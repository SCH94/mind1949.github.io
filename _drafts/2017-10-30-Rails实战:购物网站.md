---
layout: post
title: "Rails实战:购物网站"
date: 2017-10-30
tags:
    Rails
    教材
---
# Rails实战: 购物网站

| 精力管理 预计学习时间: 1小时半以内                      |                                          |
| ---------------------------------------- | ---------------------------------------- |
| [**  [直播回放\]1月16日 主动学习的启示](https://fullstack.xinshengdaxue.com/posts/387) | 共2个作业 \|[** 已完成](https://fullstack.xinshengdaxue.com/posts/387#task) |
| [**  [直播回放\]2月6日 如何多活七辈子](https://fullstack.xinshengdaxue.com/posts/421) |                                          |

| 1-教材介绍 预计学习时间: 1小时以内                     |                                          |
| ---------------------------------------- | ---------------------------------------- |
| [**  1-1 商店技术架构](https://fullstack.xinshengdaxue.com/posts/385) | 共1个作业 \|[** 未完成](https://fullstack.xinshengdaxue.com/posts/385#task) |

| 2-拆解任务 预计学习时间: 1小时半以内                    |                                          |
| ---------------------------------------- | ---------------------------------------- |
| [**  2-1 拆解任务](https://fullstack.xinshengdaxue.com/posts/377) | 共1个作业 \|[** 未完成](https://fullstack.xinshengdaxue.com/posts/377#task) |
| [**  2-2 找出系统核心组件与角色](https://fullstack.xinshengdaxue.com/posts/378) |                                          |
| [**  2-3 User Story（商家）](https://fullstack.xinshengdaxue.com/posts/371) | 共1个作业 \|[** 未完成](https://fullstack.xinshengdaxue.com/posts/371#task) |
| [**  2-4 User Story（消费者）](https://fullstack.xinshengdaxue.com/posts/372) | 共1个作业 \|[** 未完成](https://fullstack.xinshengdaxue.com/posts/372#task) |
| [**  2-5 User Story（订单部分）](https://fullstack.xinshengdaxue.com/posts/373) | 共1个作业 \|[** 未完成](https://fullstack.xinshengdaxue.com/posts/373#task) |

| 3-后台 预计学习时间: 2小时以内                       |                                          |
| ---------------------------------------- | ---------------------------------------- |
| [**  3-1 将手稿转为 User Story （后台）](https://fullstack.xinshengdaxue.com/posts/379) | 共1个作业 \|[** 未完成](https://fullstack.xinshengdaxue.com/posts/379#task) |
| [**  3-2 Fork 教学](https://fullstack.xinshengdaxue.com/posts/213) | 共1个作业 \|[** 未完成](https://fullstack.xinshengdaxue.com/posts/213#task) |
| [**  3-3 商店网站 - 实作提示 Part 1](https://fullstack.xinshengdaxue.com/posts/380) |                                          |
| [**  3-4 商店网站 - 实作提示 Part 2](https://fullstack.xinshengdaxue.com/posts/381) |                                          |
| [**  3-5 商店网站 - 实作提示 Part 3](https://fullstack.xinshengdaxue.com/posts/382) |                                          |
| [**  3-6 最后成果](https://fullstack.xinshengdaxue.com/posts/383) | 共3个作业 \|[** 未完成](https://fullstack.xinshengdaxue.com/posts/383#task) |

| 4-后台（解答） 预计学习时间: 1小时半以内                  |      |
| ---------------------------------------- | ---- |
| [**  4-1 Step 0 - 基础建设](https://fullstack.xinshengdaxue.com/posts/384) |      |
| [**  4-2 STORY 1 - 上架后台 CRUD](https://fullstack.xinshengdaxue.com/posts/216) |      |
| [**  4-3 STORY 2 - admin 可以登录后台](https://fullstack.xinshengdaxue.com/posts/218) |      |
| [**  4-4 STORY 3 - 上传图片](https://fullstack.xinshengdaxue.com/posts/207) |      |

| 5-购物车实做 预计学习时间: 3小时以内                    |                                          |
| ---------------------------------------- | ---------------------------------------- |
| [**  5-1 购物车实做](https://fullstack.xinshengdaxue.com/posts/415) |                                          |
| [**  从新手到胜任者](https://fullstack.xinshengdaxue.com/posts/420) | 共1个作业 \|[** 未完成](https://fullstack.xinshengdaxue.com/posts/420#task) |
| [**  5-2 Step 1 : 建立加入购物车的 action](https://fullstack.xinshengdaxue.com/posts/221) | 共1个作业 \|[** 未完成](https://fullstack.xinshengdaxue.com/posts/221#task) |
| [**  5-3 Step 2: 购物车设计 Part 1](https://fullstack.xinshengdaxue.com/posts/222) |                                          |
| [**  5-4 Step 3: 购物车设计 Part 2](https://fullstack.xinshengdaxue.com/posts/416) |                                          |
| [**  5-5 Step 4 : 显示购物车明细](https://fullstack.xinshengdaxue.com/posts/223) |                                          |
| [**  5-6 Step 5 : 计算总价](https://fullstack.xinshengdaxue.com/posts/224) |                                          |
| [**  5-7 购物车练习作业](https://fullstack.xinshengdaxue.com/posts/225) | 共6个作业 \|[** 未完成](https://fullstack.xinshengdaxue.com/posts/225#task) |
| [**  5-8 本章学习以及复盘指南](https://fullstack.xinshengdaxue.com/posts/419) | 共2个作业 \|[** 未完成](https://fullstack.xinshengdaxue.com/posts/419#task) |

| 6-购物车实做（解答） 预计学习时间: 1小时以内                |      |
| ---------------------------------------- | ---- |
| [**  6-1 购物车练习作业 （解答）](https://fullstack.xinshengdaxue.com/posts/226) |      |

| 7-订单实做 预计学习时间: 3小时以内                     |                                          |
| ---------------------------------------- | ---------------------------------------- |
| [**  7-1 Step 1 : 建立结帐页](https://fullstack.xinshengdaxue.com/posts/227) | 共1个作业 \|[** 未完成](https://fullstack.xinshengdaxue.com/posts/227#task) |
| [**  7-2 Step 2 : 建立购买明细](https://fullstack.xinshengdaxue.com/posts/228) |                                          |
| [**  7-3 Step 3 : 将网址改为秘密](https://fullstack.xinshengdaxue.com/posts/229) |                                          |
| [**  7-4 订单练习作业](https://fullstack.xinshengdaxue.com/posts/232) | 共1个作业 \|[** 未完成](https://fullstack.xinshengdaxue.com/posts/232#task) |
| [**  [直播回放\]2月9日 豆知识](https://fullstack.xinshengdaxue.com/posts/423) |                                          |
| [**  7-5 豆知识](https://fullstack.xinshengdaxue.com/posts/424) |                                          |
| [**  7-6 项目管理](https://fullstack.xinshengdaxue.com/posts/425) | 共1个作业 \|[** 未完成](https://fullstack.xinshengdaxue.com/posts/425#task) |

| 8-订单实做（解答） 预计学习时间: 1小时以内                 |      |
| ---------------------------------------- | ---- |
| [**  8-1 订单练习作业（解答）](https://fullstack.xinshengdaxue.com/posts/233) |      |

| 9-支付订单与寄信 预计学习时间: 1小时半以内                 |                                          |
| ---------------------------------------- | ---------------------------------------- |
| [**  9-1 Step 1 : 消费者可以针对订单付款](https://fullstack.xinshengdaxue.com/posts/231) | 共2个作业 \|[** 未完成](https://fullstack.xinshengdaxue.com/posts/231#task) |
| [**  9-2 Step 2 : 寄送订单确认通知信](https://fullstack.xinshengdaxue.com/posts/235) | 共1个作业 \|[** 未完成](https://fullstack.xinshengdaxue.com/posts/235#task) |

| 10-后台出货订单操作 预计学习时间: 1小时以内                |                                          |
| ---------------------------------------- | ---------------------------------------- |
| [**  10-1 切换订单状态](https://fullstack.xinshengdaxue.com/posts/237) | 共3个作业 \|[** 未完成](https://fullstack.xinshengdaxue.com/posts/237#task) |

| 11-后台出货订单操作（解答） 预计学习时间: 2小时以内            |      |
| ---------------------------------------- | ---- |
| [**  11-1 订单状态切换（解答）](https://fullstack.xinshengdaxue.com/posts/238) |      |
| [**  [直播回放\]2月16日 进阶知识(选修)](https://fullstack.xinshengdaxue.com/posts/431) |      |

| 12-部署到 Heroku 预计学习时间: 3小时以内              |                                          |
| ---------------------------------------- | ---------------------------------------- |
| [**  12-1 本章学习指南](https://fullstack.xinshengdaxue.com/posts/429) |                                          |
| [**  12-2 一些安全概念](https://fullstack.xinshengdaxue.com/posts/240) |                                          |
| [**  12-3 申请AWS S3（用来储存图片）（方案1）](https://fullstack.xinshengdaxue.com/posts/427) |                                          |
| [**  12-4 使用 Figaro 管理密码（方案1）](https://fullstack.xinshengdaxue.com/posts/241) | 共1个作业 \|[** 未完成](https://fullstack.xinshengdaxue.com/posts/241#task) |
| [**  12-5 将JDStore部署到Heroku（方案1）](https://fullstack.xinshengdaxue.com/posts/239) | 共1个作业 \|[** 未完成](https://fullstack.xinshengdaxue.com/posts/239#task) |
| [**  12-6 使用SendCloud服务发送邮件](https://fullstack.xinshengdaxue.com/posts/426) |                                          |
| [**  12-7 Rails 环境架构](https://fullstack.xinshengdaxue.com/posts/418) |                                          |
| [**  12-8 如何在 Heroku 上 Debug](https://fullstack.xinshengdaxue.com/posts/242) |                                          |
| [**  12-9 泄漏 S3 密钥的处理方式](https://fullstack.xinshengdaxue.com/posts/440) |                                          |
| [**  [直播回放\]2月23日 编程知识补充](https://fullstack.xinshengdaxue.com/posts/487) |                                          |
| [**  12-10 使用七牛云（用来存储图片）（方案2）](https://fullstack.xinshengdaxue.com/posts/482) |                                          |
| [**  12-11 使用Figaro管理密码（方案2）](https://fullstack.xinshengdaxue.com/posts/483) |                                          |
| [**  12-12 将JDStore部署到Heroku（方案2）](https://fullstack.xinshengdaxue.com/posts/484) |                                          |
| [**  商店创意大赛参赛手册](https://fullstack.xinshengdaxue.com/posts/1278) |                                          |

| 13-如何组队 预计学习时间: 2小时以内                    |                                          |
| ---------------------------------------- | ---------------------------------------- |
| [**  [直播回放\]2月13日 商店大赛协作技巧&如何组队](https://fullstack.xinshengdaxue.com/posts/428) |                                          |
| [**  13-1 组队诀窍](https://fullstack.xinshengdaxue.com/posts/432) | 共1个作业 \|[** 未完成](https://fullstack.xinshengdaxue.com/posts/432#task) |
| [**  13-2 Github协作指南](https://fullstack.xinshengdaxue.com/posts/430) | 共3个作业 \|[** 未完成](https://fullstack.xinshengdaxue.com/posts/430#task) |
| [**  13-3 利用 Tower 进行项目管理](https://fullstack.xinshengdaxue.com/posts/1290) |                                          |

| 14-提升网站技术品质 预计学习时间: 9小时以内                |                                          |
| ---------------------------------------- | ---------------------------------------- |
| [**  [直播回放\]2月20日 课程第一次复盘](https://fullstack.xinshengdaxue.com/posts/485) |                                          |
| [**  [直播回放\]2月27日 读书方法论](https://fullstack.xinshengdaxue.com/posts/495) |                                          |
| [**  [直播回放\]3月2日 Google进阶用法](https://fullstack.xinshengdaxue.com/posts/790) |                                          |
| [**  [直播回放\]3月6日 全栈营60天复盘](https://fullstack.xinshengdaxue.com/posts/800) | 共2个作业 \|[** 未完成](https://fullstack.xinshengdaxue.com/posts/800#task) |
| [**  [直播回放\]3月9日 Asset Pipeline知识补充&前...](https://fullstack.xinshengdaxue.com/posts/802) |                                          |
| [**  [直播回放\]3月20日 60天综合大套路](https://fullstack.xinshengdaxue.com/posts/871) |                                          |
| [**  [直播回放\]3月27日 xdite 征服世界的方法](https://fullstack.xinshengdaxue.com/posts/933) |                                          |
| [**  [直播回放\]3月30日 Nic助教分享如何找到工作](https://fullstack.xinshengdaxue.com/posts/937) |                                          |



## 注:本章中所有视频均未整理

# [直播回放]1月16日 主动学习的启示

主讲人：
Xdite老师

时间：
1月16日 20:00

时长：
主讲时长约30分钟
本次直播不设答疑环节

概要：
1.如何保持自己的幸运
2.如何保存自己的精力
3.ORID的方法

<http://maple-space.logdown.com/posts/1318762>
<iframe width="854" height="480" src="/videos/1月16日-主动学习的启示.mp4" frameborder="0" allowfullcreen></iframe>

# [直播回放]2月6日 如何多活七辈子

主讲人：
xdite老师

时间：
2月6日 20:00

时长：
主讲时长约23分钟

概要：
与当前时空的协作能力
影响你的运气的注意力

感谢刘同学第一时间的笔记
<http://maple-space.logdown.com/posts/1389071-0206-live-notes>

<iframe width="854" height="480" src="/videos/2月6日-如何多活七辈子.mp4" frameborder="0" allowfullscreen></iframe>


# 1-1 商店技术架构

这一课商店网站，你将会学到至少以下的主题：

- 购物车设计
- 结帐订单
- 第三方整合
- 代码重构

熟练掌握这个课程的主题后，能够让你在未来写出绝大多数的网站功能。

技术议题包含：

- Model 设计原则
- 自定 before_action
- 自定义 Routing
- validation
- session 操作
- find_by 操作
- where / order
- 巢状表单
- State Machine
- ActiveJob
- Mailer
- Partial / Helper

### 本节作业

##### [购物网站 - 第一周作业](https://fullstack.xinshengdaxue.com/assignments/9)：[商店技术架构](https://fullstack.xinshengdaxue.com/tasks/80)

已有 146 个第一期同学提交了这个作业 [**看看同学怎么做](https://fullstack.xinshengdaxue.com/tasks/80/other_answers?order=recent)

[**提交作业](https://fullstack.xinshengdaxue.com/tasks/80)

本周日记&周记

1.请使用[ORID格式](https://fullstack.xinshengdaxue.com/tasks/7)记录每天的学习日记
2.请根据你本周的学习情况写一篇总结周记，内容提到以下两点：
2.1 “本周学到的最棒概念/工具”
2.2 “本周遇到最大的坑”
然后把日记和周记的博客连接贴在这里，格式如下：
（注意：你的logdown连结应该会是这样 <http://yy4ever.logdown.com/posts/1143304> 而不会有edit的链接）

1/16 日记：（你的博客链接）
1/17 日记：（你的博客链接）
1/18 日记：（你的博客链接）
1/19 日记：（你的博客链接）
1/20 周记：（你的博客链接）

# 2-1 拆解任务

这一课，我们要做的是搭建一个简单的商店网站，请仿照上一课招聘网站时的便利贴方法。

- 写下 7-10 件你觉得「商店」必备的组块功能
- 整理出目的群组
- 按照 Must Have / Should Have / Could Have / Nice to Have 整理出一张图

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/uIrTDgxASW6LTygqgiqv_n0Jt4S2bQ4asSmMWU2SH_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-12-30%20%E4%B8%8B%E5%8D%885.30.29.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/uIrTDgxASW6LTygqgiqv_n0Jt4S2bQ4asSmMWU2SH_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-12-30%20%E4%B8%8B%E5%8D%885.30.29.png)

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/81YZBHOQM2SxUE9QZwR5_oM2ZxEZNSDqXiHrO9soe_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-12-30%20%E4%B8%8B%E5%8D%885.35.53.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/81YZBHOQM2SxUE9QZwR5_oM2ZxEZNSDqXiHrO9soe_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-12-30%20%E4%B8%8B%E5%8D%885.35.53.png)

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/ysFIw29CTWLPGeugGea3_uklTnDQTQky23JnMYSmW_WechatIMG3.jpeg)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/ysFIw29CTWLPGeugGea3_uklTnDQTQky23JnMYSmW_WechatIMG3.jpeg)

### 本节作业

##### [购物网站 - 第一周作业](https://fullstack.xinshengdaxue.com/assignments/9)：[拆解任務](https://fullstack.xinshengdaxue.com/tasks/81)

已有 203 个第一期同学提交了这个作业 [**看看同学怎么做](https://fullstack.xinshengdaxue.com/tasks/81/other_answers?order=recent)

[**提交作业](https://fullstack.xinshengdaxue.com/tasks/81)

- 在便利贴上写下 7-10 件你觉得“商店”必备的组块功能
- 整理出目的群组
- 按照 Must Have / Should Have / Could Have / Nice to Have 整理出一张图，整理好拍照上传。

# 2-2 找出系统核心组件与角色

## Must Have / Should Have / Could Have / Nice to Have

当书写过一轮功能之后，会发现最后留下的 Must Have / Should Have 中，最核心的功能应该会剩下以下几部分：

- 购买机制 - 消费者购买商品，放入购物车
- 结帐机制 - 消费者将购物车中的商品，结帐生成订单
- 上架机制 - 商家上架物品，设定开卖
- 配送机制 - 商家针对订单配送

整个系统有两个核心角色：

- 消费者
- 商家

# 2-3 User Story（商家）

在这一课，我们要请各位拿出

- 一本全白的笔记本
- 一支蓝笔
- 一支绿笔

跟着我这样做。

（ 请千万不要跳过这个步骤。我们需要各位真的也照着写下来，才会记住这个方法）

把第一版用户故事写下来。 （请跟着照抄，如图所示）

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/tymia3uSQPSYgNnkg6tx_2017_01_06_01_11_24_001.jpg)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/tymia3uSQPSYgNnkg6tx_2017_01_06_01_11_24_001.jpg)

### 本节作业

##### [购物网站 - 第一周作业](https://fullstack.xinshengdaxue.com/assignments/9)：[User Story - 商家](https://fullstack.xinshengdaxue.com/tasks/82)

已有 208 个第一期同学提交了这个作业 [**看看同学怎么做](https://fullstack.xinshengdaxue.com/tasks/82/other_answers?order=recent)

[**提交作业](https://fullstack.xinshengdaxue.com/tasks/82)

依照教材指示，把商家的第一版用户故事写下来后，拍照上传。

# 2-4 User Story（消费者）

把第一版用户故事写下来。 （请跟着照抄，如图所示）

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/b1FuRuBFRVGKItOYp9aJ_2017_01_06_01_11_22_001.jpg)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/b1FuRuBFRVGKItOYp9aJ_2017_01_06_01_11_22_001.jpg)

### 本节作业

##### [购物网站 - 第一周作业](https://fullstack.xinshengdaxue.com/assignments/9)：[User Story - 消费者](https://fullstack.xinshengdaxue.com/tasks/83)

已有 207 个第一期同学提交了这个作业 [**看看同学怎么做](https://fullstack.xinshengdaxue.com/tasks/83/other_answers?order=recent)

[**提交作业](https://fullstack.xinshengdaxue.com/tasks/83)

依照教材指示，把消费者的第一版用户故事写下来后，拍照上传。

# 2-5 User Story（订单部分）

把第一版用户故事写下来。 （请跟着照抄，如图所示）

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/JIx2Fk2TSyNgZ4NSJtFQ_2017_01_06_01_11_26_001.jpg)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/JIx2Fk2TSyNgZ4NSJtFQ_2017_01_06_01_11_26_001.jpg)

### 本节作业

##### [购物网站 - 第一周作业](https://fullstack.xinshengdaxue.com/assignments/9)：[User Story - 订单部分](https://fullstack.xinshengdaxue.com/tasks/84)

已有 207 个第一期同学提交了这个作业 [**看看同学怎么做](https://fullstack.xinshengdaxue.com/tasks/84/other_answers?order=recent)

[**提交作业](https://fullstack.xinshengdaxue.com/tasks/84)

依照教材指示，把订单的第一版用户故事写下来后，拍照上传。

# 3-1 将手稿转为 User Story （后台）

然后我们可以把第一张手稿转成 User Story

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/tymia3uSQPSYgNnkg6tx_2017_01_06_01_11_24_001.jpg)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/tymia3uSQPSYgNnkg6tx_2017_01_06_01_11_24_001.jpg)

### User Story 用户故事（后台）

身为商家的管理者，我要能够在后台上架我的商品，并设定能够贩卖

- 身为管理者，我要能够登入后台
  - 整个商店网站分为两种权限：admin (商家) / user （消费者）
  - 商家可以登入 /admin 后台
- 身为管理者，我要能够登入后台上架商品
  - 后台上架网址必须要是 /admin/products
  - 商品的内容分为物品标题、描述、价格、库存
  - 商品要能够设定是否能上架贩售
  - 商品必须要有商品图片

### 总结

有没有似曾相似的感觉？相信做过招聘网站的各位肯定会开始觉得自己能够挣扎解出来。

所以这一周，我们希望在这一个章节，各位能够尽量的独立做出这个模块的作业。

### 本节作业

##### [购物网站 - 第一周作业](https://fullstack.xinshengdaxue.com/assignments/9)：[将手稿转为 User Story （后台）](https://fullstack.xinshengdaxue.com/tasks/85)

已有 205 个第一期同学提交了这个作业 [**看看同学怎么做](https://fullstack.xinshengdaxue.com/tasks/85/other_answers?order=recent)

[**提交作业](https://fullstack.xinshengdaxue.com/tasks/85)

将你的购物网站「User Story 用户故事（后台）」（图片下的文字部分）手写在笔记本上，并拍照上传。

# 3-2 Fork 教学

这一节我们要请各位同学先 Fork 商店的这个专案

### Step 1: Fork 专案

到 <https://github.com/quanzhanying/jdstore> 去 Fork 专案：

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/m0QA7MzJR8imdCEFDwPL_Snip20170116_4.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/m0QA7MzJR8imdCEFDwPL_Snip20170116_4.png)

### Step 2: 检查 ID

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/yEzTai5SaeBxjkLgh0lg_Snip20170116_6.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/yEzTai5SaeBxjkLgh0lg_Snip20170116_6.png)

### Step 3: Clone url

点选 「Clone or Download」按钮，取得自己的 url，并复制到剪贴簿

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/HRBDErIJTPJufoy3eic3_Snip20170116_7.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/HRBDErIJTPJufoy3eic3_Snip20170116_7.png)

### Step 4 : 在本地跑起来

- clone 到本地
- 复制 database.yml.example
- git checkout EPIC-1

跑起来

`git clone git@github.com:XXXXX/jdstore.git`
`cd jdstore`
`cp config/database.yml.example config/database.yml`
`bundle check`
`bundle install`
`git checkout -b EPIC-1`
`rails s`

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/w1AUOlFzSUaQGnbdc9v8_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202017-01-11%20%E4%B8%8B%E5%8D%8810.24.27.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/w1AUOlFzSUaQGnbdc9v8_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202017-01-11%20%E4%B8%8B%E5%8D%8810.24.27.png)

### 本节作业

##### [购物网站 - 第一周作业](https://fullstack.xinshengdaxue.com/assignments/9)：[Fork 教学](https://fullstack.xinshengdaxue.com/tasks/48)

已有 205 个第一期同学提交了这个作业 [**看看同学怎么做](https://fullstack.xinshengdaxue.com/tasks/48/other_answers?order=recent)

[**提交作业](https://fullstack.xinshengdaxue.com/tasks/48)

\* fork <https://github.com/quanzhanying/jdstore>
\* 套上 Bootstrap
\* 套上 Devise
\* 套上 SimpleForm
\* 可以登入、登出
请贴上 github pull request 网址
并上传gif动画演示你的成果（拖曳到此处）

# 3-3 商店网站 - 实作提示 Part 1

我们这一周所要实做的内容如下：

- 身为管理者，要能够登入后台
  - 整个商店网站分为两种权限：admin (商家) / user （消费者）
  - 商家可以登入 /admin 后台
- 身为管理者，要能够登入后台上架商品
  - 后台上架网址必须要是 /admin/products
  - 商品的内容分为标题、描述、价格、库存
  - 商品要能够设定是否能上架售卖
  - 商品必须要有图片

## 提示

### 我们可以从后台网址设计开始

- 身为管理者，要能够登入后台上架商品 (这时候还不需要设计权限问题）
- 后台上架网址必须要是 /admin/products

所以网址最后要是：

<http://localhost:3000/admin/products>

- rails g controller admin/products
- 设定 namespace routing

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/a2XNaiMeSbudJ0h121IP_380-1.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/a2XNaiMeSbudJ0h121IP_380-1.png)

### 接着设计 Product Model

- 商品 ( Product ) 的内容分为标题、描述、价格、库存
- rails g model product title:string  description:text price:integer quantity:integer

### 再来设计商品上架的 CRUD

- <http://localhost:3000/admin/products/new>

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/jrBtL3mFT1OFjZvSgqtA_380-2.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/jrBtL3mFT1OFjZvSgqtA_380-2.png)

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/tUFiXa9QwqlHdze2GPNQ_380-3.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/tUFiXa9QwqlHdze2GPNQ_380-3.png)

### 商品必须要有图片

- carrierwave
- （稍后再做）

# 3-4 商店网站 - 实作提示 Part 2

我们这一周所要实做的内容如下：

- 身为管理者，要能够登入后台
  - 整个商店网站分为两种权限：admin (商家) / user （消费者）
  - 商家可以登入 /admin 后台
- 身为管理者，要能够登入后台上架商品
  - 后台上架网址必须要是 /admin/products
  - 商品的内容分为标题、描述、价格、库存
  - 商品要能够设定是否能上架售卖
  - 商品必须要有图片

接着我们要为后台加入权限判定设计

## 提示

### 先设计使用者必须要先登入后才能存取后台

- 登入必须要安装 devise
- 在 admin/products_controller.rb 加入 before_action 强制进行「登入验证」

[![img](https://ww1.sinaimg.cn/large/006tNc79gy1fck8c336eej317y0c0tak.jpg)](https://ww1.sinaimg.cn/large/006tNc79gy1fck8c336eej317y0c0tak.jpg)

然后我们在浏览器测试存取  <http://localhost:3000/admin/products/new>　是否强制验证

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/CgOfwZg9QriBCeuklvJb_381-2.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/CgOfwZg9QriBCeuklvJb_381-2.png)

### 再限制登入后台的使用者必须是 admin

- 在 admin/products_controller.rb 中加入 before_action 强制进行「admin 验证」

[![img](https://ww3.sinaimg.cn/large/006tNc79gy1fck8cdemckj31680cstav.jpg)](https://ww3.sinaimg.cn/large/006tNc79gy1fck8cdemckj31680cstav.jpg)

- 在 application_controller 中设计一个 admin_required 的验证式

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/Ez7qjSNlQti1zfLZuwbe_381-4.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/Ez7qjSNlQti1zfLZuwbe_381-4.png)

这段代码的意思是 current_user 如果不是 admin 的话，进入后台后会被直接重导到首页。

但如果这时候打开　<http://localhost:3000/admin/products/new>，会出现以下报错画面。

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/FzBnoC5WRc20zQrfhfCJ_381-5.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/FzBnoC5WRc20zQrfhfCJ_381-5.png)

这个错误是指系统不知道 `admin?` 在 User model 中代表什么意思。

### 所以我们去 User model 里设计 admin? 的判断式

- 修改 app/models/user.rb
- 加入 `admin?` 这个判断式
- 我们暂时使用 `is_admin` 这个 boolean 值（ true / false）作为是否是 admin 的判断
- **rails g migration add_is_admin_to_user**

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/zPM4ikERRy1rFZHNzJn9_381-6.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/zPM4ikERRy1rFZHNzJn9_381-6.png)

### 测试 Admin 是否真能进后台

#### 进 `rails c` 生成一个 admin user

步骤：

> rails c

输入

> u = User.new(email: "[xx@xx.com](mailto:xx@xx.com)", password: "12345678", password_confirmation: "12345678")
> u.save
> u.is_admin = true
> u.save
> exit

#### 使用 admin user开启 Chrome「无痕模式」登入后台

- 登入后台 <http://localhost:3000/admin/products/new>

# 3-5 商店网站 - 实作提示 Part 3

我们这一周所要实做的内容如下：

- 身为管理者，要能够登入后台
  - 整个商店网站分为两种权限：admin (商家) / user （消费者）
  - 商家可以登入 /admin 后台
- 身为管理者，要能够登入后台上架商品
  - 后台上架网址必须要是 /admin/products
  - 商品的内容分为标题、描述、价格、库存
  - 商品要能够设定是否能上架售卖
  - 商品必须要有图片

接着我们要为后台加入上传图片功能

## 步骤

### 安装 Carrierwave

Gemfile

```
  gem "carrierwave"
  gem "mini_magick"
```

### 新增 image 栏位

`rails g migration add_image_to_product`

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/obsZ5kIKTxmNAtM8zfaQ_382-1.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/obsZ5kIKTxmNAtM8zfaQ_382-1.png)

### 新增 image uploader

`rails g uploader image`

### 订制图片尺寸

修改 uploader 订制尺寸

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/gX3OFIBkR2mlixkbnGuT_382-2.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/gX3OFIBkR2mlixkbnGuT_382-2.png)

### 挂上 PhotoUploader

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/quijJeyfQD3V7Uqnqiv9_382-3.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/quijJeyfQD3V7Uqnqiv9_382-3.png)

# 3-6 最后成果

我们希望下次上课前，同学的实做部分，做到这个进度：

### 首页（商品列表）

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/IWzbFr4tQgiNVcBRNG12_383-1.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/IWzbFr4tQgiNVcBRNG12_383-1.png)

### 内页（商品页面）

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/wCkS1k40Q7O2h9nfkC51_383-2.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/wCkS1k40Q7O2h9nfkC51_383-2.png)

### 小结

下周，我们会从这个进度开始讲解购物车如何实做。

#### 本节作业

##### [购物网站 - 第一周作业](https://fullstack.xinshengdaxue.com/assignments/9)：[STORY 1 - 上架后台 CRUD](https://fullstack.xinshengdaxue.com/tasks/51)

已有 187 个第一期同学提交了这个作业 [**看看同学怎么做](https://fullstack.xinshengdaxue.com/tasks/51/other_answers?order=recent)

[**提交作业](https://fullstack.xinshengdaxue.com/tasks/51)

\* 使用者必须要是 admin 才能登入 <http://localhost:3000/admin/products>
\* 商品栏位必须要有 title, description, quantity, price
\* admin 后台 products 完整的 CRUD

请贴上 github pull request 网址
并上传gif动画演示你的成果（拖曳到此处）

##### [购物网站 - 第一周作业](https://fullstack.xinshengdaxue.com/assignments/9)：[STORY 2 - admin 可以登录后台](https://fullstack.xinshengdaxue.com/tasks/52)

已有 186 个第一期同学提交了这个作业 [**看看同学怎么做](https://fullstack.xinshengdaxue.com/tasks/52/other_answers?order=recent)

[**提交作业](https://fullstack.xinshengdaxue.com/tasks/52)

\* 管理者（身份商家）必须先登录网站才能进入（商家）后台
\* 管理者必须有 admin 权限才能进入后台

请贴上 github pull request 网址
并上传gif动画演示你的成果（拖曳到此处）

##### [购物网站 - 第一周作业](https://fullstack.xinshengdaxue.com/assignments/9)：[STORY 3 - 上传图片](https://fullstack.xinshengdaxue.com/tasks/53)

已有 185 个第一期同学提交了这个作业 [**看看同学怎么做](https://fullstack.xinshengdaxue.com/tasks/53/other_answers?order=recent)

[**提交作业](https://fullstack.xinshengdaxue.com/tasks/53)

\* 产品必须可以上传缩图
\* 缩图 size 是 200x200, 400x400, 800x800
首页必须长这样
[![img](https://cdn.filepicker.io/api/file/TrE1Hf2RTrqnTgpN9EBG)](https://cdn.filepicker.io/api/file/TrE1Hf2RTrqnTgpN9EBG)
商品内页必须长这样
[![img](https://cdn.filepicker.io/api/file/c660POusTaqXY9guGR3E)](https://cdn.filepicker.io/api/file/c660POusTaqXY9guGR3E)

请贴上 github pull request 网址
并上传gif动画演示你的成果（拖曳到此处）

# 4-1 Step 0 - 基础建设

## Part 1 Fork 专案

### Step 1. fork专案

到 <https://github.com/quanzhanying/jdstore> 去Fork专案

- clone 到本地
- 复制 database.yml.example
- git checkout -b EPIC-1
- 跑起来

```
git clone git@github.com:XXXXX/jdstore.git
cd jdstore
cp config/database.yml.example config/database.yml
bundle check
bundle install
git checkout -b EPIC-1
rails s
```

## Part 2 安装 Bootstrap

### Step 1. 挂上 bootstrap-sass 这个 gem

Gemfile

```
gem 'bootstrap-sass'
```

### Step 2. bundle install

执行 `bundle install`

(注意：修改完 Gemfile 都要执行 bundle install）

### Step 3. 将 Bootstrap 的 CSS 套件装进专案里面

在终端输入

`mv app/assets/stylesheets/application.css app/assets/stylesheets/application.scss`

然后修改 app/assets/stylesheets/application.scss 档案，在最后加入以下两行

app/assets/stylesheets/application.scss

```
/*
 * ...(一堆注解)
 *= require_tree .
 *= require_self
 */

+ @import "bootstrap-sprockets";
+ @import "bootstrap";
```

### Step 4. 将变更 commit 进 git 里面

```
git add .
git commit -m "add bootstrap to project"
```

## Part 3 修改样式

### Step 1. 新增 app/views/common 资料夹

`mkdir app/views/common`

### Step 2. 新增 navbar

`touch app/views/common/_navbar.html.erb`

填入

app/views/common/_navbar.html.erb

```
<nav class="navbar navbar-default" role="navigation">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header">
            <a class="navbar-brand" href="/">JDStore </a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <li><%= link_to("登入", '#') %></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container-fluid -->
</nav>
```

### Step 3. 新增 footer

`touch app/views/common/_footer.html.erb`

填入

app/views/common/_footer.html.erb

```
<footer class="container" style="margin-top: 100px;">
    <p class="text-center">Copyright ©2017 JDStore
        <br>Design by yourname

    </p>
</footer>
```

### Step 4. 修改全域 HTML 样式 application.html.erb

app/views/layouts/application.html.erb

```
<!DOCTYPE html>
<html>
    <head>
        <title>JDStore </title>
        <%= csrf_meta_tags %>

        <%= stylesheet_link_tag    'application', media: 'all', 'data-turbolinks-track': 'reload' %>
        <%= javascript_include_tag 'application', 'data-turbolinks-track': 'reload' %>
    </head>

    <body>

        <div class="container-fluid">
            <%= render "common/navbar" %>
            <%= yield %>
        </div>

        <%= render "common/footer" %>

    </body>
</html>
```

### Step 5. 产生一个新的空 Hello World 页面 （放在 weclome#index)

`rails g controller welcome`

- 新增一个 welcome controller

`touch app/views/welcome/index.html.erb`

- 新增一个空的 HelloWorld 页面

填入

app/views/welcome/index.html.erb

```
<h1> Hello World! </h1>
```

### Step 6. 将首页指到 welcome 下的 index.html.erb 页面

修改 `config/routes.rb`，改成以下内容

config/routes.rb

```
Rails.application.routes.draw do
  root 'welcome#index'
end
```

### Step 7. git 进度存档

`git add .`
`git commit -m "add bootstrap html"`

### Step 8. 重开 Rails Server

`rails s`

## Part 4 增加 flash 功能

### Step 1. 将 Boostrap 的 js 提示套件 bootstrap/alert “挂”进专案里面

在 `requre_tree` 上加入一行 `//= require bootstrap/alert`

app/assets/javascripts/application.js

```
... (一堆注解)
//= require jquery
//= require jquery_ujs
//= require turbolinks
+//= require bootstrap/alert
//= require_tree .
```

### Step 2. 新增 app/views/common/_flashes.html.erb

`touch app/views/common/_flashes.html.erb`

填入

app/views/common/_flashes.html.erb

```
<% if flash.any? %>
  <% user_facing_flashes.each do |key, value| %>
    <div class="alert alert-dismissable alert-<%= flash_class(key) %>">
      <button class="close" data-dismiss="alert">×</button>
      <%= value %>
    </div>
  <% end %>
<% end %>
```

### Step 3. 加入 app/helpers/flashes_helper.rb

`touch app/helpers/flashes_helper.rb`

填入以下内容：

app/helpers/flashes_helper.rb

```
module FlashesHelper
  FLASH_CLASSES = { alert: "danger", notice: "success", warning: "warning"}.freeze

  def flash_class(key)
    FLASH_CLASSES.fetch key.to_sym, key
  end

  def user_facing_flashes
    flash.to_hash.slice "alert", "notice","warning"
  end
end
```

### Step 4. 在 application.html.erb 内加入 flash 这个 partial

在 `<%= yield %>` 前加入 `<%= render "common/flashes" %>`

app/views/layout/application.html.erb

```
 <%= render "common/flashes" %>
  <%= yield %>
```

### Step 5. git 存档

```
git add .
git commit -m "add bootstrap flash function"
```

### Step 6: 测试 flash helper 的功能

加入 `flash[:notice] = "早安！你好！"`。你应该可以看到系统跳出“绿色”提示窗。

app/controllers/welcome_controller.rb

```
class WelcomeController < ApplicationController
  def index
    flash[:notice] = "早安！你好！"
  end
end
```

## Part 5 安装 Devise

### Step 1: 安装登入系统

Devise 是一个 Rails 内热门的 gem，专门用来快速实作“登入系统”。在这一节我们会用 devise 实作登入功能。

Gemfile 新增一行 `gem 'devise'`

Gemfile

```
gem 'devise'
```

然后执行

```
bundle install
```

### Step 2 : 产生会员系统的必要档案

执行

```
rails g devise:install
rails g devise user
rake db:migrate
```

重启`rails s`

### Step 3: 修改 app/views/common/_navbar.html.erb

app/views/common/_navbar.html.erb

```
-                <li> <%= link_to("登入", '#') %>   </li>
+                <% if !current_user %>
+                  <li><%= link_to("注册", new_user_registration_path) %> </li>
+                  <li><%= link_to("登入", new_user_session_path) %></li>
+                <% else %>
+                  <li class="dropdown">
+                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">
+                        Hi!, <%= current_user.email %>
+                        <b class="caret"></b>
+                    </a>
+                    <ul class="dropdown-menu">
+                        <li> <%= link_to("登出", destroy_user_session_path, method: :delete) %> </li>
+                    </ul>
+                  </li>
+                <% end %>
```

### Step 4: 修改 app/assets/javascripts/application.js

加入一行 `//= require bootstrap/dropdown`

app/assets/javascripts/application.js

```
//= require bootstrap/alert
+ //= require bootstrap/dropdown
```

成果应该会是这样的效果。

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/xeLBMLRfQdKd3lQzhyjf_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-09-14%20%E4%B8%8B%E5%8D%882.07.34.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/xeLBMLRfQdKd3lQzhyjf_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-09-14%20%E4%B8%8B%E5%8D%882.07.34.png)

### Step 5: git 储存

```
git add .
git commit -m "user can login/logout/signup"
```

## Part 6 安装 SimpleForm

### Step 1. 使用 SimpleForm 简化

首先我们要来安装 simple_form

打开 Gemfile，然后新增一行 `gem 'simple_form'`

Gemfile

```
gem 'bootstrap-sass'
gem 'devise'
+ gem 'simple_form'
```

然后执行

`bundle install`

安装 gem。

### Step 2. 安装 simple_form for bootstrap 的设定

执行：

`rails generate simple_form:install --bootstrap`

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/qhG8fT0yICTvwdE71igI_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-07-11%20%E4%B8%8B%E5%8D%885.45.42.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/qhG8fT0yICTvwdE71igI_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-07-11%20%E4%B8%8B%E5%8D%885.45.42.png)

然后重开 rails server（ `ctrl+c` 然后 `rails s`）

### Step 3. git 存档

```
git add .
git commit -m "install simpleform with bootstrap"
```

## Part 7 安装 font-awesome-rails

### Step 1. 挂上font-awesome-rails

Gemfile

```
gem 'devise'
gem 'simple_form'
+ gem 'font-awesome-rails'
```

### Step 2. bundle install

执行 `bundle install`

重启`rails s`

### Step 3. 将 font-awesome装进专案里面

app/assets/stylesheets/application.scss

```
@import "font-awesome";
```

### Step 4. 修改 app/views/common/_navbar.html.erb

app/views/common/_navbar.html.erb

```
             <% if !current_user %>
               <li><%= link_to("注册", new_user_registration_path) %> </li>
-                  <li><%= link_to("登入", new_user_session_path) %></li>
+                  <li><%= link_to(content_tag(:i, '登入', class: 'fa fa-sign-in'), new_user_session_path) %></li>
             <% else %>
               <li class="dropdown">
                 <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                     Hi!, <%= current_user.email %>
                     <b class="caret"></b>
                 </a>
                 <ul class="dropdown-menu">
-                        <li> <%= link_to("登出", destroy_user_session_path, method: :delete) %> </li>
+                        <li> <%= link_to(content_tag(:i, '登出', class: 'fa fa-sign-out'), destroy_user_session_path, method: :delete) %> </li>
                 </ul>
               </li>
             <% end %>
```

登入、登出旁会出现新图标

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/SSB4lxneTfymXrHnua61_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-09-14%20%E4%B8%8B%E5%8D%882.37.15.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/SSB4lxneTfymXrHnua61_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-09-14%20%E4%B8%8B%E5%8D%882.37.15.png)

### Step 5. git存档

```
git add .
git commit -m "install font-awesome-rails"
```

## 效果动图

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/hcaGc4vuSeKB52T5YdHa_jdstore-epic1.gif)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/hcaGc4vuSeKB52T5YdHa_jdstore-epic1.gif)

# 4-2 STORY 1 - 上架后台 CRUD

## 目标

- 使用者必须要是 admin 才能登入 <http://localhost:3000/admin/products>
- 商品栏位必须要有 title, description, quantity, price
- admin 后台 products 完整的 CRUD

### Step 0:

`git checkout -b story1`

### Step 1: 建立 conrtoller admin/products

`rails g controller admin::products`

### Step 2: 设定 admin/products 的 routes

config/routes.rb

```
Rails.application.routes.draw do
+ namespace :admin do
+   resources :products
+ end

...(略)
end
```

输入`rake routes`可以看到新增了路径

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/zxGXArDMRgG0HQjQ5x9a_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-09-13%20%E4%B8%8B%E5%8D%883.16.51.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/zxGXArDMRgG0HQjQ5x9a_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-09-13%20%E4%B8%8B%E5%8D%883.16.51.png)

### Step 3: 建立 model product

```
rails g model product title:string description:text quantity:integer price:integer
```

```
`rake db:migrate`
```

### Step 4: 实作后台新增商品

app/controllers/admin/products_controller.rb

```
class Admin::ProductsController < ApplicationController
  def new
    @product = Product.new
  end

  def create
    @product = Product.new(product_params)

    if @product.save
      redirect_to admin_products_path
    else
      render :new
    end
  end

  private

  def product_params
    params.require(:product).permit(:title, :description, :quantity, :price)
  end
end
```

### Step 5: 新增商品页面

`touch app/views/admin/products/new.html.erb`

app/views/admin/products/new.html.erb

```
<h2> New Product </h2>

<%= simple_form_for [:admin, @product] do |f| %>

  <div class="group">
    <%= f.input :title %>
  </div>

  <div class="group">
    <%= f.input :description %>
  </div>

  <div class="group">
    <%= f.input :quantity %>
  </div>

  <div class="group">
    <%= f.input :price %>
  </div>

  <%= f.submit "Submit", data: { disable_with: "Submitting..." } %>

<% end %>
```

<http://localhost:3000/admin/products/new>

新增几个 product 试试看。

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/QjTKV6aLQ8KoFg0jDAQT_step5.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/QjTKV6aLQ8KoFg0jDAQT_step5.png)

### Step 6: 实作后台index action

app/controllers/admin/products_contoller.rb

```
class Admin::ProductsController < ApplicationController
+ def index
+   @products = Product.all
+ end

  def new
    @product = Product.new
  end

...(略)
end
```

### Step 7: 新增index页面

`touch app/views/admin/products/index.html.erb`

app/views/admin/products/index.html.erb

```
<ul>
  <% @products.each do |product| %>

    <li> <%= link_to(product.title, admin_product_path(product)) %> </li>
  <% end %>
</ul>
```

新增商品后可以看到新增的商品页面

<http://localhost:3000/admin/products>

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/uDf3Roi2StampV4sMHhu_step7.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/uDf3Roi2StampV4sMHhu_step7.png)

### Step 8: 实作后台商品修改

#### 修改 admin/products_controller.rb

app/controllers/admin/products_controller.rb

```
...(略)
  def new
    @product = Product.new
  end

+ def edit
+   @product = Product.find(params[:id])
+ end

+ def update
+   @product = Product.find(params[:id])

+   if @product.update(product_params)
+     redirect_to admin_products_path
+   else
+     render :edit
+   end
+ end

  def create
    @product = Product.new(product_params)
...(略)
```

### Step 9: 新增修改页面

`touch app/views/admin/products/edit.html.erb`

app/views/admin/products/edit.html.erb

```
<h2> Edit Product </h2>

<%= simple_form_for [:admin, @product] do |f| %>

  <div class="group">
    <%= f.input :title %>
  </div>

  <div class="group">
    <%= f.input :description %>
  </div>

  <div class="group">
    <%= f.input :quantity %>
  </div>

  <div class="group">
    <%= f.input :price %>
  </div>

  <%= f.submit "Submit", data: { disable_with: "Submitting..." } %>

<% end %>
```

测试看看
<http://localhost:3000/admin/products/1/edit>
(/product/XXX/edit 若有多笔资料, XXX可以替换为其他数字)

### Step 10: git 存档

```
git add .
git commit -m "implement backend CRUD"
```

## 效果动图

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/31RcJJwjQcSTx6CyNDZH_jdstore-posts:216.gif)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/31RcJJwjQcSTx6CyNDZH_jdstore-posts:216.gif)



# 4-3 STORY 2 - admin 可以登录后台

## 目标

- 管理者（商家）必须先登录网站才能进入（商店）后台
- 管理者必须有 admin 权限才能进入后台

### Step 0:

`git checkout -b story2`

### Step 1: 必须要先登入才能进入

app/controllers/admin/products_controller.rb

```
class Admin::ProductsController < ApplicationController

+ before_action :authenticate_user!

  def index
    @products = Product.all
  end

...(略)
```

#### 在浏览器测试是否强制验证

<http://localhost:3000/admin/products/new>

### Step 2: 必须要有 admin 权限才能进入

app/controllers/admin/products_controller.rb

```
class Admin::ProductsController < ApplicationController

  before_action :authenticate_user!
+ before_action :admin_required

  def index
    @products = Product.all
  end

...(略)
```

### Step 3: 建立 admin 判断式

app/controllers/application_controller.rb

```
class ApplicationController < ActionController::Base
  # Prevent CSRF attacks by raising an exception.

  # For APIs, you may want to use :null_session instead.

  protect_from_forgery with: :exception

+ def admin_required
+   if !current_user.admin?
+     redirect_to "/", alert: "You are not admin."
+   end
+ end
end
```

### Step 4: 加入 admin? 判断式

app/models/user.rb

```
class User < ApplicationRecord
  # Include default devise modules. Others available are:

  # :confirmable, :lockable, :timeoutable and :omniauthable

  devise :database_authenticatable, :registerable,
         :recoverable, :rememberable, :trackable, :validatable

+ def admin?
+   is_admin
+ end
end
```

### Step 5: 新增 is_admin 栏位(boolean)

`rails g migration add_is_admin_to_user`

修改里面的档案

db/migrate/xxx(一堆数字)_add_is_admin_to_user.rb

```
class AddIsAdminToUser < ActiveRecord::Migration[5.0]
  def change
+   add_column :users, :is_admin, :boolean, default: false
  end
end
```

执行`rake db:migrate`
重开rails server

#### 测试admin是否能进后台

存取
<http://localhost:3000/admin/products/new>

### Step 6: 在 rails console 操作新增一个 admin 使用者

`rails c`

`u = User.new(email: "admin@test.com", password: "123456", password_confirmation: "123456")`
`u.save`
`u.is_admin = true`
`u.save`

#### 再次测试admin是否能进后台

存取
<http://localhost:3000/admin/products/new>

### Step 7: 新增一个 user 种子档

db/seeds.rb

```
u = User.new
u.email = "admin@test.com"           # 可以改成自己的 email

u.password = "123456"                # 最少要六码

u.password_confirmation = "123456"   # 最少要六码

u.is_admin = true
u.save
```

然后 `rake db:seed` 即可自动建一个有 admin 权限的帐号

#### 补充: 日后资料库设定 ( migrate ) 重建时发生错误时的 bug fix

`rake db:reset`

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/W9pyYgUSL2TsAwaDp0LL_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-09-13%20%E4%B8%8B%E5%8D%884.01.55.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/W9pyYgUSL2TsAwaDp0LL_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-09-13%20%E4%B8%8B%E5%8D%884.01.55.png)

### Step 8: 建立后台 layout

#### 建立 layout: admin

app/controllers/admin/products_controller.rb

```
class Admin::ProductsController < ApplicationController

+ layout "admin"

  before_action :authenticate_user!
  before_action :admin_required
...(略)
```

`touch app/views/layouts/admin.html.erb`

app/views/layouts/admin.html.erb

```
<!DOCTYPE html>
<html>
<head>
  <title>JDstore 后台</title>
  <%= stylesheet_link_tag    'application', media: 'all', 'data-turbolinks-track' => true %>
  <%= javascript_include_tag 'application', 'data-turbolinks-track' => true %>
  <%= csrf_meta_tags %>
</head>
<body>
  <div class="container">
    <%= render "common/navbar" %>
    <div class="row">
      <div class="col-md-2">
        <ul class="nav nav-pills nav-stacked" style="max-width: 300px;">
          <li> <%= link_to("Products", admin_products_path) %> </li>
        </ul>
      </div>
      <div class="col-md-10">
        <%= yield %>
      </div>
    </div>
  </div>
</body>
</html>
```

完成

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/z0KB4QaCTNa3827WnCcP_step9.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/z0KB4QaCTNa3827WnCcP_step9.png)

### Step 9: git 存档

```
git add .
git commit -m "only admin can access backend panel"
```

## 效果动图

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/gS4UUJKbStSJ1AYFzJbd_jdstore-posts:218.gif)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/gS4UUJKbStSJ1AYFzJbd_jdstore-posts:218.gif)

# 4-4 STORY 3 - 上传图片

## 目标

- 可以上传图片
- 设定 localhost:3000 为商品首页
- 商品内页展示

### Step 0:

`git checkout -b story3`

### Step 1: 安装carrierwave and mini_magick

Gemfile

```
...(略)
gem 'font-awesome-rails'

+ gem 'carrierwave'

+ gem 'mini_magick'

group :development, :test do
...(略)
```

`bundle install`

`rails g uploader image`

`重开 rails s`

### Step 2: 在product新增image栏位

`rails g migration add_image_to_product`

db/migrate/XXX(一堆数字)_add_image_to_product.rb

```
class AddImageToProduct < ActiveRecord::Migration[5.0]
  def change
+   add_column :products, :image, :string
  end
end
```

`rake db:migrate`

### Step 3: 挂上 image uploader

app/models/product.rb

```
class Product < ApplicationRecord
+ mount_uploader :image, ImageUploader
end
```

### Step 4: 设定图片上传后裁切的尺寸

app/uploaders/image_uploader.rb

```
class ImageUploader < CarrierWave::Uploader::Base

  # Include RMagick or MiniMagick support:

  # include CarrierWave::RMagick

- # include CarrierWave::MiniMagick

+ include CarrierWave::MiniMagick

  # Choose what kind of storage to use for this uploader:

  storage :file
  # storage :fog


  # Override the directory where uploaded files will be stored.

  # This is a sensible default for uploaders that are meant to be mounted:

  def store_dir
    "uploads/#{model.class.to_s.underscore}/#{mounted_as}/#{model.id}"
  end

+ process resize_to_fit: [800, 800]

+ version :thumb do
+   process resize_to_fill: [200,200]
+ end

+ version :medium do
+   process resize_to_fill: [400,400]
+ end
...(略)
```

### Step 5: 新增商品时可以上传商品照片

app/controllers/admin/products_controller.rb

```
...(略)
   def new
     @product = Product.new
   end

...(略)

   def product_params
-    params.require(:product).permit(:title, :description, :quantity, :price)
+    params.require(:product).permit(:title, :description, :quantity, :price, :image)
   end

...(略)
```

app/views/admin/products/new.html.erb

```
...(略)
  <div class="group">
    <%= f.input :price %>
  </div>

+ <div class="group">
+   <%= f.input :image, as: :file %>
+ </div>

  <%= f.submit "S
```

### Step 6: 商品修改页也能修改图片

app/views/admin/products/edit.html.erb

```
...(略)
  <div class="group">
    <%= f.input :price %>
  </div>

+ <% if @product.image.present? %>
+   <span>目前商品图</span> <br>
+   <%= image_tag(@product.image.thumb.url) %>
+ <% end %>

+ <div class="group">
+   <%= f.input :image, as: :file %>
+ </div>

  <%= f.submit "Submit", data: { disable_with: "Submitting..." } %>
...(略)
```

### Step 7: 将 uploads 资料夹放入 .gitignore

由于我们实作的图片上传功能，会将图片档案存在 public/uploads/xxx 的资料夹里面
我们不希望这些档案放进 git，所以要像 database.yml 一样将整个资料夹放入 .gitignore 里面

.gitignore

```
...(略)
config/database.yml
+ public/uploads
```

#### git存档

```
git add .
git commit -m "implement image upload"
```

### Step 8: 前台 products#show, products#index 实作

`rails g controller products`

#### 建立 products/index

app/controllers/products_controller.rb

```
class ProductsController < ApplicationController
+ def index
+   @products = Product.all
+ end
end
```

`touch app/views/products/index.html.erb`

app/views/products/index.html.erb

```
<div class="row">
  <% @products.each do |product| %>
    <div class="col-xs-6 col-md-3">
      <%= link_to product_path(product) do %>
        <% if product.image.present? %>
          <%= image_tag(product.image.thumb.url, class: "thumbnail") %>
        <% else %>
          <%= image_tag("http://placehold.it/200x200&text=No Pic", class: "thumbnail") %>
        <% end %>
      <% end %>
      <%= product.title %> ￥ <%= product.price %>
    </div>
  <% end %>
</div>
```

#### 修改首页路径

config/routes.rb

```
Rails.application.routes.draw do
- root 'welcome#index'
+ root 'products#index'  
  devise_for :users
  namespace :admin do
    resources :products
  end

+ resources :products

...(略)
```

#### 建立 products/show

app/controllers/products_controller.rb

```
class ProductsController < ApplicationController
  def index
    @products = Product.all
  end

+ def show
+   @product = Product.find(params[:id])
+ end
end
```

`touch app/views/products/show.html.erb`

app/views/products/show.html.erb

```
<div class="row">
  <div class="col-md-6">
    <% if @product.image.present? %>
      <%= image_tag(@product.image.medium.url, class: "thumbnail") %>
    <% else %>
      <%= image_tag("http://placehold.it/400x400&text=No Pic", class: "thumbnail") %>
    <% end %>
  </div>
  <div class="col-md-6">
    <h2> <%= @product.title %> </h2>
    <div style="height:100px;">
      <p>
        <%= @product.description %>
      </p>
    </div>
    <div> 数量 : <%= @product.quantity %> </div>
    <div class="product-price"> ￥ <%= @product.price %> </div>
    <div class="pull-right">
      <%= link_to("加入购物车", "#", :class => "btn btn-primary btn-lg btn-danger") %>
    </div>
  </div>
</div>
```

#### 在navbar加上product链接

app/views/common/_navbar.html.erb

```
...(略)
    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
+     <ul class="nav navbar-nav">
+       <li class="active">
+         <%= link_to("Products", products_path) %>
+       </li>
+     </ul>
...(略)
```

#### git存档

```
git add .
git commit -m "implement product show"
```

### Step 9: 重构后台商品列表

将 app/views/admin/products/index.html.erb 换成以下的 code

app/views/admin/products/index.html.erb

```
<h2> Product List </h2>
<div class="pull-right" style="padding-bottom: 20px;">
  <%= link_to("新增产品", new_admin_product_path, class: "btn btn-primary btn-sm") %>
</div>
<table class="table table-bordered">
  <thead>
    <tr>
      <th>#</th>
      <th width="220">Product Pic</th>
      <th>Name</th>
      <th>Price</th>
      <th width="100"> Options</th>
    </tr>
  </thead>
  <tbody>
    <% @products.each do |product| %>
      <tr>
        <td>
          <%= product.id %>
        </td>
        <td>
          <%= link_to product_path(product) do %>
            <% if product.image.present? %>
              <%= image_tag(product.image.thumb.url, class: "thumbnail") %>
            <% else %>
              <%= image_tag("http://placehold.it/200x200&text=No Pic", class: "thumbnail") %>
            <% end %>
          <% end %>
        </td>
        <td>
          <%= product.title %>
        </td>
        <td>
          <%= product.price %>
        </td>
        <td>
          <%= link_to("Edit", edit_admin_product_path(product)) %>
        </td>
      </tr>
    <% end %>
  </tbody>
</table>
```

完成

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/L3NIs9WgTeWXR6DP5Zwz_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-09-13%20%E4%B8%8B%E5%8D%888.21.09.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/L3NIs9WgTeWXR6DP5Zwz_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-09-13%20%E4%B8%8B%E5%8D%888.21.09.png)

#### navbar 的下拉选单放入后台链接

app/views/common/_navbar.html.erb

```
...(略)
          <li class="dropdown">
            <a href="#" class="dropdown-toggle" data-toggle="dropdown">
              Hi!, <%= current_user.email %>
              <b class="caret"></b>
            </a>
            <ul class="dropdown-menu">
+             <% if current_user.admin? %>
+               <li>
+                 <%= link_to("Admin 选单", admin_products_path ) %>
+               </li>
+             <% end %>
              <li>
                <%= link_to(content_tag(:i, '登出', class: 'fa fa-sign-out'), destroy_user_session_path, method: :delete) %>
              </li>
            </ul>
          </li>
...(略)
```

#### git存档

```
git add .
git commit -m "change admin/product backend panel"
```

## 效果动图

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/gSiJZ1aORw6IENlStTN2_jdstore-posts:207.gif)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/gSiJZ1aORw6IENlStTN2_jdstore-posts:207.gif)

# 从新手到胜任者

主讲人：
xdite老师

概要：

- 德雷福斯模型
- 学习编程需要经历的各个阶段

提示：
需要科学上网才可以正常观看本视频
如果画面模糊请到右下角设置中将画质调整为720p

### 本节作业

##### [购物网站 - 第二周作业](https://fullstack.xinshengdaxue.com/assignments/15)：[本周日记&周记](https://fullstack.xinshengdaxue.com/tasks/111)

已有 116 个第一期同学提交了这个作业 [**看看同学怎么做](https://fullstack.xinshengdaxue.com/tasks/111/other_answers?order=recent)

[**提交作业](https://fullstack.xinshengdaxue.com/tasks/111)

本周日记&周记
1.请使用[ORID格式](https://fullstack.xinshengdaxue.com/tasks/7)记录每天的学习日记
2.请根据你本周的学习情况写一篇总结周记，内容提到以下两点：
2.1 “本周学到的最棒概念/工具”
2.2 “本周遇到最大的坑”
然后把日记和周记的博客连接贴在这里，格式如下：
（注意：你的logdown连结应该会是这样 <http://yy4ever.logdown.com/posts/1143304> 而不会有edit的链接）

2/6 日记：（你的博客链接）
2/7 日记：（你的博客链接）
2/8 日记：（你的博客链接）
2/9 日记：（你的博客链接）
2/10 周记：（你的博客链接）

# 5-1 购物车实做

这一章节我们会实做的是找到商品之后

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/zGex3sDsRlezCvod3peA_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202017-02-01%20%E4%B8%8B%E5%8D%883.20.50.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/zGex3sDsRlezCvod3peA_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202017-02-01%20%E4%B8%8B%E5%8D%883.20.50.png)

加到购物车

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/FAyO00gsTwCa0AKVTObI_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202017-02-01%20%E4%B8%8B%E5%8D%883.21.03.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/FAyO00gsTwCa0AKVTObI_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202017-02-01%20%E4%B8%8B%E5%8D%883.21.03.png)

然后可以生成购物明细

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/30xu0O2SsmEDpOQgHkhM_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202017-02-01%20%E4%B8%8B%E5%8D%883.21.12.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/30xu0O2SsmEDpOQgHkhM_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202017-02-01%20%E4%B8%8B%E5%8D%883.21.12.png)

并在确定购物明细后，对订单结帐付款

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/DH7pSH1fTsOAT065cRp7_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202017-02-01%20%E4%B8%8B%E5%8D%883.22.52.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/DH7pSH1fTsOAT065cRp7_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202017-02-01%20%E4%B8%8B%E5%8D%883.22.52.png)

# 5-2 Step 1 : 建立加入购物车的 action

## 目标

这一节的目标是为了实做加入购物车的按钮，可以点击一下「加入购物车」的按钮，就将货品加入购物车

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/zGex3sDsRlezCvod3peA_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202017-02-01%20%E4%B8%8B%E5%8D%883.20.50.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/zGex3sDsRlezCvod3peA_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202017-02-01%20%E4%B8%8B%E5%8D%883.20.50.png)

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/93TowhpCRC2Ki4XLy62P_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-08-05%20%E4%B8%8B%E5%8D%881.01.07.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/93TowhpCRC2Ki4XLy62P_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-08-05%20%E4%B8%8B%E5%8D%881.01.07.png)

### 　Step 0

`git checkout -b story4`

### Step 1

实作一个「加入购物车」的按钮：

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/jji4tLMdTSSrQFFXMAyu_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-08-05%20%E4%B8%8B%E5%8D%881.02.34.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/jji4tLMdTSSrQFFXMAyu_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-08-05%20%E4%B8%8B%E5%8D%881.02.34.png)

修改 `app/views/products/show.html.erb`

app/views/products/show.html.erb

```
-  <%= link_to("加入购物车", "#", :class => "btn btn-primary btn-lg btn-danger") %>
+  <%= link_to("加入购物车", add_to_cart_product_path(@product), :method => :post, :class => "btn btn-primary btn-lg btn-danger") %>
```

然后修改 `app/controllers/products_controller.rb` 加入 `add_to_cart action`

app/controllers/products_controller.rb

```
+  def add_to_cart
+    @product = Product.find(params[:id])
+    redirect_to :back
+    flash[:notice] = "测试加入购物车"
+  end
```

修改 `config/routes.rb`

config/routes.rb

```
-  resources :products
+  resources :products do
+    member do
+      post :add_to_cart
+    end
+  end
```

```
git add .
git commit -m "add add_to_cart button"
```

## 成果

如果此步成功的话，点击「加入购物车」按钮之后，你应该可以见到绿色的Flash显示「测试加入购物车」。

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/UugW6TqFQLSPiukfmoMJ_jdstore-posts:221.gif)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/UugW6TqFQLSPiukfmoMJ_jdstore-posts:221.gif)

### 本节作业

##### [购物网站 - 第二周作业](https://fullstack.xinshengdaxue.com/assignments/15)：[Story4 加入购物车](https://fullstack.xinshengdaxue.com/tasks/107)

已有 177 个第一期同学提交了这个作业 [**看看同学怎么做](https://fullstack.xinshengdaxue.com/tasks/107/other_answers?order=recent)

[**提交作业](https://fullstack.xinshengdaxue.com/tasks/107)

- 完成加入购物车功能
- 完成购物车明细功能
- 可以看到购物车明细的总价
  请贴上你的 pull request
  并上传gif动画演示你的成果（拖曳到此处）

# 5-3 Step 2: 购物车设计 Part 1

## 目标

我们的最终目标，是要将 `app/controllers/products_controller.rb` 中的`add_to_cart` 里面，加入一行 `current_cart.add_product_to_cart(@product)` 完成加入购物车的任务。

app/controllers/products_controller.rb

```
  def add_to_cart
    @product = Product.find(params[:id])
    current_cart.add_product_to_cart(@product)
    redirect_to :back
  end
```

简单来说，我们要设计一台购物车 cart（ Model），这个购物车里面要能够执行 add_product_to_cart 这个方法，把商品加到购物车里。

## 解说

这一部份会比较难，所以我们会试着使用图解来解释如何设计 model。首先我们要来讲解购物车是如何被设计出来的

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/4d0sVOoQsiv5YWJOdlA0_iPhone%20image%20on%202017-02-01%20at%2015-51-37.jpeg)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/4d0sVOoQsiv5YWJOdlA0_iPhone%20image%20on%202017-02-01%20at%2015-51-37.jpeg)

这里有一台购物车。购物车里面有：苹果x 3，西瓜x2，柳橙 x5。

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/wD98QqOKTWunyDJCqSsq_iPhone%20image%20on%202017-02-01%20at%2015-58-35.jpeg)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/wD98QqOKTWunyDJCqSsq_iPhone%20image%20on%202017-02-01%20at%2015-58-35.jpeg)

购物车呢，可以有无限多格。所以你可以理解成为 `Cart` has_many `CartItem`

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/j4TTGtN1SWueFylWfmO7_iPhone%20image%20on%202017-02-01%20at%2016-03-46.jpeg)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/j4TTGtN1SWueFylWfmO7_iPhone%20image%20on%202017-02-01%20at%2016-03-46.jpeg)

`CartItem` 里面记载了两份资讯 `product`（哪一种物品） 与 `quantity`　（数量是多少）

## 步骤：

接下来我们就可以来产生与设计 Model

### Step 1：产生 Cart 与 CartItem 两个 model

`rails g model cart`

`rails g model cart_item`

### Step 2：修改 CartItem 的 migration

db/migrate/XXX(一堆数字)_create_cart_items.rb

```
class CreateCartItems < ActiveRecord::Migration[5.0]
  def change
    create_table :cart_items do |t|
+      t.integer :cart_id
+      t.integer :product_id
+      t.integer :quantity, default: 1
      t.timestamps
    end
  end
end
```

然后

`rake db:migrate`

### Step 3 修改 Cart

app/models/cart.rb

```
class Cart < ApplicationRecord
+  has_many :cart_items
+  has_many :products, through: :cart_items, source: :product
end
```

### Step 4 修改 CartItem

app/models/cart_item.rb

```
class CartItem < ApplicationRecord
+  belongs_to :cart
+  belongs_to :product
end
```

### Step 5 实做 add_product_to_cart

app/models/cart.rb

```
class Cart < ApplicationRecord
  has_many :cart_items
  has_many :products, through: :cart_items, source: :product

+  def add_product_to_cart(product)
+    ci = cart_items.build
+    ci.product = product
+    ci.quantity = 1
+    ci.save
+  end
end
```

```
git add .
git commit -m "implement add_product_to_cart function"
```

## 　结果

这样我们就完成了 `current_cart.add_product_to_cart(@product)` 的一半，可以执行 `cart.add_product_to_cart(product)` 这个动作。

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/7KjTKvOzRsSjqj6sWKLD_jdstore-posts:222.gif)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/7KjTKvOzRsSjqj6sWKLD_jdstore-posts:222.gif)

# 5-4 Step 3: 购物车设计 Part 2

## 目标

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/MwF3Qu9FSNy4u0rY4QKI_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202017-02-01%20%E4%B8%8B%E5%8D%884.20.57.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/MwF3Qu9FSNy4u0rY4QKI_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202017-02-01%20%E4%B8%8B%E5%8D%884.20.57.png)

我们的目的是为了每个进店的客户（不管是否有登入，都准备一台购物车）。
然后消费者随时可以察看购物车的产品数量。

## 步骤

### Step 1 : 显示购物车内物品数量

修改 `app/views/common/_navbar.html.erb`
加入

app/views/common/_navbar.html.erb

```
<ul class="nav navbar-nav navbar-right">
+ <li>
+    <%= link_to "#" do  %>
+       购物车 <i class="fa fa-shopping-cart"> </i> ( <%= current_cart.products.count %> )
+    <% end %>
+ </li>

  <% if !current_user %>
```

### Step 2 : 加入购物车代码

修改 `app/controllers/application_controller.rb`

app/controllers/application_controller.rb

```
class ApplicationController < ActionController::Base

 # ...略



+  helper_method :current_cart

+  def current_cart
+    @current_cart ||= find_cart
+  end

+  private

+  def find_cart
+    cart = Cart.find_by(id: session[:cart_id])
+    if cart.blank?
+      cart = Cart.create
+    end
+    session[:cart_id] = cart.id
+    return cart
+  end
end
```

### Step 3 : 加入 current_cart.add_product_to_cart(@product)

修改 `app/controllers/products_controller.rb`

app/controllers/products_controller.rb

```
  def add_to_cart
    @product = Product.find(params[:id])
-    redirect_to :back
-    flash[:notice] = "测试加入购物车"

+    current_cart.add_product_to_cart(@product)
+    flash[:notice] = "成功加入购物车"
+    redirect_to :back
  end
```

```
git add .
git commit -m "implement current_cart function"
```

## 结果

各位可以按下「加入购物车」的按钮，去看看购物车里的数字从 0 变成 1 。

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/dp7KoXFGTyMOUPFWZHec_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-08-05%20%E4%B8%8B%E5%8D%881.22.10.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/dp7KoXFGTyMOUPFWZHec_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-08-05%20%E4%B8%8B%E5%8D%881.22.10.png)

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/cLg8JduSTugGYgWBwZ0w_jdstore-posts:416.gif)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/cLg8JduSTugGYgWBwZ0w_jdstore-posts:416.gif)

## 解说

- 这部分代码目前对各位来说，是有相当难度的，我们不期待各位读到这一章时，能瞬间理解
- 不能够理解目前也没关系，只要当作是一段能让购物车「动起来」的代码就行
- 即便如此，我还是会尽量为各位解释

### 在 View 里面如何显示购物车内容数量 (helper_method)

app/views/common/_navbar.html.erb

```
<li>
   <%= link_to "#" do  %>
      购物车 <i class="fa fa-shopping-cart"> </i> ( <%= current_cart.products.count %> )
   <% end %>
</li>
```

在 view 里面，我们可以透过 `current_cart.products.count` 拿到购物车内的物品数量。
但是呢 `current_cart` 其实原本是一个 controller 内的 method，我们为了要在 view 里面要可以存取它。
所以，我们得在 `applications_controller.rb` 宣告他是 helper_method，才能直接存取。

app/controller/applications_controller.rb

```
class ApplicationController < ActionController::Base

 # ...略

  helper_method :current_cart
```

### current_cart 如何运作

购物车的构造是这样的：

app/controllers/application_controller.rb

```
class ApplicationController < ActionController::Base

 # ...略



  helper_method :current_cart

  def current_cart
    @current_cart ||= find_cart
  end

  private

  def find_cart
    cart = Cart.find_by(id: session[:cart_id])
    if cart.blank?
      cart = Cart.create
    end
    session[:cart_id] = cart.id
    return cart
  end
end
```

#### ||= 是什么

首先我们来解释 `||=` 是什么。

`a ||= b` 等于 `a = a || b`。意思是如果 a 是 nil 的话。 a 会被赋予　b 值。见下范例

```
a = nil
b = 20
a ||= b
```

a 会是多少？答案是`20`

所以

```
 def current_cart
    @current_cart ||= find_cart
  end
```

意思就是 `@current_cart` 是 `nil` 时会呼叫 `find_cart` 这个函式去判断消费者现在使用的是哪一台车。

#### find_cart 如何运作

```
 def find_cart
    cart = Cart.find_by(id: session[:cart_id])
    if cart.blank?
      cart = Cart.create
    end
    session[:cart_id] = cart.id
    return cart
  end
```

- 在每个人进店时，都会有一块电子感应卡，叫做 session，所以你的电子感应卡上面记录了你拿了哪台车 `cart_id`
- 所以呢，每个人「现在的车」 `current_cart` 就是透过这样的方式去存取的。
- 万一你的车丢失了没有关系。`if cart.blank?` 发现你的车不见了，会再给你一台车。重新登记上去。

# 5-5 Step 4 : 显示购物车明细

## 目标

按下购物车按钮时，可以看到购物明细

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/MqZhzK9YSTKOnWRd3Ll8_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202017-02-01%20%E4%B8%8B%E5%8D%883.21.12.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/MqZhzK9YSTKOnWRd3Ll8_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202017-02-01%20%E4%B8%8B%E5%8D%883.21.12.png)

## 步骤

### Step 1 : 新增 carts controller

`rails g controller carts`

### Step 2:

修改 `config/routes.rb`

加入

config/routes.rb

```
Rails.application.routes.draw do
...(略)
+  resources :carts
end
```

修改 `app/views/common/_navbar.html.erb` 让购物车实际可按

app/views/common/_navbar.html.erb

```
<li>
-  <%= link_to "#" do  %>
+  <%= link_to carts_path do  %>
     购物车 <i class="fa fa-shopping-cart"> </i> ( <%= current_cart.products.count %> )
  <% end %>
</li>
```

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/dp7KoXFGTyMOUPFWZHec_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-08-05%20%E4%B8%8B%E5%8D%881.22.10.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/dp7KoXFGTyMOUPFWZHec_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-08-05%20%E4%B8%8B%E5%8D%881.22.10.png)

#### Step 3: 实作购物明细：

`touch app/views/carts/index.html.erb`

app/views/carts/index.html.erb

```
<div class="row">
  <div class="col-md-12">

    <h2> 购物车 </h2>

    <table class="table table-bordered">
      <thead>
        <tr>
          <th colspan="2">商品资讯</th>
          <th>单价</th>
          <th>数量</th>
        </tr>
      </thead>
      <tbody>

        <% current_cart.cart_items.each do |cart_item| %>
          <tr>
            <td>
              <%= link_to product_path(cart_item.product) do %>
                <% if cart_item.product.image.present? %>
                  <%= image_tag(cart_item.product.image.thumb.url, class: "thumbnail") %>
                <% else %>
                  <%= image_tag("http://placehold.it/200x200&text=No Pic", class: "thumbnail") %>
                <% end %>
              <% end %>
            </td>
            <td>
              <%= link_to(cart_item.product.title, product_path(cart_item.product)) %>
            </td>
            <td>
              <%= cart_item.product.price %>
            </td>
            <td>
              <%= cart_item.quantity %>
            </td>
          </tr>
        <% end %>

      </tbody>
    </table>

    <br>

    <div class="total clearfix">
      <span class="pull-right">
         <span> 总计 xxx RMB  </span>
      </span>
    </div>

    <hr>

    <div class="checkout clearfix">
      <%= link_to("确认结账", "#", method: :post, class: "btn btn-lg btn-danger pull-right") %>
    </div>
  </div>
</div>
```

```
git add .
git commit -m "implement carts index function"
```

成功的话，应该会看到以下内容

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/lxbI8jNfTJqhya9d4rZF_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-08-05%20%E4%B8%8B%E5%8D%881.39.04.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/lxbI8jNfTJqhya9d4rZF_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-08-05%20%E4%B8%8B%E5%8D%881.39.04.png)

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/fLPSVrszRSe9ShgcIPaY_jdstore-posts:223.gif)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/fLPSVrszRSe9ShgcIPaY_jdstore-posts:223.gif)

# 5-6 Step 5 : 计算总价

## 目标

我们发现购物车里面，还没有计算总价。

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/MX1XnRCtRIuDIFz13lir_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-08-05%20%E4%B8%8B%E5%8D%881.46.46.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/MX1XnRCtRIuDIFz13lir_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-08-05%20%E4%B8%8B%E5%8D%881.46.46.png)

## 步骤：

### Step 1:

修改 `app/views/carts/index.html.erb`

app/views/carts/index.html.erb

```
...(略)
    <div class="total clearfix">
      <span class="pull-right">
         <span>
-           总计 xxx RMB
+           <% sum = 0 %>
+           <% current_cart.cart_items.each do |cart_item| %>
+             <% if cart_item.product.price.present? %>
+               <% sum = sum + cart_item.quantity * cart_item.product.price %>
+             <% end %>
+           <% end %>
+           总计 <%= sum %> RMB
         </span>
      </span>
    </div>
...(略)
```

应该会算出真正的总价

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/plqFQ148RMOJAtkYNv8l_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-08-05%20%E4%B8%8B%E5%8D%881.50.29.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/plqFQ148RMOJAtkYNv8l_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-08-05%20%E4%B8%8B%E5%8D%881.50.29.png)

### Step 2: （如何做的更好）Refactor 到 Helper 去

但是在 View 里面写这么多丑不拉叽的逻辑实在太难看了。况且「显示逻辑」应该使用 Helper 包装。于是我们可以再把这件事做得漂亮点：

修改　`app/views/carts/index.html.erb`

app/views/carts/index.html.erb

```
...(略)
    <div class="total clearfix">
      <span class="pull-right">
        <span>
-         <% sum = 0 %>
-         <% current_cart.cart_items.each do |cart_item| %>
-           <% if cart_item.product.price.present? %>
-             <% sum = sum + cart_item.quantity * cart_item.product.price %>
-           <% end %>
-         <% end %>
-         总计 <%= sum %> RMB
+         总计 <%= render_cart_total_price(current_cart) %> RMB
        </span>
      </span>
    </div>
...(略)
```

修改 `app/helpers/carts_helper.rb`

app/helpers/carts_helper.rb

```
module CartsHelper
+  def render_cart_total_price(cart)
+    sum = 0
+    cart.cart_items.each do |cart_item|
+      if cart_item.product.price.present?
+        sum += cart_item.quantity * cart_item.product.price
+      end
+    end
+    sum
+  end
end
```

### Step 3. （如何做的更好）Refactor 到 Model 去

但是算总价，其实不该是 Helper 的任务，而是 model 的任务，所以我们还可以进行下一次的重构

修改 `app/helpers/carts_helper.rb`

app/helpers/carts_helper.rb

```
module CartsHelper
  def render_cart_total_price(cart)
-    sum = 0
-    cart.cart_items.each do |cart_item|
-      if cart_item.product.price.present?
-        sum += cart_item.quantity * cart_item.product.price
-      end
-    end
-    sum
+    cart.total_price
  end
end
```

修改 `app/models/cart.rb`

app/models/cart.rb

```
class Cart < ApplicationRecord

  # ... 略


+  def total_price
+    sum = 0
+    cart_items.each do |cart_item|
+      if cart_item.product.price.present?
+        sum += cart_item.quantity * cart_item.product.price
+      end
+    end
+    sum
+  end
end
```

```
git add .
git commit -m "implement cart_total_price function"
```

## 效果动图

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/cjaUQgcRTgqTs8wuda5p_jdstore-posts:224.gif)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/cjaUQgcRTgqTs8wuda5p_jdstore-posts:224.gif)

# 5-7 购物车练习作业

- 请设计一个功能，可以一键清空购物车内所有的物品
- 某样东西突然不想买了，我可以在购物车内删除它
- 已经加入购物车的物品，不能重复被加入
- 可以更改购物车内购买的数量( 原本预设数量都是1）
- 库存为 0 的货品不能购买
- 在购物车新增数量时，不能更新超过原有库存的数量

### 本节作业

##### [购物网站 - 第二周作业](https://fullstack.xinshengdaxue.com/assignments/15)：[清空购物车](https://fullstack.xinshengdaxue.com/tasks/96)

已有 162 个第一期同学提交了这个作业 [**看看同学怎么做](https://fullstack.xinshengdaxue.com/tasks/96/other_answers?order=recent)

[**提交作业](https://fullstack.xinshengdaxue.com/tasks/96)

- 请设计一个功能，可以一键清空购物车内所有的物品
  请拉 pull request
  并上传gif动画演示你的成果（拖曳到此处）

##### [购物网站 - 第二周作业](https://fullstack.xinshengdaxue.com/assignments/15)：[可以删除购物车内某一物品](https://fullstack.xinshengdaxue.com/tasks/97)

已有 161 个第一期同学提交了这个作业 [**看看同学怎么做](https://fullstack.xinshengdaxue.com/tasks/97/other_answers?order=recent)

[**提交作业](https://fullstack.xinshengdaxue.com/tasks/97)

- 某样东西突然不想买了，我可以在购物车内删除它
  请拉 pull request
  并上传gif动画演示你的成果（拖曳到此处）

##### [购物网站 - 第二周作业](https://fullstack.xinshengdaxue.com/assignments/15)：[已经加入购物车的物品，不能重复被加入](https://fullstack.xinshengdaxue.com/tasks/98)

已有 162 个第一期同学提交了这个作业 [**看看同学怎么做](https://fullstack.xinshengdaxue.com/tasks/98/other_answers?order=recent)

[**提交作业](https://fullstack.xinshengdaxue.com/tasks/98)

- 已经加入购物车的物品，不能重复被加入
  请拉 pull request
  并上传gif动画演示你的成果（拖曳到此处）

##### [购物网站 - 第二周作业](https://fullstack.xinshengdaxue.com/assignments/15)：[可以更改购物车内购买的数量( 原本预设数量都是1）](https://fullstack.xinshengdaxue.com/tasks/99)

已有 161 个第一期同学提交了这个作业 [**看看同学怎么做](https://fullstack.xinshengdaxue.com/tasks/99/other_answers?order=recent)

[**提交作业](https://fullstack.xinshengdaxue.com/tasks/99)

- 可以更改购物车内购买的数量( 原本预设数量都是1）
  请拉 pull request
  并上传gif动画演示你的成果（拖曳到此处）

##### [购物网站 - 第二周作业](https://fullstack.xinshengdaxue.com/assignments/15)：[库存为 0 的货品不能购买](https://fullstack.xinshengdaxue.com/tasks/100)

已有 161 个第一期同学提交了这个作业 [**看看同学怎么做](https://fullstack.xinshengdaxue.com/tasks/100/other_answers?order=recent)

[**提交作业](https://fullstack.xinshengdaxue.com/tasks/100)

- 库存为 0 的货品不能购买
- 在 View 里面不可以加入购车
- 在 Controller 里面不可以加入购物车
  请拉 pull request
  并上传gif动画演示你的成果（拖曳到此处）

##### [购物网站 - 第二周作业](https://fullstack.xinshengdaxue.com/assignments/15)：[在购物车新增数量时，不能更新超过原有库存的数量](https://fullstack.xinshengdaxue.com/tasks/101)

已有 162 个第一期同学提交了这个作业 [**看看同学怎么做](https://fullstack.xinshengdaxue.com/tasks/101/other_answers?order=recent)

[**提交作业](https://fullstack.xinshengdaxue.com/tasks/101)

- 在购物车新增数量时，不能更新超过原有库存的数量
  请拉 pull request
  并上传gif动画演示你的成果（拖曳到此处）



# 5-8 本章学习以及复盘指南

本周因为难度突然间增加很高，所以我设计了一个帮助各位学习的小技巧，协助各位学习这一章。

1) 先按照教程贴 code，确保你的代码是能动的。
2) 请各位打开你的素描本。重新观看每一章指南，并且挑出你不懂的关键字，写在素描本上。
3) 写上去后不要马上查，立刻翻到下一章，继续写。看到不懂的关键词都写下来。

（如此图，在这一章正常数量会超过 10 个以上）

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/iKesmH0BRQijVfNSrw3q_iPhone%20image%20on%202017-02-03%20at%2022-29-56.jpeg)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/iKesmH0BRQijVfNSrw3q_iPhone%20image%20on%202017-02-03%20at%2022-29-56.jpeg)

4) OK 打开 google 开始查每一个词，并写一篇 logdown。

这个方法是为了克服各位大脑工作记忆区不足的技巧。
当你全部写一遍下来后，会神奇的心都不慌了。

接着你可以开始一个一个字慢慢查了。

等到查完之后，回去重看代码后，你会发现原先像外星文般的代码竟然渐渐都理解了。

### 本节作业

##### [购物网站 - 第二周作业](https://fullstack.xinshengdaxue.com/assignments/15)：[上传你的素描本问题笔记截图](https://fullstack.xinshengdaxue.com/tasks/109)

已有 94 个第一期同学提交了这个作业 [**看看同学怎么做](https://fullstack.xinshengdaxue.com/tasks/109/other_answers?order=recent)

[**提交作业](https://fullstack.xinshengdaxue.com/tasks/109)

请截图上传你的素描本问题笔记。

##### [购物网站 - 第二周作业](https://fullstack.xinshengdaxue.com/assignments/15)：[至少贴上五篇你找到的问题的答案](https://fullstack.xinshengdaxue.com/tasks/110)

已有 92 个第一期同学提交了这个作业 [**看看同学怎么做](https://fullstack.xinshengdaxue.com/tasks/110/other_answers?order=recent)

[**提交作业](https://fullstack.xinshengdaxue.com/tasks/110)

请写成文章，并在这里贴上网址。（至少五篇）

# 6-1 购物车练习作业 （解答）

### 目标

- 请设计一个功能，可以一键清空购物车内所有的商品
- 某商品突然不想买了，我可以在购物车内删除它
- 已经加入购物车的商品，不能重复被加入
- 可以更改购物车内购买的商品数量(原本预设数量都是1)
- 库存为 0 的商品不能购买
- 在购物车新增数量时，不能更新超过原有库存的商品数量

### 步骤

#### Step 1: 清空购物车

config/routes.rb

```
...(略)
 - resources :carts
 + resources :carts do
 +   collection do
 +     delete :clean
 +   end
 + end
```

app/views/carts/index.html.erb

```
...(略)
<div class="row">
  <div class="col-md-12">

+  <%= link_to("清空购物车", clean_carts_path ,
+              method: :delete , class: "pull-right",
+              style: "text-decoration: underline;",
+              data: { confirm: "你确定要清空整个购物车吗？"} )%>

    <h2> 购物车 </h2>

    <table class="table table-bordered">
...(略)
```

app/controllers/carts_controller.rb

```
class CartsController < ApplicationController
+ def clean
+   current_cart.clean!
+   flash[:warning] = "已清空购物车"
+   redirect_to carts_path
+ end
end
```

app/models/cart.rb

```
class Cart < ActiveRecord::Base
...(略)
+ def clean!
+   cart_items.destroy_all
+ end
end
```

```
git add .
git commit -m "empty cart"
```

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/tWM3uRNEQRKSuzqll9F6_jdstore-posts:226-step1.gif)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/tWM3uRNEQRKSuzqll9F6_jdstore-posts:226-step1.gif)

#### Step 2: 删除购物车内某一商品

`rails g controller cart_items`

config/routes.rb

```
Rails.application.routes.draw do
...(略)
+ resources :cart_items
end
```

app/views/carts/index.html.erb

```
...(略)
        <tr>
          <th colspan="2">商品资讯</th>
          <th>单价</th>
          <th>数量</th>
+         <th>操作选项 </th>
        </tr>
      </thead>
      <tbody>
...(略)
            <td>
              <%= cart_item.quantity %>
            </td>
+           <td>
+             <%= link_to cart_item_path(cart_item.product_id), method: :delete do %>
+               <i class="fa fa-trash"></i>
+             <% end %>
+           </td>
          </tr>
        <% end %>
...(略)
```

app/controllers/cart_items_controller.rb

```
class CartItemsController < ApplicationController
+  before_action :authenticate_user!

+  def destroy
+    @cart = current_cart
+    @cart_item = @cart.cart_items.find_by(product_id: params[:id])
+    @product = @cart_item.product
+    @cart_item.destroy

+    flash[:warning] = "成功将 #{@product.title} 从购物车删除!"
+    redirect_to :back
+  end
end
```

```
git add .
git commit -m "delete an item from cart"
```

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/k7hcKTFMQoeqBwqSjUQr_jdstore-posts:226-step2.gif)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/k7hcKTFMQoeqBwqSjUQr_jdstore-posts:226-step2.gif)

#### Step 3: 已经加入购物车的商品，不能重复被加入

app/controllers/products_contoller.rb

```
...(略)
  def show
    @product = Product.find(params[:id])
  end

  def add_to_cart
    @product = Product.find(params[:id])
+   if !current_cart.products.include?(@product)
      current_cart.add_product_to_cart(@product)
-     flash[:notice] = "成功加入购物车"
+     flash[:notice] = "你已成功将 #{@product.title} 加入购物车"
+   else
+     flash[:warning] = "你的购物车内已有此物品"
+   end
    redirect_to :back
  end
 ...(略)
```

```
git add .
git commit -m "cannot add same item in cart"
```

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/bgOmZCNwS0SMImh2uKNF_jdstore-posts:226-step3.gif)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/bgOmZCNwS0SMImh2uKNF_jdstore-posts:226-step3.gif)

#### Step 4: 可以更改购物车内购买的商品数量（原本预设数量都是1）

app/views/carts/index.html.erb

```
...(略)
        <td>
          <%= cart_item.product.price %>
        </td>
        <td>
-         <%= cart_item.quantity %>
+         <%= form_for cart_item, url: cart_item_path(cart_item.product_id) do |f| %>
+           <%= f.select :quantity, [1,2,3,4,5] %>
+           <%= f.submit "更新", data: { disable_with: "Submiting..." } %>
+         <% end %>
        </td>
...(略)
```

app/controllers/cart_items_controller.rb

```
class CartItemsController < ApplicationController
...(略)
+  def update
+    @cart = current_cart
+    @cart_item = @cart.cart_items.find_by(product_id: params[:id])
+    @cart_item.update(cart_item_params)

+    redirect_to carts_path
+  end

+  private

+  def cart_item_params
+    params.require(:cart_item).permit(:quantity)
+  end
end
```

```
git add .
git commit -m "change quantity in cart"
```

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/FosOUFeAQFyAVFIGbka6_jdstore-posts:226-step4.gif)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/FosOUFeAQFyAVFIGbka6_jdstore-posts:226-step4.gif)

#### Step 5: 库存为 0 的商品不能购买

- 在 View 里面不可以加入购物车
- 在 Controller 里面不可以加入购物车

view 的设定

app/views/products/show.html.erb

```
...(略)
    <div class="product-price"> ¥ <%= @product.price %> </div>

    <div class="pull-right">
+     <% if @product.quantity.present? && @product.quantity > 0 %>
        <%= link_to("加入购物车", add_to_cart_product_path(@product), method: :post,
                    class: "btn btn-lg btn-danger") %>
+     <% else %>
+       已销售一空，无法购买
+     <% end %>
    </div>
...(略)
```

结果：点入商品页面时，库存为0的商品，加入购物车按钮不显示 

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/veOrBp7MTiKs96LfQ9O7_%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-02-07%2016.40.28.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/veOrBp7MTiKs96LfQ9O7_%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-02-07%2016.40.28.png)

controller 的设定

app/controllers/cart_items_controller.rb

```
...(略)
  def update
    @cart = current_cart
    @cart_item = @cart.cart_items.find_by(product_id: params[:id])

+   if @cart_item.product.quantity >= cart_item_params[:quantity].to_i
      @cart_item.update(cart_item_params)
+     flash[:notice] = "成功变更数量"
+   else
+     flash[:warning] = "数量不足以加入购物车"
+   end

    redirect_to carts_path
  end
...(略)
```

结果：尝试将购物车内的商品数量，更新为大于库存的数量(or库存<=0)，将会导致无法操作并弹出警示 

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/ZiwXZXCqR9uyvhS0RNhn_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-09-20%20%E4%B8%8A%E5%8D%8811.26.43.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/ZiwXZXCqR9uyvhS0RNhn_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-09-20%20%E4%B8%8A%E5%8D%8811.26.43.png)

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/l0nNCkAtSd6uYuKOfhau_jdstore-posts:226-step5.gif)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/l0nNCkAtSd6uYuKOfhau_jdstore-posts:226-step5.gif)

```
git add .
git commit -m "cannot add item with quantity 0"
```

#### Step 6: 在购物车新增数量时，不能更新超过原有库存的数量

app/views/carts/index.html.erb

```
...(略)
            <td>
              <% cart_item = current_cart.cart_items.find_by(product_id: cart_item.product_id) %>

              <%= form_for cart_item, url: cart_item_path(cart_item.product_id) do |f| %>
-               <%= f.select :quantity, [1,2,3,4,5] %>
+               <%= f.select :quantity, 1..cart_item.product.quantity %>
                <%= f.submit "更新", data: { disable_with: "Submiting..." } %>
              <% end %>
            </td>
            <td>
...(略)
```

结果：库存为10，最多仅能更改数量为10 

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/Nvb9rDA0TwSoh9hSUgGx_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-09-20%20%E4%B8%8A%E5%8D%8811.31.08.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/Nvb9rDA0TwSoh9hSUgGx_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-09-20%20%E4%B8%8A%E5%8D%8811.31.08.png)

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/wEC7TXi76S86an0HDwWV_jdstore-posts:226-step6.gif)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/wEC7TXi76S86an0HDwWV_jdstore-posts:226-step6.gif)

```
git add .
git commit -m "cannot change quantity which exceed stock"
```

# 7-1 Step 1 : 建立结帐页

## 目标

在购物车按下「确认结帐」按钮后

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/plqFQ148RMOJAtkYNv8l_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-08-05%20%E4%B8%8B%E5%8D%881.50.29.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/plqFQ148RMOJAtkYNv8l_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-08-05%20%E4%B8%8B%E5%8D%881.50.29.png)

可以显示结帐明细，并且可以让消费者输入寄送地址

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/uKlDmXfQODGomFujGuQk_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-08-05%20%E4%B8%8B%E5%8D%883.51.09.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/uKlDmXfQODGomFujGuQk_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-08-05%20%E4%B8%8B%E5%8D%883.51.09.png)

## 步骤

### Step 0 :

`git checkout -b story5`

### Step 1 : 建立结帐页 routing

修改 `app/views/carts/index.html.erb`

app/views/carts/index.html.erb

```
...(略)
    <div class="checkout clearfix">
－      <%= link_to("确认结账", "#", method: :post, class: "btn btn-lg btn-danger pull-right") %>
＋      <%= link_to("确认结账", checkout_carts_path, method: :post, class: "btn btn-lg btn-danger pull-right") %>
    </div>
...(略)
```

修改 `config/routes.rb`

config/routes.rb

```
...(略)
  resources :carts do
    collection do
      delete :clean
+      post :checkout
    end
  end
...(略)
```

```
git add .
git commit -m "add checkout routing"
```

### Step 2 : 建立 Order model

从结帐页面看，一张订单最少要有几个信息：

- 总价 total
- 谁的订单 user_id
- 购买人姓名、地址 billing_name、billing_address
- 收件人姓名、地址 shipping_name、shipping_address 所以 `rails g model order`

db/migrate/XXX(一堆数字)_create_orders.rb

```
class CreateOrders < ActiveRecord::Migration[5.0]
  def change
    create_table :orders do |t|
+      t.integer :total, default: 0
+      t.integer :user_id
+      t.string :billing_name
+      t.string :billing_address
+      t.string :shipping_name
+      t.string :shipping_address
      t.timestamps
    end
  end
end
```

然后执行

`rake db:migrate`

```
git add .
git commit -m "add order model"
```

### Step 3 : 建立结帐页

app/controllers/carts_controller.rb

```
class CartsController < ApplicationController
...(略)
+  def checkout
+    @order = Order.new
+  end
end
```

`touch app/views/carts/checkout.html.erb`

app/views/carts/checkout.html.erb

```
<div class="row">
   <div class="col-md-12">

    <h2> 购物明细 </h2>

    <table class="table table-bordered">
      <thead>
        <tr>
          <th width="80%">商品明细</th>
          <th>单价</th>
          <th>数量</th>
        </tr>
      </thead>
      <tbody>

        <% current_cart.cart_items.each do |cart_item| %>
          <tr>
            <td>
              <%= link_to(cart_item.product.title, product_path(cart_item.product)) %>
            </td>
            <td>
              <%= cart_item.product.price %>
            </td>

            <td>
              <%= cart_item.quantity %>
            </td>

          </tr>
        <% end %>

      </tbody>
    </table>

    <div class="total clearfix">
      <span class="pull-right">
        总计 <%= render_cart_total_price(current_cart) %> CNY
      </span>
    </div>

    <hr>

    <h2> 订单资讯 </h2>

    <div class="order-form">

      <%= simple_form_for @order do |f| %>



          <legend> 订购人</legend>
          <div class="form-group col-lg-6">
            <%= f.input :billing_name  %>
          </div>
          <div class="form-group col-lg-6">
            <%= f.input :billing_address  %>
          </div>

          <legend> 收货人</legend>
          <div class="form-group col-lg-6">
           <%= f.input :shipping_name  %>
          </div>
          <div class="form-group col-lg-6">
            <%= f.input :shipping_address  %>
          </div>

        <div class="checkout">
          <%= f.submit "生成订单", class: "btn btn-lg btn-danger pull-right",
                       data: { disable_with: "Submitting..." } %>
        </div>
      <% end %>

    </div>
  </div>
</div>
```

config/routes.rb

```
Rails.application.routes.draw do
...(略)
+  resources :orders
end
```

```
git add .
git commit -m "touch app/views/carts/checkout.html.erb"
```

### Step 4 : 限制必须填写“寄件人”与“购买人资讯”

app/models/order.rb

```
class Order < ApplicationRecord
+  belongs_to :user

+  validates :billing_name, presence: true
+  validates :billing_address, presence: true
+  validates :shipping_name, presence: true
+  validates :shipping_address, presence: true

end
```

### Step 5: 建立订单 action

`rails g controller orders`

app/controllers/orders_controller.rb

```
class OrdersController < ApplicationController
+  before_action :authenticate_user!, only: [:create]

+  def create
+    @order = Order.new(order_params)
+    @order.user = current_user
+    @order.total = current_cart.total_price

+    if @order.save
+      redirect_to order_path(@order)
+    else
+      render 'carts/checkout'
+    end
+  end

+  private

+  def order_params
+    params.require(:order).permit(:billing_name, :billing_address, :shipping_name, :shipping_address)
+  end
end
```

app/models/user.rb

```
class User < ApplicationRecord
+  has_many :orders
...(略)  
```

```
git add .
git commit -m "add order controller"
```

此时按下生成订单页面，会报错（正常，因为下一节才会写show）

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/bDqUK3TlRdaJCZHFOP9X_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-09-20%20%E4%B8%8B%E5%8D%881.53.51.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/bDqUK3TlRdaJCZHFOP9X_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-09-20%20%E4%B8%8B%E5%8D%881.53.51.png)

我们到rails console查看刚刚的订单是否已经生成，输入Order.last

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/K4heKPF9TzY5ubfg3d2Q_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-09-20%20%E4%B8%8B%E5%8D%881.54.34.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/K4heKPF9TzY5ubfg3d2Q_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-09-20%20%E4%B8%8B%E5%8D%881.54.34.png)

## 效果动图

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/jjJYmUxvTB2vCv5HW8Zf_jdstore-posts:227.gif)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/jjJYmUxvTB2vCv5HW8Zf_jdstore-posts:227.gif)

### 本节作业

##### [购物网站 - 第二周作业](https://fullstack.xinshengdaxue.com/assignments/15)：[Story5 建立结帐页](https://fullstack.xinshengdaxue.com/tasks/106)

已有 165 个第一期同学提交了这个作业 [**看看同学怎么做](https://fullstack.xinshengdaxue.com/tasks/106/other_answers?order=recent)

[**提交作业](https://fullstack.xinshengdaxue.com/tasks/106)

- 可以填写寄送资讯
- 订单明细页
- 订单明细页网址必须秘密
  请拉 pull request
  并上传gif动画演示你的成果（拖曳到此处）

# 7-2 Step 2 : 建立购买明细

## 目标

这时候我们突然发现一件事，购买好像要建立一个“购买明细”。

这个购买明细呢，还不能直接用 product_id 的方式记录信息。

因为

- 有时候商品会下架
- 或者价格会改变

我们需要新建立一个 model 去储存当时购买的信息。

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/AS5M6E5NQMuHqeokflca_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202017-02-01%20%E4%B8%8B%E5%8D%885.09.14.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/AS5M6E5NQMuHqeokflca_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202017-02-01%20%E4%B8%8B%E5%8D%885.09.14.png)

## 步骤

### Step 1: 建立 ProductList model

至少要有

- 订单编号 order_id
- 商品当时的名称 product_name
- 商品当时的价格 product_price
- 购买数量 quantity

`rails g model product_list`

db/migrate/XXX(一堆数字)_create_product_lists.rb

```
class CreateProductLists < ActiveRecord::Migration[5.0]
  def change
    create_table :product_lists do |t|
+      t.integer :order_id
+      t.string  :product_name
+      t.integer :product_price
+      t.integer :quantity
      t.timestamps
    end
  end
end
```

`rake db:migrate`

app/models/order.rb

```
class Order < ApplicationRecord
...(略)

+  has_many :product_lists
end
```

app/models/product_list.rb

```
class ProductList < ApplicationRecord
+  belongs_to :order
end
```

```
git add .
git commit -m "add product_list model"
```

### Step 2：在订单建立后建立购买明细缓存

app/controllers/orders_controller.rb

```
class OrdersController < ApplicationController
  before_action :authenticate_user!, only: [:create]

  def create
    @order = Order.new(order_params)
    @order.user = current_user
    @order.total = current_cart.total_price

    if @order.save

+      current_cart.cart_items.each do |cart_item|
+        product_list = ProductList.new
+        product_list.order = @order
+        product_list.product_name = cart_item.product.title
+        product_list.product_price = cart_item.product.price
+        product_list.quantity = cart_item.quantity
+        product_list.save
+      end

      redirect_to order_path(@order)
    else
      render 'carts/checkout'
    end
  end

  private

  def order_params
    params.require(:order).permit(:billing_name, :billing_address, :shipping_name, :shipping_address)
  end
end
```

### Step 3 : 建立订单明细

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/lIMyxHJkQsSC3ExN0rhH_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-08-05%20%E4%B8%8B%E5%8D%884.13.45.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/lIMyxHJkQsSC3ExN0rhH_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-08-05%20%E4%B8%8B%E5%8D%884.13.45.png)

app/controllers/orders_controller.rb

```
...(略)
+  def show
+    @order = Order.find(params[:id])
+    @product_lists = @order.product_lists
+  end

private
...(略)
```

`touch app/views/orders/show.html.erb`

app/views/orders/show.html.erb

```
<div class="row">
  <div class="col-md-12">

    <h2> 订单明细 </h2>

    <table class="table table-bordered">
      <thead>
        <tr>
          <th width="80%">商品明细</th>
          <th>单价</th>
        </tr>
      </thead>
      <tbody>

        <% @product_lists.each do |product_list| %>
          <tr>
            <td>
              <%= product_list.product_name %>
            </td>
            <td>
              <%= product_list.product_price %>
            </td>
          </tr>
        <% end %>

      </tbody>
    </table>

    <div class="total clearfix">
      <span class="pull-right">
        总计 <%= @order.total %> CNY
      </span>
    </div>

     <hr>

     <h2> 寄送资讯 </h2>

     <table class="table table-striped table-bordered">
      <tbody>
        <tr>
          <td>
            订购人
          </td>
        </tr>
        <tr>
          <td>
            <%= @order.billing_name %> - <%= @order.billing_address %>
          </td>
        </tr>
        <tr>
          <td>
            收件人
          </td>
        </tr>
        <tr>
          <td>
            <%= @order.shipping_name %> - <%= @order.shipping_address %>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>
```

```
git add .
git commit -m "add orders show function"
```

## 效果动图

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/L1KUarQSXevj4Vj2pQFw_jdstore-posts:228.gif)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/L1KUarQSXevj4Vj2pQFw_jdstore-posts:228.gif)

# 7-3 Step 3 : 将网址改为秘密

## 目标

订单完成之后，我们赫然发现有一个严重的问题，我们产生的订单是流水号。

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/ULpESOhOQFQuQUhwwBH4_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202017-02-01%20%E4%B8%8B%E5%8D%885.20.03.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/ULpESOhOQFQuQUhwwBH4_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202017-02-01%20%E4%B8%8B%E5%8D%885.20.03.png)

如此一来：

- 路人都知道你每天的生意成交量是多少
- 路人可以猜到规律

非常危险。

因此，我们必须把订单号码改成乱序编码。如下图

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/5a3Zim2tSruXoZZaJnnB_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-08-05%20%E4%B8%8B%E5%8D%884.22.06.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/5a3Zim2tSruXoZZaJnnB_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-08-05%20%E4%B8%8B%E5%8D%884.22.06.png)

从 `/orders/1` 改成 `/orders/0f054ab5-2833-4a6d-bde5-0820b68fffae`

## 步骤

### Step 1:

我们在订单这个 model 里面加上一个栏位叫 token 存订单乱序号

`rails g migration add_token_to_order`

db/migrate/XXX(一堆数字)_add_token_to_order.rb

```
class AddTokenToOrder < ActiveRecord::Migration[5.0]
  def change
+    add_column :orders, :token, :string
  end
end
```

`rake db:migrate`

### Step 2:

app/models/order.rb

```
class Order < ApplicationRecord
+  before_create :generate_token

+  def generate_token
+    self.token = SecureRandom.uuid
+  end
...(略)
end
```

### Step 3 修改重导网址

app/controllers/orders_controller.rb

```
...(略)
  def create
    @order = Order.new(order_params)
    @order.user = current_user
    @order.total = current_cart.total_price

    if @order.save
      current_cart.cart_items.each do |cart_item|
        product_list = ProductList.new
        product_list.order = @order
        product_list.product_name = cart_item.product.title
        product_list.product_price = cart_item.product.price
        product_list.quantity = cart_item.quantity
        product_list.save
      end
-     redirect_to order_path(@order)
+     redirect_to order_path(@order.token)
    else
      render 'carts/checkout'
    end
  end

  def show
-   @order = Order.find(params[:id])
+   @order = Order.find_by_token(params[:id])
    @product_lists = @order.product_lists
  end
...(略)
```

```
git add .
git commit -m "add token to order"
```

## 效果动图

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/J8KC3bmLTLGykSeKFlzi_jdstore-posts:229.gif)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/J8KC3bmLTLGykSeKFlzi_jdstore-posts:229.gif)

## 解说

### before_create

app/models/order.rb

```
class Order < ApplicationRecord
  before_create :generate_token

  def generate_token
    self.token = SecureRandom.uuid
  end
end
```

`before_create` 是 Rails model 内建的 callbacks，目的是让资料生成储存前先执行某某动作。比如说我们在这里就是让订单在生成前，先生成「乱数序号」。而`SecureRandom.uuid` 是 Ruby 内建的随机生成器。

# 7-4 订单练习作业

- 使用者可以在 /account/orders/ 看到过去所有订单
- 使用者在下拉式选单可以看到过去所有的订单

### 本节作业

##### [购物网站 - 第二周作业](https://fullstack.xinshengdaxue.com/assignments/15)：[使用者可以看到过去所有订单](https://fullstack.xinshengdaxue.com/tasks/103)

已有 153 个第一期同学提交了这个作业 [**看看同学怎么做](https://fullstack.xinshengdaxue.com/tasks/103/other_answers?order=recent)

[**提交作业](https://fullstack.xinshengdaxue.com/tasks/103)

- 使用者可以在 /account/orders/ 看到过去所有订单
  请拉 pull request
  并上传gif动画演示你的成果（拖曳到此处）

**

#[直播回放]2月9日 豆知识

# 7-5 豆知识

## new 与 build

```
Order.new    (O) 新增一个Order的物件
Order.build  (X) 没有这种写法
```

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/7y4CuK71QHy33SMRtCSg_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-05-16%20%E4%B8%8B%E5%8D%885.12.14.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/7y4CuK71QHy33SMRtCSg_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-05-16%20%E4%B8%8B%E5%8D%885.12.14.png)

在rails源码里面`new`与`build`是alias(别名)，所以以下两种写法等价

```
current_user.orders.new  (O)
current_user.orders.build (O)
```

以新建订单为例，教材给出的写法是：

```
def create
  @order = Order.new
  @order.user = current_user
end
```

也可以这样写：

```
def create
  @order = current_user.orders.build
end
```

## 限制使用者只能看到自己的订单

我们可以这样写：

```
def show
  @order = Order.find(params[:id])
  if @order.user != current_user
    redirect_to root_path
  end
end
```

但是这样写更好：

```
def show
  @order = currernt_user.orders.find(params[:id])
end
```

在使用后一种写法时，如果输入其他用户的订单地址，localhost3000是红色报错，heroku(production)是直接404，最好不让user知道他做了什么而导致错误，这样比较安全。

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/OVThu81eTleTOfV50s7y_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-05-16%20%E4%B8%8B%E5%8D%885.27.11.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/OVThu81eTleTOfV50s7y_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-05-16%20%E4%B8%8B%E5%8D%885.27.11.png)

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/tyKMDN1lTOaynEtlU6qu_pasted-image.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/tyKMDN1lTOaynEtlU6qu_pasted-image.png)

## find 与 find_by

若 id = 1 的资料不存在

```
Order.find(1) => Couldn’t find Order with ‘id’=1
```

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/cyoQm74JQRKR0SbMwd17_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-05-16%20%E4%B8%8B%E5%8D%885.33.47.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/cyoQm74JQRKR0SbMwd17_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-05-16%20%E4%B8%8B%E5%8D%885.33.47.png)

```
Order.find_by_id(1) => nil
```

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/icImrs73TbO9GW24kq0w_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-05-16%20%E4%B8%8B%E5%8D%885.35.10.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/icImrs73TbO9GW24kq0w_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-05-16%20%E4%B8%8B%E5%8D%885.35.10.png)

所以在设计购物车时，这样写：

```
cart = Cart.find_by(id: session[:cart_id])
```

如果使用以下写法，打开首页就会报错

```
cart = Cart.find(session[:cart_id])
```

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/nvono8lJTnyKQhr8qip6_%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-02-13%2012.49.40.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/nvono8lJTnyKQhr8qip6_%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-02-13%2012.49.40.png)

## find_by 与 where

这两种写法是等价的，会找第一笔订单

```
order = Order.find_by_token(“xxx”)

order = Order.where(:token => “xxx”).first
```

要想同时查name和email，怎么写？

```
order = Order.find_by_name_and_email(“xxx”, “xxx@xxx.com”)

order = Order.where(:name => “xxx”,  :email => “xxx@xxx.com”).first
```

你还可以...

```
Order.find_by_xxx_and_yyy_and_zzz_and…
```

真的可以用，但是不要用，code会很难维护

## ! 与 ?

### ! 放在前面

`!current_user（如果 current_user 不存在）此时的！代表 NOT`

### != 放在一起

`current_user != user （不等于）`

### ! 放在后面

Ruby 内 xxxx! 表示执行此 method 会变更自己状态

```
2.3.2 :001 > STRING = "A"
 => "A"
2.3.2 :002 > STRING.downcase
 => "a"
2.3.2 :003 > STRING
 => "A"
2.3.2 :004 > STRING.downcase!
 => "a"
2.3.2 :005 > STRING
 => "a"
```

ActiveRecord 内 xxxx! 表示执行此 method 有可能 raise error (ActiveRecord就是rails用的库)

```
User.create => false
User.create!  => ActiveRecord::RecordInvalid
```

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/8ATRhrTCGoaK9pCdkCDA_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-05-16%20%E4%B8%8B%E5%8D%885.46.21.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/8ATRhrTCGoaK9pCdkCDA_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-05-16%20%E4%B8%8B%E5%8D%885.46.21.png)

debug好招，但生产环境中不要用，会出现500报错

### xxx?

Ruby 内 xxx? 表示执行此 method 回传值是 boolean (true/false)

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/faglSWATdqNVO04beqiX_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-05-16%20%E4%B8%8B%E5%8D%885.56.13.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/faglSWATdqNVO04beqiX_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-05-16%20%E4%B8%8B%E5%8D%885.56.13.png)

# 7-6 项目管理

打开github repo，点击 `Projects` ，然后点击 `Create a project`

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/ol10v7lTQCWDheihIz1s_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-10-25%20%E4%B8%8B%E5%8D%884.09.34.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/ol10v7lTQCWDheihIz1s_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-10-25%20%E4%B8%8B%E5%8D%884.09.34.png)

填写 `Name` 以及 `Description` 之后，点击 `Save project`

然后点击 `Add column`，建四个栏: `功能开发 技术细节 视觉设计 完成区域`

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/nfXrUulSXKgnnI6YmphW_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-10-25%20%E4%B8%8B%E5%8D%884.10.54.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/nfXrUulSXKgnnI6YmphW_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-10-25%20%E4%B8%8B%E5%8D%884.10.54.png)

将User Story填在 `功能开发` 栏，具体步骤填在 `技术细节` 栏，页面版式相关工作填在 `视觉设计` 栏，把已经完成的部分拖动到 `完成区域`

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/U8cItGnQT2Rbf0k8OnYb_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202017-02-09%20%E4%B8%8B%E5%8D%887.12.16.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/U8cItGnQT2Rbf0k8OnYb_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202017-02-09%20%E4%B8%8B%E5%8D%887.12.16.png)

### 本节作业

##### [购物网站 - 第三周作业](https://fullstack.xinshengdaxue.com/assignments/10)：[提供你的github project](https://fullstack.xinshengdaxue.com/tasks/112)

已有 117 个第一期同学提交了这个作业 [**看看同学怎么做](https://fullstack.xinshengdaxue.com/tasks/112/other_answers?order=recent)

[**提交作业](https://fullstack.xinshengdaxue.com/tasks/112)

\* 请依照本章教材，贴上你的github project项目网址
\* 并将user story填好后，截图放上来

# 8-1 订单练习作业（解答）

### 目标

- 使用者可以在 /account/orders/ 看到过去所有订单
- 使用者在下拉式选单可以看到过去所有的订单

### 步骤

#### Step 1: 建立 account/orders 的 controller & view

`rails g controller account::orders`

config/routes.rb

```
Rails.application.routes.draw do
...(略)
+ namespace :account do
+   resources :orders
+ end
end
```

app/controllers/account/orders_controller.rb

```
class Account::OrdersController < ApplicationController
+  before_action :authenticate_user!

+  def index
+    @orders = current_user.orders
+  end
end
```

`touch app/views/account/orders/index.html.erb`

app/views/account/orders/index.html.erb

```
<h2>订单列表 </h2>

<table class="table table-bordered">
  <thead>
    <tr>
      <th>#</th>
      <th>生成时间</th>

    </tr>
  </thead>
  <tbody>

    <% @orders.each do |order| %>
    <tr>
      <td> <%= link_to(order.id, order_path(order.token)) %> </td>
      <td> <%= order.created_at.to_s(:long) %> </td>
    </tr>
    <% end %>

  </tbody>
</table>
```

<http://localhost:3000/account/orders> 可以看到曾经下过的订单列表

#### Bug 解决: 之前的订单没有 token 资料

由于在开发时，到后面才实作将订单加入 token 的栏位，所以导致之前的订单资料完全没有 token 的数值 这会导致在这章可能会出现如下的问题

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/TeEj9SO4TP2KbjJQjtpl_pOzD1moQQ263h1dCCMcK_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-02-26%20%E4%B8%8B%E5%8D%881.41.38.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/TeEj9SO4TP2KbjJQjtpl_pOzD1moQQ263h1dCCMcK_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-02-26%20%E4%B8%8B%E5%8D%881.41.38.png)

解决方法：
`rails c` 到 rails console 输入以下指令:
`Order.where(token: nil).destroy_all`

#### Step 2: 订单的排列顺序按照 最新 -> 最旧 排列

app/controllers/account/orders_controller.rb

```
class Account::OrdersController < ApplicationController
  before_action :authenticate_user!

  def index
-   @orders = current_user.orders
+   @orders = current_user.orders.order("id DESC")
  end
end
```

<http://localhost:3000/account/orders>
最新订单会在上方

#### Step 3: navbar 新增个人订单列表的连结

app/views/common/_navbar.html.erb

```
...(略)
            <ul class="dropdown-menu">
              <% if current_user.admin? %>
                <li>
                  <%= link_to("Admin 选单", admin_products_path ) %>
                </li>
              <% end %>
+             <li>
+               <%= link_to("个人订单列表", account_orders_path ) %>
+             </li>
              <li>
                <%= link_to("登出", destroy_user_session_path, method: :delete ) %>
              </li>
            </ul>
...(略)
```

```
git add .
git commit -m "users can see their orders"
```

### 效果动图

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/WfPTi1DpQgiYm9VUYZmA_jdstore-posts:233.gif)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/WfPTi1DpQgiYm9VUYZmA_jdstore-posts:233.gif)

# 9-1 Step 1 : 消费者可以针对订单付款

## 目标

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/7F2BF4ioTYq6UGDe6HJ8_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202017-02-02%20%E4%B8%8B%E5%8D%884.23.35.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/7F2BF4ioTYq6UGDe6HJ8_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202017-02-02%20%E4%B8%8B%E5%8D%884.23.35.png)

这一章我们要实做的内容是：为订单页面加上付款按钮，消费者可以在这个页面上点击付费，并且分为两种渠道。

主要思路为：

- 使用 is_paid（boolean 属性）判断是否已付费
- 使用 payment_method 判断，实际付款渠道为：微信、支付宝
- 已付款过的订单不可以再付

## 步骤

### Step 1: 将订单分为「已付款」、「未付款」

- 新增一个栏位 `is_paid` 到 `Order` 这个 model，使用 boolean （true / false ) 属性
- 预设是 false（未付费）。

`rails g migration add_is_paid_to_order`

db/migrate/XXX(一堆数字)_add_is_paid_to_order.rb

```
class AddIsPaidToOrder < ActiveRecord::Migration[5.0]
  def change
+    add_column :orders, :is_paid, :boolean, default: false
  end
end
```

`rake db:migrate`

### Step 2: 记录订单付款方式

- 新增一个栏位 `payment_method` 到 `Order` 这个 model，使用 string 属性

`rails g migration add_payment_method_to_order`

db/migrate/XXX(一堆数字)_add_payment_method_to_order.rb

```
class AddPaymentMethodToOrder < ActiveRecord::Migration[5.0]
  def change
+    add_column :orders, :payment_method, :string
  end
end
```

`rake db:migrate`

### Step 3: 在 show 页面上加入结帐按钮

修改 `app/views/orders/show.html.erb`

app/views/orders/show.html.erb

```
  </table>

+   <div class="group pull-right">
+     <%= link_to("以支付宝支付", pay_with_alipay_order_path(@order.token), :method => :post, :class => "btn btn-danger") %>
+     <%= link_to("以微信支付", pay_with_wechat_order_path(@order.token), :method => :post, :class => "btn btn-danger") %>
+   </div>

  </div>
</div>
```

### Step 4: 设定路径

修改 `config/routes.rb`

config/routes.rb

```
...(略)
-  resources :orders
+  resources :orders do
+    member do
+      post :pay_with_alipay
+      post :pay_with_wechat
+    end
+  end
...(略)
```

### Step 5: 设定Controller

修改 `app/controllers/orders_controller.rb`

app/controllers/orders_controller.rb

```
...(略)
def pay_with_alipay
    @order = Order.find_by_token(params[:id])
    @order.set_payment_with!("alipay")
    @order.pay!

    redirect_to order_path(@order.token), notice: "使用支付宝成功完成付款"
  end

  def pay_with_wechat
    @order = Order.find_by_token(params[:id])
    @order.set_payment_with!("wechat")
    @order.pay!

    redirect_to order_path(@order.token), notice: "使用微信成功完成付款"
  end
...(略)
```

### Step 6: 修改 model 设定 order 付款完成与付款方式纪录的 method

app/models/order.rb

```
class Order < ApplicationRecord
...(略)
+ def set_payment_with!(method)
+   self.update_columns(payment_method: method )
+ end

+ def pay!
+   self.update_columns(is_paid: true )
+ end
end
```

### Step 7: 已经结帐的订单不可再付款

修改 `app/views/orders/show.html.erb`

app/views/orders/show.html.erb

```
...(略)
+   <% if !@order.is_paid? %>
    <div class="group pull-right">
      <%= link_to("以支付宝支付", pay_with_alipay_order_path(@order.token), :method => :post, :class => "btn btn-danger") %>
      <%= link_to("以微信支付", pay_with_wechat_order_path(@order.token), :method => :post, :class => "btn btn-danger") %>
    </div>
+    <% else %>
+      <p class="text-center">此订单已完成付款</p>
+    <% end %>

   </div>
 </div>
```

```
git add .
git commit -m "add payment_method function"
```

## 成果

试着结帐看看，原先订单页面会从

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/7F2BF4ioTYq6UGDe6HJ8_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202017-02-02%20%E4%B8%8B%E5%8D%884.23.35.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/7F2BF4ioTYq6UGDe6HJ8_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202017-02-02%20%E4%B8%8B%E5%8D%884.23.35.png)

变成

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/09tDEsvoSselamcTc9pS_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-09-21%20%E4%B8%8A%E5%8D%889.59.41.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/09tDEsvoSselamcTc9pS_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-09-21%20%E4%B8%8A%E5%8D%889.59.41.png)

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/iQaUrZURSyyzDBzE4xTz_jdstore-posts:231.gif)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/iQaUrZURSyyzDBzE4xTz_jdstore-posts:231.gif)



## 本节作业

##### [购物网站 - 第三周作业](https://fullstack.xinshengdaxue.com/assignments/10)：[本周日记&周记](https://fullstack.xinshengdaxue.com/tasks/105)

已有 93 个第一期同学提交了这个作业 [**看看同学怎么做](https://fullstack.xinshengdaxue.com/tasks/105/other_answers?order=recent)

[**提交作业](https://fullstack.xinshengdaxue.com/tasks/105)

本周日记&周记
1.请使用[ORID格式](https://fullstack.xinshengdaxue.com/tasks/7)记录每天的学习日记
2.请根据你本周的学习情况写一篇总结周记，内容提到以下两点：
2.1 “本周学到的最棒概念/工具”
2.2 “本周遇到最大的坑”
然后把日记和周记的博客连接贴在这里，格式如下：
（注意：你的logdown连结应该会是这样 <http://yy4ever.logdown.com/posts/1143304> 而不会有edit的链接）

2/13 日记：（你的博客链接）
2/14 日记：（你的博客链接）
2/15 日记：（你的博客链接）
2/16 日记：（你的博客链接）
2/17 周记：（你的博客链接）

##### [购物网站 - 第三周作业](https://fullstack.xinshengdaxue.com/assignments/10)：[使用者可以针对订单付款](https://fullstack.xinshengdaxue.com/tasks/55)

已有 146 个第一期同学提交了这个作业 [**看看同学怎么做](https://fullstack.xinshengdaxue.com/tasks/55/other_answers?order=recent)

[**提交作业](https://fullstack.xinshengdaxue.com/tasks/55)

\* 使用者可以针对订单付款 is_paid
\* 付款方式 payment_method ：微信、支付宝
\* 已付款过的订单不可以再付
上传gif动画演示你的成果（拖曳到此处）

# 9-2 Step 2 : 寄送订单确认通知信

## 寄送订单通知信

### 目标

- 使用者在下单后会收到一封订单确认信

## 步骤

### Step 1: 产⽣ Mailer

`rails g mailer OrderMailer`

### Step 2: 设定通知订单成立的寄信功能

app/mailers/application_mailer.rb

```
 class ApplicationMailer < ActionMailer::Base
-  default from: "from@example.com"
+  default from: "service@jdstore.com"
   layout 'mailer'
 end
```

app/mailers/order_mailer.rb

```
class OrderMailer < ApplicationMailer
  def notify_order_placed(order)
    @order       = order
    @user        = order.user
    @product_lists = @order.product_lists

    mail(to: @user.email , subject: "[JDstore] 感谢您完成本次的下单，以下是您这次购物明细 #{order.token}")
  end
end
```

`touch app/views/order_mailer/notify_order_placed.html.erb`

app/views/order_mailer/notify_order_placed.html.erb

```
<div class="row">
  <div class="col-md-12">
    <h2>
      订单明细 <br>
      <small>
        <%= link_to("订单连结", order_url(@order.token)) %>
      </small>
    </h2>
    <table class="table table-bordered">
      <thead>
        <tr>
          <th width="70%">商品明细</th>
          <th>单价</th>
          <th>数量</th>
          <th>小记</th>
        </tr>
      </thead>
      <tbody>

        <% @product_lists.each do |product_list| %>
          <tr>
            <td>
              <%= product_list.product_name %>
            </td>
            <td>
              <%= product_list.product_price %>
            </td>
            <td>
              <%= product_list.quantity %>
            </td>
            <td>
              <%= product_list.quantity * product_list.product_price %>
            </td>
          </tr>
        <% end %>

      </tbody>
    </table>

    <div class="total group clearfix">
      <h4 class="pull-right">
        总计 <%= @order.total %> CNY
      </h4>
     </div>

     <hr>

     <h2> 寄送资讯 </h2>

     <table class="table table-striped table-bordered">
      <tbody>
        <tr>
          <td> 订购人 </td>
        </tr>
        <tr>
          <td>
            <%= @order.billing_name %> - <%= @order.billing_address %>
          </td>
        </tr>
        <tr>
          <td> 收件者 </td>
        </tr>
        <tr>
          <td>
            <%= @order.shipping_name %> - <%= @order.shipping_address %>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>
```

### Step 3: 安装 gem letter_opener 来预览邮件

Gemfile

```
...(略)
gem 'mini_magick'

+ gem 'letter_opener', group: :development

group :development, :test do
...(略)
```

config/environments/development.rb

```
...(略)
+ config.action_mailer.default_url_options = { host: 'localhost:3000' }
+ config.action_mailer.delivery_method = :letter_opener
end
```

`bundle install`

重开 `rails s`

### Step 4: 在 console 模式测试信件预览

执行`rails c`

`OrderMailer.notify_order_placed(Order.last).deliver!`

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/3j6NwQh8R6tgblAR8IwW_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-09-21%20%E4%B8%8B%E5%8D%882.57.21.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/3j6NwQh8R6tgblAR8IwW_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-09-21%20%E4%B8%8B%E5%8D%882.57.21.png)

浏览器会自动开启信件如下 

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/wtByWcjJRnm03MKR9e1G_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-09-21%20%E4%B8%8B%E5%8D%882.56.20.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/wtByWcjJRnm03MKR9e1G_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-09-21%20%E4%B8%8B%E5%8D%882.56.20.png)

### Step 5: 在订单建立时寄通知信

app/controllers/orders_controller.rb

```
class OrdersController < ApplicationController
  before_action :authenticate_user!

  def create
    @order = Order.new(order_params)
    @order.user = current_user
    @order.total = current_cart.total_price

    if @order.save

      current_cart.cart_items.each do |cart_item|
        product_list = ProductList.new
        product_list.order = @order
        product_list.product_name = cart_item.product.title
        product_list.product_price = cart_item.product.price
        product_list.quantity = cart_item.quantity
        product_list.save
      end
 +    current_cart.clean!
 +    OrderMailer.notify_order_placed(@order).deliver!

      redirect_to order_path(@order.token)
    else
      render 'carts/checkout'
    end
  end
...(略)
```

```
git add .
git commit -m "add OrderMailer function"
```

## 结果

回到购物车，去下一张订单，浏览器应该除了会跳到订单支付页面外，还会跳出一个邮件预览页面。

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/wtByWcjJRnm03MKR9e1G_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-09-21%20%E4%B8%8B%E5%8D%882.56.20.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/wtByWcjJRnm03MKR9e1G_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-09-21%20%E4%B8%8B%E5%8D%882.56.20.png)

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/XPHS3GWnTMKBq6bJs6Wf_jdstore-posts:235.gif)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/XPHS3GWnTMKBq6bJs6Wf_jdstore-posts:235.gif)

## 本节作业

##### [购物网站 - 第三周作业](https://fullstack.xinshengdaxue.com/assignments/10)：[使用者在下单后会收到一张订单确认信](https://fullstack.xinshengdaxue.com/tasks/57)

已有 150 个第一期同学提交了这个作业 [**看看同学怎么做](https://fullstack.xinshengdaxue.com/tasks/57/other_answers?order=recent)

[**提交作业](https://fullstack.xinshengdaxue.com/tasks/57)

\* 请上传你的订单确认信截图
\* 以及 pull request
\* 请做好排版
上传gif动画演示你的成果（拖曳到此处）

# 10-1 切换订单状态

## 目标

我们的订单系统其实应该分为六种以上的状态

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/OlKrqkd8QfqeMk8ek5zf_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202017-02-03%20%E4%B8%8B%E5%8D%883.15.13.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/OlKrqkd8QfqeMk8ek5zf_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202017-02-03%20%E4%B8%8B%E5%8D%883.15.13.png)

- 已下订（order_placed）
- 已付款（paid）
- 出货中（shipping）
- 到货（shipped）
- 取消订单（order_cancelled）
- 退货（good_returned）

其中只有「已下订」能前进到「已付款」，只有「已下定」或「已付款」可以变成「取消订单」。只有「到货」可以变成「退货」等等。

其余皆属于非法操作。

但是这个架构实践起来却非常复杂，我们这一章会介绍「有限状态机」这个架构去将后台订单切换状态这个功能实践出来，以让管理员可以真正的操作出货或者退货流程。

## 步骤

### Step 1: AASM

安装 gem "aasm"

Gemfile

```
...(略)
+ gem 'aasm'
...(略)
```

`bundle install`
记得重开 `rails s`

### Step 2: 新增 aasm_state 栏位

`rails g migration add_aasm_state_to_order`

db/migrate/xxx(一堆数字)_add_aasm_state_to_order.rb

```
class AddAasmStateToOrder < ActiveRecord::Migration
  def change
+   add_column :orders, :aasm_state, :string, default: "order_placed"
+   add_index  :orders, :aasm_state
  end
end
```

`rake db:migrate`

### Step 3 : 设定订单状态机制

在order.rb 插入以下的程式码

app/models/order.rb

```
 include AASM

  aasm do
    state :order_placed, initial: true
    state :paid
    state :shipping
    state :shipped
    state :order_cancelled
    state :good_returned


    event :make_payment do
      transitions from: :order_placed, to: :paid
    end

    event :ship do
      transitions from: :paid,         to: :shipping
    end

    event :deliver do
      transitions from: :shipping,     to: :shipped
    end

    event :return_good do
      transitions from: :shipped,      to: :good_returned
    end

    event :cancel_order do
      transitions from: [:order_placed, :paid], to: :order_cancelled
    end
  end
```

### Step 4 : 用 AASM 的机制设定订单付款

app/controllers/orders_controller.rb

```
...(略)
  def pay_with_alipay
    @order = Order.find_by_token(params[:id])
    @order.set_payment_with!("alipay")
-   @order.pay!
+   @order.make_payment!

    redirect_to order_path(@order.token), notice: "使用支付宝成功完成付款"
  end

  def pay_with_wechat
    @order = Order.find_by_token(params[:id])
    @order.set_payment_with!("wechat")
-   @order.pay!
+   @order.make_payment!

    redirect_to order_path(@order.token), notice: "使用微信支付成功完成付款"
  end

...(略)
```

app/models/order.rb

```
...(略)
-    event :make_payment do
+    event :make_payment, after_commit: :pay! do
       transitions from: :order_placed, to: :paid
     end
...(略)
```

```
git add .
git commit -m "add aasm_state to order"
```

## 结果

重新操作一次订单建立与付款流程后，到 `rails c` 输入Order.last 检查 aasm_state 是否正确(应显示为 paid)。

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/Ait3qE7nSYu4snD8kgEq_jdstore-posts:237.gif)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/Ait3qE7nSYu4snD8kgEq_jdstore-posts:237.gif)

## 本节作业

##### [购物网站 - 第三周作业](https://fullstack.xinshengdaxue.com/assignments/10)：[建立 admin/orders 后台可以看到所有订单](https://fullstack.xinshengdaxue.com/tasks/58)

已有 132 个第一期同学提交了这个作业 [**看看同学怎么做](https://fullstack.xinshengdaxue.com/tasks/58/other_answers?order=recent)

[**提交作业](https://fullstack.xinshengdaxue.com/tasks/58)

\* 建立 admin/orders  可以看到系统内所有订单
\* admin 的 order 列表应要能显示订单状态
上传gif动画演示你的成果（拖曳到此处）

##### [购物网站 - 第三周作业](https://fullstack.xinshengdaxue.com/assignments/10)：[使用者可以“申请取消订单”](https://fullstack.xinshengdaxue.com/tasks/59)

已有 132 个第一期同学提交了这个作业 [**看看同学怎么做](https://fullstack.xinshengdaxue.com/tasks/59/other_answers?order=recent)

[**提交作业](https://fullstack.xinshengdaxue.com/tasks/59)

\* 使用者可以“申请取消订单”
\* 使用者“申请取消订单”后，管理员应该要收到“申请通知信”
上传gif动画演示你的成果（拖曳到此处）

##### [购物网站 - 第三周作业](https://fullstack.xinshengdaxue.com/assignments/10)：[后台管理员可以“取消订单”、“出货”](https://fullstack.xinshengdaxue.com/tasks/60)

已有 129 个第一期同学提交了这个作业 [**看看同学怎么做](https://fullstack.xinshengdaxue.com/tasks/60/other_answers?order=recent)

[**提交作业](https://fullstack.xinshengdaxue.com/tasks/60)

\* 后台管理员可以“取消订单”、“出货”
\* 后台管理“出货”后，系统应该寄出通知信
\* 后台管理员“取消订单”后，系统应该寄出通知信
上传gif动画演示你的成果（拖曳到此处）

# 11-1 订单状态切换（解答）

## 目标

- 建立 admin/orders 可以看到系统内所有订单
- admin 的 order 列表应要能显示订单状态
- 使用者可以“申请取消订单”
- 使用者“申请取消订单”后，管理员应该要收到“申请通知信”
- 后台管理员可以“取消订单”、“出货”
- 后台管理“出货”后，系统应该寄出通知信
- 后台管理员“取消订单”后，系统应该寄出通知信

## 步骤

### 建立 admin/orders 可以看到系统内所有订单

#### Step 1: 建立 admin/orders 的 controller & views

`rails g controller admin::orders`

config/routes.rb

```
...(略)
  namespace :admin do
    resources :products
+   resources :orders
  end
...(略)
```

app/controllers/admin/orders_controller.rb

```
class Admin::OrdersController < ApplicationController
  layout "admin"

  before_action :authenticate_user!
  before_action :admin_required

  def index
    @orders = Order.order("id DESC")
  end
end
```

app/views/layouts/admin.html.erb

```
...(略)
      <div class="col-md-2">
        <ul class="nav nav-pills nav-stacked" style="max-width: 300px;">
          <li> <%= link_to("Products", admin_products_path) %> </li>
+          <li> <%= link_to("Orders", admin_orders_path) %> </li>
        </ul>
      </div>
...(略)
```

`touch app/views/admin/orders/index.html.erb`

app/views/admin/orders/index.html.erb

```
<h2>订单列表 </h2>

<table class="table table-bordered">
  <thead>
    <tr>
      <th>#</th>
      <th>生成时间</th>
      <th>订购者</th>
      <th>订单状态</th>
    </tr>
  </thead>
  <tbody>
    <% @orders.each do |order| %>
    <tr>
      <td> <%= link_to(order.id, admin_order_path(order) ) %> </td>
      <td> <%= order.created_at.to_s(:long) %> </td>
      <td> <%= order.user.email %></td>
      <td> <%= order.aasm_state %> </td>
    </tr>
    <% end %>

  </tbody>
</table>
```

```
git add .
git commit -m "add admin/orders"
```

#### Step 2: 建立后台订单页面

app/controllers/admin/orders_controller.rb

```
class Admin::OrdersController < ApplicationController
...(略)

+ def show
+   @order = Order.find(params[:id])
+   @product_lists = @order.product_lists
+ end
end
```

`touch app/views/admin/orders/show.html.erb`

app/views/admin/orders/show.html.erb

```
<div class="row">
   <div class="col-md-12">

    <h2> 订单明细 (<%= render_order_paid_state(@order) %>) </h2>

    <table class="table table-bordered">
      <thead>
        <tr>
          <th width="80%">商品明细</th>
          <th>单价</th>
          <th>数量</th>
        </tr>
      </thead>
      <tbody>

        <% @product_lists.each do |product_list| %>
          <tr>
            <td>
              <%= product_list.product_name %>
            </td>
            <td>
              <%= product_list.product_price %>
            </td>
            <td>
              <%= product_list.quantity %>
            </td>
          </tr>
        <% end %>

      </tbody>
    </table>

    <div class="total clearfix">
      <span class="pull-right">
       总计 <%= @order.total %> CNY
       </span>
     </div>

     <hr>

     <h2> 寄送资讯 </h2>

     <table class="table table-striped table-bordered">
      <tbody>
        <tr>
          <td>
            订购人
          </td>
        </tr>
        <tr>
          <td>
            <%= @order.billing_name %> - <%= @order.billing_address %>
          </td>
        </tr>
        <tr>
          <td>
            收件人
          </td>
        </tr>
        <tr>
          <td>
            <%= @order.shipping_name %> - <%= @order.shipping_address %>
          </td>
        </tr>
      </tbody>
    </table>

  </div>
</div>
```

app/helpers/orders_helper.rb

```
module OrdersHelper
+ def render_order_paid_state(order)
+   if order.is_paid?
+     "已付款"
+   else
+     "未付款"
+   end
+ end
end
```

```
git add .
git commit -m "implement admin/orders show function"
```

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/21QYc2AkSGCYo8jz30DX_jdstore-posts:238g1.gif)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/21QYc2AkSGCYo8jz30DX_jdstore-posts:238g1.gif)

#### Step 3: 后台的订单可以依照“按照状态图”改变状态

config/routes.rb

```
...(略)
  namespace :admin do
    resources :products
-   resources :orders
+   resources :orders do
+     member do
+       post :cancel
+       post :ship
+       post :shipped
+       post :return
+     end
+   end
  end
...(略)
```

admin/orders_controller.rb 放入以下 action

app/controllers/admin/orders_controller.rb

```
class Admin::OrdersController < ApplicationController
...(略)
  def ship
    @order = Order.find(params[:id])
    @order.ship!
    redirect_to :back
  end

  def shipped
    @order = Order.find(params[:id])
    @order.deliver!
    redirect_to :back
  end

  def cancel
    @order = Order.find(params[:id])
    @order.cancel_order!
    redirect_to :back
  end

  def return
    @order = Order.find(params[:id])
    @order.return_good!
    redirect_to :back
  end
end
```

```
git add .
git commit -m "add ship/shipped/cancel/return action to admin/orders_controller"
```

#### Step 4: 新增异动订单状态的按钮

`touch app/views/admin/orders/_state_option.html.erb`

app/views/admin/orders/_state_option.html.erb

```
<div style="padding:10px; float:right;">

  <% case order.aasm_state %>
  <% when "order_placed" %>
    <%= link_to("取消订单",
                cancel_admin_order_path(order),
                class: "btn btn-default btn-sm", method: :post) %>

  <% when "paid" %>
    <%= link_to("取消订单",
                cancel_admin_order_path(order),
                class: "btn btn-default btn-sm", method: :post) %>
    <%= link_to("出货",
                ship_admin_order_path(order),
                class: "btn btn-default btn-sm", method: :post) %>

  <% when "shipping" %>
    <%= link_to("设为已出货",
                shipped_admin_order_path(order),
                class: "btn btn-default btn-sm", method: :post) %>

  <% when "shipped" %>
    <%= link_to("退货",
                return_admin_order_path(order),
                class: "btn btn-default btn-sm", method: :post) %>

  <% when "order_cancelled" %>
    <span class="label label-default">订单已取消</span>

  <% when "good_returned" %>
    <span class="label label-default">已退货</span>

  <% end %>

</div>
```

app/views/admin/orders/show.html.erb

```
<div class="row">
   <div class="col-md-12">

    <h2> 订单明细 (<%= render_order_paid_state(@order) %>) </h2>

+   <%= render "admin/orders/state_option", order: @order %>

    <table class="table table-bordered">
...(略)
```

```
git add .
git commit -m "add admin/orders/state_option button"
```

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/EK4GJJ51R8y8svWJ5WBJ_jdstore-posts:238g2.gif)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/EK4GJJ51R8y8svWJ5WBJ_jdstore-posts:238g2.gif)

#### Step 5: 用户取消订单

app/controllers/orders_controller.rb

```
...(略)
  def apply_to_cancel
    @order = Order.find(params[:id])
    OrderMailer.apply_cancel(@order).deliver!
    flash[:notice] = "已提交申请"
    redirect_to :back
  end
...(略)
```

config/routes.rb

```
  resources :orders do
    member do
      post :pay_with_alipay
      post :pay_with_wechat
+     post :apply_to_cancel
    end
  end
```

修改订单页面，增加使用者申请取消订单按钮:

app/views/orders/show.html.erb

```
</table>

+   <div class="pull-left">
+     <% if @order.order_placed? || @order.paid? %>
+       <%= link_to("申请取消订单", apply_to_cancel_order_path(@order), method: :post, class: "btn  btn-info") %>
+     <% end %>
+   </div>

<% if !@order.is_paid? %>
```

app/mailers/order_mailer.rb

```
...(略)
  def apply_cancel(order)
    @order       = order
    @user        = order.user
    @product_lists = @order.product_lists

    mail(to: "admin@test.com" , subject: "[JDStore] 用户#{order.user.email}申请取消订单 #{order.token}")
  end
...(略)
```

`touch app/views/order_mailer/apply_cancel.html.erb`

app/views/order_mailer/apply_cancel.html.erb

```
<div class="row">
  <div class="col-md-12">
    <h2>
      订单明细 <br>
      <small>
        <%= link_to("订单连结", order_url(@order.token)) %>
      </small>
    </h2>
    <table class="table table-bordered">
      <thead>
        <tr>
          <th width="70%">商品明细</th>
          <th>单价</th>
          <th>数量</th>
          <th>小记</th>
        </tr>
      </thead>
      <tbody>

        <% @product_lists.each do |product_list| %>
          <tr>
            <td>
              <%= product_list.product_name %>
            </td>
            <td>
              <%= product_list.product_price %>
            </td>
            <td>
              <%= product_list.quantity %>
            </td>
            <td>
              <%= product_list.quantity * product_list.product_price %>
            </td>
          </tr>
        <% end %>

      </tbody>
    </table>

    <div class="total group clearfix">
      <h4 class="pull-right">
        总计 <%= @order.total %> CNY
      </h4>
     </div>

     <hr>

     <h2> 寄送资讯 </h2>

     <table class="table table-striped table-bordered">
      <tbody>
        <tr>
          <td> 订购人 </td>
        </tr>
        <tr>
          <td>
            <%= @order.billing_name %> - <%= @order.billing_address %>
          </td>
        </tr>
        <tr>
          <td> 收件者 </td>
        </tr>
        <tr>
          <td>
            <%= @order.shipping_name %> - <%= @order.shipping_address %>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>
```

```
git add .
git commit -m "add apply_cancel function"
```

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/ehT78SCkRyWy3m1jPFxy_jdstore-posts:238g3.gif)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/ehT78SCkRyWy3m1jPFxy_jdstore-posts:238g3.gif)

#### Step 6: 在出货/取消订单后，系统应该寄出通知信

app/controllers/admin/orders_controller.rb

```
...(略)
  def ship
    @order = Order.find(params[:id])
    @order.ship!
+   OrderMailer.notify_ship(@order).deliver!
    redirect_to :back
  end
...(略)
  def cancel
    @order = Order.find(params[:id])
    @order.cancel_order!
+   OrderMailer.notify_cancel(@order).deliver!
    redirect_to :back
  end
...(略)
```

在 `order_mailer.rb` 新增

app/mailers/order_mailer.rb

```
...(略)
  def notify_ship(order)
    @order        = order
    @user         = order.user
    @product_lists = @order.product_lists

    mail(to: @user.email, subject: "[JDStore] 您的订单 #{order.token}已发货")
  end

  def notify_cancel(order)
    @order        = order
    @user         = order.user
    @product_lists = @order.product_lists

    mail(to: @user.email, subject: "[JDStore] 您的订单 #{order.token}已取消")
  end
...(略)
```

`touch app/views/order_mailer/notify_cancel.html.erb`

app/views/order_mailer/notify_cancel.html.erb

```
<div class="row">
  <div class="col-md-12">
    <h2>
      订单明细 <br>
      <small>
        <%= link_to("订单连结", order_url(@order.token)) %>
      </small>
    </h2>
    <table class="table table-bordered">
      <thead>
        <tr>
          <th width="70%">商品明细</th>
          <th>单价</th>
          <th>数量</th>
          <th>小记</th>
        </tr>
      </thead>
      <tbody>

        <% @product_lists.each do |product_list| %>
          <tr>
            <td>
              <%= product_list.product_name %>
            </td>
            <td>
              <%= product_list.product_price %>
            </td>
            <td>
              <%= product_list.quantity %>
            </td>
            <td>
              <%= product_list.quantity * product_list.product_price %>
            </td>
          </tr>
        <% end %>

      </tbody>
    </table>

    <div class="total group clearfix">
      <h4 class="pull-right">
        总计 <%= @order.total %> CNY
      </h4>
     </div>

     <hr>

     <h2> 寄送资讯 </h2>

     <table class="table table-striped table-bordered">
      <tbody>
        <tr>
          <td> 订购人 </td>
        </tr>
        <tr>
          <td>
            <%= @order.billing_name %> - <%= @order.billing_address %>
          </td>
        </tr>
        <tr>
          <td> 收件者 </td>
        </tr>
        <tr>
          <td>
            <%= @order.shipping_name %> - <%= @order.shipping_address %>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>
```

`touch app/views/order_mailer/notify_ship.html.erb`

app/views/order_mailer/notify_ship.html.erb

```
<div class="row">
  <div class="col-md-12">
    <h2>
      订单明细 <br>
      <small>
        <%= link_to("订单连结", order_url(@order.token)) %>
      </small>
    </h2>
    <table class="table table-bordered">
      <thead>
        <tr>
          <th width="70%">商品明细</th>
          <th>单价</th>
          <th>数量</th>
          <th>小记</th>
        </tr>
      </thead>
      <tbody>

        <% @product_lists.each do |product_list| %>
          <tr>
            <td>
              <%= product_list.product_name %>
            </td>
            <td>
              <%= product_list.product_price %>
            </td>
            <td>
              <%= product_list.quantity %>
            </td>
            <td>
              <%= product_list.quantity * product_list.product_price %>
            </td>
          </tr>
        <% end %>

      </tbody>
    </table>

    <div class="total group clearfix">
      <h4 class="pull-right">
        总计 <%= @order.total %> CNY
      </h4>
     </div>

     <hr>

     <h2> 寄送资讯 </h2>

     <table class="table table-striped table-bordered">
      <tbody>
        <tr>
          <td> 订购人 </td>
        </tr>
        <tr>
          <td>
            <%= @order.billing_name %> - <%= @order.billing_address %>
          </td>
        </tr>
        <tr>
          <td> 收件者 </td>
        </tr>
        <tr>
          <td>
            <%= @order.shipping_name %> - <%= @order.shipping_address %>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>
```

```
git add .
git commit -m "add notify_cancel/ship function"
```

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/oX8zB0JBQjy5xq8bW6es_jdstore-posts:238g4.gif)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/oX8zB0JBQjy5xq8bW6es_jdstore-posts:238g4.gif)

# [直播回放]2月16日 进阶知识(选修)

主讲人：
ihower老师时长：

本次直播总时长60分钟
直播过程中随时可发问

概要：

ihower老师和xdite老师都是Rails中文世界的教材撰写者，本次很荣幸邀请到ihower老师来客座讲解Rails的基础知识，对于商店教程有任何疑问都在直播时发问。

> 注意：
> 本次直播内容为进阶知识，看不懂请直接跳过！



# 12-1 本章学习指南

本章，我们要把JDstore部署到heroku。

和以往的专案不同的是，我们要在生产环境（真实环境）实现上传图片和发送邮件的功能，这里使用亚马逊AWS服务上传并储存图片，最后使用SendCloud服务发送邮件。

而要使用这两个服务，我们还需要使用figaro进行密码管理，避免安全信息泄露。

所以，以下教材必读！并且按照这个顺序阅读：

#### 方案1：使用 AWS S3 存储图片

[一些安全概念](https://fullstack.xinshengdaxue.com/posts/240)

[申请AWS S3（用来储存图片）](https://fullstack.xinshengdaxue.com/posts/427)

[使用 Figaro 管理密码](https://fullstack.xinshengdaxue.com/posts/241)

[部署 JDStore 到 Heroku](https://fullstack.xinshengdaxue.com/posts/239)

[使用SendCloud服务发送邮件](https://fullstack.xinshengdaxue.com/posts/426)

> 注意：存储图片的方案有2种：一种是使用 AWS S3 存储图片（需要 Visa 或 MasterCard）；一种是使用七牛云存储图片（不需要 Visa 或 MasterCard）。两种方案只需选择一种使用就可以。切勿混用！

#### 方案2：使用七牛云存储图片

[申请七牛云（用来储存图片）](https://fullstack.xinshengdaxue.com/posts/482)

[使用 Figaro 管理密码](https://fullstack.xinshengdaxue.com/posts/483)

[部署 JDStore 到 Heroku](https://fullstack.xinshengdaxue.com/posts/484)

[使用SendCloud服务发送邮件](https://fullstack.xinshengdaxue.com/posts/426)

# 12-2 一些安全概念

各位都已经有部署产品到 Heroku 的经验了。但是这里，我们需要强调一些安全观念。

在以往的教材里，我们都是教大家把密码写死在 .rb 档案里面，但是这样其实是很危险的。当我们把专案上传到 github 上后，github 是全世界都可以看的，这样就相当于把你的私人密码公布给大家，可想而知你的私人财产毫无保障。

我们可以上网看看，网络上常常有这样的惨案，坏人偷了你的钥匙后……

[![img](http://7xqmjb.com1.z0.glb.clouddn.com/2017020381957Screenshot%20at%20Feb%2003%2022-19-36.png)](http://7xqmjb.com1.z0.glb.clouddn.com/2017020381957Screenshot%20at%20Feb%2003%2022-19-36.png)

[![img](http://7xqmjb.com1.z0.glb.clouddn.com/2017020360467Screenshot%20at%20Feb%2003%2022-21-03.png)](http://7xqmjb.com1.z0.glb.clouddn.com/2017020360467Screenshot%20at%20Feb%2003%2022-21-03.png)

为了不让这些惨案发生在自己身上，我们需要增强自己的密码管理意识。

那么，我们应该如何管理自己的密钥呢？

#### 首先：**密码不要放在 .rb 档案里面**

(如下图所示的写法是很危险的)

[![img](http://7xqmjb.com1.z0.glb.clouddn.com/2017020662808snip20170206_30.png)](http://7xqmjb.com1.z0.glb.clouddn.com/2017020662808snip20170206_30.png)

#### 其次：**把密码放在 .yml 档案里面**

在做大项目的时候，我们需要与人协作。大家在 fork 或者 clone job-listing 和 jdstore 专案的时候，应该会发现一件事情，我给大家的是 database.yml.example，是因为我们不把自己真的 key（真的 key 在 database.yml 档里）给别人。所以在本地的时候就需要准备一份 database.yml.example （这是范例档，给同事知道有这个档——为了协作）。也就是说，上传到 github 上的是 database.yml.example 档。
（如下图所示的写法才是正确的）

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/D4o7snRRGsYosZGRyY0A_Screenshot%20at%20Feb%2017%2020-26-52.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/D4o7snRRGsYosZGRyY0A_Screenshot%20at%20Feb%2017%2020-26-52.png)

#### 最后：**.gitignore 设定不要上传 database.yml**

我们要在 .gitignore（我们不要上传的档）加入 database.yml 档
（如下图所示的写法才是正确的）

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/zSmPwfaURIeZASdvxUO7_Screenshot%20at%20Feb%2015%2021-38-04.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/zSmPwfaURIeZASdvxUO7_Screenshot%20at%20Feb%2015%2021-38-04.png)

这样我们就可以让自己的秘钥不上传到 github 上了。在接下来的课程里，我们更需要有这些正确的安全观念。

### 正确安全观念

• 密码用 figaro 管理

figaro 是一个方便管理机密信息、密码的gem，并且能一个指令就将机密信息同步到 Heroku上。

• ENV 环境变数

把密码设置到环境变量里，然后调用这些变量。这样就能在隐藏密码的同时，使用它们。
注意：carrierwave.rb 中只需要填写 AWS_ACCESS_KEY_ID（不用填写真实的密码），figaro自己会进行调用。

# 12-3 申请AWS S3（用来储存图片）（方案1）

> 注意：AWS S3 存储图片（方案1）与七牛云存储图片（方案2）切勿混用！

### 目标

- 注册及设置AWS S3
- 没有信用卡的同学请使用[七牛云教程](https://fullstack.xinshengdaxue.com/posts/482)（方案）

### Step 0: 注册以及设置AWS S3

- 先注册 AWS 的帐号（需要Visa或MasterCard），注册完登入

### Step 1: 根据AWS安全审查指南，创建 IAM 用户

- 在右上角点击你的帐号，选择「我的安全凭证」

[![img](http://user-image.logdown.io/user/19197/blog/18708/post/1383092/G0ngnm8TpiwO5iLlyA3l_Snip20170204_12.png)](http://user-image.logdown.io/user/19197/blog/18708/post/1383092/G0ngnm8TpiwO5iLlyA3l_Snip20170204_12.png)

- 添加用户

[![img](http://user-image.logdown.io/user/19197/blog/18708/post/1383092/mX4f8ThJRtGXNQWjj2hT_Snip20170204_13.png)](http://user-image.logdown.io/user/19197/blog/18708/post/1383092/mX4f8ThJRtGXNQWjj2hT_Snip20170204_13.png)

- 输入用户名和选择访问类型

[![img](http://user-image.logdown.io/user/19197/blog/18708/post/1383092/3nc6dS08QHe7hGQiJVSj_Snip20170204_14.png)](http://user-image.logdown.io/user/19197/blog/18708/post/1383092/3nc6dS08QHe7hGQiJVSj_Snip20170204_14.png)

- 设定权限

[![img](http://user-image.logdown.io/user/19197/blog/18708/post/1383092/AC8fNEpKRoWWSW4v36kV_Snip20170204_15.png)](http://user-image.logdown.io/user/19197/blog/18708/post/1383092/AC8fNEpKRoWWSW4v36kV_Snip20170204_15.png)

- 下载key文件，之后会用（里面有两个key，分别是access key ID和secret access key）

[![img](http://user-image.logdown.io/user/19197/blog/18708/post/1383092/dPuvq5rHT9SieYONTOjH_Snip20170204_16.png)](http://user-image.logdown.io/user/19197/blog/18708/post/1383092/dPuvq5rHT9SieYONTOjH_Snip20170204_16.png)

- s3上创建存储桶Bucket

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/w7tTYqhrQCmnTXMotI4T_Screenshot%20at%20Feb%2016%2015-21-39.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/w7tTYqhrQCmnTXMotI4T_Screenshot%20at%20Feb%2016%2015-21-39.png)

[![img](http://user-image.logdown.io/user/19197/blog/18708/post/1383092/0uEQY9pVQwO74RwQfJTb_Snip20170204_18.png)](http://user-image.logdown.io/user/19197/blog/18708/post/1383092/0uEQY9pVQwO74RwQfJTb_Snip20170204_18.png)

- 输入存储桶名称，选择区域

[![img](http://user-image.logdown.io/user/19197/blog/18708/post/1383092/7uDtiGVATVCm8SB81VBr_Snip20170204_19.png)](http://user-image.logdown.io/user/19197/blog/18708/post/1383092/7uDtiGVATVCm8SB81VBr_Snip20170204_19.png)

#### 重点 :

- 要保护好 aws 的 id 与 key 不要 push 到 github 上面，避免被盗用

#### 提示：Region位置

- <http://docs.aws.amazon.com/general/latest/gr/rande.html#s3_region>

# 12-4 使用 Figaro 管理密码（方案1）

> 注意：AWS S3 存储图片（方案1）与七牛云存储图片（方案2）切勿混用！

## 为什么我们需要 figaro？

当我们使用 Github 存储我们代码的时候，一些诸如 AccessKey 等密钥信息是不能够让其他人获得的，但项目中又需要提供配置信息。

figaro是一个方便管理机密信息、密钥的gem，并且能一个指令就将机密信息同步到heroku上，如此一来密钥也不会外泄。

### Step 1: 安装 figaro

`git checkout -b aws`

打开 Gemfile，加入

Gemfile

```
...(略)
+ gem 'figaro'
...(略)
```

`bundle install`

`figaro install`

会自动生成 config/application.yml 文件并自动添加到 .gitignore 档案里

[![img](http://user-image.logdown.io/user/19197/blog/18708/post/1383092/b5ktTYYGRbqmfpbF9pxU_Snip20170205_27.png)](http://user-image.logdown.io/user/19197/blog/18708/post/1383092/b5ktTYYGRbqmfpbF9pxU_Snip20170205_27.png)

### Step 2: 设定机密信息

`cp config/application.yml config/application.yml.example`

修改 config/application.yml 档案

{备注：config/application.yml 档案有可能被隐藏了，所以我们要把它调出来。打开 atom 编辑器里的 settings（可以通过 command+ 逗号快速调出） -> packages。在搜索栏中输入 tree，在 tree-view 中点选 settings，把 Hide VCS Ignored Files 的勾去掉就会显示出来了。}

config/application.yml

```
...(略)

+ production:
+   AWS_ACCESS_KEY_ID: "xxxx"  # 你的 Access key ID

+   AWS_SECRET_ACCESS_KEY: "xxxx"  # 你的 Secret access key

+   AWS_REGION: "xxxx"  # 你的 S3 bucket 的 Region 位置

+   AWS_BUCKET_NAME: "xxxx"  # 你设定的 bucket name


+ development:
+   AWS_ACCESS_KEY_ID: "xxxx"  # 你的 Access key ID

+   AWS_SECRET_ACCESS_KEY: "xxxx"  # 你的 Secret access key

+   AWS_REGION: "xxxx"  # 你的 S3 bucket 的 Region 位置

+   AWS_BUCKET_NAME: "xxxx"  # 你设定的 bucket name
```

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/M6gI6NETeK2iWVFPDtcq_snip20170222_34.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/M6gI6NETeK2iWVFPDtcq_snip20170222_34.png)

注意：请在[Amazon S3 - Buckets and Regions](http://docs.aws.amazon.com/general/latest/gr/rande.html#s3_region)查找Region name对应的Region，Region name是在创建存储桶时选择的，可以在存储桶的属性中查看。比如 Region name 是 "Tokyo"，Region 就是"ap-northeast-1"。 Region一定要填对，上传到 heroku 的图片才能正常显示。

```
git add .
git commit -m "figaro"

```

### 本节作业

##### [购物网站 - 第三周作业](https://fullstack.xinshengdaxue.com/assignments/10)：[使用 figaro 管理密码](https://fullstack.xinshengdaxue.com/tasks/63)

已有 112 个第一期同学提交了这个作业 [**看看同学怎么做](https://fullstack.xinshengdaxue.com/tasks/63/other_answers?order=recent)

[**提交作业](https://fullstack.xinshengdaxue.com/tasks/63)

\* 请贴上你的 pull request

# 12-5 将JDStore部署到Heroku（方案1）

> 注意：AWS S3 存储图片（方案1）与七牛云存储图片（方案2）切勿混用！

## 目标

- 在 Heroku 上可以上传图片
- 将JDStore部署到Heroku

## 步骤

### Step 1: 在 Heroku 上可以上传图片

- 依照教程[申请 AWS 服务](https://fullstack.xinshengdaxue.com/posts/427)
- 安装 gem 'fog'

Gemfile

```
...(略)
gem 'fog'
...(略)
```

`bundle install`

### Step 2: 新增 config/initializers/carrierwave.rb

`touch config/initializers/carrierwave.rb`

config/initializers/carrierwave.rb

```
CarrierWave.configure do |config|
  if Rails.env.production?
    config.fog_provider = "fog"                  
    config.fog_credentials = {
      provider:              "AWS",                        
      aws_access_key_id:     ENV["AWS_ACCESS_KEY_ID"],         

      aws_secret_access_key: ENV["AWS_SECRET_ACCESS_KEY"],        

      region:                ENV["AWS_REGION"]    

    }
    config.fog_directory  = ENV["AWS_BUCKET_NAME"]


  else
    config.storage :file
  end
end
```

### Step 3: 修改 app/uploader/image_uploader.rb

app/uploader/image_uploader.rb

```
class ImageUploader < CarrierWave::Uploader::Base
...(略)
- storage :file
+ # storage :file

+ storage :fog
...(略)
```

```
git add .
git commit -m "install fog"
```

### Step 4: 修改 Gemfile 档案

把 sqlite3 从第7行搬到约第30到40行的group :development, :test do

这一行里面，置于gem 'byebug'的下面。

[![img](http://ww1.sinaimg.cn/large/006tNbRwjw1fb5t9ep5udj30dc03ydg7.jpg)](http://ww1.sinaimg.cn/large/006tNbRwjw1fb5t9ep5udj30dc03ydg7.jpg)

在末尾新增一个 production group，加上 pg 这个 gem

```
group :production do
  gem 'pg'
end
```

[![img](http://ww3.sinaimg.cn/large/006tNbRwjw1fb5vm23d6wj30ft03zwex.jpg)](http://ww3.sinaimg.cn/large/006tNbRwjw1fb5vm23d6wj30ft03zwex.jpg)

command+s 存档

修改 Gemfile 后要 `bundle install`

存档

- `git add .`
- `git commit -m "move sqlite3 to dev group & add pg to production group "`

具体可以参考第一课[相关章节](https://fullstack.xinshengdaxue.com/posts/26)以及[帮助文档](http://docs.qzy.camp/docs/heroku)

### Step 5: 创建heroku app并将设定好的机密资讯同步到这个app

`heroku create` 先创建一个heroku app

`figaro heroku:set -e production`

`heroku config` 可以列出目前所有的设定

### Step 5: 上传到github和heroku

```
git push origin aws
git push heroku aws:master
heroku run rake db:migrate
```

#### 重点 1:

申请完 AWS 帐号后到帐号名称的下拉选单里面点“Security Credentials”，然后选导览列的“Details”可以看到有个“＋Access Keys”这边可以申请 key 跟 secret。

#### 重点 2:

[不要把 aws 的 id 与 key push 到 github 上面，避免被盗用。](https://fullstack.xinshengdaxue.com/posts/240)解决的方法可以使用 [figaro](https://fullstack.xinshengdaxue.com/posts/241) 或 heroku config。

#### 提示：如何在本地设置环境变数

- <http://thejavashop.net/blog/?p=5>

#### 提示：如何在 Heroku 设置环境变数

- <https://devcenter.heroku.com/articles/config-vars>

#### 提示：出现 uninitialized constant CarrierWave::Storage::Fog 报错，请参考

- 帮助文档[将 JDStore 部署到 Heroku](http://docs.qzy.camp/v0.1/docs/%E5%B0%86-jdstore-%E9%83%A8%E7%BD%B2%E5%88%B0-heroku)

### 本节作业

##### [购物网站 - 第三周作业](https://fullstack.xinshengdaxue.com/assignments/10)：[将你的作品上传到 Heroku](https://fullstack.xinshengdaxue.com/tasks/61)

已有 106 个第一期同学提交了这个作业 [**看看同学怎么做](https://fullstack.xinshengdaxue.com/tasks/61/other_answers?order=recent)

[**提交作业](https://fullstack.xinshengdaxue.com/tasks/61)

\* 请贴上网址
\* 这个网址内必须要有产品图
\* 请注意，绝对不要泄漏你的 s3 金钥
上传gif动画演示你的成果（拖曳到此处）

# 12-6 使用SendCloud服务发送邮件

## 目标

- 之前的章节中，我们学习了[如何寄信和预览邮件](https://fullstack.xinshengdaxue.com/posts/235)
- 在真实环境中，需要使用邮件发送服务才可以真正发送邮件
- 本节教给大家如何使用中国大陆的SendCloud服务让用户收到邮件

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/7mSBOnmzQaOMbm3Ezklj_%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-02-13%2016.35.17.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/7mSBOnmzQaOMbm3Ezklj_%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-02-13%2016.35.17.png)

## 步骤

### Step 1: 注册SendCloud

<http://sendcloud.net/>

将生成的`API_USER`和`API_KEY`信息保存下来

如果忘记 `API_KEY`，可以到 `发送设置` 生成一个新的

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/6IcbgG2Ty2aevQcYmXDg_3bLoUnjtR5qYNPSPjk3r_WX20170209-105306.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/6IcbgG2Ty2aevQcYmXDg_3bLoUnjtR5qYNPSPjk3r_WX20170209-105306.png)

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/9fV4p037SfaE5oD2VfdR_ng2cBeGRGKRr6ftEj3gH_WX20170209-105808.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/9fV4p037SfaE5oD2VfdR_ng2cBeGRGKRr6ftEj3gH_WX20170209-105808.png)

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/4hkObqRATYGks7DsPeSu_vtk2KiN2SJq4YXf9UQar_WX20170209-111805.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/4hkObqRATYGks7DsPeSu_vtk2KiN2SJq4YXf9UQar_WX20170209-111805.png)

### Step 2: 修改文件

修改开发环境用于本地测试

config/environments/development.rb

```
Rails.application.configure do
...(略)
－    config.action_mailer.delivery_method = :letter_opener
＋  # config.action_mailer.delivery_method = :letter_opener

＋  config.action_mailer.delivery_method = :smtp
＋  ActionMailer::Base.smtp_settings = {
＋    address: "smtpcloud.sohu.com",
＋    port: 25,
＋    domain: "heroku.com",
＋    authentication: "login",
＋    enable_starttls_auto: true,
＋    user_name: ENV["SEND_CLOUD_USER_NAME"],
＋    password: ENV["SEND_CLOUD_USER_KEY"]
＋    }
end
```

修改生产环境用于heroku使用

config/environments/production.rb

```
Rails.application.configure do
...(略)

+  config.action_mailer.default_url_options = { :host => '你的herokuapp地址'}

+  config.action_mailer.delivery_method = :smtp
+  ActionMailer::Base.smtp_settings = {
+    address: "smtpcloud.sohu.com",
+    port: 25,
+    domain: "heroku.com",
+    authentication: "login",
+    enable_starttls_auto: true,
+    user_name: ENV["SEND_CLOUD_USER_NAME"],
+    password: ENV["SEND_CLOUD_USER_KEY"]
+    }
end
```

config/application.yml

```
production:
  AWS_ACCESS_KEY_ID: "xxxx"
  AWS_SECRET_ACCESS_KEY: "xxxx"
  AWS_REGION: "xxxx"
  AWS_BUCKET_NAME: "xxxx"
+ SEND_CLOUD_USER_NAME: "xxxx"  # 你的 API_USER

+ SEND_CLOUD_USER_KEY: "xxxx"  # 你的 API_KEY



development:
  AWS_ACCESS_KEY_ID: "xxxx"
  AWS_SECRET_ACCESS_KEY: "xxxx"
  AWS_REGION: "xxxx"
  AWS_BUCKET_NAME: "xxxx"
+ SEND_CLOUD_USER_NAME: "xxxx"  # 你的 API_USER

+ SEND_CLOUD_USER_KEY: "xxxx"  # 你的 API_KEY
```

### Step 3: 本地测试

重开rails server

请用真实邮箱注册登录你的网站，生成订单后查收注册邮箱，收到邮件即可确认成功

如果出现下图报错，请断开VPN再测试

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/EVFrmz1ATsifxV0brJr8_%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-02-13%2015.12.57.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/EVFrmz1ATsifxV0brJr8_%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-02-13%2015.12.57.png)

### Step 4: 部署到heroku

```
git add .
git commit -m "sendcloud settings"
figaro heroku:set -e production
git push heroku aws:master
```

同样请用真实邮箱注册登录你的网站，生成订单后查收注册邮箱，收到邮件即可确认成功

# 12-7 Rails 环境架构

## Rails 架构

各位在 Rails 的 `config/enviorments/` 下面应该会看到三个档案，分别代表了 Rails 里面运行的三种模式：

- development
- test
- production

Rails 的哲学是：开发者可以只写一套代码，透过截取不同环境设定档（`config/enviorments/*.rb`）以及不同数据库 (`config/database.yml`) 来达到不同环境的数据库部署与系统设置。

如此以来可以让代码保持干净，不必在代码里面针对硬性写死代码，处理一些「正式」与「开发」环境上的例外。

### development

所谓的 development 就是开发模式，平常我们在本地电脑用的就是这种模式，包括

- `rails s`
- `rails c`

读取的都是本地开发模式。这个开发模式故障时可直接看到程式码可以 debug。

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/6gwJGGDlRxiAnpcFHYTm_development.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/6gwJGGDlRxiAnpcFHYTm_development.png)

### production

而 production 就是正式环境，heroku 就属于正式环境部署平台的一种。在正式环境上出错了，使用者只会看到 500 画面。

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/F41YWhdXSv6QbNTZejCQ_pr.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/F41YWhdXSv6QbNTZejCQ_pr.png)

### test

这个模式，是「测试」模式。（但是不是各位想像的「手动测试」，我们将会在其他课程单独讲这个主题，目前先跳过不说）

## 如何修改环境变数

通常我们会修改 config/enviorments/xxx.rb 里面的档案。（有时候某些 gem 安装时就会请你修改这里面的设置）

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/Cb3fGkwDT5SAzF4ggrNt_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202017-02-03%20%E4%B8%8B%E5%8D%883.59.37.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/Cb3fGkwDT5SAzF4ggrNt_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202017-02-03%20%E4%B8%8B%E5%8D%883.59.37.png)

修改完记得要重开 `rails s` 才会生效

## 如何在 Controller 里判断环境，而决定执行不同行为呢？

有时候，我们要做的并不是改环境设置，而是有时候在测试某些功能，只在开发环境上有效。那么我们要如何做呢？

答案就是使用这个 Rails 提供的变量 `Rails.env`，这是一个字串，只会根据环境回传 `development`，`test`或是 `production`。

具体示范如下：

```
def mail_to_customer
  if Rails.env == "devlopment"
    do_xxx
  else
    do_yyy
  end
end
```

# 12-8 如何在 Heroku 上 Debug

### 目标

- heroku logs/console/seed
- 安装套件 airbrake 实现自动通知 bug

### 步骤

#### Step 0:

通常在 heroku 上的错误信息可以透过`heroku logs`来检查。

此外，heroku open 无法开启，通常是忘了输入

`heroku run rake db:migrate`

进入rails console的方式
`heroku run rails console`

如果有写seeds档案，可以执行

`heroku run rake db:seed`

本章另外介绍 airbrake 这个服务，可以随时记录错误信息，并发送邮件通知网站出现 bug。

#### Step 1: 注册 airbrake

到 [https://airbrake.io](https://airbrake.io/) 注册帐号，选择 ESSENTIAL 方案(30天免费)

（记得30天后取消，否则会被收费）

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/XheD2eSKWr0yPMoEpAmA_Snip20170213_7.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/XheD2eSKWr0yPMoEpAmA_Snip20170213_7.png)

输入subdomain、帐号、邮箱和密码

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/yQiN7duQCmtZLufhREBC_Snip20170213_8.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/yQiN7duQCmtZLufhREBC_Snip20170213_8.png)

填写信用卡信息

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/lBRIrfzRTByOHAMylbru_Snip20170213_11.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/lBRIrfzRTByOHAMylbru_Snip20170213_11.png)

新建 airbrake 项目，点击 Generate projects from GitHub

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/z1UgLe0lQgmgccTkWrzA_Snip20170213_12.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/z1UgLe0lQgmgccTkWrzA_Snip20170213_12.png)

授权让 airbrake 接入 github，点击 Authorize application

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/2RgCpnLfS48Zek9Arlvz_Snip20170213_13.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/2RgCpnLfS48Zek9Arlvz_Snip20170213_13.png)

选择项目，点击 Create 1 project

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/u7arihwbT7GthKBm3INf_Snip20170213_18.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/u7arihwbT7GthKBm3INf_Snip20170213_18.png)

点击 Finish setup

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/Vz0ejzkMQGKqSLGRxtLk_Snip20170213_19.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/Vz0ejzkMQGKqSLGRxtLk_Snip20170213_19.png)

#### Step 2: 在项目里加上 gem airbrake

在终端输入 `git checkout -b airbrake`

安装 airbrake gem

Gemfile

```
+ gem 'airbrake', '~> 5.4'
```

`bundle install`

输入`rails g airbrake PROJECT_ID PROJECT_KEY` 会产生档案如下

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/olrJ7woQRKxD17vlLCiw_Snip20170213_23.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/olrJ7woQRKxD17vlLCiw_Snip20170213_23.png)

将红框内的代码修改如下

config/initializers/airbrake.rb

```
- c.project_id = PROJECT_ID
- c.project_key = 'PROJECT_KEY'

+ c.project_id = ENV['PROJECT_ID']
+ c.project_key = ENV['PROJECT_KEY']
```

在 airbrake 后台 => Project Settings，可以查找到 Project ID 和 Project API Key

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/po3UcTJbS6KReqnVzKkA_Snip20170213_34.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/po3UcTJbS6KReqnVzKkA_Snip20170213_34.png)

将其添加到 config/application.yml 中

config/application.yml

```
...(略)
  prouction:
    AWS_ACCESS_KEY_ID:  "XXXX"
    AWS_SECRET_ACCESS_KEY:  "XXXX"
    AWS_REGION:  "XXXX"
    AWS_BUCKET_NAME:  "XXXX"
    SEND_CLOUND_USER_NAME:  "XXXX"
    SEND_CLOUND_USER_KEY:  "XXXX"
+   PROJECT_ID:  "XXXX"
+   PROJECT_KEY:   "XXXX"

  development:
    AWS_ACCESS_KEY_ID:  "XXXX"
    AWS_SECRET_ACCESS_KEY:  "XXXX"
    AWS_REGION:  "XXXX"
    AWS_BUCKET_NAME:  "XXXX"
    SEND_CLOUND_USER_NAME:  "XXXX"
    SEND_CLOUND_USER_KEY:  "XXXX"
+   PROJECT_ID:  "XXXX"
+   PROJECT_KEY:   "XXXX"
```

测试看看，在终端运行
`rake airbrake:test`
（会得到一连串信息，是正常的。）

保存并上传到 heroku
`git add .`
`git commit -m "install airbrake"`
`figaro heroku:set -e production`
`git push heroku airbrake:master`

#### Step 3: 效果

若网站报错时：

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/v7UkVcRPCev4UC8YaRQD_Snip20170213_28.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/v7UkVcRPCev4UC8YaRQD_Snip20170213_28.png)

Airbrake 后台会自动收到错误信息：

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/HVaNsjUWRZiX9UkHCSmV_Snip20170213_30.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/HVaNsjUWRZiX9UkHCSmV_Snip20170213_30.png)

邮箱里面也会收到错误信息通知：

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/x817bgR0TwK7BFD7qhah_Snip20170213_32.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/x817bgR0TwK7BFD7qhah_Snip20170213_32.png)

如此一来便可以随时追踪错误信息了！

# 12-9 泄漏 S3 密钥的处理方式

## 目标

如果没有正确使用 [Figaro管理密码](https://fullstack.xinshengdaxue.com/posts/241)，将密钥上传到了github，会造成 S3 密钥泄漏。

如果发生了这种事情，我们需要马上删除泄漏的密钥。

## 步骤

### Step 1: 登入 AWS 后台，删除根密钥

如果你泄漏了根密钥，会导致信用卡被盗刷

打开我的安全凭证

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/12Kp5BR9Qf2AKXqT1nDQ_006tNbRwly1fcr2qxyrhhj308z06jjrk-1.jpg)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/12Kp5BR9Qf2AKXqT1nDQ_006tNbRwly1fcr2qxyrhhj308z06jjrk-1.jpg)

打开访问密钥

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/b8ng7UZOQSW45n3mS9Or_006tNbRwly1fcr39yfjqlj30l609g75i.jpg)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/b8ng7UZOQSW45n3mS9Or_006tNbRwly1fcr39yfjqlj30l609g75i.jpg)

删除泄漏访问密钥

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/sFBL68YtT6OH8HccB5RD_OCj67Wq9TImgKaz3jQfz_006tNbRwly1fcr84r1cyoj30t20ixn21.jpg)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/sFBL68YtT6OH8HccB5RD_OCj67Wq9TImgKaz3jQfz_006tNbRwly1fcr84r1cyoj30t20ixn21.jpg)

### Step 2: 登入 AWS 后台,删除 IAM 用户

如果泄漏了 IAM 用户的密钥，需要把 IAM 用户一并删除
打开我的安全凭证

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/12Kp5BR9Qf2AKXqT1nDQ_006tNbRwly1fcr2qxyrhhj308z06jjrk-1.jpg)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/12Kp5BR9Qf2AKXqT1nDQ_006tNbRwly1fcr2qxyrhhj308z06jjrk-1.jpg)

打开用户，选择泄漏的密钥的用户，删除用户即可

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/J8r7AsTSP6Fqjv9UPkVX_006tNbRwly1fcr3ya6vcoj30ie095gmf.jpg)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/J8r7AsTSP6Fqjv9UPkVX_006tNbRwly1fcr3ya6vcoj30ie095gmf.jpg)

### Step 3: 如果信用卡已经被盗刷

立即联系亚马逊客服，可以把这笔钱找回来。

# [直播回放]2月23日 编程知识补充

### 直播内容简介

- JDstore部署补充
- 商店大赛心得比赛&[作业](https://fullstack.xinshengdaxue.com/tasks/125)
- 什么是Gem?
- 注册输入验证码的gem rucaptcha实际演示([代码在此](http://docs.qzy.camp/docs/%E4%BD%BF%E7%94%A8gem-rucaptcha))

### 可参考网站:

- [Rails Cast](http://railscasts.com/): Gem的使用方法。[比较新的更新放在Youtube](https://www.youtube.com/user/RailscastsReloaded)
- [RubyFlow](http://www.rubyflow.com/): Rails的社群，可以看一下这边的讨论
- [GoRails](https://gorails.com/): 知识点的视频解说



# 12-10 使用七牛云（用来存储图片）（方案2）

> 注意：AWS S3 存储图片（方案1）与七牛云存储图片（方案2）切勿混用！

## 目标

注册[七牛云](https://www.qiniu.com/)

创建存储空间，用来存储图片

## 步骤

### Step 1: 注册七牛云

申请个人账户

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/R49PeafuQD2yF0tnjvLm_Screen%20Shot%202017-02-19%20at%2013.47.29.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/R49PeafuQD2yF0tnjvLm_Screen%20Shot%202017-02-19%20at%2013.47.29.png)

注册后需要激活邮箱

在个人面板 -> 密钥管理中，可以查看AccessKey/SecretKey，后面会用到

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/Ji0YehzaQc2o2kDsZoPB_Screen%20Shot%202017-02-19%20at%2014.40.44.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/Ji0YehzaQc2o2kDsZoPB_Screen%20Shot%202017-02-19%20at%2014.40.44.png)

### Step 2: 创建存储空间

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/toE828w6TDCiDpwLzoPQ_Screen%20Shot%202017-02-19%20at%2019.19.53.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/toE828w6TDCiDpwLzoPQ_Screen%20Shot%202017-02-19%20at%2019.19.53.png)

这些信息后面会用到

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/MtQjrNfQRurCbEdQrpJA_Screen%20Shot%202017-02-19%20at%2019.26.41.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/MtQjrNfQRurCbEdQrpJA_Screen%20Shot%202017-02-19%20at%2019.26.41.png)

### Step 3: 在专案中设置七牛云

`git checkout -b qiniu`

Gemfile

```
...(略)
+ gem 'carrierwave-qiniu'
+ gem 'qiniu-rs'
...(略)
```

`bundle install`

`bundle update`

`touch config/initializers/carrierwave.rb`

config/initializers/carrierwave.rb

```
CarrierWave.configure do |config|
  config.storage             = :qiniu
  config.qiniu_access_key    = ENV["qiniu_access_key"]
  config.qiniu_secret_key    = ENV["qiniu_secret_key"]
  config.qiniu_bucket        = ENV["qiniu_bucket"]
  config.qiniu_bucket_domain = ENV["qiniu_bucket_domain"]
  config.qiniu_block_size    = 4*1024*1024
  config.qiniu_protocol      = "http"
  config.qiniu_up_host       = "http://up.qiniug.com"  #选择不同的区域时，"up.qiniug.com" 不同

end
```

将图片存储位置改为七牛

app/uploaders/image_uploader.rb

```
class ImageUploader < CarrierWave::Uploader::Base
...(略)
- storage :file
+ # storage :file

+ storage :qiniu
...(略)
```

```
git add .
git commit -m "config qiniu"
```

# 12-11 使用Figaro管理密码（方案2）

> 注意：AWS S3 存储图片（方案1）与七牛云存储图片（方案2）切勿混用！

## 为什么我们需要 figaro？

当我们使用 Github 存储我们代码的时候，一些诸如 AccessKey 等密钥信息是不能够让其他人获得的，但项目中又需要提供配置信息。

figaro是一个方便管理机密信息、密钥的gem，并且能一个指令就将机密信息同步到heroku上，如此一来密钥也不会外泄。

### Step 1: 安装 figaro

```
+ gem 'figaro'
```

`bundle install`

`figaro install`

会自动生成 config/application.yml 文件并自动添加到 .gitignore 档案里

[![img](http://user-image.logdown.io/user/19197/blog/18708/post/1383092/b5ktTYYGRbqmfpbF9pxU_Snip20170205_27.png)](http://user-image.logdown.io/user/19197/blog/18708/post/1383092/b5ktTYYGRbqmfpbF9pxU_Snip20170205_27.png)

### Step 2: 设定机密信息

`cp config/application.yml config/application.yml.example`

修改 config/application.yml 档案

{备注：config/application.yml 档案有可能被隐藏了，所以我们要把它调出来。打开 atom 编辑器里的 settings（可以通过 command+ 逗号快速调出） -> packages。在搜索栏中输入 tree，在 tree-view 中点选 settings，把 Hide VCS Ignored Files 的勾去掉就会显示出来了。}

config/application.yml

```
...(略)

 production:
   qiniu_access_key: xxxx  # 你的 qiniu AccessKey

   qiniu_secret_key: xxxx  # 你的 qiniu SecretKey

   qiniu_bucket: xxxx  # 你的 qiniu bucket

   qiniu_bucket_domain: xxxx  # 你的 qiniu bucket domain



 development:
   qiniu_access_key: xxxx  # 你的 qiniu AccessKey

   qiniu_secret_key: xxxx  # 你的 qiniu SecretKey

   qiniu_bucket: xxxx  # 你的 qiniu bucket

   qiniu_bucket_domain: xxxx  # 你的 qiniu bucket domain

```

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/7PIMYGk5Sg2N32ymTM5j_Screenshot%20at%20Feb%2022%2021-16-13.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/7PIMYGk5Sg2N32ymTM5j_Screenshot%20at%20Feb%2022%2021-16-13.png)

```
git add .
git commit -m "figaro"
```

# 12-12 将JDStore部署到Heroku（方案2）

> 注意：AWS S3 存储图片（方案1）与七牛云存储图片（方案2）切勿混用！

## 目标

- 将密钥设定同步到Heroku
- 将JDStore部署到Heroku

## 步骤

### Step 1: 修改 Gemfile 档案

把 sqlite3 从第7行搬到 group :development, :test do 中间

[![img](http://ww1.sinaimg.cn/large/006tNbRwjw1fb5t9ep5udj30dc03ydg7.jpg)](http://ww1.sinaimg.cn/large/006tNbRwjw1fb5t9ep5udj30dc03ydg7.jpg)

在末尾新增一个 production group，加上 pg 这个 gem

```
group :production do
  gem 'pg'
end
```

[![img](http://ww3.sinaimg.cn/large/006tNbRwjw1fb5vm23d6wj30ft03zwex.jpg)](http://ww3.sinaimg.cn/large/006tNbRwjw1fb5vm23d6wj30ft03zwex.jpg)

command+s 存档

修改 Gemfile 后要 `bundle install`

```
git add .
git commit -m "move sqlite3 to dev group & add pg to production group"
```

具体可以参考第一课[相关章节](https://fullstack.xinshengdaxue.com/posts/26)以及[帮助文档](http://docs.qzy.camp/docs/heroku)

### Step 2: 创建heroku app并将设定好的机密资讯同步到这个app

`heroku create` 先创建一个heroku app

`figaro heroku:set -e production`

`heroku config` 可以列出目前所有的设定

### Step 5: 上传到github和heroku

```
git push origin qiniu
git push heroku qiniu:master
heroku run rake db:migrate
```

#### 提示：如何在本地设置环境变数

- <http://thejavashop.net/blog/?p=5>

#### 提示：如何在 Heroku 设置环境变数

- <https://devcenter.heroku.com/articles/config-vars>

# 商店创意大赛参赛手册

### [请点击这里下载参赛手册并打印出来](https://www.filepicker.io/api/file/BW4zCvlWTgSpi6uato3T)


<iframe src="/files-text/商店创意大赛参赛手册.pdf" style="width:718px; height:700px;" frameborder="4"></iframe>


# [直播回放]2月13日 商店大赛协作技巧&如何组队

主讲人：
xdite老师

时间：
2月13日 20:00

时长：
主讲时长约30分钟
答疑时长约15分钟

概要：
1.商店大赛技术结构
2.如何捕捉知识点
3.组队技巧

​        13-1 组队诀窍

## 目标

- 找到协作队友，一起参加[商店大赛](https://fullstack.xinshengdaxue.com/competition_season_2)
- 锻炼协作能力，成为靠谱的开发者

### 找什么样的队友

同城尤佳，找属性互补的，你才可以学到最多东西。

一个擅长编程，一个擅长美术、运营或策划，这样的组合更有可能会赢。

### 如何同城组队

最高效的方法就是参加 Meetup，现场组队。

组间可以互换资源，用技术「投资股份」。

### 如何远程组队

到Slack #teamup 频道发表招募信息，请务必按照以下格式撰写信息

> 我是 xdite，家住北京朝阳，一个礼拜有三天晚上可以编程，周末一天可以参加面对面组队。擅长：编程推进、文案写作。征求美术、运营、前端擅长者（三选二）同学一起组队。意者 slack 私聊。

### 如何分配任务

先自己写下 Must Have / Should Have / Could Have

聚会碰面时列出任务的优先顺序

使用 [Github Project](https://fullstack.xinshengdaxue.com/posts/425) 管理待办事项

使用[「黑客松」](https://fullstack.xinshengdaxue.com/courses/9/syllabus)技巧，管理精力、预期、产出

### 如何组队编程

首先确定一位主程，负责写程序主干，解决代码冲突

辅攻负责写css或文案

先写完「指定作业」，再研究酷炫技能（一个功能不要写超过两天）

[github协作指南](https://fullstack.xinshengdaxue.com/posts/430)

### 如何推进项目

Standup Meeting

每天早上的站会，每个人花 5 分钟讲述以下三部分内容，远程组队可以语音私聊

> - 昨天我做了什么
> - 今天我接续要做什么
> - 昨天遇到的困难点，希望队友帮忙解决

## 本节作业

##### [购物网站 - 第三周作业](https://fullstack.xinshengdaxue.com/assignments/10)：[寻找队友](https://fullstack.xinshengdaxue.com/tasks/114)

已有 117 个第一期同学提交了这个作业 [**看看同学怎么做](https://fullstack.xinshengdaxue.com/tasks/114/other_answers?order=recent)

[**提交作业](https://fullstack.xinshengdaxue.com/tasks/114)

找到队友并将你的队友全栈营「用户名」贴上来

# 13-2 Github协作指南

## 目标

使用Github进行代码协作

## 注意

本篇指南区分为，「主程篇」、「副程篇」以及「共同遵守篇」，除了共同遵守篇一定需要阅读，请针对自己在团队里的角色进行阅读就可以了，避免过多的资讯导致掉坑

## 主程篇

### Step 0: 找到你的队友

两人一队，确定一位主程。

由于我们目标是两人一队，主程必须要能负责整个购物网站专案的代码管理
除了负责 merge pull request，也需要能够解决与副程所产生的代码冲突问题。

[组队诀窍](https://fullstack.xinshengdaxue.com/posts/432)

### Step 1: 主程邀请你的队友

打开要进行协作的repo，点击 `Settings` -> `Collaborators`

在页面中间的搜索框中输入队友github的username，如果找到，框下面会跳出队友头像，点击头像，然后点击 `Add collaborator`，这样就邀请成功啦。

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/KxRSUTl6RW2b8a1x3Hd5_%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-02-13%2020.54.57.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/KxRSUTl6RW2b8a1x3Hd5_%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-02-13%2020.54.57.png)

### Step 2: 协作之前，将最新分支merge到master

如果master分支的更新时间不是最近，那么你需要做这一步

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/CiIb3zKdTiOfP8etXfKX_Screen%20Shot%202017-02-21%20at%2015.44.46.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/CiIb3zKdTiOfP8etXfKX_Screen%20Shot%202017-02-21%20at%2015.44.46.png)

比如你的最新分支是story5，那么在终端 `git checkout master`，然后 `git merge story5`，再推到github `git push origin master`

### Step 3: 主程 merge 来自副程或自己的 pull request

点击 `Pull requests` 可以看到所有 pull requests 记录

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/nv83BTBS0KxmNrVMYqXu_%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-02-13%2022.20.31.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/nv83BTBS0KxmNrVMYqXu_%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-02-13%2022.20.31.png)

点开 pull request

如果显示 `This branch has no conflicts with the base branch`，这种情况可以直接merge，点击 `Merge pull request`，然后 `Confirm merge` 就可以了

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/YHsNZ0rkQJ2DCAMaoWA5_%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-02-13%2022.29.10.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/YHsNZ0rkQJ2DCAMaoWA5_%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-02-13%2022.29.10.png)

merge完成

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/I5XYs9V4TsKDGWTkoBv2_%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-02-13%2022.33.28.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/I5XYs9V4TsKDGWTkoBv2_%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-02-13%2022.33.28.png)

那么，什么情况不能直接merge呢？

显示 `This branch has conflicts that must be resolved`，这时 `Merge pull request` 按钮呈灰色，无法点击，必须先解决代码冲突才能继续。

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/TOgZ8fViQDGimdGbMtcC_%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-02-14%2011.26.31.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/TOgZ8fViQDGimdGbMtcC_%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-02-14%2011.26.31.png)

### Step 4: 解决冲突

如何解决冲突？

你可以选择不处理这个pull request，在本地修改后再上传一个新的pull request

或者按照github给出的指令处理冲突

点击 `Resolve conflicts`，左边显示出代码有冲突的所有文件，打开其中一个文件

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/fIeRBukJQoeagROsqrcZ_%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-02-14%2011.37.20.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/fIeRBukJQoeagROsqrcZ_%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-02-14%2011.37.20.png)

可以看到，`<<<<<<<` 和 `>>>>>>> master` 把代码有冲突的部分包了起来

`=======` 又把这部分分成了上下两半

上半部分是当前pull request中这个文件的写法

下半部分是当前master分支上这个文件的写法

接下来把多出的三行符号删掉，保留你需要的代码

比如

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/e9hcNSWUSiGGYh4HT5D3_%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-02-14%2011.53.37.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/e9hcNSWUSiGGYh4HT5D3_%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-02-14%2011.53.37.png)

然后点击 `Mark as resolved`

冲突全部解决之后，会显示 `Resolved all conflicts`，点击 `Commit changes`

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/KhfsT9ENSWuEZYlKHHMP_%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-02-14%2011.56.30.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/KhfsT9ENSWuEZYlKHHMP_%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-02-14%2011.56.30.png)

之后会跳转回当前pull request地址，显示 `This branch has no conflicts with the base branch`，点击 `Merge pull request`，然后 `Confirm merge` 就可以了

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/v0qwJIQbQfeBNnynHyku_%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-02-14%2012.04.17.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/v0qwJIQbQfeBNnynHyku_%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-02-14%2012.04.17.png)

### Step 5: 在本地获取 merge 后最新的代码

当最新的代码已经合进 master 分支里，主程只需要在本地的终端checkout回master分支，然后运行git fetch

那么主程就能够得到最新的代码了

## 副程篇

### Step 1: 接受主程邀请，成为协作者

副程所使用的github注册邮箱会收到一封邀请邮件

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/UJLRG8FTSBake7cgYR3j_Screenshot%20at%20Feb%2013%2020-58-53.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/UJLRG8FTSBake7cgYR3j_Screenshot%20at%20Feb%2013%2020-58-53.png)

点击 `View invitation` 后，跳转到github页面

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/ObEv8dDQGWklU17ZYWt9_Screenshot%20at%20Feb%2013%2020-59-19.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/ObEv8dDQGWklU17ZYWt9_Screenshot%20at%20Feb%2013%2020-59-19.png)

点击 `Accept invitation`，会跳转到协作repo，同时收到一封确认邮件

协作repo如图：

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/yomQZoMfR1y2gWLxDuoQ_Screenshot%20at%20Feb%2013%2021-00-19.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/yomQZoMfR1y2gWLxDuoQ_Screenshot%20at%20Feb%2013%2021-00-19.png)

确认邮件如图：

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/A4XP1U67QK2guBmEzbeh_Screenshot%20at%20Feb%2013%2021-01-04.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/A4XP1U67QK2guBmEzbeh_Screenshot%20at%20Feb%2013%2021-01-04.png)

### Step 2: clone 主程的代码一起共同开发

第一次把代码下载到本地，使用 `git clone 主程的repo地址`

在终端运行 `cd xxx（专案名）`

`cp config/database.yml.example config/database.yml`

`bundle install`

`rake db:migrate`

再打开rails s，才能在本地跑起来

如果有先写好的seed档案，也别忘记对数据库初始化，运行 `rake db:seed` 就可以了

这里请直接 clone 主程的专案到本机进行开发，自己的专案不需要在管。

可以在你 clone 下来的专案输入 `git remote -v`，检查当中的网址是否为主程的 github 帐号，如果不是，请注意你会无法发送开发功能给主程，请在此刻修正。

### Step 3: 发送 Pull Requset 给主程吧

在本地终端切出一只分支，尝试修改某个文字之后进行 commit 存档，然后 push 这只分支到 github 吧！

接下来我们就能够发 pull request 给主程啰

点击「New pull request」，会转成以下画面。把base fork点选主程的repo（通常是第二笔）

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/bsYhwQXgReaLIb3EkrQu_Screenshot%20at%20Mar%2007%2018-24-35.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/bsYhwQXgReaLIb3EkrQu_Screenshot%20at%20Mar%2007%2018-24-35.png)

可以看到页面跳转成如下。

① 确认已经转到主程的repo；
② base选择你想要merge的分支，可以选择「master」（一般正式协作会另外创建一个develop分支，把开发的进度放到develop，master一般于production环境）；
③ compare选择副程的分支名；
④ 查看是否是「Able to merge」状态；
⑤ 写下你的comment。
确认以上五点后，点击「Create pull request」

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/vMd2FdH7RKOslvGhqzuy_Screenshot%20at%20Mar%2007%2018-27-05.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/vMd2FdH7RKOslvGhqzuy_Screenshot%20at%20Mar%2007%2018-27-05.png)

点击「Merge pull request」

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/BFqxQ21DRLi9EvuSmIM2_Screenshot%20at%20Mar%2007%2018-28-03.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/BFqxQ21DRLi9EvuSmIM2_Screenshot%20at%20Mar%2007%2018-28-03.png)

你就完成提交了功能开发的分支给主程啰，你的任务就是

「本地切分支开发功能」 -> 「开发完后 push 当前分支」 -> 「上 Github 开 pull request 给主程」

## 共同遵守篇（主程 + 副程都得这么做）

### Step 1: 获取最新代码

每天于开发前执行 `git fetch origin`，获取当前所有分支的讯息

获取最新代码时，先 `git checkout master`，然后 `git pull origin master`

### Step 2: 开发项目

现在你在master分支上，对代码进行任何改动之前，一定要切换到一个新的分支，在新分支上进行修改

分支命名规则 `git checkout -b name-feature (姓名-功能)`

记住一个原则，请勿直接在 master 开发并直接推送到 github ，容易出现双方代码不对齐的情况，并且会不断发生冲突，请详记！

### Step 3: 上传分支

上传之前，一定要在本地进行测试，确认没有bug才可以上传

```
git add .
git commit -m "这个分支做的功能"
git push origin name-feature
```

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/NIgLGgxSf928gZY7X6gx_Screen%20Shot%202017-02-13%20at%2010.06.09%20PM.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/NIgLGgxSf928gZY7X6gx_Screen%20Shot%202017-02-13%20at%2010.06.09%20PM.png)

### 本节作业

##### [购物网站 - 第三周作业](https://fullstack.xinshengdaxue.com/assignments/10)：[为你喜欢的商店大赛作品投票](https://fullstack.xinshengdaxue.com/tasks/115)

已有 116 个第一期同学提交了这个作业 [**看看同学怎么做](https://fullstack.xinshengdaxue.com/tasks/115/other_answers?order=recent)

[**提交作业](https://fullstack.xinshengdaxue.com/tasks/115)

请投票后[点击此处查看你支持的作品](https://fullstack.xinshengdaxue.com/competitions/2/my_voted)，并将截图交上来（拖曳到此处）
投票者均有机会获得投票奖：Xdite老师签名版《Growth Hack这样做》

备注：投票规则
1.本网站的免费用户/VIP 用户均可为参赛作品投票
2.每个用户最多可以为5个不同的作品投票
3.每个用户只能为同一个作品投一次票（免费用户一次投票＝1票，VIP用户一次投票＝5票）
4.投票后无法撤销投票

##### [购物网站 - 第三周作业](https://fullstack.xinshengdaxue.com/assignments/10)：[组队参赛](https://fullstack.xinshengdaxue.com/tasks/113)

已有 108 个第一期同学提交了这个作业 [**看看同学怎么做](https://fullstack.xinshengdaxue.com/tasks/113/other_answers?order=recent)

[**提交作业](https://fullstack.xinshengdaxue.com/tasks/113)

上传你们的商店大赛截图、heroku地址和github地址。

##### [购物网站 - 第三周作业](https://fullstack.xinshengdaxue.com/assignments/10)：[写下你的比赛心得](https://fullstack.xinshengdaxue.com/tasks/125)

已有 101 个第一期同学提交了这个作业 [**看看同学怎么做](https://fullstack.xinshengdaxue.com/tasks/125/other_answers?order=recent)

[**提交作业](https://fullstack.xinshengdaxue.com/tasks/125)

请在logdown写下你的参赛心得，主要阐述在比赛过程中学到什么？对个人的成长带来什么？记录自己的成长历程。把心得题目和logdown链接贴到这里。
格式：
心得题目：
logdown链接地址：

# 13-3 利用 Tower 进行项目管理

## 目标：

用 Tower进行项目管理

## 步骤：

### Step1：注册tower

打开网址: [https://tower.im](https://tower.im/) 注册

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/B3h8yEP7TRaSYJobmXLp_Screenshot%20at%20May%2018%2021-37-36.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/B3h8yEP7TRaSYJobmXLp_Screenshot%20at%20May%2018%2021-37-36.png)

### Step2: 新建看板项目

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/30YzhyTRQx6W8RCE2Vqa_Screenshot%20at%20May%2018%2021-39-53.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/30YzhyTRQx6W8RCE2Vqa_Screenshot%20at%20May%2018%2021-39-53.png)

### Step3: 定义项目流程，最基本可以设计成 Todo -> Developing -> Done

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/NgbqUly1QeK2aOyggZCw_Screenshot%20at%20May%2018%2021-41-15.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/NgbqUly1QeK2aOyggZCw_Screenshot%20at%20May%2018%2021-41-15.png)

### Step4: 每个 User Story 开始实作时，进一步描述任务细节

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/hRdttW2VTK6DeYGJa4oH_Screenshot%20at%20May%2018%2021-42-43.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/hRdttW2VTK6DeYGJa4oH_Screenshot%20at%20May%2018%2021-42-43.png)

# [直播回放]2月20日 课程第一次复盘

主讲人：
xdite老师

时间：
2月20日 20:00

时长：
主讲时长约20分钟

概要：
课程第一次复盘

提示：
需要科学上网才可以正常观看本视频
如果画面模糊请到右下角按钮设置画质

刘同学整理的[直播笔记](http://maple-space.logdown.com/posts/1435507-20170220-live-notes)

关于2月18日北京国贸meetup，张同学的[[笔记\]](http://realanalysis-blog.logdown.com/posts/1426960-under-meetup-gathering-february-18)，于同学的[[笔记\]](http://alan003-blog.logdown.com/posts/1430386)，
江同学的[[笔记\]](http://hhcj2016new-blog.logdown.com/posts/1432046-20170218-offline-meetup)

# [直播回放]2月27日 读书方法论

主讲人：
xdite老师

时间：
2月27日 20:00

时长：
主讲时长30分钟
答疑时长30分钟

概要：

- 如何达到快速读书且吸收
- 认知心理读书法
- 快速形成自己的高频小套路



# [直播回放]3月2日 Google进阶用法

### 直播内容简介

- Landing Page小贴士
- Google法: 1. 关键词 2.简单描述 3.不需考虑文法 4.记录以上过程
- 图片怎么写seeds? ([结论在此](http://docs.qzy.camp/docs/%E5%A6%82%E4%BD%95%E5%9C%A8%E5%9B%BE%E7%89%87%E6%92%B0%E5%86%99seedsrb))
- gem acts_as_list实际演示([代码在此](http://docs.qzy.camp/docs/%E5%AE%9A%E5%95%86%E5%93%81%E4%BD%8D%E7%BD%AE%E7%9A%84gem))
- gem pry的使用法

每次Google时，请记录自己的过程与思绪，最后写成logdown总结，可参考邢亚铭同学的[本篇logdown](http://yammy-blog.logdown.com/posts/1497305)，除了基础问题也可以做进阶搜索，一样可以参考[邢同学的logdown](http://yammy-blog.logdown.com/posts/1515832)。

# [直播回放]3月6日 全栈营60天复盘

主讲人：
xdite老师

时间：
3月6日 20:00

时长：
本次直播总时长30分钟

概要：
全栈营60天复盘

### 本节作业

##### [购物网站 - 第三周作业](https://fullstack.xinshengdaxue.com/assignments/10)：[为你喜欢的商店大赛作品投票](https://fullstack.xinshengdaxue.com/tasks/115)

已有 116 个第一期同学提交了这个作业 [**看看同学怎么做](https://fullstack.xinshengdaxue.com/tasks/115/other_answers?order=recent)

[**提交作业](https://fullstack.xinshengdaxue.com/tasks/115)

请投票后[点击此处查看你支持的作品](https://fullstack.xinshengdaxue.com/competitions/2/my_voted)，并将截图交上来（拖曳到此处）
投票者均有机会获得投票奖：Xdite老师签名版《Growth Hack这样做》

备注：投票规则
1.本网站的免费用户/VIP 用户均可为参赛作品投票
2.每个用户最多可以为5个不同的作品投票
3.每个用户只能为同一个作品投一次票（免费用户一次投票＝1票，VIP用户一次投票＝5票）
4.投票后无法撤销投票

##### [购物网站 - 第三周作业](https://fullstack.xinshengdaxue.com/assignments/10)：[组队参赛](https://fullstack.xinshengdaxue.com/tasks/113)

已有 108 个第一期同学提交了这个作业 [**看看同学怎么做](https://fullstack.xinshengdaxue.com/tasks/113/other_answers?order=recent)

[**提交作业](https://fullstack.xinshengdaxue.com/tasks/113)

上传你们的商店大赛截图、heroku地址和github地址。

##### [购物网站 - 第三周作业](https://fullstack.xinshengdaxue.com/assignments/10)：[写下你的比赛心得](https://fullstack.xinshengdaxue.com/tasks/125)

已有 101 个第一期同学提交了这个作业 [**看看同学怎么做](https://fullstack.xinshengdaxue.com/tasks/125/other_answers?order=recent)

[**提交作业](https://fullstack.xinshengdaxue.com/tasks/125)

请在logdown写下你的参赛心得，主要阐述在比赛过程中学到什么？对个人的成长带来什么？记录自己的成长历程。把心得题目和logdown链接贴到这里。
格式：
心得题目：
logdown链接地址：



# [直播回放]3月9日 Asset Pipeline知识补充&前端大补丸

### 直播内容简介

请参考 <https://github.com/ihower/jdstore>

主讲人：
ihower老师

时间：
3月9日 20:00

时长：
本次直播总时长60分钟

概要：

1. Asset Pipeline原理
2. 前端大补丸

# [直播回放]3月20日 60天综合大套路

### 直播内容简介:

全栈程序员如何创业

- 如何选择创业项目
- 制作 Landing Page
- 写代码
- Onboarding Framework
- NPS 净推荐值

感谢刘同学的笔记分享：<http://maple-space.logdown.com/posts/1619177>

# [直播回放]3月27日 xdite 征服世界的方法

主讲人：
xdite

时间：
3月27日 20:00

时长：
主讲时长34分钟
答疑时长12分钟

概要：
xdite 征服世界的方法

刘同学整理的笔记 <http://maple-space.logdown.com/posts/1648300-20170328-live-notes-how-to-change-the-world>

# [直播回放]3月30日 Nic助教分享如何找到工作

主讲人：
Nic (bboyceo)

时间：
2017年3月30日 20:00

时长：
主讲时长28分钟

概要：
Nic是Xdite老师在台湾开设Rails课程时的学生，也在slack上以bboyceo时常答覆大家的问题。这次本人现身说法，用亲身经历讲解求职重点以及如何面对面试的技巧
