---
layout: post
title: "Rails部署指南"
date: 2017-10-30
tags:
    Rails
    教材
---
#Rails部署指南

| 1-建立一台 Linode Sever 预计学习时间: 2小时以内        |      |
| ---------------------------------------- | ---- |
| [**  1-1 开始之前（必读）](https://fullstack.xinshengdaxue.com/posts/486) |      |
| [**  1-2 购买 ：Linode Server](https://fullstack.xinshengdaxue.com/posts/266) |      |
| [**  1-3 连线到远端主机更新](https://fullstack.xinshengdaxue.com/posts/268) |      |
| [**  1-4 购买阿里云机器并连到远端主机更新](https://fullstack.xinshengdaxue.com/posts/793) |      |
| [**  1-5 新增部署用帐号 apps](https://fullstack.xinshengdaxue.com/posts/269) |      |
| [**  1-6 安装 Ruby 环境](https://fullstack.xinshengdaxue.com/posts/270) |      |
| [**  1-7 安装 RMagick （可跳过）](https://fullstack.xinshengdaxue.com/posts/271) |      |
| [**  1-8 安装 Passenger ( Rails 用 HTTP Ser...](https://fullstack.xinshengdaxue.com/posts/272) |      |
| [**  1-9 让 Nginx 可以启动](https://fullstack.xinshengdaxue.com/posts/273) |      |

| 2-部署 Rails 项目 预计学习时间: 1小时半以内             |      |
| ---------------------------------------- | ---- |
| [**  2-1 安装 Rails](https://fullstack.xinshengdaxue.com/posts/274) |      |
| [**  2-2 安装 PostgreSQL](https://fullstack.xinshengdaxue.com/posts/275) |      |
| [**  2-3 使用 forum 这个项目测试部署 Part 1](https://fullstack.xinshengdaxue.com/posts/276) |      |
| [**  2-4 使用 forum 这个项目测试部署 Part 2](https://fullstack.xinshengdaxue.com/posts/277) |      |
| [**  2-5 使用 forum 这个项目测试部署 Part 3](https://fullstack.xinshengdaxue.com/posts/278) |      |

| 3-使用 Capistrano 部署 Rails 项目 预计学习时间: 2小时以内 |                                          |
| ---------------------------------------- | ---------------------------------------- |
| [**  3-1 新增一个 Rails 项目 "blog" 到 Github](https://fullstack.xinshengdaxue.com/posts/279) |                                          |
| [**  3-2 不用密码就能登进远端机器](https://fullstack.xinshengdaxue.com/posts/280) |                                          |
| [**  3-3 使用 Capistrano 部署项目 Part 1](https://fullstack.xinshengdaxue.com/posts/281) |                                          |
| [**  3-4 让远端机器可以去 github 拉档案](https://fullstack.xinshengdaxue.com/posts/282) |                                          |
| [**  3-5 使用 Capistrano 部署项目 Part 2](https://fullstack.xinshengdaxue.com/posts/283) |                                          |
| [**  3-6 设定 Nginx](https://fullstack.xinshengdaxue.com/posts/284) |                                          |
| [**  3-7 安装 capistrano-passenger](https://fullstack.xinshengdaxue.com/posts/285) | 共1个作业 \|[** 未完成](https://fullstack.xinshengdaxue.com/posts/285#task) |

# 1-1 开始之前（必读）

> 本教程有新改写版本，请前往 [Linux 云服务器部署运维](https://fullstack.xinshengdaxue.com/courses/66/syllabus)

### 本课程为选修课

> 若为找工作的同学，务必跟着教材实作；如果不是，可跳过本课。
>
> 无国际信用卡的同学请直接从["购买阿里云机器并连到远端主机更新"](https://fullstack.xinshengdaxue.com/posts/793)开始

- 为了更好的锻炼大家的自学能力，在实作本课程的过程中遇到任何bug，请先到Google搜索。
- 由于各位的部署环境不同，所出现的bug也都不一样，需要各位自行debug。
- 请详细记录每一次的bug，写在自己的logdown上。

# 1-2 购买 ：Linode Server

### Step 0. 註冊Linode

<https://www.linode.com/>

### Step 1. 选择机器

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/vNqexPLPSUKYL5EopGf1_qPWVe5Tc21B44rDcIkg2_p1.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/vNqexPLPSUKYL5EopGf1_qPWVe5Tc21B44rDcIkg2_p1.png)

### Step 2. 部署机器

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/2z7xpwF6QUyuXhcM8NwI_iba6.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/2z7xpwF6QUyuXhcM8NwI_iba6.png)

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/aZ6zsxwoS26bHNLVkAPF_9ceB.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/aZ6zsxwoS26bHNLVkAPF_9ceB.png)

### Step 3. 选择 Ubuntu

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/DEVo3uJPTLKUsAfnsuAy_zDzf.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/DEVo3uJPTLKUsAfnsuAy_zDzf.png)

### Step 4. 开机

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/IaQTOeVoTD24BtS4GlCw_Screen%20Shot%202016-12-20%20at%2015.55.10.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/IaQTOeVoTD24BtS4GlCw_Screen%20Shot%202016-12-20%20at%2015.55.10.png)

#### 确保真的有开好机

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/fXK3PWJrRi24WfEc21zX_Screen%20Shot%202016-12-20%20at%2015.17.33.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/fXK3PWJrRi24WfEc21zX_Screen%20Shot%202016-12-20%20at%2015.17.33.png)

# 1-3 连线到远端主机更新

### 连到远端主机

切到 Remote Access 分页

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/lLbIYzBATEW14maz2Pro_Screen%20Shot%202016-12-20%20at%2015.57.07.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/lLbIYzBATEW14maz2Pro_Screen%20Shot%202016-12-20%20at%2015.57.07.png)

找到 IP Address

### 打开 iTerm

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/eOMl5hw1QNSL5M2yzPYE_Screen%20Shot%202016-12-20%20at%2015.57.33.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/eOMl5hw1QNSL5M2yzPYE_Screen%20Shot%202016-12-20%20at%2015.57.33.png)

连线

`ssh root@xx.xx.xx.xx`

（顺利连线后的画面）

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/DqaY9C3SG2TmcWu6mGTU_Screen%20Shot%202016-12-20%20at%2015.58.07.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/DqaY9C3SG2TmcWu6mGTU_Screen%20Shot%202016-12-20%20at%2015.58.07.png)

### 让 IPV6 位址可以被辨别

`vi /etc/sysctl.conf`

加入这三行

```
net.ipv6.conf.all.disable_ipv6 = 1
net.ipv6.conf.default.disable_ipv6 = 1
net.ipv6.conf.lo.disable_ipv6 = 1
```

然后 ESC 然后输入 wq 存档离开 ( vi 操作，进阶指南请网上搜索）

然后执行 `sudo sysctl -p`

### 更新系统

`sudo apt-get update`
`sudo apt-get upgrade`

### 设定时区

`sudo dpkg-reconfigure tzdata`

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/LvdFGpmTcKcIrkcf19hU_Screen%20Shot%202016-12-20%20at%2016.04.36.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/LvdFGpmTcKcIrkcf19hU_Screen%20Shot%202016-12-20%20at%2016.04.36.png)

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/qxZrtSanRICOAGXgoVTU_Screen%20Shot%202016-12-20%20at%2016.05.26.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/qxZrtSanRICOAGXgoVTU_Screen%20Shot%202016-12-20%20at%2016.05.26.png)

### 安装 utf-8 的语系

`sudo locale-gen zh_TW zh_TW.UTF-8 zh_CN.UTF-8 en_US.UTF-8`

输入 `vi ~/.bashrc`

在键盘上按向下键，找到空行，按 `i` ，复制以下代码 `export LC_ALL="en_US.UTF-8"` ，按 command+v 黏贴进去。按键盘上的 esc 键，输入 `:`（冒号），再输入 `wq`，最后按 enter 键。

```
export LC_ALL="en_US.UTF-8"
```

如果输错时，按 esc 键，输入 `:`（冒号），再输入 `q!` ， 最后按 enter 键（此操作为放弃保存）。

然后执行 `source ~/.bashrc`

# 1-4 购买阿里云机器并连到远端主机更新

### 开始之前

> 注意：已经购买linode的同学请跳过本节，点击[下一步](https://fullstack.xinshengdaxue.com/posts/269)继续

### Step 0. 注册阿里云

<https://www.aliyun.com/>

大陆用户需要确认选择的是中国站，在首页右下角查看

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/7aYdU1BFQhWcxKFkUdsw_Screen%20Shot%202017-03-02%20at%2015.49.26.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/7aYdU1BFQhWcxKFkUdsw_Screen%20Shot%202017-03-02%20at%2015.49.26.png)

### Step 1. 需要进行实名认证才能购买产品

在首页右上角菜单找到实名认证入口

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/0expRPP6SRyZlz6rkiXv_Screen%20Shot%202017-03-05%20at%2022.07.49.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/0expRPP6SRyZlz6rkiXv_Screen%20Shot%202017-03-05%20at%2022.07.49.png)

选择认证方式，支付宝认证比较方便快捷

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/3XXee1LKQd6MJLMBzC8o_Screen%20Shot%202017-03-05%20at%2021.51.06.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/3XXee1LKQd6MJLMBzC8o_Screen%20Shot%202017-03-05%20at%2021.51.06.png)

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/JYnJ66I4TW2FKofxau4r_Screen%20Shot%202017-03-02%20at%2017.32.29.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/JYnJ66I4TW2FKofxau4r_Screen%20Shot%202017-03-02%20at%2017.32.29.png)

### Step 2. 购买云服务器

在菜单栏找到云服务器ECS服务

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/dmxUhX4QFmfhD1Dx43l6_Screen%20Shot%202017-03-02%20at%2018.26.50.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/dmxUhX4QFmfhD1Dx43l6_Screen%20Shot%202017-03-02%20at%2018.26.50.png)

进入控制台，选择云服务器 ECS > 实例，单击创建实例

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/GbA9c1GSTDGG0djfc7mI_Screen%20Shot%202017-03-02%20at%2019.16.10.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/GbA9c1GSTDGG0djfc7mI_Screen%20Shot%202017-03-02%20at%2019.16.10.png)

选择机器配置，可以根据预算和需求修改，但是公共镜像一定要选择 Ubuntu 16.04 64位

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/1qmiDCxRIeuLCy5g3uww_Screen%20Shot%202017-03-03%20at%2014.55.08.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/1qmiDCxRIeuLCy5g3uww_Screen%20Shot%202017-03-03%20at%2014.55.08.png)

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/FCqAaHe3RtGhW7uPzgy6_Screen%20Shot%202017-03-03%20at%2015.06.33.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/FCqAaHe3RtGhW7uPzgy6_Screen%20Shot%202017-03-03%20at%2015.06.33.png)

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/XthhRcGESl2zjPdlcV5i_Screen%20Shot%202017-03-03%20at%2015.11.18.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/XthhRcGESl2zjPdlcV5i_Screen%20Shot%202017-03-03%20at%2015.11.18.png)

购买后在管理控制台>云计算基础服务>云服务器ECS>实例中可以看到这台机器

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/r3Oi6qiLTPiHmIa5muC4_Screen%20Shot%202017-03-03%20at%2015.33.27.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/r3Oi6qiLTPiHmIa5muC4_Screen%20Shot%202017-03-03%20at%2015.33.27.png)

### Step 3. 连到远端主机更新

#### 连到远端主机

打开iTerm

连线 `ssh root@xx.xx.xx.xx`

询问是否连接时，输入yes

需要输入密码时输入密码

成功连线后的画面

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/ei6UF7YDRGU2IfJG145X_Screen%20Shot%20on%202017-03-03%20at%2015:36:58.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/ei6UF7YDRGU2IfJG145X_Screen%20Shot%20on%202017-03-03%20at%2015:36:58.png)

#### 更新系统

`sudo apt-get update`
`sudo apt-get upgrade`

#### 设定时区

`sudo dpkg-reconfigure tzdata`

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/LvdFGpmTcKcIrkcf19hU_Screen%20Shot%202016-12-20%20at%2016.04.36.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/LvdFGpmTcKcIrkcf19hU_Screen%20Shot%202016-12-20%20at%2016.04.36.png)

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/qxZrtSanRICOAGXgoVTU_Screen%20Shot%202016-12-20%20at%2016.05.26.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/qxZrtSanRICOAGXgoVTU_Screen%20Shot%202016-12-20%20at%2016.05.26.png)

#### 安装 utf-8 的语系

`sudo locale-gen zh_TW zh_TW.UTF-8 zh_CN.UTF-8 en_US.UTF-8`

输入 `vi ~/.bashrc`

在键盘上按向下键，找到空行，按 `i` ，复制以下代码 `export LC_ALL="en_US.UTF-8"` ，按 command+v 黏贴进去。按键盘上的 esc 键，输入 `:`（冒号），再输入 `wq`，最后按 enter 键。

```
export LC_ALL="en_US.UTF-8"
```

如果输错时，按 esc 键，输入 `:`（冒号），再输入 `q!` ， 最后按 enter 键（此操作为放弃保存）。

然后执行 `source ~/.bashrc`

# 1-5 新增部署用帐号 apps

## 解说

- 我们要建一个没有 admin 权限的 ubuntu 帐号来做未来 deploy 的操作。
- 这个没 admin 权限的帐号未来可以用来做自动化 deploy 专用，不让这个帐号有 admin 权限。
- 可以防止未来设定自动排程时手误还是被恶意放不该放的操作。

## 步骤

### 新增帐号 apps

执行`sudo adduser apps`

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/4eYQHIPwT36kc4yim7Dg_Screen%20Shot%20on%202016-12-20%20at%2016-12-28.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/4eYQHIPwT36kc4yim7Dg_Screen%20Shot%20on%202016-12-20%20at%2016-12-28.png)

### 将 apps 帐号加入 sudoer list，让 apps 有权限变身成 root

执行 `vi /etc/sudoers`

加入这一行

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/fTbMq2oiToW86N4Y1PPc_Screen%20Shot%202016-12-20%20at%2016.13.51%20(1).png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/fTbMq2oiToW86N4Y1PPc_Screen%20Shot%202016-12-20%20at%2016.13.51%20(1).png)

然后存档离开(如果提示是一个只读档案read-only，在vi输入`:wq!`来存档)

### 离开系统

输入`exit` 彻底离开这台机器

### 重新进入系统

`ssh apps@xx.xx.xx.xx`

# 1-6 安装 Ruby 环境

## 步骤

### 安装必要套件

`sudo apt-get install build-essential git-core curl libssl-dev libreadline5 libreadline-gplv2-dev zlib1g zlib1g-dev libcurl4-openssl-dev libxslt-dev libxml2-dev libffi-dev git vim`

### 安装 rvm

`\curl -sSL https://get.rvm.io | bash`

装好之后

执行 `source /home/apps/.rvm/scripts/rvm`

### 安装 Ruby

`rvm install 2.3.1`

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/0An1MWzNRlyjHAlL2F7R_Screen%20Shot%202016-12-20%20at%2016.16.25.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/0An1MWzNRlyjHAlL2F7R_Screen%20Shot%202016-12-20%20at%2016.16.25.png)

### 确认安装成功

执行 `rvm list` 确认真的有安装成功

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/G6WEWc8SuyrNUw9ZoDcM_Screen%20Shot%202016-12-20%20at%2016.16.53.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/G6WEWc8SuyrNUw9ZoDcM_Screen%20Shot%202016-12-20%20at%2016.16.53.png)

### 安装 Bundler

执行 `gem install bundler`

# 1-7 安装 RMagick （可跳过）

## 解说

- RMagick 是在生产环境最难装的套件，但又是一定会用到的套件
- 如果这步失败，请直接跳过，并在论坛上回报

## 步骤

- `sudo apt-get install imagemagick`
- `sudo apt-get install libmagickwand-dev`
- `gem install rmagick`

# 1-8 安装 Passenger ( Rails 用 HTTP Server )

### 安装 Passenger

执行 `gem install passenger`

### 安装 Nginx 并整合 Passenger

执行 `rvmsudo passenger-install-nginx-module`

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/B3KW3ziwRbebMTQ3Y6R1_Screen%20Shot%202016-12-20%20at%2016.29.04.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/B3KW3ziwRbebMTQ3Y6R1_Screen%20Shot%202016-12-20%20at%2016.29.04.png)

选择 Ruby & NodeJS

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/bYslekQuQZm9NmdrbOJZ_Screen%20Shot%202016-12-20%20at%2016.29.28.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/bYslekQuQZm9NmdrbOJZ_Screen%20Shot%202016-12-20%20at%2016.29.28.png)

再选择用“编译”的安装法

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/wYPYvnXRmqGEG4OnNCDU_Screen%20Shot%202016-12-20%20at%2016.29.52.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/wYPYvnXRmqGEG4OnNCDU_Screen%20Shot%202016-12-20%20at%2016.29.52.png)

选择“安装目录”（按Enter即可）

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/cpao98bQFKaGFhD64Tew_Screen%20Shot%202016-12-20%20at%2016.30.24.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/cpao98bQFKaGFhD64Tew_Screen%20Shot%202016-12-20%20at%2016.30.24.png)

成功画面(版本不一样没关系）

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/bkEucRmmQEajsGetjs55_Screen%20Shot%202016-12-20%20at%2016.35.13.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/bkEucRmmQEajsGetjs55_Screen%20Shot%202016-12-20%20at%2016.35.13.png)

# 1-9 让 Nginx 可以启动

`git clone git://github.com/jnstq/rails-nginx-passenger-ubuntu.git`
`sudo mv rails-nginx-passenger-ubuntu/nginx/nginx /etc/init.d/nginx`
`sudo chown root:root /etc/init.d/nginx`

编辑 nginx server 档（只有 Ubuntu 16+ 需要）

`sudo vi /lib/systemd/system/nginx.service`

加入

```
[Unit]
Description=The NGINX HTTP and reverse proxy server
After=syslog.target network.target remote-fs.target nss-lookup.target
[Service]
Type=forking
PIDFile=/opt/nginx/logs/nginx.pid
ExecStartPre=/opt/nginx/sbin/nginx -t
ExecStart=/opt/nginx/sbin/nginx
ExecReload=/bin/kill -s HUP $MAINPID
ExecStop=/bin/kill -s QUIT $MAINPID
PrivateTmp=true
[Install]
WantedBy=multi-user.target
```

存档离开

### 重开 Nginx

执行 `sudo /etc/init.d/nginx restart`

看到此画面，表示重开成功。

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/hfhXwGGwS4oboe8IYcVv_Screen%20Shot%202016-12-20%20at%2016.38.17.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/hfhXwGGwS4oboe8IYcVv_Screen%20Shot%202016-12-20%20at%2016.38.17.png)

### 测试 Nginx

连到 [http://xx.xx.xx.xx](http://xx.xx.xx.xx/) 看到此画面，表示 Nginx 已被成功架设

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/1qxj780gTBe6jOat7d6m_Screen%20Shot%202016-12-20%20at%2016.39.18.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/1qxj780gTBe6jOat7d6m_Screen%20Shot%202016-12-20%20at%2016.39.18.png)

# 2-1 安装 Rails

### 安装 Rails

`gem install rails`

### 安装 nodejs

`sudo apt-get install npm`

# 2-2 安装 PostgreSQL

### 安装 PostgreSQL

`sudo apt-get install postgresql postgresql-contrib libpq-dev`

### 安装 pg

`gem install pg`

### 更改 postgres 密码

连进 psql 指令端

`sudo -u postgres psql`

修改postgres 这个帐号的密码

输入 `\password postgres`

输入你想要的密码（我这里也是叫`postgres`)

输入`\q` 离开介面

### 让 Rails 可以直接连这个帐号

`sudo vi /etc/postgresql/9.5/main/pg_hba.conf`

把`peer` 都改成`md5` 后存档

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/RUU58WaGRySzeKfXGL59_Screen%20Shot%202017-03-03%20at%2017.20.15.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/RUU58WaGRySzeKfXGL59_Screen%20Shot%202017-03-03%20at%2017.20.15.png)

然后执行`sudo /etc/init.d/postgresql reload` 重读设定档

# 2-3 使用 forum 这个项目测试部署 Part 1

### 新增一个项目

`rails new forum -d postgresql`
`cd forum`

### 修改 config/database.yml

输入 `vi config/database.yml`

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/mtaWwDoQGGxvhpyUfh1A_Screen%20Shot%202016-12-20%20at%2016.55.42.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/mtaWwDoQGGxvhpyUfh1A_Screen%20Shot%202016-12-20%20at%2016.55.42.png)

### 新增一个 Post model

`rails g scaffold post title:string content:text`

### 执行 db migration

`rake db:create`
`rake db:migrate`

### 测试 console

`rails c` 看能不能进去。输入`Post.last`

# 2-4 使用 forum 这个项目测试部署 Part 2

### 加入 production 的 db 密码

`vi config/database.yml`

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/dUCWztdWT6GDQNzu3Lba_Screen%20Shot%202016-12-20%20at%2017.07.52.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/dUCWztdWT6GDQNzu3Lba_Screen%20Shot%202016-12-20%20at%2017.07.52.png)

### 新增签名秘钥

执行 `rake secret`

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/FUwOSOlQQj69SgqT0VRL_Screen%20Shot%202016-12-20%20at%2017.08.31.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/FUwOSOlQQj69SgqT0VRL_Screen%20Shot%202016-12-20%20at%2017.08.31.png)

然后修改 `config/secrets.yml` 的 production 部分改上去

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/rFBGLjWfRsmb5xeFwwEV_Screen%20Shot%202016-12-20%20at%2017.09.06.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/rFBGLjWfRsmb5xeFwwEV_Screen%20Shot%202016-12-20%20at%2017.09.06.png)

### 执行 db migrate

`RAILS_ENV="production" rake db:create`
`RAILS_ENV="production" rake db:migrate`

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/tk5jVkIVQByDL6yGzaTJ_Screen%20Shot%20on%202016-12-20%20at%2017-09-51.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/tk5jVkIVQByDL6yGzaTJ_Screen%20Shot%20on%202016-12-20%20at%2017-09-51.png)

### Debug

可以用 `rails s -e production` debug

打开 <http://xxx.xxx.xxx.xx:3000/> 发现主页没有了，在 `config/routes.rb` 加上这一段

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/2gVzaXkBTFukb7B3451Q_Screen%20Shot%202016-12-20%20at%2017.11.26.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/2gVzaXkBTFukb7B3451Q_Screen%20Shot%202016-12-20%20at%2017.11.26.png)

# 2-5 使用 forum 这个项目测试部署 Part 3

### 编辑本机 /etc/hosts 让不存在的 forum.example.com 可以连

在本地终端中输入 `sudo atom /etc/hosts`

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/RWDumH01RlqCvcbni5hg_Screen%20Shot%202016-12-20%20at%2017.02.36.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/RWDumH01RlqCvcbni5hg_Screen%20Shot%202016-12-20%20at%2017.02.36.png)

### 修改 production 机器上的 nginx config 档

在远端服务器上输入 `sudo vi /opt/nginx/conf/nginx.conf`

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/7eIek6cDQmS0HNZmBwyS_Screen%20Shot%202016-12-20%20at%2017.00.23.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/7eIek6cDQmS0HNZmBwyS_Screen%20Shot%202016-12-20%20at%2017.00.23.png)

### 重开 nginx

`sudo /etc/init.d/nginx restart`

### 连到 [http://forum.example.com](http://forum.example.com/)

(如果连不上时，请关闭VPN再重试)

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/YzewocAhQbG24E8QRTfH_Screen%20Shot%202016-12-20%20at%2017.13.32.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/YzewocAhQbG24E8QRTfH_Screen%20Shot%202016-12-20%20at%2017.13.32.png)

# 3-1 新增一个 Rails 项目 "blog" 到 Github

## 这章请在本地操作

`rails new blog -d postgresql`
`cd blog`
`git init`
`git add .`
`git commit -m "init"`
`rails g scaffold post title:string content:text`
`rake db:create`
`rake db:migrate`

修改 config/routes.rb

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/lfidMHETOJbEkgrfBJxw_Screen%20Shot%202016-12-20%20at%2017.48.21.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/lfidMHETOJbEkgrfBJxw_Screen%20Shot%202016-12-20%20at%2017.48.21.png)

### 移除敏感的 config/database.yml

`cp config/database.yml config/database.yml.example`
`git rm config/database.yml`

修改 `.gitignore`，加入 `config/database.yml`

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/7x6GpkoBQnOTtmuJsdtt_Screen%20Shot%202016-12-20%20at%2017.50.02.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/7x6GpkoBQnOTtmuJsdtt_Screen%20Shot%202016-12-20%20at%2017.50.02.png)

`git add .`
`git add -u`
`git commit -m "move config/database.yml"`

### 移除敏感的 config/secrets.yml

`cp config/secrets.yml config/secrets.yml.example`
`git rm config/secrets.yml`

修改 `.gitignore`，加入 `config/secrets.yml`

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/R4RKwyHjSPCwg8OYEJ60_Screen%20Shot%202016-12-20%20at%2017.51.58.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/R4RKwyHjSPCwg8OYEJ60_Screen%20Shot%202016-12-20%20at%2017.51.58.png)

`git add .`
`git commit -m "move secrets"`

## 上传到 Github

去 github 新建一个项目

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/v4NHdaqlQxi8wdZgJmKL_Screen%20Shot%202016-12-20%20at%2017.53.12.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/v4NHdaqlQxi8wdZgJmKL_Screen%20Shot%202016-12-20%20at%2017.53.12.png)

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/6bYj5sJLTTGH2pDXUSIK_Screen%20Shot%202016-12-20%20at%2017.54.47.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/6bYj5sJLTTGH2pDXUSIK_Screen%20Shot%202016-12-20%20at%2017.54.47.png)

`git remote add origin git@github.com:ＸＸＸＸＸＸＸ/blog.git`
`git push -u origin master`

# 3-2 不用密码就能登进远端机器

复制本机的 pub key

`more ~/.ssh/id_rsa.pub`

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/K3sx9h4RvKGCvegGojri_Screen%20Shot%202016-12-20%20at%2017.56.15.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/K3sx9h4RvKGCvegGojri_Screen%20Shot%202016-12-20%20at%2017.56.15.png)

连到远端机器

ssh [apps@xx.xx.xx.xx](mailto:apps@xx.xx.xx.xx)

`mkdir -p ~/.ssh`

`vim ~/.ssh/authorized_keys`

把刚刚的内容贴进去。

退出之后，下次应该不用密码就可以再进去了。

# 3-3 使用 Capistrano 部署项目 Part 1

### 修改 Gemfile 加入

Gemfile

```
group :development do
  gem "capistrano", "~> 3.4"
  gem "capistrano-rvm"
  gem "capistrano-rails"
end
```

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/lXbffdUPQCOYvGQ5TUs3_Screen%20Shot%202016-12-20%20at%2018.00.15.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/lXbffdUPQCOYvGQ5TUs3_Screen%20Shot%202016-12-20%20at%2018.00.15.png)

然后执行 `cap install`
(出现｀zsh: command not found: cap｀的提示的话，输入｀bundle install｀安装capstrino)

会产生以下档案

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/fuaTfCdSDWf5WctRU44A_Screen%20Shot%202016-12-20%20at%2018.02.17.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/fuaTfCdSDWf5WctRU44A_Screen%20Shot%202016-12-20%20at%2018.02.17.png)

### 修改 config/deploy.rb

```
# config valid only for current version of Capistrano

lock '3.6.1'  # 每个人按自己的默认版本，不一定要是"3.6.1"


set :application, 'blog'
set :repo_url, 'git@github.com:xdite/blog.git'  # 这里填的是每个人自己的repo地址


# Default branch is :master

# ask :branch, `git rev-parse --abbrev-ref HEAD`.chomp


# Default deploy_to directory is /var/www/my_app_name

set :deploy_to, '/home/apps/blog'

# Default value for :format is :airbrussh.

# set :format, :airbrussh


# You can configure the Airbrussh format using :format_options.

# These are the defaults.

# set :format_options, command_output: true, log_file: 'log/capistrano.log', color: :auto, truncate: :auto


# Default value for :pty is false

# set :pty, true


# Default value for :linked_files is []

# append :linked_files, 'config/database.yml', 'config/secrets.yml'

set :linked_files, fetch(:linked_files, []).push('config/database.yml', 'config/secrets.yml')

# Default value for linked_dirs is []

# append :linked_dirs, 'log', 'tmp/pids', 'tmp/cache', 'tmp/sockets', 'public/system'

set :linked_dirs, fetch(:linked_dirs, []).push('log', 'tmp/pids', 'tmp/cache', 'tmp/sockets', 'vendor/bundle')

(略)
```

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/FlGZ2X4fTuyE4LmLffGr_Screenshot%20at%20Mar%2001%2019-35-08.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/FlGZ2X4fTuyE4LmLffGr_Screenshot%20at%20Mar%2001%2019-35-08.png)

### 修改 Capfile

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/87S6xbXITuup2pMcyIv0_Screen%20Shot%202016-12-20%20at%2018.08.31.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/87S6xbXITuup2pMcyIv0_Screen%20Shot%202016-12-20%20at%2018.08.31.png)

### 修改config/deploy/production.rb

如下圖加上這行:

config/deploy/production.rb`server "103.3.62.98(linode的ip)", user: "apps", roles: %w{app db web}, my_property: :my_value`

[![img](http://ohemzrezo.bkt.clouddn.com/2016-12-24-092524.jpg)](http://ohemzrezo.bkt.clouddn.com/2016-12-24-092524.jpg)

`git add .`
`git commit -m 'Add capistrano file'`

`git push`

### 在远端生成档案

执行 `cap production deploy:check`。会去远端机器生一堆档案

# 3-4 让远端机器可以去 github 拉档案

### 连到远端机器

`ssh apps@xx.xx.xxx.xx`

### 生成远端机器的 key

`ssh-keygen`

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/6ixWLAaSDWU6Q8Pd8UFx_Screen%20Shot%202016-12-20%20at%2018.12.03.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/6ixWLAaSDWU6Q8Pd8UFx_Screen%20Shot%202016-12-20%20at%2018.12.03.png)

### 查看 apps 的 pub ket

`more ~/.ssh/id_rsa.pub`

### 然后去刚刚的项目里面贴到 deploy keys

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/cymNkzAQQHWq1ZP3Uwwq_Screen%20Shot%202016-12-20%20at%2018.13.38.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/cymNkzAQQHWq1ZP3Uwwq_Screen%20Shot%202016-12-20%20at%2018.13.38.png)

### 测试

贴完后然后在机器输入

`ssh -T git@github.com`

看到这样的画面就是成功了

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/NTQDEi72RvOgflakvWyt_Screen%20Shot%202016-12-20%20at%2018.15.54.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/NTQDEi72RvOgflakvWyt_Screen%20Shot%202016-12-20%20at%2018.15.54.png)

# 3-5 使用 Capistrano 部署项目 Part 2

### 远端机器（服务器端）

远端机器（服务器端）的blog 下有两个目录。一个是 release 一个是 shared。设定档通常放在 shared

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/gSqFsv7TRiW204Cv2jdZ_Screen%20Shot%202016-12-20%20at%2018.16.48%20(1).png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/gSqFsv7TRiW204Cv2jdZ_Screen%20Shot%202016-12-20%20at%2018.16.48%20(1).png)

新增database.yml `vim shared/config/database.yml`

shared/config/database.yml

```
production:

  adapter: postgresql

  encoding: unicode

  pool: <%= ENV.fetch("RAILS_MAX_THREADS") { 5 } %>

  database: blog_production

  username: postgres

  password: postgres
```

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/LbfaYecWSgi52Gk74FbL_Screen%20Shot%202016-12-20%20at%2018.18.52.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/LbfaYecWSgi52Gk74FbL_Screen%20Shot%202016-12-20%20at%2018.18.52.png)

新增secrets.yml

在**本机**上执行`rake secret` 产生钥匙

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/Hntg3fY1SmWmuZpQAffU_Screen%20Shot%202016-12-20%20at%2018.19.41.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/Hntg3fY1SmWmuZpQAffU_Screen%20Shot%202016-12-20%20at%2018.19.41.png)

然后贴到 `vim shared/config/secrets.yml`

shared/config/secrets.yml

```
production:

  secret_key_base: 剛剛的那串密鑰
```

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/p0NVtLXIRsC1bxF1alOl_Screen%20Shot%202016-12-20%20at%2018.20.50.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/p0NVtLXIRsC1bxF1alOl_Screen%20Shot%202016-12-20%20at%2018.20.50.png)

### 正式 deploy

- 然后执行 `cap production deploy`
- 第一次会卡在 `bundle install` 比较久，大概一分钟

第一次 deploy 会失败。因为 production db 还没建立

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/mBV12sDR2SefrWxrjMBU_Screen%20Shot%202016-12-20%20at%2018.25.54.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/mBV12sDR2SefrWxrjMBU_Screen%20Shot%202016-12-20%20at%2018.25.54.png)

### 建立 db

让我们到最新的目录

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/7eFglGtbTk671gwhi4x1_Screen%20Shot%202016-12-20%20at%2018.28.19.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/7eFglGtbTk671gwhi4x1_Screen%20Shot%202016-12-20%20at%2018.28.19.png)

执行

`RAILS_ENV="production" bundle exec rake db:create`

再跑一次 `cap production deploy`

这次应该 ok 了

# 3-6 设定 Nginx

### 修改 production 机器上的 nginx config 档

`sudo vi /opt/nginx/conf/nginx.conf`

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/2BzjhK41QQmlrJFXoBXq_Screen%20Shot%202016-12-20%20at%2018.31.49.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/2BzjhK41QQmlrJFXoBXq_Screen%20Shot%202016-12-20%20at%2018.31.49.png)

### 重开 nginx

`sudo /etc/init.d/nginx restart`

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/vEYouAvVRHebk7OpKe0r_Screen%20Shot%202016-12-20%20at%2018.33.00.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/vEYouAvVRHebk7OpKe0r_Screen%20Shot%202016-12-20%20at%2018.33.00.png)

### 编辑本机 /etc/hosts 让不存在的 blog.example.com 可以连

`sudo atom /etc/hosts`

### 连到 [http://blog.example.com](http://blog.example.com/)

(如果连不上时，请关闭VPN再重试)

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/bbEEBWX2QxKm2MSXAP2T_Screen%20Shot%202016-12-20%20at%2018.33.30.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/bbEEBWX2QxKm2MSXAP2T_Screen%20Shot%202016-12-20%20at%2018.33.30.png)





# 3-7 安装 capistrano-passenger

### 修改 Gemfile

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/fB246xWKTRSYgK64voho_Screen%20Shot%202016-12-21%20at%2001.14.25.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/fB246xWKTRSYgK64voho_Screen%20Shot%202016-12-21%20at%2001.14.25.png)

### 修改 Capfile

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/SXCIOgEkSV6dITzOFiSD_Screen%20Shot%202016-12-20%20at%2018.34.17.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/SXCIOgEkSV6dITzOFiSD_Screen%20Shot%202016-12-20%20at%2018.34.17.png)

### 修改 config/deploy.rb

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/kWz3U9EkQIivkSSjF5y5_Screen%20Shot%202016-12-20%20at%2018.34.56.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/kWz3U9EkQIivkSSjF5y5_Screen%20Shot%202016-12-20%20at%2018.34.56.png)

在本机先后执行`bundle install` 和 `cap production deploy`

### 成功画面

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/KWN8mmh9Sje9ckNrE0lM_Screen%20Shot%202016-12-20%20at%2018.37.27.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/KWN8mmh9Sje9ckNrE0lM_Screen%20Shot%202016-12-20%20at%2018.37.27.png)

到此大功告成！

### 本节作业

##### [实际演练](https://fullstack.xinshengdaxue.com/assignments/16)：[部署 Rails101](https://fullstack.xinshengdaxue.com/tasks/116)

已有 22 个第一期同学提交了这个作业 [**看看同学怎么做](https://fullstack.xinshengdaxue.com/tasks/116/other_answers?order=recent)

[**提交作业](https://fullstack.xinshengdaxue.com/tasks/116)

依照教程将
1.[第三课 Rails101](https://fullstack.xinshengdaxue.com/courses/3) 部署到自己的服务器上。
2.在部署成功的网站上操作：开新讨论区、新增留言等功能。并将操作录制成gif动图并上传到这里。
