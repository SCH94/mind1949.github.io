---
layout: post
title: "Linux部署运维"
date: 2017-10-30
tags:
    Rails
    教材
---
| Part 1: 云服务                              |      |
| ---------------------------------------- | ---- |
| [**  1. 什么是云服务](https://fullstack.xinshengdaxue.com/posts/1555) |      |
| [**  2. 租用云服务器(Linode)](https://fullstack.xinshengdaxue.com/posts/1556) |      |
| [**  3. 租用云服务器(阿里云)](https://fullstack.xinshengdaxue.com/posts/1557) |      |

| Part 2: Linux 指令入门                       |      |
| ---------------------------------------- | ---- |
| [**  4. 认识命令行 CLI 介面](https://fullstack.xinshengdaxue.com/posts/1558) |      |
| [**  5. Linux 档案操作](https://fullstack.xinshengdaxue.com/posts/1559) |      |
| [**  6. Linux 权限管理](https://fullstack.xinshengdaxue.com/posts/1560) |      |

| Part 3: 网站服务器安装                          |      |
| ---------------------------------------- | ---- |
| [**  7. 更新和安装 Linux 套件](https://fullstack.xinshengdaxue.com/posts/1561) |      |
| [**  8. 安装 Ruby](https://fullstack.xinshengdaxue.com/posts/1562) |      |
| [**  9. 安装数据库服务器](https://fullstack.xinshengdaxue.com/posts/1563) |      |
| [**  10. 安装 Nginx + Passenger 网站服务器](https://fullstack.xinshengdaxue.com/posts/1564) |      |

| Part 4: 自动化部署 Rails                      |                                          |
| ---------------------------------------- | ---------------------------------------- |
| [**  11. 新增 deploy 用户](https://fullstack.xinshengdaxue.com/posts/1565) |                                          |
| [**  12. 安装 Capistrano](https://fullstack.xinshengdaxue.com/posts/1566) |                                          |
| [**  13. 完成 Nginx 设定](https://fullstack.xinshengdaxue.com/posts/1567) | 共1个作业 \|[** 未完成](https://fullstack.xinshengdaxue.com/posts/1567#task) |

| Part 5: Linux 基本运维                       |      |
| ---------------------------------------- | ---- |
| [**  14. 运维常用指令](https://fullstack.xinshengdaxue.com/posts/1568) |      |
| [**  15. 整理 Log 档案](https://fullstack.xinshengdaxue.com/posts/1569) |      |
| [**  16. 异步处理](https://fullstack.xinshengdaxue.com/posts/1570) |      |
| [**  17. 安全防护](https://fullstack.xinshengdaxue.com/posts/1571) |      |
| [**  18. 服务器数据备份](https://fullstack.xinshengdaxue.com/posts/1572) |      |

| Part 6: 第三方服务                            |      |
| ---------------------------------------- | ---- |
| [**  19. E-mail 服务](https://fullstack.xinshengdaxue.com/posts/1574) |      |
| [**  20. 档案存储服务](https://fullstack.xinshengdaxue.com/posts/1573) |      |
| [**  21. 服务器监控服务](https://fullstack.xinshengdaxue.com/posts/1575) |      |

| Part 7: 购买域名、HTTPS、HTTP/2                |      |
| ---------------------------------------- | ---- |
| [**  22. 域名购买和设定](https://fullstack.xinshengdaxue.com/posts/1577) |      |
| [**  23. 安装 HTTPS 凭证和 HTTP/2](https://fullstack.xinshengdaxue.com/posts/1578) |      |

# 1. 什么是云服务

云服务是将电脑运算所需要的硬件和软件资源，透过因特网远程使用，而不需要自备电脑或机房。白话的说，就是去租用别人的电脑。

传统 IT 要建立网站服务器，需要自行购买电脑硬件、购买网络设备、租用机房实体空间等等，在开站前就必须投资大笔的硬件成本。近年来的云服务就像水电等公共基础设施，用多少算多少，你不需要自己盖电厂或净水场。

总而言之，云服务的好处有：

- 抽象化的资源：你不需要担心底层的硬件设备，包括运算资源(CPU)、储存资源(硬盘)、网络资源(频宽)等等都可以租用
- 随租随有：随时可以租、随时可以退租
- 扩充性：根据需求，随时可以租更多来对付更大的用户流量
- 用多少算多少：用了多少资源，就算多少钱

这年头的新创网络公司，几乎都会选择使用云服务来架设网站服务器，快速方便又经济实惠。

### 云服务类型和厂商

云服务可以分成 IaaS、PaaS 和 SaaS 类型，分别为：

- IaaS：基础设施服务，Infrastructure-as-a-Service
- PaaS：平台服务，Platform-as-a-Service
- SaaS：软件服务，Software-as-a-Service

> 另一篇参考文章 [IaaS，PaaS，SaaS 的区别](http://www.ruanyifeng.com/blog/2017/07/iaas-paas-saas.html)

以下分别介绍这几种类型。

### IaaS

IaaS 类型(Infrastructure as a Service)的云服务，你可以租到一台有最高权限的虚拟机，可以随你的意愿安装任何软件。

这里说明一下什么是[虚拟机(Virtual Machine)](https://zh.wikipedia.org/zh-cn/%E8%99%9A%E6%8B%9F%E6%9C%BA%E5%99%A8)：一台电脑上会有一个操作系统，这叫做 Host OS (主人)，但是上面可以透过 VM 软件再安装不同的操作系统，这叫做 Guest OS (客人)，每个 Guest OS 都是独立互相隔离的。

在 Mac 上我们可以透过 [VirualBox](https://www.virtualbox.org/)、[VMware Fusion](https://www.vmware.com/) 或 [Parallels Desktop](https://www.parallels.com/) 等软件，在 Mac 上再安装 Windows 或 Linux 操作系统。

在云服务中其实也有用了 VM 技术来分租给用户，实际上那一台服务器可能是 8 CPU 核心 16GB 内存，但是分租给八个用户，每个人分配到 1 核心 CPU 和 2GB 内存。透过 VM 技术，不同用户的操作系统是完全独立的，你不会感觉到别的用户跟你共享同一台电脑。有些售价非常便宜云服务商，为什么售价可以这么便宜，就是它把一台服务器分租给过多的用户，并且没有保障你有固定的 CPU 资源可以使用。

让我们看看知名的 IaaS 服务商：

#### 国外云服务商

- [Amazon Web Service](http://aws.amazon.com/ec2/) 亚马逊是目前全世界最大的云服务商，也是云服务的领导厂商，在各大洲都布有机房。
- [Microsoft Azure](http://azure.microsoft.com/zh-tw/services/virtual-machines/) 微软的云服务，亚洲的机房在香港和新加坡
- [Google Cloud Compute Engine](https://cloud.google.com/compute/) 谷歌的云服务，亚洲的机房在台湾、东京、新加坡
- [Linode](https://www.linode.com/) 亚洲的机房在东京和新加坡
- [DigitalOcean](https://www.digitalocean.com/) 新加坡机房
- [Vultr](https://www.vultr.com/) 东京机房

其中 Linode、DigitalOcean 等传统上叫做 VPS(Vitual Private Server) 厂商，只提供虚拟机产品，通常价格比较便宜，计价方式也很简单，一个月只需要美金五块、十块起跳，它套装就包括很够力 CPU 效能、流量频宽、硬盘空间等，挑东京机房离中国也近，所以成为小网站或个人装机的高C/P值首选。

Amazon、Microsoft 和 Google 这种属于云计算平台，以丰富的云端生态系见长，除了虚拟机之外，它还有提供数据库、档案储存和 NoSQL 数据库等等各式各样的代管服务(不用你自己安装，它已经装好并帮你维护)，但同时设定和计价模式也复杂的多，适合专业的网络服务。这些厂商也有提供教育训练跟证照，在稍有规模的公司里面，是由专人(叫做系统管理员、System Administrator、DevOps)或运维部门负责操作的。

#### 国内云服务商

- [阿里云](https://www.alibabacloud.com/zh)
- [腾讯云](https://www.qcloud.com/?lang=zh)
- [青云](https://www.qingcloud.com/)
- [UCloud](https://www.ucloud.cn/)
- [Amazon 中国](https://www.amazonaws.cn/?nc1=h_ls)
- [美团云](https://www.mtyun.com/)

注意到亚马逊中国的用户帐号，和国外 Amazon 的帐号是分开的。为了符合中国法规，在境内营业的公司，服务器都必须设在国内。

### PaaS

PaaS 类型的云服务则是提供固定的程序执行环境，支援特定的编程语言和框架，只要将程式上传到平台上就可以执行。其中支援 Ruby 的厂商有：

- [Heroku](https://www.heroku.com/)
- [IBM Bluemix](https://www.ibm.com/cloud-computing/bluemix)
- [redhat Openshift](https://www.openshift.com/)

之前的教程中，我们将写好的 Rails 网站部署到 Heroku 上，而 Heroku 的服务其实是两个服务的总和：IaaS 云服务器和 Rails 的环境。

为了吸引客户，这些 PaaS 通常会有免费方案可以试用。不过一但需要更多运算资源时，这些 PaaS 的价格比起 IaaS 就贵的多，而且大多只有在美国有机房。因此如果有能力自己运维 Linux 服务器的话，比较少公司会选择用 PaaS 平台。

### SaaS

SaaS (Software as a Service) 类型的云服务只能执行特定软件，例如：

- [金数据](https://jinshuju.net/) 人人可用的在线表单工具
- [Tower](https://hk.tower.im/) 你的网上办公室
- [strikingly](https://www.strikingly.com/) Landing Page
- [Github](https://github.com/)
- ....非常多，只要是线上用租的软件都算

SaaS 软件算是近年来的软件趋势，早年的软件都是一套一套卖断的，现在则逐渐流行用月租或年租的 SaaS 方式。例如早些年微软的 Office 软件就是卖断的软件，一套一套卖，现在因为网络发达，加上 Google 推出免费的 Office 线上软件做竞争，所以微软也开始推出 SaaS 模式的 Office 365。

# 2. 租用云服务器(Linode)

接下来我们要来实际租一台 IaaS 类型的云服务器，然后在上面运行我们的 Rails 项目：

- 有国际信用卡(VISA/MASTER)的学员，建议使用 Linode 服务器(日本东京机房)
- 没有国际信用卡，有国内银行卡的学员，建议用国内的阿里云

### Linux 操作系统

云服务器的操作系统几乎都是使用 Linux 操作系统，Linux 是一套开源且免费的操作系统。当我们提 Linux 时，通常是讲 Linux Kernel (内核)。给一般用户安装的又分为不同的发行版本(Linux distribution)，例如 Ubuntu、Linux Mint、Debian、CentOS、Redhat 等等由不同厂商或社区维护。不同发行版会预装不同的软件，也有桌面版和服务器版本之分 (服务器版本就不需要 GUI 视窗介面)。

这里推荐初学者使用最多人使用的 [Ubuntu Server](https://www.ubuntu.com/server) 版，比较不会碰到安装问题，就算碰到也较容易搜寻到解答。依照 Ubuntu 的命名惯例，建议挑`.04`是 LTS (Long Term Support) 版本。目前最近的 LTS 版本是 16.04。

### 租用 Linode 服务器

以下是在 Linode 租服务器的流程：

(使用阿里云的学员请跳到下一章)

### Step 0. 注册 Linode

前往 [https://www.linode.com](https://www.linode.com/?r=037302ca3f330ec5ca6e910cd1977560d6ff0f3b) 注册，然后进入 Linode Manager 后台。

### Step 1. 选择机器

用最小的 1G 内存就够了，地点选离我们最近的 Tokyo 2 机房。

> 内存会影响网站可以服务多少用户，如果用户多就需要比较多的内存。

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/3sfevBWjTu6GKwbRWOJr_1.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/3sfevBWjTu6GKwbRWOJr_1.png)

### Step 2. 安装操作系统

选择 Ubuntu 16.04 并设定 root 密码

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/R1oJuhPMQfSWSxaJbTU2_2.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/R1oJuhPMQfSWSxaJbTU2_2.png)

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/jOXaM9fRQ7GHaiQB4ABw_3.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/jOXaM9fRQ7GHaiQB4ABw_3.png)

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/YE3guezeTIoTMzY6HqHy_4.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/YE3guezeTIoTMzY6HqHy_4.png)

> root 密码请务必有足够的复杂度，如果太好猜被人破解，你的服务器就会被人入侵拿去做坏事喔，例如去挖比特币或是网络攻击的跳板。

### Step 3. 开机

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/scJZTXqhSEq3HUXgKQgY_5.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/scJZTXqhSEq3HUXgKQgY_5.png)

确保真的有开好机

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/BlV39gXrRsiU64ZvEqqH_6.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/BlV39gXrRsiU64ZvEqqH_6.png)

### Step 4. 登入服务器

把 IP 位址记下来，用 SSH 就可以远端登入服务器：

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/kNioqcNrTqmBeBUPJWRs_7.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/kNioqcNrTqmBeBUPJWRs_7.png)

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/DU99d68RQSCI3qJ40euw_8.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/DU99d68RQSCI3qJ40euw_8.png)

输入 exit 可以离开服务器。

### 如何移除服务器？

如果练习完毕，或是觉得做坏了想要重来。别担心，云服务器就是另一台电脑，随时可以砍掉重练。

如果你要砍掉的话，先关机：

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/jCWyWiLSFSm0huhrFKCV_10.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/jCWyWiLSFSm0huhrFKCV_10.png)

然后点移除(Remove)

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/rqs8GA2VRZmqssg6wliQ_9.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/rqs8GA2VRZmqssg6wliQ_9.png)

> 注意：所有的云服务器如果你只是点关机、中止或停止的按钮，该服务器还是会继续算钱的。你要点移除、删除或释放的按钮，在主控台上看不到那一台机器后，才不会继续算钱。常常有学员忘记移除掉没有使用的服务器，就会继续被扣钱喔。

# 3. 租用云服务器(阿里云)

接下来示范如何租用阿里云：

### Step 0. 注册阿里云

前往 <https://www.aliyun.com/>，大陆用户请确认选择的是中国站：

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/zRR5vLaGT1yNi0OGUr0y_11.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/zRR5vLaGT1yNi0OGUr0y_11.png)

注册后需要实名认证，才可以继续购买服务器。

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/oEvSvWFHRci7ZjTGX3yR_12.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/oEvSvWFHRci7ZjTGX3yR_12.png)

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/5CuIHqf1TJWxRbWfyuQU_13.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/5CuIHqf1TJWxRbWfyuQU_13.png)

充值 100 元：

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/iTTuiCtRHKFL0u1Iwy8A_20.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/iTTuiCtRHKFL0u1Iwy8A_20.png)

### Step 1. 选择机器

在菜单栏找到云服务器 ECS 服务：

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/5FKBOiaTQI6fEVnlM9rv_14.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/5FKBOiaTQI6fEVnlM9rv_14.png)

云服务器 ECS > 实例，单击创建实例

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/MjHuFKgTgOt9Y7QJaROy_15.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/MjHuFKgTgOt9Y7QJaROy_15.png)

配置很多，让我们稍加说明：

#### 计费方式和地域

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/SeI3pNkCTaOOPmG2kUaN_16.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/SeI3pNkCTaOOPmG2kUaN_16.png)

计费分成包年包月和按量付费，前者长期来说会比较便宜，不过如果只是短时间做练习，可以选后者。

不同地点会影响连线速度，你可以挑离给最近的。不同地域可以用的服务器等级也不一样，这里建议用比较新的华北三。

#### 网络安全组

阿里云内建了防火墙功能，你需要打开对内连线 Port 22 (SSH 登入用)、Port 80 (HTTP)、Port 443 (HTTPS)。这里请选默认安全组：

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/huMupyuiRrSNUlD2WfKW_21.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/huMupyuiRrSNUlD2WfKW_21.png)

#### 挑选实例

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/AFRU6wgTfmOousoPwRSQ_17.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/AFRU6wgTfmOousoPwRSQ_17.png)

可以选最便宜的 1G 内存就够了。

> 内存会影响网站可以服务多少用户，如果用户多就需要比较多的内存。

#### 镜像

挑选操作系统，请选 Ubuntu 16.04

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/QXhJNeQ5mUdBCkriklQM_18.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/QXhJNeQ5mUdBCkriklQM_18.png)

#### 安全设置

请设置 root 密码

> root 密码请务必有足够的复杂度，如果太好猜被人破解，你的服务器就会被人入侵拿去做坏事喔，例如去挖比特币或是网络攻击的跳板。

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/oQNdcZxJRNSHwom6RsmU_19.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/oQNdcZxJRNSHwom6RsmU_19.png)

### Step 3. 开机

开通后，前往控制台实例，等待启动后，找到分配给你的 IP 位置：

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/1vFKhowoQNWkFJCT7ePF_22-0.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/1vFKhowoQNWkFJCT7ePF_22-0.png)

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/fuj1M9FARQeJXwwUpVsH_22.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/fuj1M9FARQeJXwwUpVsH_22.png)

### Step 4. 登入服务器

SSH 登入主机

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/OMsWdsqCT1GFYDW5I2tv_23.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/OMsWdsqCT1GFYDW5I2tv_23.png)

### 如何移除服务器？

如果练习完毕，或是觉得做坏了想要重来。别担心，云服务器就是另一台电脑，随时可以砍掉重练。

首先先停止服务器

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/rgxLWjW8RMKFe3C219fz_34.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/rgxLWjW8RMKFe3C219fz_34.png)

然后点释放设置

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/VpQE5c6JSCuLhOGMwrOs_35.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/VpQE5c6JSCuLhOGMwrOs_35.png)

确定主控台没有这个服务器了

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/ujPBHBioRPqoyA7PcEX5_36.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/ujPBHBioRPqoyA7PcEX5_36.png)

> 注意：所有的云服务器如果你只是点关机、中止或停止的按钮，该服务器还是会继续算钱的。你要点移除、删除或释放的按钮，在主控台上看不到那一台机器后，才不会继续算钱。常常有学员忘记移除掉没有使用的服务器，就会继续被扣钱喔。

# 4. 认识命令行 CLI 介面

Command Line Interface (CLI) 就是指用文字输入的方式来操作电脑，相对于 Graphical user interface (GUI) 图形用户界面来说，CLI 可说是开发者们的好朋友，因为很多操作用 CLI 的方式比起 GUI 可以更有效率的执行，在服务器上更是只有提供 CLI 可以使用，服务器不需要 GUI 来耗费额外的运算资源，服务器不需要接上萤幕，只有需要运维的时候我们会透过网络远端登入进去操作。

不同操作系统有不同的 CLI 指令，由于 Mac 和 Linux 都是 [UNIX-like](https://zh.wikipedia.org/wiki/%E7%B1%BBUnix%E7%B3%BB%E7%BB%9F) 操作系统，所以操作系统的架构和 CLI 指令十分相像，因此可以跑在 Linux 上的开源软件(特别是 Web 后端用到的软件，例如各种数据库、网站服务器、Ruby/Python/PHP 编程语言语言等等) 也都支援 Mac，反而 Windows 支援比较差，CLI 指令也完全不同。这也是为什么 Web 开发者爱用 Mac 的原因，因为接近 Linux 服务器的环境。

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/x8wAyzRRRmlOWGa2xAfQ_unix.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/x8wAyzRRRmlOWGa2xAfQ_unix.png)

> 微软在 2014 年换 CEO 后才意识到这个问题，在 Windows 10 上推出了 [Linux Subsystem 和 Bash on Ubuntu on Windows](https://msdn.microsoft.com/en-us/commandline/wsl/about) 来试图力挽狂澜...

### 名词释疑: Terminal, Console 和 Shell

Terminal 是指 CLI 输入输出的介面程序，例如 mac 内建的 Terminal，或是另外装的 [iTerm2](https://www.iterm2.com/)。使用 Terminal 时会需要设定要用哪一种 Shell。

Shell 是指和电脑沟通的指令，这有分很多种，Unix 上常见使用 Bash Shell，Mac 也是默认用 Bash，但也有人推荐改用 Zsh 更为花俏。Windows 则是用 PowerShell。Shell 可以只当作是 Shell command 用，但也可以当作 Shell script 使用，就像编程语言一样。

Console 指某特定的指令语言环境，例如 mysql console (输入 SQL 指令)、irb console (输入 Ruby 程序)、rails console (输入 rails 程序)

### Terminal 视窗操作技巧

- `Control+c` 取消目前指令
- `Control+z` 中断目前指令
- `Control+a` 跳到指令最前面
- `Control+e` 跳到指令最后面
- `Control+l` 清除画面 (或用 clear 指令)

### 一些简单的 CLI 指令

> 这些指令 Mac 和 Linux 大部分都是通用的

- `date` 会显示系统时间
- `uname -a` 显示系统版本
- `uptime` 查电脑开机多久了
- `which` 查询执行档的确切位置
- `history` 查询刚刚执行过的指令

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/LHIgk8I3StqzRTNxHC9K_40.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/LHIgk8I3StqzRTNxHC9K_40.png)

- `man` 可以查指令的文件，按 `q` 可以离开

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/E0pK1BCNTeqGYXnjpnAt_41.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/E0pK1BCNTeqGYXnjpnAt_41.png)

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/XBsQIG3GTdCfmjO78GUm_42.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/XBsQIG3GTdCfmjO78GUm_42.png)

### 认识 PATH 环境变量

刚刚执行 `which date` 和 `which uptime` 时，告诉我们这两个执行档真正的位置放在 `/bin/date` 和 `/usr/bin/uptime`。

为什么 Linux 知道要去哪些目录去找执行档在哪里呢? 为什么不需要执行 `/bin/date`，只需要执行 `date` 就够了?

在 Linux 中有个特别的环境变量叫做 `PATH`，你可以用 `echo` 指令来输出：

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/oCQ13dAQ3aCocbruAeyQ_56.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/oCQ13dAQ3aCocbruAeyQ_56.png)

PATH 这个环境变量定义了要去哪些目录去找执行档。

> 在 Ruby 程序中，`ENV` 这个常数就是操作系统的环境变量，用 `ENV["PATH"]` 可以读到

用 `export` 指令可以设定环境变量。

### 其他 CLI 参考资料

先加入书籤，之后有空看。

- [快乐的 Linux 命令行](http://billie66.github.io/TLCL/)
- [Unix/Linux 命令参考](https://i.linuxtoy.org/files/pdf/fwunixref.pdf)
- [Ten Steps to Linux Survival 电子书](http://www.oreilly.com/programming/free/ten-steps-to-linux-survival.csp)
- [Command Line Crash Course](https://learnpythonthehardway.org/book/appendixa.html)

# 5. Linux 档案操作

Linux 的文件系统和 Mac 很像，以下介绍相关的指令：

- `pwd` 显示目前所在的工作目录
- `cd` 可以切换目前的工作目录

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/kgdzr9zHQyaHIOo85Bs5_43.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/kgdzr9zHQyaHIOo85Bs5_43.png)

在 Linux 中有哪些目录呢？大概说明一下：

- `/` 是根目录
- `/home` 用户目录，每个用户会有自己的家目录。（在 Mac 上是 `/Users`)
- `/etc` 放各种软件的配置文件，例如 mysql, nginx
- `/var` 放 log 日志
- `/usr` 应用程序的安装目录 user program
- `/tmp` 暂存目录，操作系统会定期清除，重开机也会清除
- `~` 这个符号是家目录的意思，如果目前登入的用户是 `root`，那个 `cd ~` 会前往 `/root`。如果目前是用 ihower 帐号登入，`cd ~` 就会前往 `/home/ihower/`

### 一些档案管理的指令

- `ls -la` 显示所有档案，包含 `.` 开头的隐藏档案

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/LKVvkhAiSr6qmJYmnQ0Q_44.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/LKVvkhAiSr6qmJYmnQ0Q_44.png)

这会显示档案和目录的权限(下一章会说明)、档案大小、最后修改时间。

- `mkdir` 新增目录
- `touch` 创建一个空文件
- `cp` 复制档案
- `mv` 移动档案或目录(也可以更名)
- `ln -s` 建立捷径别名

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/6oUoLyWTDOcf5qFhGq7J_45.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/6oUoLyWTDOcf5qFhGq7J_45.png)

在截图中，我先建立一个空目录是 `test`，然后创建一个文件 README.txt，接着复制和移动。最后用 `ln -s` 建立一个捷径别名(可以看到 abc 指向 todo.txt)

- `rm` 删除档案
- `rm -r` 删除整个目录和以下的档案

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/h0FfVvu8RFSXoUOrc6yL_46.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/h0FfVvu8RFSXoUOrc6yL_46.png)

截图中用 `rm` 指令删除了 abc 和 README.txt。`rm` 不能删除目录，而 `rmdir` 指令只能删除空目录，要用 `rm -r` 指令才可以整个目录含以下的档案都删除掉。

### 如何编辑和浏览文件

在 CLI 中没有像 Atom 的 GUI 编辑器，操作系统内建的是 nano 或 vi，让我们练习一下：

输入 `nano abc.txt`

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/IW3OBwEaR1C04sp3e58F_47.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/IW3OBwEaR1C04sp3e58F_47.png)

按 control + X 再按 Y 再按 Enter 就可以存盘离开。

请务必熟悉一下如何编辑文件，因为我们会时常需要在服务器上直接编辑各种设定档。

vi 和 vim 是另一套更为 geek 的文档编辑器，功能强大但比较难上手使用，有兴趣的学员可以自行 google 如何使用。

### 如何传档案？

SSH 通信协议除了可以让我们登入远端的服务器，也可以作为档案传输使用，又叫做 SFTP。CLI 的指令是 `scp`。

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/QikL8gWCTWCjDrPuboav_48.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/QikL8gWCTWCjDrPuboav_48.png)

截图中，第一个指令将本机的 test.txt 传到服务器上 root 帐号的 `~/` 目录。

第二个指令则是将服务器上的 `~/text.txt` 传回本机。

> 在 Mac 上可以用 FTP 软件例如 [Cyberduck](https://cyberduck.io/)，通讯协议选 SFTP 就可以连线传档。

### 如何打包压缩档案

压缩和打包是可以分开的：`gzip` 只能压缩一个档案、`tar` 可以打包整个目录顺便压缩。

- `gzip` 压缩档案
- `gzip -d` 解压缩档案
- `tar zcvf xxx.tar.gz xxx` 将 xxx 目录打包并压缩成 `xxx.tar.gz` 档案
- `tar zxcf xxx.tar.gz`。将 `xxx.tar.gz` 解压缩

如果你要和服务器传输很多档案，建议先压缩打包成一个档案再传，速度会快很多。

# 6. Linux 权限管理

### 开自己的帐号

刚刚登入服务器用的 `root` 帐号拥有最大的权限，通常我们会另开一个帐号作为平常登入管理之用：

> 有了自己的管理帐号后，稍后的 Linux 安全性章节会说明如何让 root 无法远端登入，不然每台服务器默认都有 root 帐号，要破解密码的话只要去猜 root 密码即可。

执行 `adduser ihower`

> 请把 `ihower` 换成你自己的用户 ID

设定密码后，一直按 Enter 即可。

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/1lToMCRBRgeLXWmrVDAu_49.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/1lToMCRBRgeLXWmrVDAu_49.png)

输入 `exit` 离开服务器，重新 SSH 登入看看：

`ssh ihower@47.92.136.237`

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/ZGtPnlGTGKV9nUBsY3zo_51.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/ZGtPnlGTGKV9nUBsY3zo_51.png)

执行 `pwd` 发现家目录是 `/home/ihower`

如果试图去编辑 `/root/abc.txt`，或是 `cd /root` 的话，会出现 `Permission denied` 没有权限的错误，因为这个目录需要 root 权限。那怎么办呢?

`su` 指令可以切换身份，例如切换成 root 帐号：

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/WYwK6d36T3uftnEfG7dg_52.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/WYwK6d36T3uftnEfG7dg_52.png)

输入 root 密码，就可以变身成 root。

切过去后，如果再输入 `exit` 则会返回上一层的 ihower 身份。

> `su -` 的 `-` 的意思是可以把 ihower 的环境变量带过去

### sudo 权限

很多时候我们只想执行一个指令需要 root 权限，如果每次都要用 `su` 切换身份输入 root 密码太麻烦了。Linux 上有一种机制是 sudo 权限，可以暂时提升权限。

新开的帐号没有 sudo 权限，首先需要将 ihower 加到 sudo 清单：

新增 `/etc/sudoers.d/ihower` 这个档案，内容是

```
ihower  ALL=(ALL:ALL) ALL
```

> 或是执行 `gpasswd -a ihower sudo` 也可以让 ihower 新增 sudo 权限

存盘离开。让我们实验看看编辑 root 的 `/root/abc.txt`，刚刚如果直接编辑是没有权限的。现在请在需要 root 权限的指令前加上 `sudo`

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/bVEdFETASTWMM4GYDKpk_53.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/bVEdFETASTWMM4GYDKpk_53.png)

注意到 sudo 后要再次输入自己密码，不是 root 的密码。

### 档案和目录权限

Linux 对于每个档案和目录，依据不同用户有着严格的权限控制：可否读、可否写、可否执行。

执行 `ls -la` 显示一下当前目前目录的所有档案：

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/JFvfJ9orTy2sYKLXEwXP_50.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/JFvfJ9orTy2sYKLXEwXP_50.png)

第二栏的 root 表示这个档案属于 root 用户，也就是档案 owner 拥有者。

第三栏的 root 表示这个档案属于 root 群组(group)。默认每个用户会属于跟自己同名的群组。

而第一栏的字段共十位，第一位表示是文件还是目录，`d` 是目录、`-`是文件。

剩下9位，每三位一组，第一组是档案 owner 拥有者的权限、第二组是群组(group)群限、第三组是其他用户。

每组分别是三位来表示，分别是 `rwx`，`r` 表示读、`w`表示写入、`x`表示可以执行，`-` 表示没有权限。

截图中 abc.txt 是 `-rw-r--r--` 表示这是一个档案、档案拥有者是 `rw-` 可以读写、无法执行、群组和其他人是 `r--` 表示可以读不能写入。

#### 如何变更档案权限？

`chown` 指令可以变更档案拥有者和群组，例如 `chown ihower:ihower abc.txt` 可以将档案 abc.txt 的拥有者设定为 `ihower`，群组设定为 `ihower`。如果要修改整个目录包含以下档案，则可以用 `chown -R`

`chmod` 指令可以变更档案的权限，例如 `chmod 644 abc.txt` 就会设定成 `rw-r--r--`。这需要了解一下什么是 Octal Permissions 表示方式：

- `r 是 4`
- `w 是 2`
- `x 是 1`

你要的权限就是把数字加起来，例如 `rw-` 就是 4+2 是 6。`r--` 就是 4。于是 `rw-r--r--` 就是 644 了。

如果理解的话，之后碰到档案存取权限问题时，就知道如何处理了。

### 免密码登入

远端登入除了输入密码之外，SSH 还可以用非对称加密(Public Key Encryption)的方式来做登入。

在非对称加密算法中，会有两把钥匙(key)，一把叫做公钥(public key)、一把叫做密钥(private key)。

- 透过公钥加密的密文，只有密钥能够解开
- 透过密钥加密的密文，只有公钥能够解开

于是我们就可以用这个机制来做登入：首先我们把自己的公钥先放在服务器上，那么之后登入时，服务器会送一个乱数字符串给用户，用户用密钥加密后返回服务器，如果服务器可以用公钥解回来，就表示认证成功。

以下是设定的步骤，：

`mkdir ~/.ssh`

`touch ~/.ssh/authorized_keys`

回到本机电脑把公钥印出来，执行 `cat ~/.ssh/id_rsa.pub` 就会印在画面上。

回到远端服务器继续：

`nano ~/.ssh/authorized_keys` 把公钥贴上去

`chmod 700 ~/.ssh`

`chmod 644 ~/.ssh/authorized_keys`

这样就好了，你可以试试看再次登入就不用打密码了，太棒了！

以下是操作的截图：

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/kGQ1kdltQMiH7Eq2IERl_54.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/kGQ1kdltQMiH7Eq2IERl_54.png)

这是本机 cat 公钥的截图：

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/UaRCmvmNR0CSMz0PP9rz_55.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/UaRCmvmNR0CSMz0PP9rz_55.png)

#### 本机没有 id_rsa.pub ？

因为 Github 也是用一样的认证机制，所以之前操作 git 时你应该已经产生过这个 SSH key，并且在 Github 后台贴上你自己的公钥，所以在 `git push` 时不需要打密码。

如果本机真的没有 `~/.ssh/id_rsa.pub` 公钥的话，需要先产生你自己的公钥私钥，请执行 `ssh-keygen -t rsa` 就会产生公钥 `~/.ssh/id_rsa.pub` 以及密钥 `~/.ssh/id_rsa` 这两个档案。请一直按 Enter，不需要设定 passphrse 密码(不然你每次用key都要输入一次密码很麻烦)。

公钥可以公开给别人没关系，密钥就千万要保管好喔。

# 7. 更新和安装 Linux 套件

`apt-get`是 Ubuntu 内建的套件管理工具，类似于 Mac 上的 homebrew。拿到一台服务器，首先就是先更新系统套件的清单，然后进行升级。

> 以下需要 root 权限的指令一律都加上 sudo，如果你是 root 身份其实不需要 sudo，但没关系都可以作用。

执行 `sudo apt-get update`

执行 `sudo apt-get upgrade -f`

看到 Do you want to continue? [Y/n] 继续按 Enter 即可

然后设定系统时区：

执行 `sudo dpkg-reconfigure tzdata`

进入选单选 Asia 然后选 Shanghai 就是中国时区 (UTF+8)

接着我们安装新的套件们，这些是 Ruby on Rails 所需要的东西。请输入以下指令(这是一行)：

执行 `sudo apt-get install -y build-essential git-core bison openssl libreadline6-dev curl zlib1g zlib1g-dev libssl-dev libyaml-dev libsqlite3-0 libsqlite3-dev sqlite3 autoconf libc6-dev libpcre3-dev libcurl4-nss-dev libxml2-dev libxslt-dev imagemagick nodejs libffi-dev`

看到 Do you want to continue? [Y/n] 继续按 Enter 即可

### 设定 apt-get 只使用 ipv4

使用 Linode 的学员，因为 ipv6 线路不稳，如果 apt-get update 卡在 0% [Connecting to security.ubuntu.com (2001:67c:1360:8001::17)] 的话，请编辑 `/etc/sysctl.conf`

加入这三行

```
net.ipv6.conf.all.disable_ipv6 = 1
net.ipv6.conf.default.disable_ipv6 = 1
net.ipv6.conf.lo.disable_ipv6 = 1
```

然后执行 `sudo sysctl -p` 后，再次执行 `sudo apt-get update

# 8. 安装 Ruby

我们使用 [Brighbox](https://www.brightbox.com/docs/ruby/ubuntu/) 已经编译好的 Ruby 套件，输入以下指令，会把 Brighbox 提供的套件加进清单，然后安装：

执行 `sudo apt-get install software-properties-common`

执行 `sudo apt-add-repository ppa:brightbox/ruby-ng`

执行 `sudo apt-get update`

执行 `sudo apt-get install ruby2.4 ruby2.4-dev`

安装好之后，输入 `ruby -v`

应该就会看到 `ruby 2.4.1p111 (2017-03-22 revision 58053) [x86_64-linux-gnu]` 就是成功了。

接着安装 [Bundler](http://bundler.io/) gem，等会安装 Rails 时会需要这个 Ruby 套件：

执行 `sudo gem install bundler --no-ri --no-rdoc`

> `--no-ri --no-rdoc` 参数的意思是不需要安装文档，可以节省安装时间

如果服务器在中国境内的话，可以改用 `sudo gem install bundler --no-ri --no-rdoc --source https://gems.ruby-china.org` 会比较快。

# 9. 安装数据库服务器

以下提供 MySQL 和 PostgreSQL 的安装方式，请择一安装即可：

> 本机电脑可以用 brew 安装 MySQL 和 PostgreSQL，对于正式营运上线的项目，本机电脑最好也更换成和服务器一样的数据库，让本机环境与服务器环境尽量一样。

### MySQL

[MySQL](https://www.mysql.com/) 是一个非常受欢迎的关联式数据库，可以说是大多数网络公司的首选。以下是安装*MySQL*的指令，过程中会提示你设定数据库的*root*密码(请记下来，等会设定 Rails 会用到)。

执行 `sudo apt-get install mysql-common mysql-client libmysqlclient-dev mysql-server`

过程中请配置一个数据库的 root 密码 (请记下来，等会设定 rails 的 database.yml 会用到)

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/gnhGRefTPSeWPbSyBenQ_25.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/gnhGRefTPSeWPbSyBenQ_25.png)

接着我们进入 mysql console 建立新的数据库：

执行 `mysql -u root -p` 进入 mysql console 后，输入：

`CREATE DATABASE rails_recipes CHARACTER SET utf8mb4;`

这会建立一个叫做 `rails_recipes` 的数据库(注意，数据库名称不要包括横线`-`)，等会你的*Rails*就用这个数据库。执行完，输入 exit 离开 mysql console。

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/jYra2DFcTlC2rG5pt7kP_26.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/jYra2DFcTlC2rG5pt7kP_26.png)

> 请把 `rails_recipes` 换成你自己项目的名称

### PostgreSQL

MySQL 是网络公司的最爱，分布式扩充和商业支持的生态系非常丰富。PostgreSQL 则是对进阶的 SQL 语法支援比较多，以及支援更多的储存格式，例如 [PostGIS](http://postgis.net/)。

你也可以选择安装*PostgreSQL*：

执行 `sudo apt-get install postgresql libpq-dev postgresql-contrib`

修改帐号 postgres 的密码

执行 `sudo -u postgres psql`，然后打 `\password` 后，就可以设置数据库的密码(请记下来，等会设定 rails 的 database.yml 会用到)。

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/EzcJx7tJRZ2vrTTMKJCJ_27.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/EzcJx7tJRZ2vrTTMKJCJ_27.png)

执行 `sudo -u postgres createdb rails_recipes` 建立一个叫做 rails_recipes 的数据库

# 10. 安装 Nginx + Passenger 网站服务器

在本机开发的时候，我们使用 [puma](https://github.com/puma/puma) 这一套由 Ruby 写的网站服务器，无论是静态档案(图片/CSS/JS)或是会进到 Rails 处理的动态网页，一律都是由 puma 来处理。

在正式 production 环境中，我们会用更高效能的网站服务器来处理，其中 [Nginx](http://nginx.org/) 是目前最流行的网站服务器(用C语言开发的)，可以非常高效能地提供静态档案，效能是纯 Ruby 网站服务器的数十倍以上。因此像图档/CSS/JS等等静态资源，都会由 Nginx 处理。至于 Rails 动态网页的部分，我们会安装 [Passenger](https://www.phusionpassenger.com/) 这个 Nginx 的扩充模组来执行 Ruby 程序：Nginx 会把非静态档案的 HTTP Request 转交给 Passenger 来处理。

以下安装程序参考自 [Installing Passenger + Nginx](https://www.phusionpassenger.com/library/install/nginx/install/oss/) 的步骤：

```
sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys 561F9B9CAC40B2F7

sudo apt-get install -y apt-transport-https ca-certificates

sudo sh -c 'echo deb https://oss-binaries.phusionpassenger.com/apt/passenger xenial main > /etc/apt/sources.list.d/passenger.list'

sudo apt-get update

sudo apt-get install -y nginx-extras passenger
```

打开你的浏览器，输入服务器的 IP 位置，应该就可以看到默认的 Nginx 静态网页了：`Welcome to nginx on Ubuntu!`

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/nCVya8SwQ67naFiG7IA9_28.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/nCVya8SwQ67naFiG7IA9_28.png)

# 11. 新增 deploy 用户

将下来我们想要找地方放我们 Rails 项目代码。因为 root 和 ihower 帐号权限很大，习惯上我们会在服务器上另开一个专门的帐号来放*Rails*代码。这里我们另开一个 deploy 帐号来使用：

在远端执行 `sudo adduser --disabled-password deploy` 新增帐号

> `--disabled-password deploy` 参数会让`deploy`无法用密码登入，因为我们打算用 SSH Key 来登入更安全。

### 设定用 SSH Key 登入 deploy 帐号

在远端执行 `sudo su deploy` 切换到 deploy 身份：

执行 `mkdir ~/.ssh`

执行 `touch ~/.ssh/authorized_keys`

回到本机电脑把公钥印出来，执行 `cat ~/.ssh/id_rsa.pub` 就会印在画面上。

回到远端服务器继续：

`nano ~/.ssh/authorized_keys` 把公钥贴上去

`chmod 700 ~/.ssh`

`chmod 644 ~/.ssh/authorized_keys`

这样就好了，本机可以直接 `ssh deploy@<主机IP位置>` 无须输入密码。

# 12. 安装 Capistrano

[Capistrano](http://capistranorb.com/) 是 Rails 社区中最常使用的布署工具，以下是安装和使用步骤。

以下使用百宝箱教程的项目来进行示范：

### 修改 Gemfile 加入 capistrano

首先在本机的 Rails 项目修改 `Gemfile`：

Gemfile

```
+  gem 'mysql2'  # mysql2 和 pg 择一安装即可
+  gem 'pg'

   group :development, :test do
+    gem 'capistrano-rails'
+    gem 'capistrano-passenger'

     gem 'rspec-rails'
     gem 'byebug', platform: :mri
   end
```

数据库用 MySQL 的话，加上 `gem "mysql2"`，数据库用 PG 的话，则用 `gem "pg"`。

执行 `bundle` 安装

### 本机设定 capistrano

执行 `cap install`，这会新增一些配置档案。

编辑 `Capfile`：

Capfile

```
   require "capistrano/scm/git"
   install_plugin Capistrano::SCM::Git

+  require 'capistrano/rails'
+  require 'capistrano/passenger'
```

修改 `config/deploy.rb`

```
+  sh "ssh-add"

   # config valid only for current version of Capistrano
   lock "3.8.1"

-  set :application, "my_app_name"
+  set :application, "rails_recipes"   # 请用你自己的项目名称

-  set :repo_url, "git@example.com:me/my_repo.git"
+  set :repo_url, "git@github.com:growthschool/rails-recipes.git"    # 请用你自己项目的git位置

   # Default branch is :master
   # ask :branch, `git rev-parse --abbrev-ref HEAD`.chomp

   # Default deploy_to directory is /var/www/my_app_name
   # set :deploy_to, "/var/www/my_app_name"
+  set :deploy_to, "/home/deploy/rails-recipes"     # 这样服务器上代码的目录位置，放在 deploy 帐号下。请用你自己的项目名称。

   # Default value for :format is :airbrussh.
   # set :format, :airbrussh

   # You can configure the Airbrussh format using :format_options.
   # These are the defaults.
   # set :format_options, command_output: true, log_file: "log/capistrano.log", color: :auto, truncate: :auto

   # Default value for :pty is false
   # set :pty, true

   # Default value for :linked_files is []
-  # append :linked_files, "config/database.yml", "config/secrets.yml"
+  append :linked_files, "config/database.yml", "config/secrets.yml"

   # Default value for linked_dirs is []
-  # append :linked_dirs, "log", "tmp/pids", "tmp/cache", "tmp/sockets", "public/system"
+  append :linked_dirs, "log", "tmp/pids", "tmp/cache", "tmp/sockets", "public/system"

+  set :passenger_restart_with_touch, true

   # Default value for default_env is {}
   # set :default_env, { path: "/opt/ruby/bin:$PATH" }

   # Default value for keep_releases is 5
-  # set :keep_releases, 5
+  set :keep_releases, 5
```

修改 `config/deploy/production.rb`，设定要用哪一个 branch 放在服务器上，以及服务器的 IP 位置：

```
+   set :branch, "master"
-   # server "example.com", user: "deploy", roles: %w{app db web}, my_property: :my_value
+     server "47.92.82.116", user: "deploy", roles: %w{app db web}, my_property: :my_value
```

在本机执行 `cap production deploy:check`，这会自动登入远端服务器建立一些 Capistrano 需要的架构目录(稍后会解说)。

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/YYvMTAgQDGGhVZgYWL4E_30.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/YYvMTAgQDGGhVZgYWL4E_30.png)

你会看到一个 ERROR 说服务器上缺少一些档案，让我们进远端服务器上新增这些档案：

### 远端设定 database.yml 和 secrets.yml

请用 deploy 身份登入 `ssh deploy@47.92.82.116`，或是切换到 deploy 身份 `sudo su deploy`：

在远端新增 `/home/deploy/rails-recipes/shared/config/database.yml` 这个档案，内容是：

如果是 MySQL 数据库：

```
production:
  adapter: mysql2
  encoding: utf8mb4
  database: rails_recipes
  host: localhost
  username: root
  password: xxxxxxxxxx
```

如果是 PG 数据库：

```
production:
  adapter: postgresql
  pool: 25
  database: rails_recipes
  host: localhost
  username: postgres
  password: xxxxxxxxxx
```



> password 记得换成你的数据库密码

在本机执行 `rake secret`，这会产生一段乱数的key，等会要用。

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/YbGf15mdQKqqCK3pwEdo_31.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/YbGf15mdQKqqCK3pwEdo_31.png)

在远端新增 `/home/deploy/rails-reipes/shared/config/secrets.yml` 这个档案，内容是：

```
production:
  secret_key_base: 把刚刚的乱数key贴上来
```

本机再次执行 `cap production deploy:check`

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/2vZSNQYhS7mtOBXkOzgi_32.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/2vZSNQYhS7mtOBXkOzgi_32.png)

### 执行部署

本机执行部署 `cap production deploy`，这个指令会登入远端服务器，把 Github 上的代码抓下来，然后自动执行 bundle 安装套件、跑数据库 migration 和编译 assets 编译等等步骤：

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/rXVdFE8JSESNwoU2o7qP_29.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/rXVdFE8JSESNwoU2o7qP_29.png)

第一次会比较久，需耗时数十分钟，取决于网络环境与 CPU 速度：

如果您用国内的服务器，跑 `01 bundle install --path /home/deploy/rails-recipes/shared/bundle`这一步可能因为网络问题而失败。建议你可以修改 `Gemfile` 第一行，改成 `source 'https://gems.ruby-china.org'` 使用国内的 rubygems.org 镜像服务器，因为服务器本身是没有翻墙的。改完请执行 `bundle`，然后 git commit 和 git push 上去。然后再重新执行 `cap production deploy`。

如果服务器 CPU 等级比较差，跑 `01 bundle exec rake assets:precompile` 这一步会比较久，如果出现 `Errno::ECONNRESET: Connection reset by peer - recvfrom(2)` 请重试几次 `cap production deploy`。

完成后，capistrano 的设定就告一个段落了，可以 commit 了。

之后有修改代码，只要 git push 到 Github 上，然后再次执行 `cap production deploy`，这样服务器上就会拉下最新的代码。

### Capistrano 目录结构解说

在远端的部署目录 `/home/deploy/rails-receips` 下，Capistrano 建立了一些目录：

- releases
  - 20170728140659
  - 20170728141211
  - 20170728174109
  - 20170729041358
  - .....
- current
- shared
  - bundle
  - config
  - log
  - public/system
  - public/assets
  - tmp

每次执行 `cap production deploy` 时，capistrano 都会在 releases 都会建一个新的目录，然后从 git repo 把最新的代码抓下来，执行 bundle 安装套件、跑数据库 migration、编译 assets 编译等等步骤，都完成之后，会更新 current 目录(这是一个 `ln -s` 的捷径)指向最新的 releases/xxxx 目录，最后 `touch tmp/restart.txt` 告诉 Passenger 重启 Rails。

这样做的好处是在部署过程中，服务器仍然可以稳稳地用本来的版本，不会受到新版本的影响，直到部署过程都完成之后，才会修改 current 目录重启 Rails。

也由于每次部署都会建立新的 `releases/xxx` 目录，因此不同版本之间需要共享的档案和目录，就会放在 `shared` 下，例如 `bundle` 目录是放安装的 Ruby 套件、`public/system` 是默认用户上传档案放的位置、`public/assets` 是静态档案编译后放的位置。

在 `config/deploy.rb` 的设定中，`linked_files` 和 `linked_dirs` 就是在配置部署过程中，需要将这些 `shared` 下的档案和目录，连结到新的 `releases` 目录里面去。

# 13. 完成 Nginx 设定

在远端用 root 权限编辑 `/etc/nginx/nginx.conf` 这个档案：

```
  # 让 Nginx 可以读到环境变量 PATH，Rails 需要这一行才能调用到 nodejs 来编译静态档案
+ env PATH;

    user www-data;
    worker_processes auto;
    pid /run/nginx.pid;

    events {
      worker_connections 768;
      # multi_accept on;
    }

  http {

    # 关闭 Passenger 和 Nginx 在 HTTP Response Header 的版本资讯，减少资讯洩漏
+   passenger_show_version_in_header off;
+   server_tokens       off;

    # 设定档案上传可以到100mb，默认只有1Mb超小气的，上传一张图片就爆了
+   client_max_body_size 100m;

    gzip on;
    gzip_disable "msie6";

       # 最佳化 gzip 压缩
+   gzip_comp_level    5;
+   gzip_min_length    256;
+   gzip_proxied       any;
+   gzip_vary          on;
+   gzip_types application/atom+xml application/javascript application/x-javascript application/json application/rss+xml application/vnd.ms-fontobject application/x-font-ttf application/x-web-app-manifest+json application/xhtml+xml application/xml font/opentype image/svg+xml image/x-icon text/css text/xml text/plain text/javascript text/x-component;

    # 打开 passenger 模组
-   # include /etc/nginx/passenger.conf;
+   include /etc/nginx/passenger.conf;

    # 下略
```

在远端用 root 权限新增 `/etc/nginx/sites-enabled/rails-recipes.conf` 这个档案(档名可以自订无所谓)

```
server {
  listen 80;
  server_name 47.92.82.116;   # 用你自己的服务器 IP 位置

  root /home/deploy/rails-recipes/current/public;  # 用你自己的项目名称位置

  passenger_enabled on;

  passenger_min_instances 1;

  location ~ ^/assets/ {
    expires 1y;
    add_header Cache-Control public;
    add_header ETag "";
    break;
   }
}
```

以上设定包括设定 Assets 静态档案成为永不过期(Rails的Assets Pipeline会加上版本号，所以不需要担心)、设定 Passenger 至少开一个进程(Process)。其中 `server_name` 应该填网域名称。不过如果目前没有的话，只好先填 IP 位置。

如果有多个 domain 连到同一个网站，可以用空白区隔，例如：

`server_name abc.ihower.tw xyz.ihower.tw ihower.tw;`

这样三个网址都会连到同一个 Rails 了。如果之后想在同一个服务器装多个网站，那么就需要有不同的网域名称，每个网站有自己的 `/etc/nginx/sites-enabled/xxxxx.conf` 设定档案，这样 Nginx 才能区别用户是要打开那一个网站。

最后执行 `sudo service nginx restart` 才会套用新的 Nginx 设定。

> 如果 Nginx 设定档格式不对，例如结尾少了分号 `;`，那么 `sudo service nginx restart` 会失败，Nginx 服务器就死掉了。这时候请回头修好设定档，然后执行 `sudo service nginx start` 就会启动 Nginx 了。如果无法启动请检查 `/etc/nginx/nginx.conf` 和 `/etc/nginx/sites-enabled/rails-recipes.conf`。

打开浏览器连过去，应该可以看到百宝箱的首页了，大功告成。

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/WVbvE7w5SQqlpBxkR7pI_33.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/WVbvE7w5SQqlpBxkR7pI_33.png)

### 本节作业

##### [作业](https://fullstack.xinshengdaxue.com/assignments/80)：[作业一](https://fullstack.xinshengdaxue.com/tasks/382)

已有 6 个第一期同学提交了这个作业 [**看看同学怎么做](https://fullstack.xinshengdaxue.com/tasks/382/other_answers?order=recent)

[**提交作业](https://fullstack.xinshengdaxue.com/tasks/382)

请租一台服务器，将你的项目部署上去(或是用你百宝箱的练习项目)。请截图最后成功的浏览器画面贴上来，并分享你用哪一家的云服务商、服务器所在地域和服务器等级(CPU、内存)。

# 14. 运维常用指令

要部署新代码上服务器，记得需要先 `git push` 到 Github 上，再执行 `cap production deploy`

### 如何检视 log

- 用 deploy 身分登入
- `cd ~/rails-recipes/current` 进到 Rails 目录下
- `tail -n 500 log/production.log` 这样会显示最后500行
- `tail -f log/production.log` 这样会一直挂着显示

除了 Rails 的错误讯息，错误也有可能发生在 Nginx，这时候可以找 nginx log，位置在 `/var/log/nginx/error.log`，需要用 root 身分才能看。

### 如何查看系统状态

- `free -h` 显示内存用量
- `df -h` 显示硬盘剩馀空间
- `sudo passenger-status` 显示 Passenger 状态，主要观察 Passenger 开了多少个 Rails 进程(默认最多开6个，如果机器的内存够多，你可以调整 Nginx 设定 [passenger_max_pool_size](https://www.phusionpassenger.com/library/config/nginx/reference/) 增加更多进程来服务更多流量)
- `sudo passenger-memory-stats` 显示 Passenger 内存状态，主要观察每个 Rails 进程耗费多少内存

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/KnyCl2eQb2KhqMJGUmEg_60.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/KnyCl2eQb2KhqMJGUmEg_60.png)

- `top` 系统状态，主要可以看 CPU 负载情形，以及哪些进程在忙

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/cuhYV4XoS6iTvUngDSBK_59.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/cuhYV4XoS6iTvUngDSBK_59.png)

> load average 三个数字分别代表最近1分钟、5分钟和15分钟的系统平均负载。这个数字表示有多少进程在等待被 CPU 执行，数字越小越好，表示系统不忙。如果你的服务器只有单颗 CPU，那这个数字应该要小于1。两颗CPU则要小于2。

- `ps ax` 显示目前所有进程(process)，用 `sudo kill -9 <PID>` 可以强制删除该程序，这是最后手段。

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/K136APksTFa7rWy9TZqU_61.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/K136APksTFa7rWy9TZqU_61.png)

网站如果无法正常运作，第一个检查网络是否正常，是不是可以 SSH 连线进去。如果第一关就卡住了，可能整台机器已经蒙了，这时候需要回到云服务的后台，强制关机重开。

如果可以连线进去，就先检查目前系统负载情形，是不是内存不够了? 或是硬盘满了? 如果是 Passenger 进程太多人塞住了，可以先尝试重开 Nginx 让网站恢复运作。如果还是没多久还是一样，就需要进一步看 log 检查是哪一个环节不正常。

### 网站服务器重启指令

默认安装完以及开机后，就会启动 Nginx。如果有修改 Nginx 设定档，需要重开 Nginx。

启动 `sudo service nginx start`
停止 `sudo service nginx stop`
重开 `sudo service nginx restart`

如果只是要重开 Rails，可以不重开 Nginx。在你的 Rails 目录下(例如 `/home/deploy/rails-recipes/current` 这个目录)执行 `touch tmp/restart.txt` 即可，这样 Passenger 就会知道要重新加载 Rails，而不需要重开 Nginx。

### 在远端如何进 rails console?

- 用 deploy 身分登入，例如 ssh deploy@your_server_ip 或用 root 登入再切换身分 sudo su deploy
- `cd ~/your_project/current`
- 执行 `bundle exec rails c production`

### 如何在远端跑 rake?

例如想在服务器上执行 `rake db:seed`，可以这样做：

- 用 deploy 身分登入，例如 ssh deploy@your_server_ip 或用 root 登入再切换身分 sudo su deploy
- `cd ~/your_project/current`
- 执行 `RAILS_ENV=production bundle exec rake db:seed`

# 15. 整理 Log 档案

Linux 内建有 logrotate 工具，可以定期清空和压缩 Log 档案。如果你不整理的话，Rails 的 production.log 会不断成长到撑爆硬盘空间。

用 root 权限新增 `/etc/logrotate.d/rails` 档案，内容如下：

```
/home/deploy/rails-recipes/shared/log/*.log {
  monthly
  dateext
  missingok
  rotate 65535
  notifempty
  copytruncate
}
```



> `rails-recipes` 请换成你的项目名称

- 其中 daily 表示每天整理，也可以改成 weekly 或 monthly
- dateext 表示档案补上 rotate 的日期
- missingok 表示如果找不到 log 档也没关系
- rotate 表示保留65535份，建议如果硬盘空间够的话，就不要砍log档了，以供未来备查
- compress 表示压缩起来，默认用 gzip
- delaycompress 表示延后压缩直到下一次 rotate
- notifempty 表示如果 log 档是空的，就不 rotate
- copytruncate 先复制 log 档的内容后，在清空的作法，因为有些程式一定 log 在本来的档名，例如 rails。另一种方法是 create。

设定好之后，可以等明天，或是执行 `sudo /usr/sbin/logrotate -f /etc/logrotate.conf` 测试看看，会发现 rails 项目下的 log/production.log 被依日期拆开了。

# 16. 异步处理

### Sidekiq 安装

在百宝箱第四集有安装 Redis 和 Sidekiq 来做异步处理，要在 Ubuntu 上安装 Redis 很简单：

请执行 `sudo apt-get install redis-server` 就装好了。

Capistrano 也需要调整，我们可以使用 <https://github.com/seuros/capistrano-sidekiq> 这个 gem

首先编辑 `Gemfile` 加上 `gem 'capistrano-sidekiq'`：

Gemfile`  group :development, :test do    gem 'capistrano-rails'    gem 'capistrano-passenger'+   gem 'capistrano-sidekiq'`

执行 `bundle`

编辑 `Capfile` 加上 `require 'capistrano/sidekiq'`

Capfile`   require 'capistrano/rails'   require 'capistrano/passenger'+  require 'capistrano/sidekiq'`

执行 `cap production deploy`，远端服务器上就会跑起来 Sidekiq 了。

你可以在远端服务器上用 `ps ax | grep 'sidekiq'` 指令检查看看是否有 Sidekiq 进程：

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/OVxMKZ4TzWwyLpz2nQ8A_62.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/OVxMKZ4TzWwyLpz2nQ8A_62.png)

> `grep` 指令可以过滤文字，`|` 可以将前面的输出导到后面指令的输入。

之后每次 `cap production deploy` 进行布署的时候，这也会重开 sidekiq。

### Cron 固定排程

Sidekiq 是不定时由用户的某个行为来触发，但有时候我们需要的是某个固定时间由系统排程来执行，例如每天凌晨四点进行备份、每天凌晨寄信提醒缴费、每周一凌晨一点产生报表等等。这种情况可以透过 Linux 内建的例行性排程机制 Cron。

> [例行性工作排程(crontab)](http://linux.vbird.org/linux_basic/0430cron.php)

首先，你先将需要执行的任务写成一个 rake 指令，这样就可以在主机上用 crontab 指令去执行这个 rake。

不过由于 crontab 的格式不是非常友善，我们可以透过 [whenever](https://github.com/javan/whenever) 这个 Gem 来编辑，用 Ruby 的语法撰写 crontab 语法，并且他支援搭配 capistrano 在布署时自动更新 crontab，非常方便。

#### 安装方式

修改 Gemfile 加上

Gemfile

`+ gem 'whenever', :require => false`

接着执行 `bundle` 和 `wheneverize .` 就会产生设定档。

#### 排程设定

修改 `config/schedule.rb` 加入你要的排程工作，例如：

```
env :PATH, ENV['PATH']
set :output, 'log/cron.log'

# 每个小时调用一次 rake check_event_registrations
every 1.hour do
  rake "check_event_registrations"
end

# 每天调用一次 rake fetch_user_feeds
every 1.day do
  rake "fetch_user_feeds"
end
```

#### Capistrano 设定

在 `Capfile` 加入 `require "whenever/capistrano"`

这样就会在 `cap production deploy` 自动化布署时，自动更新服务器上的 crontab。

# 17. 安全防护

### 调整服务器 SSH 设定

服务器开了自己帐号之后，我们可以不允许 root 远端登入：

用 root 权限编辑 `/etc/ssh/sshd_config`

修改 `PermitRootLogin no` 这样就不允许 root 选端登入。

如果你有设好用公钥登入，也可以修改 `PasswordAuthentication no`，这样就不能用输入密码的方式登入。这样服务器会安全的多，因为骇客就不能猜密码了。只是说如果你不是用自己的电脑想要登入服务器，没有公钥档案的话就没有办法登入了。

最后，执行 `sudo service ssh restart` 就会重启 SSH 套用设定。

### 防火墙

像 Linode 并没有内建防火墙功能，我们可以用 ufw 这个工具来设定 Linux 要开放哪些 Port。

以下是开放 Port 22, 80, 443 的指令：

- `sudo apt-get install ufw`
- `sudo ufw default deny`
- `sudo ufw allow 22`
- `sudo ufw allow 80`
- `sudo ufw allow 443`
- `sudo ufw enable` 启用防火墙
- `sudo ufw status` 显示目前状态

如果发现网站被特定IP攻击，也可以用 ufw 来丢弃特定来源的数据包：

- `sudo ufw insert 1 deny from <要ban掉的IP>`
- `sudo ufw reload`

# 18. 服务器数据备份

一个正式运营中的网站，数据备份是一件非常重要的事情，无论是天灾人祸，不怕一万只怕万一。

服务器上要备份的数据有哪些？

1. 源代码：这个我们都放在 Github 上了，加上 Git 分布式的特性，每个开发者都有一份完成的 repo，因此不需要备份服务器上的源代码。
2. 数据库：这是最重要的，需要汇出。
3. 用户上传的档案：如果你有做档案上传的功能，就会需要备份这些档案。不过如果有用七牛云或 AWS S3 来放档案的话，就不需要担心了。

备份数据需要存放在不同台机器才保险。除了备份程序之外，复原的程序也很重要，需要实际验证。很多公司以为做了备份，但真的发生事情要复原时，才发现备份的档案不能用。

### 手动备份

汇出数据库：

MySQL 的指令是 `mysqldump -u root -p rails_recipes > rails_recipes.sql`

参数 `-u root` 表示用数据库的 root 帐号、`-p` 表示要输入密码、汇出 `rails_recipes` 数据库到 `rails_recipes.sql` 这个档案

PostreSQL 的指令是 `pg_dump -W -U postgres -h localhost rails_recipes > rails_recipes.sql`

接着我们可以 `gzip rails_recipes.sql` 压缩起来，备份到其他电脑即可。

数据库汇入：

MySQL 的指令是 `mysql -u root -p rails_recipes < rails_recipes.sql`

PostgreSQL 的指令是 `psql -W -U postgres -h localhost rails_recipes < rails_recipes.sql`

用户上传的档案：

放在 `/home/deploy/rails-recipes/shared/public/system` 目录下，请打包压缩备份回其他电脑。

### 自动备份

使用 <https://github.com/backup/backup> 这个 Ruby 工具可以帮助我们设定好自动备份，可以参考 <https://gist.github.com/ihower/5a28624f9420fb9a7c49> 这会备份整个 mysql 数据库，打包压缩整个 /srv 目录，上传到指定的 AWS S3 bucket，最后寄送 email 通知完成。

在服务器上执行 `crontab -e` 可以编辑例行性工作排程(crontab)，以下是一个每日凌晨 4:30 自动执行的范例:

```
30 4 * * * /bin/bash -l -c '/usr/local/bin/backup perform -t my_backup -c /home/ihower/Backup/config.rb'
```

# 19. E-mail 服务

这年头要自行架设 E-Mail 服务器很复杂，因为为了防堵垃圾邮件需要很多额外的配置。因此网站上的 E-mail 功能，我们偏好租用第三方的 E-mail 服务，推荐的厂商有：

- 如果目标用户主要在中国，建议用 [SendCloud](http://sendcloud.net/)
- 如果目标用户主要是国外，建议用 [Mailgun](https://www.mailgun.com/)、[SendGrid](https://sendgrid.com/)、[Postmark](https://postmarkapp.com/) 等等

无论是哪一家 E-mail，注册后会拿到 SMTP (邮件通信协议) 服务器的 1.位址 2. 帐号 3. 密码

如果你希望寄信来源要显示你自己的网域，例如来自 `hello@ihower.tw` 的话，首先你需要购买自己的网域(Part 7 会教)，以及进一步的 DNS 配置。

### SendCloud

<http://sendcloud.net/>

将生成的`API_USER`和`API_KEY`信息保存下来。如果忘记 `API_KEY`，可以到 `发送设置` 生成一个新的

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/6IcbgG2Ty2aevQcYmXDg_3bLoUnjtR5qYNPSPjk3r_WX20170209-105306.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/6IcbgG2Ty2aevQcYmXDg_3bLoUnjtR5qYNPSPjk3r_WX20170209-105306.png)

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/9fV4p037SfaE5oD2VfdR_ng2cBeGRGKRr6ftEj3gH_WX20170209-105808.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/9fV4p037SfaE5oD2VfdR_ng2cBeGRGKRr6ftEj3gH_WX20170209-105808.png)

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/4hkObqRATYGks7DsPeSu_vtk2KiN2SJq4YXf9UQar_WX20170209-111805.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/4hkObqRATYGks7DsPeSu_vtk2KiN2SJq4YXf9UQar_WX20170209-111805.png)

### Mailgun

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/IdfKCmPqQbQ6u7qasAgs_63.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/IdfKCmPqQbQ6u7qasAgs_63.png)

### Rails 设定

在本机编辑 `config/environments/production.rb`，加载 email 设定档。

config/environments/production.rb

```
+  config.action_mailer.default_url_options = { :host => '你的网域名称，暂时还没有就填IP地址' }
+  config.action_mailer.delivery_method = :smtp
+  config.action_mailer.smtp_settings = config_for(:email).symbolize_keys
```

在远端服务器上，用 deploy 帐号新增 `/home/deploy/rails-recipes/shared/config/email.yml`

如果用 SendCloud 会长这样：

```
production:
  address: "smtpcloud.sohu.com"
  port: 25
  domain: "XXX.sendcloud.org"
  authentication: "plain"
  user_name: "XXX_test_XXX"
  password: "keyXXXXX"
  enable_starttls_auto: true
```

> 注意，在阿里云、AWS、Google Cloud Platform 等大云服务商，会封锁 25 port 来阻挡垃圾邮件发送。通常 E-mail 服务商会另外提供 2525 或 587 port，例如 [SendCloud 的 SMTP 服务只开放了 25 端口么?](https://sendcloud.sohu.com/doc/faq/)，请依此修改 port 和 SMTP address 位置。

如果用 Mailgun 会长这样：

```
production:
  address: "smtp.mailgun.org"
  port: 587
  domain: "mailgun.org"
  authentication: "plain"
  user_name: "postmaster@sandboxXXXXXX.mailgun.org"
  password: "XXXXX"
  enable_starttls_auto: true
```

最后编辑 `config/deploy.rb`，在部署过程中去连结 `config/email.yml` 设定档。

config/deploy.rb

```
-  append :linked_files, "config/database.yml", "config/secrets.yml"
+  append :linked_files, "config/database.yml", "config/secrets.yml", "config/email.yml"
```

git commit 和 git push 后，进行部署 `cap production deploy`。

可以用忘记密码流程进行测试 E-mail 发送。

# 20. 档案存储服务

使用者上传的档案，在 carrierwave 或 paperclip gem 中默认会把档案放在服务器上的 `shared/public/system` 目录下。这样当然是可以运作。

不过相比于数据库所需要的硬盘空间，用户上传的档案很可能会耗费更多空间。不但造成备份上的难度，也需要时常注意硬盘空间，万一硬盘满了之后，会需要增加硬盘空间甚至移机，麻烦很多。

因此，在正式运营的网站，我们会偏好使用专门的第三方档案储存服务，来放这些用户上传的档案，节省我们后续维运上的麻烦。

比较大的云服务商上都有提供类似的产品，这里我们推荐：

- [七牛云](https://www.qiniu.com/)
- [Amazon S3](https://aws.amazon.com/s3/)

详细的安装用法，在之前的 Rails 实战：购物网站 教程有介绍。至于密码的处理，可以参考上一节处理 email.yml 的手法。

# 21. 服务器监控服务

### 网站 Uptime 监控

以下这些第三方服务，可以每隔几分钟检查你指定的 URL 是否正常回应(不需要额外安装Gem)，如果连不上可以透过 E-mail 通知你。免费的方案就够用了，如果需要短信通知或增加检查频率，则需要付费。

- <https://uptimerobot.com/>
- <https://www.statuscake.com/>
- <https://tools.pingdom.com/>
- [https://www.pagerduty.com](https://www.pagerduty.com/)

### Rails 异常监控

以下这些第三方服务，可以在 Rails 发生异常 (exception) 时，主动通知及纪录下这个错误例外(exception)，好让我可以进行追踪除错。

- [https://rollbar.com](https://rollbar.com/)
- [https://airbrake.io](https://airbrake.io/)
- [https://sentry.io](https://sentry.io/)
- [https://www.honeybadger.io](https://www.honeybadger.io/)

这些服务都有提供 gem 可以安装，按照注册流程应该就可以完成。

### 效能监控

以下这些第三方服务，会纪录监控网站程式的效能，例如网站的回应速度，协助你分析哪些部分需要做最佳化改善：

- <https://www.skylight.io/>
- <https://newrelic.com/>
- <https://appsignal.com/>

这些服务都有提供 gem 可以安装，按照注册流程应该就可以完成。

# 22. 域名购买和设定

接下来我们来实际购买一个域名，有了域名我们才能设定 HTTPS 加密连线。

- 有国际信用卡的，推荐从 [Namechaep](https://www.namecheap.com/) 购买
- 国内可以从 [阿里云(万网)](https://wanwang.aliyun.com/domain/) 购买

以下是示范用 Namecheap 进行购买：

### Namecheap 购买设定步骤

[https://www.namecheap.com](https://www.namecheap.com/)

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/PQOgJg6Sv2fHq9x5hkwO_70.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/PQOgJg6Sv2fHq9x5hkwO_70.png)

> rails-recipes.win 一年才 USD $0.66，便宜!

购买后，需要认证 E-mail

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/JNwymzDSvWcFLSJ959UL_71.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/JNwymzDSvWcFLSJ959UL_71.png)

进入该网域的 Manage 画面

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/mqDcSTqDTW637fHsAbVr_72.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/mqDcSTqDTW637fHsAbVr_72.png)

NAMESERVERS 用 Namecheap 内建提供的即可

> Linode 也有提供 DNS 服务，如果你想在 Linode 设定 DNS 纪录，这里可以用 Custom DNS，填上 Linode 的 DNS 位址，就可以改用 Linode 的 DNS 服务。阿里云跟 AWS 也有自己的 DNS 服务，提供比较多的功能。

进化 Advanced DNS 画面

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/Ifb2ZzLIR4yqe3UFrozs_73.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/Ifb2ZzLIR4yqe3UFrozs_73.png)

删除目前的两个 RECORDS，按 ADD NEW RECORD 新增一个 A Record，让 `www` 指向我们的服务器 IP 地址。

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/xgKBjQ9sQjuWA0aH2TM0_74.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/xgKBjQ9sQjuWA0aH2TM0_74.png)

设定 DNS 需要一些时间才会生效。你可以在用 `nslookup` 或 `dig` 指令查询 DNS 是否已经生效。

> 如果等不及的话，你可以先修改本机电脑的 `/etc/hosts` 自行加上 DNS 对应。只是这个纪录只有你本机有效而已。

### 修改 Nginx 设定

进入远端服务器，用 root 权限修改 `/etc/nginx/sites-enabled/rails-recipes.conf`

把 server_name 改成我们的网域名称：

```
server_name www.rails-recipes.win;
```

重启 `sudo service nginx restart`

浏览 `http://www.rails-recipes.win` 确认完成

### 中国境内 ICP 备案

如果服务器主机和 DNS 服务器在中国境内，必须将网域名称和主机IP进行备案。如果没有备案，云服务商会进行定期检查屏蔽，DNS 解析也可能会被国内的 DNS 查询系统屏蔽：

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/51xJhDmHR2OgnM0IRuIa_99.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/51xJhDmHR2OgnM0IRuIa_99.png)

> 实际测试发现 http 在开站两天后就被阿里云屏蔽、但 https 或 IP 地址连线没问题。

不同备案的省市和不同的网域名称，会有不同申请规定。在哪一家云服务商购买主机，就用那家的备案系统进行申请，例如[阿里云备案](https://beian.aliyun.com/)

如果服务器主机在国外，就不需要也不能备案，但可能被墙封锁。另外也无法申请中国境内的金流服务和 CDN 服务等。

# 23. 安装 HTTPS 凭证和 HTTP/2

> HTTPS 和 HTTP/2 的说明，请前往 "网路概论教程 12. 什么是 HTTPS 和 HTTP/2"

要启用 HTTPS 加密连线和 HTTP/2 的话，需要申请该域名的 SSL 凭证：

1. 需要购买 SSL 凭证：在 [Namechaep](https://www.namecheap.com/)、[阿里云](https://common-buy.aliyun.com/?spm=5176.2020520163.cas.1.2arDtO&commodityCode=cas#/buy) 等各家域名商都可以购买的到。
2. 或是使用 [Let's Encrypt](https://letsencrypt.org/) 的免费凭证。Let's Encrypt 是由许多大公司以及各大非营利团体为了推广 HTTPS 而赞助的一家免费发布 SSL 凭证的机构。不过它的效期只有三个月的效期，到期需要更新。凭证过期的话，浏览器会跳出警告讯息。

申请凭证的流程大致上是：

1. 先自己生成一個私鑰、一個申請用的憑證CSR
2. 將 CSR 傳上去給憑證機構
3. 憑證機構认证你真的拥有这个网域
4. 下載 SSL 憑證
5. 將私鑰和 SSL 憑證安裝到網站服務器上

如果主要用戶不在中國境內、服務器放在國外，建議可以用 [Cloudflare](https://cloudflare.com/) 這個 CDN 服務，這包含免費的 SSL 憑證，可以免去申請安裝的麻煩。它的 [Flexible SSL](https://www.cloudflare.com/ssl/) 模式，可以让终端使用者到 CloudFlare 是加密连线，而你的服务器不需要安装。使用 Cloudflare 需要將 DNS 也給它管理，在註冊的流程中會要求你去修改 Namecheap 改用 Custom DNS。

### Let's Encrypt 凭证申请

[Let's Encrypt](https://letsencrypt.org/) 网页上有安装说明，或是你可以用 [https://gethttpsforfree.com](https://gethttpsforfree.com/) 手动线上申请，请依照指示在远端服务器上操作。

> protip: 过程中 Step 4: Verify Ownership 需要在服务器上启动它的 Web 服务器来做认证，我们必须暂停我们 Ngnx 服务器(执行`sudo service nginx stop`)，然后执行它的 python 程序。认证完之后就中断掉，再把我们的服务器 `sudo service nginx start` 跑起来。

### 安装 SSL 凭证

最后你会获得一个 Signed Certificate 憑證，请存在服务器上 `/etc/nginx/signed.crt`，以及一開始的私鑰 `domain.key` 請放在 `/etc/nginx/domain.key`。

编辑 `/etc/nginx/sites-enabled/rails-recipes.conf`，加上 HTTPS 設定以及啟用 HTTP/2：

```
server {
  listen       443 ssl http2;
  ssl on;
  ssl_certificate       /etc/nginx/signed.crt;  # 这是跟凭证机构申请后，拿回来的凭证 Key
  ssl_certificate_key    /etc/nginx/domain.key; # 这是一开始我们自己产生的 Private Key

  ssl_protocols TLSv1 TLSv1.1 TLSv1.2;

  ssl_prefer_server_ciphers on;
  # by https://mozilla.github.io/server-side-tls/ssl-config-generator/
 ssl_ciphers 'ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA:ECDHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-RSA-AES256-SHA256:DHE-RSA-AES256-SHA:ECDHE-ECDSA-DES-CBC3-SHA:ECDHE-RSA-DES-CBC3-SHA:EDH-RSA-DES-CBC3-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:DES-CBC3-SHA:!DSS';

  server_name www.rails-recipes.win;

  root /home/deploy/rails-recipes/current/public;
  passenger_enabled on;

  passenger_min_instances 1;

  location ~ ^/assets/ {
    expires 1y;
    add_header Cache-Control public;
    add_header ETag "";
    break;
  }
}
```

如果你只打算 HTTPS 安全连线，可以将所有 HTTP 连线重导到 HTTPS：

```
 server {
    listen 80;
    server_name www.rails-recipes.win;
    server_tokens off;
    location / {
      return 301 https://$host$request_uri;
    }
  }
```

大功告成！

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/4jbHgccrRaiCUGEiJd9v_75.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/4jbHgccrRaiCUGEiJd9v_75.png)

> <https://www.ssllabs.com/ssltest/index.html> 可以检测 SSL 是否安装完美。SSL 有很多安全性相关标准。
