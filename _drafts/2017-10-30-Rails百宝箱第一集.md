---
layout: post
title: "Rails百宝箱第一集"
date: 2017-10-30
tags:
    Rails
    教材
---

#Rails百宝箱第一集
| 1. 前言与案例准备 预计学习时间: 10分钟以内                |      |
| ---------------------------------------- | ---- |
| [**  1-1 前言](https://fullstack.xinshengdaxue.com/posts/1088) |      |
| [**  1-2 案例准备](https://fullstack.xinshengdaxue.com/posts/1089) |      |

| 2. 自定义 Model 网址 预计学习时间: 1小时以内            |      |
| ---------------------------------------- | ---- |
| [**  2-1 适用情境](https://fullstack.xinshengdaxue.com/posts/1090) |      |
| [**  2-2 方案一：网址ID+文字](https://fullstack.xinshengdaxue.com/posts/1091) |      |
| [**  2-3 方案二: 乱数 ID](https://fullstack.xinshengdaxue.com/posts/1092) |      |
| [**  2-4 方案三: 用户可以自定义 ID](https://fullstack.xinshengdaxue.com/posts/1093) |      |

| 3. 多语言设置 预计学习时间: 1小时半以内                  |      |
| ---------------------------------------- | ---- |
| [**  3-1 配置中文语系](https://fullstack.xinshengdaxue.com/posts/1094) |      |
| [**  3-2 词汇中内嵌变量](https://fullstack.xinshengdaxue.com/posts/1095) |      |
| [**  3-3 安装 Rails 中文翻译词汇档](https://fullstack.xinshengdaxue.com/posts/1096) |      |
| [**  3-4 安装 Devise 翻译档](https://fullstack.xinshengdaxue.com/posts/1097) |      |
| [**  3-5 Model 字段翻译](https://fullstack.xinshengdaxue.com/posts/1098) |      |
| [**  3-6 如何让使用者可以切换多语系](https://fullstack.xinshengdaxue.com/posts/1099) |      |
| [**  3-7 语系样板](https://fullstack.xinshengdaxue.com/posts/1100) |      |

| 4. 时区设置 预计学习时间: 半小时以内                    |      |
| ---------------------------------------- | ---- |
| [**  4-1 配置北京时区](https://fullstack.xinshengdaxue.com/posts/1101) |      |
| [**  4-2 根据用户配置切换时区](https://fullstack.xinshengdaxue.com/posts/1102) |      |

| 5. 格式化日期时间 预计学习时间: 1小时以内                 |                                          |
| ---------------------------------------- | ---------------------------------------- |
| [**  5-1 strftime 格式化时间](https://fullstack.xinshengdaxue.com/posts/1103) |                                          |
| [**  5-2 Rails 时间 to_s 方法](https://fullstack.xinshengdaxue.com/posts/1104) | 共1个作业 \|[** 未完成](https://fullstack.xinshengdaxue.com/posts/1104#task) |

| 6. 表单单选 UI (固定选项无 Model) 预计学习时间: 1小时以内   |      |
| ---------------------------------------- | ---- |
| [**  6-1 情境准备](https://fullstack.xinshengdaxue.com/posts/1105) |      |
| [**  6-2 显示输出](https://fullstack.xinshengdaxue.com/posts/1106) |      |
| [**  6-3 使用 Select 下拉选单](https://fullstack.xinshengdaxue.com/posts/1107) |      |
| [**  6-4 改用 Radio Button UI](https://fullstack.xinshengdaxue.com/posts/1108) |      |
| [**  6-5 使用 Radio Button 加上 Bootstrap Bu...](https://fullstack.xinshengdaxue.com/posts/1109) |      |

| 7. 表单单选 UI 和 Select2 Plugin 预计学习时间: 1小时以内 |      |
| ---------------------------------------- | ---- |
| [**  7-1 情境和 Model 准备](https://fullstack.xinshengdaxue.com/posts/1110) |      |
| [**  7-2 使用 Select 下拉选单](https://fullstack.xinshengdaxue.com/posts/1111) |      |
| [**  7-3 显示分类并避免 nil 错误](https://fullstack.xinshengdaxue.com/posts/1112) |      |
| [**  7-4 使用 jQuery Select2 Plugin](https://fullstack.xinshengdaxue.com/posts/1113) |      |

| 8. 表单多选 UI 和 Select2 Plugin 预计学习时间: 1小时半以内 |      |
| ---------------------------------------- | ---- |
| [**  8-1 情境准备](https://fullstack.xinshengdaxue.com/posts/1114) |      |
| [**  8-2 建立 Model](https://fullstack.xinshengdaxue.com/posts/1115) |      |
| [**  8-3 用 checkbox 可以多选分组](https://fullstack.xinshengdaxue.com/posts/1116) |      |
| [**  8-4 用 Select multiple 加上 Select2 Pl...](https://fullstack.xinshengdaxue.com/posts/1117) |      |

# 1-1 前言

本课程收集各种常用的 Ruby on Rails 锦囊妙计，第一集的内容包括:

- 自定义Model网址
- 多语言设置
- 时区设置
- 格式化日期时间
- 表单单选 UI (固定选项无 Model)
- 表单单选 UI 和 Select2 Plugin
- 表单多选 UI 和 Select2 Plugin



# 1-2 案例准备

接下来几堂的百宝箱课程，会基于一个活动(Event)报名系统的情境：

- 用户可以在前台看到活动信息
- 管理员可以在后台管理活动资料
- 管理员可以在后台管理用户资料
- 用户可以在前台进行报名
- 管理员可以在后台管理报名资料

为了让大家可以快速开始练习重点，请直接 clone 这个项目：<https://github.com/growthschool/rails-recipes>

请依序执行：

`git clone git@github.com:growthschool/rails-recipes.git`
`cd rails-recipes`
`bin/setup`
`bundle exec rake dev:fake`

在这个项目中，已经装好了 Devise、Bootstrap、RSpec，并且建立好了 User 和 Event models，以及前后台的 events controller。

`rails server`

接着打开浏览器 [http://localhost:3000](http://localhost:3000/)

登入帐号 `admin@example.org`
登入密码 `12345678`

请浏览看看前台活动页面：

![F2BFD77A-F086-499A-BE91-9182A23FB267](/var/folders/2k/q63b1kcj38j4cfrl_fjx6z1c0000gn/T/net.shinyfrog.bear/BearTemp.roLcX1/F2BFD77A-F086-499A-BE91-9182A23FB267.png)

请进入后台操作看看新增、编辑和删除活动资料：

![D49194A8-A28B-41DF-B0DE-FAB046B4276B](/var/folders/2k/q63b1kcj38j4cfrl_fjx6z1c0000gn/T/net.shinyfrog.bear/BearTemp.dGvQ27/D49194A8-A28B-41DF-B0DE-FAB046B4276B.png)



# 2-1 适用情境

在做 model 的 CRUD 时，一个 `resources :events` 这样的路由，它的 show 页面的网址总是这样：

`/events/123`

这样的网址有几个缺点:

1. SEO(Search Engine Optimization、搜寻引擎优化) 不够好。只有数字，而不是有意义的文字。
2. 洩露了数据库中的资料量，聪明的用户可以透过修改网址，就可以猜到数据库有多少笔资料。

让我们依序解决这个问题，这里提供三种层次的解决方案：

- 方案一：网址上除了数字ID，可以再加上文字
- 方案二：不要用数据库的递增数字ID，而是用一个乱数产生的 ID
- 方案三：除了用乱数ID，也可以让用户自定义 ID

# 2-2 方案一：网址ID+文字

#### 方案一：网址上除了数字ID，可以再加上文字

[![img](/var/folders/2k/q63b1kcj38j4cfrl_fjx6z1c0000gn/T/net.shinyfrog.bear/BearTemp.RdH1fA/3DC35F0A-3B1A-4652-8E49-9DD0B34AE3AD.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/PQl2OYQQ2qenoxfYqDZA_1-to-param.png)

修改 `app/models/event.rb`，加上一个 `to_param` 方法：

app/models/event.rb

```
  class Event < ApplicationRecord

    validates_presence_of :name

+   def to_param
+     "#{self.id}-#{self.name}"
+   end

  end
```

这样就好了，出来的网址就会变成 `/events/123-活动名称`。

#### 解说一：

在调用路由方法时，Rails 默认都会用 to_param 方法来转换 ID，例如：

`event_path(@event)` 等同于 `event_path(@event.to_param)`

而这个 `to_param` 方法其实是一个 Rails 默认就有的方法，它本来是这样的：

```
def to_param
  self.id
end
```

这就是为什么你不需要特地写 `event_path(@event.id)`，因为 Rails 默认调用了 `to_param`

#### 解说二：

在 controller 中的 `@event = Event.find(params[:id])` 为什么不需要修改呢?
因为 Rails 在 `find` 的时候，会先调用 `to_i` 转成纯数字的 ID。

而任意字串 `to_i` 之后，只会留下前面的数字，后面非数字的字串都会忽略掉。

于是 `"123-XXXXX".to_i` 就变成 `123` 了，和本来的数字ID是一致的。

# 2-3 方案二: 乱数 ID

#### 方案二：不要用数据库的递增数字ID，而是用一个乱数产生的 ID

[![img](/var/folders/2k/q63b1kcj38j4cfrl_fjx6z1c0000gn/T/net.shinyfrog.bear/BearTemp.KbrAsi/D19ED684-1332-4BFF-B9CF-52C60FFA9B0B.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/s3WwGlg9StXVn6Z5P5hX_1-uuid.png)

如果不要显示数据库的递增整数 ID 的话，我们需要在 events 上新增另一个字段来做识别。

执行 `rails g migration add_friendly_id_to_events`

编辑 `201704XXXXXXXX_add_friendly_id_to_events.rb`

201704XXXXXXXX_add_friendly_id_to_events

```
  class AddFriendlyIdToEvents < ActiveRecord::Migration[5.0]

    def change
+     add_column :events, :friendly_id, :string
+     add_index :events, :friendly_id, :unique => true

+     Event.find_each do |e|
+       e.update( :friendly_id => SecureRandom.uuid )
+     end
    end

  end
```

在终端运行 `rake db:migrate`

记得这个字段需要加上唯一索引。

编辑 `app/controllers/events_controller`，改成用 `friendly_id` 这个字段来找 event：

app/controllers/events_controller.rb

```
  def show
-    @event = Event.find(params[:id])
+    @event = Event.find_by_friendly_id!(params[:id])
   end
```

编辑 `app/controllers/admin/events_controller`

app/controllers/admin/events_controller.rb

```
  def show
-    @event = Event.find(params[:id])
+    @event = Event.find_by_friendly_id!(params[:id])
   end

   def edit
-    @event = Event.find(params[:id])
+    @event = Event.find_by_friendly_id!(params[:id])

   def update
-    @event = Event.find(params[:id])
+    @event = Event.find_by_friendly_id!(params[:id])

   def destroy
-    @event = Event.find(params[:id])
+    @event = Event.find_by_friendly_id!(params[:id])
```

编辑 `app/models/event.rb`，修改 `to_param` 改成用 `friendly_id`，並在新增的时候自动产生乱数的 `friendly_id`。

app/models/event.rb

```
  class Event < ApplicationRecord

    validates_presence_of :name

+   before_validation :generate_friendly_id, :on => :create

    def to_param
-     "#{self.id}-#{self.name}"
+     self.friendly_id
    end

+   protected

+   def generate_friendly_id
+     self.friendly_id ||= SecureRandom.uuid
+   end

end
```

# 2-4 方案三: 用户可以自定义 ID

#### 方案三：不要用数据库的递增数字ID，并且用户可以自定义 ID

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/IinpjOeQXiOYn5MdL0Zk_1-edit2.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/IinpjOeQXiOYn5MdL0Zk_1-edit2.png)

基于方案二，我们只要让管理员可以编辑 friendly_id 字段即可：

编辑 `app/views/admin/events/_form.html.erb`

app/views/admin/events/_form.html.erb

```
+<div class="form-group">
+  <%= f.label :friendly_id %>
+  <%= f.text_field :friendly_id, :required => true, :class => "form-control" %>
+  <p class="help-block">限小写英数字及横线，将作为网址的一部分</p>
+</div>
```

编辑 `app/controllers/admin/events_controller.rb`

app/controllers/admin/events_controller.rb

```
   def event_params
-    params.require(:event).permit(:name, :description)
+    params.require(:event).permit(:name, :description, :friendly_id)
   end
```

这样在后台就可以编辑 `friendly_id` 了。

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/IdNhclcrSoaWp2PY4SiD_1-edit.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/IdNhclcrSoaWp2PY4SiD_1-edit.png)

由于这个字段输入的资料，会出现在网址上，所以最好加上一些资料验证：

编辑 `app/models/event.rb`

app/models/event.rb

```
-  validates_presence_of :name
+  validates_presence_of :name, :friendly_id
+
+  validates_uniqueness_of :friendly_id
+  validates_format_of :friendly_id, :with => /\A[a-z0-9\-]+\z/
```

这里不但要检查必填，还检查了必须唯一，而且格式只限小写英数字及横线。

# 3-1 配置中文语系

Rails 支持多语言化(Internationalization，简称I18n)，默认的语系是英文，请先修改 `config/application.rb` 将默认改为中文：

config/application.rb

```
  class Application < Rails::Application

+   config.i18n.default_locale = "zh-CN"

  end
```

所谓的多国语系的功能，是指网站中的句子和单字，可以根据用户的需求进行切换。实际的作法就是准备翻译词汇档，然后将样板中本来写死的文字，置换成调用 I18n 方法。

例如，请新增 `config/locales/zh-CN.yml` 这个词汇 YAML 档：

```
"zh-CN":
  event_list: 活动列表
  admin:
    event_list: 活动列表管理
```

修改 `config/locales/en.yml`

```
  "en":
+   event_list: Event List
+   admin:
      event_list: Admin Event List
```

> 注意 YAML 格式的缩排必须使用两个空格，Tab 是不允许的。直接复制贴上可能会有问题，请小心检查缩排。

修改 `app/views/events/index.html`

```
-  <h1>Event List</h1>
+  <h1><%= t("event_list") %></h1>
```

修改 `app/views/admin/events/index.html`

```
-  <h1>Admin Event List</h1>
+  <h1><%= t("admin.event_list") %></h1>
```

> 也可以写成 `t("event_list", :scope => "admin")` 结果是一样的

其中 `t` 等同于 `I18n.t`，是个 Helper 方法，会根据语系来做字符串的替换。

重启服务器，浏览看看就会发现这个单字被替换成中文了。

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/DNWlSEeASnOGuVjenZci_3-1.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/DNWlSEeASnOGuVjenZci_3-1.png)

> 新增词汇档案需要重启服务器，修改词汇不需要。

# 3-2 词汇中内嵌变量

有些句子可能会需要内嵌变量，可以使用 `%{variable_name}` 的语法，例如：

config/locales/zh-CN.yml

```
  "zh-CN":
+   hello: "亲～ %{name} 你好："
```

config/locales/en.yml

```
  "en":
-   hello: "Hello world"
+   hello: "Hi %{name},"修改 `app/views/layouts/application.html.erb`
```

app/views/layouts/application.html.erb

```
-  <%= current_user.display_name %>
+ <%= t( "hello", :name => current_user.display_name) %>
```

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/iA5DTesQRqyZfZ75h80t_3-2.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/iA5DTesQRqyZfZ75h80t_3-2.png)

如果我们的网站不需要支援多国语系，你可能会觉得这样做有点辛苦，直接将中文写在样板上就好了。

但这个功能对于团队协作开发网站仍然非常有帮助，因为写程式的时候不一定会先确定文案规格，用 I18n 来处理的话，最后只需要让 PM 统一修改翻译词汇档即可。

# 3-3 安装 Rails 中文翻译词汇档

Rails 本身就有用到 I18n 的功能，可以安装 rails-i18n 这个 gem 有开源社区做好的中文翻译：

编辑 Gemfile，加上

```
gem "rails-i18n"
```

执行 `bundle`

重启服务器。会被翻译的词汇请参考 <https://github.com/svenfuchs/rails-i18n/blob/master/rails/locale/zh-CN.yml>

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/g9htQj2OQtO3N7zyURYI_3-3.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/g9htQj2OQtO3N7zyURYI_3-3.png)

# 3-4 安装 Devise 翻译档

Devise 也有用到 I18n，可以安装 devise-i18n 这个 gem 有开源社区做好的中文翻译：

请编辑 Gemfile，加上

```
gem "devise-i18n"
```

执行 `bundle`

重启服务器。会被翻译的词汇请参考 <https://github.com/tigrish/devise-i18n/blob/master/rails/locales/zh-CN.yml>

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/vQClOiWGQHKTa0DsNzaq_3-4.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/vQClOiWGQHKTa0DsNzaq_3-4.png)

# 3-5 Model 字段翻译

在套用上述的翻译词汇档之后，你可能会注意到 Model 验证错误讯息会变成如 Name不能为空字符，如果需要进一步中文化字段名称，你可以新增 `config/locales/events.yml` 内容如下：

```
  zh-CN:
+    activerecord:
+      attributes:
+        event:
+          name: "活动名称"
+          description: "描述"
```

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/rr2PKKwRRzyGjmkGPk7u_3-5.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/rr2PKKwRRzyGjmkGPk7u_3-5.png)

其实，翻译档档名叫 events.yml、zh-TW.yml、en.yml 什么都无所谓，重要的是 YAML 结构中第一层要对应locale的名称，也就是 `zh-CN`，Rails 会加载 `config/locales` 下所有的YAML词汇档案。

# 3-6 如何让使用者可以切换多语系

刚刚我们准备了中文和英文翻译档案，但是并没有提供切换的机制。

接下来请编辑 `app/controllers/application_controller.rb` 中加入:

app/controllers/application_controller.rb

```
+ before_action :set_locale
+
+ def set_locale
+   if params[:locale] && I18n.available_locales.include?( params[:locale].to_sym )
+     session[:locale] = params[:locale]
+   end
+
+   I18n.locale = session[:locale] || I18n.default_locale
+ end
```

修改前台的 layout `app/views/layouts/application.html.erb`

app/views/layouts/application.html.erb

```
+   <%= link_to "中文版", :controller => controller_name, :action => action_name, :locale => "zh-CN" %>
+   <%= link_to "English", :controller => controller_name, :action => action_name, :locale => "en" %>

    </div>
  </body>
  `
```

浏览前台 `http://localhost:3000` 并点选中文版、English 就会进行切换了。

# 3-7 语系样板

除了上述一个单字一个单字的翻译词汇替换之外，如果样板内大多是属于较为静态的内容，Rails 也提供了不同语系可以有不同样板，你只要将样板命名加上语系附档名即可，例如我们来产生 FAQ 页面：

执行 `rails g controller pages`

编辑 `config/routes.rb`

```
+  get "/faq" => "pages#faq"
```

新增 `app/views/pages/faq.zh-CN.html.erb`

新增 `app/views/pages/faq.en.html.erb`

如此在英文版的时候就会使用 `faq.en.html.erb` 这个样板，中文版时使用 `faq.zh-CN.html.erb` 这个样板。

最后，编辑 `app/views/layouts/application.rb` 放上 FAQ 页面的连结：

app/views/layouts/application.rb

```
   <%= yield %>

+  <%= link_to "FAQ", faq_path %>
```

# 4-1 配置北京时区

在 Rails 中，数据库里面的时间(datetime)字段一定都是储存成 UTC 时间。这样设计的理由是在多国时区的网站中，数据库比较时间大小需要一致的标准。

编辑 `app/views/events/index.html.erb` 加上显示时间：

```
-  <%= link_to event.name, event_path(event) %>
+ <%= link_to event.name, event_path(event) %> <%= event.created_at %>
```

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/m3jE0XN4RmPnM5q7cXjD_4-0.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/m3jE0XN4RmPnM5q7cXjD_4-0.png)

而 Rails 提供的机制是让你从数据库拿资料时，自动帮你转换时区。例如，请设置 Rails 默认为北京 +8 时区：

修改 `config/application.rb`

config/application.rb`config.i18n.default_locale = "zh-CN"+   config.time_zone = "Beijing"  `

重启服务器，就是改成北京时间显示了。Rails 会帮你自动转换时区：从数据库取出来时会加八小时，存回数据库时会减八小时。

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/1Oq7dAnqRtmq1cW7GzuE_4-1.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/1Oq7dAnqRtmq1cW7GzuE_4-1.png)



# 4-2 根据用户配置切换时区

常见的做法是在 Users 上新增一个字段 `time_zone:string`，储存该用户的偏好时区。

执行 `rails g migration add_time_zone_to_users`

编辑 `20XXXXXX083439_add_time_zone_to_users.rb`

db/migrate/20XXXXXX083439_add_time_zone_to_users.rb

```
  class AddTimeZoneToUsers < ActiveRecord::Migration[5.0]
    def change
+     add_column :users, :time_zone, :string
    end
  end执行 `rake db:migrate`
```

编辑 `config/routes.rb`

config/routes.rb

```
+  resource :user
```

> 注意，这里的路由设计使用单数 `resource:user`，跟 `resources :users` 相比，单数的路由少了 `index action`，并且网址上不会有 ID，路由方法也皆为单数不需要参数，例如 `user_path`、`edit_user_path`。会这样设计的原因是对前台用户而言，编辑用户资料就是编辑自己的资料，所以这个单数的用意是指唯一自己，用户也不能修改其他人的资料，因此在controller 里面是写`@user = current_user`，而不是根据`params[:id]` 去捞不同用户。另一个附带的好处是网址列上不会出现ID，即使你没有实作第一章去改 Model 网址，用户也不会知道 User ID。

执行 `rails g controller users`

> 不管单复数 `resource` 或 `resources` 默认的 controller 命名一律是复数型。

编辑 `app/controllers/users_controller.rb`

app/controllers/users_controller.rb

```
class UsersController < ApplicationController

  before_action :authenticate_user!

  def edit
    @user = current_user
  end

  def update
    @user = current_user

    if @user.update(user_params)
      flash[:notice] = "修改成功"
      redirect_to edit_user_path
    else
      render "edit"
    end
  end

  protected

  def user_params
    params.require(:user).permit(:time_zone)
  end

end
```

编辑 `app/views/users/edit.html.erb`

app/views/users/edit.html.erb

```
<h2>Edit User</h2>

<%= form_for @user do |f| %>

  <div class="form-group">
    <%= f.label :time_zone %>
    <%= f.time_zone_select :time_zone %>
  </div>

  <div class="form-group">
    <%= f.submit "Save", :class => "btn btn-primary" %>
  </div>

<% end %>
```

编辑 `app/views/layouts/application.html.erb`

app/views/layouts/application.html.erb

```
   <ul class="dropdown-menu">
     <li><%= link_to('管理员面板', admin_events_path) %></li>
+    <li><%= link_to('修改个人资料', edit_user_path) %></li>
```

浏览 `http://localhost:3000/user/edit` 就可以编辑用户偏好的时区了。

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/1R50uWgQ5epjsXNiyzbT_4-2.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/1R50uWgQ5epjsXNiyzbT_4-2.png)

不过，真正重点是要在 `app/controllers/application_controller.rb` 中加入:

app/controllers/application_controller.rb

```
+  before_action :set_timezone

+  def set_timezone
+    if current_user && current_user.time_zone
+      Time.zone = current_user.time_zone
+    end
+  end
```

这样才会设置 Rails 目前要使用哪个时区。请试着编辑用户为不同时区，然后观察看看 <http://localhost:3000/events> 上面的时间。

# 5-1 strftime 格式化时间

在修改默认时区后，Rails 默认的时间显示格式例如 `2017-04-10 17:53:55 +0800` 包含了时区资讯，通常我们不会显示给用户，那要如何修改时间的显示方式呢？

Ruby 内建了 [strftime](https://ruby-doc.org/core-2.3.4/Time.html#strftime-method) 这个方法来格式化输出，请修改 `app/views/events/index.html.erb`

app/views/events/index.html.erb

```
-  <%= event.created_at %>
+  <%= event.created_at.strftime("%Y/%m/%d %I:%M %p") %>
```

这样就会输出成例如 `2017/04/10 05:53 PM` 了

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/czw8o9IUT4a6crhEdjUZ_5-1.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/czw8o9IUT4a6crhEdjUZ_5-1.png)

这个 `strftime` 方法接受了一个字符串参数是格式。详细这个格式代表什么意义，请参考 [strftime](https://ruby-doc.org/core-2.3.4/Time.html#strftime-method) 文档上的说明，例如 `%m` 就代表月份(会补零)，而 `%M` 代表分钟。

# 5-2 Rails 时间 to_s 方法

在一个 Rails 项目中，会有很多地方会显示时间，我们希望采用一致的方式输出。

除了使用上一节的 strftime 方法，Rails 也可以直接呼叫 to_s 来转换输出格式，例如

```
datetime = Time.now

datetime.to_s(:db)            # => "2007-12-04 00:00:00"
datetime.to_s(:number)        # => "20071204000000"
datetime.to_s(:short)         # => "04 Dec 00:00"
datetime.to_s(:long)          # => "December 04, 2007 00:00"
datetime.to_s(:long_ordinal)  # => "December 4th, 2007 00:00"
datetime.to_s(:rfc822)        # => "Tue, 04 Dec 2007 00:00:00 +0000"
datetime.to_s(:iso8601)       # => "2007-12-04T00:00:00+00:00"
```

另外，也可以自行配置项目常用的格式。例如，请编辑 `config/application.rb`，在最后新增一行：

```
Time::DATE_FORMATS.merge!(:default => '%Y/%m/%d %I:%M %p', :ymd => '%Y/%m/%d')
```

这样就会 1. 修改默认的时间显示格式 2. 注册一个新的格式是 `ymd` 只有日期

重启 rails s 服务器。

修改 `app/views/events/index.html.erb`

app/views/events/index.html.erb

```
-  <%= event.created_at.strftime("%Y/%m/%d %I:%M %p") %>
+  <%= event.created_at.to_s %>
```

就会得到一样的结果 `2017/04/10 05:53 PM` 了。

如果只想显示日期，可以改成 `<%= event.created_at.to_s(:ymd) %>`

#### 本节作业

##### [第一集作业](https://fullstack.xinshengdaxue.com/assignments/50)：[作业一](https://fullstack.xinshengdaxue.com/tasks/311)

已有 31 个第一期同学提交了这个作业 [**看看同学怎么做](https://fullstack.xinshengdaxue.com/tasks/311/other_answers?order=recent)

[**提交作业](https://fullstack.xinshengdaxue.com/tasks/311)

请修改你之前的购物网站 jdstore 项目：

- Product 改成可以自订 Model 网址
- 设置多国语系为 zh-CN，并将商品页面完成支援英文版和中文版
- 设置中国时区 UTC+8
- 统一格式化日期时间

请附上商品页面的英文版截图，并包含网址列。

# 6-1 情境准备

这一章我们要示范如何在表单实作一个单选的 UI，单选的选项是固定的，不需要额外建立 Model 来存选项。例如活动(Event)需要一个状态字段，有多少种「状态」是固定的、有限的。在后台可以编辑，前台可以显示。或是活动可以选择固定种类的分类等等，都属于这种 UI。

首先，在数据库新增一个字段来存这个状态，我们会用字符串代号来代表不同状态，而不直接存给用户看的中文：

- draft 代表草稿活动
- public 代表公开活动
- private 代表私密活动

> 这个范例使用字符串来代表不同状态，有些程序员喜欢用数字。用字符串的优点是一目了然，可读性高。用数字的优点是数据库佔的空间较少效能较高一些，但是缺点是光看数字是不懂意义的。

这是因为：

1. 要显示给用户的的中文，可能会因为需求而改变。但是数据库的资料不会改。
2. 多国语系的支援，实际显示给用户的会依照用户语系而改变
3. 程序可能会依赖这个代码，写程序时一律写英文比较一致，例如 `if event.status == 'draft'`

请执行 `rails g migration add_status_to_events`

编辑 `20170414072940_add_status_to_events.rb`

20170414072940_add_status_to_events.rb

```
  class AddStatusToEvents < ActiveRecord::Migration[5.0]
    def change
+     add_column :events, :status, :string, :default => "draft"
    end
  end
```

执行 `rake db:migrate`

可以编辑 `app/models/event.rb`，加上资料验证

app/models/event.rb

```
  class Event < ApplicationRecord

+   STATUS = ["draft", "public", "private"]
+   validates_inclusion_of :status, :in => STATUS
```

# 6-2 显示输出

数据库存的是代码而已，实际显示给用户时，需要转换成中文，作法有两种：

#### 方法一：用 Helper

编辑 `app/helpers/events_helper.rb`

app/helpers/events_helper.rb

```
 module EventsHelper

+   def display_event_status(event)
+     case event.status
+       when "draft"
+         "草稿"
+       else
+         ""
+     end
+   end

  end
```

编辑 `app/views/events/show.html.erb`

app/views/events/show.html.erb

```
+ <h2><%= display_event_status(@event) %></h2>
```

#### 方法二：用 I18n

如果已经配置了多国语系，可以改用 i18n，以下我们会用这种做法。

编辑 `app/views/events/show.html.erb`

app/views/events/show.html.erb

```
+ <h2><%= t(@event.status, :scope => "event.status") %></h2>
```

编辑 `config/locals/zh-CN.yml`

config/locals/zh-CN.yml

```
 "zh-CN":
+   event:
+     status:
+       draft: 草稿
+       public: 公开
+       private: 私密
```

> 如果只做中文版，就不编辑 en.yml 也没关系。

# 6-3 使用 Select 下拉选单

接着我们编辑后台的表单，加一个下拉选单来选择状态：

编辑 `app/views/admin/events/_form.html.erb`

app/views/admin/events/_form.html.erb

```
+   <div class="form-group">
+     <%= f.label :status %>
+
+     <%= f.select :status, Event::STATUS.map{ |s| [t(s, :scope => "event.status"), s] }, {}, :class => "form-control" %>

+   </div>
```

其中第二个参数 `Event::STATUS.map{ |s| [t(s, :scope => "event.status"), s] }` 是一个二维数组，表示下拉的选项、第三个和第四个参数都是 Hash，为了顺利让第四个参数(设置 Bootstrap 样式需要的 class)传进去，所以要补一个空的 Hash 在第三个参数。详见 [Rails select 文档](http://api.rubyonrails.org/classes/ActionView/Helpers/FormOptionsHelper.html#method-i-select)。

编辑 `app/controllers/admin/events_controller.rb`

```
   def event_params
-    params.require(:event).permit(:name, :description, :friendly_id)
+    params.require(:event).permit(:name, :description, :friendly_id, :status)
   end
```

这样就可以选择状态了：

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/fBfxWAGBSv3nUQRPu2mz_6-3.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/fBfxWAGBSv3nUQRPu2mz_6-3.png)

# 6-4 改用 Radio Button UI

如果选项是 3 个以下，可以考虑改用 Radio Button，对用户会更方便(鼠标只要点一次就可以选择)：

再次编辑 `app/views/admin/events/_form.html.erb`，把 `f.select :status` 改成：

```
 <% Event::STATUS.each do |status| %>
  <label>
    <%= f.radio_button :status, status %>
    <%= t(status, :scope => "event.status") %>
  </label>
 <% end %>
```

> 用 label 标籤包起来的话，点选文字才会有选 radio 的效果

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/DqVMfDauRESYyGbUvtAR_6-1.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/DqVMfDauRESYyGbUvtAR_6-1.png)

# 6-5 使用 Radio Button 加上 Bootstrap Button 样式

Radio Button UI 也可以考虑搭配 Bootstrap 按钮样式，请修改成：

```
  <div class="btn-group" data-toggle="buttons">
    <% Event::STATUS.each do |status| %>
      <label class="btn btn-default <%= (status == f.object.status)? 'active' : '' %>">
        <%= f.radio_button :status, status %>
        <%= t(status, :scope => "event.status") %>
      </label>
    <% end %>
  </div>
```

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/nSSfXRJZSd6I4aHKzWhK_6-2.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/nSSfXRJZSd6I4aHKzWhK_6-2.png)

这样就很漂亮了。



# 7-1 情境和 Model 准备

这一章我们同样示范如何在表单实作一个单选的 UI，例如活动(Event)需要一个分类，但是跟上一章是固定有限的选项不同，我们希望分类是可以持续编辑的，因此需要再新增一个 Category Model，然后让 Category has_many Event 来建立数据关系。

执行 `rails g model category name:string`

编辑 `db/migrate/20170414082617_create_categories.rb`

20170414082617_create_categories.rb

```
  class CreateCategories < ActiveRecord::Migration[5.0]
    def change
      create_table :categories do |t|
        t.string :name

        t.timestamps
      end

+     add_column :events, :category_id, :integer
+     add_index :events, :category_id
    end
  end
```

执行 `rake db:migrate`

编辑 `app/models/category.rb` 加上关联：

app/models/category.rb

```
  class Category < ApplicationRecord
+   has_many :events
  end
```

编辑 `app/models/event.rb` 加上关联：

app/models/event.rb

```
 class Event < ApplicationRecord

+   belongs_to :category, :optional => true
```

针对 Category model 的 CRUD 介面这里就省略了，你可以透过 `rails g controller admin::categories` 盖一个后台去编辑。

请直接进 `rails console` 手动加一些分类：

```
10.times{ |i| Category.create!( :name => "#{i} Category" ) }
```

# 7-2 使用 Select 下拉选单

接着来编辑后台表单，在编辑活动时，可以选择分类。

编辑 `app/views/admin/events/_form.html.erb`

```
+  <div class="form-group">
+    <%= f.label :category_id %>
+    <%= f.select :category_id, Category.all.map{ |c| [c.name, c.id] }, {}, :class => "form-control" %>
+  </div>
```

> 如果你用 [simple_form](https://github.com/plataformatec/simple_form) 而不是 Rails 内建的 `form_for` 来制作表单的话，是写 `<%= f.association :category %>` 效果是一样的。

编辑 `app/controllers/admin/events_controller.rb`

app/controllers/admin/events_controller.rb

```
   def event_params
-    params.require(:event).permit(:name, :description, :friendly_id, :status)
+    params.require(:event).permit(:name, :description, :friendly_id, :status, :category_id)
   end
```

成果：

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/KNg5wgZfSXuz9E33iUXY_7.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/KNg5wgZfSXuz9E33iUXY_7.png)

# 7-3 显示分类并避免 nil 错误

在前台的活动页面，需要显示该活动的分类。

编辑 `app/views/events/show.html.erb`

app/views/events/show.html.erb

```
+ <h2><%= @event.category.name %></h2>
```

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/7TK0GEpHTrCYVlQCoA4x_7-2.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/7TK0GEpHTrCYVlQCoA4x_7-2.png)

活动的 `category_id` 是后来才增加的字段，因此有些活动是没有 `category_id` 资料的。这时如果我们去点其他还没有选分类的活动，会发现出现以下的错误：

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/I9REGyVTFuUSphShorVA_7-3.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/I9REGyVTFuUSphShorVA_7-3.png)

这是因为 `@event.category` 是 `nil`，再调用 `nil.name` 就会出现 `NoMethodError` 了。

针对这种情况，Rails 提供了一个 `try` 方法，参数就是要调用的方法名称。透过 `try` 不管是不是 `nil`，都不会报错：

app/views/events/show.html.erb

```
- <h2><%= @event.category.name %></h2>
+ <h2><%= @event.category.try(:name) %></h2>
```

这样就算没有选 Cateogry 也不会报错了：

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/OJ8U8dTQhiccRoYnEKBJ_7-4.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/OJ8U8dTQhiccRoYnEKBJ_7-4.png)

# 7-4 使用 jQuery Select2 Plugin

当选项非常多时，单纯的下拉选单，可能就不好选了。例如，请进 `rails console` 手动再多加一些分类：

```
100.times{ |i| Category.create!( :name => "#{i+100} Category" ) }
```

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/P0mxuMAaTXObEXmbLRnr_7-5.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/P0mxuMAaTXObEXmbLRnr_7-5.png)

这种情况，可以安装 jQuery Plugin: [Select2](https://select2.github.io/) 是一个非常好用的单选、多选选单，非常适合选项非常多的情境。

这个 jQuery Plugin 有包好的 gem: [select2-rails](https://github.com/argerim/select2-rails)，请编辑 Gemfile，加上

Gemfile

```
gem "select2-rails"
```

执行 `bundle`，重启服务器。

编辑 `app/assets/javascripts/application.js`

app/assets/javascripts/application.js

```
   //= require jquery
   //= require jquery_ujs
   //= require turbolinks
   //= require bootstrap-sprockets
+  //= require select2
```

编辑 `app/asssets/stylesheets/application.scss`

app/asssets/stylesheets/application.scss

```
   @import "bootstrap-sprockets";
   @import "bootstrap";
+  @import "select2";
+  @import "select2-bootstrap";
```

> 这个 Select2 有提供配合 Bootstrap 的样式

编辑 `app/views/admin/events/_form.html.erb`，在最下方加入：

app/views/admin/events/_form.html.erb

```
<script>
  $("#event_category_id").select2( { theme: "bootstrap"} );
</script>
```

其中 `event_category_id` 是这个 select 下拉选单的 HTML ID。

以下是最后的成果，你可以打一些关键字 Select2 就会帮你做过滤来减少选项。

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/kXdlWgIZQRuHfq67pXK7_7-6.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/kXdlWgIZQRuHfq67pXK7_7-6.png)



# 8-1 情境准备

这一章我们示范如何在表单实作多选 UI。示范的情境是后台可以管理用户资料，针对每个用户可以编辑属于哪一个分组(Group)。

首先制作后台可以编辑用户资料：

编辑 `config/routes.rb`

config/routes.rb

```
  namespace :admin do
    root "events#index"
    resources :events
+    resources :users
  end
```

执行 `rails g controller admin::users`

编辑 `app/controllers/admin/users_controller.rb`

app/controllers/admin/users_controller.rb

```
-  class Admin::UsersController < ApplicationController
+  class Admin::UsersController < AdminController

+   def index
+     @users = User.all
+   end

+   def edit
+     @user = User.find(params[:id])
+   end

+   def update
+     @user = User.find(params[:id])

+     if @user.update(user_params)
+       redirect_to admin_users_path
+     else
+       render "edit"
+     end
+   end

+   protected

+   def user_params
+     params.require(:user).permit(:email)
+   end

end
```

> Rails 的 controller 默认会继承自 ApplicationController，这里改成继承自 AdminController，这样定义在 app/controllers/admin_controller.rb 的所有方法都会被继承下来，包括 `layout "admin"`

编辑 `app/views/admin/users/index.html.erb`

```
<h1>Admin Users</h1>

<table class="table">
<tr>
  <th>ID</th>
  <th>Email</th>
  <th>Actions</th>
</tr>
<% @users.each do |user| %>
  <tr>
    <td><%= user.id %></td>
    <td><%= user.email %></td>
    <td><%= link_to "Edit", edit_admin_user_path(user), :class => "btn btn-default" %></td>
  </tr>
<% end %>
</table>
```

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/C7SDF6J3R4SB7HbxDGtv_8.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/C7SDF6J3R4SB7HbxDGtv_8.png)

编辑 `app/views/admin/users/edit.html.erb`

```
<h1>Edit User</h1>

<% if @user.errors.any? %>
  <div id="error_explanation">
    <ul>
    <% @user.errors.full_messages.each do |msg| %>
      <li><%= msg %></li>
    <% end %>
    </ul>
  </div>
<% end %>

<%= form_for [:admin, @user] do |f| %>

  <div class="form-group">
    <%= f.label :email %>
    <%= f.text_field :email, :class => "form-control" %>
  </div>

  <div class="form-group">
    <%= f.submit "Update", :class => "btn btn-primary" %>
    <%= link_to "Cancel", admin_users_path %>
  </div>

<% end %>
```

编辑 `app/views/layout/admin.html.erb`

app/views/layout/admin.html.erb

```
  <% if current_user %>
    <li class="active"><%= link_to('活动管理', admin_events_path) %></li>
+   <li><%= link_to('用户管理', admin_users_path) %></li>
  <% end %>
```

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/hrgRNCMRONbgbs7pES0w_8-2.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/hrgRNCMRONbgbs7pES0w_8-2.png)

# 8-2 建立 Model

针对每个用户可以编辑属于哪一个分组(Group)，因此需要建立 Group model。

执行 `rails g model group name:string`

一个 User 可以属于很多 Group、一个 Group 可以有很多 User，这是多对多的关系，因此需要一个关联的 Model，可以命名为 Membership

执行 `rails g model membership`

编辑 `db/migrate/20170415120527_create_memberships.rb`

db/migrate/20170415120527_create_memberships.r

```
class CreateMemberships < ActiveRecord::Migration[5.0]
  def change
    create_table :memberships do |t|
      t.integer :user_id, :index => true
      t.integer :group_id, :index => true
      t.timestamps
    end
  end
end
```

执行 `rake db:migrate`

编辑 `app/models/user.rb`

app/models/user.rb

```
+  has_many :memberships
+  has_many :groups, :through => :memberships
```

编辑 `app/models/membership.rb`

```
class Membership < ApplicationRecord

  belongs_to :user
  belongs_to :group

end
```

编辑 `app/models/group.rb`

```
class Group < ApplicationRecord

  has_many :memberships
  has_many :users, :through => :memberships

end
```

建立一些假资料，进入 `rails c`

`100.times{ |i| Group.create!( :name => "No.1 #{i} Group") }`

# 8-3 用 checkbox 可以多选分组

用核选方块是最常见的多选 UI 方式

编辑 `app/views/admin/users/edit.html.erb`

app/views/admin/users/edit.html.erb

```
+  <div class="form-group">
+    <%= f.label :group_ids %>
+    <%= f.collection_check_boxes(:group_ids, Group.all, :id, :name) %>
+  </div>
```

> 如果你用 [simple_form](https://github.com/plataformatec/simple_form) 而不是 Rails 内建的 `form_for` 来制作表单的话，写 `<%= f.association :groups, :as => :check_boxes %>` 效果是一样的。

编辑 `app/controllers/admin/users_controller.rb`

app/controllers/admin/users_controller.rb

```
   def user_params
-    params.require(:user).permit(:email)
+    params.require(:user).permit(:email, :group_ids => [])
   end
```

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/NNDs23ZQxK2KboiVZHWp_8-3.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/NNDs23ZQxK2KboiVZHWp_8-3.png)

显示的部分，可以修改 `app/views/admin/users/index.html.erb`

app/views/admin/users/index.html.erb

```
   <th>Email</th>
+  <th>Groups</th>

   # 略

     <td><%= user.email %></td>
+    <td>
+      <% user.groups.each do |g| %>
+        <%= g.name %><br>
+      <% end %>
+    </td>
```

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/ouSpofS7QWuN1Kp6aYLJ_8-5.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/ouSpofS7QWuN1Kp6aYLJ_8-5.png)

为了避免 N+1 Query 效能问题，可以再修改 `app/controllers/admin/users_controller.rb`

```
   def index
-    @users = User.all
+    @users = User.includes(:groups).all
   end
```

改之前，很多针对 groups 的数据库查询：

![7693C39B-985A-4F14-A6A4-D9CEC4599557](/var/folders/2k/q63b1kcj38j4cfrl_fjx6z1c0000gn/T/net.shinyfrog.bear/BearTemp.YKSmAn/7693C39B-985A-4F14-A6A4-D9CEC4599557.png)

改之后，只剩下一个针对 groups 的数据库查询：

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/1ERoTp8CTwmJ2LXVgHoy_8-7.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/1ERoTp8CTwmJ2LXVgHoy_8-7.png)

# 8-4 用 Select multiple 加上 Select2 Plugin

当多选的选项太多时，也可以用 Select2 来改进 UI。

> 请先完成上一章的单选 Select2 的安装

编辑 `app/views/admin/users/edit.html.erb`

app/views/admin/users/edit.html.erb

```
   <div class="form-group">
     <%= f.label :group_ids %>
-    <%= f.collection_check_boxes(:group_ids, Group.all, :id, :name) %>
+    <%= f.select :group_ids, Group.all.map{ |g| [g.name, g.id] }, {}, :multiple => true, :class => "form-control" %>
  </div>
```

同一页最下方补上：

```
<script>
  $("#user_group_ids").select2()
</script>
```

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/49w1uSJXSY6tuM9CqfX1_8-4.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/49w1uSJXSY6tuM9CqfX1_8-4.png)

#### 本节作业

##### [第一集作业](https://fullstack.xinshengdaxue.com/assignments/50)：[作业二](https://fullstack.xinshengdaxue.com/tasks/312)

已有 35 个第一期同学提交了这个作业 [**看看同学怎么做](https://fullstack.xinshengdaxue.com/tasks/312/other_answers?order=recent)

[**提交作业](https://fullstack.xinshengdaxue.com/tasks/312)

请在任一个项目中，使用 Select2 Plugin 在单选或多选 UI 上，截图贴上来。
