---
layout: post
title: "Ajaxäº¤äº’å¼ç½‘é¡µåº”ç”¨"
date: 2017-10-30
tags:
    Rails
    æ•™æ
---
#Ajaxäº¤äº’å¼é¡µé¢åº”ç”¨

| 1. jQuery 101 é¢„è®¡å­¦ä¹ æ—¶é—´: 2å°æ—¶ä»¥å†…              |      |
| ---------------------------------------- | ---- |
| [**  1-1 ä»€ä¹ˆæ˜¯ jQuery å’Œ DOM](https://fullstack.xinshengdaxue.com/posts/938) |      |
| [**  1-2 æ–°å¢ç»ƒä¹ ç½‘é¡µ](https://fullstack.xinshengdaxue.com/posts/939) |      |
| [**  1-3 å¦‚ä½•åŠ¨æ€å¢åŠ å†…å®¹åˆ°ç½‘é¡µä¸Š](https://fullstack.xinshengdaxue.com/posts/940) |      |
| [**  1-4 å¦‚ä½•é™¤é”™?](https://fullstack.xinshengdaxue.com/posts/941) |      |
| [**  1-5 document.ready äº‹ä»¶è§£è¯´](https://fullstack.xinshengdaxue.com/posts/942) |      |
| [**  1-6 å¦‚ä½•éšè—å’Œæ‰“å¼€å†…å®¹](https://fullstack.xinshengdaxue.com/posts/943) |      |
| [**  1-7 é¼ æ ‡ç§»è¿‡å»è‡ªåŠ¨æ‰“å¼€å’Œéšè—å†…å®¹](https://fullstack.xinshengdaxue.com/posts/944) |      |
| [**  1-8 å¦‚ä½•æ›¿æ¢å’Œç§»é™¤å†…å®¹](https://fullstack.xinshengdaxue.com/posts/945) |      |
| [**  1-9 å¦‚ä½•æ”¹å˜ class å±æ€§](https://fullstack.xinshengdaxue.com/posts/946) |      |
| [**  1-10 jQuery å°ç»“](https://fullstack.xinshengdaxue.com/posts/947) |      |

| 2. Ajax on Rails é¢„è®¡å­¦ä¹ æ—¶é—´: 3å°æ—¶ä»¥å†…           |                                          |
| ---------------------------------------- | ---------------------------------------- |
| [**  2-1 Ajax ç®€ä»‹](https://fullstack.xinshengdaxue.com/posts/948) |                                          |
| [**  2-2 ç›®æ ‡](https://fullstack.xinshengdaxue.com/posts/949) |                                          |
| [**  2-3 å»ºç«‹ Models](https://fullstack.xinshengdaxue.com/posts/950) |                                          |
| [**  2-4 æµè§ˆè´´æ–‡å’Œäº§ç”Ÿå‡èµ„æ–™](https://fullstack.xinshengdaxue.com/posts/951) |                                          |
| [**  2-5 æ–°å¢å’Œåˆ é™¤è´´æ–‡](https://fullstack.xinshengdaxue.com/posts/952) |                                          |
| [**  2-6 Ajax åˆ é™¤](https://fullstack.xinshengdaxue.com/posts/953) |                                          |
| [**  2-7 Ajax æ–°å¢](https://fullstack.xinshengdaxue.com/posts/954) |                                          |
| [**  2-8 Ajax æ–°å¢: æ¸…ç©ºè¡¨å•å’Œé”™è¯¯å¤„ç†](https://fullstack.xinshengdaxue.com/posts/955) |                                          |
| [**  2-9 åˆ¶ä½œæŒ‰èµåŠŸèƒ½](https://fullstack.xinshengdaxue.com/posts/956) |                                          |
| [**  2-10 Ajax æŒ‰è®š](https://fullstack.xinshengdaxue.com/posts/959) |                                          |
| [**  2-11 æ˜¾ç¤ºå’Œæ›´æ–°å¤šå°‘äººæŒ‰è®š](https://fullstack.xinshengdaxue.com/posts/957) |                                          |
| [**  2-12 Ajax å°ç»“](https://fullstack.xinshengdaxue.com/posts/958) | å…±3ä¸ªä½œä¸š \|[** æœªå®Œæˆ](https://fullstack.xinshengdaxue.com/posts/958#task) |

| 3. Turbolinks è§£è¯´ é¢„è®¡å­¦ä¹ æ—¶é—´: 1å°æ—¶ä»¥å†…           |      |
| ---------------------------------------- | ---- |
| [**  3-1 Turbolinks å‘](https://fullstack.xinshengdaxue.com/posts/960) |      |
| [**  3-2 æ‹†é™¤ Turbolinks](https://fullstack.xinshengdaxue.com/posts/961) |      |

| 4. Ajax on Rails (è¿›é˜¶ç¯‡) é¢„è®¡å­¦ä¹ æ—¶é—´: 2å°æ—¶ä»¥å†…     |                                          |
| ---------------------------------------- | ---------------------------------------- |
| [**  4-1 å‰è¨€](https://fullstack.xinshengdaxue.com/posts/992) |                                          |
| [**  4-2 æŠŠåˆ é™¤æ”¹æˆè‡ªè¡Œç»‘äº‹ä»¶](https://fullstack.xinshengdaxue.com/posts/993) |                                          |
| [**  4-3 è´´æ–‡æ— é™æ²è½´](https://fullstack.xinshengdaxue.com/posts/994) |                                          |
| [**  4-4 ä½¿ç”¨æ ¸é€‰æ–¹å—(checkbox)åšå¼€å…³](https://fullstack.xinshengdaxue.com/posts/995) |                                          |
| [**  4-5 æµè§ˆå™¨ Bubble Up äº‹ä»¶æ¨¡å‹](https://fullstack.xinshengdaxue.com/posts/996) |                                          |
| [**  4-6 ä½¿ç”¨ jQuery Traversing èµ°è®¿å…ƒç´ ](https://fullstack.xinshengdaxue.com/posts/997) |                                          |
| [**  4-7 ä½¿ç”¨ä¸‹æ‹‰é€‰å•(select)åˆ†ç±»è´´æ–‡](https://fullstack.xinshengdaxue.com/posts/998) |                                          |
| [**  4-8 Ajax åŠ¨ç”»æ•ˆæœ](https://fullstack.xinshengdaxue.com/posts/999) |                                          |
| [**  4-9 jQuery Plugin æ•´åˆç¤ºèŒƒ](https://fullstack.xinshengdaxue.com/posts/1000) |                                          |
| [**  4-10 jQuery Plugin æ•´åˆç¤ºèŒƒ(cont)](https://fullstack.xinshengdaxue.com/posts/1001) | å…±1ä¸ªä½œä¸š \|[** æœªå®Œæˆ](https://fullstack.xinshengdaxue.com/posts/1001#task) |

| 5. Unobtrusive JavaScript è§£è¯´ é¢„è®¡å­¦ä¹ æ—¶é—´: åŠå°æ—¶ä»¥å†… |      |
| ---------------------------------------- | ---- |
| [**  jquery-ujs](https://fullstack.xinshengdaxue.com/posts/1002) |      |

# 1-1 ä»€ä¹ˆæ˜¯ jQuery å’Œ DOM

[jQuery](https://jquery.com/)æ˜¯ä¸€å¥—æœ€å¤šäººä½¿ç”¨çš„ JavaScript å‡½å¼åº“ï¼Œå¯ä»¥æ’°å†™å„ç§ç½‘é¡µæ•ˆæœï¼Œæœ‰ä¸°å¯Œçš„ç¤¾åŒºå’Œå„ç§ Plugins å¤–æŒ‚ã€‚

å®ƒçš„ä¸»è¦ä½œç”¨æ˜¯æ“çºµç½‘é¡µçš„ DOM(Document Object Model)ï¼šæµè§ˆå™¨ä¼šè§£æ HTML ç„¶åæ˜¾ç¤ºåœ¨ç”»é¢ä¸Šï¼Œè¿™ä¸ªè§£æå‡ºæ¥çš„ç»“æ„å°±å«åš DOMï¼Œåœ¨æµè§ˆå™¨å†…éƒ¨è¿™æ˜¯ä¸€ä¸ªæ ‘çŠ¶çš„èµ„æ–™ç»“æ„ï¼š

```
html
  - head
    - title
     - a web page
  - body class="home"
    - h1 id="header"
     - a headline
    - p
     - some
     - span
      - text
     - text
```

æµè§ˆå™¨æä¾›äº† DOM API è®©å¼€å‘è€…å¯ä»¥æ“çºµè¿™äº›ç»“æ„ï¼Œé€è¿‡ jQuery æˆ‘ä»¬å¯ä»¥å¾ˆæ–¹ä¾¿åœ°ä» HTML å–å¾—è¦æ“çºµçš„ HTML å…ƒç´ ï¼Œå¹¶åœ¨ DOM é‡Œé¢è¿›è¡Œæ’å…¥ã€ä¿®æ”¹ã€åˆ é™¤å…ƒç´ ï¼Œè¿™æ ·æµè§ˆå™¨çš„ç”»é¢å°±ä¼šè·Ÿç€å˜åŒ–äº†ã€‚

# 1-2 æ–°å¢ç»ƒä¹ ç½‘é¡µ

jQuery åœ¨ Rails 5.0 ä»¥å‰çš„ç‰ˆæœ¬é»˜è®¤å°±æœ‰å®‰è£…ï¼Œä½ å¯ä»¥åœ¨ Gemfile é‡Œé¢çœ‹åˆ° `gem 'jquery-rails'` ä»¥åŠåœ¨ `app/assets/javascripts/application.js` é‡Œé¢çœ‹åˆ° `//= require jquery`ã€‚

> åœ¨ Gemfile å‰å‡ è¡Œå¯ä»¥çœ‹åˆ°ä½  Rails çš„ç‰ˆæœ¬ã€‚å¦‚æœä½ æ˜¯ Rails 5.1ï¼Œè¯·åœ¨ Gemfile è¡¥ä¸Š `gem 'jquery-rails'`ï¼Œç„¶åæ‰§è¡Œ `bundle`ï¼Œæ¥ç€åœ¨ `app/assets/javascripts/application.js` é‡Œé¢æ‹¿æ‰ `//= require rails-ujs` æ¢æˆ `//= require jquery` è·Ÿ `//= require jquery_ujs`

è®©æˆ‘ä»¬æ–°å¢ä¸€ä¸ªä¸“æ¡ˆï¼Œå¹¶æ–°å¢ä¸€äº›é¡µé¢æ¥è¿›è¡Œç¤ºèŒƒï¼š

`rails new ajax-posting-app`

`cd ajax-posting-app`

`git init`

`rails g controller pages`

ç¼–è¾‘ `config/routes.rb`

config/routes.rb

```
get "/jquery-1" => "pages#jquery_1"
get "/jquery-2" => "pages#jquery_2"
get "/jquery-3" => "pages#jquery_3"
get "/jquery-4" => "pages#jquery_4"
get "/jquery-5" => "pages#jquery_5"

root "pages#jquery_1"
```

ç¼–è¾‘ `app/views/layouts/application.html.erb`

app/views/layouts/application.html.erb

```
   <body>
+    <%= link_to "jQuery ç»ƒä¹ ä¸€", jquery_1_path %> |
+    <%= link_to "jQuery ç»ƒä¹ äºŒ", jquery_2_path %> |
+    <%= link_to "jQuery ç»ƒä¹ ä¸‰", jquery_3_path %> |
+    <%= link_to "jQuery ç»ƒä¹ å››", jquery_4_path %> |
+    <%= link_to "jQuery ç»ƒä¹ äº”", jquery_5_path %>
```

å®‰è£… [bootstrap-sass](https://github.com/twbs/bootstrap-sass) (æ­¥éª¤çœç•¥ï¼Œä¹‹åçš„æˆªå›¾æ˜¯æœ‰å®‰è£… Bootstrapï¼Œç”»é¢æ¯”è¾ƒæ¼‚äº®ï¼Œæ²¡åšä¸å½±å“åŠŸèƒ½)

å¯åŠ¨æœåŠ¡å™¨ `rails server`

(è¯·æ¥ç€åšä¸‹ä¸€èŠ‚å†æ‰“å¼€æµè§ˆå™¨)

# 1-3 å¦‚ä½•åŠ¨æ€å¢åŠ å†…å®¹åˆ°ç½‘é¡µä¸Š

ç›®æ ‡ï¼šç‚¹å‡»ä¸€ä¸ª HTML å…ƒç´ åï¼ŒåŠ¨æ€ç½®æ¢ä¸€æ®µå†…å®¹

æ–°å¢ `app/views/pages/jquery_1.html.erb`

```
<p>
  <a id="my-click">Click Me</a>
</p>

<div id="foo" style="border: 1px solid red;">
  <p>bar</p>
</div>

<script>
  $("#my-click").click(function(){
    $("#foo").html('<h1>zoo</h1>');
  })
</script>
```

æµè§ˆ `http://localhost:3000/jquery-1`

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/6MKTXNchSfSt6YMinFiK_1.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/6MKTXNchSfSt6YMinFiK_1.png)

ç‚¹å‡» Click Me è¿ç»“çš„è¯ï¼Œä½ ä¼šå‘ç° `<p>bar</p>` å°±åŠ¨æ€ç½®æ¢æˆ `<h1>zoo</h1>` äº†ã€‚

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/X6DsK83eQqOrdYTjXuH9_2.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/X6DsK83eQqOrdYTjXuH9_2.png)

è§£è¯´ï¼š

- `<script>...</script>` åŒ…èµ·æ¥çš„éƒ¨åˆ†å°±æ˜¯å†™ JavaScript çš„åœ°æ–¹
- è¿™ä¸ªé’±å· $ ç­‰åŒäº jQuery
- `$("#my-click")` æ˜¯ jQuery çš„é€‰æ‹©å™¨ç”¨æ³•ï¼Œä¼šæŒ‘å‡º id æ˜¯ `my-click` çš„å…ƒç´ ï¼Œåœ¨è¿™é‡Œå°±æ˜¯æŒ‡ Click Me çš„è¶…è¿ç»“ã€‚åœ¨ HTML ä¸Š id æ˜¯å”¯ä¸€çš„ï¼Œä¸èƒ½æœ‰é‡å¤çš„ idã€‚
- `.click( function(){...} )` ä¼šç»‘è®¢ä¸€ä¸ªç‚¹å‡»(click)äº‹ä»¶åœ¨è¯¥å…ƒç´ ä¸Šé¢ï¼Œå½“ç”¨æˆ·ç‚¹å‡»è¿™ä¸ªå…ƒç´ æ—¶ï¼Œå°±ä¼šæ‰§è¡Œé‡Œé¢çš„ function
- `$("#foo").html('<h1>zoo</h1>')` ä¼šæŠŠ #foo è¿™ä¸ªå…ƒç´ çš„å†…å®¹ç½®æ¢æˆ `<h1>zoo</h1>`

è¯·è¯•è¯•çœ‹æŠŠ `html` æ¢æˆä»¥ä¸‹ç”¨æ³•ï¼Œè§‚å¯Ÿçœ‹çœ‹æœ‰ä»€ä¹ˆå·®åˆ«ï¼š

- `text` æ–‡å­—æ›¿æ¢
- `prepend` æŠŠå†…å®¹æ’åœ¨æŒ‡å®šå…ƒç´ é‡Œé¢çš„æœ€å‰é¢
- `append` æŠŠå†…å®¹æ’åœ¨æŒ‡å®šå…ƒç´ é‡Œé¢çš„æœ€åé¢
- `before` æŠŠå†…å®¹æ’åœ¨æŒ‡å®šå…ƒç´ çš„å‰é¢
- `after` æŠŠå†…å®¹æ’åœ¨æŒ‡å®šå…ƒç´ çš„åé¢

è¯·å…ˆæ­é…çœ‹ä¸‹ä¸€èŠ‚å¦‚ä½•é™¤é”™ã€‚

# 1-4 å¦‚ä½•é™¤é”™?

è¯·ä½¿ç”¨ Chrome å¼€å‘è€…å·¥å…·ï¼šåœ¨ HTML ç”»é¢ä¸ŠæŒ‰å³é”®ï¼Œç‚¹ Inspectï¼Œå°±ä¼šçœ‹åˆ°ä»¥ä¸‹ç”»é¢ï¼š

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/9qkFqQi5QMKpl8xwKxpY_3-debug.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/9qkFqQi5QMKpl8xwKxpY_3-debug.png)

å¦‚æœ JavaScript å†™é”™çš„è¯ï¼Œåœ¨ Console å¯ä»¥çœ‹åˆ°é”™è¯¯ï¼Œä¾‹å¦‚æˆ‘ä»¬æŠŠ `click` æ‹¼é”™æˆ `clickk` çš„è¯ï¼š

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/qgWeEcpRdK8tHhTxh5KA_4-debug.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/qgWeEcpRdK8tHhTxh5KA_4-debug.png)

> ä»é”™è¯¯çš„åœ°æ–¹å¼€å§‹ï¼Œä»¥ä¸‹çš„ JavaScript ç¨‹åºéƒ½ä¸ä¼šæ‰§è¡Œå–”

æƒ³åœ¨ JavaScript ç¨‹åºä¸­è§‚å¯Ÿå˜é‡çš„è¯ï¼Œå¯ä»¥ç”¨ `alert` æˆ– `console.log` è¯­æ³•ï¼Œä¾‹å¦‚ï¼š

```
  $("#my-click").click(function(){
    alert("test");
  })
```

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/PNwSIeZqRE2uQYM2EgvY_5-debug.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/PNwSIeZqRE2uQYM2EgvY_5-debug.png)

ä¸è¿‡è·³ alert æœ‰æ—¶å€™å¤ªæ¼äººäº†ï¼Œå¯ä»¥æ”¹ç”¨ `console.log` å°±ä¼šå‡ºç°åœ¨å¼€å‘è€…å·¥å…·çš„ Console é‡Œé¢ï¼š

```
 console.log("checkpoint A");

  $("#my-click").click(function(){
    console.log("checkpoint C");
  })

  console.log("checkpoint B");
```

å°±ä¼šå‡ºç°ï¼š

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/J3Eu05hHSgSSTIiZfuR5_6-debug.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/J3Eu05hHSgSSTIiZfuR5_6-debug.png)

# 1-5 document.ready äº‹ä»¶è§£è¯´

åœ¨ç”¨ `$("xxxx")` jQuery é€‰æ‹©å™¨çš„æ—¶å€™ï¼ŒHTML å¿…é¡»å…ˆåŠ è½½å®Œï¼ŒjQuery æ‰èƒ½å¤Ÿæ‰¾å¾—åˆ°å…ƒç´ ã€‚å› æ­¤æˆ‘ä»¬åˆšåˆšæ˜¯å…ˆå†™ HTML åœ¨ä¸Šï¼ŒæŠŠ `script` å†™åœ¨ä¸‹é¢ã€‚å¦‚æœå€’è¿‡æ¥çš„è¯ï¼š

```
<script>
  $("#my-click").click(function(){
    $("#foo").html('<h1>zoo</h1>');
  })
</script>

<p>
  <a id="my-click">Click Me</a>
</p>

<div id="foo" style="border: 1px solid red;">
  <p>bar</p>
</div>
```

ä½ ä¼šå‘ç°æ²¡æœ‰æ•ˆæœï¼Œç‚¹äº†æ²¡ååº”ï¼Œå› ä¸º `click`äº‹ä»¶å¹¶æ²¡æœ‰é¡ºåˆ©ç»‘åœ¨è¶…è¿ç»“ä¸Šã€‚

ä½†æ˜¯ä¼ ç»Ÿä¸Šæˆ‘ä»¬ä¹ æƒ¯å°† JavaScript æ”¾åœ¨ HTML ä¸Šæ–¹åŠ è½½ï¼Œä¾‹å¦‚å†™åœ¨ `app/assets/javascripts/application.js` é‡Œé¢ï¼Œå› æ­¤è¿™æ—¶å€™æˆ‘ä»¬éœ€è¦ç”¨ `$(document).ready` æŠŠç¨‹åºåŒ…èµ·æ¥ï¼Œä¹Ÿå°±æ˜¯æ”¹æˆï¼š

```
  <script>
+ // è¿™æ˜¯ javascript æ³¨è§£
+ // ä¹Ÿå¯ä»¥ç¼©å†™æˆ $(function() {
+ $(document).ready(function(){
    $("#my-click").click(function(){
      $("#foo").html('<h1>zoo</h1>');
    })
+ })
  </script>

  <p>
    <a id="my-click">Click Me</a>
  </p>

  <div id="foo" style="border: 1px solid red;">
    <p>bar</p>
  </div>
```

`$(document).ready` æ˜¯ä¸€ä¸ªæµè§ˆå™¨çš„äº‹ä»¶ï¼Œä¼šåœ¨åŠ è½½ HTML å®Œæˆä¹‹åï¼Œæ‰æ‰§è¡Œé‡Œé¢çš„ functionï¼Œå°±å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚

# 1-6 å¦‚ä½•éšè—å’Œæ‰“å¼€å†…å®¹

ç›®æ ‡ï¼šç‚¹å‡»ä¸€ä¸ªå…ƒç´ åï¼ŒåŠ¨æ€éšè—å’Œæ‰“å¼€ä¸€æ®µå†…å®¹

æ–°å¢ `app/views/pages/jquery_2.html.erb`

```
<p>
  <a id="my-open-click">Open</a>
</p>

<div id="foo" style="border: 1px solid red;">
  <a id="my-hide-click">Hide</a>
  <p>bar</p>
</div>


<script>
  $("#foo").hide();

  $("#my-open-click").click(function(){
    $("#foo").show();
  })

  $("#my-hide-click").click(function(){
    $("#foo").hide();
  })
</script>
```

æµè§ˆ `http://localhost:3000/jquery-2`

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/A8kZpbE2RhuU8Abav4Ol_7-hide.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/A8kZpbE2RhuU8Abav4Ol_7-hide.png)

ç‚¹å‡» Open

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/Dj5ejPATbSZslH3EGwnV_8-show.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/Dj5ejPATbSZslH3EGwnV_8-show.png)

å†ç‚¹å‡» Hide å°±ä¼šéšè—èµ·æ¥äº†ã€‚

è¯·è¯•è¯•çœ‹æŠŠ `hide` å’Œ `show` åˆ†åˆ«æ”¹æˆ

- `fadeOut` å’Œ `fadeIn`
- `slideUp` å’Œ `slideDown`

ä¼šæœ‰ä¸åŒçš„åŠ¨ç”»æ•ˆæœã€‚

# 1-7 é¼ æ ‡ç§»è¿‡å»è‡ªåŠ¨æ‰“å¼€å’Œéšè—å†…å®¹

ç›®æ ‡ï¼šé¼ æ ‡ç§»è¿‡å»ï¼Œå°±ä¼šè‡ªåŠ¨æ‰“å¼€å’Œéšè—ä¸€æ®µå†…å®¹

æ–°å¢ `app/views/pages/jquery_3.html.erb`

```
<p>
  <a id="my-toggle-click">Toggle</a>
</p>

<div id="foo" style="border: 1px solid red;">
  <p>bar</p>
</div>

<script>
  $("#foo").hide();   // å…ˆé©¬ä¸Šè—èµ·æ¥

  $("#my-toggle-click").hover(function(){
    $("#foo").toggle();   // ç§»è¿‡å»ä¼šæœ‰å¼€å…³çš„æ•ˆæœ
  })

</script>
```

æµè§ˆ `http://localhost:3000/jquery-3`

é¼ æ ‡ç§»è¿‡å»å°±ä¼šæ‰“å¼€å†…å®¹ï¼Œé¼ æ ‡ç§»èµ°å†…å®¹å°±ä¼šéšè—èµ·æ¥ã€‚

è§£è¯´ï¼š

è¿™é‡Œæˆ‘ä»¬æ”¹ç”¨ `hover` äº‹ä»¶ï¼Œè¿™ä¼šåœ¨é¼ æ ‡ç§»è¿‡å»å’Œç§»å‡ºå»çš„æ—¶å€™ï¼Œéƒ½ä¼šè§¦å‘ã€‚ç„¶åæ­é… `toggle` æ–¹æ³•å°±å¯ä»¥ä¸€å¼€ä¸€å…³äº†ã€‚

jQuery æ”¯æ´äº†éå¸¸å¤šçš„[æµè§ˆå™¨äº‹ä»¶](https://www.w3schools.com/jquery/jquery_events.asp)ï¼Œä»é¼ æ ‡å•ç‚¹ã€åŒç‚¹ã€ç§»è¿‡å»ã€ç§»å‡ºå»ï¼Œåˆ°é”®ç›˜è¾“å…¥å“ªä¸€ä¸ªæŒ‰é”®ç­‰ç­‰ï¼Œåœ¨æµè§ˆå™¨é‡Œé¢å‘ç”Ÿçš„äº‹æƒ…éƒ½å¯ä»¥ç»‘äº‹ä»¶ä¸Šå»ã€‚

æœ€åï¼Œè¯·è¯•è¯•çœ‹æŠŠ `toggle` æ”¹æˆ

- `slideToggle`
- `fadeToggle`

ä¼šæœ‰ä¸åŒçš„åŠ¨ç”»æ•ˆæœã€‚

# 1-8 å¦‚ä½•æ›¿æ¢å’Œç§»é™¤å†…å®¹

ç›®æ ‡ï¼šç‚¹å‡»ä¸€ä¸ªå…ƒç´ åï¼ŒåŠ¨æ€æ›¿æ¢å’Œåˆ é™¤å†…å®¹

æ–°å¢ `app/views/pages/jquery_4.html.erb`

```
<p>
  <a id="my-replace-click">Replace</a>
  <a id="my-remove-click">Remove</a>
  <a id="my-remove-all-click">Remove All</a>
</p>

<div id="foo" style="border: 1px solid red;">
  <p>bar</p>
</div>

<div class="zoo"><p>a</p></div>
<div class="zoo"><p>b</p></div>
<div class="zoo"><p>c</p></div>

<script>
  $("#my-replace-click").click(function(){
    $("#foo").replaceWith('<div id="foo" style="border:1px solid green"><p>foo</p></div>');
  })

  $("#my-remove-click").click(function(){
    $("#foo").remove();
  })

  $("#my-remove-all-click").click(function(){
    $(".zoo").remove();
  })
</script>
```

æµè§ˆ `http://localhost:3000/jquery-4`

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/cDDCsqm5TKWHX7uAAvGY_9.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/cDDCsqm5TKWHX7uAAvGY_9.png)

ç‚¹å‡» Replace

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/2oVKMzN0R7uPSqLZTXAf_10-replace.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/2oVKMzN0R7uPSqLZTXAf_10-replace.png)

è§£è¯´ï¼š`replaceWith` ä¼šè¿åŒæŒ‡å®šå…ƒç´ ä¸€èµ·ç½®æ¢æ‰ï¼Œå› æ­¤æ•´ä¸ª `#foo` åŒ…å« `<div>` éƒ½ä¸€èµ·è¢«æ¢æ‰äº†ã€‚

ç‚¹å‡» Remove ç§»é™¤ä¸€ä¸ªå…ƒç´ ï¼š

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/zITaXYjRoKS2XHZbVwlr_11-remove.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/zITaXYjRoKS2XHZbVwlr_11-remove.png)

ç‚¹å‡» Remove All ç§»é™¤ a,b,c ä¸‰ä¸ªå…ƒç´ ï¼š

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/hFLME8DwR8O04ETxfyJg_12-remove-all.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/hFLME8DwR8O04ETxfyJg_12-remove-all.png)

è§£è¯´ï¼šè¿™é‡Œæˆ‘ä»¬æ”¹ç”¨ `$(".zoo")` é€‰æ‹©å™¨æ¥æŒ‘é€‰å‡ºæ‰€æœ‰ class é‡Œé¢æœ‰ `zoo` çš„å…ƒç´ ã€‚è·Ÿ id ä¸åŒï¼Œä¸€ä»½ HTML ä¸Šå¯ä»¥æœ‰å¤šä¸ªé‡å¤çš„ classã€‚

# 1-9 å¦‚ä½•æ”¹å˜ class å±æ€§

ç›®æ ‡ï¼šç‚¹å‡»ä¸€ä¸ªå…ƒç´ åï¼ŒåŠ¨æ€æ›¿æ¢å…ƒç´ çš„ classï¼Œè¿™æ ·å°±ä¼šå¥—ç”¨ä¸åŒçš„ CSS æ¥æ”¹å˜å¤–è§‚

æ–°å¢ `app/views/pages/jquery_5.html.erb`

```
<style>
  .error {
    color: red;
  }
  .success {
    color: green;
  }
</style>

<p>
  <a id="my-add-class-click">Add Class</a>

  <a id="my-remove-class-click">Remove Class</a>
</p>

<div id="foo">
  <h1>bar</h1>
</div>

<script>
  $("#my-add-class-click").click(function(){
    $("#foo").removeClass('error');
    $("#foo").addClass('success');
  })

  $("#my-remove-class-click").click(function(){
    $("#foo").removeClass('success');
    $("#foo").addClass('error');
  })
</script>

```

æµè§ˆ `http://localhost:3000/jquery-5`

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/KSyQmOkRmey4nBZmdQSR_13-class.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/KSyQmOkRmey4nBZmdQSR_13-class.png)

ç‚¹å‡» Add Class

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/EiAAw6KTJuJF31ns3B2H_14.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/EiAAw6KTJuJF31ns3B2H_14.png)

ç‚¹å‡» Remove Class

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/mLwXUn7HQh28w0aHqlLF_15.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/mLwXUn7HQh28w0aHqlLF_15.png)

jQuery ä¹Ÿæœ‰ API å¯ä»¥[ç›´æ¥æ”¹ CSS](http://api.jquery.com/css/)ã€‚

# 1-10 jQuery å°ç»“

è¿™ç« ç¤ºèŒƒçš„å°±æ˜¯æœ€å¸¸è§çš„ jQuery ä½¿ç”¨å¥—è·¯äº†ï¼ŒåŒ…æ‹¬ï¼š

- ç”¨é€‰æ‹©å™¨ Selector é€‰å–å‡ºç›®æ ‡å…ƒç´ ï¼Œæˆ‘ä»¬å­¦åˆ°æœ€ç®€å•çš„å¯ä»¥ç”¨ id æˆ– class æ¥é€‰ï¼Œä¾‹å¦‚ `$("#æŸä¸ªID")` å’Œ `$(".æŸä¸ªclass")`ã€‚
- ç»‘å®šä¸€ä¸ªäº‹ä»¶(Event)ä¸Šå»ï¼Œä¾‹å¦‚ `click` å’Œ `hover` äº‹ä»¶
- å½“äº‹ä»¶è¢«è§¦å‘çš„æ—¶å€™ï¼Œæ‰§è¡ŒæŸä¸ª DOM æ“ä½œæ¥æ”¹å˜ HTMLï¼Œå¯èƒ½æ˜¯æ”¹å˜å…ƒç´ çš„å±æ€§ã€æ’å…¥æ–°å†…å®¹ã€æ–°å¢æˆ–ç§»é™¤ class å±æ€§ç­‰ç­‰ã€‚ç›®å‰å­¦åˆ°çš„ç”¨æ³•æœ‰ï¼š
  - `html`
  - `append`
  - `prepend`
  - `before`
  - `after`
  - `remove`
  - `replaceWith`
  - `toggle`
  - `addClass` å’Œ `removeClass`

å…¶å®å¤§éƒ¨åˆ†çš„ jQuery ä»£ç çš„å·¥ä½œå°±æ˜¯å»æ–°å¢å†…å®¹ã€æ”¹å˜ HTMLã€è°ƒæ•´ CSS ç­‰æ–¹å¼æ“æ§ç½‘é¡µï¼Œä¾‹å¦‚è·³å‡ºé€‰å•ã€è½®æ’­å¹¿å‘Šã€æ»‘åŠ¨æ ‡é¢˜å›¾ç‰‡ç­‰ç­‰ï¼Œè¿™äº›å°±æ˜¯æ‰§è¡Œä¸Šè¿°æ­¥éª¤ã€‚

# 2-1 Ajax ç®€ä»‹

å›æƒ³ä¹‹å‰çš„è¶…è¿ç»“æˆ–æ˜¯è¡¨å•é€å‡ºï¼Œæµè§ˆå™¨ä¼šæ•´é¡µæ›¿æ¢ï¼š

ä¾‹å¦‚ç‚¹è¶…è¿ç»“æ—¶ï¼Œæµè§ˆå™¨ä¼šç”¨ GET é€å‡ºï¼Œç„¶åæ•´ä¸ªæµè§ˆå™¨åˆ·æ–°åˆ°ä¸‹ä¸€é¡µï¼š

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/cfoF9h32Qp6KLN3oXxsb_1.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/cfoF9h32Qp6KLN3oXxsb_1.png)

å¦‚æœç”¨è¡¨å•é€å‡ºçš„è¯ï¼Œæµè§ˆå™¨ä¼šå…ˆç”¨ POST é€å‡ºï¼ŒRails æœåŠ¡å™¨å¤„ç†å®Œä¹‹åï¼Œé€šå¸¸æˆ‘ä»¬ä¼šç”¨ `redirect` è¯­æ³•æ¥å›ä¼  HTTP çŠ¶æ€ç  301ï¼Œå½“æµè§ˆå™¨çœ‹åˆ° 301 åå°±ä¼šé€ GET å»æŠ“ä¸‹ä¸€é¡µã€‚(ä¸ºä½•è¿™æ ·è®¾è®¡?è¯·å‚è€ƒã€ŒWeb API è®¾è®¡å®ä½œã€æ•™ç¨‹çš„ [3-2 ä»€ä¹ˆæ˜¯ REST API](https://fullstack.xinshengdaxue.com/posts/838))

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/OUlDWbULTz5PwYLf5YO6_2.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/OUlDWbULTz5PwYLf5YO6_2.png)

æ¥ä¸‹æ¥è¦ä»‹ç»çš„ Ajax(Asynchronous JavaScript and XML) å¼‚æ­¥çš„JavaScriptä¸XMLæŠ€æœ¯ï¼Œåˆ™å¯ä»¥ä¸éœ€è¦æ•´é¡µæ›¿æ¢ï¼Œåªæ›´æ–°éƒ¨åˆ†ç½‘é¡µï¼Œè¿™å¯ä»¥å¤§å¤§çš„æ”¹è¿› UI ååº”é€Ÿåº¦ã€‚ç›®å‰å·²ç»ä¸æµè¡Œç”¨ XML äº†ï¼Œå› æ­¤å¸¸è§çš„å›ä¼ ä¼šç”¨ JSON å’Œ Script æ ¼å¼ï¼š

ç”¨ JSON æ ¼å¼ï¼Œå¿…é¡»å†™è‡ªå®šä¹‰çš„ JavaScript å»å¤„ç† Ajax çš„å‘é€å’Œæ¥æ”¶å¤„ç†ã€‚JavaScript å¼ºè€…æˆ–å›¢é˜Ÿä¸­æœ‰å‰ç«¯å·¥ç¨‹å¸ˆä¼šåå¥½è¿™ç§æ–¹å¼ã€‚

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/IlmXqvNRTOKY0dR53iiA_3.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/IlmXqvNRTOKY0dR53iiA_3.png)

å¦ä¸€ç§æ˜¯ç”¨ Script æ ¼å¼ï¼ŒæœåŠ¡å™¨å›ä¼  JavaScriptï¼Œæµè§ˆå™¨æ‹¿åˆ°åç›´æ¥æ‰§è¡Œå³å¯ã€‚è¿™ç§æ–¹å¼ Rails æœ‰å†…å»º [jquery-ujs](https://github.com/rails/jquery-ujs) gemï¼Œä¼šå¸®æˆ‘ä»¬ç»‘å¥½äº‹ä»¶å»å¤„ç† Ajax å‘é€å’Œæ¥æ”¶ã€‚è¿™æ˜¯æ¯”è¾ƒç®€å•çš„ä½œæ³•ï¼Œå¯¹ jQuery æŠ€èƒ½çš„è¦æ±‚ä¹Ÿæ¯”è¾ƒä½ã€‚

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/9inQIiFTXKrjJ6vDFXT6_4.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/9inQIiFTXKrjJ6vDFXT6_4.png)

è¿™ä¸€ç« æˆ‘ä»¬ä¼šç¤ºèŒƒç”¨ Script çš„æ–¹å¼æ¥åš Ajaxã€‚

# 2-2 ç›®æ ‡

åˆ¶ä½œä¸€ä¸ªå¯ä»¥åˆ†äº«å†…å®¹ï¼Œç”¨æˆ·å¯ä»¥æŒ‰è®šçš„çš„ç½‘ç«™ã€‚User Story åŒ…æ‹¬ï¼š

- ç”¨æˆ·å¯ä»¥è´´æ–‡
- ç”¨æˆ·å¯ä»¥æµè§ˆæ‰€æœ‰è´´æ–‡
- ç”¨æˆ·å¯ä»¥åˆ é™¤è‡ªå·±çš„è´´æ–‡
- ç”¨æˆ·å¯ä»¥é’ˆå¯¹è´´æ–‡æŒ‰è®šï¼Œæ¯ç¯‡è´´æ–‡åªèƒ½æŒ‰è®šä¸€æ¬¡

éåŠŸèƒ½æ€§çš„è¦æ±‚æ˜¯ï¼Œåˆ©ç”¨ Ajax æŠ€æœ¯æ”¹å–„ UIï¼Œè®©æ“ä½œçš„ååº”å˜æˆç¥é€Ÿã€‚

# 2-3 å»ºç«‹ Models

é¦–å…ˆæ¥å®‰è£… Devise äº§ç”Ÿ User Model

ç¼–è¾‘ `Gemfile` åŠ ä¸Š `gem "devise"`

æ‰§è¡Œ `bundle`ï¼Œç„¶åé‡å¯æœåŠ¡å™¨

æ‰§è¡Œ `rails g devise:install`

æ‰§è¡Œ `rails g devise user`

ç¼–è¾‘ `app/views/layouts/application.html.erb`ï¼Œæ’å…¥ï¼š

app/views/layouts/application.html.erb

```
  <body>
+   <% if flash[:notice] %>
+     <%= flash[:notice] %>
+   <% end %>

+   <% if flash[:alert] %>
+     <%= flash[:alert] %>
+   <% end %>

+  <% if current_user %>
+     <%= link_to('ç™»å‡º', destroy_user_session_path, :method => :delete) %>
+    <%= link_to('ä¿®æ”¹å¯†ç ', edit_registration_path(:user)) %>
+  <% else %>
+    <%= link_to('æ³¨å†Œ', new_registration_path(:user)) %> |
+    <%= link_to('ç™»å…¥', new_session_path(:user)) %>
+   <% end %>

...(ç•¥)
```

æ‰§è¡Œ `rails g model post content:text user_id:integer`

ç¼–è¾‘ `app/models/user.rb`ï¼ŒåŠ ä¸Š posts å…³è”ï¼Œä»¥åŠä¸€ä¸ª `display_name` æ–¹æ³•æ¥æ˜¾ç¤ºç”¨æˆ·åç§°ã€‚

app/models/user.rb

```
 class User < ApplicationRecord

+   has_many :posts

+   def display_name
+     # # å– email çš„å‰åŠæ¥æ˜¾ç¤ºï¼Œå¦‚æœä½ ä¹Ÿå¯ä»¥å¦å¼€ä¸€ä¸ªå­—æ®µæ˜¯ nickname è®©ç”¨æˆ·å¯ä»¥è‡ªå·±ç¼–è¾‘æ˜¾ç¤ºåç§°
+     self.email.split("@").first
+   end

...(ç•¥)
```

ç¼–è¾‘ `app/models/post.rb`ï¼ŒåŠ ä¸Š user å…³è”

app/models/post.rb

```
  class Post < ApplicationRecord
+   validates_presence_of :content
+   belongs_to :user

...(ç•¥)
```

æ‰§è¡Œ `rake db:migrate`

# 2-4 æµè§ˆè´´æ–‡å’Œäº§ç”Ÿå‡èµ„æ–™

ç¼–è¾‘ `config/routes.rb`

config/routes.rb

```
+ resources :posts

- root "pages#jquery_1"
+ root "posts#index"
```

æ‰§è¡Œ `rails g controller posts`

ç¼–è¾‘ `app/controllers/posts_controller.rb`

app/controllers/posts_controller.rb

```
+  def index
+    @posts = Post.order("id DESC").all    # æ–°è´´æ–‡æ”¾å‰é¢
+  end
```

æ–°å¢ `app/views/posts/index.html.erb`

```
<% @posts.each do |post| %>

<div class="panel panel-default">
  <div class="panel-heading"><%= post.user.display_name %></div>
  <div class="panel-body">
    <%= post.content %>
  </div>
</div>

<% end %>
```

æ²¡æœ‰èµ„æ–™å°±ä¸å¥½ç©äº†ï¼Œé™¤äº†è¿› `rails console` è‡ªå·±æ–°å¢ä¹‹å¤–ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥è‡ªå·±å†™ä¸€ä¸ªå°ç¨‹åºæ¥äº§ç”Ÿä¸€å †å‡èµ„æ–™ã€‚

[Faker](https://github.com/stympy/faker) è¿™ä¸ª gem å¯ä»¥éšæœºäº§ç”Ÿå‡æ–‡ï¼Œç¼–è¾‘ Gemfile åŠ ä¸Šï¼š

```
 group :development do
+   gem 'faker'

  # (ç•¥)
```

æ‰§è¡Œ `bundle install`

å†™ä¸ª rake ç¨‹åºæ¥äº§ç”Ÿå‡èµ„æ–™ï¼Œæ–°å¢ `lib/tasks/dev.rake`ï¼Œæ”¾åœ¨è¿™ä¸ªç›®å½•ä¸‹çš„ rake æ¡£æ¡ˆæ˜¯ç”¨æ¥ç¼–å†™ä»»åŠ¡è„šæœ¬ï¼Œè®©æˆ‘ä»¬åœ¨ Terminal ä¸­å¯ä»¥æ‰§è¡Œå®ƒï¼š

lib/tasks/dev.rake

```
namespace :dev do

  task :fake => :environment do
    users = []
    10.times do
      users << User.create!( :email => Faker::Internet.email, :password => "12345678")
    end

    50.times do |i|
      post = Post.create!( :content => Faker::Lorem.paragraph,
                            :user_id => users.sample.id )

    end
  end

end
```

æ‰§è¡Œ `rake dev:fake` å°±ä¼šæ‰§è¡Œè¿™ä¸ªä»»åŠ¡ï¼Œäº§ç”Ÿ 10 ç¬”å‡ç”¨æˆ·å’Œ 50 ç¬”æ–‡ç« ã€‚

æµè§ˆ `http://localhost:3000` å¯ä»¥çœ‹åˆ°è´´æ–‡ä¸€è§ˆäº†ï¼š

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/dlQZRTQCT3WrW16fq5ql_16-posts.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/dlQZRTQCT3WrW16fq5ql_16-posts.png)

> è¯·è‡ªè¡Œå®‰è£… Bootstrap ç”»é¢æ‰ä¼šæ¼‚äº®å–”ï¼Œä¸è£…ä¹Ÿæ²¡å…³ç³»ä¸å½±å“å­¦ä¹  Ajax

# 2-5 æ–°å¢å’Œåˆ é™¤è´´æ–‡

åœ¨åš Ajax æ•ˆæœä¹‹å‰ï¼Œè¯·å…ˆå®ŒæˆåŸºæœ¬åŠŸèƒ½ï¼Œæ¥ä¸‹æ¥åˆ¶ä½œæ–°å¢å’Œåˆ é™¤ã€‚

ç¼–è¾‘ `app/controllers/posts_controller.rb`

app/controllers/posts_controller.rb

```
  class PostsController < ApplicationController

+   before_action :authenticate_user!, :only => [:create, :destroy]

+   def create
+     @post = Post.new(post_params)
+     @post.user = current_user
+     @post.save
+
+     redirect_to posts_path
+   end
+
+   def destroy
+     @post = current_user.posts.find(params[:id]) # åªèƒ½åˆ é™¤è‡ªå·±çš„è´´æ–‡
+     @post.destroy
+
+     redirect_to posts_path
+   end
+
+   protected
+
+   def post_params
+     params.require(:post).permit(:content)
+    end

  end
```

ç¼–è¾‘ `app/views/posts/index.html.erb`

```
+ <%= form_for Post.new do |f| %>
+   <div class="form-group">
+     <%= f.text_area :content, :class => "form-control" %>
+   </div>
+   <div class="form-group">
+     <%= f.submit :class => "btn btn-primary" %>
+   </div>
+ <% end %>

  <% @posts.each do |post| %>

  <div class="panel panel-default">
    <div class="panel-heading"><%= post.user.display_name %></div>
    <div class="panel-body">
      <%= post.content %>

+     <% if current_user && post.user == current_user %>
+       <p class="text-right">
+         <%= link_to "Delete", post_path(post), :method => :delete, :class => "btn btn-danger" %>
+       </p>
+     <% end %>
    </div>
  </div>

  <% end %>
```

æµ‹è¯•çœ‹çœ‹æ–°å¢è´´æ–‡å’Œåˆ é™¤ï¼Œè¦å…ˆæ³¨å†Œç™»å…¥æ‰èƒ½è´´æ–‡å–”ï¼š

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/0a4AgJKBRdiduR13OMku_17-new.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/0a4AgJKBRdiduR13OMku_17-new.png)

# 2-6 Ajax åˆ é™¤

æ¥ä¸‹æ¥æ˜¯æœ¬è¯¾ç¨‹çš„é‡ç‚¹æˆ Ajaxã€‚é¦–å…ˆæˆ‘ä»¬è¦è®© Delete åˆ é™¤çš„è¶…è¿ç»“å˜æˆ Ajax é€å‡ºã€‚

ç¼–è¾‘ `app/views/posts/index.html.erb`

```
-  <%= link_to "Delete", post_path(post), :method => :delete, :class => "btn btn-danger" %>
+  <%= link_to "Delete", post_path(post), :method => :delete, :remote => true, :class => "btn btn-danger" %>
```

é€è¿‡ `:remote => true` å°±ä¼šå˜æˆ Ajax é€å‡ºäº†ï¼Œä¸éœ€è¦è‡ªå·±å†™ `$("xxx").click` å»ç»‘äº‹ä»¶ã€‚

æ¥ç€ç¼–è¾‘ `app/controllers/posts_controller.rb`

app/controllers/posts_controller.rb

```
  def destroy
    @post = current_user.posts.find(params[:id])
    @post.destroy

-   redirect_to posts_path
+   render :js => "alert('ok');"
  end
```

è¿™é‡Œæ”¹æˆè¿”å›ä¸€æ®µ JavaScript å­—ä¸²ä»£ç ï¼Œå†…å®¹æ˜¯ `alert('ok');`ï¼Œå®é™…æµ‹è¯•çœ‹çœ‹ï¼Œç‚¹åˆ é™¤ï¼š

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/QylsbXhJQqKgPNZsUqlo_18-ajax-delete.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/QylsbXhJQqKgPNZsUqlo_18-ajax-delete.png)

æœåŠ¡å™¨å›ä¼ äº† `alert('ok');` å­—ä¸²ï¼Œæµè§ˆå™¨æ‹¿åˆ°ä¹‹åå°±å»æ‰§è¡Œï¼Œäºæ˜¯è·³å‡ºä¸€ä¸ª alert è§†çª—ã€‚

> è¿™ä¸€æ‹›åˆå«åš Remote JavaScript (RJS)ï¼ŒæŠŠè¿œç«¯çš„ JavaScript ä»£ç æŠ“å›æ¥æ‰§è¡Œã€‚

åšåˆ°è¿™é‡Œï¼Œé‚£ä¸€ç¬”è´´æ–‡è™½ç„¶åœ¨æ•°æ®åº“ä¸­å·²ç»è¢«åˆ é™¤äº†ï¼Œä½†å› ä¸ºæ˜¯ Ajax æ²¡æœ‰æ•´é¡µé‡æ–°æ•´ç†ï¼Œæ‰€ä»¥é‚£ä¸€ç¬”è´´æ–‡çœ‹èµ·æ¥è¿˜åœ¨ç½‘é¡µä¸Šé¢ï¼Œå¦‚æœä½ é‡æ–°æ•´ç†ç”»é¢çš„è¯ï¼Œé‚£ä¸€ç¬”æ‰ä¼šä¸è§ã€‚

æˆ‘ä»¬å¸Œæœ›çš„ UI æ•ˆæœæ˜¯ç«‹å³ç§»é™¤ç”»é¢ä¸Šçš„é‚£ä¸€ç¬”è´´æ–‡ï¼Œè¿™æ—¶å€™å¾—ç”¨åˆ°ä¸Šä¸€ç«  jQuery å­¦åˆ°çš„ `$("xxxx").remove()` ç”¨æ³•ï¼š

å› ä¸ºè¦åœ¨ controller é‡Œé¢æ”¾ JavaScript å­—ä¸²æ˜¯å¾ˆç—›è‹¦çš„ï¼Œæ¥ä¸‹æ¥æ”¹æˆç”¨ erb æ ·æ¿çš„æ–¹å¼æ¥å†™ JavaScriptï¼š

å†æ¬¡ç¼–è¾‘ `app/controllers/posts_controller.rb`ï¼ŒæŠŠ `render :js` ç æ‰ï¼š

app/controllers/posts_controller.rb

```
  def destroy
    @post = current_user.posts.find(params[:id])
    @post.destroy

-   render :js => "alert('ok');"
  end
```

ç¼–è¾‘ `app/views/posts/index.html.erb`ï¼Œé’ˆå¯¹æ¯ä¸€ç¬”è´´æ–‡ div è¡¥ä¸Šä¸€ä¸ª id æ¥åšå®šä½ï¼š

```
-  <div class="panel panel-default">
+  <div id="post-<%= post.id %>" class="panel panel-default">
```

æ–°å¢ `app/views/posts/destroy.js.erb` æ ·æ¿ï¼š

```
 $("#post-<%= @post.id %>").remove();
```

è§£è¯´ï¼š

- é’ˆå¯¹è¦è¢«ç§»é™¤çš„ `<div>` åŒºå—ï¼Œæˆ‘ä»¬è¡¥ä¸Šäº†ä¸€ä¸ª idï¼Œä¾‹å¦‚ `<div id="post-123">`ï¼Œè¿™æ ·ç­‰ä¼š jQuery è¦ç§»é™¤çš„æ—¶å€™ï¼Œå°±å¯ä»¥ç›´æ¥æŠ“åˆ°è¦ç§»é™¤å“ªä¸€ä¸ªå…ƒç´ äº†
- ä¸€ä¸ª action å¦‚æœæ²¡æœ‰å†™æ˜ `redirect` æˆ– `render` çš„è¯ï¼Œå°±ä¼šé»˜è®¤å»æ‰¾ action åç§°çš„æ ·æ¿ã€‚äºæ˜¯è¿™é‡Œå°±ä¼šå»æ‰¾ `destroy.js.erb`
- `destroy.js.erb` é‡Œé¢è¦å†™å›ä¼ çš„ JavaScript ä»£ç ï¼Œè¿™ä¸ªæ¡£æ¡ˆä¹Ÿæ˜¯ erb æ ·æ¿ï¼Œæ‰€ä»¥å¯ä»¥ç”¨ `<%= XXX %>` å†…åµŒ Ruby è¯­æ³•

å†æ¬¡æµ‹è¯•çœ‹çœ‹åˆ é™¤ï¼Œä½ ä¼šå‘ç°åˆ é™¤çš„æ“ä½œå˜æˆè¶…çº§ç¥é€Ÿã€‚

#### Ajax è¦å¦‚ä½•é™¤é”™?

ç”±äºå‰ç«¯æ²¡æœ‰æ¢é¡µï¼Œæ‰€ä»¥å°±ç®—ä»£ç å†™é”™äº†ï¼ŒæŒ‰é’®æŒ‰ä¸‹å»ä¹Ÿä¸ä¼šæœ‰ä»»ä½•ååº”ã€‚è¿™æ—¶å€™è¯·çœ‹ `rails server` çš„ logï¼Œæˆ–æ˜¯æ‰“å¼€ Chrome å¼€å‘è€…æ¨¡å¼çš„ Network è¿›è¡Œè§‚å¯Ÿï¼š

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/Qhr7AlW0QcUQup9OBG46_19.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/Qhr7AlW0QcUQup9OBG46_19.png)

è¿™æˆªå›¾è¯´æ˜äº†æœåŠ¡å™¨å›ä¼  `$("#post-76").remove();` JavaScript å­—ä¸²ï¼Œæµè§ˆå™¨å»æ‰§è¡Œè¿™ä¸ªå­—ä¸²å°±æŠŠ id post-76 è¿™ä¸ª div ç»™ç§»é™¤äº†ã€‚

# 2-7 Ajax æ–°å¢

é™¤äº† `link_to`ã€`button_to` å¯ä»¥åŠ ä¸Š `:remote => true` å˜æˆ Ajax ä¹‹å¤–ã€‚`form_for` ä¹Ÿå¯ä»¥ç”¨è¿™æ‹›ã€‚æ¥ä¸‹æ¥åšåšçœ‹æ–°å¢è´´æ–‡ï¼š

ç¼–è¾‘ `app/views/posts/index.html.erb`

app/views/posts/index.html.erb

```
-  <%= form_for Post.new do |f| %>
+  <%= form_for Post.new, :remote => true do |f| %>
```

ç¼–è¾‘ `app/controllers/posts_controller.rb`ï¼ŒæŠŠ `redirect_to` ç æ‰ï¼š

app/controllers/posts_controller.rb

```
  def create
    @post = Post.new(post_params)
    @post.user = current_user
    @post.save

-   redirect_to posts_path

  end
```

è¿™æ—¶å€™å¦‚æœä½ æ–°å¢çš„è¯ï¼ŒæŒ‰ä¸‹é€å‡ºç½‘é¡µçœ‹èµ·æ¥æ²¡æœ‰ååº”ï¼Œå…¶å®æ•°æ®åº“å·²ç»æ’å…¥è¿™ä¸€ç¬”ï¼Œé‡æ–°æ•´ç†å°±ä¼šå‡ºç°ã€‚

æˆ‘ä»¬å¸Œæœ›çš„ UI æ•ˆæœæ˜¯åœ¨ HTML ä¸Šæ’å…¥ä¸€æ•´ä¸ªæ–°è´´æ–‡çš„å†…å®¹ï¼Œä¹Ÿå°±æ˜¯å¾—åœ¨ `app/views/posts/create.js.erb` ç”¨ `$("XXX").prepend("YYY")` çš„è¯­æ³•æ¥è¾¾æˆã€‚é—®é¢˜æ˜¯ XXX è·Ÿ YYY è¦å¡«ä»€ä¹ˆï¼Ÿ

å…ˆæ¥è§£å†³ XXXï¼Œæˆ‘ä»¬é¢„æœŸæ–°çš„è´´æ–‡æ”¾åœ¨æœ¬æ¥è´´æ–‡çš„ä¸Šæ–¹ï¼Œæ‰€ä»¥è¦åœ¨ HTML ä¸Šå®šä½å‡ºæœ¬æ¥çš„è´´æ–‡åŒºå—ï¼Œè¯·ç¼–è¾‘ `app/views/posts/index.html.erb` ç”¨ä¸€ä¸ª div æ•´ä¸ªåŒ…èµ·æ¥

app/views/posts/index.html.erb

```
+  <div id="post-list">
  <% @posts.each do |post| %>
    # ç•¥...
  <% end %>
+ </div>
```

æ¥ç€æ˜¯ YYYï¼Œè¿™ä¸ªè¦æ’å…¥çš„ HTML å­—ä¸²è·Ÿç›®å‰åœ¨ `index.html.erb` æ ·æ¿ä¸Šé¢çš„è´´æ–‡ HTML æ˜¯ä¸€æ¨¡ä¸€æ ·çš„ï¼Œè¿™æ—¶å€™æƒ³åˆ°æ¥ç”¨ partial æ ·æ¿ï¼Œå†æ¬¡ç¼–è¾‘ `app/views/posts/index.html.erb`ï¼ŒæŠŠæ•´å—è´´æ–‡çš„éƒ¨åˆ†æ¬å» partial:

app/views/posts/index.html.erb

```
  <div id="post-list">
   <% @posts.each do |post| %>
-    <div id="post-<%= post.id %>" class="panel panel-default">
-      <div class="panel-heading"><%= post.user.display_name %></div>
-      <div class="panel-body">
-      <%= post.content %>
-
-        <% if current_user && post.user == current_user %>
-        <p class="text-right">
-          <%= link_to "Delete", post_path(post), :method => :delete, :class => "btn btn-danger", :remote => true %>
-        </p>
-        <% end %>
-      </div>
-   </div>

+   <%= render :partial => "post", :locals => { :post => post } %>
  <% end %>
</div>
```

æ–°å¢ `app/views/posts/_post.html.erb` è¿™ä¸ª Partial æ ·æ¿ï¼š

```
<div id="post-<%= post.id %>" class="panel panel-default">
  <div class="panel-heading">
    <%= post.user.display_name %>
  </div>
  <div class="panel-body">
    <%= post.content %>

    <% if current_user && post.user == current_user %>
      <p class="text-right">
        <%= link_to "Delete", post_path(post), :method => :delete, :class => "btn btn-danger", :remote => true %>
      </p>
    <% end %>
  </div>
</div>
```

é‡æ–°æ•´ç† index ç”»é¢åº”è¯¥è¿˜æ˜¯æ­£å¸¸çš„ã€‚

æ¥ç€å¯ä»¥å†™ `app/views/posts/create.js.erb` äº†

```
$("#post-list").prepend("<%=j render :partial => "post", :locals => { :post => @post } %>");
```

å°±ä¸€è¡Œï¼Œè¿™æ ·å°±å¯ä»¥é‡å¤åˆ©ç”¨ partial æ ·æ¿ï¼ŒæŠŠæ•´ä¸ª partial å˜æˆä¸€ä¸ª JavaScript å­—ä¸²ï¼Œç„¶åå¡å…¥ `<div id="#post-list">` é‡Œã€‚

å…¶ä¸­ `j` ç­‰åŒäº `escape_javascript`ï¼Œè¿™ä¼šåšé€¸å‡ºå¥½è®© partial å­—ä¸²å¯ä»¥å˜æˆåˆæ³•çš„ JavaScript å­—ä¸²ï¼š

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/QcmYyZxnQg2RZJYbrcHL_20-create.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/QcmYyZxnQg2RZJYbrcHL_20-create.png)

å¦‚æœä½ æŠŠ j æ‹¿æ‰ï¼Œä¼šå˜æˆä»¥ä¸‹è¿™æ ·ï¼Œæµè§ˆå™¨æ˜¯æ— æ³•æ­£ç¡®æ‰§è¡Œè¿™æ®µ JavaScript ä»£ç çš„ï¼š

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/ZE9qr5mR1mMrWK7kU2ag_21.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/ZE9qr5mR1mMrWK7kU2ag_21.png)

# 2-8 Ajax æ–°å¢: æ¸…ç©ºè¡¨å•å’Œé”™è¯¯å¤„ç†

æ¥ä¸‹æ¥è¿˜æœ‰ä¸¤ä¸ªå°åœ°æ–¹å¯ä»¥æ”¹è¿›ï¼Œç¬¬ä¸€æ˜¯é€å‡ºåï¼Œè¾“å…¥æ¡†åº”è¯¥æ¸…ç©ºã€‚

ä¿®æ”¹`app/views/posts/create.js.erb`ï¼Œæ–°å¢ä¸€è¡Œ `$("#post_content").val("");`

```
   $("#post-list").prepend("<%=j render :partial => "post", :locals => { :post => @post } %>");
+  $("#post_content").val("");
```

ç”¨ `.val("")` å°±å¯ä»¥æŠŠè¾“å…¥æ¡†çš„å€¼è®¾å®šä¸ºç©ºã€‚

ç¬¬äºŒæ˜¯å‚¨å­˜å¤±è´¥çš„æƒ…å†µå¤„ç†ï¼Œå‡è®¾è´´æ–‡æ˜¯ç©ºçš„ï¼Œé‚£ä¹ˆ @post ä¼šå‚¨å­˜å¤±è´¥ï¼Œè¿™æ—¶å€™åº”è¯¥æœ‰é”™è¯¯è®¯æ¯æç¤ºã€‚ä¿®æ”¹`app/views/posts/create.js.erb`

```
+ <% if @post.valid? %>
  $("#post-list").prepend("<%=j render :partial => "post", :locals => { :post => @post } %>");
  $("#post_content").val("");
+ <% else %>
+   alert("è´´æ–‡å¤±è´¥");
+ <% end %>
```

å¢åŠ ä¸€ä¸ª if else çš„æƒ…å†µåŒºåˆ†ï¼Œå½“ `valid?` æˆåŠŸæ—¶ï¼Œæ’å…¥æ–°è´´æ–‡ï¼Œå½“å‚¨å­˜å¤±è´¥æ—¶ï¼Œè·³ä¸€ä¸ª alert è§†çª—ã€‚

# 2-9 åˆ¶ä½œæŒ‰èµåŠŸèƒ½

æ¥ä¸‹æ¥åˆ¶ä½œç”¨æˆ·å¯ä»¥é’ˆå¯¹è´´æ–‡æŒ‰è®šï¼Œå…ˆæ¥åšä¸€ä¸ªåŸºæœ¬ç‰ˆæ²¡æœ‰ Ajax æ•ˆæœçš„ç‰ˆæœ¬ï¼š

ä¸€ä¸ªç”¨æˆ·å¯ä»¥é’ˆå¯¹å¾ˆå¤šè´´æ–‡æŒ‰è®šï¼Œä¸€ç¯‡è´´æ–‡å¯ä»¥æœ‰å¾ˆå¤šç”¨æˆ·æŒ‰è®šï¼Œè¿™æ˜¯ä¸€ä¸ªå¤šå¯¹å¤šçš„æ¨¡å‹ï¼Œè®©æˆ‘ä»¬æ–°å¢ä¸€ä¸ª Like modelï¼š

æ‰§è¡Œ `rails g model like`

ç¼–è¾‘ `db/migrate/201703XXXXXXXX_create_likes.rb`

db/migrate/201703XXXXXXXX_create_likes.rb

```
  class CreateLikes < ActiveRecord::Migration[5.0]
    def change
      create_table :likes do |t|
+       t.integer :user_id, :index => true
+       t.integer :post_id, :index => true
        t.timestamps
      end
    end
  end
```

åœ¨ç»ˆç«¯æ‰§è¡Œ `rake db:migrate`

ç¼–è¾‘ `app/models/like.rb`ï¼ŒåŠ ä¸Šå…³è”

app/models/like.rb

```
+  belongs_to :user
+  belongs_to :post
```

ç¼–è¾‘ `app/models/post.rb`ï¼ŒåŠ ä¸Šå…³è”å’Œä¸€ä¸ª `find_like` æ–¹æ³•ï¼šç”±äºä¸€ä¸ªç”¨æˆ·åªèƒ½é’ˆå¯¹ä¸€ç¯‡è´´æ–‡æŒ‰ä¸€ä¸ªè®šï¼Œæ‰€ä»¥é€è¿‡ç”¨æˆ·IDå’Œè´´æ–‡IDï¼Œå°±å¯ä»¥æ‰¾åˆ°å”¯ä¸€çš„ Likeï¼Œç­‰ä¼šæˆ‘ä»¬ä¼šç”¨è¿™ä¸ªæ–¹æ³•æ¥åˆ¤æ–­ä¸€ä¸ªç”¨æˆ·ä¸èƒ½é‡å¤æŒ‰è®šã€‚

app/models/post.rb

```
   belongs_to :user

+  has_many :likes, :dependent => :destroy
+  has_many :liked_users, :through => :likes, :source => :user

+  def find_like(user)
+    self.likes.where( :user_id => user.id ).first
+  end
```

ç¼–è¾‘ `app/models/user.rb`ï¼ŒåŠ ä¸Šå…³è”

app/models/user.rb

```
   has_many :posts

+  has_many :likes, :dependent => :destroy
+  has_many :liked_posts, :through => :likes, :source => :post
```

> å› ä¸ºå·²ç»æœ‰äº† `has_many :posts`ï¼Œæ‰€ä»¥è¿™é‡Œè¦å–ä¸åŒåç§° `:liked_posts`ï¼Œä¹Ÿå› ä¸ºå–äº†ä¸åŒåç§°ï¼Œéœ€è¦é¢å¤–æŒ‡å®š sourceã€‚è¯¦ç»†åœ¨ [2017/2/16 çš„ç›´æ‹¨](https://fullstack.xinshengdaxue.com/posts/431) æœ‰è§£è¯´

ç¼–è¾‘ `config/routes.rb`

config/routes.rb

```
-  resources :posts
+  resources :posts do
+    member do
+      post "like" => "posts#like"
+      post "unlike" => "posts#unlike"
+    end
+  end
```

ç¼–è¾‘ `app/views/posts/_post.html.erb` åŠ ä¸ŠæŒ‰è®šçš„æŒ‰é’®ï¼š

app/views/posts/_post.html.erb

```
  <div class="panel-body">
     <%= post.content %>

+    <div class="text-right">
+
+      <% if post.liked_users.any? %>
+        <%= post.liked_users.map{ |u| u.display_name }.join(",") %> ç‚¹äº†èµ
+      <% end %>
+
+      <% if current_user # æœ‰ç™»å…¥æ‰å¯ä»¥æŒ‰è®š %>
+        <% if post.find_like(current_user) %>
+          <%= link_to "-1", unlike_post_path(post), :method => :post, :class => "btn btn-primary" %>
+        <% else %>
+          <%= link_to "+1", like_post_path(post), :method => :post, :class => "btn btn-primary" %>
+        <% end %>
+      <% end %>

      # (ç•¥ï¼Œåˆ é™¤æŒ‰é’®åœ¨è¿™é‡Œ)

+    </div>
  </div>
```

æœ€åæ˜¯ controllerï¼Œè¯·ç¼–è¾‘ `app/controllers/posts_controller.rb`ï¼ŒåŠ ä¸Š like å’Œ unlike æ–¹æ³•ï¼š

app/controllers/posts_controller.rb

```
+  def like
+    @post = Post.find(params[:id])
+    unless @post.find_like(current_user)  # å¦‚æœå·²ç»æŒ‰è®šè¿‡äº†ï¼Œå°±ç•¥è¿‡ä¸å†æ–°å¢
+      Like.create( :user => current_user, :post => @post)
+    end
+
+    redirect_to posts_path
+  end
+
+  def unlike
+    @post = Post.find(params[:id])
+    like = @post.find_like(current_user)
+    like.destroy
+
+    redirect_to posts_path
+  end
+
```

å®é™…æµ‹è¯•çœ‹çœ‹æŒ‰è®š +1 å’Œå–æ¶ˆæŒ‰è®š -1

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/4khabC9NTb5cK0xvJQpR_21-like.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/4khabC9NTb5cK0xvJQpR_21-like.png)

# 2-10 Ajax æŒ‰è®š

æ¥ç€æ”¹è¿›ä¸ºç¥é€Ÿ Ajax æŒ‰è®šï¼Œæµç¨‹æ˜¯ï¼š

1. æŠŠæœ¬æ¥çš„ +1 å’Œ -1 æŒ‰é’®ï¼Œæ”¹æˆ `:remote => true` ç”¨ Ajax é€å‡º
2. æœåŠ¡å™¨ä¼šæ–°å»ºæˆ–åˆ é™¤ Like èµ„æ–™è¿›æ•°æ®åº“
3. æœåŠ¡å™¨å›ä¼ çš„ JavaScript è¦æ›¿æ¢æ‰æ•´å—æŒ‰è®šçš„ HTML éƒ¨åˆ†ï¼ŒåŒ…æ‹¬ XXX æŒ‰äº†è®šï¼Œä»¥åŠæŠŠ +1 æ”¹æˆ -1 æŒ‰é’®æˆ– -1 æ”¹æˆ +1 æŒ‰é’®ã€‚

è¿™é‡Œåˆéœ€è¦ç”¨åˆ° Partial æ ·æ¿äº†ï¼Œè¿™æ ·æ‰èƒ½åœ¨ä¸€å¼€å§‹æ˜¾ç¤º HTML æ—¶ï¼Œä»¥åŠåœ¨ Ajax ä¸­å»é‡å¤ä½¿ç”¨åŒä¸€ä»½ erb ä»£ç ã€‚

ç¼–è¾‘ `app/views/posts/_post.html.erb` æŠŠæœ¬æ¥æ•´å—çš„æŒ‰è®š HTML æ¬åˆ° Partial å»ï¼Œå¹¶ç”¨ä¸€ä¸ª span åŒ…èµ·æ¥ï¼Œæ–¹ä¾¿ç­‰ä¼šå®šä½ï¼š

app/views/posts/_post.html.erb

```
-   <% if post.liked_users.any? %>
-     <%= post.liked_users.map{ |u| u.display_name }.join(",") %> ç‚¹äº†èµ
-   <% end %>
-
-   <% if current_user # æœ‰ç™»å…¥æ‰å¯ä»¥æŒ‰è®š %>
-     <% if post.find_like(current_user) %>
-       <%= link_to "-1", unlike_post_path(post), :method => :post, :class => "btn btn-primary" %>
-     <% else %>
-       <%= link_to "+1", like_post_path(post), :method => :post, :class => "btn btn-primary" %>
-     <% end %>
-   <% end %>

+    <span id="post-like-<%= post.id %>">
+      <%= render :partial => "like", :locals => { :post => post } %>
+    </span>
```

æ–°å¢ `app/views/posts/_like.html.erb`ï¼Œå¹¶åœ¨æœ¬æ¥çš„ like å’Œ unlike æŒ‰é’®ä¸ŠåŠ ä¸Š `:remote => true` å˜æˆ Ajaxï¼š

```
<% if post.liked_users.any? %>
  <%= post.liked_users.map{ |u| u.display_name }.join(",") %> ç‚¹äº†èµ
<% end %>

<% if current_user # æœ‰ç™»å…¥æ‰å¯ä»¥æŒ‰è®š %>
  <% if post.find_like(current_user) %>
    <%= link_to "å–æ¶ˆè®š", unlike_post_path(post), :method => :post, :remote => true, :class => "btn btn-primary" %>
  <% else %>
    <%= link_to "è®š", like_post_path(post), :method => :post, :remote => true, :class => "btn btn-primary" %>
  <% end %>
<% end %>
```

ç¼–è¾‘ `app/controllers/posts_controller.rb`ï¼ŒæŠŠ like å’Œ unlike é‡Œé¢çš„ `redirect_to` æ‹¿æ‰ï¼š

app/controllers/posts_controller.rb

```
  def like
    # (ç•¥)
-   redirect_to posts_path
  end

  def unlike
    # (ç•¥)
-   redirect_to posts_path
+   render "like"
  end
```

ä¸ç®¡ like æˆ– unlikeï¼Œåæ­£æˆ‘ä»¬éƒ½ä¼šæŠŠæ•´å— `<span id="post-like-XXX">` æ›¿æ¢æ‰ã€‚å› æ­¤ unlike é‡Œé¢æˆ‘ä»¬ç”¨ `render "like"` é‡å¤ä½¿ç”¨åŒä¸€ä¸ª `like.js.erb` æ ·æ¿ã€‚

æ–°å¢ `app/views/posts/like.js.erb`

```
str = "<%=j render :partial => "like", :locals => { :post => @post } %>";
$("#post-like-<%= @post.id %>").html(str);
```

æµ‹è¯•çœ‹çœ‹ï¼Œç°åœ¨å¯ä»¥ç¥é€ŸæŒ‰è®šäº†ã€‚

# 2-11 æ˜¾ç¤ºå’Œæ›´æ–°å¤šå°‘äººæŒ‰è®š

æ¥ä¸‹æ¥æˆ‘ä»¬æƒ³é¢å¤–åœ¨ç”»é¢ä¸Šæ˜¾ç¤ºæ€»å…±æœ‰å¤šå°‘äººæŒ‰è®šï¼Œåƒè¿™æ ·ï¼š

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/Q7XdZvNSTFue1STvg67N_22.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/Q7XdZvNSTFue1STvg67N_22.png)

ç¼–è¾‘ `app/views/posts/_post.html.erb`

```
   <div class="panel-body">
+    <span id="post-thumbsup-<%= post.id %>" class="label label-success"><%= post.likes.count %> ğŸ‘</span>
```

ä¿®æ”¹ `app/views/posts/like.js.erb` é™¤äº†æ›¿æ¢æŒ‰è®šçš„åŒºå—ï¼Œä¹Ÿéœ€è¦åŒæ—¶æ›´æ–°ä¸Šè¿°çš„ ğŸ‘ æ•°é‡ï¼š

```
   str = "<%=j render :partial => "like", :locals => { :post => @post } %>";
   $("#post-like-<%= @post.id %>").html(str);

+  $("#post-thumbsup-<%= @post.id %>").html("<%= @post.likes.count %>" + " ğŸ‘");
```

è¿™æ ·å°±å¯ä»¥åŒæ—¶æ›´æ–° HTML ä¸Šçš„ä¸¤ä¸ªåœ°æ–¹ã€‚

# 2-12 Ajax å°ç»“

Ajax æ˜¯ä¸€ç§å¢å¼º UI çš„æ–¹å¼ï¼Œæˆ‘ä»¬ä¼šå…ˆæŠŠåŸºæœ¬åŠŸèƒ½å®Œæˆï¼Œå†æ ¹æ®éœ€è¦æ”¹æˆ Ajax æ•ˆæœã€‚

è¿™ä¸€ç« ç»ƒä¹ äº†åˆ é™¤ã€æŒ‰è®šã€æ–°å¢è´´æ–‡ï¼Œç”»é¢ä¸Šæ¯”è¾ƒå•çº¯çš„æŒ‰é’®å‹æ“ä½œï¼Œæœ€é€‚åˆç”¨ Ajax æ•ˆæœï¼Œä¾‹å¦‚åˆ é™¤ã€æŒ‰è®šã€æ”¶è—ã€åŠ å…¥è´­ç‰©è½¦ç­‰ç­‰ã€‚
å¦‚æœæ˜¯æ¯”è¾ƒå¤æ‚çš„å¡«è¡¨å•æ“ä½œï¼Œè¦åš Ajax æ•ˆæœå°±ä¼šæ¯”è¾ƒè´¹å·¥ï¼Œå› ä¸ºéœ€è¦è€ƒè™‘é”™è¯¯å¤„ç†(å‚¨å­˜å¤±è´¥)çš„æƒ…å†µã€‚

Rails å†…å»ºé€è¿‡ `:remote => true` çš„æ–¹å¼ï¼Œå°±å¯ä»¥å¾ˆå¿«åˆ¶ä½œå‡º Ajax æ•ˆæœã€‚
å†ç¨åçš„ç« èŠ‚ä¸­ï¼Œæˆ‘ä»¬ä¼šç¤ºèŒƒè¿›é˜¶çš„ç”¨æ³•ï¼šåœ¨ä¸€äº›æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¿…é¡»æ‰‹å†™ jQuery å»ç»‘äº‹ä»¶é€ Ajaxï¼Œå–å¾— JSON å›ä¼ å¹¶æ›´æ–° DOMã€‚

### æœ¬èŠ‚ä½œä¸š

##### [Ajax ä½œä¸š](https://fullstack.xinshengdaxue.com/assignments/43)ï¼š[ä½œä¸šä¸€](https://fullstack.xinshengdaxue.com/tasks/285)

å·²æœ‰ 51 ä¸ªç¬¬ä¸€æœŸåŒå­¦æäº¤äº†è¿™ä¸ªä½œä¸š [**çœ‹çœ‹åŒå­¦æ€ä¹ˆåš](https://fullstack.xinshengdaxue.com/tasks/285/other_answers?order=recent)

[**æäº¤ä½œä¸š](https://fullstack.xinshengdaxue.com/tasks/285)

è¯·å°†å®Œæˆçš„è´´æ–‡æ–°å¢ã€åˆ é™¤å’ŒæŒ‰è®šç”»é¢ï¼Œç”¨ gif æˆªå›¾ä¸Šæ¥ã€‚

##### [Ajax ä½œä¸š](https://fullstack.xinshengdaxue.com/assignments/43)ï¼š[ä½œä¸šäºŒ: åŠ å…¥è´­ç‰©è½¦](https://fullstack.xinshengdaxue.com/tasks/286)

å·²æœ‰ 31 ä¸ªç¬¬ä¸€æœŸåŒå­¦æäº¤äº†è¿™ä¸ªä½œä¸š [**çœ‹çœ‹åŒå­¦æ€ä¹ˆåš](https://fullstack.xinshengdaxue.com/tasks/286/other_answers?order=recent)

[**æäº¤ä½œä¸š](https://fullstack.xinshengdaxue.com/tasks/286)

è¯·å›å¤´å°† jdstore å•†åº—çš„åŠ å…¥è´­ç‰©è½¦åŠŸèƒ½ï¼Œæ”¹é€ æˆ Ajax æ•ˆæœ

##### [Ajax ä½œä¸š](https://fullstack.xinshengdaxue.com/assignments/43)ï¼š[ä½œä¸šä¸‰: åŠ å…¥æ”¶è—](https://fullstack.xinshengdaxue.com/tasks/287)

å·²æœ‰ 39 ä¸ªç¬¬ä¸€æœŸåŒå­¦æäº¤äº†è¿™ä¸ªä½œä¸š [**çœ‹çœ‹åŒå­¦æ€ä¹ˆåš](https://fullstack.xinshengdaxue.com/tasks/287/other_answers?order=recent)

[**æäº¤ä½œä¸š](https://fullstack.xinshengdaxue.com/tasks/287)

ç”¨æˆ·å¯ä»¥ç‚¹ â¤ æ”¶è—è´´æ–‡ï¼Œå¹¶ä¸”ç”¨ Ajax æ•ˆæœæ”¹è¿› UIã€‚

# 3-1 Turbolinks å‘

[Turbolinks](https://github.com/turbolinks/turbolinks) æ˜¯ä¸€ä¸ª Rails å†…å»ºçš„é¡µé¢åŠ é€Ÿå·¥å…·ï¼Œåœ¨ `Gemfile` å’Œ `application.js` å¯ä»¥å‘ç°å®ƒçš„è¸ªè¿¹ã€‚è¿™æ˜¯ä¸€ä¸ª Javascript å¥—ä»¶ä¼šåœ¨æ¢é¡µçš„æ—¶å€™ï¼Œä¸é‡æ–°è½½å…¥ HTML çš„ `head`ï¼Œåªè½½å…¥æ–°çš„ `body`ï¼Œæ¥åŠ é€Ÿæ¢é¡µã€‚

è™½ç„¶æœ‰åŠ é€Ÿçš„æ•ˆæœï¼Œä½†æ˜¯å´å¾ˆå¹²æ‰°å…¶ä»– `javascript` æºç çš„è½½å…¥ï¼š

#### ç¬¬ä¸€ä¸ªå‘

ç½‘ä¸Šæ‰€æœ‰ jQuery çš„æ•™å­¦æ–‡ç« ï¼Œéƒ½æ˜¯ç”¨`$(document).ready(function(){...})` æˆ–`$(function(){...})`ï¼Œåœ¨ HTML è½½å…¥å®Œæ¯•åæ‰§è¡Œ js æºç ã€‚ä½†æ˜¯ç”¨äº† Turbolink åªä¼šè§¦å‘ç¬¬ä¸€æ¬¡è€Œå·²ï¼Œæ¢é¡µæ—¶ä¸ä¼šå†æ‰§è¡Œã€‚

åœ¨ 1-4 ä¸­æˆ‘ä»¬ç¤ºèŒƒäº† `$(document).ready` ç”¨æ³•ï¼Œå¦‚æœä½ ç‚¹è¶…è¿ç»“å»åˆ«çš„é¡µé¢ï¼Œç„¶åå†ç‚¹å›æ¥ï¼Œä¼šå‘ç°é‚£æ®µ JavaScript å°±ä¸ä¼šæ‰§è¡Œäº†ã€‚

è§£æ³•ï¼šæœ‰ç”¨åˆ° `$(document).ready(function(){...})` çš„åœ°æ–¹éƒ½è¦æ”¹æˆç”¨ `$(document).on("turbolinks:load", function(){...})`

#### ç¬¬äºŒä¸ªå‘

å•é¡µ(page-specific)æ‰ç”¨åˆ°çš„ javascript ä»£ç ï¼Œå¦‚æœå†™åœ¨ `body` é‡Œé¢ï¼Œè·³é¡µå›æ¥æ—¶ï¼Œä¼šè§¦å‘ä¸¤æ¬¡ã€‚æŸäº› js code é‡å¤æ‰§è¡Œä¸¤æ¬¡æ²¡å…³ç³»ï¼Œä½†æœ‰äº›ä¼šæœ‰é—®é¢˜ã€‚

è§£æ³•ä¸€ï¼šå…³æ‰ Turbolinks çš„ç¼“å­˜åŠŸèƒ½ï¼ŒæŠŠ `<meta name="turbolinks-cache-control" content="no-cache">` æ”¾åˆ° layout çš„ `head` é‡Œé¢ã€‚

è§£æ³•äºŒï¼šæŠŠlayout çš„`<body>` æ”¹æˆ`<body id="<%= "#{controller_name}-#{action_name}"%>">`ï¼Œè¿™æ ·å°±å¯ä»¥åœ¨å…¨å±€è½½å…¥çš„`application.js` ä¸­æŒ‡å®šåªæœ‰è¿™ä¸€é¡µæ‰æ‰§è¡Œçš„js codeï¼Œä¾‹å¦‚ï¼š

```
  $(document).on("turbolinks:load", function() {
    if ( $("#products-show").length > 0 ) {
      console.log("product-show");
    }
  })
```

å¦‚æœåŒå­¦ä»¬è¿˜æ²¡æœ‰å†™åˆ° jQuery æ•ˆæœæˆ–ç”¨åˆ° jQuery Plugins çš„è¯ï¼Œå¯èƒ½è¿˜æ²¡æ„Ÿè§‰ã€‚

å¦‚æœä½ ä¸æƒ³å¤„ç†æˆ–æ— æ³•ç†è§£è¿™ä¸¤ä¸ªå‘çš„åŸå› ï¼Œæˆ‘å»ºè®®ä½ æ‹†é™¤ Turbolinks æ¥å›é¿è¿™äº›å‘ã€‚

# 3-2 æ‹†é™¤ Turbolinks

å¦‚æœä½ çš„ JavaScript æœ‰ä»¥ä¸‹ç—‡çŠ¶ï¼š

ç—‡çŠ¶ä¸€: é‡æ–°æ•´ç† JavaScript å°±æ­£å¸¸ï¼Œç‚¹åˆ«é¡µå†ç‚¹å›æ¥ï¼Œå°±ä¸æ­£å¸¸(æ²¡åŠ è½½æ‰§è¡Œæˆ–é‡å¤æ‰§è¡Œä¸¤é)

ç—‡çŠ¶äºŒ: ç…§ã€ŒRefactor & æ•ˆèƒ½æå‡ã€æ•™ç¨‹ï¼ŒæŠŠ[å°† CSS æ”¾åœ¨æœ€é¡¶å±‚ï¼Œå°† JavaScript æ”¾åœ¨æœ€åº•å±‚](https://fullstack.xinshengdaxue.com/posts/731)çš„è¯ï¼Œè¿™ä¼šè·Ÿ Turbolinks çš„è®¾è®¡å†²çªã€‚é€ æˆå¦‚[è¿™ç¯‡è®¨è®º](https://forum.qzy.camp/t/turbolink-js/1016)çš„é—®é¢˜ï¼šé‡æ–°æ•´ç†åï¼ŒJavaScript ä¼šä¸æ­£å¸¸ã€‚

è¯·è¿›è¡Œæ‹†é™¤ Turbolinks çš„æ­¥éª¤ï¼š

ä¿®æ”¹ `Gemfile`ï¼Œæ‹¿æ‰ turbolinksï¼š

Gemfile

```
-  # Turbolinks makes navigating your web application faster. Read more: https://github.com/turbolinks/turbolinks
-  gem 'turbolinks', '~> 5'
```

ä¿®æ”¹ `app/assets/javascripts/application.js`ï¼Œæ‹¿æ‰ turbolinks çš„åŠ è½½ï¼š

app/assets/javascripts/application.js

```
-  //= require turbolinks
```

ä¿®æ”¹ `app/views/layout/application.html.erb`ï¼Œæ‹¿æ‰ turbolinks å±æ€§ï¼š

app/views/layout/application.html.erb

```
-  <%= javascript_include_tag 'application', 'data-turbolinks-track': 'reload' %>
+  <%= javascript_include_tag 'application' %>
```

æ‰§è¡Œ `bundle`ï¼Œé‡å¯æœåŠ¡å™¨ã€‚

# 4-1 å‰è¨€

è¿™ä¸€ç« å°†ç¤ºèŒƒç›´æ¥ç”¨ jQuery çš„ Ajax åŠŸèƒ½ï¼Œè€Œä¸ä½¿ç”¨ Rails çš„ `:remote => true` æ–¹æ³•æ¥åš Ajax æ•ˆæœã€‚

è¿™æ˜¯å› ä¸º Rails çš„ `:remote => true` åŠŸèƒ½åªèƒ½æ”¾åœ¨è¶…è¿ç»“æˆ–è¡¨å•ä¸Šï¼Œå› æ­¤ä¸å±äºè¿™ä¸¤ç§æƒ…å½¢çš„éœ€æ±‚ï¼Œå°±éœ€è¦è‡ªè¡Œç»‘äº‹ä»¶ä¸Šå»ï¼Œè§¦å‘æ—¶é€ Ajax Request åˆ°æœåŠ¡å™¨ã€‚

è¿™ä¸€ç« å°†ç¤ºèŒƒï¼š

- å°†åˆ é™¤æ”¹æˆè‡ªè¡Œç»‘äº‹ä»¶
- è´´æ–‡æ— é™æ²è½´
- ä½¿ç”¨æ ¸é€‰æ–¹å—(checkbox)åšå¼€å…³
- ä½¿ç”¨ä¸‹æ‹‰é€‰å•(select)åˆ†ç±»è´´æ–‡

å¦å¤–ï¼Œæ­é… jQuery Plugin çš„è¯ï¼Œä¹Ÿå¿…é¡»è‡ªå·±å†™ Ajax ä»£ç ã€‚è¿™ç« æœ€åä¹Ÿä¼šç¤ºèŒƒä½¿ç”¨ jQuery Raty - A Star Rating Plugin æ¥åšè¯„ç­‰ã€‚

# 4-2 æŠŠåˆ é™¤æ”¹æˆè‡ªè¡Œç»‘äº‹ä»¶

ä¸Šä¸€ç« æˆ‘ä»¬ç”¨ Rails å†…å»ºçš„ `:remote => true` æ¥å¸®æˆ‘ä»¬é€ Ajaxï¼Œè¿™èƒŒåçš„åŸç†å…¶å®å°±æ˜¯è‡ªå·±å»ç»‘å®šäº‹ä»¶ï¼Œç„¶åé€ Ajaxã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬æ¥æ”¹å†™çœ‹çœ‹å¦‚ä½•è‡ªè¡Œç»‘äº‹ä»¶é€ Ajaxï¼Œé¦–å…ˆä¿®æ”¹ `_post.html.erb`ï¼Œåˆ æ‰æœ¬æ¥çš„ :method å’Œ :remote è¡Œä¸ºï¼Œè¡¥ä¸Šä¸€ä¸ª delete-post class è®©æˆ‘ä»¬ç­‰ä¼šç»‘äº‹ä»¶ä¸Šå»ï¼š

app/views/posts/_post.html.erb

```
- <%= link_to "Delete", post_path(post), :method => :delete, :class => "btn btn-danger", :remote => true %>
+ <%= link_to "Delete", post_path(post), :class => "delete-post btn btn-danger" %>
```

ç„¶ååœ¨ `app/views/posts/index.html.erb` ä¸‹æ–¹åŠ å…¥ï¼š

app/views/posts/index.html.erb

```
+  <script>
+   // è¿™ä¼šç»‘ click äº‹ä»¶åˆ°æ‰€æœ‰æœ‰ `.delete-post` class çš„å…ƒç´ ä¸Šï¼Œä¹Ÿå°±æ˜¯æ‰€æœ‰çš„åˆ é™¤æŒ‰é’®
+   $(".delete-post").click(function(evt){
+     // `evt` æ˜¯æµè§ˆå™¨çš„äº‹ä»¶ç‰©ä»¶ï¼Œevt.preventDefault(); ä¼šç»ˆæ­¢è¿™ä¸ªå…ƒç´ çš„é»˜è®¤è¡Œä¸ºï¼š
+     // è¶…è¿ç»“ a çš„é»˜è®¤è¡Œä¸ºæ˜¯è·³åˆ°ä¸‹ä¸€é¡µï¼Œå¦‚æœæ²¡æœ‰è¿™è¡Œçš„è¯ï¼Œé€å‡º ajax åä¼šè·³å» show page
+     evt.preventDefault();
+     // this æ˜¯ä¸ªç‰¹åˆ«çš„å˜é‡ï¼Œä»£è¡¨è§¦å‘äº‹ä»¶çš„å…ƒç´ ã€‚ä½¿ç”¨ attr å¯ä»¥è¯»å–å…ƒç´ çš„å±æ€§ï¼Œè¿™é‡Œè¦æ‹¿åˆ°è¶…è¿ç»“çš„ç½‘å€
+     var url = $(this).attr("href");
+
+     // é€å‡º Ajax
+     $.ajax({
+       url: url,
+       method: 'DELETE',
+       dataType: 'script' // è¦æ±‚æœåŠ¡å™¨å›ä¼  javascript
+     })
+   })
+  </script>
```

ä¸€ä½†éœ€è¦è‡ªå·±åœ¨å‰ç«¯ç»‘äº‹ä»¶ï¼Œå°±ä¼šè§‰å¾—æŠŠ JavaScript ä»£ç é›†ä¸­åœ¨å‰ç«¯çš„è¯ï¼Œè´£ä»»åŒºåˆ†ä¼šæ¯”è¾ƒæ¸…æ¥šã€‚å› æ­¤æˆ‘ä»¬æ¥æ”¹æˆç”¨ JSON æ ¼å¼å§ï¼ŒæŠŠ `dataType` æ”¹æˆ JSONï¼Œç„¶ååŠ ä¸€ä¸ª success çš„å›å‘¼ï¼ŒæœåŠ¡å™¨å›ä¼ èµ„æ–™åï¼Œå°±ä¼šè§¦å‘ success çš„å‡½å¼ï¼š

app/views/posts/index.html.erb

```
  <script>
    $(".delete-post").click(function(evt){
      evt.preventDefault();
      var url = $(this).attr("href");

      // é€å‡º Ajax
      $.ajax({
        url: url,
        method: 'DELETE',
-       dataType: 'script'
+       dataType: 'json', // è¦æ±‚æœåŠ¡å™¨å›ä¼  json
+       success: function(data){   // data å°±æ˜¯æœåŠ¡å™¨å›ä¼ çš„ JSON èµ„æ–™
+         $("#post-" + data["id"]).remove();
+       }
      })
    })
  </script>
```

ä¿®æ”¹ `app/controllers/posts_controller.rb` æ”¹æˆç›´æ¥å›ä¼  JSON

app/controllers/posts_controller.rb

```
   def destroy
     @post = current_user.posts.find(params[:id])
     @post.destroy

+    render :json => { :id => @post.id }
   end
```

æ¥ç€åˆ é™¤ `app/views/posts/destroy.js.erb` æ ·æ¿ï¼Œæˆ‘ä»¬ä¸éœ€è¦ Remote JavaScript äº†ã€‚

å¦‚æœå›¢é˜Ÿä¸­æœ‰ä¸“é—¨çš„å‰ç«¯å·¥ç¨‹å¸ˆï¼Œä¹Ÿä¼šåå¥½è¿™ç§æ–¹å¼ã€‚è¿™æ ·å‰åç«¯çš„å·¥ä½œå¯ä»¥æ‹†åˆ†çš„æ¯”è¾ƒæ¸…æ¥šã€‚
åç«¯å¤„ç†æ•°æ®åº“å’Œå›ä¼  JSON èµ„æ–™å³å¯ï¼Œé¡µé¢æ€ä¹ˆå˜åŒ–å…¨ç”±å‰ç«¯å·¥ç¨‹å¸ˆè´Ÿè´£ã€‚

# 4-3 è´´æ–‡æ— é™æ²è½´

ç›®æ ‡ï¼šå®ä½œè´´æ–‡çš„æ— é™æ²è½´ (Endless Page)ï¼Œå½“ç”¨æˆ·æ²åˆ°ç”»é¢æœ€ä¸‹æ–¹æ—¶ï¼Œè‡ªåŠ¨åŠ è½½æ›´æ—©çš„èµ„æ–™ã€‚

è¿™ä¸ªä»»åŠ¡éœ€è¦ä¾¦æµ‹æµè§ˆå™¨æ²è½´çš„è¡Œä¸ºï¼Œæ²¡åŠæ³•ç”¨ `:remote => true` äº†ï¼Œéœ€è¦è‡ªå·±å»ç»‘å®šäº‹ä»¶ï¼Œä¾¦æµ‹ç”¨æˆ·æ²åˆ°è§†çª—æœ€ä¸‹é¢ã€‚

ç¼–è¾‘`app/views/posts/index.html.erb`

app/views/posts/index.html.erb

```
  <script>
+  // è®°ä¸‹ç›®å‰ç”»é¢æœ€å°çš„è´´æ–‡ ID
+  var current_post_id = <%= @posts.last.id %>;
+
+  // å½“æ²è½´åŠ¨çš„æ—¶å€™ï¼Œä¼šè§¦å‘è¿™ä¸ªäº‹ä»¶
+  $(window).scroll(function(){
+    // å½“æ²åˆ°æœ€ä¸‹é¢çš„æ—¶å€™
+    if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight) {
+      var url = "/posts?max_id=" + current_post_id;
+      if (url) {
+        $.ajax({
+          method: "GET",
+          url: url,
+          dataType: "script"
+        })
+      } else {
+        console.log("data ended")
+      }
+    }
+  })
  </script>
```

ä¿®æ”¹ `app/controllers/posts_controller.rb`ï¼Œè·Ÿä¹‹å‰åšåˆ†é¡µä¸€æ ·ï¼Œæˆ‘ä»¬ç»§ç»­æ²¿ç”¨äº† index actionï¼Œåªæ˜¯ä¼šæ ¹æ® `params[:max_id]` å›ä¼ æ›´æ—©çš„èµ„æ–™ï¼š

app/controllers/posts_controller.rb

```
   def index
-    @posts = Post.order("id DESC").all
+    @posts = Post.order("id DESC").limit(20)
+
+    if params[:max_id]
+      @posts = @posts.where( "id < ?", params[:max_id])
+    end
+
+    respond_to do |format|
+      format.html  # å¦‚æœå®¢æˆ·ç«¯è¦æ±‚ HTMLï¼Œåˆ™å›ä¼  index.html.erb
+      format.js    # å¦‚æœå®¢æˆ·ç«¯è¦æ±‚ JavaScriptï¼Œå›ä¼  index.js.erb
+    end
   end
```

`respond_to` å¯ä»¥è®© Rails æ ¹æ® request è¯·æ±‚çš„æ ¼å¼(åœ¨ $ajax ä¸­æˆ‘ä»¬æœ‰æŒ‡å®šäº† dataType)ï¼Œæ¥å›ä¼ ä¸åŒæ ¼å¼ã€‚

æ–°å¢ `app/views/posts/index.js.erb`

```
<% @posts.each do |post| %>
  $("#post-list").append("<hr>")
  $("#post-list").append("<%=j render :partial => "post", :locals => { :post => post } %>");
<% end %>

<% if @posts.any? %>
var current_post_id = <%= @posts.last.id %>;
<% end %>
```

è¿™æ ·ç”»é¢æ²åˆ°æœ€ä¸‹æ–¹æ—¶ï¼Œå°±ä¼šè‡ªåŠ¨åŠ è½½ï¼Œå¹¶ä¸”æ›´æ–° `current_post_id` çš„å€¼ï¼Œè¿™æ ·ä¸‹æ¬¡å†æŠ“å°±ä¼šæŠ“åˆ°æ›´æ—©çš„èµ„æ–™ã€‚

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/DUUZhNl4QhGQ2m9qFxFN_endless-page.gif)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/DUUZhNl4QhGQ2m9qFxFN_endless-page.gif)

# 4-4 ä½¿ç”¨æ ¸é€‰æ–¹å—(checkbox)åšå¼€å…³

ç›®æ ‡ï¼šåšä¸€ä¸ªå‹¾é€‰çš„æ ¸é€‰æ–¹å—ï¼Œç®¡ç†å‘˜å¯ä»¥æ‰“å‹¾æ ‡è®°æˆåƒåœ¾ã€‚

æ‰§è¡Œ `rails g migration add_flag_to_posts`

ç¼–è¾‘ `db/migrate/201704XXXXXXXX_add_flag_to_posts.rb`

201704XXXXXXXX_add_flag_to_posts.rb

```
 class AddFlagToPosts < ActiveRecord::Migration[5.0]
   def change
+    add_column :users, :role, :string
+    add_column :posts, :flag_at, :datetime
   end
 end
```

æ‰§è¡Œ `rake db:migrate`

ç¼–è¾‘ `app/models/user.rb`

app/models/user.rb

```
+  def is_admin?
+    role == "admin"
+  end
```

æ‰§è¡Œ `rails console` æ–°å¢ä¸€ä¸ªç®¡ç†å‘˜å¸å·

```
 User.create!( :email => "admin@example.org", :password => "123456", :role => "admin" )
```

ç„¶åæ”¹ç”¨è¿™ä¸ªå¸å·ç™»å…¥ã€‚

ç¼–è¾‘ `config/routes.rb` æ–°å¢ä¸€ä¸ª `toggle_flag` è·¯ç”±ï¼š

config/routes.rb

```
   resources :posts do
     member do
       post "like" => "posts#like"
       post "unlike" => "posts#unlike"
+      post "toggle_flag" => "posts#toggle_flag"
     end
   end
```

ç¼–è¾‘ `app/views/posts/_post.html.erb` åŠ ä¸Š checkbox æ ¸é€‰æ–¹å—ï¼Œä»¥åŠæ˜¾ç¤ºæ ‡è®°æ—¶é—´ï¼š

app/views/posts/_post.html.erb

```
  <div class="panel-body">
    # (ç•¥)
  </div>

+  <div class="panel-footer">
+    <% if current_user && current_user.is_admin? %>
+      <label>
+      <%= check_box_tag "mark_flag[#{post.id}]", 1, post.flag_at.present?,
+            :data => { :url => toggle_flag_post_path(post) }, :class => "toggle-flag" %> æ ‡è®°ä¸ºåƒåœ¾
+        <span id="post-flag-<%= post.id %>"><%= post.flag_at %></span>
+      </label>
+    <% end %>
+  </div>
```

ç¼–è¾‘ `app/views/posts/index.html.erb` ç»‘ä¸Š click äº‹ä»¶é€å‡º Ajax è¯·æ±‚ï¼š

app/views/posts/index.html.erb

```
   <script>
+  $(".toggle-flag").on('change', function(){
+    var url = $(this).data("url");
+
+    $.ajax({
+      url: url,
+      method: "POST",
+      dataType: "json",
+      success: function(data){
+        if ( data["flag_at"] ) {
+          $("#post-flag-" + data["id"]).html(data["flag_at"]);
+        } else {
+          $("#post-flag-" + data["id"]).html("");
+        }
+      }
+    });
+  });
   </script>
```

è§£è¯´:

- `$("XXXX").on` æ˜¯ç»‘äº‹ä»¶çš„è¯­æ³•ï¼Œä¹‹å‰å­¦è¿‡çš„ `$("XXX").click(function(){...}` å¯ä»¥æ”¹å†™æˆ `$("XXX").on("click", function(){...})` æ˜¯ä¸€æ ·çš„ã€‚è¿™é‡Œç”¨çš„äº‹ä»¶åç§°æ˜¯ `change`ï¼Œè¡¨ç¤ºè¾“å…¥æ¡†æœ‰å˜åŠ¨çš„è¯ï¼Œå°±ä¼šè§¦å‘ã€‚
- åœ¨ HTML å…ƒç´ å±æ€§ä¸Šçš„ `data-XXX`ï¼Œåœ¨ jQuery ä¸­å¯ä»¥ç”¨ `.data("XXX")` å»è¯»å–åˆ°å®ƒçš„å€¼

æœ€åç¼–è¾‘ `app/controllers/posts_controller.rb` æ–°å¢ä¸€ä¸ª toggle_flag action æ¥æ”¶å¤„ç†ï¼š

app/controllers/posts_controller.rb

```
+  def toggle_flag
+    @post = Post.find(params[:id])
+
+    if @post.flag_at
+      @post.flag_at = nil
+    else
+      @post.flag_at = Time.now
+    end
+
+    @post.save!
+
+    render :json => { :message => "ok", :flag_at => @post.flag_at, :id => @post.id }
+  end
```

æœ€åæˆæœï¼š

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/m2mG2tXHQgqSgNClVM0X_ajax-checkbox.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/m2mG2tXHQgqSgNClVM0X_ajax-checkbox.png)



# 4-5 æµè§ˆå™¨ Bubble Up äº‹ä»¶æ¨¡å‹

å‰è¿°çš„åˆ é™¤å’Œæ‰“å‹¾çš„ä¾‹å­ï¼Œæœ‰ä¸ªå¤§ Bugï¼Œå°±æ˜¯åˆšæ–°å¢çš„è´´æ–‡æ²¡ä½œç”¨ã€‚ä½ å¯ä»¥è¯•è¯•çœ‹å…ˆæ–°å¢ä¸€ç¬”è´´æ–‡ï¼Œç„¶åç‚¹ç‚¹çœ‹åˆ é™¤å’Œæ‰“å‹¾ï¼Œä¼šå‘ç°ç«Ÿç„¶æ²¡ä½œç”¨ã€‚

è¿™æ˜¯æ€ä¹ˆå›äº‹å‘¢? è¿™æ˜¯å› ä¸ºæµè§ˆå™¨å¹¶ä¸ä¼šä¸ºæ–°å¢çš„å…ƒç´ è‡ªåŠ¨ç»‘äº‹ä»¶ä¸Šå»ã€‚æ‰€ä»¥åæ¥ Ajax æ–°å¢ä¸Šå»çš„è´´æ–‡æ˜¯æ²¡æœ‰äº‹ä»¶çš„ã€‚

é‚£è¦æ€ä¹ˆè§£å†³å‘¢? æˆ‘ä»¬éœ€è¦äº†è§£ä¸€ä¸‹æµè§ˆå™¨çš„äº‹ä»¶æœºåˆ¶ï¼Œå‡è®¾æœ‰ä»¥ä¸‹ HTML:

```
<body>
  <div>
     <p>
        <a>XXX</a>
     </p>
  </div>
</body>
```

å½“æˆ‘ä»¬ click ç‚¹å‡» XXX æ—¶ï¼Œæµè§ˆå™¨ä¸åªä¼šè§¦å‘ a å…ƒç´ çš„ click äº‹ä»¶ï¼Œä¹Ÿä¼šå¾€å¤–å±‚ä¸€è·¯è§¦å‘ï¼ŒåŒ…æ‹¬ p çš„ click äº‹ä»¶ã€div çš„ click äº‹ä»¶ã€body çš„ click äº‹ä»¶ã€‚è¿™å«åš Bubble Up äº‹ä»¶æ¨¡å‹ã€‚

äº†è§£è¿™ä¸ªæ¨¡å‹ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥å°†äº‹ä»¶ç»‘åœ¨å¯é çš„ä¸Šä¸€å±‚å…ƒç´ ä¸Šï¼Œè¿™é‡Œä¹Ÿå°±æ˜¯ #post-list çš„ div ä¸Šï¼Œåæ­£ç‚¹å‡»é‡Œé¢çš„å…ƒç´ ï¼Œæœ€ç»ˆéƒ½ä¼š Bubble Up ä¸Šæ¥è§¦å‘ã€‚

è¯·ä¿®æ”¹ `app/views/posts/index.html.erb`

app/views/posts/index.html.erb

```
-  $(".delete-post").click(function(evt){
+  $("#post-list").on('click', ".delete-post", function(evt){

   // ç•¥

-  $(".toggle-flag").on('change', function(){
+  $("#post-list").on('change', ".toggle-flag", function(){`
```

ä¸€æ ·æ˜¯ç”¨ `on` è¯­æ³•ï¼Œä½†æ˜¯æ”¹æˆç»‘åœ¨ `#post-list` ä¸Šï¼Œä»¥åŠé‡ç‚¹æ˜¯å¤šäº†ç¬¬äºŒä¸ªå‚æ•°å¯ä»¥è¿‡æ»¤å‡ºçœŸæ­£è§¦å‘çš„å…ƒç´ ï¼Œåœ¨è¿™é‡Œä¹Ÿå°±æ˜¯ `.delete-post` å’Œ `.toggle-flag`ã€‚

# 4-6 ä½¿ç”¨ jQuery Traversing èµ°è®¿å…ƒç´ 

ä¸Šè¿°çš„èŒƒä¾‹ä¸­ï¼Œæœ‰ç”¨åˆ° `this` å¯ä»¥çŸ¥é“æ˜¯å“ªä¸€ä¸ªå…ƒç´ è¢«ç‚¹å‡»äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬æ‰å¯ä»¥ç”¨ `$(this).data("url")`å»è¯»å–åˆ°è¯¥å…ƒç´ çš„ data å±æ€§ã€‚

æ—¢ç„¶å·²ç»çŸ¥é“æ˜¯å“ªä¸€ä¸ªå…ƒç´ è¢«ç‚¹å‡»äº†ï¼Œé‚£å…¶å®å¯ä»¥åˆ©ç”¨ jQuery çš„ [Traversing](https://api.jquery.com/category/traversing/) APIï¼Œå°±å¯ä»¥è¿›è¡Œå®šä½ï¼š

ä¾‹å¦‚æˆ‘ä»¬å¯ä»¥è¿™æ ·ä¿®æ”¹åˆ é™¤ï¼š

app/views/posts/index.html.erb

```
  $("#post-list").on('click', ".delete-post",function(evt){
    evt.preventDefault();
    var url = $(this).attr("href");
+   var that = this;

    $.ajax({
      url: url,
      method: 'DELETE',
      dataType: 'json',
      success: function(data){
-       $("#post-" + data["id"]).remove();
+       $(that).closest(".panel").remove();
      }
    })
    //return false;
  })
```

è§£è¯´ï¼š

- ç”±äº success æ˜¯ä¸ªå¼‚æ­¥çš„å›å‘¼ï¼Œé‡Œé¢çš„ `this` ä¸ç­‰åŒäºå¤–å±‚çš„ `this`ã€‚æ‰€ä»¥æˆ‘ä»¬å¾—å…ˆåœ¨å¤–å±‚è®°ä¸‹ `that` æ˜¯è§¦å‘äº‹ä»¶çš„å…ƒç´ ã€‚
- `closest` ä¼šæ‰¾æœ€è¿‘çš„ä¸Šä¸€å±‚å…ƒç´ ï¼Œè¿™é‡Œå°±ä¼šæ‰¾åˆ°åŒ…ä½æ•´ä¸ªè´´æ–‡çš„ class æ˜¯ panel çš„ div åŒºå—ã€‚

ç»§ç»­ä¿®æ”¹ checkbox å¼€å…³ï¼š

app/views/posts/index.html.erb

```
  $("#post-list").on('change', ".toggle_flag",function(){
    var url = $(this).data("url");
+   var that = this;

    $.ajax({
      url: url,
      method: "POST",
      dataType: "json",
      success: function(data){
        if ( data["flag_at"] ) {
-         $("#post-flag-" + data["id"]).html(data["flag_at"]);
+         $(that).closest("label").find("span").html(data["flag_at"]);
        } else {
-         $("#post-flag-" + data["id"]).html("");
+         $(that).closest("label").find("span").html("");
        }
      }
    });
  });
```

è§£è¯´ï¼š

`find` ä¼šæ‰¾ä¸‹å±‚çš„å…ƒç´ ã€‚ä¸€ä¸ªå¸¸è§çš„æŠ€å·§æ˜¯ï¼Œå…ˆå¾€ä¸Šå±‚æ‰¾åˆ°å…±åŒçš„ç¥–å…ˆæ˜¯`label`ï¼Œç„¶åå¾€é‡Œå±‚æ‰¾ç›®æ ‡`span`ã€‚

è¿™æ ·åšçš„å¥½å¤„æ˜¯ä»€ä¹ˆå‘¢? è¿™æ ·å†™æˆ‘ä»¬å°±ä¸éœ€è¦é¢å¤–å¡ post id åˆ° div ä¸Šæ¥å®šä½äº†ã€‚é€è¿‡ç‚¹å‡»çš„å…ƒç´ ï¼Œæˆ‘ä»¬å°±å¯ä»¥èµ°è®¿åˆ°è¦æ“ä½œçš„ DOM ä¸Šã€‚

# 4-7 ä½¿ç”¨ä¸‹æ‹‰é€‰å•(select)åˆ†ç±»è´´æ–‡

ç›®æ ‡ï¼šåšä¸€ä¸ªä¸‹æ‹‰é€‰å•å¯ä»¥åˆ†ç±»ï¼Œé€‰äº†å°±ç«‹å³ç”Ÿæ•ˆï¼Œä¸éœ€è¦å†ç‚¹é€å‡º

è®©æˆ‘ä»¬äº§ç”Ÿä¸€ä¸ªåˆ†ç±» Category modelï¼Œè®© Post è´´æ–‡å±äºä¸€ç§åˆ†ç±»ï¼š

æ‰§è¡Œ `rails g model category`

ç¼–è¾‘ `db/migrate/201704XXXXXXXX_create_categories.rb`

db/migrate/201704XXXXXXXX_create_categories.rb

```
 class CreateCategories < ActiveRecord::Migration[5.0]
    def change
      create_table :categories do |t|
+       t.string :name
        t.timestamps
      end

+     add_column :posts, :category_id, :integer
+     add_index :posts, :category_id
    end
  end
```

æ‰§è¡Œ `rake db:migrate`

ç¼–è¾‘ `app/models/post.rb`

app/models/post.rb

```
  class Post < ApplicationRecord
+   belongs_to :category, :optional => true

    # (ç•¥)
  end
```

ç¼–è¾‘ `app/models/category.rb`

app/models/category.rb

```
  class Category < ApplicationRecord

+   has_many :posts

  end
```

æ‰§è¡Œ `rails c` æ–°å¢ä¸€äº›åˆ†ç±»èµ„æ–™ï¼š

```
 Category.create!( :name => "Ruby" )
 Category.create!( :name => "JavaScript" )
 Category.create!( :name => "PHP" )
 Category.create!( :name => "Java" )
 Category.create!( :name => "Python" )
```

ç¼–è¾‘ `app/views/posts/_post.html.erb` åŠ ä¸Šä¸‹æ‹‰é€‰å•ï¼š

app/views/posts/_post.html.erb

```
  <div class="panel-footer">
    <% if current_user && current_user.is_admin? %>
+      <%= select_tag "category_id[#{post.id}]", options_for_select(Category.all.map{ |x| [x.name, x.id]}, post.category_id),
+                     :data => { :url => post_path(post) }, :prompt => "è¯·é€‰æ‹©åˆ†ç±»", :class => "select_category" %>
```

ç¼–è¾‘ `app/views/posts/index.html.erb` ç»‘ä¸Šäº‹ä»¶ï¼š

app/views/posts/index.html.erb

```
  <script>
+   $("#post-list").on('change', ".select_category", function(){
+     var url = $(this).data("url");
+
+     $.ajax({
+       url: url,
+       method: "PATCH",
+       dataType: "json",
+       data: {
+         post: {
+           category_id: $(this).val()
+         }
+       }
+     });
+   });
  </script>
```

å…¶ä¸­ `$ajax` é‡Œé¢çš„ `data` å°±æ˜¯è¦é€å‡ºå»çš„å‚æ•°ï¼Œé€è¿‡ `$(this).val()` å¯ä»¥æŠ“åˆ°é€‰å•çš„å€¼ã€‚

ç¼–è¾‘ `app/controllers/posts_controller.rb` åŠ ä¸Š `update` actionï¼š

app/controllers/posts_controller.rb

```
+  def update
+    @post = Post.find(params[:id])
+    @post.update!( post_params )
+
+    render :json => { :id => @post.id, :message => "ok"}
+  end

   #(ç•¥)

   def post_params
-    params.require(:post).permit(:content)
+    params.require(:post).permit(:content, :category_id)
   end
```

æœ€åæˆæœï¼š

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/DxAxOgKVQgibPeGaUjsH_ajax-select0.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/DxAxOgKVQgibPeGaUjsH_ajax-select0.png)

# 4-8 Ajax åŠ¨ç”»æ•ˆæœ

ä¸Šä¸€èŠ‚çš„ä¸‹æ‹‰é€‰å•é€å‡º Ajax åï¼Œè™½ç„¶æ•°æ®åº“å·²ç»æ›´æ–°äº†ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰ä»»ä½•è§†è§‰å›é¦ˆï¼Œç”¨æˆ·å¯èƒ½ä¼šæ„Ÿåˆ°ç–‘æƒ‘åˆ°åº•æˆåŠŸäº†æ²¡æœ‰ã€‚æ‰€ä»¥é€šå¸¸æˆ‘ä»¬è¿˜ä¼šåˆ¶ä½œä¸€äº›åŠ¨ç”»æ•ˆæœï¼Œå¥½å‘Šè¯‰ç”¨æˆ·æ“ä½œç¡®å®å®Œæˆäº†ã€‚

è®©æˆ‘ä»¬æ‰¾ä¸€å¼ åŠ¨ç”»å›¾ç‰‡ï¼Œåœ¨ [http://loading.io](http://loading.io/) å¯ä»¥äº§ç”Ÿå’Œä¸‹è½½git å›¾ç‰‡ï¼Œæˆ–ç”¨è¿™å¼ åŠ¨å›¾[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/cuin0cnOSEeorE6v3jlp_ajax-loader.gif)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/cuin0cnOSEeorE6v3jlp_ajax-loader.gif)

ï¼ˆè¯·æŒ‰å³é”®å¦å­˜æ–°æ¡£)ï¼Œè¯·å°†åŠ¨å›¾è¯·æ”¾åœ¨`public/images/` ç›®å½•ä¸‹ï¼Œå¹¶å‘½åä¸º `ajax-loader.gif`ã€‚

ä¿®æ”¹ `app/views/posts/index.html.erb`

app/views/posts/index.html.erb

```
  <script>
  $("#post-list").on('change', ".select_category",function(){
    var url = $(this).data("url");
+   var that = this;

    $.ajax({
        url: url,
        method: "PATCH",
        dataType: "json",
        data: {
          post: {
            category_id: $(this).val()
          }
-       }
+       },
+       beforeSend: function(){
+         $(that).after( $(' <img src="/images/ajax-loader.gif" id="ajax-loading"> ') );
+       },
+       complete: function(){
+         $("#ajax-loading").remove();
+       }
      });
    });
  </script>
```

å…¶ä¸­ `beforeSend` ä¼šåœ¨ Ajax é€å‡ºå‰è§¦å‘ï¼Œè€Œ`complete` ä¼šåœ¨å®Œæˆåè§¦å‘ã€‚åˆ†åˆ«æ˜¯æ’å…¥è¿™å¼ åŠ¨ç”» gif å›¾ç‰‡ï¼Œä»¥åŠåœ¨ Ajax å®Œæˆåç§»é™¤å›¾ç‰‡ã€‚

å› ä¸ºæ˜¯æœ¬åœ°å¼€å‘ï¼Œæ„Ÿè§‰å¯èƒ½ä¼šä¸€é—ªè€Œè¿‡ï¼Œæˆ‘ä»¬å¯ä»¥æš‚æ—¶æ•…æ„åœ°åœ¨ action åšå»¶è¿Ÿï¼š

app/controllers/posts_controller.rb

```
  def update
+   sleep(1)
    # (ç•¥ )
  end
```

ä½†è¿™åªæ˜¯çœ‹çœ‹æ•ˆæœï¼Œè¯•å®Œè¯·ç§»é™¤æ‰ã€‚

æœ€åæˆæœï¼š

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/0tbJNgwpTFSNHaWpskQH_ajax-select.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/0tbJNgwpTFSNHaWpskQH_ajax-select.png)

# 4-9 jQuery Plugin æ•´åˆç¤ºèŒƒ

ç›®æ ‡: ä½¿ç”¨ [jQuery Raty](http://www.sahmeran.nl/nieuw/modules/rating_raty/) è¿™ä¸ª jQuery Pluginï¼Œè¿›è¡Œè´´æ–‡çš„æ˜Ÿæ˜Ÿè¯„ç­‰ï¼Œå¹¶è®¡ç®—å¹³å‡åˆ†æ•°ã€‚

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/uGSkOAIFR3C0UZz0PXeY_star-rating.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/uGSkOAIFR3C0UZz0PXeY_star-rating.png)

å‰å¾€ <https://github.com/wbotelhos/raty> ç‚¹é€‰ "Clone or download" æŒ‰é’®ï¼Œç„¶åç‚¹ Download ZIP ä¸‹è½½å›æ¥ã€‚

è§£å‹ç¼©åï¼š

- å°† lib/jquery.raty.css æ”¾åˆ° vendor/assets/stylesheets/ ç›®å½•ä¸‹
- å°† lib/jquery.raty.js æ”¾åˆ° vendor/assets/javascripts/ ç›®å½•ä¸‹
- å°† images ä¸‹çš„å›¾ç‰‡ï¼Œæ”¾åœ¨ public/images ç›®å½•ä¸‹

ä¿®æ”¹ `app/assets/javascript/application.js`ï¼Œ

app/assets/javascript/application.js

```
+    //= require jquery.raty
     //= require_tree .
```

ä¿®æ”¹ `app/assets/stylesheets/application.scss`

```
  @import "bootstrap-sprockets";
  @import "bootstrap";
+ @import "jquery.raty";
```

> å¦‚æœä½ æ²¡è£… Bootstrap çš„è¯ï¼Œè¿™é‡Œæ˜¯ application.css å†™ `//=require jquery.raty`

ä¿®æ”¹ `app/views/posts/_post.html.erb`

```
   <div class="panel-body">
     <span id="post-thumbsup-<%= post.id %>" class="label label-success"><%= post.likes.count %> ğŸ‘</span>

+    <div class="raty"></div>
```

ä¿®æ”¹ `app/views/posts/index.html.erb`

```
  <script>
+   $(".raty").raty( { path: '/images/' } );
  </script>
```

æµè§ˆç”»é¢ï¼Œåº”è¯¥å°±ä¼šçœ‹çœ‹æ˜Ÿæ˜Ÿäº†ï¼Œä¹Ÿå¯ä»¥ç‚¹ç‚¹çœ‹ã€‚ä½†æ˜¯ç›®å‰è¿˜æ²¡ä¸²å¥½æ•°æ®åº“ã€‚

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/HyCmuNYERxy3hmfIU5V1_rating1.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/HyCmuNYERxy3hmfIU5V1_rating1.png)

æ¥ä¸‹æ¥å¸Œæœ›ç‚¹äº†æ˜Ÿæ˜Ÿè¯„ç­‰ï¼Œä¼šå®é™…çºªå½•è¿›æ•°æ®åº“ã€‚

# 4-10 jQuery Plugin æ•´åˆç¤ºèŒƒ(cont)

ä¸€ä¸ªç”¨æˆ·å¯ä»¥é’ˆå¯¹å¾ˆå¤šè´´æ–‡è¯„åˆ†ï¼Œä¸€ç¯‡è´´æ–‡ä¹Ÿå¯ä»¥æœ‰å¤šäººè¯„åˆ†ï¼Œè®©æˆ‘ä»¬æ–°å¢ä¸€ä¸ª PostScore model æ¥çºªå½•åˆ†æ•°ï¼š

æ‰§è¡Œ `rails g model post_score`

ä¿®æ”¹ `db/migrate/201704XXXXXXXX_create_post_scores.rb

db/migrate/201704XXXXXXXX_create_post_scores.rb

```
 class CreatePostScores < ActiveRecord::Migration[5.0]
    def change
      create_table :post_scores do |t|
+       t.integer :post_id, :index => true
+       t.integer :score
+       t.integer :user_id
        t.timestamps
      end
    end
  end
```

æ‰§è¡Œ `rake db:migrate`

ç¼–è¾‘ `app/models/post_score.rb`

app/models/post_score.rb

```
 class PostScore < ApplicationRecord
+
+   belongs_to :post
+   belongs_to :user
+
  end
```

ç¼–è¾‘ `app/models/post.rb`

app/models/post.rb

```
+  has_many :scores, :class_name => "PostScore"
+
+  def find_score(user)
+    user && self.scores.where( :user_id => user.id ).first
+  end
+
+
+  def average_score
+    self.scores.average(:score)
+  end
```

ç¼–è¾‘ `config/routes.rb`

config/routes.rb

```
   resources :posts do
     member do
       post "like" => "posts#like"
       post "unlike" => "posts#unlike"
       post "toggle_flag" => "posts#toggle_flag"
+      post "rate" => "posts#rate"
     end
   end
```

å†æ¬¡ä¿®æ”¹ `app/views/posts/_post.html.erb`ï¼ŒåŠ ä¸Šå¹³å‡åˆ†æ•°ï¼Œä»¥åŠ data å±æ€§åŒ…æ‹¬ç”¨æˆ·ç»™çš„åˆ†æ•° score å’Œæ‰“åˆ†çš„ urlï¼Œå¥½è®© jQuery å¯ä»¥å¤„ç†ã€‚

```
   <div class="panel-body">
     <span id="post-thumbsup-<%= post.id %>" class="label label-success"><%= post.likes.count %> ğŸ‘</span>

-    <div class="raty"></div>
+    <span class="average-score"><%= post.average_score %></span>
+    <div class="raty" data-score="<%= post.find_score(current_user).try(:score) || 0 %>" data-score-url="<%= rate_post_path(post) %>"></div>
+
```

ä¿®æ”¹ `app/views/posts/index.html.erb`

```
  <script>
-   $(".raty").raty( { path: '/images/' } );
+   $(".raty").raty({
+     path: '/images/',
+     score: function() { return $(this).data('score'); },
+     click: function(score) {
+       var that = this;
+       $.ajax({
+         url: $(this).data("score-url"),
+         method: "POST",
+         data: { score: score },
+         dataType: "json",
+         success: function(data){
+           $(that).closest(".panel-body").find(".average-score").html( data["average_score"] );
+         }
+       })
+     }
+   });
  </script>
```

æ ¹æ® raty çš„æ–‡æ¡£ï¼Œå…¶ä¸­ï¼š

- `score` æ˜¯åˆå§‹å‡½å¼ï¼Œæˆ‘å€‘å·²ç¶“ç”¨ `data-score` å±æ€§å°†ç”¨æˆ·ä¹‹å‰çš„è¯„åˆ†æ”¾ä¸Šå»ï¼Œé€™è£¡å†ç”¨ `$(this).data('score');` æŠ“åˆ°å€¼ã€‚
- `click` æ˜¯å½“ç”¨æˆ·ç‚¹å‡»æ˜Ÿæ˜Ÿæ—¶ï¼Œä¼šè§¦å‘çš„å‡½å¼ã€‚è¿™é‡Œå°±æ˜¯ä¼šé€å‡º Ajax è¯·æ±‚ã€‚

ç¼–è¾‘ `app/controllers/posts_controller.rb` åŠ ä¸Šæ¥æ”¶çš„ actionï¼š

app/controllers/posts_controller.rb

```
+  def rate
+    @post = Post.find(params[:id])
+
+    existing_score = @post.find_score(current_user)
+    if existing_score
+      existing_score.update( :score => params[:score] )
+    else
+      @post.scores.create( :score => params[:score], :user => current_user )
+    end
+
+    render :json => { :average_score => @post.average_score }
+  end
```

æœ€åæˆæœï¼š

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/sDFUTBQNqNwgUTm91xgI_rating2.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/sDFUTBQNqNwgUTm91xgI_rating2.png)

### æœ¬èŠ‚ä½œä¸š

##### [Ajax ä½œä¸š](https://fullstack.xinshengdaxue.com/assignments/43)ï¼š[ä½œä¸šå››](https://fullstack.xinshengdaxue.com/tasks/300)

å·²æœ‰ 37 ä¸ªç¬¬ä¸€æœŸåŒå­¦æäº¤äº†è¿™ä¸ªä½œä¸š [**çœ‹çœ‹åŒå­¦æ€ä¹ˆåš](https://fullstack.xinshengdaxue.com/tasks/300/other_answers?order=recent)

[**æäº¤ä½œä¸š](https://fullstack.xinshengdaxue.com/tasks/300)

è¯·å°†å®Œæˆçš„è´´æ–‡æ ‡è®°åƒåœ¾ã€é€‰æ‹©åˆ†ç±»å’Œæ‰“æ˜Ÿç”»é¢ï¼Œç”¨ git æˆªå›¾ä¸Šæ¥ã€‚

# 5-1 jquery-ujs

Rails çš„ `:remote => true` çš„è¿™ä¸ªåŠŸèƒ½ï¼Œåœ¨ Rails æ˜¯é€è¿‡ [jquery-ujs](https://github.com/rails/jquery-ujs) è¿™ä¸ª gem æ‰€æä¾›çš„ï¼Œä½ å¯ä»¥åœ¨ `Gemfile` ä¸­æ‰¾åˆ°å®ƒï¼Œä»¥åŠåœ¨ `app/assets/javascripts/application.js` é‡Œé¢åŠ è½½äº† `//= require jquery_ujs`ã€‚

ä¹‹æ‰€ä»¥å« UJS æ˜¯å› ä¸ºå…¨åå«åš Unobtrusive JavaScriptã€‚é‚£ä¹ˆä»€ä¹ˆæ˜¯ Unobtrusive å‘¢ï¼Ÿç”¨ä¸ªèŒƒä¾‹æ¥è¯´å§ï¼Œä»¥ä¸‹ä»£ç ä¼šå°†è¶…è¿ç»“æ”¹æˆç”¨è¡¨å•DELETEé€å‡ºï¼Œå¹¶ä¸”ç”¨ä¸€ä¸ªæç¤ºè§†çª—æ¥ä½œç¡®è®¤ï¼š

```
link_to 'Remove', post_path(1), :method => :delete, :data => { :confirm => "Sure?" }
```

åœ¨ Rails 3 ä»¥å‰çš„ç‰ˆæœ¬ï¼Œä¼šè¾“å‡ºï¼š

```
<a onclick="if (confirm('Sure?')) { var f = document.createElement('form'); f.style.display = 'none'; this.parentNode.appendChild(f); f.method = 'POST'; f.action = this.href;var m = document.createElement('input'); m.setAttribute('type', 'hidden'); m.setAttribute('name', '_method'); m.setAttribute('value', 'delete'); f.appendChild(m);f.submit(); };return false;" href="/events/1">Remove</a>
```

çœ‹èµ·æ¥æœ‰ç‚¹å¤æ‚ï¼Œå…¶å®åªæ˜¯é€è¿‡ onclick å±æ€§æŠŠ JavaScript ä»£ç å†™åœ¨é‡Œé¢ã€‚

åœ¨ Rails 3 ä¹‹åï¼Œåˆ™ä¼šè¾“å‡ºï¼š

```
<a rel="nofollow" data-confirm="Sure?" data-method="delete" class="delete" href="/events/1">Remove</a>
```

ç„¶ååœ¨ jquery_ujs çš„ JavaScript åº“é‡Œé¢ä¼šæ£€æŸ¥ DOM é‡Œé¢æœ‰ `data-confirm` å’Œ `data-method` çš„è¶…è¿ç»“ï¼Œå†å»ç»‘è®¢äº‹ä»¶ã€‚

Unobtrusive çš„æ¦‚å¿µå°±æ˜¯å°† JavaScript ä»£ç ä¸ HTML åˆ†å¼€ï¼Œé™¤äº†å¯ä»¥è®© HTML ç å¹²å‡€ä¹‹å¤–ï¼Œä¹Ÿå¯ä»¥æ”¯æ´æ›´æ¢ä¸åŒçš„ JavaScript åº“ã€‚

jquery-ujs çš„åŠŸèƒ½åŒ…æ‹¬äº†ï¼š

- è®©è¶…è¿ç»“å¯ä»¥ç”¨ :method å‚æ•°æ”¯æ´é GET æ–¹æ³•
- ç”¨è¶…è¿ç»“ã€æŒ‰é’®å’Œè¡¨å•å¯ä»¥ç”¨ `:remote => true` æ”¯æ´ Ajax
- è¶…è¿ç»“ã€æŒ‰é’®å’Œè¡¨å•å¯ä»¥ç”¨ `:data => { :confirm => "Are you sure? }` å‚æ•°ï¼Œè·³å‡ºç¡®è®¤å¯¹è¯è§†çª—
- é€å‡ºæŒ‰é’®å¯ä»¥ç”¨ `:data => { :disable_with => "Please wait..." }` å‚æ•°åœ¨é€å‡ºè¡¨å•æ—¶æš‚æ—¶å…³é—­æŒ‰é’®é¿å…é‡å¤é€å‡º
- åœ¨ Layout çš„ head ä¸­æœ‰è¾“å‡ºä¸€æ®µ `<%= csrf_meta_tag %>` çš„ä½œç”¨ä¹Ÿæ˜¯æ­é…ç»™ UJS ä½¿ç”¨çš„ï¼Œè¿™ä¼šè®© jQuery çš„ $ajax é€å‡ºæ—¶é™„å¸¦ CSRF è¡¨å•å®‰å…¨éªŒè¯ç ï¼Œæˆ‘ä»¬ä¼šåœ¨ä¹‹åçš„ç½‘ç»œå®‰å…¨ä¸€ç« è®¨è®ºåˆ°ä»€ä¹ˆæ˜¯CSRFã€‚

æ€»ä¹‹ï¼Œå¦‚æœ jquery-ujs æ²¡æœ‰é¡ºåˆ©åŠ è½½çš„è¯ï¼Œä¸åª `:remote => true` ä¸èƒ½ç”¨ï¼Œæ‰€æœ‰é GET æ–¹æ³•çš„è¶…è¿ç»“ä¼šåæ‰ï¼Œä¼šå˜æˆ GET å‡ºå»ã€‚å¦å¤–è¿˜æœ‰ Devise çš„ç™»å‡ºæŒ‰é’®å› ä¸ºç”¨äº† `:method => :delete` ä¹Ÿä¼šæ— æ³•ä½œç”¨ã€‚
