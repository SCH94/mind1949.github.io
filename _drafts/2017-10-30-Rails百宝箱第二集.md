---
layout: post
title: "Railsç™¾å®ç®±ç¬¬äºŒé›†"
date: 2017-10-30
tags:
    Rails
    æ•™æ
---

#Railsç™¾å®ç®±ç¬¬äºŒé›†

| 9. åµŒå¥—è¡¨å•(1-to-1) é¢„è®¡å­¦ä¹ æ—¶é—´: 1å°æ—¶ä»¥å†…            |      |
| ---------------------------------------- | ---- |
| [**  9-1 æƒ…å¢ƒå‡†å¤‡](https://fullstack.xinshengdaxue.com/posts/1126) |      |
| [**  9-2 å•ç‹¬çš„ resource ç¼–è¾‘ UI](https://fullstack.xinshengdaxue.com/posts/1127) |      |
| [**  9-3 åµŒå¥—(Nested)è¡¨å• UI](https://fullstack.xinshengdaxue.com/posts/1128) |      |
| [**  9-4 Profile çš„æ˜¾ç¤º](https://fullstack.xinshengdaxue.com/posts/1129) |      |

| 10. åµŒå¥—è¡¨å•(1-to-many) é¢„è®¡å­¦ä¹ æ—¶é—´: 1å°æ—¶ä»¥å†…        |                                          |
| ---------------------------------------- | ---------------------------------------- |
| [**  10-1 æƒ…å¢ƒå‡†å¤‡](https://fullstack.xinshengdaxue.com/posts/1130) |                                          |
| [**  10-2 åµŒå¥—(Nested)è¡¨å• UI](https://fullstack.xinshengdaxue.com/posts/1131) | å…±1ä¸ªä½œä¸š \|[** æœªå®Œæˆ](https://fullstack.xinshengdaxue.com/posts/1131#task) |
| [**  10-3 å•ç‹¬çš„ resources ç¼–è¾‘ UI](https://fullstack.xinshengdaxue.com/posts/1132) |                                          |

| 11. é€‰æ—¥æœŸæ—¶é—´çš„ UI é¢„è®¡å­¦ä¹ æ—¶é—´: 0.5å°æ—¶ä»¥å†…            |      |
| ---------------------------------------- | ---- |
| [**  11-1 éœ€æ±‚è¯´æ˜](https://fullstack.xinshengdaxue.com/posts/1133) |      |
| [**  11-2 å®‰è£…ä½¿ç”¨ datepicker](https://fullstack.xinshengdaxue.com/posts/1134) |      |

| 12. æ‹†å¼€å‰åå°çš„ CSS å’Œ JS é¢„è®¡å­¦ä¹ æ—¶é—´: 0.5å°æ—¶ä»¥å†…      |      |
| ---------------------------------------- | ---- |
| [**  12-1 éœ€æ±‚è¯´æ˜](https://fullstack.xinshengdaxue.com/posts/1135) |      |
| [**  12-2 å®ä½œæ‹†å¼€](https://fullstack.xinshengdaxue.com/posts/1136) |      |

| 13. Rich Editor ç¼–è¾‘å™¨ é¢„è®¡å­¦ä¹ æ—¶é—´: 1å°æ—¶ä»¥å†…        |                                          |
| ---------------------------------------- | ---------------------------------------- |
| [**  13-1 å¦‚ä½•æ˜¾ç¤ºç”¨æˆ·è¾“å…¥çš„ HTML](https://fullstack.xinshengdaxue.com/posts/1137) |                                          |
| [**  13-2 è¾“å…¥ HTMLï¼šä½¿ç”¨ Rich Editor](https://fullstack.xinshengdaxue.com/posts/1138) | å…±1ä¸ªä½œä¸š \|[** æœªå®Œæˆ](https://fullstack.xinshengdaxue.com/posts/1138#task) |

| 14. æ‰¹æ¬¡ç¼–è¾‘ (Bulk Editing) é¢„è®¡å­¦ä¹ æ—¶é—´: 1å°æ—¶ä»¥å†…    |                                          |
| ---------------------------------------- | ---------------------------------------- |
| [**  14-1 éœ€æ±‚è¯´æ˜](https://fullstack.xinshengdaxue.com/posts/1139) |                                          |
| [**  14-2 æ‰¹æ¬¡åˆ é™¤](https://fullstack.xinshengdaxue.com/posts/1140) |                                          |
| [**  14-3 æ‰¹æ¬¡ä¿®æ”¹](https://fullstack.xinshengdaxue.com/posts/1141) | å…±1ä¸ªä½œä¸š \|[** æœªå®Œæˆ](https://fullstack.xinshengdaxue.com/posts/1141#task) |

# 9-1 æƒ…å¢ƒå‡†å¤‡

Model å’Œ Model ä¹‹é—´çš„æ•°æ®å…³è”ï¼Œé™¤äº†ä¸€å¯¹å¤š(1-to-many)ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€ç§æ˜¯ ä¸€å¯¹ä¸€(1-to-1)ï¼Œä¸€å¯¹ä¸€å…³è”ç®—æ˜¯ä¸€å¯¹å¤šå…³è”çš„ä¸€ç§ç‰¹ä¾‹æƒ…å†µã€‚

ä¾‹å¦‚ï¼Œä¸€ä¸ªå¸¸è§çš„è®¾è®¡æ˜¯è®© User æ‹¥æœ‰ Profileï¼Œå¹¶ä¸”ä¸€ä¸ª User ç”¨æˆ·åªä¼šæœ‰ä¸€ä¸ª Profile èµ„æ–™ã€‚

ä»€ä¹ˆæ—¶å€™ä¼šéœ€è¦ä¸€å¯¹ä¸€çš„å…³è”è®¾è®¡å‘¢ï¼Ÿæ—¢ç„¶æ˜¯ä¸€å¯¹ä¸€å¯¹åº”ï¼Œé‚£ä¹ˆç›´æ¥åˆå¹¶ profiles çš„æ‰€æœ‰å­—æ®µåœ¨ users table ä¸Šï¼Œåªç”¨ä¸€ä¸ª User Model ä¹Ÿæ˜¯å¯ä»¥å•Šã€‚

ä¼šè¿™æ ·è®¾è®¡çš„ä¸»è¦åŸå› æ˜¯ä¸ºäº†èŠ‚çœæ•°æ®åº“æŸ¥è¯¢é‡ï¼Œä¾‹å¦‚ç”¨æˆ·çš„ Profile å‚¨å­˜äº†ç”¨æˆ·çš„è¯¦ç»†èµ„æ–™ï¼Œä¸€æ¥å¾ˆå¯èƒ½åªæœ‰è¿›åˆ°ç”¨æˆ·è¯¦ç»†é¡µé¢(ä¾‹å¦‚users#show)æ‰ä¼šç”¨åˆ°ã€äºŒæ¥å¯èƒ½ä¸æ˜¯æ¯ä¸€ä¸ªç”¨æˆ·éƒ½æœ‰è¿™ä¸ª Profile ç»†èŠ‚èµ„æ–™ï¼Œæ‰€ä»¥æ‹†è¡¨ä¹‹åå¯ä»¥è®©ç»å¤§éƒ¨åˆ†çš„æ“ä½œéƒ½ä¸éœ€è¦å»ç¢°åˆ° profiles tableã€‚å¯¹ User æ¥è¯´å°¤å…¶é‡è¦ï¼Œå› ä¸ºç™»å…¥ä¹‹åï¼Œæ¯ä¸€æ¬¡çš„æµè§ˆï¼ŒRails éƒ½ä¼šå»æ•°æ®åº“æå‡º User èµ„æ–™è®¾å®š `current_user`

å¥½ï¼Œé‚£è®©æˆ‘ä»¬æ¥åˆ¶ä½œç”¨æˆ· Profileï¼š

æ‰§è¡Œ `rails g model profile`

ç¼–è¾‘ `db/migrate/201XXXXXXXX2545_create_profiles.rb`

201XXXXXXXX2545_create_profiles.rb

```
class CreateProfiles < ActiveRecord::Migration[5.0]
  def change
    create_table :profiles do |t|
      t.integer :user_id, :index => true
      t.string :legal_name
      t.date :birthday
      t.string :location
      t.string :education
      t.string :occupation
      t.text :bio
      t.text :specialty
      t.timestamps
    end
  end
end
```

æ‰§è¡Œ `rake db:migrate`

ç¼–è¾‘ `app/models/user.rb`

app/models/user.rb

```
  class User < ApplicationRecord
+    has_one :profile
```

ç¼–è¾‘ `app/models/profile.rb`

app/models/profile.rb

```
  class Profile < ApplicationRecord
+   belongs_to :user
  end
```

æ¥ä¸‹æ¥ç¤ºèŒƒä¸¤ç§è¡¨å• UI çš„è®¾è®¡ï¼š

- æ–¹æ¡ˆä¸€ï¼šå•ç‹¬çš„ resource ç¼–è¾‘ UI
- æ–¹æ¡ˆäºŒï¼šåµŒå¥—(Nested)è¡¨å• UI

# 9-2 å•ç‹¬çš„ resource ç¼–è¾‘ UI

é’ˆå¯¹ Profile è®¾è®¡å•ç‹¬çš„ CRUDï¼Œæ˜¯ä¹‹å‰å°±å­¦è¿‡çš„è®¾è®¡ï¼Œè®©æˆ‘ä»¬å¤ä¹ ä¸€ä¸‹å¦‚ä½•åå°ç¼–è¾‘ Profileï¼š

ç¼–è¾‘ `config/routes.rb`

config/routes.rb

```
   namespace :admin do
     root "events#index"
     resources :events
-    resources :users
+    resources :users do
+      resource :profile, :controller => "user_profiles"
+    end
  end
```

> æ³¨æ„ï¼šè¿™é‡Œç”¨å•æ•° `resource :profile`ï¼Œå…³äºå•æ•° resource çš„è¯´æ³•è¯·å‚è€ƒ 4-2 æ ¹æ®ç”¨æˆ·é…ç½®åˆ‡æ¢æ—¶åŒº ä¸€èŠ‚ã€‚å¦å¤–ï¼Œå› ä¸ºé»˜è®¤çš„ controller çš„å‘½åæ˜¯ `profiles`ï¼Œè¿™é‡Œæˆ‘ä»¬åå¥½è‡ªå®šä¹‰å‘½åæ”¹ä¸º `user_prorfiles`ã€‚

ç¼–è¾‘ `app/views/admin/users/index.html.erb`

app/views/admin/users/index.html.erb

```
  <td><%= link_to "Edit", edit_admin_user_path(user), :class => "btn btn-default" %></td>
+ <td><%= link_to "Edit Profile", edit_admin_user_profile_path(user), :class => "btn btn-default" %></td>
```

![BCE8C870-8480-4420-B0E1-67835D8943A4](/var/folders/2k/q63b1kcj38j4cfrl_fjx6z1c0000gn/T/net.shinyfrog.bear/BearTemp.vn6Okw/BCE8C870-8480-4420-B0E1-67835D8943A4.png)

æ‰§è¡Œ `rails g controller admin::user_profiles`

ç¼–è¾‘ `app/controllers/admin/user_profiles_controller.rb`

app/controllers/admin/user_profiles_controller.rb

```
-  class Admin::UserProfilesController < ApplicationController
+  class Admin::UserProfilesController < AdminController
+
+    before_action :find_user_and_profile
+
+    def edit
+    end
+
+    def update
+      if @profile.update(profile_params)
+        redirect_to admin_users_path
+      else
+        render "edit"
+      end
+    end
+
+    protected
+
+    def find_user_and_profile
+      @user = User.find(params[:user_id])
+      # å› ä¸ºæ–°å»ºçš„ç”¨æˆ·å¹¶æ²¡æœ‰ profileï¼Œæ‰€ä»¥è¿™é‡Œå…ˆæ£€æŸ¥æ˜¯å¦æœ‰ @user.profileï¼Œå¦‚æœæ²¡æœ‰çš„è¯å°±ç”¨ @user.create_profile æ–°å»ºè¿›æ•°æ®åº“
+      @profile = @user.profile || @user.create_profile
+    end
+
+    def profile_params
+      params.require(:profile).permit(:legal_name, :birthday, :location, :education, :occupation, :bio, :specialty)
+    end
+
+  end
```

æ–°å¢ `app/views/admin/user_profiles/edit.html.erb`

app/views/admin/user_profiles/edit.html.erb

```
<h2>Edit User Profile</h2>
<%= form_for @profile, :url => admin_user_profile_path(@user) do |f| %>

  <div class="form-group">
    <%= f.label :legal_name %>
    <%= f.text_field :legal_name, :class => "form-control" %>
  </div>

  <div class="form-group">
    <%= f.label :birthday %>
    <%= f.date_field :birthday, :class => "form-control" %>
  </div>

  <div class="form-group">
    <%= f.label :location %>
    <%= f.text_field :location, :class => "form-control" %>
  </div>

  <div class="form-group">
    <%= f.label :education %>
    <%= f.text_field :education, :class => "form-control" %>
  </div>

  <div class="form-group">
    <%= f.label :occupation %>
    <%= f.text_field :occupation, :class => "form-control" %>
  </div>

  <div class="form-group">
    <%= f.label :bio %>
    <%= f.text_area :bio, :class => "form-control" %>
  </div>

  <div class="form-group">
    <%= f.label :specialty %>
    <%= f.text_area :specialty, :class => "form-control" %>
  </div>

  <div class="form-group">
    <%= f.submit "Submit", :class => "btn btn-primary" %>
  </div>

<% end %>
```

[![img](/var/folders/2k/q63b1kcj38j4cfrl_fjx6z1c0000gn/T/net.shinyfrog.bear/BearTemp.D5HOd7/A0F0989F-732E-44CC-865C-EAA80A8E1FE4.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/DYXRAc4KQreML4AYBzQI_9-2.png)

è¿™æ ·å°±å¯ä»¥åœ¨åå°ç¼–è¾‘ User Profile äº†ã€‚



# 9-3 åµŒå¥—(Nested)è¡¨å• UI

æ¥ä¸‹æ¥çš„é‡å¤´æˆæ˜¯å°†ç¼–è¾‘ User å’Œç¼–è¾‘ Profile çš„è¡¨å•åˆå¹¶åœ¨ä¸€èµ·ã€‚å¾ˆå¤šæ—¶å€™è¿™æ ·å¯¹ç”¨æˆ·çš„æ“ä½œä¼šæ›´æ–¹ä¾¿ï¼Œä¸€æ¬¡å°±å¯ä»¥ç¼–è¾‘ä¸¤ä¸ª Model çš„èµ„æ–™ã€‚æ¥ä¸‹æ¥ç¤ºèŒƒå¦‚ä½•åœ¨å‰å°åšè¿™ä¸ª UIã€‚

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/UTAwvoVLQQWmXchavBT4_9-3.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/UTAwvoVLQQWmXchavBT4_9-3.png)

ç¼–è¾‘ `app/models/user.rb`

app/models/user.rb

```
+  accepts_nested_attributes_for :profile
```

ç¼–è¾‘ `app/controllers/users_controller.rb`

app/controllers/users_controller.rb

```
   def edit
     @user = current_user
     # è·Ÿåˆšæ‰åå°æƒ…å†µä¸€æ ·ï¼Œå¦‚æœæ²¡æœ‰ @user.profileï¼Œè¦å…ˆæ–°å»ºä¸€ä¸ª
     # unless @user.profile ç­‰åŒäº if !@user.profile æˆ– if @user.profile.nil?
+    @user.create_profile unless @user.profile
   end

   # (ç•¥)

   def user_params
-    params.require(:user).permit(:time_zone)
+    params.require(:user).permit(:time_zone, :profile_attributes => [:id, :legal_name, :birthday, :location, :education, :occupation, :bio, :specialty] )
   end
```

Rails çš„ [accepts_nested_attributes_for](http://api.rubyonrails.org/classes/ActiveRecord/NestedAttributes/ClassMethods.html) ä½œç”¨æ˜¯å¯ä»¥åœ¨æ›´æ–° User æ—¶ï¼Œä¹Ÿé¡ºä¾¿å¯ä»¥æ›´æ–° Profile èµ„æ–™ã€‚

ç¼–è¾‘ `app/views/users/edit.html.erb` æŠŠ Profile çš„è¡¨å•åŠ åœ¨æœ¬æ¥çš„ User è¡¨å•é‡Œé¢ï¼š

app/views/users/edit.html.erb

```
  <h2>Edit User</h2>

  <%= form_for @user do |f| %>

    <div class="form-group">
      <%= f.label :time_zone %>
      <%= f.time_zone_select :time_zone %>
    </div>

+   <%= f.fields_for :profile do |ff| %>
+     <div class="form-group">
+       <%= ff.label :legal_name %>
+       <%= ff.text_field :legal_name, :class => "form-control" %>
+     </div>
+
+     <div class="form-group">
+       <%= ff.label :birthday %>
+       <%= ff.date_field :birthday, :class => "form-control" %>
+     </div>
+
+     <div class="form-group">
+       <%= ff.label :location %>
+       <%= ff.text_field :location, :class => "form-control" %>
+     </div>
+
+     <div class="form-group">
+       <%= ff.label :education %>
+       <%= ff.text_field :education, :class => "form-control" %>
+     </div>
+
+     <div class="form-group">
+       <%= ff.label :occupation %>
+       <%= ff.text_field :occupation, :class => "form-control" %>
+     </div>
+
+     <div class="form-group">
+       <%= ff.label :bio %>
+       <%= ff.text_area :bio, :class => "form-control" %>
+     </div>
+
+     <div class="form-group">
+       <%= ff.label :specialty %>
+       <%= ff.text_area :specialty, :class => "form-control" %>
+     </div>
+   <% end %>

    <div class="form-group">
      <%= f.submit "Save", :class => "btn btn-primary" %>
    </div>

<% end %>
```

è¿™æ ·å°±å®Œæˆäº†ï¼Œä½ å¯ä»¥é€å‡ºç¼–è¾‘çœ‹çœ‹ã€‚

> ç”¨è¿™ç§åµŒå¥—(Nested)è¡¨å• UI çš„è¯ï¼Œæˆ‘ä»¬ä¸éœ€è¦ç¼–è¾‘ routes.rb åŠ ä¸Š profile è·¯ç”±ï¼Œä¹Ÿä¸éœ€è¦ profiles_controllerï¼Œå› ä¸ºé€è¿‡ users_controller å°±å¯ä»¥å®Œæˆäº†ã€‚

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/hVbc3UaTKiYblYJtmGHn_9-4.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/hVbc3UaTKiYblYJtmGHn_9-4.png)

# 9-4 Profile çš„æ˜¾ç¤º

æ¥ç€å¢åŠ æ˜¾ç¤ºé¡µé¢çœ‹çœ‹ã€‚

ä¿®æ”¹ `app/controllers/users_controller.rb`ï¼Œæ–°å¢ `show` actionï¼Œé¡ºä¾¿é‡æ„ä¸€ä¸‹éƒ½å…ˆè°ƒç”¨ `find_user`æ–¹æ³•ã€‚

app/controllers/users_controller.rb

```
  class UsersController < ApplicationController

    before_action :authenticate_user!
+   before_action :find_user

+   def show
+   end

    def edit
-     @user = current_user
    end

   def update
-    @user = current_user
     if @user.update(user_params)
       flash[:notice] = "ä¿®æ”¹æˆåŠŸ"
       redirect_to edit_user_path
     else
       render "edit"
     end
   end

   # (ç•¥)

   protected

+  def find_user
+    @user = current_user
+    @user.create_profile unless @user.profile
+  end

   # (ç•¥)
```

æ–°å¢ `app/views/users/show.html.erb`

```
<h1>æˆ‘çš„ä¸ªäººèµ„æ–™</h1>

<p>Email: <%= @user.email %></p>
<p>Timezone: <%= @user.time_zone %></p>
<p>Birthday: <%= @user.profile.birthday %></p>
<p>Bio: <%= simple_format @user.profile.bio %></p>
```

ç¼–è¾‘ `app/views/layout/application.html.erb` ä¿®æ”¹ä¸»é€‰å•åŠ ä¸Šè¿™ä¸ªè¿ç»“ï¼Œ

app/views/layout/application.html.erb

```
+   <li><%= link_to('æˆ‘çš„ä¸ªäººèµ„æ–™', user_path) %></li>
    <li><%= link_to('ä¿®æ”¹ä¸ªäººèµ„æ–™', edit_user_path) %></li>
```

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/bzROdUTR9ulky9ZwNdLf_9-6.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/bzROdUTR9ulky9ZwNdLf_9-6.png)

# 10-1 æƒ…å¢ƒå‡†å¤‡

æƒ…å¢ƒï¼šç®¡ç†å‘˜åœ¨åå°å¯ä»¥ç¼–è¾‘æ´»åŠ¨æœ‰ä¸åŒç¥¨ç§(Ticket)ï¼Œä¸€ä¸ªæ´»åŠ¨ä¼šæœ‰å¾ˆå¤šä¸ªç¥¨ç§ã€‚

æˆ‘ä»¬éœ€è¦æ–°å¢ä¸€ä¸ª Ticket modelï¼Œå¹¶è®© Event has_many ticketsã€‚

æ‰§è¡Œ `rails g model ticket`

ç¼–è¾‘ `db/migrate/20170423111008_create_tickets.rb`

db/migrate/20170423111008_create_tickets.rb

```
  class CreateTickets < ActiveRecord::Migration[5.0]
    def change
      create_table :tickets do |t|
+       t.integer :event_id, :index => true
+       t.string :name
+       t.text :description
+       t.integer :price
+       t.timestamps
      end
    end
  end
```

æ‰§è¡Œ `rake db:migrate`

ç¼–è¾‘ `app/models/event.rb`

app/models/event.rb

```
+  has_many :tickets, :dependent => :destroy
```

ç¼–è¾‘ `app/models/ticket.rb`

```
  class Ticket < ApplicationRecord
+   validates_presence_of :name, :price
+   belongs_to :event
  end
```

æ¥ä¸‹æœ‰ä¸¤ç§ UI æ–¹æ¡ˆï¼š

- æ–¹æ¡ˆä¸€ï¼šå•ç‹¬çš„ resources ç¼–è¾‘ UI
- æ–¹æ¡ˆäºŒï¼šåµŒå¥—(Nested)è¡¨å• UI

# 10-2 åµŒå¥—(Nested)è¡¨å• UI

è®©æˆ‘ä»¬ç›´æ¥è¿›å…¥é‡ç‚¹ï¼Œåˆ¶ä½œåµŒå¥—(Nested)è¡¨å• UIã€‚å°†ç¼–è¾‘ Event å’Œç¼–è¾‘ Ticket çš„è¡¨å•åˆå¹¶åœ¨ä¸€èµ·ã€‚å› ä¸ºä¸€ä¸ªæ´»åŠ¨ä¼šæœ‰çš„ Ticket ç¥¨ç§ä¹Ÿä¸æ˜¯å¾ˆå¤šï¼Œè€Œ Ticket çš„å­—æ®µä¹Ÿä¸æ˜¯å¾ˆå¤šï¼Œåˆå¹¶åœ¨ä¸€èµ·ç¼–è¾‘å¯¹ç”¨æˆ·çš„æ“ä½œä¼šæ›´æ–¹ä¾¿ï¼Œä¸€æ¬¡å°±å¯ä»¥ç¼–è¾‘ä¸¤ä¸ª Model çš„èµ„æ–™ã€‚

å†æ¬¡ç¼–è¾‘ `app/models/event.rb`ï¼ŒåŠ ä¸Š `accepts_nested_attributes_for` å®£å‘Šï¼š

app/models/event.rb

```
-  has_many :tickets, :dependent => :destroy
+  has_many :tickets, :dependent => :destroy, :inverse_of  => :event
+  accepts_nested_attributes_for :tickets, :allow_destroy => true, :reject_if => :all_blank

```

> æŸäº›ç‰ˆæœ¬çš„Rails æœ‰ä¸ªaccepts_nested_attributes_for çš„[bug](https://github.com/rails/rails/issues/18672) è®©has_many æ•…éšœäº†ï¼Œéœ€è¦é¢å¤–è¡¥ä¸Š`inverse_of` å‚æ•°ï¼Œä¸ç„¶å­˜å‚¨æ—¶ä¼šæ‰¾ä¸åˆ°tickets

ç¼–è¾‘ `app/controllers/admin/events_controller.rb`

app/controllers/admin/events_controller.rb

```
   def new
     @event = Event.new
+    @event.tickets.build
+    @event.tickets.build
   end

   # (ç•¥)

   def edit
     @event = Event.find_by_friendly_id!(params[:id])
+    @event.tickets.build
+    @event.tickets.build
   end

   # (ç•¥)

   def event_params
-    params.require(:event).permit(:name, :description, :friendly_id, :status, :category_id)
+    params.require(:event).permit(:name, :description, :friendly_id, :status, :category_id, :tickets_attributes => [:id, :name, :description, :price, :_destroy])
   end
```

> è¿™é‡Œ `@event.tickets.build` ä¸¤æ¬¡ï¼Œç­‰ä¼šè¡¨å•ä¸­å°±æœ‰ä¸¤ç¬”ç©ºçš„ Ticket å¯ä»¥ç¼–è¾‘ã€‚Strong Parameters çš„éƒ¨åˆ†ï¼Œæ–°å¢äº† `tickets_attributes` æ•°ç»„åŒ…å«è¦ä¿®æ”¹çš„ ticket å±æ€§ï¼Œå¹¶ä¸”é¢å¤–å¤šäº†ä¸€ä¸ª `:id` å’Œ `:_destroy` æ˜¯ä¸ºäº†é…åˆ `accepts_nested_attributes_for` å¯ä»¥ç¼–è¾‘å’Œåˆ é™¤ã€‚

ç¼–è¾‘ `app/views/admin/events/_form.html.erb`

app/views/admin/events/_form.html.erb

```
+  <%= f.fields_for :tickets do |ff| %>
+    <fieldset style="border-left: 5px solid #bbb; margin-bottom: 10px; padding: 10px;">
+      <legend>Ticket</legend>
+      <div class="form-group">
+        <%= ff.label :name %>
+        <%= ff.text_field :name, :class => "form-control" %>
+      </div>
+
+      <div class="form-group">
+        <%= ff.label :price %>
+        <%= ff.number_field :price, :class => "form-control" %>
+      </div>
+
+      <div class="form-group">
+        <%= ff.label :description %>
+        <%= ff.text_area :description, :class => "form-control" %>
+      </div>
+    </fieldset>
+  <% end %>
```

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/0lkrbRHWSU2ZU6VcCWwx_10-1.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/0lkrbRHWSU2ZU6VcCWwx_10-1.png)

è¿™ä¸ª UI åšåˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å†™æ­»äº†å›ºå®šæ–°å¢ä¸¤ç¬”ï¼Œä¼¼ä¹ç¾ä¸­ä¸è¶³å•Š :(

æœ‰æ²¡æœ‰åŠæ³•å¯ä»¥åœ¨ UI ä¸ŠåŠ¨æ€ä¸€ç›´æ–°å¢? è¿™ä¼šéœ€è¦ JavaScript çš„ååŠ©ï¼Œè¿™é‡Œæˆ‘ä»¬ç›´æ¥å®‰è£…ä¸€ä¸ª [nested_form_fields](https://github.com/ncri/nested_form_fields) gemï¼š

ç¼–è¾‘ `Gemfile`

Gemfile

```
+  gem "nested_form_fields"
```

æ‰§è¡Œ bundle ç„¶åé‡å¯æœåŠ¡å™¨

ç¼–è¾‘ `app/assets/javascripts/application.js`

app/assets/javascripts/application.js

```
+  //= require nested_form_fields
   //= require_tree .
```

å†æ¬¡ç¼–è¾‘ `app/controllers/admin/events_controller.rb`

app/controllers/admin/events_controller.rb

```
   def new
     @event = Event.new
     @event.tickets.build
-    @event.tickets.build
   end
     # (ç•¥)
   def edit
     @event = Event.find_by_friendly_id!(params[:id])
-    @event.tickets.build
-    @event.tickets.build
+    @event.tickets.build if @event.tickets.empty?
   end
```

å†æ¬¡ç¼–è¾‘ `app/views/admin/events/_form.html.erb`

app/views/admin/events/_form.html.erb

```
-  <%= f.fields_for :tickets do |ff| %>
+  <%= f.nested_fields_for :tickets do |ff| %>
     <fieldset style="border-left: 5px solid #bbb; margin-bottom: 10px;  padding: 10px;">
       <legend>Ticket</legend>
       <div class="form-group">
         <%= ff.label :name %>
         <%= ff.text_field :name, :class => "form-control" %>
       </div>

       <div class="form-group">
         <%= ff.label :price %>
         <%= ff.number_field :price, :class => "form-control" %>
       </div>

       <div class="form-group">
         <%= ff.label :description %>
         <%= ff.text_area :description, :class => "form-control" %>
       </div>
     </fieldset>
+    <%= ff.remove_nested_fields_link "ç§»é™¤è¿™ä¸ªç¥¨ç§", :class => "btn btn-danger" %>
   <% end %>
+  <p class="text-right">
+    <%= f.add_nested_fields_link :tickets, "æ–°å¢ç¥¨ç§", :class => "btn btn-default" %>
+  </p>
```

æœ€åæˆæœï¼Œæ˜¯ä¸ªå¾ˆæ¼‚äº®çš„ UI å¯ä»¥åŠ¨æ€æ–°å¢å’Œåˆ é™¤ï¼š

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/JrE4AMxsQwSLhMWmWCIx_10-2.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/JrE4AMxsQwSLhMWmWCIx_10-2.png)

#### æœ¬èŠ‚ä½œä¸š

##### [ç¬¬äºŒé›†ä½œä¸š](https://fullstack.xinshengdaxue.com/assignments/52)ï¼š[ä½œä¸šä¸€](https://fullstack.xinshengdaxue.com/tasks/314)

å·²æœ‰ 30 ä¸ªç¬¬ä¸€æœŸåŒå­¦æäº¤äº†è¿™ä¸ªä½œä¸š [**çœ‹çœ‹åŒå­¦æ€ä¹ˆåš](https://fullstack.xinshengdaxue.com/tasks/314/other_answers?order=recent)

[**æäº¤ä½œä¸š](https://fullstack.xinshengdaxue.com/tasks/314)

è¯·å®ä½œ Nested-form è¡¨å•(1-to-many) åœ¨ä»»ä¸€ä¸ªé¡¹ç›®ï¼Œå¹¶è´´ä¸Š gif å®Œæˆå›¾ã€‚

# 10-3 å•ç‹¬çš„ resources ç¼–è¾‘ UI

å¦‚æœ has_many çš„èµ„æ–™éå¸¸å¤šã€å­—æ®µåˆå¤šçš„è¯ï¼Œå°±ä¸é€‚åˆç”¨åµŒå¥—(Nested)è¡¨å• UIã€‚ç‹¬ç«‹çš„ CRUD ä½ åº”è¯¥å·²ç»æœ‰èƒ½åŠ›å¯ä»¥å®Œæˆäº†ï¼Œåšä¸ºå¤ä¹ ï¼Œè¿™é‡Œè¿˜æ˜¯å¿«é€Ÿç¤ºèŒƒä¸€ä¸‹ï¼š

ç¼–è¾‘ `config/routes.rb`

config/routes.rb

```
  namespace :admin do
    # (ç•¥)
-   resources :events
+   resources :events do
+     resources :tickets, :controller => "event_tickets"
+   end
```

æ‰§è¡Œ `rails g controller admin::event_tickets`

ç¼–è¾‘ `app/controllers/admin/event_tickets_controller.rb`

app/controllers/admin/event_tickets_controller.rb

```
-  class Admin::EventTicketsController < ApplicationController
+  class Admin::EventTicketsController < AdminController
+
+   before_action :find_event
+
+   def index
+     @tickets = @event.tickets
+   end
+
+   def new
+     @ticket = @event.tickets.new
+   end
+
+   def create
+     @ticket = @event.tickets.new(ticket_params)
+     if @ticket.save
+       redirect_to admin_event_tickets_path(@event)
+     else
+       render "new"
+     end
+   end
+
+   def edit
+     @ticket = @event.tickets.find(params[:id])
+   end
+
+   def update
+     @ticket = @event.tickets.find(params[:id])
+
+     if @ticket.update(ticket_params)
+       redirect_to admin_event_tickets_path(@event)
+     else
+       render "edit"
+     end
+   end
+
+   def destroy
+     @ticket = @event.tickets.find(params[:id])
+     @ticket.destroy
+
+     redirect_to admin_event_tickets_path(@event)
+   end
+
+   protected
+
+   def find_event
+     @event = Event.find_by_friendly_id!(params[:event_id])
+   end
+
+   def ticket_params
+     params.require(:ticket).permit(:name, :price, :description)
+   end

  end
```

ç¼–è¾‘ `app/views/admin/events/index.html.erb`

app/views/admin/events/index.html.erb

```
+  <%= link_to "Tickets", admin_event_tickets_path(event), :class => "btn btn-default" %>
   <%= link_to "Edit", edit_admin_event_path(event), :class => "btn btn-default" %>
```

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/wbYnS6uKQaCySRBX2wO9_10-4.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/wbYnS6uKQaCySRBX2wO9_10-4.png)

æ–°å¢ `app/views/admin/event_tickets/index.html.erb`

app/views/admin/event_tickets/index.html.erb

```
<h1><%= @event.name %> / Tickets</h1>

<p class="text-right">
<%= link_to "New Ticket", new_admin_event_ticket_path(@event), :class => "btn btn-primary" %>
</p>

<table class="table">
<tr>
  <th>Name</th>
  <th>Price</th>
  <th>Description</th>
  <th>Actions</th>
</tr>
<% @tickets.each do |ticket| %>
  <tr>
    <td><%= ticket.name %></td>
    <td><%= ticket.price %></td>
    <td><%= simple_format ticket.description %></td>
    <td>
      <%= link_to "Edit", edit_admin_event_ticket_path(@event, ticket), :class => "btn btn-default" %>
      <%= link_to "Delete", admin_event_ticket_path(@event, ticket), :method => "delete", :data => { :confirm => "Are you sure?" }, :class => "btn btn-danger" %>
  </tr>
<% end %>
</table>
```

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/Lz8BXuYBQhmEpfojL5uS_10-3.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/Lz8BXuYBQhmEpfojL5uS_10-3.png)

æ–°å¢ `app/views/admin/event_tickets/new.html.erb`

app/views/admin/event_tickets/new.html.erb

```
<h1>New Ticket</h1>

<%= form_for [:admin, @event, @ticket] do |f| %>

  <%= render :partial => "form", :locals => { :f => f } %>

  <div class="form-group">
    <%= f.submit "Create", :class => "btn btn-primary" %>
    <%= link_to "Cancel", admin_event_tickets_path(@event) %>
  </div>
<% end %>
```

æ–°å¢ `app/views/admin/event_tickets/edit.html.erb`

app/views/admin/event_tickets/edit.html.erb

```
<h1>Edit Ticket</h1>

<%= form_for [:admin, @event, @ticket] do |f| %>

  <%= render :partial => "form", :locals => { :f => f } %>

  <div class="form-group">
    <%= f.submit "Update", :class => "btn btn-primary" %>
    <%= link_to "Cancel", admin_event_tickets_path(@event) %>
  </div>

<% end %>
```

æ–°å¢ `app/views/admin/event_tickets/_form.html.erb`

app/views/admin/event_tickets/_form.html.erb

```
<% if @ticket.errors.any? %>
  <div id="error_explanation">
    <ul>
    <% @ticket.errors.full_messages.each do |msg| %>
      <li><%= msg %></li>
    <% end %>
    </ul>
  </div>
<% end %>

<div class="form-group">
  <%= f.label :name %>
  <%= f.text_field :name, :class => "form-control" %>
</div>

<div class="form-group">
  <%= f.label :price %>
  <%= f.number_field :price, :class => "form-control" %>
</div>

<div class="form-group">
  <%= f.label :description %>
  <%= f.text_area :description, :class => "form-control" %>
</div>
```

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/kNZDEaLWR8mI9iVEVILB_10-5.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/kNZDEaLWR8mI9iVEVILB_10-5.png)

# 11-1 éœ€æ±‚è¯´æ˜

ä¹‹å‰æˆ‘ä»¬åœ¨åå°ç¼–è¾‘ User Profile çš„ç”Ÿæ—¥æ—¶ï¼Œç”¨çš„æ˜¯

app/views/admin/user_profiles/edit.html.erb

```
<%= f.date_field :birthday, :class => "form-control" %>
```

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/DgdJkBaScma2QZ8CV8Ce_11-3.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/DgdJkBaScma2QZ8CV8Ce_11-3.png)

è¿™ä¸ª UI æ˜¯ç”¨æµè§ˆå™¨å†…å»ºçš„ `<input type="date">` è¾“å…¥æ¡†ï¼Œä¸è¿‡å¾ˆå¯æƒœï¼Œè¿™ç§ input é™¤äº† Chrome æµè§ˆå™¨ä¹‹å¤–æ˜¯ä¸å¤ªæ”¯æ´çš„ï¼Œè¯¦è§ [Can I use?](http://caniuse.com/#feat=input-datetime) çš„ç»Ÿè®¡èµ„æ–™ã€‚å› æ­¤åå°ç”¨è¿˜å¯ä»¥ï¼Œå› ä¸ºä½ å¯ä»¥è¦æ±‚ç®¡ç†å‘˜ç»Ÿä¸€ç”¨ Chrome æµè§ˆå™¨ï¼Œä½†æ˜¯å‰å°è¦ç»™ä¸€èˆ¬ç”¨æˆ·å°±ä¸å¤ªå¥½äº†ã€‚

Rails ä¹Ÿæœ‰å¦å¤–å†…å»ºä¸€ç§ç”¨ä¸‹æ‹‰é€‰å•çš„æ–¹å¼ï¼š

app/views/admin/user_profiles/edit.html.erb

```
<%= f.date_select :birthday, :class => "form-control" %>
```

è¿™ä¼šäº§ç”Ÿä¸‰ä¸ªä¸‹æ‹‰é€‰å•ï¼š

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/f3ignv3SVij8wJvIHKXt_11-4.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/f3ignv3SVij8wJvIHKXt_11-4.png)

è¿™ç§ä¸‹æ‹‰é€‰å•å°±æ²¡æœ‰æµè§ˆå™¨æ”¯æ´çš„é—®é¢˜ï¼Œä½†æ˜¯å°±æ˜¯æœ‰ç‚¹ä¸‘è€Œä¸”æ²¡æœ‰æ—¥å†ï¼Œæˆ‘ä»¬æƒ³è¦ ğŸ“… å•Šã€‚

è¿™ä¸€ç« å°†ä»‹ç»ä½¿ç”¨ [bootstrap-datepicker](https://uxsolutions.github.io/bootstrap-datepicker/) è¿™ä¸ª jQuery Pluginï¼Œå¯ä»¥è·å¾—æ—¥å†èˆ¬çš„ç‚¹é€‰æ¥å£ã€‚

> bootstrap-datepicker åªæœ‰æ—¥æœŸï¼Œå¦‚æœéœ€è¦æ—¥æœŸåŠ ä¸Šæ—¶é—´ï¼Œå¯ä»¥ç”¨ [bootstrap-datetimepicker](http://eonasdan.github.io/bootstrap-datetimepicker/) è¿™ä¸ª jQuery Pluginï¼Œä»¥åŠåŒ…å¥½çš„ [bootstrap3-datetimepicker-rails](https://github.com/TrevorS/bootstrap3-datetimepicker-rails) gemã€‚

# 11-2 å®‰è£…ä½¿ç”¨ datepicker

[bootstrap-datepicker](https://uxsolutions.github.io/bootstrap-datepicker/) æ˜¯ä¸ª jQuery Pluginï¼Œå¹¶ä¸”æœ‰ç°æˆåŒ…å¥½çš„ gem å¯ä»¥ç›´æ¥ä½¿ç”¨ [bootstrap-datepicker-rails](https://github.com/Nerian/bootstrap-datepicker-rails)ã€‚

ç¼–è¾‘ `Gemfile`

Gemfile

```
+  gem 'bootstrap-datepicker-rails'
```

æ‰§è¡Œ `bundle` åï¼Œé‡å¯æœåŠ¡å™¨

ç¼–è¾‘ `app/assets/stylesheets/application.scss`

app/assets/stylesheets/application.scss

```
   @import "bootstrap-sprockets";
   @import "bootstrap";
   @import "select2";
   @import "select2-bootstrap";
+  @import "bootstrap-datepicker3";
```

ç¼–è¾‘ `app/assets/javascripts/application.js`

app/assets/javascripts/application.js

```
   //= require jquery
   //= require jquery_ujs
   //= require turbolinks
   //= require bootstrap-sprockets
   //= require select2
   //= require nested_form_fields
+  //= require bootstrap-datepicker/core
+  //= require bootstrap-datepicker/locales/bootstrap-datepicker.zh-CN
   //= require_tree .
```

ç¼–è¾‘ `app/views/users/edit.html.erb`ï¼Œå°† script æ”¾åˆ°æœ€ä¸‹æ–¹ï¼š

app/views/users/edit.html.erb

```
-  <%= ff.date_field :birthday, :class => "form-control" %>
+  <%= ff.text_field :birthday, :class => "form-control" %>

   # ç•¥

+  <script>
+    $("#user_profile_attributes_birthday").datepicker({ format: "yyyy-mm-dd" });
+  </script>
```

æ³¨æ„æ ¼å¼è¦æŒ‡å®šä»¥é…åˆ Railsï¼Œè¿™é‡ŒæŒ‡å®šæˆ `"yyyy-mm-dd"` å¹´æœˆæ—¥çš„é¡ºåºã€‚

å…¶ä¸­ `#user_profile_attributes_birthday` è¿™ä¸ª HTML ID å¯ä»¥é€è¿‡ Chrome æŒ‰å³é”®é€è¿‡ Inspect è§‚å¯Ÿå¾—çŸ¥ï¼š

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/fRMgcp9jQYGbLXq7yNj2_11-0.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/fRMgcp9jQYGbLXq7yNj2_11-0.png)

è¿™æ˜¯æˆæœï¼š

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/puMQftqjT1eTRtkjF57q_11-1.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/puMQftqjT1eTRtkjF57q_11-1.png)

å¦‚æœéœ€è¦æ”¯æ´å¤šè¯­è¨€ï¼Œå¯ä»¥æŒ‡å®šè¯­è¨€ï¼š

```
<script>
  $("#user_profile_attributes_birthday").datepicker({ format: "yyyy-mm-dd", language: "<%= I18n.locale %>" });
</script>
```

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/sR6WptvZQKyT14SR3kAz_11-6.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/sR6WptvZQKyT14SR3kAz_11-6.png)

# 12-1 éœ€æ±‚è¯´æ˜

æˆ‘ä»¬å­¦è¿‡å¦‚ä½•æ‹† layout äº†ï¼šé»˜è®¤çš„ layout æ˜¯ `app/views/layouts/application.html.erb`ï¼Œè€Œåå°çš„ controller æˆ‘ä»¬é€è¿‡ `layout "admin"` å¯ä»¥æ”¹ç”¨ `app/views/layouts/admin.html.erb`ã€‚

ä½†æ˜¯æœ‰ä¸ªéƒ¨åˆ†æˆ‘ä»¬æ²¡æœ‰æ‹†å¼€ï¼Œé‚£å°±æ˜¯ css å’Œ javascriptï¼Œåˆ°ç›®å‰è¿˜æ˜¯å…±äº« `app/assets/stylesheets/application.scss` å’Œ `app/assets/javascript/application.js`ã€‚

éšç€ Plugins åŠŸèƒ½è¶Šè£…è¶Šå¤šï¼Œæœ‰å¾ˆå¤š css/js å‰åå°æ˜¯ä¸ä¸€æ ·çš„ï¼Œä¾‹å¦‚æˆ‘ä»¬åæ¥è£…çš„ `select2` å’Œ `nested_form_fields` pluginsï¼Œå‰å°ç›®å‰æ²¡æœ‰ç”¨åˆ°ï¼Œä½†æ˜¯å› ä¸ºå‰åå°å…±äº«çš„å…³ç³»ï¼Œè¿˜æ˜¯è¢«ç”¨æˆ·ä¸‹è½½äº†ã€‚

è¿™éƒ¨åˆ†çš„ css/js ä¹Ÿå¯ä»¥å‰åå°æ‹†å¼€ï¼Œé™¤äº†å¯ä»¥è®©å‰å°ä¸‹è½½æ›´æœ‰æ•ˆç‡ï¼Œä¹Ÿå¯ä»¥è®©ä»£ç åˆ†å¼€ç®¡ç†ã€‚

# 12-2 å®ä½œæ‹†å¼€

æ–°å¢ `app/assets/stylesheets/admin.scss`

```
@import "bootstrap-sprockets";
@import "bootstrap";
@import "select2";
@import "select2-bootstrap";
@import "bootstrap-datepicker3";
```

æ–°å¢ `app/assets/javascripts/admin.js`

```
//= require jquery
//= require jquery_ujs
//= require turbolinks
//= require bootstrap-sprockets
//= require select2
//= require nested_form_fields
//= require bootstrap-datepicker/core
//= require bootstrap-datepicker/locales/bootstrap-datepicker.zh-CN
```

ä¿®æ”¹ `config/initializers/assets.rb`

config/initializers/assets.rb

```
- # Rails.application.config.assets.precompile += %w( search.js )

+ Rails.application.config.assets.precompile += %w( admin.css admin.js )
```

è¿™ä¼šå‘Šè¯‰ Rails ç¼–è¯‘ assets æ—¶è¦å¤šç¼–è¯‘è¿™ä¸¤ä¸ªè¿›å…¥ç‚¹æ¡£æ¡ˆã€‚

é‡å¯ Rails æœåŠ¡å™¨

ä¿®æ”¹ `app/views/layouts/admin.html.erb`ï¼Œæ¢æˆè½½å…¥ admin css å’Œ js

app/views/layouts/admin.html.erb

```
-  <%= stylesheet_link_tag    'application', media: 'all', 'data-turbolinks-track': 'reload' %>
+ <%= stylesheet_link_tag    'admin', media: 'all', 'data-turbolinks-track': 'reload' %>

-  <%= javascript_include_tag 'application', 'data-turbolinks-track': 'reload' %>
+  <%= javascript_include_tag 'admin', 'data-turbolinks-track': 'reload' %>
```

æµè§ˆçœ‹çœ‹åå°ï¼Œä¸€åˆ‡åº”æ­£å¸¸ã€‚

å¦‚æœæ£€è§†ä¸€ä¸‹ HTML æºç ï¼Œå¯ä»¥çœ‹åˆ°å·²ç»é¡ºåˆ©æ”¹ç”¨ admin css å’Œ js äº†ï¼š

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/ijBWWSBRlwhp8vw0giOQ_12.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/ijBWWSBRlwhp8vw0giOQ_12.png)

æ—¢ç„¶æ˜¯å‰åå°æ‹†å¼€äº†ï¼Œæ¥ç€å¯ä»¥ç˜¦èº«ä¸€ä¸‹å‰å°çš„ css å’Œ jsï¼Œæ¥æŠŠ `select2` å’Œ `nested_form_fields` ç§»é™¤ã€‚

ä¿®æ”¹ `app/assets/stylesheets/application.scss`

app/assets/stylesheets/application.scss

```
   @import "bootstrap-sprockets";
   @import "bootstrap";
-  @import "select2";
-  @import "select2-bootstrap";
   @import "bootstrap-datepicker3";
```

ä¿®æ”¹ `app/assets/javascripts/application.js`

app/assets/javascripts/application.js

```
   //= require jquery
   //= require jquery_ujs
   //= require turbolinks
   //= require bootstrap-sprockets
-  //= require select2
-  //= require nested_form_fields
   //= require bootstrap-datepicker/core
   //= require bootstrap-datepicker/locales/bootstrap-datepicker.zh-CN
   //= require_tree .
```

æ£€æŸ¥çœ‹çœ‹å‰å°åŠŸèƒ½ï¼Œåº”è¯¥ä¸€åˆ‡æ­£å¸¸ã€‚

# 13-1 å¦‚ä½•æ˜¾ç¤ºç”¨æˆ·è¾“å…¥çš„ HTML

åå°åœ¨ç¼–è¾‘ Event æè¿°æ—¶ï¼Œç”¨äº†å¤šè¡Œè¾“å…¥æ¡†(text_area)æ¥è¾“å…¥æ´»åŠ¨æè¿°ã€‚ä¸çŸ¥é“ä½ æœ‰æ²¡æœ‰å°è¯•è¿‡è¾“å…¥ HTML ä»£ç ï¼Œç»“æœä¼šæ€ä¹ˆæ ·ï¼Ÿ ä¾‹å¦‚ä»¥ä¸‹çš„è¾“å…¥ï¼š

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/EH5YbHTRheC6bgGkCkbo_13-1.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/EH5YbHTRheC6bgGkCkbo_13-1.png)

#### simple_format

ç›®å‰åœ¨ `app/views/admin/events/show.html.erb` é¡µé¢ä¸Šï¼Œæ˜¾ç¤ºçš„éƒ¨åˆ†æ˜¯ç”¨ `<%= simple_format @event.description %>`ï¼Œç»“æœæ˜¯ï¼š

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/vf3WOd2jQWi67nbZZz5B_13-2.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/vf3WOd2jQWi67nbZZz5B_13-2.png)

å¥½åƒå“ªé‡Œæ€ªæ€ªçš„ï¼Œé¢œè‰²è·Ÿè¡¨æ ¼ä¸è§äº†ï¼Œè§‚å¯Ÿçœ‹çœ‹åŸå§‹ç :

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/S4SkfbgQjqxJ8rGKV4ti_13-3.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/S4SkfbgQjqxJ8rGKV4ti_13-3.png)

è·Ÿå½“åˆè¾“å…¥çš„ä¸ä¸€æ ·ï¼Œ`table` æ ‡ç±¤ä¸è§äº†ã€`style`å±æ€§ä¹Ÿä¸è§äº†ã€‚è¿™æ˜¯å› ä¸º simple_format çš„å®‰å…¨æœºåˆ¶ä¼šè¿‡æ»¤ HTML çš„è¾“å‡ºã€‚

å¦å¤–ï¼Œ`simple_format` çš„ä½œç”¨æ˜¯æ¢è¡Œï¼šåœ¨è¾“å…¥æ¡†ä¸­çš„æ¢è¡Œï¼Œè¾“å‡ºæ—¶ä¼šå¤šåŒ…ä¸€ä¸ª `<p>` æ ‡ç±¤æ¥åŒºåˆ†æ®µè½ã€‚è¿™é‡Œä¹Ÿçœ‹å‡ºäº† `simple_format` å…¶å®ä¸é€‚åˆç”¨åœ¨ç”¨æˆ·è¾“å…¥ HTML çš„æƒ…å†µï¼Œå› ä¸ºå®ƒä¼šè‡ªä½œèªæ˜å¤šåŒ…ä¸€å±‚ `<p>`ã€‚

#### ç§»é™¤ simple_formatï¼Œæ”¹å› Rails é»˜è®¤è¾“å‡ºè¡Œä¸º

é‚£å¦‚æœä¸è¦ç”¨ `simple_format` helper å‘¢ï¼Œæ¥æ”¹æˆ `<%= @event.description %>`ï¼Œç»“æœæ˜¯ï¼š

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/rrizmUckRh6l2qhIv1CM_13-4.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/rrizmUckRh6l2qhIv1CM_13-4.png)

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/0oNUFg5kRrokTkLmZPbW_13-5.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/0oNUFg5kRrokTkLmZPbW_13-5.png)

è¿™ä¸‹å­ HTML å®Œå…¨è¢«è„±é€¸(escaped)äº†ï¼Œä¾‹å¦‚ `<` ä¼šå˜æˆ `&lt;`ã€‚è¿™æ˜¯ Rails é»˜è®¤çš„å®‰å…¨æœºåˆ¶ï¼Œä½†ä¹Ÿä¸æ˜¯æˆ‘ä»¬è¿™é‡Œæƒ³è¦çš„ç»“æœã€‚

#### raw æˆ– html_safe

é‚£å¯ä»¥å« Rails ä¸è¦è„±é€¸ HTML å—ï¼Ÿæ¥æ”¹æˆ `<%= raw @event.description %>` æˆ– `<%= @event.description.html_safe %>`

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/4jRtbMrAS1ys9WlRTZZl_13-6.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/4jRtbMrAS1ys9WlRTZZl_13-6.png)

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/sXUNF3gFRKuBe8mZnWgv_13-7.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/sXUNF3gFRKuBe8mZnWgv_13-7.png)

ç»“æœçœ‹èµ·æ¥å¯¹äº†ï¼Œä½†æ˜¯ Rails æ—¢ç„¶é»˜è®¤ä¼šè„±é€¸ HTMLï¼Œæƒ³å¿…æœ‰å…¶è®¾è®¡çš„é“ç†å§ï¼Ÿæ²¡é”™ï¼Œè¿™çš„ç¡®ä¼šé€ æˆå®‰å…¨æ€§çš„é—®é¢˜ï¼Œä¾‹å¦‚ç”¨æˆ·å¯ä»¥è¾“å…¥ JavaScript ç¨‹åºï¼š

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/V7ul5K9sTUGNtmsyOL2L_13-8-hack.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/V7ul5K9sTUGNtmsyOL2L_13-8-hack.png)

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/rEpVyrfoRQqniUSFKMZA_13-9-hackyou.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/rEpVyrfoRQqniUSFKMZA_13-9-hackyou.png)

è¿™ä¹ˆå½“å…¶ä»–ç”¨æˆ·æµè§ˆåˆ°è¿™ä¸€é¡µæ—¶ï¼Œæµè§ˆå™¨å°±ä¼šç›²ç›®çš„æ‰§è¡Œè¿™æ®µ JavaScript ä»£ç ï¼Œä¾‹å¦‚è¿™é‡Œä¼šè·³å‡ºæ¼äººçš„ `alert` è§†çª—ï¼Œè€Œæ¶æ„çš„éª‡å®¢ä¼šæ¤å…¥é‚ªæ¶çš„ JavaScript ç¨‹åºï¼Œä¾‹å¦‚è¾“å…¥ `<script>location.href='https://ihower.tw'</script>` å°±ä¼šæŠŠç”¨æˆ·éª—å» ihower è€å¸ˆçš„ç½‘é¡µ ğŸ˜µğŸ˜µğŸ˜µ æˆ–æ˜¯åˆ é™¤ç”¨æˆ·èµ„æ–™æˆ–çªƒå–ç™»å…¥æƒé™ç­‰ç­‰ã€‚è¿™ç§æ”»å‡»æ–¹å¼å«åš [XSS](https://zh.wikipedia.org/zh-cn/%E8%B7%A8%E7%BD%91%E7%AB%99%E6%8C%87%E4%BB%A4%E7%A0%81) è·¨ç«™è„šæœ¬æ”»å‡»ï¼Œæ˜¯æœ€å¸¸è§çš„ç½‘ç»œæ”»å‡»æ‰‹æ³•ä¹‹ä¸€ã€‚ä»»ä½•ç½‘ç«™åªè¦å…è®¸ç”¨æˆ·è¾“å…¥èµ„æ–™ï¼Œå°±æœ‰è¿™ä¸ªé£é™©ã€‚é˜²èŒƒçš„æ–¹å¼å°±æ˜¯åœ¨è¾“å‡ºæ—¶ï¼Œè¿›è¡Œè¿‡æ»¤æˆ–ä¸€å¾‹è„±é€¸ã€‚

è€Œå½“æˆ‘ä»¬ç”¨ `raw` æˆ– `html_safe` çš„è¯ï¼Œå°±æ˜¯å‘Šè¯‰ Rails è¿™ä¸ªè¾“å‡ºå­—ä¸²æ˜¯å®‰å…¨çš„ã€‚

> å½“ç„¶ï¼Œåœ¨è¿™ä¸ªæƒ…å¢ƒä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å‡è®¾èƒ½è¿›å…¥åå°çš„ç”¨æˆ·å°±æ˜¯å¯ä¿¡ä»»çš„ç®¡ç†å‘˜ï¼Œåº”è¯¥ä¸ä¼šè‡ªå·±éª‡è‡ªå·±çš„ç½‘ç«™ï¼Œå› æ­¤ç›´æ¥ `raw` è¾“å‡ºå½“æ˜¯æ— å¦¨ã€‚ä½†å¦‚æœæ˜¯ä¸€èˆ¬ç”¨æˆ·åœ¨å‰å°è¾“å…¥ã€ç¼–è¾‘è‡ªå·±çš„ä¸ªäººèµ„æ–™ï¼Œå°±ä¸èƒ½ä¿¡ä»»äº†ã€‚

#### sanitize ç™½åå•è¿‡æ»¤

éœ€è¦æ˜¾ç¤ºç”¨æˆ·è¾“å…¥çš„ HTML åˆè¦æœ‰å®‰å…¨æ€§ï¼Œé‚£å°±éœ€è¦ä¸€ç§ç™½åå•çš„è¿‡æ»¤æœºåˆ¶äº†ï¼ŒRails æä¾›äº† `sanitize`helperã€‚

è¯·ä¿®æ”¹ `app/views/admin/events/show.html.erb`

```
-  <%= simple_format @event.description %>
+  <%= sanitize @event.description %>
```

ä»¥åŠå‰å°çš„ `app/views/events/show.html.erb`

```
-  <%= simple_format @event.description %>
+  <%= sanitize @event.description %>
```

ç»“æœï¼š

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/FzKAIVKLTj2Z85LhzfCl_13-10-sanitize.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/FzKAIVKLTj2Z85LhzfCl_13-10-sanitize.png)

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/7bxvvNS4R9qNmLUB3GLm_13-11.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/7bxvvNS4R9qNmLUB3GLm_13-11.png)

çœ‹èµ·æ¥æ¯”è¾ƒæ­£å¸¸äº†ï¼Œæ¯”èµ· `simple_format` ä¸ä¼šå¤šç®¡é–’äº‹å¤šåŒ… `<p>` æ ‡ç±¤ï¼Œä½†æ˜¯è¿˜æ˜¯å°‘äº† `table` æ ‡ç±¤å’Œ `style` å±æ€§ã€‚è¿™æ˜¯å› ä¸ºé»˜è®¤çš„ç™½åå•æ˜¯ï¼š

- å…è®¸çš„ HTML æ ‡ç±¤ `strong em b i p code pre tt samp kbd var sub sup dfn cite big small address hr br div span h1 h2 h3 h4 h5 h6 ul ol li dl dt dd abbr acronym a img blockquote del ins`
- å…è®¸çš„ HTML å±æ€§ `href src width height alt cite datetime title class name xml:lang abbr`

æ°å·§ table è·Ÿ style ä¸åœ¨é‡Œé¢ï¼Œæˆ‘ä»¬éœ€è¦è‡ªå·±åŠ ã€‚è¯·ä¿®æ”¹ `config/application.rb`

config/application.rb

```
  class Application < Rails::Application
    config.i18n.default_locale = "zh-CN"
    config.time_zone = "Beijing"

+   config.action_view.sanitized_allowed_tags = Rails::Html::WhiteListSanitizer.allowed_tags + %w(table tr td)
+   config.action_view.sanitized_allowed_attributes = Rails::Html::WhiteListSanitizer.allowed_attributes + %w(style border)
  end

```

é‡å¯æœåŠ¡å™¨ï¼Œå†çœ‹ä¸€æ¬¡ç»“æœï¼š

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/xxwQowAOQUuAAmOnH2n5_13-12-ok.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/xxwQowAOQUuAAmOnH2n5_13-12-ok.png)

[![img](/var/folders/2k/q63b1kcj38j4cfrl_fjx6z1c0000gn/T/net.shinyfrog.bear/BearTemp.2Alzb4/0C3CBA62-230B-4722-89FD-92BD72929082.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/2o7IqjStQxSlFj7Qt25z_13-13-ok.png)

è¿™æ ·å°±æ—¢æ»¡è¶³å®‰å…¨æ€§è¦æ±‚ï¼Œåˆè¾¾åˆ°æˆ‘ä»¬è¦çš„ç»“æœäº†ã€‚

# 13-2 è¾“å…¥ HTMLï¼šä½¿ç”¨ Rich Editor

ä¸Šä¸€èŠ‚ä¸­ï¼Œå°±ç®—æˆ‘ä»¬å…è®¸ HTML è¾“å…¥ï¼Œä½†æ˜¯é‚£ä¸ªè¾“å…¥çš„ç•Œé¢å´ä¸æ˜¯æ™®é€šäººå¯ä»¥æ¥å—çš„ï¼Œæ‰€ä»¥é€šå¸¸æˆ‘ä»¬ç”¨å¦å¤–å®‰è£…æ‰€è§å³æ‰€å¾—(WYSIWYG) çš„ç¼–è¾‘å™¨ï¼Œåˆå«åš Rich Editorã€‚

è¿™ç§ç¼–è¾‘å™¨æ˜¯ä¸€ç§å‰ç«¯ Pluginï¼Œä»Šå¤©å«ç¤ºèŒƒå®‰è£…å…¶ä¸­ä¸€å¥—å«åš [ckeditor](http://ckeditor.com/)ï¼Œè¿™æœ‰ç°æˆçš„ Rails gem <https://github.com/galetahub/ckeditor> å¯ä»¥ç›´æ¥å®‰è£…æ¯”è¾ƒæ–¹ä¾¿ã€‚

ä¿®æ”¹ `Gemfile`

Gemfile

```
+  gem 'ckeditor'
```

ç¼–è¾‘ `app/assets/javascripts/admin.js`

```
  //= require jquery
  //= require jquery_ujs
  //= require turbolinks
  //= require bootstrap-sprockets
  //= require select2
  //= require nested_form_fields
  //= require bootstrap-datepicker/core
  //= require bootstrap-datepicker/locales/bootstrap-datepicker.zh-CN
+ //= require ckeditor/init
```

ç¼–è¾‘ `app/views/admin/events/_form.html.erb`

app/views/admin/events/_form.html.erb

```
-  <%= f.text_area :description, :class => "form-control" %>
+  <%= f.cktext_area :description, ckeditor: { language: 'zh-CN'} %>
```

> å¦‚æœç”¨ `simple_form` çš„è¯ï¼Œå¯ä»¥ç”¨ `f.input :description, as: :ckeditor`

ç¼–è¾‘ `config/initializers/assets.rb`

config/initializers/assets.rb

```
-  # Rails.application.config.assets.precompile += %w( admin.css admin.js )
+  Rails.application.config.assets.precompile += %w( admin.css admin.js ckeditor/* )
```

è¿è¡Œ bundleï¼Œé‡å¯ Rails server

ç¼–è¾‘çœ‹çœ‹ Event å°±æœ‰å‰å®³çš„ç¼–è¾‘å™¨äº†ï¼š

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/FhLZMXHCQLyh7C2EYnlc_13-14-ckeditor.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/FhLZMXHCQLyh7C2EYnlc_13-14-ckeditor.png)

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/vtatM3mSgut7JUN3S5BO_13-15.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/vtatM3mSgut7JUN3S5BO_13-15.png)

å¦‚æœè§‰å¾—é»˜è®¤çš„å·¥å…·åˆ—(toolbar)å¤ªå¤æ‚ï¼Œå¯ä»¥æ”¹ç”¨ mini toolbar é…ç½®ï¼š

app/views/admin/events/_form.html.erb

```
-  <%= f.cktext_area :description, ckeditor: { language: 'zh-CN'} %>
+  <%= f.cktext_area :description, ckeditor: { toolbar: 'mini', language: 'zh-CN'} %>
```

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/h7iXwOsT7qfaigj0bHab_13-16.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/h7iXwOsT7qfaigj0bHab_13-16.png)

Ckeditor è¿˜å¯ä»¥è¿›ä¸€æ­¥è‡ªè®¢ä¹‰å·¥å…·åˆ—çš„é•¿ç›¸ï¼Œå°±è¯·è‡ªè¡Œå‚è€ƒæ–‡æ¡£äº†ã€‚

#### æœ¬èŠ‚ä½œä¸š

##### [ç¬¬äºŒé›†ä½œä¸š](https://fullstack.xinshengdaxue.com/assignments/52)ï¼š[ä½œä¸šäºŒ](https://fullstack.xinshengdaxue.com/tasks/315)

å·²æœ‰ 31 ä¸ªç¬¬ä¸€æœŸåŒå­¦æäº¤äº†è¿™ä¸ªä½œä¸š [**çœ‹çœ‹åŒå­¦æ€ä¹ˆåš](https://fullstack.xinshengdaxue.com/tasks/315/other_answers?order=recent)

[**æäº¤ä½œä¸š](https://fullstack.xinshengdaxue.com/tasks/315)

è¯·å®‰è£… Ckeditor åœ¨ä»»ä¸€ä¸ªé¡¹ç›®ä¸­ï¼Œå¹¶è´´ä¸Šæˆªå›¾ã€‚è®°å¾—ä¹Ÿè¦ä¿®æ”¹æ˜¾ç¤ºçš„éƒ¨åˆ†å…è®¸ HTML è¾“å‡ºã€‚

# 14-1 éœ€æ±‚è¯´æ˜

åœ¨åå°ç¼–è¾‘èµ„æ–™æ—¶ï¼Œå¦‚æœèµ„æ–™å¾ˆå¤šï¼Œæœ‰æ²¡æœ‰ä»€ä¹ˆ UI å¯ä»¥ä¸€æ¬¡ä¿®æ”¹æˆ–åˆ é™¤å¤šç¬”å‘¢ï¼Ÿ è¿™ä¸€ç« å°†å®ä½œé€è¿‡æ ¸é€‰æ–¹å—æ¥åšæ‰¹æ¬¡åˆ é™¤å’Œä¿®æ”¹ã€‚

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/n59xy2wAQSCp8SsqjomP_14-2.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/n59xy2wAQSCp8SsqjomP_14-2.png)

å‹¾é€‰è¦ä¿®æ”¹å“ªäº›æ´»åŠ¨ï¼ŒæŒ‰ä¸‹æœ€ä¸‹é¢çš„æŒ‰é’®å°±ä¼šæ‰¹æ¬¡ä¿®æ”¹ã€‚

# 14-2 æ‰¹æ¬¡åˆ é™¤

å…ˆæ¥åšæ‰¹æ¬¡åˆ é™¤ï¼Œé¦–å…ˆéœ€è¦ä¿®æ”¹ `config/routes.rb`ï¼ŒåŠ ä¸Šä¸€ä¸ªæ–°çš„è·¯ç”±æ¥åšæ‰¹æ¬¡åŠ¨ä½œï¼š

config/routes.rb

```
resources :events do
  resources :tickets, :controller => "event_tickets"

+      collection do
+        post :bulk_update
+      end
end
```

ä¿®æ”¹ `app/views/admin/events/index.html.erb`ï¼Œç”¨ `form_tag` åŒ…ä½æ•´ä¸ª `table`ï¼Œå¹¶åŠ ä¸Šæ ¸é€‰æ–¹å—å’Œæ‰¹æ¬¡åˆ é™¤çš„æŒ‰é’®ï¼š

app/views/admin/events/index.html.erb

```
+  <%= form_tag bulk_update_admin_events_path, :class => "form-inline" do %>
   <table class="table">
   <tr>
+    <th><%= check_box_tag "å…¨é€‰", "1", false, :id => "toggle_all" %></th>

   # ç•¥

   <% @events.each do |event| %>
    <tr>
+     <td>
+       <%= check_box_tag "ids[]", event.id %>
+     </td>

   # ç•¥

   </table>

+    <p><%= submit_tag "æ‰¹æ¬¡åˆ é™¤", :class => "btn btn-danger", :data => { :confirm => "Are you sure?" } %></p>
+  <% end %>

+  <script>
+    // è¿™ä¸ª javascript ä¼šç»‘äº‹ä»¶åœ¨ #toggle_all æ ¸é€‰æ–¹å—ä¸Šï¼Œæ¥åšå…¨é€‰æ•ˆæœ
+    $("#toggle_all").click(function(){
+      if ( $(this).prop("checked") ) {
+        $("input[name='ids[]']").prop("checked", true);
+      } else {
+        $("input[name='ids[]']").prop("checked", false);
+      }
+    })
+  </script>
```

ä¿®æ”¹ `app/controllers/admin/events_controller.rb`ï¼Œå¾ªç¯ `params[:ids]` æ•°ç»„æ‰¾å‡ºæ¯ä¸ª event ç„¶ååˆ é™¤ã€‚

app/controllers/admin/events_controller.rb

```
+  def bulk_update
+    total = 0
+    Array(params[:ids]).each do |event_id|
+      event = Event.find(event_id)
+      event.destroy
+      total += 1
+    end
+
+    flash[:alert] = "æˆåŠŸå®Œæˆ #{total} ç¬”"
+    redirect_to admin_events_path
+  end
```

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/5TDfv99jRj2d1Mh8nUQY_14-1.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/5TDfv99jRj2d1Mh8nUQY_14-1.png)

è¿™æ ·å°±å¯ä»¥æ‰¹æ¬¡åˆ é™¤äº†ã€‚

> Pro Tip å°æŠ€å·§ï¼šå…³äº `Array(params[:ids]` è¿™ä¸ªç”¨æ³•ï¼Œå¦‚æœæ˜¯ `Array([1,2,3])` ä¼šç­‰åŒäº `[1,2,3]`æ²¡å˜ï¼Œä½†æ˜¯ `Array[nil]` ä¼šå˜æˆ `[]` ç©ºæ•°ç»„ï¼Œè¿™å¯ä»¥è®© `.each` æ–¹æ³•ä¸ä¼šå› ä¸º `nil.each` è€Œçˆ†é”™ã€‚å¦‚æœä¸è¿™æ ·å¤„ç†ï¼Œåœ¨æ²¡æœ‰å‹¾é€‰ä»»ä½•æ´»åŠ¨å°±é€å‡ºçš„æƒ…å†µï¼Œå°±ä¼šçˆ†å‡º NoMethodError é”™è¯¯ã€‚é™¤éä½ é¢å¤–æ£€æŸ¥ `params[:id]` å¦‚æœæ˜¯ `nil` å°±è¿”å›ï¼Œä½†ä¸å¦‚ç”¨ `Array` æ¥çš„ç²¾å·§ã€‚

æ³¨æ„æœ¬æ¥çš„ admin layout ä¸­çš„ flash æ ·å¼æœ‰ç‚¹é—®é¢˜ï¼Œè¯·ä¿®æ”¹ `app/views/layouts/admin.html.erb` ä¿®æ­£ä¸€ä¸‹ï¼š

app/views/layouts/admin.html.erb

```
-    <div class="container">
+    <div class="container" style="padding-top: 60px">

-      <p class="notice"><%= notice %></p>
-      <p class="alert"><%= alert %></p>

+      <% if notice %>
+        <p class="notice alert-success"><%= notice %></p>
+      <% end %>

+      <% if alert %>
+        <p class="alert alert-danger"><%= alert %></p>
+      <% end %>
```

# 14-3 æ‰¹æ¬¡ä¿®æ”¹

æ¥ä¸‹æ¥å®ä½œæ‰¹æ¬¡ä¿®æ”¹çŠ¶æ€ã€‚æ³¨æ„åˆ°æˆ‘ä»¬å·²ç»åŒ…äº†ä¸€ä¸ª `form` åœ¨ `table` å¤–é¢äº†ï¼š

- ä¸€ä¸ª form çš„é€å‡º URL ä½ç½®æ˜¯å›ºå®šçš„ï¼Œä¼šè¿›åˆ°åŒä¸€ä¸ª actionã€‚è¿™é‡Œä¼š POST é€å‡ºåˆ° `bulk_update_admin_events_path`
- `form` é‡Œé¢ä¸èƒ½å†åŒ… `form`

é‚£æˆ‘ä»¬è¦æ€ä¹ˆåŒºåˆ«åˆ°åº•æ˜¯è¦åˆ é™¤è¿˜æ˜¯ä¿®æ”¹ï¼Ÿæ‰€å¹¸ï¼ŒæŒ‰é’®çš„æ–‡å­—ä¹Ÿä¼šé€å‡ºå˜æˆå‚æ•°ã€‚è¯·ä¿®æ”¹ `app/views/admin/events/index.html.erb`ï¼ŒåŠ ä¸Šæ‰¹æ¬¡ä¿®æ”¹çš„æŒ‰é’®ï¼Œä»¥åŠçŠ¶æ€çš„ä¸‹æ‹‰é€‰å•ï¼š

app/views/admin/events/index.html.erb

```
   </table>

-   <p><%= submit_tag "æ‰¹æ¬¡åˆ é™¤", :class => "btn btn-danger", :data => { :confirm => "Are you sure?" } %></p>

+   <p>
+   <%= select_tag :event_status, options_for_select( Event::STATUS.map{ |s| [t(s, :scope => + "event.status"), s] }), :class => "form-control" %>
+
+   <%= submit_tag t(:bulk_update), :class => "btn btn-primary" %>
+   <%= submit_tag t(:bulk_delete), :class => "btn btn-danger", :data => { :confirm => "Are you + sure?" } %>
+   </p>

  <% end %>
```

ä¿®æ”¹ `config/locales/zh-CN.yml`

config/locales/zh-CN.yml

```
   "zh-CN":
+    bulk_update: æ‰¹æ¬¡ç¼–è¾‘
+    bulk_delete: æ‰¹æ¬¡åˆ é™¤
```

> å¦‚æœè¦åšè‹±æ–‡ç‰ˆï¼Œè¯·å†ç¼–è¾‘ en.yml åŠ ä¸Šè‹±æ–‡ç¿»è¯‘å³å¯

å¦‚æœè§‚å¯Ÿä¸€ä¸‹ HTML æºç ï¼Œå¯ä»¥çœ‹åˆ°æŒ‰é’®ä¹Ÿæ˜¯æœ‰å‚æ•°çš„ï¼š

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/icBx4QySZe3g4RHWK62m_14-3.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/icBx4QySZe3g4RHWK62m_14-3.png)

æ¥ç€ä¿®æ”¹ `app/controllers/admin/events_controller.rb`ï¼Œæ ¹æ® `params[:commit]` å‚æ•°ï¼Œå°±å¯ä»¥åˆ¤æ–­ç”¨æˆ·å½“åˆæ˜¯æŒ‰ä¸‹åˆ é™¤è¿˜æ˜¯ä¿®æ”¹äº†ï¼š

app/controllers/admin/events_controller.rb

```
     Array(params[:ids]).each do |event_id|
       event = Event.find(event_id)
-      event.destroy
-      total += 1
+
+      if params[:commit] == I18n.t(:bulk_update)
+        event.status = params[:event_status]
+        if event.save
+          total += 1
+        end
+      elsif params[:commit] == I18n.t(:bulk_delete)
+        event.destroy
+        total += 1
+      end
     end
```

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/sMOVxKR4RVepfCD0fiYY_14-2.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/sMOVxKR4RVepfCD0fiYY_14-2.png)

> Pro Tip å°æŠ€å·§ï¼šè¿™é‡Œ ihower è€å¸ˆæ”¹ç”¨äº† I18n æ¥æ˜¾ç¤ºæŒ‰é’®å­—ä¸²ï¼Œè¿™å€’ä¸æ˜¯å› ä¸ºä¸€å®šè¦æ”¯æ´å¤šè¯­è¨€ï¼Œè€Œæ˜¯å› ä¸ºæ–‡æ¡ˆå¯èƒ½ä¼šæ”¹ã€‚å¦‚æœä½ æŒ‰é’®å†™æ­» `<%= submit_tag 'æ‰¹æ¬¡ä¿®æ”¹'` çš„è¯ï¼Œé‚£ä¹ˆåœ¨ controller ä¸­ä¹Ÿéœ€è¦å†™æˆ `if params[:commit] == 'æ‰¹æ¬¡ä¿®æ”¹'`ã€‚å°†æ¥é‚£ä¸€å¤©è¦æ”¹å­—ï¼Œå°±è¦è®°å¾—ä¸¤ä¸ªåœ°æ–¹éƒ½è¦æ”¹åˆ°ã€‚ä½†æ˜¯å¦‚æœç”¨ I18n æ¥å¤„ç†ï¼Œå°±ä¹‹ååªè¦è®°å¾—æ”¹ç¿»è¯‘æ¡£ä¸€ä¸ªåœ°æ–¹å°±å¥½äº†ã€‚è¿™ä¸ªåŸåˆ™å°±å«åš [DRY: Don't repeat yourself](https://zh.wikipedia.org/wiki/%E4%B8%80%E6%AC%A1%E4%B8%94%E4%BB%85%E4%B8%80%E6%AC%A1)ï¼Œè¿™æ˜¯ä¸€ä¸ªå†™å¥½ç¨‹åºçš„åŸºæœ¬åŸåˆ™ã€‚

#### æœ¬èŠ‚ä½œä¸š

##### [ç¬¬äºŒé›†ä½œä¸š](https://fullstack.xinshengdaxue.com/assignments/52)ï¼š[ä½œä¸šä¸‰](https://fullstack.xinshengdaxue.com/tasks/316)

å·²æœ‰ 30 ä¸ªç¬¬ä¸€æœŸåŒå­¦æäº¤äº†è¿™ä¸ªä½œä¸š [**çœ‹çœ‹åŒå­¦æ€ä¹ˆåš](https://fullstack.xinshengdaxue.com/tasks/316/other_answers?order=recent)

[**æäº¤ä½œä¸š](https://fullstack.xinshengdaxue.com/tasks/316)

è¯·åœ¨ä»»ä¸€ä¸ªé¡¹ç›®ä¸­ï¼Œå®ä½œæ‰¹æ¬¡åˆ é™¤ and/or æ‰¹æ¬¡ä¿®æ”¹ï¼Œå¹¶è´´ä¸Šæˆªå›¾ã€‚
