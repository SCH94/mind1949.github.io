---
layout: post
title: "Rails百宝箱第二集"
date: 2017-10-30
tags:
    Rails
    教材
---

#Rails百宝箱第二集

| 9. 嵌套表单(1-to-1) 预计学习时间: 1小时以内            |      |
| ---------------------------------------- | ---- |
| [**  9-1 情境准备](https://fullstack.xinshengdaxue.com/posts/1126) |      |
| [**  9-2 单独的 resource 编辑 UI](https://fullstack.xinshengdaxue.com/posts/1127) |      |
| [**  9-3 嵌套(Nested)表单 UI](https://fullstack.xinshengdaxue.com/posts/1128) |      |
| [**  9-4 Profile 的显示](https://fullstack.xinshengdaxue.com/posts/1129) |      |

| 10. 嵌套表单(1-to-many) 预计学习时间: 1小时以内        |                                          |
| ---------------------------------------- | ---------------------------------------- |
| [**  10-1 情境准备](https://fullstack.xinshengdaxue.com/posts/1130) |                                          |
| [**  10-2 嵌套(Nested)表单 UI](https://fullstack.xinshengdaxue.com/posts/1131) | 共1个作业 \|[** 未完成](https://fullstack.xinshengdaxue.com/posts/1131#task) |
| [**  10-3 单独的 resources 编辑 UI](https://fullstack.xinshengdaxue.com/posts/1132) |                                          |

| 11. 选日期时间的 UI 预计学习时间: 0.5小时以内            |      |
| ---------------------------------------- | ---- |
| [**  11-1 需求说明](https://fullstack.xinshengdaxue.com/posts/1133) |      |
| [**  11-2 安装使用 datepicker](https://fullstack.xinshengdaxue.com/posts/1134) |      |

| 12. 拆开前后台的 CSS 和 JS 预计学习时间: 0.5小时以内      |      |
| ---------------------------------------- | ---- |
| [**  12-1 需求说明](https://fullstack.xinshengdaxue.com/posts/1135) |      |
| [**  12-2 实作拆开](https://fullstack.xinshengdaxue.com/posts/1136) |      |

| 13. Rich Editor 编辑器 预计学习时间: 1小时以内        |                                          |
| ---------------------------------------- | ---------------------------------------- |
| [**  13-1 如何显示用户输入的 HTML](https://fullstack.xinshengdaxue.com/posts/1137) |                                          |
| [**  13-2 输入 HTML：使用 Rich Editor](https://fullstack.xinshengdaxue.com/posts/1138) | 共1个作业 \|[** 未完成](https://fullstack.xinshengdaxue.com/posts/1138#task) |

| 14. 批次编辑 (Bulk Editing) 预计学习时间: 1小时以内    |                                          |
| ---------------------------------------- | ---------------------------------------- |
| [**  14-1 需求说明](https://fullstack.xinshengdaxue.com/posts/1139) |                                          |
| [**  14-2 批次删除](https://fullstack.xinshengdaxue.com/posts/1140) |                                          |
| [**  14-3 批次修改](https://fullstack.xinshengdaxue.com/posts/1141) | 共1个作业 \|[** 未完成](https://fullstack.xinshengdaxue.com/posts/1141#task) |

# 9-1 情境准备

Model 和 Model 之间的数据关联，除了一对多(1-to-many)之外，还有一种是 一对一(1-to-1)，一对一关联算是一对多关联的一种特例情况。

例如，一个常见的设计是让 User 拥有 Profile，并且一个 User 用户只会有一个 Profile 资料。

什么时候会需要一对一的关联设计呢？既然是一对一对应，那么直接合并 profiles 的所有字段在 users table 上，只用一个 User Model 也是可以啊。

会这样设计的主要原因是为了节省数据库查询量，例如用户的 Profile 储存了用户的详细资料，一来很可能只有进到用户详细页面(例如users#show)才会用到、二来可能不是每一个用户都有这个 Profile 细节资料，所以拆表之后可以让绝大部分的操作都不需要去碰到 profiles table。对 User 来说尤其重要，因为登入之后，每一次的浏览，Rails 都会去数据库捞出 User 资料设定 `current_user`

好，那让我们来制作用户 Profile：

执行 `rails g model profile`

编辑 `db/migrate/201XXXXXXXX2545_create_profiles.rb`

201XXXXXXXX2545_create_profiles.rb

```
class CreateProfiles < ActiveRecord::Migration[5.0]
  def change
    create_table :profiles do |t|
      t.integer :user_id, :index => true
      t.string :legal_name
      t.date :birthday
      t.string :location
      t.string :education
      t.string :occupation
      t.text :bio
      t.text :specialty
      t.timestamps
    end
  end
end
```

执行 `rake db:migrate`

编辑 `app/models/user.rb`

app/models/user.rb

```
  class User < ApplicationRecord
+    has_one :profile
```

编辑 `app/models/profile.rb`

app/models/profile.rb

```
  class Profile < ApplicationRecord
+   belongs_to :user
  end
```

接下来示范两种表单 UI 的设计：

- 方案一：单独的 resource 编辑 UI
- 方案二：嵌套(Nested)表单 UI

# 9-2 单独的 resource 编辑 UI

针对 Profile 设计单独的 CRUD，是之前就学过的设计，让我们复习一下如何后台编辑 Profile：

编辑 `config/routes.rb`

config/routes.rb

```
   namespace :admin do
     root "events#index"
     resources :events
-    resources :users
+    resources :users do
+      resource :profile, :controller => "user_profiles"
+    end
  end
```

> 注意：这里用单数 `resource :profile`，关于单数 resource 的说法请参考 4-2 根据用户配置切换时区 一节。另外，因为默认的 controller 的命名是 `profiles`，这里我们偏好自定义命名改为 `user_prorfiles`。

编辑 `app/views/admin/users/index.html.erb`

app/views/admin/users/index.html.erb

```
  <td><%= link_to "Edit", edit_admin_user_path(user), :class => "btn btn-default" %></td>
+ <td><%= link_to "Edit Profile", edit_admin_user_profile_path(user), :class => "btn btn-default" %></td>
```

![BCE8C870-8480-4420-B0E1-67835D8943A4](/var/folders/2k/q63b1kcj38j4cfrl_fjx6z1c0000gn/T/net.shinyfrog.bear/BearTemp.vn6Okw/BCE8C870-8480-4420-B0E1-67835D8943A4.png)

执行 `rails g controller admin::user_profiles`

编辑 `app/controllers/admin/user_profiles_controller.rb`

app/controllers/admin/user_profiles_controller.rb

```
-  class Admin::UserProfilesController < ApplicationController
+  class Admin::UserProfilesController < AdminController
+
+    before_action :find_user_and_profile
+
+    def edit
+    end
+
+    def update
+      if @profile.update(profile_params)
+        redirect_to admin_users_path
+      else
+        render "edit"
+      end
+    end
+
+    protected
+
+    def find_user_and_profile
+      @user = User.find(params[:user_id])
+      # 因为新建的用户并没有 profile，所以这里先检查是否有 @user.profile，如果没有的话就用 @user.create_profile 新建进数据库
+      @profile = @user.profile || @user.create_profile
+    end
+
+    def profile_params
+      params.require(:profile).permit(:legal_name, :birthday, :location, :education, :occupation, :bio, :specialty)
+    end
+
+  end
```

新增 `app/views/admin/user_profiles/edit.html.erb`

app/views/admin/user_profiles/edit.html.erb

```
<h2>Edit User Profile</h2>
<%= form_for @profile, :url => admin_user_profile_path(@user) do |f| %>

  <div class="form-group">
    <%= f.label :legal_name %>
    <%= f.text_field :legal_name, :class => "form-control" %>
  </div>

  <div class="form-group">
    <%= f.label :birthday %>
    <%= f.date_field :birthday, :class => "form-control" %>
  </div>

  <div class="form-group">
    <%= f.label :location %>
    <%= f.text_field :location, :class => "form-control" %>
  </div>

  <div class="form-group">
    <%= f.label :education %>
    <%= f.text_field :education, :class => "form-control" %>
  </div>

  <div class="form-group">
    <%= f.label :occupation %>
    <%= f.text_field :occupation, :class => "form-control" %>
  </div>

  <div class="form-group">
    <%= f.label :bio %>
    <%= f.text_area :bio, :class => "form-control" %>
  </div>

  <div class="form-group">
    <%= f.label :specialty %>
    <%= f.text_area :specialty, :class => "form-control" %>
  </div>

  <div class="form-group">
    <%= f.submit "Submit", :class => "btn btn-primary" %>
  </div>

<% end %>
```

[![img](/var/folders/2k/q63b1kcj38j4cfrl_fjx6z1c0000gn/T/net.shinyfrog.bear/BearTemp.D5HOd7/A0F0989F-732E-44CC-865C-EAA80A8E1FE4.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/DYXRAc4KQreML4AYBzQI_9-2.png)

这样就可以在后台编辑 User Profile 了。



# 9-3 嵌套(Nested)表单 UI

接下来的重头戏是将编辑 User 和编辑 Profile 的表单合并在一起。很多时候这样对用户的操作会更方便，一次就可以编辑两个 Model 的资料。接下来示范如何在前台做这个 UI。

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/UTAwvoVLQQWmXchavBT4_9-3.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/UTAwvoVLQQWmXchavBT4_9-3.png)

编辑 `app/models/user.rb`

app/models/user.rb

```
+  accepts_nested_attributes_for :profile
```

编辑 `app/controllers/users_controller.rb`

app/controllers/users_controller.rb

```
   def edit
     @user = current_user
     # 跟刚才后台情况一样，如果没有 @user.profile，要先新建一个
     # unless @user.profile 等同于 if !@user.profile 或 if @user.profile.nil?
+    @user.create_profile unless @user.profile
   end

   # (略)

   def user_params
-    params.require(:user).permit(:time_zone)
+    params.require(:user).permit(:time_zone, :profile_attributes => [:id, :legal_name, :birthday, :location, :education, :occupation, :bio, :specialty] )
   end
```

Rails 的 [accepts_nested_attributes_for](http://api.rubyonrails.org/classes/ActiveRecord/NestedAttributes/ClassMethods.html) 作用是可以在更新 User 时，也顺便可以更新 Profile 资料。

编辑 `app/views/users/edit.html.erb` 把 Profile 的表单加在本来的 User 表单里面：

app/views/users/edit.html.erb

```
  <h2>Edit User</h2>

  <%= form_for @user do |f| %>

    <div class="form-group">
      <%= f.label :time_zone %>
      <%= f.time_zone_select :time_zone %>
    </div>

+   <%= f.fields_for :profile do |ff| %>
+     <div class="form-group">
+       <%= ff.label :legal_name %>
+       <%= ff.text_field :legal_name, :class => "form-control" %>
+     </div>
+
+     <div class="form-group">
+       <%= ff.label :birthday %>
+       <%= ff.date_field :birthday, :class => "form-control" %>
+     </div>
+
+     <div class="form-group">
+       <%= ff.label :location %>
+       <%= ff.text_field :location, :class => "form-control" %>
+     </div>
+
+     <div class="form-group">
+       <%= ff.label :education %>
+       <%= ff.text_field :education, :class => "form-control" %>
+     </div>
+
+     <div class="form-group">
+       <%= ff.label :occupation %>
+       <%= ff.text_field :occupation, :class => "form-control" %>
+     </div>
+
+     <div class="form-group">
+       <%= ff.label :bio %>
+       <%= ff.text_area :bio, :class => "form-control" %>
+     </div>
+
+     <div class="form-group">
+       <%= ff.label :specialty %>
+       <%= ff.text_area :specialty, :class => "form-control" %>
+     </div>
+   <% end %>

    <div class="form-group">
      <%= f.submit "Save", :class => "btn btn-primary" %>
    </div>

<% end %>
```

这样就完成了，你可以送出编辑看看。

> 用这种嵌套(Nested)表单 UI 的话，我们不需要编辑 routes.rb 加上 profile 路由，也不需要 profiles_controller，因为透过 users_controller 就可以完成了。

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/hVbc3UaTKiYblYJtmGHn_9-4.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/hVbc3UaTKiYblYJtmGHn_9-4.png)

# 9-4 Profile 的显示

接着增加显示页面看看。

修改 `app/controllers/users_controller.rb`，新增 `show` action，顺便重构一下都先调用 `find_user`方法。

app/controllers/users_controller.rb

```
  class UsersController < ApplicationController

    before_action :authenticate_user!
+   before_action :find_user

+   def show
+   end

    def edit
-     @user = current_user
    end

   def update
-    @user = current_user
     if @user.update(user_params)
       flash[:notice] = "修改成功"
       redirect_to edit_user_path
     else
       render "edit"
     end
   end

   # (略)

   protected

+  def find_user
+    @user = current_user
+    @user.create_profile unless @user.profile
+  end

   # (略)
```

新增 `app/views/users/show.html.erb`

```
<h1>我的个人资料</h1>

<p>Email: <%= @user.email %></p>
<p>Timezone: <%= @user.time_zone %></p>
<p>Birthday: <%= @user.profile.birthday %></p>
<p>Bio: <%= simple_format @user.profile.bio %></p>
```

编辑 `app/views/layout/application.html.erb` 修改主选单加上这个连结，

app/views/layout/application.html.erb

```
+   <li><%= link_to('我的个人资料', user_path) %></li>
    <li><%= link_to('修改个人资料', edit_user_path) %></li>
```

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/bzROdUTR9ulky9ZwNdLf_9-6.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/bzROdUTR9ulky9ZwNdLf_9-6.png)

# 10-1 情境准备

情境：管理员在后台可以编辑活动有不同票种(Ticket)，一个活动会有很多个票种。

我们需要新增一个 Ticket model，并让 Event has_many tickets。

执行 `rails g model ticket`

编辑 `db/migrate/20170423111008_create_tickets.rb`

db/migrate/20170423111008_create_tickets.rb

```
  class CreateTickets < ActiveRecord::Migration[5.0]
    def change
      create_table :tickets do |t|
+       t.integer :event_id, :index => true
+       t.string :name
+       t.text :description
+       t.integer :price
+       t.timestamps
      end
    end
  end
```

执行 `rake db:migrate`

编辑 `app/models/event.rb`

app/models/event.rb

```
+  has_many :tickets, :dependent => :destroy
```

编辑 `app/models/ticket.rb`

```
  class Ticket < ApplicationRecord
+   validates_presence_of :name, :price
+   belongs_to :event
  end
```

接下有两种 UI 方案：

- 方案一：单独的 resources 编辑 UI
- 方案二：嵌套(Nested)表单 UI

# 10-2 嵌套(Nested)表单 UI

让我们直接进入重点，制作嵌套(Nested)表单 UI。将编辑 Event 和编辑 Ticket 的表单合并在一起。因为一个活动会有的 Ticket 票种也不是很多，而 Ticket 的字段也不是很多，合并在一起编辑对用户的操作会更方便，一次就可以编辑两个 Model 的资料。

再次编辑 `app/models/event.rb`，加上 `accepts_nested_attributes_for` 宣告：

app/models/event.rb

```
-  has_many :tickets, :dependent => :destroy
+  has_many :tickets, :dependent => :destroy, :inverse_of  => :event
+  accepts_nested_attributes_for :tickets, :allow_destroy => true, :reject_if => :all_blank

```

> 某些版本的Rails 有个accepts_nested_attributes_for 的[bug](https://github.com/rails/rails/issues/18672) 让has_many 故障了，需要额外补上`inverse_of` 参数，不然存储时会找不到tickets

编辑 `app/controllers/admin/events_controller.rb`

app/controllers/admin/events_controller.rb

```
   def new
     @event = Event.new
+    @event.tickets.build
+    @event.tickets.build
   end

   # (略)

   def edit
     @event = Event.find_by_friendly_id!(params[:id])
+    @event.tickets.build
+    @event.tickets.build
   end

   # (略)

   def event_params
-    params.require(:event).permit(:name, :description, :friendly_id, :status, :category_id)
+    params.require(:event).permit(:name, :description, :friendly_id, :status, :category_id, :tickets_attributes => [:id, :name, :description, :price, :_destroy])
   end
```

> 这里 `@event.tickets.build` 两次，等会表单中就有两笔空的 Ticket 可以编辑。Strong Parameters 的部分，新增了 `tickets_attributes` 数组包含要修改的 ticket 属性，并且额外多了一个 `:id` 和 `:_destroy` 是为了配合 `accepts_nested_attributes_for` 可以编辑和删除。

编辑 `app/views/admin/events/_form.html.erb`

app/views/admin/events/_form.html.erb

```
+  <%= f.fields_for :tickets do |ff| %>
+    <fieldset style="border-left: 5px solid #bbb; margin-bottom: 10px; padding: 10px;">
+      <legend>Ticket</legend>
+      <div class="form-group">
+        <%= ff.label :name %>
+        <%= ff.text_field :name, :class => "form-control" %>
+      </div>
+
+      <div class="form-group">
+        <%= ff.label :price %>
+        <%= ff.number_field :price, :class => "form-control" %>
+      </div>
+
+      <div class="form-group">
+        <%= ff.label :description %>
+        <%= ff.text_area :description, :class => "form-control" %>
+      </div>
+    </fieldset>
+  <% end %>
```

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/0lkrbRHWSU2ZU6VcCWwx_10-1.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/0lkrbRHWSU2ZU6VcCWwx_10-1.png)

这个 UI 做到这里，我们写死了固定新增两笔，似乎美中不足啊 :(

有没有办法可以在 UI 上动态一直新增? 这会需要 JavaScript 的协助，这里我们直接安装一个 [nested_form_fields](https://github.com/ncri/nested_form_fields) gem：

编辑 `Gemfile`

Gemfile

```
+  gem "nested_form_fields"
```

执行 bundle 然后重启服务器

编辑 `app/assets/javascripts/application.js`

app/assets/javascripts/application.js

```
+  //= require nested_form_fields
   //= require_tree .
```

再次编辑 `app/controllers/admin/events_controller.rb`

app/controllers/admin/events_controller.rb

```
   def new
     @event = Event.new
     @event.tickets.build
-    @event.tickets.build
   end
     # (略)
   def edit
     @event = Event.find_by_friendly_id!(params[:id])
-    @event.tickets.build
-    @event.tickets.build
+    @event.tickets.build if @event.tickets.empty?
   end
```

再次编辑 `app/views/admin/events/_form.html.erb`

app/views/admin/events/_form.html.erb

```
-  <%= f.fields_for :tickets do |ff| %>
+  <%= f.nested_fields_for :tickets do |ff| %>
     <fieldset style="border-left: 5px solid #bbb; margin-bottom: 10px;  padding: 10px;">
       <legend>Ticket</legend>
       <div class="form-group">
         <%= ff.label :name %>
         <%= ff.text_field :name, :class => "form-control" %>
       </div>

       <div class="form-group">
         <%= ff.label :price %>
         <%= ff.number_field :price, :class => "form-control" %>
       </div>

       <div class="form-group">
         <%= ff.label :description %>
         <%= ff.text_area :description, :class => "form-control" %>
       </div>
     </fieldset>
+    <%= ff.remove_nested_fields_link "移除这个票种", :class => "btn btn-danger" %>
   <% end %>
+  <p class="text-right">
+    <%= f.add_nested_fields_link :tickets, "新增票种", :class => "btn btn-default" %>
+  </p>
```

最后成果，是个很漂亮的 UI 可以动态新增和删除：

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/JrE4AMxsQwSLhMWmWCIx_10-2.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/JrE4AMxsQwSLhMWmWCIx_10-2.png)

#### 本节作业

##### [第二集作业](https://fullstack.xinshengdaxue.com/assignments/52)：[作业一](https://fullstack.xinshengdaxue.com/tasks/314)

已有 30 个第一期同学提交了这个作业 [**看看同学怎么做](https://fullstack.xinshengdaxue.com/tasks/314/other_answers?order=recent)

[**提交作业](https://fullstack.xinshengdaxue.com/tasks/314)

请实作 Nested-form 表单(1-to-many) 在任一个项目，并贴上 gif 完成图。

# 10-3 单独的 resources 编辑 UI

如果 has_many 的资料非常多、字段又多的话，就不适合用嵌套(Nested)表单 UI。独立的 CRUD 你应该已经有能力可以完成了，做为复习，这里还是快速示范一下：

编辑 `config/routes.rb`

config/routes.rb

```
  namespace :admin do
    # (略)
-   resources :events
+   resources :events do
+     resources :tickets, :controller => "event_tickets"
+   end
```

执行 `rails g controller admin::event_tickets`

编辑 `app/controllers/admin/event_tickets_controller.rb`

app/controllers/admin/event_tickets_controller.rb

```
-  class Admin::EventTicketsController < ApplicationController
+  class Admin::EventTicketsController < AdminController
+
+   before_action :find_event
+
+   def index
+     @tickets = @event.tickets
+   end
+
+   def new
+     @ticket = @event.tickets.new
+   end
+
+   def create
+     @ticket = @event.tickets.new(ticket_params)
+     if @ticket.save
+       redirect_to admin_event_tickets_path(@event)
+     else
+       render "new"
+     end
+   end
+
+   def edit
+     @ticket = @event.tickets.find(params[:id])
+   end
+
+   def update
+     @ticket = @event.tickets.find(params[:id])
+
+     if @ticket.update(ticket_params)
+       redirect_to admin_event_tickets_path(@event)
+     else
+       render "edit"
+     end
+   end
+
+   def destroy
+     @ticket = @event.tickets.find(params[:id])
+     @ticket.destroy
+
+     redirect_to admin_event_tickets_path(@event)
+   end
+
+   protected
+
+   def find_event
+     @event = Event.find_by_friendly_id!(params[:event_id])
+   end
+
+   def ticket_params
+     params.require(:ticket).permit(:name, :price, :description)
+   end

  end
```

编辑 `app/views/admin/events/index.html.erb`

app/views/admin/events/index.html.erb

```
+  <%= link_to "Tickets", admin_event_tickets_path(event), :class => "btn btn-default" %>
   <%= link_to "Edit", edit_admin_event_path(event), :class => "btn btn-default" %>
```

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/wbYnS6uKQaCySRBX2wO9_10-4.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/wbYnS6uKQaCySRBX2wO9_10-4.png)

新增 `app/views/admin/event_tickets/index.html.erb`

app/views/admin/event_tickets/index.html.erb

```
<h1><%= @event.name %> / Tickets</h1>

<p class="text-right">
<%= link_to "New Ticket", new_admin_event_ticket_path(@event), :class => "btn btn-primary" %>
</p>

<table class="table">
<tr>
  <th>Name</th>
  <th>Price</th>
  <th>Description</th>
  <th>Actions</th>
</tr>
<% @tickets.each do |ticket| %>
  <tr>
    <td><%= ticket.name %></td>
    <td><%= ticket.price %></td>
    <td><%= simple_format ticket.description %></td>
    <td>
      <%= link_to "Edit", edit_admin_event_ticket_path(@event, ticket), :class => "btn btn-default" %>
      <%= link_to "Delete", admin_event_ticket_path(@event, ticket), :method => "delete", :data => { :confirm => "Are you sure?" }, :class => "btn btn-danger" %>
  </tr>
<% end %>
</table>
```

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/Lz8BXuYBQhmEpfojL5uS_10-3.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/Lz8BXuYBQhmEpfojL5uS_10-3.png)

新增 `app/views/admin/event_tickets/new.html.erb`

app/views/admin/event_tickets/new.html.erb

```
<h1>New Ticket</h1>

<%= form_for [:admin, @event, @ticket] do |f| %>

  <%= render :partial => "form", :locals => { :f => f } %>

  <div class="form-group">
    <%= f.submit "Create", :class => "btn btn-primary" %>
    <%= link_to "Cancel", admin_event_tickets_path(@event) %>
  </div>
<% end %>
```

新增 `app/views/admin/event_tickets/edit.html.erb`

app/views/admin/event_tickets/edit.html.erb

```
<h1>Edit Ticket</h1>

<%= form_for [:admin, @event, @ticket] do |f| %>

  <%= render :partial => "form", :locals => { :f => f } %>

  <div class="form-group">
    <%= f.submit "Update", :class => "btn btn-primary" %>
    <%= link_to "Cancel", admin_event_tickets_path(@event) %>
  </div>

<% end %>
```

新增 `app/views/admin/event_tickets/_form.html.erb`

app/views/admin/event_tickets/_form.html.erb

```
<% if @ticket.errors.any? %>
  <div id="error_explanation">
    <ul>
    <% @ticket.errors.full_messages.each do |msg| %>
      <li><%= msg %></li>
    <% end %>
    </ul>
  </div>
<% end %>

<div class="form-group">
  <%= f.label :name %>
  <%= f.text_field :name, :class => "form-control" %>
</div>

<div class="form-group">
  <%= f.label :price %>
  <%= f.number_field :price, :class => "form-control" %>
</div>

<div class="form-group">
  <%= f.label :description %>
  <%= f.text_area :description, :class => "form-control" %>
</div>
```

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/kNZDEaLWR8mI9iVEVILB_10-5.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/kNZDEaLWR8mI9iVEVILB_10-5.png)

# 11-1 需求说明

之前我们在后台编辑 User Profile 的生日时，用的是

app/views/admin/user_profiles/edit.html.erb

```
<%= f.date_field :birthday, :class => "form-control" %>
```

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/DgdJkBaScma2QZ8CV8Ce_11-3.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/DgdJkBaScma2QZ8CV8Ce_11-3.png)

这个 UI 是用浏览器内建的 `<input type="date">` 输入框，不过很可惜，这种 input 除了 Chrome 浏览器之外是不太支援的，详见 [Can I use?](http://caniuse.com/#feat=input-datetime) 的统计资料。因此后台用还可以，因为你可以要求管理员统一用 Chrome 浏览器，但是前台要给一般用户就不太好了。

Rails 也有另外内建一种用下拉选单的方式：

app/views/admin/user_profiles/edit.html.erb

```
<%= f.date_select :birthday, :class => "form-control" %>
```

这会产生三个下拉选单：

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/f3ignv3SVij8wJvIHKXt_11-4.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/f3ignv3SVij8wJvIHKXt_11-4.png)

这种下拉选单就没有浏览器支援的问题，但是就是有点丑而且没有日历，我们想要 📅 啊。

这一章将介绍使用 [bootstrap-datepicker](https://uxsolutions.github.io/bootstrap-datepicker/) 这个 jQuery Plugin，可以获得日历般的点选接口。

> bootstrap-datepicker 只有日期，如果需要日期加上时间，可以用 [bootstrap-datetimepicker](http://eonasdan.github.io/bootstrap-datetimepicker/) 这个 jQuery Plugin，以及包好的 [bootstrap3-datetimepicker-rails](https://github.com/TrevorS/bootstrap3-datetimepicker-rails) gem。

# 11-2 安装使用 datepicker

[bootstrap-datepicker](https://uxsolutions.github.io/bootstrap-datepicker/) 是个 jQuery Plugin，并且有现成包好的 gem 可以直接使用 [bootstrap-datepicker-rails](https://github.com/Nerian/bootstrap-datepicker-rails)。

编辑 `Gemfile`

Gemfile

```
+  gem 'bootstrap-datepicker-rails'
```

执行 `bundle` 后，重启服务器

编辑 `app/assets/stylesheets/application.scss`

app/assets/stylesheets/application.scss

```
   @import "bootstrap-sprockets";
   @import "bootstrap";
   @import "select2";
   @import "select2-bootstrap";
+  @import "bootstrap-datepicker3";
```

编辑 `app/assets/javascripts/application.js`

app/assets/javascripts/application.js

```
   //= require jquery
   //= require jquery_ujs
   //= require turbolinks
   //= require bootstrap-sprockets
   //= require select2
   //= require nested_form_fields
+  //= require bootstrap-datepicker/core
+  //= require bootstrap-datepicker/locales/bootstrap-datepicker.zh-CN
   //= require_tree .
```

编辑 `app/views/users/edit.html.erb`，将 script 放到最下方：

app/views/users/edit.html.erb

```
-  <%= ff.date_field :birthday, :class => "form-control" %>
+  <%= ff.text_field :birthday, :class => "form-control" %>

   # 略

+  <script>
+    $("#user_profile_attributes_birthday").datepicker({ format: "yyyy-mm-dd" });
+  </script>
```

注意格式要指定以配合 Rails，这里指定成 `"yyyy-mm-dd"` 年月日的顺序。

其中 `#user_profile_attributes_birthday` 这个 HTML ID 可以透过 Chrome 按右键透过 Inspect 观察得知：

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/fRMgcp9jQYGbLXq7yNj2_11-0.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/fRMgcp9jQYGbLXq7yNj2_11-0.png)

这是成果：

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/puMQftqjT1eTRtkjF57q_11-1.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/puMQftqjT1eTRtkjF57q_11-1.png)

如果需要支援多语言，可以指定语言：

```
<script>
  $("#user_profile_attributes_birthday").datepicker({ format: "yyyy-mm-dd", language: "<%= I18n.locale %>" });
</script>
```

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/sR6WptvZQKyT14SR3kAz_11-6.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/sR6WptvZQKyT14SR3kAz_11-6.png)

# 12-1 需求说明

我们学过如何拆 layout 了：默认的 layout 是 `app/views/layouts/application.html.erb`，而后台的 controller 我们透过 `layout "admin"` 可以改用 `app/views/layouts/admin.html.erb`。

但是有个部分我们没有拆开，那就是 css 和 javascript，到目前还是共享 `app/assets/stylesheets/application.scss` 和 `app/assets/javascript/application.js`。

随着 Plugins 功能越装越多，有很多 css/js 前后台是不一样的，例如我们后来装的 `select2` 和 `nested_form_fields` plugins，前台目前没有用到，但是因为前后台共享的关系，还是被用户下载了。

这部分的 css/js 也可以前后台拆开，除了可以让前台下载更有效率，也可以让代码分开管理。

# 12-2 实作拆开

新增 `app/assets/stylesheets/admin.scss`

```
@import "bootstrap-sprockets";
@import "bootstrap";
@import "select2";
@import "select2-bootstrap";
@import "bootstrap-datepicker3";
```

新增 `app/assets/javascripts/admin.js`

```
//= require jquery
//= require jquery_ujs
//= require turbolinks
//= require bootstrap-sprockets
//= require select2
//= require nested_form_fields
//= require bootstrap-datepicker/core
//= require bootstrap-datepicker/locales/bootstrap-datepicker.zh-CN
```

修改 `config/initializers/assets.rb`

config/initializers/assets.rb

```
- # Rails.application.config.assets.precompile += %w( search.js )

+ Rails.application.config.assets.precompile += %w( admin.css admin.js )
```

这会告诉 Rails 编译 assets 时要多编译这两个进入点档案。

重启 Rails 服务器

修改 `app/views/layouts/admin.html.erb`，换成载入 admin css 和 js

app/views/layouts/admin.html.erb

```
-  <%= stylesheet_link_tag    'application', media: 'all', 'data-turbolinks-track': 'reload' %>
+ <%= stylesheet_link_tag    'admin', media: 'all', 'data-turbolinks-track': 'reload' %>

-  <%= javascript_include_tag 'application', 'data-turbolinks-track': 'reload' %>
+  <%= javascript_include_tag 'admin', 'data-turbolinks-track': 'reload' %>
```

浏览看看后台，一切应正常。

如果检视一下 HTML 源码，可以看到已经顺利改用 admin css 和 js 了：

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/ijBWWSBRlwhp8vw0giOQ_12.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/ijBWWSBRlwhp8vw0giOQ_12.png)

既然是前后台拆开了，接着可以瘦身一下前台的 css 和 js，来把 `select2` 和 `nested_form_fields` 移除。

修改 `app/assets/stylesheets/application.scss`

app/assets/stylesheets/application.scss

```
   @import "bootstrap-sprockets";
   @import "bootstrap";
-  @import "select2";
-  @import "select2-bootstrap";
   @import "bootstrap-datepicker3";
```

修改 `app/assets/javascripts/application.js`

app/assets/javascripts/application.js

```
   //= require jquery
   //= require jquery_ujs
   //= require turbolinks
   //= require bootstrap-sprockets
-  //= require select2
-  //= require nested_form_fields
   //= require bootstrap-datepicker/core
   //= require bootstrap-datepicker/locales/bootstrap-datepicker.zh-CN
   //= require_tree .
```

检查看看前台功能，应该一切正常。

# 13-1 如何显示用户输入的 HTML

后台在编辑 Event 描述时，用了多行输入框(text_area)来输入活动描述。不知道你有没有尝试过输入 HTML 代码，结果会怎么样？ 例如以下的输入：

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/EH5YbHTRheC6bgGkCkbo_13-1.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/EH5YbHTRheC6bgGkCkbo_13-1.png)

#### simple_format

目前在 `app/views/admin/events/show.html.erb` 页面上，显示的部分是用 `<%= simple_format @event.description %>`，结果是：

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/vf3WOd2jQWi67nbZZz5B_13-2.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/vf3WOd2jQWi67nbZZz5B_13-2.png)

好像哪里怪怪的，颜色跟表格不见了，观察看看原始码:

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/S4SkfbgQjqxJ8rGKV4ti_13-3.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/S4SkfbgQjqxJ8rGKV4ti_13-3.png)

跟当初输入的不一样，`table` 标籤不见了、`style`属性也不见了。这是因为 simple_format 的安全机制会过滤 HTML 的输出。

另外，`simple_format` 的作用是换行：在输入框中的换行，输出时会多包一个 `<p>` 标籤来区分段落。这里也看出了 `simple_format` 其实不适合用在用户输入 HTML 的情况，因为它会自作聪明多包一层 `<p>`。

#### 移除 simple_format，改回 Rails 默认输出行为

那如果不要用 `simple_format` helper 呢，来改成 `<%= @event.description %>`，结果是：

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/rrizmUckRh6l2qhIv1CM_13-4.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/rrizmUckRh6l2qhIv1CM_13-4.png)

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/0oNUFg5kRrokTkLmZPbW_13-5.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/0oNUFg5kRrokTkLmZPbW_13-5.png)

这下子 HTML 完全被脱逸(escaped)了，例如 `<` 会变成 `&lt;`。这是 Rails 默认的安全机制，但也不是我们这里想要的结果。

#### raw 或 html_safe

那可以叫 Rails 不要脱逸 HTML 吗？来改成 `<%= raw @event.description %>` 或 `<%= @event.description.html_safe %>`

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/4jRtbMrAS1ys9WlRTZZl_13-6.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/4jRtbMrAS1ys9WlRTZZl_13-6.png)

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/sXUNF3gFRKuBe8mZnWgv_13-7.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/sXUNF3gFRKuBe8mZnWgv_13-7.png)

结果看起来对了，但是 Rails 既然默认会脱逸 HTML，想必有其设计的道理吧？没错，这的确会造成安全性的问题，例如用户可以输入 JavaScript 程序：

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/V7ul5K9sTUGNtmsyOL2L_13-8-hack.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/V7ul5K9sTUGNtmsyOL2L_13-8-hack.png)

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/rEpVyrfoRQqniUSFKMZA_13-9-hackyou.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/rEpVyrfoRQqniUSFKMZA_13-9-hackyou.png)

这么当其他用户浏览到这一页时，浏览器就会盲目的执行这段 JavaScript 代码，例如这里会跳出恼人的 `alert` 视窗，而恶意的骇客会植入邪恶的 JavaScript 程序，例如输入 `<script>location.href='https://ihower.tw'</script>` 就会把用户骗去 ihower 老师的网页 😵😵😵 或是删除用户资料或窃取登入权限等等。这种攻击方式叫做 [XSS](https://zh.wikipedia.org/zh-cn/%E8%B7%A8%E7%BD%91%E7%AB%99%E6%8C%87%E4%BB%A4%E7%A0%81) 跨站脚本攻击，是最常见的网络攻击手法之一。任何网站只要允许用户输入资料，就有这个风险。防范的方式就是在输出时，进行过滤或一律脱逸。

而当我们用 `raw` 或 `html_safe` 的话，就是告诉 Rails 这个输出字串是安全的。

> 当然，在这个情境中，我们可以假设能进入后台的用户就是可信任的管理员，应该不会自己骇自己的网站，因此直接 `raw` 输出当是无妨。但如果是一般用户在前台输入、编辑自己的个人资料，就不能信任了。

#### sanitize 白名单过滤

需要显示用户输入的 HTML 又要有安全性，那就需要一种白名单的过滤机制了，Rails 提供了 `sanitize`helper。

请修改 `app/views/admin/events/show.html.erb`

```
-  <%= simple_format @event.description %>
+  <%= sanitize @event.description %>
```

以及前台的 `app/views/events/show.html.erb`

```
-  <%= simple_format @event.description %>
+  <%= sanitize @event.description %>
```

结果：

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/FzKAIVKLTj2Z85LhzfCl_13-10-sanitize.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/FzKAIVKLTj2Z85LhzfCl_13-10-sanitize.png)

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/7bxvvNS4R9qNmLUB3GLm_13-11.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/7bxvvNS4R9qNmLUB3GLm_13-11.png)

看起来比较正常了，比起 `simple_format` 不会多管閒事多包 `<p>` 标籤，但是还是少了 `table` 标籤和 `style` 属性。这是因为默认的白名单是：

- 允许的 HTML 标籤 `strong em b i p code pre tt samp kbd var sub sup dfn cite big small address hr br div span h1 h2 h3 h4 h5 h6 ul ol li dl dt dd abbr acronym a img blockquote del ins`
- 允许的 HTML 属性 `href src width height alt cite datetime title class name xml:lang abbr`

恰巧 table 跟 style 不在里面，我们需要自己加。请修改 `config/application.rb`

config/application.rb

```
  class Application < Rails::Application
    config.i18n.default_locale = "zh-CN"
    config.time_zone = "Beijing"

+   config.action_view.sanitized_allowed_tags = Rails::Html::WhiteListSanitizer.allowed_tags + %w(table tr td)
+   config.action_view.sanitized_allowed_attributes = Rails::Html::WhiteListSanitizer.allowed_attributes + %w(style border)
  end

```

重启服务器，再看一次结果：

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/xxwQowAOQUuAAmOnH2n5_13-12-ok.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/xxwQowAOQUuAAmOnH2n5_13-12-ok.png)

[![img](/var/folders/2k/q63b1kcj38j4cfrl_fjx6z1c0000gn/T/net.shinyfrog.bear/BearTemp.2Alzb4/0C3CBA62-230B-4722-89FD-92BD72929082.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/2o7IqjStQxSlFj7Qt25z_13-13-ok.png)

这样就既满足安全性要求，又达到我们要的结果了。

# 13-2 输入 HTML：使用 Rich Editor

上一节中，就算我们允许 HTML 输入，但是那个输入的界面却不是普通人可以接受的，所以通常我们用另外安装所见即所得(WYSIWYG) 的编辑器，又叫做 Rich Editor。

这种编辑器是一种前端 Plugin，今天叫示范安装其中一套叫做 [ckeditor](http://ckeditor.com/)，这有现成的 Rails gem <https://github.com/galetahub/ckeditor> 可以直接安装比较方便。

修改 `Gemfile`

Gemfile

```
+  gem 'ckeditor'
```

编辑 `app/assets/javascripts/admin.js`

```
  //= require jquery
  //= require jquery_ujs
  //= require turbolinks
  //= require bootstrap-sprockets
  //= require select2
  //= require nested_form_fields
  //= require bootstrap-datepicker/core
  //= require bootstrap-datepicker/locales/bootstrap-datepicker.zh-CN
+ //= require ckeditor/init
```

编辑 `app/views/admin/events/_form.html.erb`

app/views/admin/events/_form.html.erb

```
-  <%= f.text_area :description, :class => "form-control" %>
+  <%= f.cktext_area :description, ckeditor: { language: 'zh-CN'} %>
```

> 如果用 `simple_form` 的话，可以用 `f.input :description, as: :ckeditor`

编辑 `config/initializers/assets.rb`

config/initializers/assets.rb

```
-  # Rails.application.config.assets.precompile += %w( admin.css admin.js )
+  Rails.application.config.assets.precompile += %w( admin.css admin.js ckeditor/* )
```

运行 bundle，重启 Rails server

编辑看看 Event 就有厉害的编辑器了：

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/FhLZMXHCQLyh7C2EYnlc_13-14-ckeditor.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/FhLZMXHCQLyh7C2EYnlc_13-14-ckeditor.png)

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/vtatM3mSgut7JUN3S5BO_13-15.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/vtatM3mSgut7JUN3S5BO_13-15.png)

如果觉得默认的工具列(toolbar)太复杂，可以改用 mini toolbar 配置：

app/views/admin/events/_form.html.erb

```
-  <%= f.cktext_area :description, ckeditor: { language: 'zh-CN'} %>
+  <%= f.cktext_area :description, ckeditor: { toolbar: 'mini', language: 'zh-CN'} %>
```

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/h7iXwOsT7qfaigj0bHab_13-16.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/h7iXwOsT7qfaigj0bHab_13-16.png)

Ckeditor 还可以进一步自订义工具列的长相，就请自行参考文档了。

#### 本节作业

##### [第二集作业](https://fullstack.xinshengdaxue.com/assignments/52)：[作业二](https://fullstack.xinshengdaxue.com/tasks/315)

已有 31 个第一期同学提交了这个作业 [**看看同学怎么做](https://fullstack.xinshengdaxue.com/tasks/315/other_answers?order=recent)

[**提交作业](https://fullstack.xinshengdaxue.com/tasks/315)

请安装 Ckeditor 在任一个项目中，并贴上截图。记得也要修改显示的部分允许 HTML 输出。

# 14-1 需求说明

在后台编辑资料时，如果资料很多，有没有什么 UI 可以一次修改或删除多笔呢？ 这一章将实作透过核选方块来做批次删除和修改。

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/n59xy2wAQSCp8SsqjomP_14-2.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/n59xy2wAQSCp8SsqjomP_14-2.png)

勾选要修改哪些活动，按下最下面的按钮就会批次修改。

# 14-2 批次删除

先来做批次删除，首先需要修改 `config/routes.rb`，加上一个新的路由来做批次动作：

config/routes.rb

```
resources :events do
  resources :tickets, :controller => "event_tickets"

+      collection do
+        post :bulk_update
+      end
end
```

修改 `app/views/admin/events/index.html.erb`，用 `form_tag` 包住整个 `table`，并加上核选方块和批次删除的按钮：

app/views/admin/events/index.html.erb

```
+  <%= form_tag bulk_update_admin_events_path, :class => "form-inline" do %>
   <table class="table">
   <tr>
+    <th><%= check_box_tag "全选", "1", false, :id => "toggle_all" %></th>

   # 略

   <% @events.each do |event| %>
    <tr>
+     <td>
+       <%= check_box_tag "ids[]", event.id %>
+     </td>

   # 略

   </table>

+    <p><%= submit_tag "批次删除", :class => "btn btn-danger", :data => { :confirm => "Are you sure?" } %></p>
+  <% end %>

+  <script>
+    // 这个 javascript 会绑事件在 #toggle_all 核选方块上，来做全选效果
+    $("#toggle_all").click(function(){
+      if ( $(this).prop("checked") ) {
+        $("input[name='ids[]']").prop("checked", true);
+      } else {
+        $("input[name='ids[]']").prop("checked", false);
+      }
+    })
+  </script>
```

修改 `app/controllers/admin/events_controller.rb`，循环 `params[:ids]` 数组找出每个 event 然后删除。

app/controllers/admin/events_controller.rb

```
+  def bulk_update
+    total = 0
+    Array(params[:ids]).each do |event_id|
+      event = Event.find(event_id)
+      event.destroy
+      total += 1
+    end
+
+    flash[:alert] = "成功完成 #{total} 笔"
+    redirect_to admin_events_path
+  end
```

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/5TDfv99jRj2d1Mh8nUQY_14-1.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/5TDfv99jRj2d1Mh8nUQY_14-1.png)

这样就可以批次删除了。

> Pro Tip 小技巧：关于 `Array(params[:ids]` 这个用法，如果是 `Array([1,2,3])` 会等同于 `[1,2,3]`没变，但是 `Array[nil]` 会变成 `[]` 空数组，这可以让 `.each` 方法不会因为 `nil.each` 而爆错。如果不这样处理，在没有勾选任何活动就送出的情况，就会爆出 NoMethodError 错误。除非你额外检查 `params[:id]` 如果是 `nil` 就返回，但不如用 `Array` 来的精巧。

注意本来的 admin layout 中的 flash 样式有点问题，请修改 `app/views/layouts/admin.html.erb` 修正一下：

app/views/layouts/admin.html.erb

```
-    <div class="container">
+    <div class="container" style="padding-top: 60px">

-      <p class="notice"><%= notice %></p>
-      <p class="alert"><%= alert %></p>

+      <% if notice %>
+        <p class="notice alert-success"><%= notice %></p>
+      <% end %>

+      <% if alert %>
+        <p class="alert alert-danger"><%= alert %></p>
+      <% end %>
```

# 14-3 批次修改

接下来实作批次修改状态。注意到我们已经包了一个 `form` 在 `table` 外面了：

- 一个 form 的送出 URL 位置是固定的，会进到同一个 action。这里会 POST 送出到 `bulk_update_admin_events_path`
- `form` 里面不能再包 `form`

那我们要怎么区别到底是要删除还是修改？所幸，按钮的文字也会送出变成参数。请修改 `app/views/admin/events/index.html.erb`，加上批次修改的按钮，以及状态的下拉选单：

app/views/admin/events/index.html.erb

```
   </table>

-   <p><%= submit_tag "批次删除", :class => "btn btn-danger", :data => { :confirm => "Are you sure?" } %></p>

+   <p>
+   <%= select_tag :event_status, options_for_select( Event::STATUS.map{ |s| [t(s, :scope => + "event.status"), s] }), :class => "form-control" %>
+
+   <%= submit_tag t(:bulk_update), :class => "btn btn-primary" %>
+   <%= submit_tag t(:bulk_delete), :class => "btn btn-danger", :data => { :confirm => "Are you + sure?" } %>
+   </p>

  <% end %>
```

修改 `config/locales/zh-CN.yml`

config/locales/zh-CN.yml

```
   "zh-CN":
+    bulk_update: 批次编辑
+    bulk_delete: 批次删除
```

> 如果要做英文版，请再编辑 en.yml 加上英文翻译即可

如果观察一下 HTML 源码，可以看到按钮也是有参数的：

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/icBx4QySZe3g4RHWK62m_14-3.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/icBx4QySZe3g4RHWK62m_14-3.png)

接着修改 `app/controllers/admin/events_controller.rb`，根据 `params[:commit]` 参数，就可以判断用户当初是按下删除还是修改了：

app/controllers/admin/events_controller.rb

```
     Array(params[:ids]).each do |event_id|
       event = Event.find(event_id)
-      event.destroy
-      total += 1
+
+      if params[:commit] == I18n.t(:bulk_update)
+        event.status = params[:event_status]
+        if event.save
+          total += 1
+        end
+      elsif params[:commit] == I18n.t(:bulk_delete)
+        event.destroy
+        total += 1
+      end
     end
```

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/sMOVxKR4RVepfCD0fiYY_14-2.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/sMOVxKR4RVepfCD0fiYY_14-2.png)

> Pro Tip 小技巧：这里 ihower 老师改用了 I18n 来显示按钮字串，这倒不是因为一定要支援多语言，而是因为文案可能会改。如果你按钮写死 `<%= submit_tag '批次修改'` 的话，那么在 controller 中也需要写成 `if params[:commit] == '批次修改'`。将来那一天要改字，就要记得两个地方都要改到。但是如果用 I18n 来处理，就之后只要记得改翻译档一个地方就好了。这个原则就叫做 [DRY: Don't repeat yourself](https://zh.wikipedia.org/wiki/%E4%B8%80%E6%AC%A1%E4%B8%94%E4%BB%85%E4%B8%80%E6%AC%A1)，这是一个写好程序的基本原则。

#### 本节作业

##### [第二集作业](https://fullstack.xinshengdaxue.com/assignments/52)：[作业三](https://fullstack.xinshengdaxue.com/tasks/316)

已有 30 个第一期同学提交了这个作业 [**看看同学怎么做](https://fullstack.xinshengdaxue.com/tasks/316/other_answers?order=recent)

[**提交作业](https://fullstack.xinshengdaxue.com/tasks/316)

请在任一个项目中，实作批次删除 and/or 批次修改，并贴上截图。
