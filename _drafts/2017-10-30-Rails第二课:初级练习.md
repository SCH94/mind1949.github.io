---
layout: post
title: Rails第二课:初级练习
date: 2017-10-30
tags:
  教材
---
# Rails 第二课: 初级练习

| 1- 教材介绍 预计学习时间: 10分钟                     |      |
| ---------------------------------------- | ---- |
| [**  1-0 由此开始：学习说明](https://fullstack.xinshengdaxue.com/posts/252) |      |
| [**  1-1 前言](https://fullstack.xinshengdaxue.com/posts/32) |      |

| 2-Ruby 程式语言 预计学习时间: 1小时                  |      |
| ---------------------------------------- | ---- |
| [**  2-1 基础 Ruby](https://fullstack.xinshengdaxue.com/posts/34) |      |

| 3-初探 Rails 预计学习时间: 4小时                   |                                          |
| ---------------------------------------- | ---------------------------------------- |
| [**  3-1 开始吧！](https://fullstack.xinshengdaxue.com/posts/35) |                                          |
| [**  3-2 把专案加进 Git Repo](https://fullstack.xinshengdaxue.com/posts/41) | 共1个作业 \|[** 已完成](https://fullstack.xinshengdaxue.com/posts/41#task) |
| [**  3-3 在本机执行你的程式](https://fullstack.xinshengdaxue.com/posts/42) |                                          |
| [**  3-4 建立 Migration](https://fullstack.xinshengdaxue.com/posts/43) |                                          |
| [**  3-5 CRUD 和 Scaffolding](https://fullstack.xinshengdaxue.com/posts/44) |                                          |
| [**  3-6 设定首页](https://fullstack.xinshengdaxue.com/posts/45) |                                          |
| [**  3-7 对 Topic 投票](https://fullstack.xinshengdaxue.com/posts/46) |                                          |
| [**  3-8 把投票记录和 Topics 接起来](https://fullstack.xinshengdaxue.com/posts/47) |                                          |
| [**  3-9 让大家可以投票](https://fullstack.xinshengdaxue.com/posts/48) |                                          |
| [**  3-10 新增后能够回到 topics 列表](https://fullstack.xinshengdaxue.com/posts/36) |                                          |
| [**  3-11 把 Topic 标题变成可以点选的超连结](https://fullstack.xinshengdaxue.com/posts/37) |                                          |
| [**  3-12 清理 Topics 列表](https://fullstack.xinshengdaxue.com/posts/38) |                                          |
| [**  3-13 加分题 & 下一步](https://fullstack.xinshengdaxue.com/posts/39) |                                          |
| [**  3-14 贺！你刚“完成”了你的第一个 Rails 程式！](https://fullstack.xinshengdaxue.com/posts/40) | 共1个作业 \|[** 已完成](https://fullstack.xinshengdaxue.com/posts/40#task) |

| 4-补充教材 预计学习时间: 1小时                       |
| ---------------------------------------- |
| [**  4-1 补充教材：Rails 架构](https://fullstack.xinshengdaxue.com/posts/49) |

# 1-0 由此开始：学习说明

欢迎进入课程，本网站用户分为免费会员和 VIP 会员。

免费会员可以学习免费课程。

VIP 会员在会员有效期内可以学习所有开课内容，并可享有 Slack 上专业程序员助教团队的技术指导、答疑，另外还有各界大牛不定期直播分享，帮助 VIP 会员更好的成长。

### 课程提醒

继续阅读前请设置[科学上网](http://docs.qzy.camp/docs/internet)，不然教材里的图片可能无法正常显示。

我们为每一位 VIP 会员准备了科学上网礼包 ，[点击查看](https://fullstack.xinshengdaxue.com/account/vip_gifts)。

如果在注册各种帐号的时候遇到不懂操作的地方，请查阅[课程帮助文档](http://docs.qzy.camp/docs/courses1)。

VIP会员请务必在正式开课前完成课前作业，即： 《Rails 第一课》、《Rails 第二课》、《Rails 第三课》的作业。

# 1-1 前言

### 目标

为了让你用最快的速度上手 Ruby on Rails，我们会使用“真实世界”的范例。

现在我们要实际做出一个投票系统， 这是一个基本可用的程式，让使用者可以：

- 检视主题，用投票数来排序
- 对主题投票
- 开新主题、编辑主题、删除主题
- 贴张图让你看看它会长怎样：

[![img](https://cdn.filepicker.io/api/file/sV3eQ7djRmOOqyTYGE3n)](https://cdn.filepicker.io/api/file/sV3eQ7djRmOOqyTYGE3n)

(这份教材是基于 RailsBridge 工作坊的 [Intro to Rails](http://docs.railsbridge.org/intro-to-rails/)改编）

### 练功目标

将初级作业完成之后，你会学会：

- 基本 Ruby 语法
- 要怎么试一些 Ruby 程式码 (irb)
- 要怎么把需求变成会动的 Rails 应用程式
- 要怎么把你的应用程式放到网路上
- Rails 工程师会使用的基本工具（版本控制、编辑器、console、本机 server）

### 时程

- 约 1 小时 Ruby
- 约 4-6小时 Rails。

### 需求

我们会用这些来做：

- ruby 2.1.2 、2.2.0 、2.3.1用 RVM 安装（Mac 或 Linux）
- rails 5.0.0
- bundler
- Atom编辑器

这些应该都要在前一份教材就装好，确定它们都妥妥的。

### 如何确认一切没问题？

运行终端机，输入：

`irb`

2.3.1 :001 > `1 + 2`
=> 3

2.3.1 :002 > `require "active_support"`
=> true

2.3.1 :003 > `exit`

这些都可以成功执行的话，就是没问题了。

提示：在 irb 里运行命令的最后记得输入 `exit` 退出。

### 效能！效率！

我非常推荐你这样做：

- 打开终端机并开两个标签页：
  - 一个放着跑 rails s
  - 一个用来做平常的终端机指令
    （有时会用来使用 irb —— 即 rails console，我们之后会提到，用过后记得输入exit退出即可）
- 重新打开你的浏览器，或是把其他窗口关掉
  - 打开新的窗口并开两个标签页
  - 一个用来看本教学
  - 一个用来测试你的程式
- 打开Atom编辑器，然后不要关掉它。我们不会中途离开。
- 把其他应用程式都隐藏起来，关掉 Twitter 、即时通讯程式、别的干扰物。
- 把跟你互动的东西最少化，可以减少你分心在这些东西的次数与耗费的时间（比方说在浏览器里打开 50 个分页，这会干扰到你并且浪费你的时间）

### 格式

每一课的格式都会长这样：

- 目标

叙述我们要做什么。

- 步骤

跟着做，但是这时候你还不知道原理。

- 解释

关于这些步骤实际上做了什么的细节，详述原因与效果。将一切都连在一起。

### 注意

如果你刚刚完成第一课的环境建置

1. 请在终端机运行 rails server 的窗口（或者标签页）中按 ctrl + c 终止运行，然后按 command + q 退出终端机。
2. 请在 Atom 编辑器的界面按 command + w 关闭所有的标签页，然后点击任务栏左上角 Atom > Quit 退出编辑器。

# 2-1 基础 Ruby

### 目标：

- 会使用 Ruby 基本的语法
- 用 IRB 跑 Ruby 程式
- 做简单的算术
- 使用、了解 Variable（变数）
- 使用、了解 Array（阵列）
- 使用 Loop（回圈）和条件判断

### 步骤

#### 步骤 1

在终端机打这些字来启动 IRB（Interactive Ruby Shell），这个程式可以让你试一些 Ruby 程式码：

`irb`

长得像这样（你看到的或许会有些不同）：

`2.3.1 :001 > `

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/1HWHe1kuSi2tSL4DBOGK_Screenshot%20at%20Mar%2027%2019-56-32.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/1HWHe1kuSi2tSL4DBOGK_Screenshot%20at%20Mar%2027%2019-56-32.png)

#### 步骤 2

接着试一些 Ruby 内建的简单算术。在 IRB 里面打字：

`3 + 3`
=> 6

`7 * 6`
=> 42

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/2H67OWL5SM2PkjFKyKeM_Screenshot%20at%20Mar%2027%2019-57-36.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/2H67OWL5SM2PkjFKyKeM_Screenshot%20at%20Mar%2027%2019-57-36.png)

#### 步骤 3

Variables（变数） 指的是一个被指定 values（值）的名字。

`my_variable = 5`
这会把 5 这个值指定给 my_variable 这个名字。

#### 步骤 4

也可以对变数做算术：

`my_variable + 2`
=>7

`my_variable * 3`
=>15

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/dEI7aox8TvyUXc77nmbZ_Screenshot%20at%20Mar%2027%2019-58-55.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/dEI7aox8TvyUXc77nmbZ_Screenshot%20at%20Mar%2027%2019-58-55.png)

#### 步骤 5

变数可以放多个值，这叫 Array（阵列）。

`fruits = ["kiwi", "strawberry", "plum"]`

这里我们用了 fruits 这个变数来放一群水果名。

#### 步骤 6

在终端机打这些字：

`fruits = fruits + ["orange"]`
`fruits = fruits - ["kiwi"]`

- \+ 和 - 叫做 Operators（运算符号）。跟数字一样，我们也可以把它们用在 array 上。

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/JYyWIck3Qh6TQWtJyFh0_Screenshot%20at%20Mar%2027%2020-00-26.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/JYyWIck3Qh6TQWtJyFh0_Screenshot%20at%20Mar%2027%2020-00-26.png)

#### 步骤 7

在 Ruby 里面，万物皆有 class （类别）。请在 IRB 里面打字：

`7.class`
`"kiwi".class`
`fruits.class`
这些就是我们至今介绍的三个资料型态：**Fixnum（数值）**、**String（文字）**、**Array（列表）**。

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/4MDA1Gi1RE6aeE3h5OQh_Screenshot%20at%20Mar%2027%2020-01-36.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/4MDA1Gi1RE6aeE3h5OQh_Screenshot%20at%20Mar%2027%2020-01-36.png)

#### 步骤 8

每个 class 都有不同的 **method （方法）**可以在该 class 的 **instance （实例）**使用

`fruits.length`
`fruits.first`

你可以看看一个 object 所拥有的所有 method：

`fruits.methods`

还可以串在一起：

`fruits.methods.sort`

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/kJvz5kkMSoaNw4Bm70WA_Screenshot%20at%20Mar%2027%2020-02-42.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/kJvz5kkMSoaNw4Bm70WA_Screenshot%20at%20Mar%2027%2020-02-42.png)

#### 步骤 9

Array 有个 method 叫做 **each**，会遍历它里面每一个项目并执行程式。

`fruits.each do |fruit|`
`puts fruit`
`end`

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/qZIuscyaSfhDV4b1gmrr_Screenshot%20at%20Mar%2027%2020-03-45.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/qZIuscyaSfhDV4b1gmrr_Screenshot%20at%20Mar%2027%2020-03-45.png)

这会把 fruits array 里面的第一项（"strawberry"）拿出来，把它设给绝对值符号中的 fruit 变数，并执行 do 和 end 之间的程式。然后对其他项重覆做这件事。上面这段程式会印出水果的列表。

#### 步骤 10

**conditional（条件式）** 只会在条件满足的时候才执行程式。

`if my_variable > 1`
`puts "YAY!"`
`end`

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/gx1pxq6S8iOgNnumfMR7_Screenshot%20at%20Mar%2027%2020-04-52.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/gx1pxq6S8iOgNnumfMR7_Screenshot%20at%20Mar%2027%2020-04-52.png)

如果 my_variable 变数里面储存的值大于 1，才会印出 YAY!。

请试着把 `>` 改成 `<`。

#### 步骤 11

你也可以做自己的 method：

`def pluralize(word)`
`word + "s"`
`end`
`pluralize("kiwi")`

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/FAF8WY2SMWSWTGc2ROfz_Screenshot%20at%20Mar%2027%2020-05-48.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/FAF8WY2SMWSWTGc2ROfz_Screenshot%20at%20Mar%2027%2020-05-48.png)

Method 会取 **parameters（参数）**，表示它们要对哪些变数操作。以此例而言，我们做了一个 method 叫做 pluralize ，它取一个参数 word，是一个单字。

Method 也可以 return（回传）资料。以此例而言，pluralize 会回传 word 单字加上 's' 结尾。在 Ruby 里面，method 会回传最后一行的结果，无论该结果是什么。

#### 步骤 12

离开IRB
输入 `exit` 然后回车即可！

### 本节常见问题

##### 看不懂，不知是否要背诵

先不要试图去理解，照着教材打一遍，而不是看一遍，不需要背。

# 3-1 开始吧！

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/5bhXugJ7Rbup5tk8iCin_Start_page.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/5bhXugJ7Rbup5tk8iCin_Start_page.png)

### 目标

建立你的 New Application

来，开始吧！在这一步骤的最后，我们会得到一个全新的（空白）Rails 应用程式。

### 步骤

#### 步骤 1

cd 的意思是切换目录（**C**hange **D**irectory）

在终端机打这些字 ( Mac 或 Linux )

`cd ~`
cd ~ 切换（当前位置）到home目录

#### 步骤 2

在终端机打这些字：

`mkdir railsbridge`

这会新增一个资料夹，让我们把专案放在里面。

#### 步骤 3

在终端机打这些字：

`cd railsbridge`

#### 步骤 4

确定一下你有没有之前练习用的程式码在里面。

在终端机打这些字：

`ls`

这指令会列出 railsbridge 资料夹里面的档案。如果列出了旧的 suggestotron 应用程式，你可以删掉它们来避免干扰：

在终端机打这些字：

`rm -rf suggestotron`

#### 步骤 5

在终端机打这些字：

`rails new suggestotron`

rails new 会用你给的名字来建立新的 Rails 专案

这次我们建一个新的专案叫 suggestotron 。我们马上就会详述它到底建立了什么。

#### 步骤 6

在终端机打这些字：

`cd suggestotron`

cd 指的是切换目录 (**c**hange **d**irectory)。

cd suggestotron 切换到 suggestotron 做为成当前资料夹。

#### 步骤 7

在终端机打这些字：

`ls`

ls 指的是列出东西 (**l**ist **s**tuff)。

它会把目前资料夹的内容列出来给你看。

#### 步骤 8

运行 Atom 编辑器，用专案的方式打开 suggestotron 资料夹。

选择 File > Add Project Folder...。

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/VK95IFVJSDCcllQJNKhf_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-07-10%20%E4%B8%8B%E5%8D%889.43.28.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/VK95IFVJSDCcllQJNKhf_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-07-10%20%E4%B8%8B%E5%8D%889.43.28.png)

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/UjXTgjYnRhe1OlNPUl92_finder.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/UjXTgjYnRhe1OlNPUl92_finder.png)

在右上角输入suggestotron，电脑会找到这给资料夹，点击选择它，如果一切没问题的话，Atom 会在视窗左边以树状结构列出资料夹的内容：

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/BMH6RhzoTXqDKA3JpvMm_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-07-10%20%E4%B8%8B%E5%8D%889.46.16.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/BMH6RhzoTXqDKA3JpvMm_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-07-10%20%E4%B8%8B%E5%8D%889.46.16.png)

你会发现 rails new 开了一大堆资料夹和档案。今天我们要看的是这些：

（**档案/资料夹 ：**用途 ）

**app/：** 包含你应用程式的 controllers、models、views。你要改的东西大多是这些。

**config/：** 设定应用程式的执行阶段规则、路由设定（routes）、资料库等等。

**db/：**显示你目前资料库的 schema（结构定义），以及资料库的 migrations。

**public/：**这是唯一一个资料夹会是放什么就出现什么的。如果你把档案放里面，server 会直接回传，不会经过 Rails 的处理。

**app/assets/：**你会要把图片、JavaScript、stylesheets (CSS) 还有其他静态档案放在里面。现代的 Rails 应用程式使用一种叫做 Assets Pipeline 的东西，把在这资料夹里面的所有 JavaScript 和 CSS 档合并成一个档案来加速。

rails new 还建立了其他很多东西。大概可以写一本书来讲，所以我们现在先无视它们。

# 3-2 把专案加进 Git Repo

### 目标

- 建一个本地的 git repository（仓库）
- 把所有档案加入 git repository

为了把我们的应用程式发布到网络上，我们要把我们的程式和过程中的修改都加到“版本控制系统”。我们会用 git ，因为它比较简单，而且 Heroku 也用它。

### 步骤

#### 步骤 1

请用`pwd`确认你在suggestotron目录里。

在终端机打这些字：

`git init`

[![img](http://ww2.sinaimg.cn/large/006y8lVajw1faqwyyi527j30km02jgmx.jpg)](http://ww2.sinaimg.cn/large/006y8lVajw1faqwyyi527j30km02jgmx.jpg)

跑完之后它看起来没有做什么事，然而事实上 git init 已经把 repository（repo）初始化到一个叫做 .git 的资料夹。 你可以打 ls -a（列出所有档案）来看到它。

#### 步骤 2

在终端机打这些字：

`git status`

[![img](http://ww4.sinaimg.cn/large/006y8lVajw1faqx0ddc70j30j80dhjtp.jpg)](http://ww4.sinaimg.cn/large/006y8lVajw1faqx0ddc70j30j80dhjtp.jpg)

git status 会告诉你 git 所见所有改过、新增、删掉的东西。

第一次跑这个指令的时候，会看到很多东西。

第二次跑这个指令的时候，你不会看到很多东西。

#### 步骤 3

在终端机打这些字：

`git add .`

git add . 告诉 git 你想要把目前资料夹（即 .）还有它底下的所有东西加进 repo。

在 Git 里，有多个指令可以做到类似的事：

- `git add foo.txt` 把名叫 foo.txt 的档案加进追踪修订。
- `git add . ("git add dot")` 把所有新档案和改过的档案加进追踪修订，但“保留”你删掉的档案。
- `git add -A` 全部加进追踪修订，包括删掉的档案。

“把删掉的档案加进来”听起来很奇怪，但如果你把版本控制系统想像成是追踪“修改”的工具，或许就会懂了。 多数人用 git add . 但 git add -A 会比较安全。无论如何，git status 都能帮上你的忙。

#### 步骤 4

在终端机打这些字：

`git commit -m "Added all the things"`

[![img](http://ww1.sinaimg.cn/large/006y8lVajw1faqx0z5fmjj30il071jup.jpg)](http://ww1.sinaimg.cn/large/006y8lVajw1faqx0z5fmjj30il071jup.jpg)

git commit 告诉 git 真的要执行你叫它做的事。

分成 add 和 commit 两个步骤的好处是，如此你就可以把多个修改合并在一起。

-m "Added all the things 这个捷径让你可以直接写下 commit message。

### 本节作业

##### [Rails 初级练习作业](https://fullstack.xinshengdaxue.com/assignments/2)：[把专案上传到你的 Github](https://fullstack.xinshengdaxue.com/tasks/18)

已有 351 个第一期同学提交了这个作业 [**看看同学怎么做](https://fullstack.xinshengdaxue.com/tasks/18/other_answers?order=recent)

[**修改作业](https://fullstack.xinshengdaxue.com/tasks/18)

请把你的专案上传到 Github ，并把你的 github repo 网址贴在这里。
操作细节可以参考这个章节：<https://fullstack.xinshengdaxue.com/posts/23>

https://github.com/mind1949/suggestotron

# 3-3 在本机执行你的程式

### 目标

我们来把程式在本机启动吧！

### 步骤

#### 步骤 1

在终端机打这些字：

`rails server`

#### 步骤 2

在你的浏览器打开 [http://localhost:3000](http://localhost:3000/)

然后你就会看到的程式跑起来了！

#### 步骤 3

在终端机里面，server 跑起来的时候，随时按下 Ctrl+C 就可以把 server 关掉。你可以马上试试看。

预期的结果：

```
➜  suggestotron rails s
=> Booting Puma
=> Rails 5.0.0 application starting in development on http://localhost:3000
=> Run `rails server -h` for more startup options
Puma starting in single mode...
* Version 3.4.0 (ruby 2.3.1-p112), codename: Owl Bowl Brawl
* Min threads: 5, max threads: 5
* Environment: development
* Listening on tcp://localhost:3000
Use Ctrl-C to stop
^CExiting
```

[![img](http://ww2.sinaimg.cn/large/006y8lVajw1faqwt0ycoyj30je05zacf.jpg)](http://ww2.sinaimg.cn/large/006y8lVajw1faqwt0ycoyj30je05zacf.jpg)

# 3-4 建立 Migration

### 目标

[![<img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/KnxmiCxQT2CuweYh6o11_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-07-10%20%E4%B8%8B%E5%8D%889.58.19.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/KnxmiCxQT2CuweYh6o11_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-07-10%20%E4%B8%8B%E5%8D%889.58.19.png)

我们的 suggestotron 会有一个 Topics （主题）列表让大家来投票。我们会把 Topics 存进 database 里面。在这一步你会做这些事：

- 在资料库里建立一个简单的“表格（Table）”来储存 Topics，每一篇 Topic 里会有标题和正文内容。
- 在 Rails 里自动产生相对应的 Scaffold（包含 Model、View、Controller）。

### 步骤

#### 步骤 1

在终端机打这些字：

`rails generate scaffold topic title:string description:text`

- generate scaffold 告诉 Rails 去建立一堆档案让 topics 可以动。
- topic 是告诉 rails 新的 Model 的名字是什么。
- title:string 是说 topics 有标题（title），它是一个字串（String）。
- description:text 是说 topics 有正文内容（description），它是一段文字（Text）。（“字串”跟“文字”的差别？基本上“文字”是用来储存可能会很长的字串。）

[![img](http://ww4.sinaimg.cn/large/006y8lVajw1faqwp5ocz3j30p9071778.jpg)](http://ww4.sinaimg.cn/large/006y8lVajw1faqwp5ocz3j30p9071778.jpg)

你若有兴趣，可以花一点时间研究一下自动产生出来的档案。

补充教材：[“Rails 架构”](https://fullstack.xinshengdaxue.com/posts/49)

#### 步骤 2

在终端机打这些字：

`rake db:migrate`

[![img](http://ww1.sinaimg.cn/large/006y8lVajw1faqwr419bmj30f803i75g.jpg)](http://ww1.sinaimg.cn/large/006y8lVajw1faqwr419bmj30f803i75g.jpg)

告诉 Rails 更新资料库来建立一个用来储存新的 Model 的表格（Table）。

# 3-5 CRUD 和 Scaffolding

### 目标

大部份基于资料库的网站，其核心都是一样的，都要把资料存起来并且提供方法来做这些事：

**C** - 建立（**C**reate）新资料并存进资料库。
**R** - 读取（**R**ead）或显示资料库里的资料。
**U** - 更新（**U**pdate）既有的资料。
**D** - 删除（**D**estroy）资料。

这四个操作（CRUD）常见到 Rails 把它内建到 scaffold 指令里面，我们可以很容易实作出来。

### 步骤

#### 步骤 1

在浏览器打开 <http://localhost:3000/topics>

你应该会看到一个“Listing Topics”的页面，有个空白但有 Title 和 Description 栏位标题的表格，还有一个连结可以新增 Topic：

[![img](http://ww1.sinaimg.cn/large/006y8lVajw1faqwgyvo87j308y06374j.jpg)](http://ww1.sinaimg.cn/large/006y8lVajw1faqwgyvo87j308y06374j.jpg)

#### 步骤 2

- 按一下 New Topic
- 填写表单，然后按一下 Create Topic
- 你应该会看到一个网页，里面显示你新建立的 topic，并且说你已经成功建立你的 topic 了：

[![img](http://ww4.sinaimg.cn/large/006y8lVajw1faqwhelurnj309b0810t9.jpg)](http://ww4.sinaimg.cn/large/006y8lVajw1faqwhelurnj309b0810t9.jpg)

#### 步骤 3

- 按一下 back
- 你应该会再看到 topics 列表，这次还有你刚刚新增的 topic：

[![img](http://ww2.sinaimg.cn/large/006y8lVajw1faqwhrinuaj30dn06tdge.jpg)](http://ww2.sinaimg.cn/large/006y8lVajw1faqwhrinuaj30dn06tdge.jpg)

- 试试看 show、edit、destroy 连结看看会发生什么事。
- 贺！你已经建立了一个基本的资料库网站了！

# 3-6 设定首页

### 目标

现在结构已经打好了，来把流程变顺畅吧。

现在你打开 [http://localhost:3000](http://localhost:3000/) 的话，你会看到 "Yay! You’re on Rails!" 的字样。

但如果 [http://localhost:3000](http://localhost:3000/) 就可以直接跑到 topics 列表的话，会比较方便。

所以在这一步我们会实现它，并从中学习 Rails 路由（routes）的基本。

### 步骤

#### 步骤 1：加入 root route

在atom编辑器打开 config/routes.rb, 在

`Rails.application.routes.draw do`

下面加一行

`root "topics#index"`

看起来会像这样

config/routes.rb

```
Rails.application.routes.draw do
  root "topics#index"
```

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/NbT4a7qnTUeWrreBVuT7_Screenshot%20at%20Mar%2030%2015-24-42.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/NbT4a7qnTUeWrreBVuT7_Screenshot%20at%20Mar%2030%2015-24-42.png)

请记得存档（⌘ command + s），修改才会生效。

#### 步骤 2：确认修改成功

回到 <http://localhost:3000/>。你应该会被带到 topics 列表。

[![img](http://ww3.sinaimg.cn/large/006y8lVajw1faqw65429tj30dx07naam.jpg)](http://ww3.sinaimg.cn/large/006y8lVajw1faqw65429tj30dx07naam.jpg)

### 部署（Deploying）

在继续下一步之前，你可以考虑把程式上传到 Heroku！

具体可以参考第一课[相关章节](https://fullstack.xinshengdaxue.com/posts/932)以及[帮助文档](http://docs.qzy.camp/docs/heroku)

# 3-7 对 Topic 投票

### 目标

- 建立投票的 model

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/DoNxzxLRsGXvNdjJ1ggt_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-07-10%20%E4%B8%8B%E5%8D%8810.17.57.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/DoNxzxLRsGXvNdjJ1ggt_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-07-10%20%E4%B8%8B%E5%8D%8810.17.57.png)

Suggestotron 里面的每一个 topic 都可以投票。为了计算票数，我们要有投票记录。来加个 table 吧。

### 步骤

在终端机打这些字：

- `rails generate model vote topic_id:integer`
- `rake db:migrate`

[![img](http://ww4.sinaimg.cn/large/006y8lVajw1faqw0lq2mrj30lp05076j.jpg)](http://ww4.sinaimg.cn/large/006y8lVajw1faqw0lq2mrj30lp05076j.jpg)

[![img](http://ww2.sinaimg.cn/large/006y8lVajw1faqw1aojs3j30gc03jabb.jpg)](http://ww2.sinaimg.cn/large/006y8lVajw1faqw1aojs3j30gc03jabb.jpg)

# 3-8 把投票记录和 Topics 接起来

### 目标

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/XPaKQENjQ1OBk75V8e4x_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-07-10%20%E4%B8%8B%E5%8D%8810.20.26.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/XPaKQENjQ1OBk75V8e4x_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-07-10%20%E4%B8%8B%E5%8D%8810.20.26.png)

资料库里面有了关联号码，接下来我们要来告诉 Rails，topic 和投票记录之间有明确的关系。

### 步骤

#### 步骤 1：告诉 Topic model 有 Vote（投票记录）的存在

编辑 app/models/topic.rb 让它长得像这样：

app/models/topic.rb

```
class Topic < ApplicationRecord
  has_many :votes, dependent: :destroy
end
```

[![img](http://ww1.sinaimg.cn/large/006y8lVajw1faqvu2tazdj30lk08idgy.jpg)](http://ww1.sinaimg.cn/large/006y8lVajw1faqvu2tazdj30lk08idgy.jpg)

#### 步骤 2：告诉 Vote model 有 Topic 的存在

编辑 app/models/vote.rb 让它长得像这样：

app/models/vote.rb

```
class Vote < ApplicationRecord
  belongs_to :topic
end
```

[![img](http://ww4.sinaimg.cn/large/006y8lVajw1faqvv8wpbzj30lk08iwfh.jpg)](http://ww4.sinaimg.cn/large/006y8lVajw1faqvv8wpbzj30lk08iwfh.jpg)

#### 步骤 3：进 Rails console 随便玩玩看 Topic 和 Vote model

首先，先确定你已经开了至少一篇 topic。

然后，从终端机视窗进入 Rails console：

`rails c`

预期的结果：

```
Running via Spring preloader in process 11071
Loading development environment (Rails 5.0.0)
2.3.1 :001 >
```

在 console 里面试试看这些指令：

检查总共有多少 topics：

继续在终端输入`Topic.count`

把第一篇 topic 存入变数

`my_topic = Topic.first`

my_topic 可以是任何的变数名称，不过现在我们一律用 my_topic。

把那个 topic 的 title 改成别的：

`my_topic.update_attributes(title: 'Edited in the console')`

新增一笔投票记录给那个 topic：

`my_topic.votes.create`

检查 topic 总共有多少笔投票：

`my_topic.votes.count`

删除一笔那个 topic 的投票记录：

`my_topic.votes.first.destroy`

最后，记得输入`exit`退出console。

请注意，你在 **Model class**（例如 **Topic**、**Vote**）和 **Model instance**（例如此例的my_topic）可以做的事是不一样的。my_topic.votes称作 association，在这里的行为比较像是 model class。

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/GmS6BOkCRJagJJkU7fx0_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-07-10%20%E4%B8%8B%E5%8D%8810.27.27.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/GmS6BOkCRJagJJkU7fx0_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-07-10%20%E4%B8%8B%E5%8D%8810.27.27.png)

要看完整的列表的话，你可以上 [Active Record Query Interface RailsGuide](http://guides.rubyonrails.org/active_record_querying.html)

# 3-9 让大家可以投票

### 目标

现在我们要来加一个按钮，让大家可以按下去就投票加分。

### 步骤

#### 步骤 1：加一个新的 controller action 来投票加分

编辑 app/controllers/topics_controller.rb 然后把以下这个 method 加在 controller 下方的 private这个keyword 之上：

app/controllers/topics_controller.rb

```
def upvote
  @topic = Topic.find(params[:id])
  @topic.votes.create
  redirect_to(topics_path)
end
```

[![img](http://ww1.sinaimg.cn/large/006y8lVajw1faqvl4cxf4j30m60hrn0g.jpg)](http://ww1.sinaimg.cn/large/006y8lVajw1faqvl4cxf4j30m60hrn0g.jpg)

##### 我们来看一下以上代码的具体作用：

`@topic = Topic.find(params[:id])`

从资料库里面用 id 找到 topic 然后存进 @topic 变数里面。

`@topic.votes.create`

给目前这篇 topic 新增一笔投票记录，然后存进资料库里面。

`redirect_to(topics_path)`

跟浏览器说要回到 topics_path（topics 的列表）。

#### 步骤 2：给投票加分操作加一个 route

打开 config/routes.rb 然后找这个：

config/routes.rb

```
...（略）
resources :topics
...（略）
```

取代之，让整个档案长得像这样：

config/routes.rb

```
Rails.application.routes.draw do
 root 'topics#index'
 resources :topics do
   member do
     post 'upvote'
   end
 end
end
```

[![img](http://ww3.sinaimg.cn/large/006y8lVajw1faqvm3y8p8j30ln0e1myy.jpg)](http://ww3.sinaimg.cn/large/006y8lVajw1faqvm3y8p8j30ln0e1myy.jpg)

现在来检查 route 有成功加入，方法是看一下 `rake routes` 的输出结果，或是打开 <http://localhost:3000/rails/info>。你应该会看到有一行长得像这样：

[![img](http://ww4.sinaimg.cn/large/006tNbRwjw1fawn5a69tjj30uc02m0tv.jpg)](http://ww4.sinaimg.cn/large/006tNbRwjw1fawn5a69tjj30uc02m0tv.jpg)

#### 步骤 3：在 view 里面加一个按钮

编辑 app/views/topics/index.html.erb 让最下面的 loop（回圈）程式码长得像这样：

app/views/topics/index.html.erb

```
<% @topics.each do |topic| %>
  <tr>
    <td><%= topic.title %></td>
    <td><%= topic.description %></td>
    <td><%= pluralize(topic.votes.count, "vote") %></td>
    <td><%= button_to '+1', upvote_topic_path(topic), method: :post %></td>
    <td><%= link_to 'Show', topic %></td>
    <td><%= link_to 'Edit', edit_topic_path(topic) %></td>
    <td><%= link_to 'Destroy', topic, method: :delete, data: { confirm: 'Are you sure?' } %></td>
  </tr>
<% end %>
```

[![img](http://ww1.sinaimg.cn/large/006y8lVajw1faqvnhnojej30su0lyjwd.jpg)](http://ww1.sinaimg.cn/large/006y8lVajw1faqvnhnojej30su0lyjwd.jpg)

##### 我们来看一下以上代码的具体作用：

`pluralize(topic.votes.count, "vote") `

会输出票数，并且根据（英文的）单复数在后面加上 'vote' 或 'votes' 单字。

`button_to '+1' `

加一个 HTML 的按钮（button），里面有字 '+1'。

`upvote_topic_path(topic)`

产生我们要呼叫的 action 的对应 URL。以此例而言，我们要对目前的 topic 投票加分。它会回传/topics/42/upvote（如 topic.id 是 42）

`method: :post`

确保我们使用了 CRUD 里面的 create 操作，而非 read。

#### 步骤 4：在浏览器里面检查修改成功

回到 <http://localhost:3000/topics> 然后随便玩玩看。

嗯，你发现了吗，Rails程式可以一边运行一边被修改，不用“关闭--修改--重开”，酷吧？

[![img](http://ww2.sinaimg.cn/large/006y8lVajw1faqvom2oqlj30h306kwf0.jpg)](http://ww2.sinaimg.cn/large/006y8lVajw1faqvom2oqlj30h306kwf0.jpg)

### 部署（Deploying）

在继续下一步之前，你可以考虑把程式上传到 Heroku！

# 3-10 新增后能够回到 topics 列表

当使用者建立了一篇新的 topic、或是编辑既有的 topic 的时候，使用者将会看到单独那一篇 topic 的页面。但对于我们的投票程式来说，如果能够回到 topics 列表会更好。

所以在这一步里面我们将会修改程式的流程，让 user 新增（create）topic 或编辑（update）topic 之后可以回到 topics 列表。

### 步骤

#### 步骤 1：修改 topics controller

打开 app/controllers/topics_controller.rb 找到 create method。

找这一行：

```
format.html { redirect_to @topic, notice: 'Topic was successfully created.' }
```

把 @topic 改成 topics_path，像这样：

```
format.html { redirect_to topics_path, notice: 'Topic was successfully created.' }
```

最后会长得像这样：

app/controllers/topics_controller.rb

```
def create
  @topic = Topic.new(topic_params)

  respond_to do |format|
    if @topic.save
      format.html { redirect_to topics_path, notice: 'Topic was successfully created.' }
      format.json { render :show, status: :created, location: @topic }
    else
      format.html { render :new }
      format.json { render json: @topic.errors, status: :unprocessable_entity }
    end
  end
end
```

[![img](http://ww3.sinaimg.cn/large/006y8lVajw1faqvgwkj2dj30q20dzgom.jpg)](http://ww3.sinaimg.cn/large/006y8lVajw1faqvgwkj2dj30q20dzgom.jpg)

在同一个档案里面，找到 update method。

找这一行：

```
format.html { redirect_to @topic, notice: 'Topic was successfully updated.' }
```

跟之前一样，把 @topic 改成 topics_path：

```
format.html { redirect_to topics_path, notice: 'Topic was successfully updated.' }
```

[![img](http://ww1.sinaimg.cn/large/006y8lVajw1faqvisd3gzj30nx0dzju8.jpg)](http://ww1.sinaimg.cn/large/006y8lVajw1faqvisd3gzj30nx0dzju8.jpg)

#### 步骤 2：确认修改成功

打开 <http://localhost:3000/topics> 然后玩玩看。

# 3-11 把 Topic 标题变成可以点选的超连结

### 目标

你朋友建议你把网站修改以下2个地方，看起来会更好：

- 不要在 topics 列表页面出现正文内容。
- 把 topics 变成超链接，使用者必须点击 topics 才会显示正文内容。

### 步骤

#### 步骤 1：拿掉正文内容

首先来拿掉正文内容（description）吧。打开 app/views/topics/index.html.erb 然后删掉这一行：

app/views/topics/index.html.erb

```
<td><%= topic.description %></td>
```

也删掉这一行

app/views/topics/index.html.erb

```
<th>Description</th>
```

[![img](http://ww2.sinaimg.cn/large/006y8lVajw1faqvcpjvztj30pq0k6jvr.jpg)](http://ww2.sinaimg.cn/large/006y8lVajw1faqvcpjvztj30pq0k6jvr.jpg)

现在可以试试看在浏览器里面重新刷新，你应该会发现正文内容消失了。

#### 步骤 2：把标题变成超连结

现在来把标题变成超链接，编辑 app/views/topics/index.html.erb 然后把这一行：

app/views/topics/index.html.erb

```
<td><%= topic.title %></td>
```

改成这样：

app/views/topics/index.html.erb

```
<td><%= link_to topic.title, topic %></td>
```

[![img](http://ww4.sinaimg.cn/large/006y8lVajw1faqvdhn4d9j30qr08sgnl.jpg)](http://ww4.sinaimg.cn/large/006y8lVajw1faqvdhn4d9j30qr08sgnl.jpg)

# 3-12 清理 Topics 列表

### 目标

我们的程式快要完成了！topics 列表页看起来很冗。其实有一些连结是无用的。
来清理一下吧：

- 拿掉 show 超连结。
- 拿掉 edit 超连结。
- 把 destroy改成 delete。

### 步骤

#### 步骤 1：拿掉 show 和 edit 超连结

打开 app/views/topics/index.html.erb 删除这两行：

app/views/topics/index.html.erb

```
<td><%= link_to 'Show', topic %></td>
<td><%= link_to 'Edit', edit_topic_path(topic) %></td>
```

#### 步骤 2：把 destroy 改成 delete

把有 Destroy 字样的那一行修改成这样：

app/views/topics/index.html.erb

```
<td><%= link_to 'Delete', topic, method: :delete, data: { confirm: 'Are you sure?' } %></td>
```

[![img](http://ww3.sinaimg.cn/large/006y8lVajw1faqva53w8ej30ry0bpmzy.jpg)](http://ww3.sinaimg.cn/large/006y8lVajw1faqva53w8ej30ry0bpmzy.jpg)

#### 步骤 3：确认修改成功

存档，然后重新刷新浏览器，看看修改有没有成功。

# 3-13 加分题 & 下一步

### 请做完第三课中级练习的同学再回来做

此题如在 Slack 求助，需展示第三课的作业完成链接

### 加分题

如果你完成了 Suggestotron 而还剩下一些时间，你可以试试看这些：

- 加一个“扣分”按钮，做的事跟加分按钮相反。
- 根据投票分数排序 topics。
- 新增一个 'about' 页面，并将连结放在 topics 列表的最下方。记得也要在 About 页面上放置回 Topics 列表的连结，以免使用者迷路。

# 3-14 贺！你刚“完成”了你的第一个 Rails 程式！

你知道吗？你**做完了**！！！
贺！你刚“完成”了你的第一个 Rails 程式！

### 接下来你可以进到：Rails101

### 本节作业

##### [Rails 初级练习作业](https://fullstack.xinshengdaxue.com/assignments/2)：[把专案上传到 Heroku](https://fullstack.xinshengdaxue.com/tasks/20)

已有 326 个第一期同学提交了这个作业 [**看看同学怎么做](https://fullstack.xinshengdaxue.com/tasks/20/other_answers?order=recent)

[**修改作业](https://fullstack.xinshengdaxue.com/tasks/20)

把专案的 Heroku 公开网址贴在这里，并将完成画面截图上传：图片需包含公开网址与网站页面（留下证明之后，就可以删掉heroku再重做一遍）
上传到heroku需要修改一些地方，请参考第一课的教材 <https://fullstack.xinshengdaxue.com/posts/26> 以及帮助文档
<http://docs.qzy.camp/docs/heroku>

https://warm-bayou-14816.herokuapp.com/
[![img](https://cdn.filepicker.io/api/file/8OGxclPRD6BUSgqWn8ma)pasted-file-1.png 45.46 KB](https://cdn.filepicker.io/api/file/8OGxclPRD6BUSgqWn8ma)

# 4-1 补充教材：Rails 架构

## 目标

做一个资料库表格来储存 topic，topic 有 title 和 description。

在这一步我们会学一点 Rails 的架构。最终你应该会了解这些观念：

- Table
- Model
- View
- Controller

## 解说

### Rails 的架构以及它与资料库的关联

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/2aFSZZRQKei3eSroobFg_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-07-10%20%E4%B8%8B%E5%8D%8811.14.22.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/2aFSZZRQKei3eSroobFg_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202016-07-10%20%E4%B8%8B%E5%8D%8811.14.22.png)

Rails 把 **Model/View/Controller** 的设计模式实作得非常具体，来指引你如何设计你的网路应用程式。

#### Model

- 我们在 RailsBridge 建立的 Model，其每一个 Model object 都在资料库里面有对应的资料。资料库里面的表格（table）是 Model 的 class name 的复数形。例如，如果 Model 叫做 'Duck'，就会自动去资料库读写 'ducks' 这个表格。
- Rails 内部的 methods 让我们可以很容易把资料写入到资料库，之后再从资料库里面查询（query）出来。
- Model 是介于资料库和你的程式码之间的桥梁。

#### View

- View 会产生 HTML 来显示在浏览器。
- View 档案是用 ERB 写的，它是一种样板语言（Template Language）。里面是 HTML 加上内嵌的 Ruby 程式码。View 里面的 Ruby 的变数便是当使用者要浏览该页面的时候，所要填入的内容。
- （还有别的样板语言，但是在 RailsBridge 我们只用 ERB。）

#### Controller

- Controller 把 Ruby 的 objects 在 Model 和 View 之间传来传去。
- 每一个 URL 都对应到 Controller 里面的某一个特定的 method。
- 在这一步骤以后，当你打开你应用程式里面的任何一个页面，该请求（request）会被某个 Controller 的 method 处理。

当我们把 Models、Views、Controllers 放在一起的时候，他们会遵循以下的模式：

给一个 URL，Rails 会去检查要使用哪一个 Controller 里面的 method（又称为 "Action"）。Controller Action 会去呼叫 Model 里面对应的 methods。Model 会去读写资料库，然后把包含资料的 object 回传到 Controller。Controller 会拿到这个 object 并且丢到 View 里面。Action 通常会有对应的 View 档案，Rails 会自动寻找并使用之。）

Models、Views、Controllers 有各自的工作。像这样把责任拆开来，会比较容易开发，尤其是它长得愈来愈大的时候。（每个档案都有清晰的责任，会比较容易处理问题、增加新功能。）

如果你想要学更多 Rails 架构的话，你可以看一下这个教学影片（三分半钟）[“MVC 架构 YouTube”](https://www.youtube.com/watch?v=eTdVkgF_Slo)

#### 补充

换个方式说说 MVC

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/q7vmo1xSQw6vRT4hUSu9_Screenshot%20at%20Mar%2029%2015-48-32.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/q7vmo1xSQw6vRT4hUSu9_Screenshot%20at%20Mar%2029%2015-48-32.png)

从这张图可以更明白， controller 就是手把的摇杆去操控 model 后把画面给 view 显示。

那么这边指的 model 就相当于游戏的逻辑啰，不同的游戏就载入不同的逻辑，以玛利欧游戏来说， model 里面就存放的关卡的讯息，包含有多少怪物、关卡可以获得多少金币等等… 当你破关的时候，就会在 model 里面去更新你的讯息了，这样下次就会知道哪些关卡已经突破，哪些还尚未闯关，如此一来，你就可以用 controller 选择下一关继续闯关了，这时候 view 就会显示新的关卡了。
