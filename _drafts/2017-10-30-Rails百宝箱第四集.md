---
layout: post
title: "Railsç™¾å®ç®±ç¬¬å››é›†"
date: 2017-10-30
tags:
    Rails
    æ•™æ
---

#Railsç™¾å®ç®±ç¬¬å››å­£

| 21. å¤šæ¡£æ¡ˆä¸Šä¼                                 |                                          |
| ---------------------------------------- | ---------------------------------------- |
| [**  21-1 ä¸Šä¼ å•å¼ å›¾ç‰‡](https://fullstack.xinshengdaxue.com/posts/1175) |                                          |
| [**  21-2 ä¸Šä¼ å¤šæ¡£](https://fullstack.xinshengdaxue.com/posts/1176) |                                          |
| [**  21-3 ä¸Šä¼ å¤šæ¡£æ¡ˆ(ä½¿ç”¨é¢å¤–Model)](https://fullstack.xinshengdaxue.com/posts/1177) | å…±1ä¸ªä½œä¸š \|[** æœªå®Œæˆ](https://fullstack.xinshengdaxue.com/posts/1177#task) |

| 22. å›¾è¡¨èµ„æ–™åˆ†æ                               |                                          |
| ---------------------------------------- | ---------------------------------------- |
| [**  22-1 å‰è¨€å’Œ Chart.js å®‰è£…](https://fullstack.xinshengdaxue.com/posts/1178) |                                          |
| [**  22-2 åˆ†æä¸åŒç¥¨ç§çš„æŠ¥åäººæ•°](https://fullstack.xinshengdaxue.com/posts/1179) |                                          |
| [**  22-3 åˆ†æç¥¨ç§çš„æ€»é‡‘é¢](https://fullstack.xinshengdaxue.com/posts/1180) |                                          |
| [**  22-4 åˆ†æç¥¨ç§çš„æŠ¥åäººæ•°ï¼Œå¹¶æ ¹æ®çŠ¶æ€åˆ†ç±»](https://fullstack.xinshengdaxue.com/posts/1181) |                                          |
| [**  22-5 åˆ†ææ¯æ—¥æŠ¥åäººæ•°ï¼Œå¹¶æ ¹æ®çŠ¶æ€åˆ†ç±»](https://fullstack.xinshengdaxue.com/posts/1182) | å…±1ä¸ªä½œä¸š \|[** æœªå®Œæˆ](https://fullstack.xinshengdaxue.com/posts/1182#task) |

| 23. ç”¨æˆ·æƒé™æ§ç®¡                               |      |
| ---------------------------------------- | ---- |
| [**  23-1 å¢åŠ åå°ç®¡ç†å‘˜æƒé™](https://fullstack.xinshengdaxue.com/posts/1183) |      |
| [**  23-2 å¢åŠ å…¶ä»–è§’è‰²](https://fullstack.xinshengdaxue.com/posts/1184) |      |
| [**  23-3 ç¼–è¾‘ç”¨æˆ·è§’è‰²](https://fullstack.xinshengdaxue.com/posts/1185) |      |
| [**  23-4 æƒé™é‡æ„](https://fullstack.xinshengdaxue.com/posts/1186) |      |
| [**  23-5 è¡¥å……: pundit å’Œ cancancan](https://fullstack.xinshengdaxue.com/posts/1187) |      |

| 24. HTML E-mail å¯„é€                       |                                          |
| ---------------------------------------- | ---------------------------------------- |
| [**  24-1 å®‰è£… letter_opener](https://fullstack.xinshengdaxue.com/posts/1188) |                                          |
| [**  24-2 å¯„é€æŠ¥åå®Œæˆçš„ E-mail](https://fullstack.xinshengdaxue.com/posts/1189) |                                          |
| [**  24-3 HTML E-mail](https://fullstack.xinshengdaxue.com/posts/1190) |                                          |
| [**  24-4 E-mail CSS æ ·å¼é—®é¢˜ï¼šå®‰è£… premailer](https://fullstack.xinshengdaxue.com/posts/1191) |                                          |
| [**  24-5 HTML E-mail å¥—ç‰ˆ](https://fullstack.xinshengdaxue.com/posts/1192) | å…±1ä¸ªä½œä¸š \|[** æœªå®Œæˆ](https://fullstack.xinshengdaxue.com/posts/1192#task) |

| 25. æ•°æ®æ±‡å…¥                                 |      |
| ---------------------------------------- | ---- |
| [**  25-1 è§£æ CSV æ¡£æ¡ˆ (Rake)](https://fullstack.xinshengdaxue.com/posts/1193) |      |
| [**  25-2 è§£æ CSV æ¡£æ¡ˆ (Web UI æ¥å£)](https://fullstack.xinshengdaxue.com/posts/1194) |      |
| [**  25-3 æŠŠæ±‡å…¥æ¡£æ¡ˆå­˜ä¸‹æ¥çºªå½•è¿‡ç¨‹](https://fullstack.xinshengdaxue.com/posts/1195) |      |

| 26. å¼‚æ­¥å¤„ç†ä»»åŠ¡                               |      |
| ---------------------------------------- | ---- |
| [**  26-1 å‰è¨€å’Œå®‰è£… sidekiq](https://fullstack.xinshengdaxue.com/posts/1196) |      |
| [**  26-2 å¼‚æ­¥æ±‡å…¥](https://fullstack.xinshengdaxue.com/posts/1197) |      |
| [**  26-3 Sidekiq ç®¡ç† UI](https://fullstack.xinshengdaxue.com/posts/1198) |      |
| [**  26-4 å¼‚æ­¥æ±‡å‡º](https://fullstack.xinshengdaxue.com/posts/1199) |      |
| [**  26-5 æŠ¥å15åˆ†é’Ÿå†…æ²¡å®Œæˆè‡ªåŠ¨å–æ¶ˆ](https://fullstack.xinshengdaxue.com/posts/1200) |      |
| [**  å¼‚æ­¥ E-mail å¯„ä¿¡](https://fullstack.xinshengdaxue.com/posts/1201) |      |

# 21-1 ä¸Šä¼ å•å¼ å›¾ç‰‡

è¿™ä¸€ç« ä»‹ç»ä¸Šä¼ æ–‡æ¡£ï¼Œç¤ºèŒƒçš„æƒ…å¢ƒæœ‰ï¼š

1. Event æ´»åŠ¨å¯ä»¥ä¸Šä¼ ä¸€å¼  Logo å›¾ç‰‡
2. Event æ´»åŠ¨å¯ä»¥ä¸Šä¼ å¤šå¼  Images å›¾ç‰‡
3. Events æ´»åŠ¨å¯ä»¥ä¸Šä¼ å¤šä¸ªé™„åŠ æ–‡æ¡£ï¼Œæ¯ä¸ªæ–‡æ¡£æœ‰å„è‡ªçš„æè¿°è¯´æ˜

åœ¨ Rails ä¸­ä¸Šä¼ å’Œå­˜å‚¨æ–‡æ¡£ï¼Œæœ€å¸¸è§ä½¿ç”¨çš„ gem æ˜¯ [carrierwave](https://github.com/carrierwaveuploader/carrierwave) å’Œ [paperclip](https://github.com/thoughtbot/paperclip)ï¼Œè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ carrierwaveã€‚

æ¥ä¸‹æ¥æˆ‘æ¥å®ä½œä¸º Event æ´»åŠ¨ä¸Šä¼ ä¸€å¼  Logo å›¾ç‰‡ï¼š

ç¼–è¾‘ Gemfile

Gemfile

```
+  gem 'carrierwave'
+  gem "mini_magick"
```

æ‰§è¡Œ `bundle`ï¼Œé‡å¯æœåŠ¡å™¨

æ‰§è¡Œ `rails g migration add_logo_to_events logo:string`ï¼Œè¿™ä¼šäº§ç”Ÿä¸€ä¸ª migration å†…å®¹æ˜¯ä¸º events å¢åŠ ä¸€ä¸ª logo å­—æ®µã€‚

æ‰§è¡Œ `rake db:migrate`

æ‰§è¡Œ `rails g uploader EventLogo`

ç¼–è¾‘ `app/uploaders/event_logo_uploader.rb`

event_logo_uploader.rb

```
  class EventLogoUploader < CarrierWave::Uploader::Base

+   include CarrierWave::MiniMagick

+   version :thumb do
+     process resize_to_fit: [50, 50]
+   end

  end
```

ç¼–è¾‘ `app/models/event.rb`ï¼ŒæŠŠ carrierwave çš„ Uploader æŒ‚è½½ä¸Šå»ã€‚

app/models/event.rb

```
  class Event < ApplicationRecord
+   mount_uploader :logo, EventLogoUploader
```

ç¼–è¾‘ `app/views/admin/events/_form.html.erb` åŠ ä¸Šæ–‡æ¡£ä¸Šä¼ çš„è¾“å…¥æ¡†ã€‚å¦‚æœå·²ç»æœ‰ä¸Šä¼ è¿‡äº†ï¼Œåˆ™å¤šæ˜¾ç¤ºåˆ é™¤çš„ checkboxã€‚

```
+  <div class="form-group">
+    <%= f.label :logo %>
+    <%= f.file_field :logo, :class => "form-control" %>
+    <% if f.object.logo.present? %>
+      <label>
+        <%= f.check_box :remove_logo %> åˆ é™¤å›¾æ¡£
+      </label>
+      <%= link_to f.object.logo.filename, f.object.logo.url, :target => "_blank" %>
+    <% end %>
+  </div>

   <div class="form-group">
     <%= f.label :description %>
```

ç¼–è¾‘ `app/controllers/admin/events_controller.rb` åŠ ä¸Š `:logo` å’Œ `:remove_logo` åˆ° event_params

app/controllers/admin/events_controller.rb

```
  def event_params
-    params.require(:event).permit(:name, :description, :friendly_id, :status, :category_id, :tickets_attributes => [:id, :name, :description, :price, :_destroy])
+    params.require(:event).permit(:name, :logo, :remove_logo, :description, :friendly_id, :status, :category_id, :tickets_attributes => [:id, :name, :description, :price, :_destroy])
  end
```



[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/Mr4XqYL1Shm9ijTbSFDv_21-1.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/Mr4XqYL1Shm9ijTbSFDv_21-1.png)

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/QsU4DWerSTeeduIK79As_21-2.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/QsU4DWerSTeeduIK79As_21-2.png)

ç¼–è¾‘å‰å°çš„æ´»åŠ¨é¡µé¢ `app/views/events/show.html.erb`ï¼ŒæŠŠå›¾ç‰‡æ˜¾ç¤ºå‡ºæ¥

app/views/events/show.html.erb

```
+ <% if @event.logo.present? %>
+   <%= link_to image_tag(@event.logo.url(:thumb)), @event.logo.url, :target => "_blank" %>
+ <% end %>

  <h1><%= @event.name %></h1>
```

æœ€åï¼Œä¸Šä¼ çš„æ–‡æ¡£ä¸éœ€è¦ git commitï¼Œæ‰€ä»¥è¯·ç¼–è¾‘ `.gitignore` å¿½ç•¥æ‰ `public/uploads` è¿™ä¸ªç›®å½•ã€‚

.gitignore

```
  # Ignore Byebug command history file.
  .byebug_history
+ /public/uploads/*
```

è¿™æ ·å°±å®Œæˆäº†ï¼Œè¯·åœ¨åå°ä¸Šä¼ å›¾ç‰‡ï¼Œç„¶ååˆ°å‰å°æ´»åŠ¨é¡µå°±å¯çœ‹åˆ°äº†ã€‚

# 21-2 ä¸Šä¼ å¤šæ¡£

æƒ…å¢ƒï¼šEvent æ´»åŠ¨å¯ä»¥ä¸Šä¼ å¤šå¼  Images å›¾ç‰‡

æ‰§è¡Œ `rails g migration add_images_to_events images:string`

æ‰§è¡Œ `rake db:migrate`

æ‰§è¡Œ `rails g uploader EventImage`

ç¼–è¾‘ `app/uploaders/event_image_uploader.rb`

app/uploaders/event_image_uploader.rb

```
  class EventImageUploader < CarrierWave::Uploader::Base

+   include CarrierWave::MiniMagick

+   version :small do
+     process resize_to_fit: [250, 250]
+   end

  end
```

ç¼–è¾‘ `app/models/event.rb`ï¼ŒæŠŠ carrierwave çš„ Uploader æŒ‚è½½ä¸Šå»ï¼š

app/models/event.rb

```
  class Event < ApplicationRecord
    mount_uploader :logo, EventLogoUploader
+   mount_uploaders :images, EventImageUploader
+   serialize :images, JSON
```

ç¼–è¾‘ `app/views/admin/events/_form.html.erb` åŠ ä¸Šæ–‡æ¡£ä¸Šä¼ çš„è¾“å…¥æ¡†ï¼Œæ³¨æ„åˆ°å› ä¸ºè¦æ”¯æ´å¤šæ¡£ä¸Šä¼ ï¼Œå¤šäº†ä¸€ä¸ª `:multiple => true` å‚æ•°ã€‚

app/views/admin/events/_form.html.erb_

```
+  <div class="form-group">
+    <%= f.label :images %>
+    <%= f.file_field :images, :multiple => true, :class => "form-control" %>
+    <% if f.object.images.present? %>
+      <label>
+        <%= f.check_box :remove_images %> åˆ é™¤å›¾æ¡£
+      </label>
+      <% f.object.images.each do |i| %>
+        <%= link_to i.filename, i.url, :target => "_blank" %>
+      <% end %>
+    <% end %>
+  </div>

   <div class="form-group">
     <%= f.label :description %>
```

ç¼–è¾‘ `app/controllers/admin/events_controller.rb` åŠ ä¸Š `:remove_images` å’Œ `:images => []` åˆ° event_params

app/controllers/admin/events_controller.rb

```
  def event_params
-    params.require(:event).permit(:name, :logo, :remove_logo, :description, :friendly_id, :status, :category_id, :tickets_attributes => [:id, :name, :description, :price, :_destroy])
+    params.require(:event).permit(:name, :logo, :remove_logo, :remove_images, :description, :friendly_id, :status, :category_id, :images => [], :tickets_attributes => [:id, :name, :description, :price, :_destroy])

  end
```

> å°å¿ƒ `:images => []` è¦æ”¾åœ¨æœ€åï¼Œå› ä¸ºé»˜è®¤çš„ Hash å“ˆå¸Œå‚æ•°éƒ½æ˜¯æ”¾åœ¨å‚æ•°æœ€å

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/WmS1lwxIRm64dZLRVwkQ_21-3.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/WmS1lwxIRm64dZLRVwkQ_21-3.png)

> è¯·ç”¨ command ç‚¹é€‰æ–‡æ¡£è¿›è¡Œå¤šé€‰

ç¼–è¾‘å‰å°çš„æ´»åŠ¨é¡µé¢ `app/views/events/show.html.erb`ï¼ŒæŠŠå›¾ç‰‡æ˜¾ç¤ºå‡ºæ¥ã€‚æ³¨æ„åˆ°å› ä¸ºæ˜¯å¤šæ¡£äº†ï¼Œæ‰€ä»¥ç›¸æ¯”æ˜¾ç¤º Logo å¤šäº† `.each` å¾ªç¯ã€‚

app/views/events/show.html.erb

```
   <h2><%= @event.category.try(:name) %></h2>

+  <% if @event.images.present? %>
+    <% @event.images.each do |i| %>
+      <%= link_to image_tag(i.url(:small)), i.url %>
+    <% end %>
+  <% end %>
```

è¿™æ ·å°±å®Œæˆäº†ã€‚

# 21-3 ä¸Šä¼ å¤šæ¡£æ¡ˆ(ä½¿ç”¨é¢å¤–Model)

ä¸Šä¸€èŠ‚çš„å¤šæ¡£ä¸Šä¼ å®ä½œï¼Œæˆ‘ä»¬ç”¨äº† `serialize :images, JSON` è¿™ä¼šå°†å¤šä¸ªæ–‡æ¡£çš„æ¡£åæ•°ç»„ï¼Œè½¬æˆ JSON åå­˜å‚¨åœ¨ `images` å­—æ®µä¹‹ä¸­ï¼ŒRails åœ¨è¯»å‡ºæ¥çš„æ—¶å€™ï¼Œä¼šè‡ªåŠ¨è½¬å›æ•°ç»„ã€‚è¿™ä¸€æ‹›è®© carrierwave å¾ˆç®€å•å°±å¯ä»¥æ”¯æ´å¤šæ¡£ä¸Šä¼ ï¼Œå®ƒæŠŠæ‰€æœ‰æ¡£åçš„æ•°æ®éƒ½å¡è¿›åŒä¸€ä¸ªå­—æ®µ `images`ã€‚

ä¸è¿‡è¿™ç§æ–¹æ³•æœ‰å‡ ä¸ªç¼ºç‚¹ï¼š

1. æ— æ³•å¢åŠ æ¯ä¸ªæ–‡æ¡£ç¼–è¾‘é¢å¤–çš„æè¿°æˆ–å…¶ä»–èµ„è®¯
2. æ— æ³•ä¸ºä¸ªåˆ«çš„æ–‡æ¡£è¿›è¡Œæ›´æ–°ï¼šé‡ä¼ çš„æ—¶å€™ï¼Œå®ƒä¼šå…¨éƒ¨ç æ‰ç„¶åå…¨éƒ¨é‡æ–°ä¸Šä¼ 
3. ä¸Šä¼ çš„ UI éœ€è¦ç”¨æˆ·çŸ¥é“ç”¨ Command æŒ‰é”®æ‰èƒ½å¤šé€‰æ–‡æ¡£ã€‚å› æ­¤å¦‚æœæ˜¯åå°ç®¡ç†å‘˜è¿˜å¯ä»¥æ•™è‚²ï¼Œå‰å°ä¸€èˆ¬ç”¨æˆ·å¯èƒ½ä¼šä¸çŸ¥é“å¦‚ä½•ä½¿ç”¨ã€‚

å› æ­¤ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ç¤ºèŒƒå¦‚ä½•è®© Events æ´»åŠ¨å¯ä»¥ä¸Šä¼ å¤šä¸ªé™„åŠ æ–‡æ¡£ï¼Œæ¯ä¸ªæ–‡æ¡£æœ‰å„è‡ªçš„æè¿°è¯´æ˜ã€‚

ä½œæ³•æ˜¯æ–°å¢ä¸€ä¸ª EventAttachment modelï¼Œç„¶åè®© Event has_many EventAttachmentï¼Œå…¶ä¸­æ¯ä¸€ç¬” EventAttachment å°±æ˜¯ä¸€ä¸ªé™„åŠ æ–‡æ¡£ã€‚è¡¨å• UI çš„éƒ¨åˆ†åˆ™ä½¿ç”¨ç™¾å®ç®±10æ•™è¿‡çš„ ã€ŒåµŒå¥—è¡¨å•(1-to-manyã€

æ‰§è¡Œ `rails g model event_attachment`ï¼Œæˆ‘ä»¬å°†è®© Event has_many è¿™ä¸ª EventAttachment modelï¼Œç„¶åå°† carrierwave ä¹ŸæŒ‚è½½åˆ°è¿™ä¸ª EventAttachment model èº«ä¸Šã€‚

ç¼–è¾‘ `201XXXXX025046_create_event_attachments.rb`

db/migrate/201XXXXX025046_create_event_attachments.rb

```
  class CreateEventAttachments < ActiveRecord::Migration[5.0]
    def change
      create_table :event_attachments do |t|
+       t.integer :event_id, :index => true
+       t.string :attachment
+       t.string :description
        t.timestamps
      end
    end
  end
```

æ‰§è¡Œ `rake db:migrate`

æ‰§è¡Œ `rails g uploader EventAttachment`

ç¼–è¾‘ `app/models/event.rb`

app/models/event.rb

```
   has_many :tickets, :dependent => :destroy
   accepts_nested_attributes_for :tickets, :allow_destroy => true, :reject_if => :all_blank

+  has_many :attachments, :class_name => "EventAttachment", :dependent => :destroy
+  accepts_nested_attributes_for :attachments, :allow_destroy => true, :reject_if => :all_blank
```

ç¼–è¾‘ `app/models/event_attachment.rb`

app/models/event_attachment.rb

```
  class EventAttachment < ApplicationRecord

+   mount_uploader :attachment, EventAttachmentUploader
+   belongs_to :event

  end
```

è¿™æ · models çš„éƒ¨åˆ†å°±å¥½äº†ã€‚æ¥ç€ç¼–è¾‘åå°è¡¨å• `app/views/admin/events/_form.html.erb`

app/views/admin/events/_form.html.erb_

```
+ <%= f.nested_fields_for :attachments do |ff| %>
+   <fieldset style="border-left: 5px solid #bbb; margin-bottom: 10px; padding: 10px;">
+     <legend>Attachment</legend>
+     <div class="form-group">
+       <%= ff.label :attachment %>
+       <%= ff.file_field :attachment, :class => "form-control" %>
+       <% if ff.object.attachment.present? %>
+         å·²ä¸Šä¼ æ¡£æ¡ˆ <%= link_to ff.object.description, ff.object.attachment.url, :target => "_blank" %>
+       <% end %>
+     </div>
+
+     <div class="form-group">
+       <%= ff.label :description %>
+       <%= ff.text_field :description, :class => "form-control" %>
+     </div>
+
+     <%= ff.remove_nested_fields_link "ç§»é™¤è¿™ä¸ªæ¡£æ¡ˆ", :class => "btn btn-danger" %>
+   </fieldset>
+ <% end %>
+ <p class="text-right">
+   <%= f.add_nested_fields_link :attachments, "æ–°å¢æ¡£æ¡ˆ", :class => "btn btn-default" %>
+ </p>
+

 <%= f.nested_fields_for :tickets do |ff| %>
```

ç¼–è¾‘ `app/controllers/admin/events_controller.rb`ï¼Œå¦‚æœè¯¥ @event æ²¡æœ‰ attachments çš„è¯ï¼Œnew å‡ºæ¥ä¸€ç¬”å¥½è®©è¡¨å•å¯ä»¥æ˜¾ç¤ºä¸€ç¬”è¿›è¡Œç¼–è¾‘ï¼Œä»¥åŠæŠŠ `attachments_attributes` åŠ è¿› `event_params`ã€‚

app/controllers/admin/events_controller.rb

```
   def new
     @event = Event.new
     @event.tickets.build
+    @event.attachments.build
   end

   # (ç•¥)

   def edit
     @event = Event.find_by_friendly_id!(params[:id])
     @event.tickets.build if @event.tickets.empty?
+    @event.attachments.build if @event.attachments.empty?
   end

   # (ç•¥)

   protected

   def event_params
-    params.require(:event).permit(:name, :logo, :remove_logo, :remove_images, :description, :friendly_id, :status, :category_id, :images => [], :tickets_attributes => [:id, :name, :description, :price, :_destroy])
+    params.require(:event).permit(:name, :logo, :remove_logo, :remove_images, :description, :friendly_id, :status, :category_id, :images => [], :tickets_attributes => [:id, :name, :description, :price, :_destroy], :attachments_attributes => [:id, :attachment, :description, :_destroy])
   end
```

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/cqVoKjNVSByyDpZKl51b_21-5.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/cqVoKjNVSByyDpZKl51b_21-5.png)

ç¼–è¾‘å‰å° `app/views/events/show.html.erb`

app/views/events/show.html.erb

```
+  <ul>
+  <% @event.attachments.each do |a| %>
+    <li><%= link_to a.description, a.attachment.url %></li>
+  <% end %>
+  </ul>

  <%= sanitize @event.description %>
```

è¿™æ ·å°±å®Œæˆäº†ã€‚è¯·åœ¨åå°ä¸Šä¼ ä¸€äº›æ–‡æ¡£å’Œæè¿°ï¼Œç„¶ååˆ°å‰å°æµè§ˆçœ‹çœ‹ã€‚

#### æœ¬èŠ‚ä½œä¸š

##### [ç¬¬å››é›†ä½œä¸š](https://fullstack.xinshengdaxue.com/assignments/55)ï¼š[ä½œä¸šä¸€](https://fullstack.xinshengdaxue.com/tasks/321)

å·²æœ‰ 16 ä¸ªç¬¬ä¸€æœŸåŒå­¦æäº¤äº†è¿™ä¸ªä½œä¸š [**çœ‹çœ‹åŒå­¦æ€ä¹ˆåš](https://fullstack.xinshengdaxue.com/tasks/321/other_answers?order=recent)

[**æäº¤ä½œä¸š](https://fullstack.xinshengdaxue.com/tasks/321)

è¯·åœ¨ä»»ä¸€ä¸ªé¡¹ç›®ä¸­ï¼Œå®ä½œä¸Šä¼ å¤šæ¡£æ¡ˆã€‚

# 22-1 å‰è¨€å’Œ Chart.js å®‰è£…

è¿™ä¸€ç« ä»‹ç»å¦‚ä½•åˆ¶ä½œå›¾è¡¨æ¥åˆ†ææŠ¥åèµ„æ–™ï¼ŒåŒ…æ‹¬ï¼š

- åˆ†æç¥¨ç§çš„æŠ¥åäººæ•°
- åˆ†æç¥¨ç§çš„æ€»é‡‘é¢
- åˆ†æç¥¨ç§çš„æŠ¥åäººæ•°ï¼Œå¹¶æ ¹æ®çŠ¶æ€åˆ†ç±»(æŠ¥åå°šæœªå®Œæˆã€æŠ¥åæˆåŠŸ)
- åˆ†ææ¯æ—¥æŠ¥åäººæ•°ï¼Œå¹¶æ ¹æ®çŠ¶æ€åˆ†ç±»

åˆ¶ä½œå›¾è¡¨éœ€è¦ç”¨åˆ°å‰ç«¯ JavaScript å¥—ä»¶ï¼Œä¾‹å¦‚ï¼š

- [Chartkick](http://chartkick.com/) è¿™ä¸€å¥—æ­é… Rails æœ€ç®€å•ï¼Œç”šè‡³ä¸éœ€è¦å†™ JavaScript ä»£ç ï¼Œæœ‰ Helper å¯ä»¥ä½¿ç”¨
- [Chart.js](http://www.chartjs.org/) è¿™ä¸€å¥—å¥½ç”¨åˆæ¼‚äº®ï¼Œéœ€è¦å†™ JavaScript
- [D3.js](https://d3js.org/) è¿™ä¸€å¥—åŠŸèƒ½æœ€å¼ºï¼Œæ˜¯ä¸“ä¸šçš„æ•°æ®å¯è§†åŒ–å¥—ä»¶ï¼Œä½†ä¹Ÿæ¯”è¾ƒå¤æ‚

æˆ‘ä»¬å°†ç¤ºèŒƒä¼šä½¿ç”¨ [Chart.js](http://www.chartjs.org/)ï¼Œè¿™ä¹Ÿæœ‰[ä¸­æ–‡æ–‡æ¡£](http://www.bootcss.com/p/chart.js/)ã€‚

#### Chart.js å®‰è£…

Chart.js æœ‰ [chart-js-rails gem](https://github.com/coderbydesign/chart-js-rails) å¯ä»¥å®‰è£…ï¼Œä½†æ˜¯å› ä¸ºåªæœ‰åå°æŠ¥è¡¨é‚£ä¸€é¡µæœ‰ç”¨åˆ°ï¼Œæ‰€ä»¥æˆ‘ä»¬å°±ä¸åŒ…è¿› asset pipeline äº†ï¼Œè€Œæ˜¯ä½¿ç”¨ CDN è®©ç”¨æˆ·ç›´æ¥ä» CDN æœåŠ¡å™¨ä¸‹è½½å›å»ã€‚

åœ¨å›½å†…å…è´¹çš„ CDN æœåŠ¡å™¨ [BootCDN](http://www.bootcdn.cn/) ä¸Šå¯ä»¥æ‰¾åˆ° Chart.jsï¼Œç¼–è¾‘ `app/views/admin/events/show.html.erb` æŠŠè¯¥ä½ç½®è´´ä¸Šå»ï¼š

app/views/admin/events/show.html.erb

```
+  <script src="//cdn.bootcss.com/Chart.js/2.5.0/Chart.bundle.min.js"></script>

   <h1><%= @event.name %></h1>
```

è¿™æ ·ç”¨æˆ·è¿›åˆ°è¿™ä¸€é¡µï¼Œå°±å¯ä»¥ä½¿ç”¨ Chart.js äº†ã€‚

è®©æˆ‘ä»¬è¯•è¯•çœ‹æ•ˆæœï¼Œå†æ¬¡ç¼–è¾‘ `app/views/admin/events/show.html.erb`ï¼Œè´´ä¸Šä¸€æ®µèŒƒä¾‹ï¼š

app/views/admin/events/show.html.erb

```
   <script src="//cdn.bootcss.com/Chart.js/2.5.0/Chart.bundle.min.js"></script>

   <h1><%= @event.name %></h1>

   <p>
     <%= link_to "æ‰“å¼€å‰å°", event_path(@event), :target => "_blank", :class => "btn    btn-primary" %>
   </p>

+  <canvas id="myChart" width="400" height="200"></canvas>
+  <script>
+  var ctx = document.getElementById("myChart");
+  var myChart = new Chart(ctx, {
+      type: 'bar',
+      data: {
+          labels: ["Red", "Blue", "Yellow", "Green", "Purple", "Orange"],
+          datasets: [{
+              label: '# of Votes',
+              data: [12, 19, 3, 5, 2, 3],
+              backgroundColor: [
+                  'rgba(255, 99, 132, 0.2)',
+                  'rgba(54, 162, 235, 0.2)',
+                  'rgba(255, 206, 86, 0.2)',
+                  'rgba(75, 192, 192, 0.2)',
+                  'rgba(153, 102, 255, 0.2)',
+                  'rgba(255, 159, 64, 0.2)'
+              ],
+              borderColor: [
+                  'rgba(255,99,132,1)',
+                  'rgba(54, 162, 235, 1)',
+                  'rgba(255, 206, 86, 1)',
+                  'rgba(75, 192, 192, 1)',
+                  'rgba(153, 102, 255, 1)',
+                  'rgba(255, 159, 64, 1)'
+              ],
+              borderWidth: 1
+          }]
+      },
+      options: {
+          scales: {
+              yAxes: [{
+                  ticks: {
+                      beginAtZero:true
+                  }
+              }]
+          }
+      }
+  });
+  </script>
```

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/WPraiiXjTDOLorlzd9ET_22-1.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/WPraiiXjTDOLorlzd9ET_22-1.png)

è¿™åªæ˜¯ä¸ª Chart.js èŒƒä¾‹ï¼Œå¹¶æ²¡æœ‰ç”¨åˆ°æ•°æ®åº“çš„çœŸå®èµ„æ–™ã€‚åœ¨ç»§ç»­ä¸‹å»ä¹‹å‰ï¼Œè¯·åˆ æ‰å®ƒã€‚

# 22-2 åˆ†æä¸åŒç¥¨ç§çš„æŠ¥åäººæ•°

æœ€å¸¸è§çš„æ•°æ®åˆ†ææ¨¡å¼ï¼Œå°±æ˜¯æ ¹æ®ä¸åŒåˆ†ç±»è®¡ç®—æ•°é‡æˆ–æ€»å’Œï¼Œä¾‹å¦‚æˆ‘ä»¬æ¥åˆ†æä¸åŒç¥¨ç§çš„æŠ¥åäººæ•°ã€‚

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/lpC3TNN7SZqnzLwqVTjL_22-2.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/lpC3TNN7SZqnzLwqVTjL_22-2.png)

> ä»¥ä¸‹æ•°æ®æ²¿ç”¨æˆ‘ä»¬åœ¨ [18-1 åˆ¶ä½œåå°ç®¡ç†æŠ¥åèµ„æ–™](https://fullstack.xinshengdaxue.com/posts/1160) æ‰€äº§ç”Ÿçš„å‡æ´»åŠ¨å’ŒæŠ¥åæ•°æ®ã€‚

ç¼–è¾‘ `app/controllers/admin/events_controller.rb`

app/controllers/admin/events_controller.rb

```
  def show
    @event = Event.find_by_friendly_id!(params[:id])

+    colors = ['rgba(255, 99, 132, 0.2)',
+              'rgba(54, 162, 235, 0.2)',
+              'rgba(255, 206, 86, 0.2)',
+              'rgba(75, 192, 192, 0.2)',
+              'rgba(153, 102, 255, 0.2)',
+              'rgba(255, 159, 64, 0.2)'
+              ]
+
+    ticket_names = @event.tickets.map { |t| t.name }
+
+    @data1 = {
+        labels: ticket_names,
+        datasets: [{
+          label: "# of Registrations",
+          data: @event.tickets.map{ |t| t.registrations.count },
+          backgroundColor: colors,
+          borderWidth: 1
+        }]
+    }
```

ç¼–è¾‘ `app/views/admin/events/show.html.erb`

app/views/admin/events/show.html.erb

```
  <script src="//cdn.bootcss.com/Chart.js/2.5.0/Chart.bundle.min.js"></script>

  <h1><%= @event.name %></h1>

  <p>
    <%= link_to "æ‰“å¼€å‰å°", event_path(@event), :target => "_blank", :class => "btn   btn-primary" %>
  </p>

+  <canvas id="myChart1" width="400" height="200"></canvas>
+  <script>
+  var ctx1 = document.getElementById("myChart1");
+  var myChart1 = new Chart(ctx1, {
+      type: 'bar',
+      data: <%= raw @data1.to_json %>,
+      options: {
+          scales: {
+              yAxes: [{
+                  ticks: {
+                      beginAtZero:true
+                  }
+              }]
+          }
+      }
+  });
+  </script>
+
+  <hr>
```

æˆ‘ä»¬åœ¨ controller ä¸­å‡†å¤‡äº†`@data1` å˜é‡å°±æ˜¯è¦é¤µç»™ Chart.js çš„åˆ†æèµ„æ–™ï¼Œåœ¨ View ä¸­éœ€è¦æŠŠè¿™ä¸ª Ruby å˜é‡é€è¿‡ `to_json` è½¬æˆ JavaScript å˜é‡ã€‚

è¿™ä¸ª `@data1` è¾“å‡ºåçš„æ•°æ®æ ¼å¼é•¿è¿™æ ·ï¼š

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/FXlFQSMcRseHrl80ILxK_22-3.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/FXlFQSMcRseHrl80ILxK_22-3.png)

Chart.js å‚æ•°è¯´æ˜ï¼š

```
type: 'bar',  // é•¿æ¡å›¾

data: {
  "labels": ["Guest","VIP ç¬¬ä¸€æœŸ","VIP ç¬¬äºŒæœŸ"],   // æ¨ªè½´çš„æ ‡ç±¤æœ‰å“ªäº›

  "datasets": [
    { "label": "# of Registrations",   // æ•°æ®é›†çš„åç§°

      "data": [324,346,330],           // æ•°æ®(è¿™æ˜¯æ•°ç»„)

      "backgroundColor":["rgba(255, 99, 132, 0.2)","rgba(54, 162, 235, 0.2)","rgba(255, 206, 86, 0.2)","rgba(75, 192, 192, 0.2)","rgba(153, 102, 255, 0.2)","rgba(255, 159, 64, 0.2)"],  // é•¿æ¡çš„é¢œè‰²

      "borderWidth": 1    // è¦æœ‰æ¡†çº¿

    }
  ]
},
options: {
    scales: {
        yAxes: [{
            ticks: {
                beginAtZero:true   // X è½´è¦ä» 0 èµ·è·³

            }
        }]
    }
}
```

è¯¦ç»†å…³äºè¿™ä¸ªèµ„æ–™ç»“æ„çš„è¯´æ˜ï¼Œå¯ä»¥å‚è€ƒ Chart.js æ–‡æ¡£ã€‚

# 22-3 åˆ†æç¥¨ç§çš„æ€»é‡‘é¢

è·Ÿä¸Šä¸€èŠ‚ç±»ä¼¼ï¼Œä½†æ”¹æˆè®¡ç®—æŠ¥åæˆåŠŸçš„æ€»é‡‘é¢ã€‚

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/ZvygV2IT2mW2Z7FvOKL5_22-4.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/ZvygV2IT2mW2Z7FvOKL5_22-4.png)

ç¼–è¾‘ `app/controllers/admin/events_controller.rb`

app/controllers/admin/events_controller.rb

```
+   @data2 = {
+       labels: ticket_names,
+       datasets: [{
+           label: '# of Amount',
+           data:  @event.tickets.map{ |t| t.registrations.by_status("confirmed").count * t.price },
+           backgroundColor: colors,
+           borderWidth: 1
+       }]
+   }
```

å…¶ä¸­ data çš„éƒ¨åˆ†å˜æˆè®¡ç®—æŠ¥åæˆåŠŸçš„æ•°é‡ä¹˜ä¸Šè¯¥ç¥¨ä»·ã€‚

ç¼–è¾‘ `app/views/admin/event/show.html.erb` åŠ ä¸Šå›¾è¡¨ï¼š

app/views/admin/event/show.html.erb

```
   <hr>

+  <canvas id="myChart2" width="400" height="200"></canvas>
+  <script>
+  var ctx2 = document.getElementById("myChart2");
+  var myChart2 = new Chart(ctx2, {
+      type: 'bar',
+      data: <%= raw @data2.to_json %>,
+      options: {
+          scales: {
+              yAxes: [{
+                  ticks: {
+                      beginAtZero:true
+                  }
+              }]
+          }
+      }
+  });
+  </script>
```

è¿™æ ·å°±å®Œæˆäº†ã€‚Guest ç¥¨å› ä¸ºç¥¨ä»·æ˜¯0å…ƒï¼Œæ‰€ä»¥æ€»é‡‘é¢ä¹Ÿæ˜¯0ã€‚

# 22-4 åˆ†æç¥¨ç§çš„æŠ¥åäººæ•°ï¼Œå¹¶æ ¹æ®çŠ¶æ€åˆ†ç±»

åœ¨ä¸Šä¸ŠèŠ‚ "ä¸åŒç¥¨ç§çš„æŠ¥åäººæ•°" å›¾è¡¨ä¸­ï¼ŒæŠŠæŠ¥åæœªå®Œæˆå’ŒæŠ¥åæˆåŠŸçš„æ•°æ®éƒ½ç®—åœ¨ä¸€èµ·äº†ï¼Œæœ‰æ²¡æœ‰åŠæ³•å¯ä»¥æ ¹æ®ä¸åŒçŠ¶æ€åˆ†å¼€ç®—å‘¢ï¼Ÿ

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/NiA2RLO4ROSFrwhbTO21_22-5.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/NiA2RLO4ROSFrwhbTO21_22-5.png)

ç¼–è¾‘ `app/controllers/admin/events_controller.rb`

app/controllers/admin/events_controller.rb

```
-   @data1 = {
-       labels: ticket_names,
-       datasets: [{
-         label: "# of Registrations",
-         data: @event.tickets.map{ |t| t.registrations.count },
-         backgroundColor: colors,
-         borderWidth: 1
-       }]
-   }

+   status_colors = { "confirmed" => "#FF6384",
                      "pending" => "#36A2EB"}

+   @data1 = {
+       labels: ticket_names,
+       datasets: Registration::STATUS.map do |s|
+         {
+           label: I18n.t(s, :scope => "registration.status"),
+           data: @event.tickets.map{ |t| t.registrations.by_status(s).count },
+           backgroundColor: status_colors[s],
+           borderWidth: 1
+         }
+       end
+   }
```

`datasets` å‚æ•°å…¶å®å°±æ˜¯èµ„æ–™é›†çš„æ•°ç»„ï¼Œæœ¬æ¥åªæœ‰ä¸€ä¸ªèµ„æ–™é›†ï¼Œç°åœ¨æ”¹æˆé€è¿‡ `Registration::STATUS.map`äº§ç”Ÿä¸¤ä¸ªèµ„æ–™é›†ï¼Œåˆ†åˆ«æ˜¯æŠ¥åæœªå®Œæˆå’ŒæŠ¥åæˆåŠŸã€‚

è®©æˆ‘ä»¬è§‚å¯Ÿä¸€ä¸‹å®é™…è¾“å‡ºçš„æ•°æ®æ ¼å¼é•¿æ€æ ·ï¼š

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/9TFqc71Q6KKirZsyAz6Q_22-6.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/9TFqc71Q6KKirZsyAz6Q_22-6.png)

```
  data: {
    "labels": ["Guest","VIP ç¬¬ä¸€æœŸ","VIP ç¬¬äºŒæœŸ"],  // è¿™æ˜¯ Y è½´çš„æ ‡ç±¤

    "datasets":[
      { "label": "æŠ¥åå°šæœªå®Œæˆ",     // è¿™æ˜¯ç¬¬ä¸€ä¸ªèµ„æ–™é›†

        "data": [160,164,160],
        "backgroundColor":"#36A2EB",
        "borderWidth":1
      },
      { "label": "æŠ¥åæˆåŠŸ",         // è¿™æ˜¯ç¬¬äºŒä¸ªèµ„æ–™é›†

        "data":[164,182,170],
        "backgroundColor":"#FF6384",
        "borderWidth":1
      }
    ]
  },
```

å½“æœ‰å¤šä¸ªèµ„æ–™é›†æ—¶ï¼Œå®ƒä¼šæ²¿ç€ Y è½´çš„æ ‡ç±¤ä¾åºç”»ä¸Šå»ã€‚

# 22-5 åˆ†ææ¯æ—¥æŠ¥åäººæ•°ï¼Œå¹¶æ ¹æ®çŠ¶æ€åˆ†ç±»

åˆ†æä»ç¬¬ä¸€å¤©åˆ°ä»Šå¤©çš„æ¯æ—¥æŠ¥åäººæ•°ï¼Œå¹¶æ ¹æ®çŠ¶æ€åˆ†ç±»ã€‚

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/wys4IY7ySLGxyC0sDbrU_22-7.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/wys4IY7ySLGxyC0sDbrU_22-7.png)

ç¼–è¾‘ `app/controllers/admin/events_controller.rb`ã€‚å…¶ä¸­ labels å‚æ•°æ˜¯ Y è½´ï¼Œè¿™é‡Œæ”¹æˆç”¨ dates æ•°ç»„ï¼Œä»£è¡¨ä»æœ‰äººæŠ¥åçš„ç¬¬ä¸€å¤©åˆ°ä»Šå¤©ã€‚

app/controllers/admin/events_controller.rb

```
+   if @event.registrations.any?
+     dates = (@event.registrations.order("id ASC").first.created_at.to_date..Date.today).to_a

+     @data3 = {
+       labels: dates,
+       datasets: Registration::STATUS.map do |s|
+         {
+           :label => I18n.t(s, :scope => "registration.status"),
+           :data => dates.map{ |d|
+             @event.registrations.by_status(s).where( "created_at >= ? AND created_at <= ?", d.beginning_of_day, d.end_of_day).count
+           },
+           borderColor: status_colors[s]
+         }
+       end
+     }
+   end
```

è·Ÿä¸Šä¸€èŠ‚ç±»ä¼¼ï¼Œ`data` æœ‰æœ‰ä¸¤ä¸ªèµ„æ–™é›†åˆ†åˆ«æ˜¯æŠ¥åå°šæœªå®Œæˆå’ŒæŠ¥åå®Œæˆã€‚

ç¼–è¾‘ `app/views/admin/event/show.html.erb` åŠ ä¸Šå›¾è¡¨ï¼Œè¿™é‡Œæ”¹æˆç”¨ `line` æŠ˜çº¿å›¾ï¼š

app/views/admin/event/show.html.erb

```
   <hr>

+  <canvas id="myChart3" width="400" height="200"></canvas>
+  <script>
+  var ctx3 = document.getElementById("myChart3");
+  var myChart3 = new Chart(ctx3, {
+      type: 'line',
+      data: <%= raw @data3.to_json %>,
+      options: {
+          scales: {
+              yAxes: [{
+                  ticks: {
+                      beginAtZero:true
+                  }
+              }]
+          }
+      }
+  });
+  </script>
```

è¿™æ ·å°±å®Œæˆäº†ã€‚

#### æœ¬èŠ‚ä½œä¸š

##### [ç¬¬å››é›†ä½œä¸š](https://fullstack.xinshengdaxue.com/assignments/55)ï¼š[ä½œä¸šäºŒ](https://fullstack.xinshengdaxue.com/tasks/322)

å·²æœ‰ 12 ä¸ªç¬¬ä¸€æœŸåŒå­¦æäº¤äº†è¿™ä¸ªä½œä¸š [**çœ‹çœ‹åŒå­¦æ€ä¹ˆåš](https://fullstack.xinshengdaxue.com/tasks/322/other_answers?order=recent)

[**æäº¤ä½œä¸š](https://fullstack.xinshengdaxue.com/tasks/322)

è¯·åœ¨è´­ç‰©è½¦é¡¹ç›®ä¸­ï¼Œåˆ†ææ¯æ—¥è®¢å•æ•°é‡ï¼Œå¹¶åˆ¶ä½œå›¾è¡¨ã€‚

# 23-1 å¢åŠ åå°ç®¡ç†å‘˜æƒé™

ç›®å‰åªè¦æœ‰ç™»å…¥å°±å¯ä»¥è¿›å…¥åå°ï¼Œæ¥ä¸‹æ¥å®ä½œåŸºæœ¬çš„æƒé™æ£€æŸ¥(Authorization)å§ï¼Œåªæœ‰ç®¡ç†å‘˜æ‰å¯ä»¥è¿›å…¥åå°ã€‚

åŸºæœ¬çš„åŸç†å¾ˆç®€å•ï¼Œæˆ‘ä»¬åœ¨ User model ä¸Šæ–°å¢ä¸€ä¸ªå­—æ®µæ ‡è®°æ˜¯ä¸æ˜¯ç®¡ç†å‘˜å³å¯ã€‚

æ‰§è¡Œ `rails g migration add_role_to_users role:string` å¢åŠ ä¸€ä¸ª role å­—ä¸²ç¬¦å­—æ®µåˆ° users table ä¸Šã€‚

> åœ¨ä¹‹å‰çš„è¯¾ç¨‹ä¸­ï¼Œæ˜¯ç”¨ `is_admin:boolean` å­—æ®µæ¥è¡¨ç¤ºæ˜¯ä¸æ˜¯ç®¡ç†å‘˜ï¼Œåœ¨è¿™é‡Œæ”¹ç”¨ `role:string`ï¼Œè¿™æ ·çš„å¥½å¤„æ˜¯å¯ä»¥æœ‰è§’è‰²æ‰©å……çš„å¼¹æ€§ã€‚

æ‰§è¡Œ `rake db:migrate`

ç¼–è¾‘ `app/controllers/admin_controller.rb`ï¼Œå¢åŠ æƒé™æ£€æŸ¥ `current_user` çš„ role (è§’è‰²)å¿…é¡»æ˜¯ `admin`ã€‚

app/controllers/admin_controller.rb

```
  class AdminController < ApplicationController
    protect_from_forgery with: :exception

    before_action :authenticate_user!
+   before_action :require_admin!

    layout "admin"

+   protected

+   def require_admin!
+     if current_user.role != "admin"
+       flash[:alert] = "æ‚¨çš„æƒé™ä¸è¶³"
+       redirect_to root_path
+     end
+   end

  end
```

è¿™æ—¶å€™ç‚¹é€‰ä¸»é€‰å•çš„åå°é¢æ¿ï¼Œå°±ä¼šå‡ºç°ï¼š

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/w9hAiOVeS96PK3ocy3XJ_23-1.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/w9hAiOVeS96PK3ocy3XJ_23-1.png)

è¿™æ ·å°±è¿›ä¸å»åå°äº†ã€‚

è¦è®¾å®šç¬¬ä¸€ä¸ªç®¡ç†å‘˜ï¼Œåªèƒ½é€è¿‡ rails console äº†ã€‚

æ‰§è¡Œ `rails console`ï¼Œä¾åºè¾“å…¥ï¼š

```
u = User.find_by_email("admin@example.org")
u.role = "admin"
u.save!
```

è¿™æ · `admin@example.org` å°±æœ‰æƒé™å¯ä»¥è¿›å…¥åå°ç®¡ç†ã€‚

# 23-2 å¢åŠ å…¶ä»–è§’è‰²

ç”¨ `role` çš„è®¾è®¡å¥½å¤„æ˜¯å¯ä»¥æ‰©å……ä¸åŒè§’è‰²ï¼Œè®©æˆ‘ä»¬æ–°è®¾è®¡ä¸€ä¸ª `editor` è§’è‰²ï¼š

- `admin` æœ‰å…¨éƒ¨åå°æƒé™
- `editor` å¯ä»¥è¿›å…¥åå°ç®¡ç†æ´»åŠ¨ï¼Œä½†ä¸èƒ½ç®¡ç†ç”¨æˆ·

ç¼–è¾‘ `app/controllers/admin_controller.rb`ï¼Œæ‹¿æ‰æœ¬æ¥åå°éƒ½å¥—ç”¨çš„ `before_action :require_admin!` æƒé™æ£€æŸ¥ã€‚ç„¶åæ–°å¢ä¸€ä¸ª `require_editor!` æ–¹æ³•ï¼Œç­‰ä¼šæˆ‘ä»¬å¾—é€ä¸ª controllers ä¸€ä¸ªä¸€ä¸ªåŠ ä¸Šæƒé™æ£€æŸ¥ã€‚

app/controllers/admin_controller.rb

```
  class AdminController < ApplicationController
    protect_from_forgery with: :exception

    before_action :authenticate_user!
-   before_action :require_admin!

    layout "admin"

    protected

+   def require_editor!
+     if current_user.role != "editor" && current_user.role != "admin"
+       flash[:alert] = "æ‚¨çš„æƒé™ä¸è¶³"
+       redirect_to root_path
+     end
+   end

    def require_admin!
      if current_user.role != "admin"
        flash[:alert] = "æ‚¨çš„æƒé™ä¸è¶³"
        redirect_to root_path
      end
    end

  end
```

ç¼–è¾‘ä»¥ä¸‹æ¡£æ¡ˆï¼Œéœ€è¦ editor æƒé™ï¼š

- `app/controllers/admin/event_registrations_controller.rb`
- `app/controllers/admin/event_tickets_controller.rb`
- `app/controllers/admin/events_controller.rb`

```
+  before_action :require_editor!
```

ç¼–è¾‘ä»¥ä¸‹æ¡£æ¡ˆï¼Œéœ€è¦ admin æƒé™ï¼š

- `app/controllers/admin/user_profiles_controller.rb`
- `app/controllers/admin/users_controller.rb`
- `app/controllers/admin/versions_controller.rb`

```
+  before_action :require_admin!
```

> ä»¥ä¸Šè¿™äº› controller éƒ½åº”è¯¥ç»§æ‰¿è‡ª `AdminController`ï¼Œä¾‹å¦‚ `class Admin::EventsController < AdminController`ï¼Œè¿™æ ·æ‰ä¼šæœ‰è¿™ä¸¤ä¸ªæ–¹æ³•å¯ä»¥è°ƒç”¨

è¿™æ ·å°±å®Œæˆäº†ï¼Œæ¯ä¸ª `app/controllers/admin/` ç›®å½•ä¸‹çš„ controller éƒ½è¦è®°å¾—åŠ ä¸Šæƒé™æ£€æŸ¥ã€‚

# 23-3 ç¼–è¾‘ç”¨æˆ·è§’è‰²

é™¤äº†ç¬¬ä¸€ä¸ªç®¡ç†å‘˜éœ€è¦è¿›å…¥ rails console ç¼–è¾‘è§’è‰²ä¹‹å¤–ï¼Œåœ¨ç¼–è¾‘ç”¨æˆ·é‚£ä¸€é¡µï¼Œæˆ‘ä»¬å¯ä»¥å®ä½œä¸€ä¸ªä¸‹æ‹‰é€‰å•æ¥ç¼–è¾‘è§’è‰²ã€‚

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/c9Uy1XoTSKYyXzfaI08Q_23-2.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/c9Uy1XoTSKYyXzfaI08Q_23-2.png)

ç¼–è¾‘ `app/models/user.rb`

app/models/user.rb

```
  class User < ApplicationRecord

+   ROLES = ["admin", "editor"]
```

ç¼–è¾‘ `app/views/admin/users/edit.html.erb`

app/views/admin/users/edit.html.erb

```
   <div class="form-group">
     <%= f.label :email %>
     <%= f.text_field :email, :class => "form-control" %>
   </div>

+  <div class="form-group">
+    <%= f.label :role %>
+    <%= f.select :role, User::ROLES.map{ |x| [t(x, :scope => "user.role"), x] }, { :include_blank => true }, :class => "form-control" %>
+  </div>
```

> æ³¨æ„è¿™é‡Œå¤šåŠ äº† `:include_blank => true` å‚æ•°ï¼Œè¿™ä¼šè®©ä¸‹æ‹‰é€‰å•å¤šä¸€ä¸ªç©ºçš„ nil ç©ºé€‰é¡¹ã€‚

ç¼–è¾‘ `config/locales/zh-CN.yml`

config/locales/zh-CN.yml

```
  "zh-CN":
+   user:
+     role:
+       admin: è¶…çº§ç®¡ç†å‘˜
+       editor: æ´»åŠ¨ç®¡ç†å‘˜
```

ç¼–è¾‘ `app/controllers/admin/users_controller.rb`

app/controllers/admin/users_controller.rb

```
   def user_params
-    params.require(:user).permit(:email, :group_ids => [])
+    params.require(:user).permit(:email, :role, :group_ids => [])
   end
```

è¿™æ ·å°±å¯ä»¥ç¼–è¾‘ç”¨æˆ·çš„è§’è‰²äº†ã€‚è¯·ç¼–è¾‘ä»»ä¸€ä¸ªç”¨æˆ·å˜æˆ editorï¼Œç„¶åç™»å‡ºï¼Œæ”¹ç”¨é‚£ä¸ªå¸å·ç™»å…¥(å‡ç”¨æˆ·çš„å¯†ç æ˜¯12345678)ï¼Œå°±å¯ä»¥æµ‹è¯•ä¸Šä¸€èŠ‚çš„æƒé™æ£€æŸ¥äº†ï¼šå¯ä»¥æ´»åŠ¨ç®¡ç†ï¼Œä½†æ˜¯ç‚¹ç”¨æˆ·ç®¡ç†ä¼šè·³å‡ºæƒé™ä¸è¶³ã€‚

# 23-4 æƒé™é‡æ„

æ—¢ç„¶ editor æ²¡æœ‰æƒé™å¯ä»¥ç®¡ç†ç”¨æˆ·ï¼Œé‚£ä¹ˆåœ¨ä¸»é€‰å•ä¸Šå°±ä¸åº”è¯¥å‡ºç°ç”¨æˆ·ç®¡ç†çš„è¿ç»“ï¼Œè®©æˆ‘ä»¬å°å°æ”¹è¿›ä¸€ä¸‹ï¼š

ç¼–è¾‘ `app/views/layouts/admin.html.erb`ï¼Œæ ¹æ®ä¸åŒæƒé™å†³å®šè¦ä¸è¦æ˜¾ç¤ºè¿ç»“ï¼š

app/views/layouts/admin.html.erb

```
  <% if current_user %>
+   <% if current_user.role == "admin" || current_user.role == "editor" %>
      <li class="active"><%= link_to('æ´»åŠ¨ç®¡ç†', admin_events_path) %></li>
+   <% end %>

+   <% if current_user.role == "admin" %>
      <li><%= link_to('ç”¨æˆ·ç®¡ç†', admin_users_path) %></li>
+    <% end %>
  <% end %>
```

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/pixHFFSQViREGemRy8Hg_23-3.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/pixHFFSQViREGemRy8Hg_23-3.png)

ä¸è¿‡è¿™ä¸ª if æ¡ä»¶è·Ÿ `admin_controller.rb` é‡Œé¢çš„æƒé™æ£€æŸ¥æ¡ä»¶ï¼Œå…¶å®é€»è¾‘æ˜¯ä¸€æ ·çš„ï¼Œä¹Ÿå°±æ˜¯ admin çš„æƒé™åŒ…æ‹¬ editor çš„æƒé™ï¼Œæˆ‘ä»¬è¿›ä¸€æ­¥é‡æ„ä¸€ä¸‹ã€‚

ç¼–è¾‘ `app/models/user.rb`ï¼ŒåŠ ä¸Šä¸¤ä¸ªæ–¹æ³•åˆ¤æ–­æ˜¯ä¸æ˜¯ admin å’Œ editor

app/models/user.rb

```
+  def is_admin?
+    self.role == "admin"
+  end
+
+  def is_editor?
+    ["admin", "editor"].include?(self.role)  # å¦‚æœæ˜¯ admin çš„è¯ï¼Œå½“ç„¶ä¹Ÿæœ‰ editor çš„æƒé™
+  end
```

ç¼–è¾‘ `app/controllers/admin_controller.rb`ï¼Œæ”¹æˆç”¨ `is_admin?` å’Œ `is_editor?` æ–¹æ³•

```
  protected

  def require_editor!
-   if current_user.role != "editor" && current_user.role != "admin"
+   unless current_user.is_editor?
      flash[:alert] = "æ‚¨çš„æƒé™ä¸è¶³"
      redirect_to root_path
    end
  end

  def require_admin!
-   if current_user.role != "admin"
+   unless current_user.is_admin?
      flash[:alert] = "æ‚¨çš„æƒé™ä¸è¶³"
      redirect_to root_path
    end
  end
```

ç¼–è¾‘ `app/views/layouts/admin.html.erb`ï¼Œæ”¹æˆç”¨ `is_admin?` å’Œ `is_editor?` æ–¹æ³•

app/views/layouts/admin.html.erb

```
  <% if current_user %>
-   <% if current_user.role == "admin" || current_user.role == "editor" %>
+   <% if current_user.is_editor? %>
      <li class="active"><%= link_to('æ´»åŠ¨ç®¡ç†', admin_events_path) %></li>
    <% end %>

-   <% if current_user.role == "admin" %>
+   <% if current_user.is_admin? %>
      <li><%= link_to('ç”¨æˆ·ç®¡ç†', admin_users_path) %></li>
     <% end %>
  <% end %>
```

è¿™æ ·å°±å®Œæˆäº†ï¼Œé€è¿‡ User model çš„ `is_admin?` å’Œ `is_editor?` æ–¹æ³•é›†ä¸­æƒé™æ£€æŸ¥çš„é€»è¾‘ï¼Œä¹‹åå¦‚æœæ–°å¢ä¸åŒå­æƒé™ï¼Œåªè¦æ”¹ model å°±å¯ä»¥äº†ã€‚

# 23-5 è¡¥å……: pundit å’Œ cancancan

å¦‚æœæƒé™æ£€æŸ¥çš„é€»è¾‘æ¯”è¾ƒå¤æ‚ï¼Œæœ‰å¾ˆå¤šè§’è‰²è€Œä¸”ä¸åŒ action åˆæœ‰ä¸åŒæƒé™ï¼Œç”šè‡³æ˜¯ä¸åŒèµ„æ–™æœ‰ä¸åŒæƒé™ï¼Œè¿™æ—¶å€™æˆ‘ä»¬å¯ä»¥è€ƒè™‘ä½¿ç”¨ä¸“ç”¨çš„æƒé™æ£€æŸ¥ gemï¼Œå¸®åŠ©æˆ‘ä»¬ç»„ç»‡ä»£ç ï¼Œä¹Ÿé¿å…å¿˜è®°åŠ ä¸Šæƒé™(å‰å‡ èŠ‚çš„å®ä½œï¼Œå¦‚æœå¿˜è®°åŠ ä¸Š `before_action` ä½ å°±å¿˜è®°æ£€æŸ¥åˆ°å›‰)ã€‚æœ€çŸ¥åçš„æœ‰ä»¥ä¸‹ä¸¤å¥—ï¼š

- [Pundit](https://github.com/elabs/pundit)
- [Cancancan](https://github.com/CanCanCommunity/cancancan)

è¯¦ç»†ç”¨æ³•è¯·è‡ªè¡Œå‚è€ƒæ–‡æ¡£ã€‚

# 24-1 å®‰è£… letter_opener

åœ¨æœ¬æœºå¼€å‘çš„æ—¶å€™ï¼Œä¸éœ€è¦çœŸçš„å¯„å‡º E-mailï¼Œè¯·å®‰è£… [letter_opener](https://github.com/ryanb/letter_opener)ï¼Œè¿™æ · Rails ä¼šåœ¨å¯„ä¿¡æ—¶ï¼Œè‡ªåŠ¨æ‰“å¼€æµè§ˆå™¨è¿›è¡Œé¢„è§ˆã€‚

ç¼–è¾‘ `Gemfile`

Gemfile

```
  group :development do
    gem 'faker'
+   gem 'letter_opener'

```

ç¼–è¾‘ `config/environments/development.rb` è®¾å®š `delivery_method`

config/environments/development.rb

```
+  config.action_mailer.delivery_method = :letter_opener
   config.action_mailer.default_url_options = { :host => 'localhost:3000' }
```

æ‰§è¡Œ `bundle`ï¼Œé‡å¯æœåŠ¡å™¨

è¦æµ‹è¯• E-mail çš„ä¸€ä¸ªç®€å•æ–¹å¼æ˜¯å»æµ‹è¯•å¿˜è®°å¯†ç æµç¨‹ï¼šè¯·ç™»å‡ºï¼Œç„¶åè¿›å…¥ç™»å…¥ç”»é¢ï¼Œç‚¹é€‰ Forgot your password?

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/BmFako9ZSei1wyIAh6QT_24-1.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/BmFako9ZSei1wyIAh6QT_24-1.png)

è¾“å…¥ E-mail åæŒ‰ä¸‹é€å‡ºï¼Œè¿™æ—¶å€™ä¸ä¼šçœŸçš„å¯„å‡º E-mailï¼Œè€Œæ˜¯è‡ªåŠ¨è·³å‡ºæµè§ˆå™¨æµè§ˆä¿¡ä»¶å†…å®¹ï¼š

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/MzLT86PfTbmfFTiWkArc_24-2.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/MzLT86PfTbmfFTiWkArc_24-2.png)

# 24-2 å¯„é€æŠ¥åå®Œæˆçš„ E-mail

å®ä½œç›®æ ‡ï¼šå®ŒæˆæŠ¥ååï¼Œå¯„å‡ºé€šçŸ¥ E-mail

æ‰§è¡Œ `rails g mailer notification`

ç¼–è¾‘ `app/mailers/notification_mailer.rb`ï¼Œæ–°å¢ confirmed_registration ä¿¡

app/mailers/notification_mailer.rb

```
  class NotificationMailer < ApplicationMailer

+   def confirmed_registration(registration)
+     @registration = registration
+     @event = registration.event
+
+     mail( :to => @registration.email, :subject =>   I18n.t("notification.subject.confirmed_registration", :name => @event.name) )
+   end

  end
```

ç¼–è¾‘ `config/locales/zh-CN.yml` å¢åŠ  E-mail æ ‡é¢˜çš„ç¿»è¯‘

config/locales/zh-CN.yml

```
  "zh-CN":
+   notification:
+     subject:
+       confirmed_registration: "æŠ¥åæˆåŠŸ: %{name}"
```

æ–°å¢ `app/views/notification_mailer/confirmed_registration.text.erb` æ˜¯ E-mail æ ·æ¿

```
Hi <%= @registration.name %>,

æ‚¨å·²å®ŒæˆæŠ¥å <%= @event.name %> <%= event_url(@event) %>
```

> åœ¨ E-mail é‡Œé¢çš„ç½‘å€éƒ½å¿…é¡»è¦å†™ç»å¯¹ç½‘å€ `xxx_url`ï¼Œè€Œä¸æ˜¯ç›¸å¯¹ç½‘å€ `xxx_path`ã€‚ä¾‹å¦‚ `event_url(@event)` ä¼šäº§ç”Ÿ `http://localhost:3000/events/fullstack-meetup`ï¼Œè€Œ `event_path(@event)` ä¼šäº§ç”Ÿ `/events/fullstack-meetup`ï¼Œè¿™æ ·åœ¨ E-mail é˜…è¯»å™¨ä¸­ç‚¹è¶…è¿ç»“æ‰èƒ½é¡ºåˆ©è®©æµè§ˆå™¨æ‰“å¼€ç½‘å€ã€‚é‚£ Rails è¦æ€ä¹ˆçŸ¥é“ç½‘ç«™ä½ç½®å‘¢? æˆ‘ä»¬æ›¾åœ¨ `config/environments/development.rb` å†™è¿‡ `config.action_mailer.default_url_options = { :host => 'localhost:3000' }` è¿™å°±æ˜¯ E-mail ä¸­äº§ç”Ÿ `xxx_url` ç½‘å€æ—¶ï¼Œä¼šç”¨çš„ç½‘ç«™ä½ç½®ã€‚ä¹‹åä¸Š production ä½ ä¹Ÿå¿…é¡»åœ¨ `config/environments/production.rb` è¿›è¡Œè®¾å®šã€‚

ç¼–è¾‘ `app/controllers/registrations_controller.rb` åœ¨æŠ¥åå®Œæˆåå¯„å‡º E-mail

app/controllers/registrations_controller.rb

```
  def step3_update
    @registration = @event.registrations.find_by_uuid(params[:id])
    @registration.status = "confirmed"
    @registration.current_step = 3

    if @registration.update(registration_params)
      flash[:notice] = "æŠ¥åæˆåŠŸ"

+     NotificationMailer.confirmed_registration(@registration).deliver_later

      redirect_to event_registration_path(@event, @registration)
    else
      render "step3"
    end
  end

  "zh-CN":
+   notification:
+     subject:
+       confirmed_registration: "æŠ¥åæˆåŠŸ: %{name}"
```

è¿™æ ·å°±ä¼šåœ¨æŠ¥åå®Œæˆåï¼Œå¯„å‡º E-mail äº†ï¼š

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/zC0XX8WRBSnNQsyKvPGQ_24-3.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/zC0XX8WRBSnNQsyKvPGQ_24-3.png)

ä½ ä¹Ÿå¯ä»¥ç›´æ¥åœ¨ rails console ä¸­è¿›è¡Œæµ‹è¯•ï¼š

æ‰§è¡Œ `rails console`ï¼Œç„¶åè¾“å…¥

```
NotificationMailer.confirmed_registration( Registration.by_status("confirmed").last ).deliver_now
```

è¿™æ ·å°±ä¼šå¯„å‡ºæœ€åä¸€ç¬”æŠ¥åæˆåŠŸçš„ä¿¡ï¼Œæ–¹ä¾¿æˆ‘ä»¬åå¤ä¿®æ”¹ `app/views/notification_mailer/confirmed_registration.text.erb` æ ·æ¿ï¼Œè€Œä¸éœ€è¦ç¦»å¼€ rails consoleï¼Œæ¯æ¬¡æ”¹å®Œåªè¦åœ¨ rails console ä¸­å†å¯„ä¸€æ¬¡å°±å¯ä»¥äº†ã€‚

# 24-3 HTML E-mail

ä¸Šä¸€èŠ‚ä¸­çš„ E-mail æ ·æ¿ï¼Œé‡‡ç”¨çš„æ˜¯çº¯æ–‡å­— text æ ¼å¼ï¼Œæ‰€ä»¥å‰¯æ¡£åæ˜¯ `.text.erb`ã€‚

çº¯æ–‡å­—çš„ E-mail å¥½å¤„æ˜¯æ’ç‰ˆç®€å•ï¼Œä¸éœ€è¦çƒ¦æ¼æ ·å¼ã€è€Œä¸”æ‰€æœ‰çš„ Email é˜…è¯»å™¨éƒ½å¯ä»¥é¡ºåˆ©æ‰“å¼€ï¼Œä¸è¿‡ç¼ºç‚¹å°±æ˜¯å› ä¸ºæ²¡æœ‰ HTMLï¼Œæ‰€ä»¥ä¸èƒ½æ”¾è¶…è¿ç»“ï¼Œåªèƒ½ç›´æ¥æ”¾ç½‘å€ (ä¸è¿‡å¤§éƒ¨åˆ†çš„ E-mail é˜…è¯»å™¨éƒ½èƒ½åˆ¤æ–­è¿™æ˜¯ç½‘å€ï¼Œä¾¿ä¼šè‡ªåŠ¨å¸®ä½ åŠ ä¸Šè¶…è¿ç»“)ã€ä¸èƒ½æ”¾ç›´æ¥æ”¾å›¾ç‰‡(img)ã€ä¸èƒ½æ”¾è¡¨æ ¼(table)ç­‰ç­‰ã€‚

å› æ­¤å¦‚æœæƒ³è¦åˆ¶ä½œæ¼‚äº®çš„ E-mailï¼Œå°±éœ€è¦åˆ¶ä½œ HTML æ ¼å¼çš„ E-mailï¼Œè¦æ”¹æˆå¯„å‡º HTML E-mail å¾ˆç®€å•ï¼š

è¯·å°† `app/views/notification_mailer/confirmed_registration.text.erb` æ¡£åå˜æ›´ä¸º `app/views/notification_mailer/confirmed_registration.html.erb`ï¼Œæ¥ç€ç¼–è¾‘å®ƒï¼š

app/views/notification_mailer/confirmed_registration.html.erb

```
-   Hi <%= @registration.name %>,
+  <p>Hi <%= @registration.name %>,</p>

-  æ‚¨å·²å®ŒæˆæŠ¥å <%= @event.name %> <%= event_url(@event) %>
+  <p>æ‚¨å·²å®ŒæˆæŠ¥å <%= link_to @event.name, event_url(@event) %></p>
```

å†æµ‹è¯•å¯„ä¸€æ¬¡ï¼Œç½‘å€çš„éƒ¨åˆ†å°±å˜æˆè¶…è¿ç»“äº†ï¼š

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/8UtdwuvlSF2RRF8eEIkd_24-4.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/8UtdwuvlSF2RRF8eEIkd_24-4.png)

> Protip: ç”±ç”¨æˆ·è§¦å‘çš„ç³»ç»Ÿä¿¡æ¯”è¾ƒé€‚åˆç”¨ HTML E-mailï¼Œç”¨æˆ·ä¼šæ„Ÿè§‰é‚£æ˜¯ç³»ç»Ÿè‡ªåŠ¨å¯„å‡ºçš„ä¿¡ä»¶ã€‚ä½†å¦‚æœæ˜¯å®¢æœå›ä¿¡æˆ–æ„è§è¯¢é—®ï¼Œç”¨çº¯æ–‡å­— E-mail å¯èƒ½åè€Œæ¯”è¾ƒæœ‰è¯šæ„å–”ã€‚å› ä¸ºç”¨æˆ·ä¼šæ„Ÿè§‰é‚£æ˜¯äººå†™çš„ä¿¡ä»¶ï¼Œè€Œä¸æ˜¯ç³»ç»Ÿè‡ªåŠ¨å¯„å‡ºçš„ä¿¡ã€‚

# 24-4 E-mail CSS æ ·å¼é—®é¢˜ï¼šå®‰è£… premailer

æ—¢ç„¶ç”¨äº† HTML E-mailï¼Œæ¥ä¸‹æ¥ä¼šæƒ³åŠ ä¸€äº› CSS æ ·å¼ä¸Šå»ã€‚ä¸è¿‡è¿™å°±æ˜¯éº»çƒ¦çš„åœ°æ–¹ï¼ŒE-mail é˜…è¯»è½¯ä»¶æ¯”èµ·æµè§ˆå™¨æ›´å¤šæ ·æ›´å¤è€ï¼Œä¾‹å¦‚æœ‰ Outlookã€iPhoneã€Apple Mailã€Yahoo! Mailã€Google Mailã€Androidã€QQ ä¿¡ç®±ç­‰ç­‰ï¼Œè¿™äº› E-mail é˜…è¯»å™¨å¯¹ CSS çš„æ”¯æ´ç¨‹åº¦å¾ˆä¸ä¸€è‡´ã€‚è¯¦æƒ…è¯·å‚è€ƒï¼š

- [Modern HTML Email Development](https://blog.othree.net/log/2016/08/25/modern-html-email-develop/)
- [The Ultimate Guide to CSS](https://www.campaignmonitor.com/css/)
- [CSS | Email Design Reference](http://templates.mailchimp.com/development/css/)

åŸºæœ¬æ¥è¯´ï¼Œä½ ä¸èƒ½ç”¨ `<link>` æ ‡ç±¤å»åŠ è½½ CSS æ¡£æ¡ˆã€æœ‰äº› E-mail é˜…è¯»å™¨ä¸èƒ½ç”¨ `<style>` æ ‡ç±¤å†™ CSS æ ·å¼ï¼Œå½“ç„¶ä¹Ÿä¸å¯èƒ½å†™ JavaScriptã€‚

ä¿é™©çš„ä½œæ³•æ˜¯éœ€è¦å°† CSS ç”¨ Inline (å†…è”)çš„æ–¹å¼åˆ° HTML é‡Œé¢ï¼Œä¾‹å¦‚ä»¥ä¸‹çš„ HTMLï¼š

```
<link rel="stylesheet" media="all" href="/assets/email.css" />
<style>
  p { color: red }
</style>
<body>
  <p>TEST</p>
</body>
```

åœ¨å¯„å‡ºçš„ E-mail ä¸­éœ€è¦æ”¹æˆå°† CSS éƒ½é›†ä¸­åˆ°è¯¥æ ‡ç±¤çš„ `style` å±æ€§ï¼Œè¿™æ · E-mail é˜…è¯»å™¨æ‰ä¼šå¥—ç”¨åˆ° CSS æ ·å¼ã€‚

```
<body>
  <p style="color: red; font-family: 'Helvetica N=
eue', Helvetica, Arial, sans-serif; font-size: 14px; font-weight: normal;">
</body>
```

è¿™æ˜¯ä¸€ä¸ªå¤§è‹¦å·¥å•Šï¼Œæ›´ä½•å†µå†™æˆ inline CSS çš„è¯ï¼Œä»£ç ç»´æŠ¤æ€§ä¼šå˜æˆéå¸¸å·®å¾ˆéš¾æ”¹ã€‚

å¥½åœ¨ Rails æœ‰ä¸ª [premailer-rails](https://github.com/fphilipe/premailer-rails) gem å¯ä»¥å¸®æˆ‘ä»¬è‡ªåŠ¨åšå¥½è¿™ä¸ªè½¬æ¢ï¼Œå°±å¯ä»¥ç”¨æœ¬æ¥çš„å†™æ³•ï¼Œå®ƒä¼šè‡ªåŠ¨è½¬æ¢æˆ inline CSS ğŸ‘ğŸ‘ğŸ‘

è¯·ç¼–è¾‘ `Gemfile`

```
+  gem 'premailer-rails'
```

æ‰§è¡Œ `bundle`ï¼Œé‡å¯æœåŠ¡å™¨ï¼Œä¸‹ä¸€èŠ‚æˆ‘ä»¬æ¥å¥—ç‰ˆã€‚

# 24-5 HTML E-mail å¥—ç‰ˆ

å› ä¸º E-mail çš„ CSS å±æ€§æ”¯æ´ç¨‹åº¦ä¸ä¸€ï¼Œå¦‚æœè¦å®Œå…¨è‡ªå·±å†™ CSS æµ‹è¯•ä¼šå¾ˆè¾›è‹¦ï¼Œå¥½åœ¨æˆ‘ä»¬æœ‰ç°æˆçš„ Email Responsive Template æ ·æ¿å¯ä»¥å¥—ï¼š

- [Transactional HTML Email Templates](http://blog.mailgun.com/transactional-html-email-templates/)
- [Really Simple Responsive HTML Email Template](https://github.com/leemunroe/responsive-html-email-template)
- [Responsive HTML Email Templates](https://htmlemail.io/) USD $49

è¯·ä¸‹è½½ç¬¬ä¸€ä¸ª [Transactional HTML Email Templates çš„ zip å‹ç¼©æ¡£](https://github.com/mailgun/transactional-email-templates/archive/master.zip)ï¼Œæˆ‘ä»¬æ‹¿å®ƒçš„ `templates/action.html` æ¥æ”¹ã€‚

> ä½ ä¼šå‘ç°è¿™ä¸ªä»–è¿˜æœ‰æä¾› inlined çš„ç‰ˆæœ¬ï¼ŒæŠŠ style inline è¿›å»åçš„ HTML ä»£ç éå¸¸çš„æ¶å¿ƒï¼Œå¾ˆéš¾ä¿®æ”¹ã€‚å¥½åœ¨æˆ‘ä»¬æœ‰è£… `premailer-rails` gem äº†ï¼Œæ‰€ä»¥ç”¨ä¸åˆ°ã€‚

è¯·æŠŠ `templates/style.css` å¤åˆ¶åˆ°æˆ‘ä»¬é¡¹ç›®ä¸­çš„ `app/assets/stylesheets/email.css`

ç¼–è¾‘ `app/views/layouts/mailer.html.erb`ï¼ŒæŠŠå†…å®¹å…¨éƒ¨æ¢æˆï¼š

app/views/layouts/mailer.html.erb

```
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta name="viewport" content="width=device-width" />
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>Notification</title>
<link href="email.css" media="all" rel="stylesheet" type="text/css" />
</head>

<body itemscope itemtype="http://schema.org/EmailMessage">

<table class="body-wrap">
  <tr>
    <td></td>
    <td class="container" width="600">
      <div class="content">
        <table class="main" width="100%" cellpadding="0" cellspacing="0" itemprop="action" itemscope itemtype="http://schema.org/ConfirmAction">
          <tr>
            <td class="content-wrap">
              <meta itemprop="name" content="Confirm Email"/>
              <table width="100%" cellpadding="0" cellspacing="0">
                <tr>
                  <td class="content-block">
                    <%= yield %>
                  </td>
                </tr>
                <tr>
                  <td class="content-block" itemprop="handler" itemscope itemtype="http://schema.org/HttpActionHandler">
                    <%= yield :action %>
                  </td>
                </tr>
                <tr>
                  <td class="content-block">
                    &mdash; ä½ çš„åå­—
                  </td>
                </tr>
              </table>
            </td>
          </tr>
        </table>
        <div class="footer">
          <table width="100%">
            <tr>
              <td class="aligncenter content-block"><a href="https://fullstack.xinshengdaxue.com">æ–°ç”Ÿå¤§å­¦çº¿ä¸Šå…¨æ ˆè¥</a></td>
            </tr>
          </table>
        </div></div>
    </td>
    <td></td>
  </tr>
</table>

</body>
</html>
```

å…¶ä¸­ä¸»å†…å®¹æ˜¯ `<%= yield %>`ï¼Œå¦å¤–è¿˜æŒ–äº†ä¸€ä¸ªæ´æ˜¯ `<%= yield :action %>`ï¼Œç­‰ä¼šç”¨ `content_for :action` å¯ä»¥å¡«å†…å®¹è¿›å»ã€‚

ç¼–è¾‘ `app/views/notification_mailer/confirmed_registration.html.erb`

app/views/notification_mailer/confirmed_registration.html.erb

```
   <p>Hi <%= @registration.name %>,</p>

   <p>æ‚¨å·²å®ŒæˆæŠ¥å <%= link_to @event.name, event_url(@event) %></p>

+  <% content_for :action do %>
+    <%= link_to "æµè§ˆæŠ¥åç»“æœ", event_registration_url(@event, @registration), :class => "btn-primary", :itemprop => "url" %>
+  <% end %>
```

å¤šåŠ äº†ä¸€ä¸ªç”¨é€”æ˜¯ Call to Action çš„æŒ‰é’®ï¼Œè¿™æ ·ä¸€å°æ¼‚äº®çš„ E-mail å°±å®Œæˆäº†ã€‚

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/Y6WMipPSD6UbhQVqgdWO_24-5.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/Y6WMipPSD6UbhQVqgdWO_24-5.png)

#### æœ¬èŠ‚ä½œä¸š

##### [ç¬¬å››é›†ä½œä¸š](https://fullstack.xinshengdaxue.com/assignments/55)ï¼š[ä½œä¸šä¸‰](https://fullstack.xinshengdaxue.com/tasks/323)

å·²æœ‰ 12 ä¸ªç¬¬ä¸€æœŸåŒå­¦æäº¤äº†è¿™ä¸ªä½œä¸š [**çœ‹çœ‹åŒå­¦æ€ä¹ˆåš](https://fullstack.xinshengdaxue.com/tasks/323/other_answers?order=recent)

[**æäº¤ä½œä¸š](https://fullstack.xinshengdaxue.com/tasks/323)

è¯·åœ¨ä»»ä¸€ä¸ªé¡¹ç›®ä¸­çš„ E-mail (ä¾‹å¦‚è´­ç‰©è½¦çš„è®¢å•å®Œæˆä¿¡)ï¼Œå¥—ç”¨ HTML æ ·æ¿ã€‚

# 25-1 è§£æ CSV æ¡£æ¡ˆ (Rake)

æˆ‘ä»¬åœ¨ã€Œç™¾å®ç®± 20-æ•°æ®æ±‡å‡º ã€å®ä½œè¿‡æ±‡å‡º CSV æ ¼å¼ï¼Œä¸€ä¸ªæœ‰è‰¯å¿ƒçš„å¹³å°ä¼šå®ä½œæ±‡å‡ºåŠŸèƒ½ï¼Œæ–¹ä¾¿ç”¨æˆ·è¿›è¡Œåˆ†ææˆ–èµ„æ–™è½¬ç§»ã€‚æˆ–æ˜¯ç”¨ Microsoft Excel æˆ– Apple Numbers è¯•ç®—è¡¨ï¼Œå¯ä»¥ç‚¹é€‰å¦å­˜æ–°æ¡£(Save As...)ä¸º CSV UTF-8 æ ¼å¼æ¥åšæ•°æ®æ±‡å‡ºã€‚

> [CSV é€—å·åˆ†éš”å€¼](https://zh.wikipedia.org/wiki/%E9%80%97%E5%8F%B7%E5%88%86%E9%9A%94%E5%80%BC) æ ¼å¼é™¤äº†å®¹æ˜“æ±‡å‡ºï¼Œä¹Ÿæ˜¯æœ€å®¹æ˜“æ±‡å…¥å¤„ç†çš„æ ¼å¼ï¼Œè¿™ä¸€ç« ä¼šç”¨ CSV ä¸¾ä¾‹ï¼Œä¸éœ€è¦é¢å¤–è£… gem å°±èƒ½å¤„ç†ã€‚

å‡è®¾æˆ‘ä»¬æ‹¿åˆ°è¿™æ ·çš„ CSV æ¡£æ¡ˆï¼Œæ¥ä¸‹æ¥è¦å¦‚æœæ±‡å…¥æ•°æ®åº“å‘¢ï¼Ÿæ€»ä¸èƒ½ä¸€ç¬”ä¸€ç¬”è¾“å…¥å¤ªæ…¢äº†ï¼Œå½“ç„¶è¦ç”¨å†™ç¨‹åºçš„æ–¹å¼æ¥åšæ±‡å…¥ã€‚

å¦‚æœæ±‡å…¥æ˜¯ç¨‹åºå‘˜çš„ä¸€æ¬¡æ€§çš„ä»»åŠ¡ï¼Œæˆ‘ä»¬å¯ä»¥ä¸éœ€è¦å®ä½œ Web UIï¼Œåªéœ€è¦ä¸€ä¸ª rake ä»»åŠ¡å¯ä»¥æ‰§è¡Œå°±å¥½äº†ã€‚

è¯·ä¸‹è½½è¿™ä¸€ä¸ª CSV: [registrations.csv](https://raw.githubusercontent.com/growthschool/rails-recipes/master/registrations.csv) æ”¾åœ¨é¡¹ç›® `tmp` ç›®å½•ä¸‹ï¼ˆæŒ‰å³é”®å¦å­˜æ–°æ¡£)

> è¿™æœ‰1000ç¬”æŠ¥åèµ„æ–™ï¼Œå…¶ä¸­æœ‰2ç¬”æ•…æ„ç¼ºå°‘äº† E-mailã€‚

ç¼–è¾‘ `lib/tasks/dev.rake`ï¼Œè®©æˆ‘ä»¬æ–°å¢ä¸€ä¸ª `import_registration_csv_file` ä»»åŠ¡

lib/tasks/dev.rake

```
+ require 'csv'
  namespace :dev do

+   task :import_registration_csv_file => :environment do
+     event = Event.find_by_friendly_id("fullstack-meetup")
+     tickets = event.tickets
+
+     success = 0
+     failed_records = []
+
+     CSV.foreach("#{Rails.root}/tmp/registrations.csv") do |row|
+       registration = event.registrations.new( :status => "confirmed",
+                                    :ticket => tickets.find{ |t| t.name == row[0] },
+                                    :name => row[1],
+                                    :email => row[2],
+                                    :cellphone => row[3],
+                                    :website => row[4],
+                                    :bio => row[5],
+                                    :created_at => Time.parse(row[6]) )
+
+       if registration.save
+         success += 1
+       else
+         failed_records << [row, registration]
+       end
+     end
+
+     puts "æ€»å…±æ±‡å…¥ #{success} ç¬”ï¼Œå¤±è´¥ #{failed_records.size} ç¬”"
+
+     failed_records.each do |record|
+       puts "#{record[0]} ---> #{record[1].errors.full_messages}"
+     end
+
+   end
```

æ‰§è¡Œ `rake dev:import_registration_csv_file` å°±ä¼šæ‰§è¡Œäº†æ±‡å…¥çš„æ“ä½œåˆ° `fullstack-meetup` è¿™ä¸ªæ´»åŠ¨ã€‚

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/FQqv602eRrGiC0mVt6qa_25-1.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/FQqv602eRrGiC0mVt6qa_25-1.png)

è§£è¯´:

1. å’Œæ±‡å‡º CSV ä¸€æ ·ï¼ŒRuby å†…å»ºäº† CSV åº“å¯ä»¥è§£æ CSVï¼Œæ‰€ä»¥ç¬¬ä¸€è¡Œå…ˆ `require 'csv'`
2. `CSV.foreach` ä¼šæ‰“å¼€è¿™ä¸ª CSV æ¡£æ¡ˆè·‘å¾ªç¯ï¼Œæ¯ç¬”èµ„æ–™å°±æ˜¯ä¸€è¡Œ `row`ï¼Œé‚£ä¸€è¡Œçš„ç¬¬ä¸€åˆ—æ˜¯ `row[0]`ã€ç¬¬äºŒåˆ—æ˜¯ `row[1]`ã€‚åªè¦ä¾åºå¡ç»™ `event.registrations.new` å³å¯ã€‚
3. CSV ä¸­çš„ç¥¨ç§æ˜¯å­—ç¬¦ä¸²ï¼Œä½†æ˜¯è½¬è¿›æˆ‘ä»¬çš„æ•°æ®åº“ä¸­éœ€è¦è½¬æ¢æˆ Ticket modelï¼Œå› æ­¤è¿™é‡Œå†™æˆ `tickets.find{ |t| t.name == row[0] }` ç”¨ç¥¨ç§åç§°å»æ‰¾æ˜¯å“ªä¸€ä¸ªå¯¹è±¡ã€‚
4. æ—¶é—´ä¹Ÿæ˜¯ä¸€æ ·ï¼Œé€è¿‡ `Time.parse` è½¬æˆæ—¶é—´å¯¹è±¡
5. å› ä¸ºæ±‡å…¥ä¼šä¸€æ¬¡æ±‡å…¥éå¸¸å¤šç¬”ï¼Œæˆ‘ä»¬å¸Œæœ›ä¸ç®¡æ¯ç¬”èµ„æ–™ save æˆåŠŸæˆ–å¤±è´¥ï¼Œéƒ½èƒ½è·‘å®Œå…¨éƒ¨èµ„æ–™ï¼Œæœ€åå°å‡ºä¸€ä¸ªæ€»ç»“ï¼šå‘Šè¯‰æˆ‘ä»¬æ€»å…±å‡ ç¬”æˆåŠŸï¼Œæ€»å…±å‡ ç¬”å¤±è´¥ï¼Œæ˜¯å“ªäº›ç¬”å¤±è´¥åˆæ˜¯ä»€ä¹ˆåŸå› ã€‚

# 25-2 è§£æ CSV æ¡£æ¡ˆ (Web UI æ¥å£)

éœ€è¦ Web UI å¯ä»¥ä¸Šä¼ æ¡£æ¡ˆçš„è¯ï¼Œè®©æˆ‘ä»¬æ¥å®ä½œä¸€ä¸‹ï¼š

è¯·ç¼–è¾‘ `config/routes.rb`ï¼Œæ–°å¢ä¸€ä¸ª import è·¯ç”±

config/routes.rb

```
   namespace :admin do
     # ç•¥
     resources :events do
-      resources :registrations, :controller => "event_registrations"
+      resources :registrations, :controller => "event_registrations" do
+        collection do
+          post :import
+        end
+      end
```

ç¼–è¾‘ `app/views/admin/event_registrations/index.html.erb` åŠ ä¸Šæ¡£æ¡ˆä¸Šä¼ çš„è¾“å…¥æ¡†ï¼š

app/views/admin/event_registrations/index.html.erb

```
   <%= link_to "æ±‡å‡º CSV", admin_event_registrations_path(:format => :csv), :class => "btn btn-default" %>
   <%= link_to "æ±‡å‡º Excel", admin_event_registrations_path(:format => :xlsx), :class => "btn btn-default" %>
 </p>
+
+ <hr>
+
+ <%= form_tag import_admin_event_registrations_path(@event), :multipart => true do %>
+   <p><%= file_field_tag "csv_file" %></p>
+   <p><%= submit_tag "æ±‡å…¥CSV", :class => "btn btn-danger" %></p>
+ <% end %>
```

ç¼–è¾‘ `app/controllers/admin/event_registrations_controller.rb` æ–°å¢ä¸€ä¸ª import actionï¼Œå†…å®¹åŸºæœ¬ä¸Šè·Ÿ rake çš„ç‰ˆæœ¬å·®ä¸å¤š

app/controllers/admin/event_registrations_controller.rb

```
+  def import
+    csv_string = params[:csv_file].read.force_encoding('utf-8')
+
+    tickets = @event.tickets
+
+    success = 0
+    failed_records = []
+
+    CSV.parse(csv_string) do |row|
+      registration = @event.registrations.new( :status => "confirmed",
+                                   :ticket => tickets.find{ |t| t.name == row[0] },
+                                   :name => row[1],
+                                   :email => row[2],
+                                   :cellphone => row[3],
+                                   :website => row[4],
+                                   :bio => row[5],
+                                   :created_at => Time.parse(row[6]) )
+
+      if registration.save
+        success += 1
+      else
+        failed_records << [row, registration]
+        Rails.logger.info("#{row} ----> #{registration.errors.full_messages}")
+      end
+    end
+
+    flash[:notice] = "æ€»å…±æ±‡å…¥ #{success} ç¬”ï¼Œå¤±è´¥ #{failed_records.size} ç¬”"
+    redirect_to admin_event_registrations_path(@event)
+  end
+
   protected
```

å…¶ä¸­ `csv_string` å°±æ˜¯ä»ä¸Šä¼ çš„æ¡£æ¡ˆä¸­è¯»å–å†…å®¹ï¼Œæ¥ç€ç”¨ `CSV.parse` è¿›è¡Œè§£æå¾ªç¯ã€‚

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/YE9m2o1cSwu0nsTPa5Bb_25-2.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/YE9m2o1cSwu0nsTPa5Bb_25-2.png)

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/NrcLkD5gSPW82NN7xD1t_25-3.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/NrcLkD5gSPW82NN7xD1t_25-3.png)

æ³¨æ„æœ¬æ¥çš„ admin layout ä¸­çš„ flash æ ·å¼æœ‰ç‚¹é—®é¢˜ï¼Œè¯·ä¿®æ”¹ `app/views/layouts/admin.html.erb` ä¿®æ­£ä¸€ä¸‹ï¼š

app/views/layouts/admin.html.erb

```
-    <div class="container">
+    <div class="container" style="padding-top: 60px">

-      <p class="notice"><%= notice %></p>
-      <p class="alert"><%= alert %></p>

+      <% if notice %>
+        <p class="notice alert-success"><%= notice %></p>
+      <% end %>

+      <% if alert %>
+        <p class="alert alert-danger"><%= alert %></p>
+      <% end %>
```

# 25-3 æŠŠæ±‡å…¥æ¡£æ¡ˆå­˜ä¸‹æ¥çºªå½•è¿‡ç¨‹

ä¸Šä¸€èŠ‚çš„æ–¹å¼æ¯”è¾ƒç®€ç•¥ï¼Œæˆ‘ä»¬å¹¶æ²¡æœ‰æŠŠä¸Šä¼ çš„æ¡£æ¡ˆå­˜ä¸‹æ¥ï¼Œè€Œæ˜¯ç›´æ¥è¯»å–æ¡£æ¡ˆå†…å®¹è¿›è¡Œå¤„ç†ã€‚

å¦‚æœè¿™æ˜¯ä¸€ä¸ªé¢å‘ç»ˆç«¯ç”¨æˆ·çš„åŠŸèƒ½ï¼Œä¼šéœ€è¦å®ä½œçš„æ›´å®Œæ•´ï¼Œä¾‹å¦‚ï¼š

1. æŠŠä¸Šä¼ çš„æ¡£æ¡ˆå…ˆå­˜ä¸‹æ¥ï¼Œå…ˆç»™ç”¨æˆ·é¢„è§ˆå­—æ®µé¡ºåºæ˜¯å¦æ­£ç¡®ã€æœ‰å¤šå°‘æ•°æ®è¦æ±‡å…¥ã€å“ªäº›æ•°æ®æœ‰é—®é¢˜
2. ç¡®è®¤åï¼Œæ‰å¼€å§‹æ±‡å…¥æ•°æ®åº“
3. å¯ä»¥æµè§ˆè¿‡å¾€çš„æ±‡å…¥å†å²çºªå½•

æ¥ä¸‹æ¥æˆ‘ä»¬ç¤ºèŒƒå¦‚ä½•æ–°å¢ä¸€ä¸ª Model æŠŠæ¡£æ¡ˆå­˜ä¸‹æ¥å¤„ç†ï¼Œä»¥åŠæ–°å¢ä¸€ä¸ª RegistrationImports controller æ˜¾ç¤ºæ±‡å…¥çš„å†å²çºªå½•ã€‚

æ‰§è¡Œ `rails g model registration_import`ï¼Œè¿™ä¸ª Model ä¼šå­˜ä¸‹ä¸Šä¼ çš„ CSV æ¡£æ¡ˆï¼Œå¹¶è®°å½•æ±‡å…¥çš„ç»“æœã€‚

ç¼–è¾‘ `db/migrate/2017XXXXXX4512_create_registration_imports.rb`

db/migrate/2017XXXXXX4512_create_registration_imports.rb

```
  class CreateRegistrationImports < ActiveRecord::Migration[5.0]
    def change
      create_table :registration_imports do |t|
+       t.string :status
+       t.string :csv_file
+       t.integer :event_id, :index => true
+       t.integer :user_id
+       t.integer :total_count
+       t.integer :success_count
+       t.text :error_messages
        t.timestamps
      end
    end
  end
```

æ‰§è¡Œ `rake db:migrate`

æ‰§è¡Œ `rails g uploader registration_import_csv`

ç¼–è¾‘ `app/models/registration_import.rb`ï¼Œå…¶ä¸­çš„ `process!` æ–¹æ³•å°±æ˜¯è¦æ‰§è¡Œçš„æ±‡å…¥æ“ä½œã€‚

app/models/registration_import.rb

```
+ require 'csv'
  class RegistrationImport < ApplicationRecord

+   mount_uploader :csv_file, RegistrationImportCsvUploader
+
+   validates_presence_of :csv_file
+
+   belongs_to :event
+   belongs_to :user
+
+   serialize :error_messages, JSON
+
+   def process!
+     csv_string = self.csv_file.read.force_encoding('utf-8')
+     tickets = self.event.tickets
+
+     success = 0
+     failed_records = []
+
+     CSV.parse(csv_string) do |row|
+       registration = self.event.registrations.new( :status => "confirmed",
+                                    :ticket => tickets.find{ |t| t.name == row[0] },
+                                    :name => row[1],
+                                    :email => row[2],
+                                    :cellphone => row[3],
+                                    :website => row[4],
+                                    :bio => row[5],
+                                    :created_at => Time.parse(row[6]) )
+
+       if registration.save
+         success += 1
+       else
+         failed_records << [row, registration.errors.full_messages]
+       end
+     end
+
+     self.status = "imported"
+     self.success_count = success
+     self.total_count = success + failed_records.size
+     self.error_messages = failed_records
+
+     self.save!
+   end

  end
```

ç¼–è¾‘ `app/models/event.rb`

app/models/event.rb

```
   has_many :registrations, :dependent => :destroy
+  has_many :registration_imports, :dependent => :destroy
```

ç¼–è¾‘ `config/routes.rb`

config/routes.rb

```
  namespace :admin do
     # (ç•¥)
     resources :events do
+      resources :registration_imports
```

ç¼–è¾‘ `app/views/admin/event_registrations/index.html.erb` åŠ ä¸Šä¸€ä¸ªæŒ‰é’®

app/views/admin/event_registrations/index.html.erb

```
  <p class="text-right">
    <%= link_to "New Registration", new_admin_event_registration_path(@event), :class => "btn btn-primary" %>
+   <%= link_to "Import Registration", admin_event_registration_imports_path(@event), :class => "btn btn-primary" %>
   </p>
```

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/Y1o2zIdOTzyKQwJbTcLf_25-4.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/Y1o2zIdOTzyKQwJbTcLf_25-4.png)

æ‰§è¡Œ `rails g controller admin::registration_imports`

ç¼–è¾‘ `app/controllers/admin/registration_imports_controller.rb`

app/controllers/admin/registration_imports_controller.rb

```
- class Admin::RegistrationImportsController < ApplicationController
+ class Admin::RegistrationImportsController < AdminController

+   before_action :require_editor!
+   before_action :find_event
+
+   def index
+     @imports = @event.registration_imports.order("id DESC")
+   end
+
+   def create
+     @import = @event.registration_imports.new(registration_import_params)
+     @import.status = "pending"
+     @import.user = current_user
+
+     if @import.save
+       @import.process!
+       flash[:notice] = "æ±‡å…¥å®Œæˆ"
+     end
+
+     redirect_to admin_event_registration_imports_path(@event)
+   end
+
+   protected
+
+   def find_event
+     @event = Event.find_by_friendly_id!(params[:event_id])
+   end
+
+   def registration_import_params
+     params.require(:registration_import).permit(:csv_file)
+   end

  end
```

å…¶ä¸­åœ¨ `@import.save` ä¹‹åï¼Œéšå³å‘¼å« `process!` å¼€å§‹æ±‡å…¥ã€‚

æ–°å¢ `app/views/admin/registration_imports/index.html.erb` æ˜¾ç¤ºæ¡£æ¡ˆä¸Šä¼ çš„è¾“å…¥æ¡†ï¼Œä»¥åŠå†å²æ±‡å…¥çºªå½•ã€‚

app/views/admin/registration_imports/index.html.erb

```
<h1><%= @event.name %> / Registrations Import</h1>


<%= form_for [:admin, @event, RegistrationImport.new] do |f| %>

  <div class="form-group">
    <%= f.label :csv_file %>
    <%= f.file_field :csv_file, :required => true, :class => "form-control" %>
  </div>

  <div class="form-group">
    <%= f.submit "é€å‡º", :class => "btn btn-primary" %>
  </div>

<% end %>

<table class="table">
<tr>
  <th>ID</th>
  <th>çŠ¶æ€</th>
  <th>CSVæ¡£æ¡ˆ</th>
  <th>æ€»ç¬”æ•°</th>
  <th>æ±‡å…¥æˆåŠŸç¬”æ•°</th>
  <th>é”™è¯¯è®¯æ¯</th>
</tr>
<% @imports.each do |import| %>
  <tr>
    <td><%= import.id %></td>
    <td><%= import.status %></td>
    <td><%= link_to import.csv_file.url, import.csv_file.url %></td>
    <td><%= import.total_count %></td>
    <td><%= import.success_count %></td>
    <td>
      <ul>
      <% Array(import.error_messages).each do |e| %>
       <li><%= e[0] %> ----> <strong><%= e[1] %></strong></li>
      <% end %>
      </ul>
    </td>
  </tr>
<% end %>
</table>
```

è¿™æ ·å°±å®Œå·¥å•¦ã€‚

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/wy7rA3aRrSGT7BtGhFlF_25-5.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/wy7rA3aRrSGT7BtGhFlF_25-5.png)

# 26-1 å‰è¨€å’Œå®‰è£… sidekiq

æ‰€è°“çš„å¼‚æ­¥å¤„ç†ä»»åŠ¡ï¼Œå°±æ˜¯åœ¨ç”¨æˆ·é€å‡ºæ“ä½œåï¼ŒRails ä¸ä¼šç«‹å³æ‰§è¡Œè¿™ä¸ªä»»åŠ¡ï¼Œè€Œæ˜¯äº¤ç”±å¦ä¸€ä¸ªè¿›ç¨‹(process)åœ¨èƒŒæ™¯è¿›è¡Œå¤„ç†æ‰§è¡Œã€‚

ä½¿ç”¨çš„åœºæ™¯æ˜¯ï¼šå½“ä»»åŠ¡è¦æ‰§è¡Œå¾ˆä¹…çš„æ—¶å€™ï¼Œä¾‹å¦‚æ±‡å‡ºå¤§ç¬”æ•°æ®ã€æ±‡å…¥å¤§ç¬”æ•°æ®ç­‰ï¼Œå½“æ•°æ®é‡ä¸Šä¸‡ç¬”çš„æ—¶å€™ï¼Œå¯èƒ½ä¼šéœ€è¦å¥½å‡ åˆ†é’Ÿæ‰èƒ½æ‰§è¡Œå®Œæˆã€‚è¿™æ—¶å€™å¦‚æœä¸åšå¼‚æ­¥å¤„ç†ï¼Œç”¨æˆ·çš„æµè§ˆå™¨å°±ä¼šåƒå¡ä½ä¸€æ ·ï¼Œéœ€è¦ç­‰æœåŠ¡å™¨å®Œæˆä»»åŠ¡æ‰æœ‰å›åº”ã€‚

ç­‰å¾…æ—¶é—´å¤ªä¹…é™¤äº†è®©ç”¨æˆ·æ„Ÿå—ä¸ä½³ä¹‹å¤–ï¼Œå¯¹äºæœåŠ¡å™¨æ•ˆèƒ½ä¸Šçš„å½±å“ä¹Ÿå¾ˆå·¨å¤§ã€‚ç”¨æˆ·å¯èƒ½ç­‰ä¸åŠåˆé‡æ–°æ•´ç†ä¸€æ¬¡ï¼Œäºæ˜¯ç›¸åŒçš„ä»»åŠ¡åˆåœ¨é‡å¤´æ‰§è¡Œä¸€éã€‚è€Œä¸€ä¸ª HTTP Request å¦‚æœé•¿æ—¶é—´æ‰§è¡Œï¼Œä¹Ÿä¼šè®© Rails æœåŠ¡å™¨æ— æ³•æœåŠ¡å…¶ä»–ç”¨æˆ·ã€‚

å› æ­¤ï¼Œè¿™ç±»å‹çš„ä»»åŠ¡æˆ‘ä»¬ä¼šæ”¹æˆå¼‚æ­¥å¤„ç†ï¼Œç¬¬ä¸€æ—¶é—´ç”¨æˆ·ä¼šå…ˆçœ‹åˆ°ã€Œæ“ä½œæ­£åœ¨æ‰§è¡Œä¸­ï¼Œè¯·ç¨å€™å†å›æ¥ã€æˆ–æ˜¯ã€Œå®Œæˆåä¼š E-mail é€šçŸ¥æ‚¨ã€çš„è®¯æ¯ã€‚

å¸¸ç”¨çš„å¼‚æ­¥å¤„ç†æœ‰ä¸¤å¥— gem:

- [delayed_job](https://github.com/collectiveidea/delayed_job): ä½¿ç”¨å…³è”å¼æ•°æ®åº“ï¼Œå®¹æ˜“å®‰è£…ä½¿ç”¨
- [Sidekiq](http://sidekiq.org/): ä½¿ç”¨é«˜æ•ˆèƒ½çš„ [Redis](https://redis.io/) æ•°æ®åº“ï¼Œæ‰§è¡Œæ•ˆç‡æå¥½ï¼Œä¸šç•Œè¾ƒå¸¸ç”¨

è¿™ä¸¤å¥— gem çš„ä½œç”¨éƒ½æ˜¯è®© Rails å¯ä»¥å­˜ä¸‹è¦æ‰§è¡Œçš„å¼‚æ­¥å¤„ç†ä»»åŠ¡ï¼Œç„¶åå¯åŠ¨è¿›ç¨‹(process)åœ¨èƒŒæ™¯è¿›è¡Œå¤„ç†æ‰§è¡Œã€‚

è¿™ä¸€ç« å°†ç”¨ Sidekiq ä¸¾ä¾‹ï¼Œæœ¬æœº Mac éœ€è¦å®‰è£… Redis æ•°æ®åº“ï¼š

æ‰§è¡Œ `brew install redis`

å¦å¼€ä¸€ä¸ª Termonal è§†çª—ï¼Œæ‰§è¡Œ `redis-server /usr/local/etc/redis.conf` å°±ä¼šè·‘èµ·æ¥ Redis æœåŠ¡å™¨

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/dGmddzyTTdqGfcvYuom0_26-2.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/dGmddzyTTdqGfcvYuom0_26-2.png)

ç¼–è¾‘ `Gemfile`

Gemfile

```
+  gem 'sidekiq'
```

æ‰§è¡Œ `bundle`

ç¼–è¾‘ `config/environments/development.rb` å’Œ `config/environments/production.rb` å‘Šè¯‰ Rails è¦ç”¨ sidekiq æ¥åšå¼‚æ­¥å¤„ç†

config/environments/development.rb

```
+ config.active_job.queue_adapter = :sidekiq
```

æ–°å¢ `config/sidekiq.yml`

```
---
:queues:
  - default
  - mailers
```

é‡å¯æœåŠ¡å™¨

# 26-2 å¼‚æ­¥æ±‡å…¥

å°±æ‹¿ä¸Šä¸€ç« çš„æ•°æ®æ±‡å…¥æ¥æ”¹å§ï¼Œæœ¬æ¥çš„æ±‡å…¥æœ‰1000ç¬”å…¶å®å°±è¦è·‘ä¸€é˜µå­äº†ï¼Œè¿™æ˜¯ä¸ªæ ‡å‡†æƒ…å†µéœ€è¦æ”¹æˆå¼‚æ­¥å¤„ç†ã€‚

æ‰§è¡Œ `rails g job import_worker` è¿™ä¼šäº§ç”Ÿä¸€ç§å¼‚æ­¥å¤„ç†ä»»åŠ¡ï¼Œå«åš `ImportWorkerJob`

app/jobs/import_worker_job.rb

```
  class ImportWorkerJob < ApplicationJob
    queue_as :default

-   def perform(*args)
-     # Do something later
-   end

+   def perform(import_id)
+     import = RegistrationImport.find(import_id)
+     import.process!
+   end

  end
```

è¿™ä¸ªå¼‚æ­¥å¤„ç†è¦æ€ä¹ˆè°ƒç”¨å‘¢ï¼Ÿæ¥ç€ä¿®æ”¹ `app/controllers/admin/registration_imports_controller.rb`ï¼Œæ”¹æˆå¼‚æ­¥å¤„ç†ï¼š

app/controllers/admin/registration_imports_controller.rb

```
  def create
    @import = @event.registration_imports.new(registration_import_params)
    @import.status = "pending"
    @import.user = current_user

    if @import.save
-     @import.process!
+     ImportWorkerJob.perform_later(@import.id)

-     flash[:notice] = "æ±‡å…¥å®Œæˆ"
+     flash[:notice] = "æ±‡å…¥å·²åœ¨èƒŒæ™¯æ‰§è¡Œï¼Œè¯·ç¨å€™å†æ¥çœ‹ç»“æœ"
    end

    redirect_to admin_event_registration_imports_path(@event)
  end
```

æœ¬æ¥æ˜¯ç›´æ¥è°ƒç”¨ `@import.process!`ï¼Œç°åœ¨æ”¹æˆè°ƒç”¨ `ImportWorkerJob.perform_later(@import.id)` å°±ä¼šå˜æˆå¼‚æ­¥ã€‚

ä½ å¯ä»¥å›åˆ° 25-3 å®ä½œçš„æ•°æ®æ±‡å…¥ï¼Œä¸Šä¼ ä¸€ä¸ªæ¡£æ¡ˆçœ‹çœ‹ï¼Œä½ ä¼šå‘ç°æœåŠ¡å™¨ç«‹å³å°±å›ä¼ äº†ã€Œæ±‡å…¥å·²åœ¨èƒŒæ™¯æ‰§è¡Œï¼Œè¯·ç¨å€™å†æ¥çœ‹ç»“æœã€è®¯æ¯ã€‚ä¹‹æ‰€ä»¥è¿™ä¹ˆå¿«ï¼Œæ˜¯å› ä¸ºå®ƒæ²¡æœ‰æ‰§è¡Œæ±‡å…¥ï¼Œå®ƒåªæ˜¯è·Ÿ Sidekiq è¯´æœ‰ä¸€ä¸ªä»»åŠ¡è¦æ‰§è¡Œè€Œå·²ã€‚

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/zsarmhrZSnu7WEV9A3E0_26-1.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/zsarmhrZSnu7WEV9A3E0_26-1.png)

é‚£åˆ°åº•è°å»æ‰§è¡Œè¿™ä¸ªå¼‚æ­¥ä»»åŠ¡å‘¢? æˆ‘ä»¬éœ€è¦å¦å¤–å¯åŠ¨ Sidekiq è¿›ç¨‹ï¼Œè¯·å†å¼€ä¸€ä¸ªæ–°ä¸ª Terminal è§†çª—ï¼Œæ‰§è¡Œ

`bundle exec sidekiq`

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/jZluYz6RS7ClcZCrD7UA_26-4.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/jZluYz6RS7ClcZCrD7UA_26-4.png)

åªè¦æœ‰å¼‚æ­¥ä»»åŠ¡è¿›æ¥ï¼Œè¿™ä¸ª Sidekiq ä¼šå»å»æ‰§è¡Œå®ƒã€‚

> å¦‚æœè¿› rails console æƒ³è¦å•çº¯æµ‹è¯•è¿™ä¸ªä»»åŠ¡ï¼Œå¯ä»¥ä¸éœ€è¦å¼‚æ­¥ï¼Œæ”¹ç”¨ `.perform_now` æ–¹æ³•å°±ä¼šé©¬ä¸Šæ‰§è¡Œ

# 26-3 Sidekiq ç®¡ç† UI

Sidekiq æœ‰æä¾›ä¸€ä¸ªæ¼‚äº®çš„ç®¡ç† UIï¼Œå¯ä»¥æ¬£èµæœ‰å¤šå°‘å¾…æ‰§è¡Œçš„å¼‚æ­¥ä»»åŠ¡ã€æœ‰å¤šå°‘æ‰§è¡ŒæˆåŠŸå’Œå¤±è´¥(å¤±è´¥sidekiqä¼šé‡è¯•)ï¼Œä¹Ÿå¯ä»¥åˆ é™¤ä»»åŠ¡ã€‚

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/fu5NgA99TySIWr2WHeYR_26-5.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/fu5NgA99TySIWr2WHeYR_26-5.png)

ä¿®æ”¹ `config/routes.rb`

config/routes.rb

```
  Rails.application.routes.draw do

+   require 'sidekiq/web'
+   authenticate :user, lambda { |u| u.is_admin? } do
+     mount Sidekiq::Web => '/sidekiq'
+   end
```

> å…¶ä¸­ authenticate æ–¹æ³•ä¼šæ£€æŸ¥æƒé™ï¼Œåˆ©ç”¨æˆ‘ä»¬ä¹‹å‰å†™çš„ User#is_admin? æ–¹æ³•

æµè§ˆå™¨æµè§ˆ `http://localhost:3000/sidekiq`

# 26-4 å¼‚æ­¥æ±‡å‡º

æ•°æ®æ±‡å‡ºä¹Ÿæ˜¯ä¸€ä¸ªå¸¸ç”¨å¼‚æ­¥æ¥å¤„ç†çš„ä»»åŠ¡ï¼Œæµç¨‹å’Œæ±‡å…¥å…¶å®87åˆ†åƒï¼š

- å»ºç«‹ RegistraionExport modelï¼Œè¿™ä¸ª model ä¼šçºªå½•æ˜¯é‚£ä¸ª user åšæ±‡å‡ºã€æ˜¯å“ªä¸ª event è¦æ±‡å‡ºï¼Œä»¥åŠå­˜å‚¨æœ€åæ±‡å‡ºçš„æ¡£æ¡ˆ
- å»ºç«‹ä¸€ä¸ª RegistrationExports controllerï¼Œè¿™ä¸ª controller è®©ç”¨æˆ·å¯ä»¥æ–°å¢æ±‡å‡ºçºªå½•ï¼Œä»¥åŠæµè§ˆæ±‡å‡ºçºªå½•
- å»ºç«‹ ExportWorkerJobï¼Œè¿™ä¸ªå¼‚æ­¥ä»»åŠ¡ä¼šæ‰§è¡Œæ±‡å‡ºæ“ä½œï¼Œå¹¶å°†æ±‡å‡ºçš„æ¡£æ¡ˆæ”¾åˆ° RegistraionExport model ä¸Š
- å¼‚æ­¥ä»»åŠ¡æœ€åå®Œæˆæ—¶ï¼Œå¯ä»¥å¯„ E-mail é€šçŸ¥ç”¨æˆ·æ±‡å‡ºçš„æ¡£æ¡ˆå·²ç»å‡†å¤‡å¥½äº†

è¿™é‡Œå°±ä¸ç¤ºèŒƒå®åšäº†ã€‚

æœ€åï¼Œæ±‡å‡ºå’Œæ±‡å…¥çš„åŠŸèƒ½è¦å®Œæ•´å®åšçš„è¯ï¼Œè¿˜éœ€è¦è€ƒè™‘æ¡£æ¡ˆå­˜å‚¨çš„ä½ç½®ã€‚æˆ‘ä»¬ç”¨ carrierwave ä¸Šä¼ çš„æ¡£æ¡ˆï¼Œé»˜è®¤æ˜¯å…¬å¼€çš„ã€‚ä½†æ˜¯æ±‡å‡ºå’Œæ±‡å…¥çš„æ¡£æ¡ˆï¼Œåº”è¯¥ä¹Ÿå¿…é¡»è¦æ£€æŸ¥æœ‰æ²¡æœ‰æƒé™æ‰è¡Œã€‚è¿™éƒ¨åˆ†çš„å®ä½œç‰µæ‰¯åˆ°æˆ‘ä»¬ä½¿ç”¨å“ªç§æ¡£æ¡ˆæœåŠ¡å™¨ï¼š

- å­˜å‚¨åœ¨æœ¬æœºçš„è¯ï¼Œè¯·å‚è€ƒ [How To: Secure Upload](https://github.com/carrierwaveuploader/carrierwave/wiki/how-to:-secure-upload)
- å­˜å‚¨åœ¨ä¸ƒç‰›äº‘ï¼Œè¯·å‚è€ƒ [ä¸‹è½½å‡­è¯](https://developer.qiniu.com/kodo/manual/1202/download-token)
- å­˜å‚¨åœ¨ AWS S3ï¼Œè¯·å‚è€ƒ [Serving Private Content](http://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/PrivateContent.html)

åœ¨ä¹‹åçš„è¿›é˜¶éƒ¨ç½²è¯¾ç¨‹ä¸­ï¼Œä¼šå†è¿›ä¸€æ­¥ç¤ºèŒƒå¦‚ä½•ä½¿ç”¨ã€‚

# 26-5 æŠ¥å15åˆ†é’Ÿå†…æ²¡å®Œæˆè‡ªåŠ¨å–æ¶ˆ

å¼‚æ­¥å¤„ç†å¯ä»¥è®¾å®šå»¶è¿Ÿæ—¶é—´ï¼Œä¾‹å¦‚æˆ‘ä»¬æ¥å®ä½œä¸€ä¸ªå°åŠŸèƒ½ï¼šå¦‚æœæŠ¥å15åˆ†é’Ÿå†…æ²¡æœ‰å®Œæˆï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å–æ¶ˆ

æ‰§è¡Œ `rails g job check_registration`

ç¼–è¾‘ `app/jobs/check_registration_job.rb`

app/jobs/check_registration_job.rb

```
  class CheckRegistrationJob < ApplicationJob
    queue_as :default

-   def perform(*args)
+   def perform(registration_id)
+     registration = Registration.find(registration_id)
+
+     unless registration.status == "confirmed"
+       registration.status = "cancalled"
+       registration.save!
+     end
+
    end
  end
```

ç¼–è¾‘ `app/models/registration.rb`

app/models/registration.rb

```
-  STATUS = ["pending", "confirmed"]
+  STATUS = ["pending", "confirmed", "cancalled"]
```

ç¼–è¾‘ `config/locales/zh-CN.yml`

config/locales/zh-CN.yml

```
   registration:
     status:
       pending: æŠ¥åå°šæœªå®Œæˆ
       confirmed: æŠ¥åæˆåŠŸ
+      cancalled: æŠ¥åå·²å–æ¶ˆ
```

ç¼–è¾‘ `app/controllers/registrations_controller.rb`ï¼Œåœ¨æ–°å»ºæŠ¥åä¹‹åï¼Œå¢åŠ è¿™ä¸ªå¼‚æ­¥ä»»åŠ¡ï¼Œå¹¶ç”¨ `set` æ–¹æ³•æŒ‡å®šå»¶è¿Ÿæ—¶é—´ã€‚å¦å¤–ï¼Œé‡æ„äº† `before_action :set_pending_registration` æ£€æŸ¥å¦‚æœæ˜¯ cancalled çŠ¶æ€å°±ä¸èƒ½ç»§ç»­å¡«å†™æŠ¥åèµ„æ–™ã€‚

app/controllers/registrations_controller.rb

```
  class RegistrationsController < ApplicationController

    before_action :find_event
+   before_action :set_pending_registration, :only => [:step1, :step1_update, :step2, :step2_update, :step3, :step3_update]

    def create
      @registration = @event.registrations.new(registration_params)
      @registration.ticket = @event.tickets.find( params[:registration][:ticket_id] )
      @registration.status = "pending"
      @registration.user = current_user
      @registration.current_step = 1

      if @registration.save
+        CheckRegistrationJob.set( wait: 15.minutes ).perform_later(@registration.id)

    # ç•¥...

    def step1
-     @registration = @event.registrations.find_by_uuid(params[:id])
    end

    def step1_update
-     @registration = @event.registrations.find_by_uuid(params[:id])

      # ç•¥

    def step2
-     @registration = @event.registrations.find_by_uuid(params[:id])
    end

    def step2_update
-     @registration = @event.registrations.find_by_uuid(params[:id])

      # ç•¥

    def step3
-     @registration = @event.registrations.find_by_uuid(params[:id])
    end

    def step3_update
-     @registration = @event.registrations.find_by_uuid(params[:id])

    # ç•¥

    protected

+   def set_pending_registration
+     @registration = @event.registrations.find_by_uuid(params[:id])
+
+     if @registration.status == "cancalled"
+       flash[:alert] = "è¯·é‡æ–°æŠ¥å"
+       redirect_to event_path(@event)
+     end
+   end

    # ç•¥
```

> å¯ä»¥æš‚æ—¶æ”¹æˆç”¨ `1.minute` è¿›è¡Œæµ‹è¯•

è¿™æ ·å°±å®Œæˆäº†ã€‚

# å¼‚æ­¥ E-mail å¯„ä¿¡

Rails çš„ E-mail å¯„ä¿¡åŠŸèƒ½ï¼Œå…¶å®ä¹Ÿç”¨äº†å¼‚æ­¥å¤„ç†ä»»åŠ¡ï¼Œå› ä¸ºå¯„ä¿¡ä¼šè°ƒç”¨ç¬¬ä¸‰æ–¹çš„å¯„ä¿¡ SMTP æœåŠ¡å™¨ï¼Œæ‰§è¡Œé€Ÿåº¦ä¸Šæ¯”è¾ƒæ…¢ï¼Œå› æ­¤ä¹Ÿé€‚åˆç”¨å¼‚æ­¥å¤„ç†æ¥åšã€‚

å›æƒ³åœ¨ 24-2 å¯„é€æŠ¥åå®Œæˆçš„ E-mail æ˜¯å¦‚ä½•å¯„é€çš„ï¼š

```
NotificationMailer.confirmed_registration(@registration).deliver_later
```

è¿™é‡Œçš„ `deliver_later` æ–¹æ³•ï¼Œå°±ä¼šç”¨è¿™ä¸€ç« è®¾å®šçš„å¼‚æ­¥å¤„ç†æœºåˆ¶å»å¯„ä¿¡ã€‚

å¦‚æœä¸è¦ç”¨å¼‚æ­¥å¤„ç†ï¼Œä¾‹å¦‚æˆ‘ä»¬åœ¨ rails console æµ‹è¯•çš„æ—¶å€™ï¼š

```
NotificationMailer.confirmed_registration( Registration.by_status("confirmed").last ).deliver_now
```

è¿™é‡Œçš„ `deliver_now` æ–¹æ³•ï¼Œå°±ä¼šç«‹å³å¯„å‡ºã€‚
