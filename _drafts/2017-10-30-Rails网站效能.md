---
layout: post
title: "Railsç½‘ç«™æ•ˆèƒ½"
date: 2017-10-30
tags:
    Rails
    æ•™æ
---
| 1. å‰è¨€ä¸æ¡ˆä¾‹å‡†å¤‡                               |      |
| ---------------------------------------- | ---- |
| [**  1-1 å‰è¨€](https://fullstack.xinshengdaxue.com/posts/1205) |      |
| [**  1-2 æ³•å¾‹è­¦å‘Š](https://fullstack.xinshengdaxue.com/posts/1206) |      |

| 2. XSS è·¨ç«™è„šæœ¬æ”»å‡»                            |      |
| ---------------------------------------- | ---- |
| [**  2-1 ä»€ä¹ˆæ˜¯ XSS è·¨ç«™è„šæœ¬æ”»å‡»?](https://fullstack.xinshengdaxue.com/posts/1207) |      |
| [**  2-2 å¦‚ä½•é˜²å¾¡ XSS?](https://fullstack.xinshengdaxue.com/posts/1208) |      |
| [**  2-3 å¦ä¸€ä¸ªä¸å°å¿ƒçš„æ¼æ´](https://fullstack.xinshengdaxue.com/posts/1209) |      |
| [**  2-4 è§£æ³•åŠæ³•](https://fullstack.xinshengdaxue.com/posts/1210) |      |
| [**  2-5 å°ç»“](https://fullstack.xinshengdaxue.com/posts/1211) |      |

| 3. CSRF è·¨ç«™è¯·æ±‚ä¼ªé€                            |      |
| ---------------------------------------- | ---- |
| [**  3-1 ä»€ä¹ˆæ˜¯ CSRF è·¨ç«™è¯·æ±‚ä¼ªé€ ?](https://fullstack.xinshengdaxue.com/posts/1212) |      |
| [**  3-2 å¦‚ä½•é˜²å¾¡ï¼Ÿ](https://fullstack.xinshengdaxue.com/posts/1213) |      |
| [**  3-3 æ¼ç½‘ä¹‹é±¼](https://fullstack.xinshengdaxue.com/posts/1214) |      |
| [**  3-4 å¦‚ä½•é˜²å¾¡ POST ç±»å‹çš„ CSRF æ”»å‡»ï¼Ÿ](https://fullstack.xinshengdaxue.com/posts/1215) |      |

| 4. SQL Injection æ•°æ®åº“æ³¨å…¥æ”»å‡»                 |      |
| ---------------------------------------- | ---- |
| [**  4-1 ä»€ä¹ˆæ˜¯ SQL](https://fullstack.xinshengdaxue.com/posts/1216) |      |
| [**  4-2 ä»€ä¹ˆæ˜¯ SQL Injection æ”»å‡»?](https://fullstack.xinshengdaxue.com/posts/1217) |      |
| [**  4-3 å¦‚ä½•é˜²å¾¡ SQL æ³¨å…¥æ”»å‡» ï¼Ÿ](https://fullstack.xinshengdaxue.com/posts/1235) |      |
| [**  4-4 æ¼ç½‘ä¹‹é±¼](https://fullstack.xinshengdaxue.com/posts/1218) |      |

| 5. å¤§é‡èµ‹å€¼(Mass Assignment)                 |      |
| ---------------------------------------- | ---- |
| [**  5-1 ActiveRecord èµ‹å€¼åŠŸèƒ½](https://fullstack.xinshengdaxue.com/posts/1219) |      |
| [**  5-2 å¤§é‡èµ‹å€¼ä¸ Rails è¡¨å•](https://fullstack.xinshengdaxue.com/posts/1220) |      |
| [**  5-3 æ”»å‡»ç¤ºèŒƒ](https://fullstack.xinshengdaxue.com/posts/1221) |      |
| [**  5-4 ä¿®è¡¥æ¼æ´](https://fullstack.xinshengdaxue.com/posts/1222) |      |

| 6. ç ´è§£åŠ å¯† Cookie-based Session             |      |
| ---------------------------------------- | ---- |
| [**  6-1 ä»€ä¹ˆæ˜¯åŠ å¯† Cookie](https://fullstack.xinshengdaxue.com/posts/1223) |      |
| [**  6-2 Rails çš„ secret key](https://fullstack.xinshengdaxue.com/posts/1224) |      |
| [**  6-3 ç ´è§£ç¤ºèŒƒ](https://fullstack.xinshengdaxue.com/posts/1225) |      |
| [**  6-4 å¦‚ä½•é˜²å¾¡?](https://fullstack.xinshengdaxue.com/posts/1226) |      |

| 7. DoS æ‹’ç»æœåŠ¡æ”»å‡»                            |      |
| ---------------------------------------- | ---- |
| [**  7-1 ä»€ä¹ˆæ˜¯ DoS æ‹’ç»æœåŠ¡æ”»å‡»](https://fullstack.xinshengdaxue.com/posts/1227) |      |
| [**  7-2 å¦‚ä½•é˜²å¾¡?](https://fullstack.xinshengdaxue.com/posts/1228) |      |

| 8. å®‰å…¨åˆ†æå·¥å…·                                |                                          |
| ---------------------------------------- | ---------------------------------------- |
| [**  8-1 å®‰è£… brakeman æ£€æµ‹ä»£ç ](https://fullstack.xinshengdaxue.com/posts/1229) |                                          |
| [**  8-2 å®‰è£… bundler-audit æ£€æµ‹å¥—ä»¶](https://fullstack.xinshengdaxue.com/posts/1230) | å…±1ä¸ªä½œä¸š \|[** æœªå®Œæˆ](https://fullstack.xinshengdaxue.com/posts/1230#task) |

| 9. å¯†ç æ˜¯å¦‚ä½•å­˜å‚¨çš„ï¼Ÿ                             |      |
| ---------------------------------------- | ---- |
| [**  9-1 è®¤è¯†æ•£åˆ—å‡½æ•°](https://fullstack.xinshengdaxue.com/posts/1231) |      |
| [**  9-2 æ•£åˆ—å‡½æ•°çš„ç”¨é€”](https://fullstack.xinshengdaxue.com/posts/1232) |      |

| 10. HTTPS åŠ å¯†å®‰å…¨è¿çº¿                         |      |
| ---------------------------------------- | ---- |
| [**  10-1. è®¤è¯†éå¯¹ç§°åŠ å¯†](https://fullstack.xinshengdaxue.com/posts/1233) |      |
| [**  10-2 ç»“è¯­](https://fullstack.xinshengdaxue.com/posts/1234) |      |

# 1-1 å‰è¨€

ä¸ºäº†è®©å¤§å®¶å¯ä»¥å¿«é€Ÿå¼€å§‹è¿›è¡Œ~~æ”»å‡»~~ï¼Œè¯· Fork è¿™ä¸ªé¡¹ç›®ï¼š<https://github.com/growthschool/hackme-app>ï¼Œç„¶å Clone å›å»ã€‚

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/RJ7gTIJqTLWOQtFmp3J3_1-1.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/RJ7gTIJqTLWOQtFmp3J3_1-1.png)

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/bsQSwaFnT0SXT38aPK8E_1-2.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/bsQSwaFnT0SXT38aPK8E_1-2.png)

> å› ä¸ºç­‰ä¼šäº¤ä½œä¸šç”¨ Pull Requestï¼Œæ‰€ä»¥ä½ éœ€è¦ç”¨ Fork æŠŠé¡¹ç›®å¤åˆ¶åœ¨ä½ çš„ Github å¸å·ä¸‹ï¼Œè¿™æ ·ä¿®æ”¹åæ‰å¯ä»¥ Push ä¸Šå»ï¼Œæœ€åç”¨ Pull Request äº¤ä½œä¸šã€‚

Fork åï¼Œè¯·ä¾åºæ‰§è¡Œï¼š

`git clone git@github.com:ä½ çš„å¸å·/hackme-app.git`
`cd hackme-app`
`bin/setup`
`bundle exec rake dev:fake`

åœ¨è¿™ä¸ªé¡¹ç›®ä¸­ï¼Œå·²ç»è£…å¥½äº† Deviseã€Bootstrapã€RSpecï¼Œå¹¶ä¸”å»ºç«‹å¥½äº†ä»¥ä¸‹åŠŸèƒ½ï¼š

- ç”¨æˆ·ç™»å…¥ã€ç™»å‡º
- ç”¨æˆ·å¯ä»¥æµè§ˆä¸åŒæ´»åŠ¨
- ç”¨æˆ·å¯ä»¥é’ˆå¯¹æ´»åŠ¨ç•™è¨€
- ç®¡ç†å‘˜å¯ä»¥é’ˆå¯¹ç‰¹å®šç•™è¨€ï¼Œè¿›è¡Œé«˜äº®(Highlight)æ˜¾ç¤º
- ç”¨æˆ·å¯ä»¥æµè§ˆå•†å“
- ç”¨æˆ·å¯ä»¥å°†å•†å“åŠ å…¥è´­ç‰©è½¦

æ‰§è¡Œ `rails server`

æ¥ç€æ‰“å¼€æµè§ˆå™¨ [http://localhost:3000](http://localhost:3000/)

æ•°æ®åº“ä¸­å·²ç»æœ‰ä¸‰ä¸ªç”¨æˆ·ï¼š

å¸å·: `hacker@example.org`
å¯†ç : `12345678`
è¯´æ˜: è¿™æ˜¯ä½ ï¼Œè¶…çº§éª‡å®¢

å¸å·: `ihower@gmail.com`
å¯†ç : `12345678`
è¯´æ˜: è¿™æ˜¯è¦è¢«éª‡çš„è·¯äºº

å¸å·: `admin@example.org`
å¯†ç : `12345678`
è¯´æ˜: è¿™æ˜¯è¦è¢«éª‡çš„ç½‘ç«™ç®¡ç†å‘˜

è¯·æµè§ˆçœ‹çœ‹å‰å°å…¶ä¸­ä¸€ä¸ªæ´»åŠ¨é¡µé¢ï¼š

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/0pC86VofRmLDzD6Zkm3x_1-3.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/0pC86VofRmLDzD6Zkm3x_1-3.png)

# 1-2 æ³•å¾‹è­¦å‘Š

æœ¬è¯¾ç¨‹çš„ç›®çš„æ˜¯ä¸ºäº†è®©å¤§å®¶èƒ½å¤Ÿæ›´å¥½çš„ä¿æŠ¤è‡ªå·±ï¼Œäº†è§£éª‡å®¢æ˜¯å¦‚ä½•æ”»å‡»çš„ï¼Œè¿›è€Œäº†è§£ Rails æ˜¯å¦‚ä½•è¿›è¡Œé˜²å¾¡çš„ã€‚æ‰€è°“ã€Œå®³äººä¹‹å¿ƒä¸å¯æœ‰ï¼Œé˜²äººä¹‹å¿ƒä¸å¯æ— ã€ï¼Œçœ‹åˆ°åˆ«äººå®¶é‡Œæ²¡é”é—¨ï¼Œä¸ä»£è¡¨ä½ å¯ä»¥è¿›å»ç ´åæˆ–å·ä¸œè¥¿ã€‚è¿™åœ¨æ¯ä¸ªå›½å®¶éƒ½æ˜¯çŠ¯æ³•çš„è¡Œä¸ºï¼ä½ å¯ä»¥å–„æ„åœ°æé†’äººå®¶æ²¡é”é—¨ï¼Œä½†æ˜¯åƒä¸‡ä¸è¦è‡ªä»¥ä¸ºæ˜¯è¶Šè¿‡æ³•å¾‹çš„ç•Œçº¿å–”ã€‚

> [ä¸­åäººæ°‘å…±å’Œå›½ç½‘ç»œå®‰å…¨æ³•](http://www.npc.gov.cn/npc/xinwen/2016-11/07/content_2001605.htm) ç¬¬äºŒåä¸ƒæ¡ ä»»ä½•ä¸ªäººå’Œç»„ç»‡ä¸å¾—ä»äº‹éæ³•ä¾µå…¥ä»–äººç½‘ç»œã€å¹²æ‰°ä»–äººç½‘ç»œæ­£å¸¸åŠŸèƒ½ã€çªƒå–ç½‘ç»œæ•°æ®ç­‰å±å®³ç½‘ç»œå®‰å…¨çš„æ´»åŠ¨ï¼›ä¸å¾—æä¾›ä¸“é—¨ç”¨äºä»äº‹ä¾µå…¥ç½‘ç»œã€å¹²æ‰°ç½‘ç»œæ­£å¸¸åŠŸèƒ½åŠé˜²æŠ¤æªæ–½ã€çªƒå–ç½‘ç»œæ•°æ®ç­‰å±å®³ç½‘ç»œå®‰å…¨æ´»åŠ¨çš„ç¨‹åºã€å·¥å…·ï¼›æ˜çŸ¥ä»–äººä»äº‹å±å®³ç½‘ç»œå®‰å…¨çš„æ´»åŠ¨çš„ï¼Œä¸å¾—ä¸ºå…¶æä¾›æŠ€æœ¯æ”¯æŒã€å¹¿å‘Šæ¨å¹¿ã€æ”¯ä»˜ç»“ç®—ç­‰å¸®åŠ©ã€‚

# 2-1 ä»€ä¹ˆæ˜¯ XSS è·¨ç«™è„šæœ¬æ”»å‡»?

æˆ‘ä»¬åœ¨ã€Œç™¾å®ç®± 13. Rich Editor ç¼–è¾‘å™¨ã€æœ‰ä»‹ç»è¿‡ [XSS](https://zh.wikipedia.org/zh-cn/%E8%B7%A8%E7%BD%91%E7%AB%99%E6%8C%87%E4%BB%A4%E7%A0%81) è·¨ç«™è„šæœ¬æ”»å‡»ï¼šå¦‚æœç”¨æˆ·å¯ä»¥è‡ªå·±å¼ è´´å†…å®¹åˆ°ç½‘ç«™ä¸Šï¼Œå¹¶ä¸”ç½‘ç«™ä¼šæ˜¾ç¤ºå‡ºæ¥çš„è¯ï¼Œå°±æœ‰å¯èƒ½æœ‰ XSS æ¼æ´ã€‚æ¶æ„ç”¨æˆ·ä¼šå¼ è´´ JavaScript ä»£ç ä¸Šæ¥ï¼Œé‚£ä¹ˆè¿™ä¹ˆå½“å…¶ä»–ç”¨æˆ·æµè§ˆåˆ°è¿™ä¸€é¡µæ—¶ï¼Œæµè§ˆå™¨å°±ä¼šç›²ç›®çš„æ‰§è¡Œ JavaScript ä»£ç ã€‚

è®©æˆ‘ä»¬æ”»å‡»çœ‹çœ‹ï¼Œè¯·ç”¨ `hacker@example.org` ç™»å…¥ï¼Œç„¶åé’ˆå¯¹ä¸€åˆ™æ´»åŠ¨ç•™è¨€ï¼Œè´´ä¸Šä»¥ä¸‹ JavaScript ä»£ç ï¼š

```
<script>
$.ajax({
  url: $(location).attr('href') + "/comments",
  method: "POST",
  data: {  comment : { content: "å•Šå“ˆå“ˆå“ˆï½ä½ çœ‹çœ‹ä½ ï¼ (Ïƒï¾Ÿâˆ€ï¾Ÿ)Ïƒï¾Ÿâˆ€ï¾Ÿ)Ïƒï¾Ÿâˆ€ï¾Ÿ)Ïƒ" } },
  dataType: "JSON"
})
</script>
```

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/spCHxGm0T1a72SvrzZCV_2-1.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/spCHxGm0T1a72SvrzZCV_2-1.png)

ç•™è¨€å®Œä¹‹åï¼Œæ¥ä¸‹æ¥ä»»ä½•äººçœ‹åˆ°è¿™ä¸€é¡µï¼Œå°±ä¼šæ‰§è¡Œè¿™æ®µ Ajax ä»£ç ï¼Œä¹Ÿè·Ÿç€ç•™è¨€ä¸€æ¬¡ã€‚è¯·å¤šé‡æ–°æ•´ç†é¡µé¢å‡ æ¬¡çœ‹çœ‹ã€‚

ä½ ä¹Ÿå¯ä»¥æµ‹è¯•çœ‹çœ‹å…¶ä»–äººæµè§ˆä¼šæ€ä¹ˆæ ·ï¼Ÿä½ å¯ä»¥ç”¨å¦ä¸€ä¸ªæµè§ˆå™¨(ä¾‹å¦‚ Safari)ï¼Œæˆ–æ˜¯ç”¨ Chrome çš„ Incognito Windows(æ— ç—•æ¨¡å¼ï¼Œè¿™ä¼šå¼€å¯ä¸€ä¸ªå¹²å‡€æ²¡æœ‰ Cookie çš„æ–°è§†çª—)ï¼Œç„¶åæ”¹ç”¨ `admin@example.org` ç™»å…¥ï¼Œç„¶åæµè§ˆåˆšåˆšé‚£ä¸€ä¸ªæ´»åŠ¨...

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/pVhhnVfpQhORali1KhpE_2-chrome.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/pVhhnVfpQhORali1KhpE_2-chrome.png)

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/j0wwOYnhQ8qwc4Nx7rhk_2-2.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/j0wwOYnhQ8qwc4Nx7rhk_2-2.png)

`admin` ä¹Ÿä¼šè‡ªåŠ¨å¼ è´´ç•™è¨€äº†....

# 2-2 å¦‚ä½•é˜²å¾¡ XSS?

è¦é˜²å¾¡è¯´èµ·æ¥ç®€å•ï¼Œå°±æ˜¯æ˜¾ç¤ºæ¯ä¸ªç”¨æˆ·è´´æ–‡çš„åœ°æ–¹éƒ½è¦è„±é€¸ HTMLï¼Œæ‰“å¼€ `app/views/events/show.html.erb`

app/views/events/show.html.erb

```
-  <%= raw comment.content %>
+  <%= comment.content %>
```

Rails é»˜è®¤å°±ä¼šè„±é€¸ HTML äº†ï¼Œç”¨ `raw comment.content` æˆ– `comment.content.html_safe` åè€Œæ˜¯å‘Šè¯‰ Rails ä¸è¦è„±é€¸ HTMLã€‚æ‹¿æ‰ `raw` ä¹‹åï¼Œå°±ä¼šè„±é€¸æ˜¾ç¤ºå‡ºåŸä»£ç ï¼Œä¾‹å¦‚ `<` ä¼šå˜æˆ `&lt;`ã€‚

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/1GJCqr1cSja2Ogj1Y6Hk_2-3.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/1GJCqr1cSja2Ogj1Y6Hk_2-3.png)

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/ENHZc8s5T66i5qSGpllR_2-4.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/ENHZc8s5T66i5qSGpllR_2-4.png)

ä¸è¿‡è¿™æ ·ä¼šå®Œå…¨é˜²æ­¢ä»»ä½• HTML æ ‡ç±¤ï¼Œä¾‹å¦‚æˆ‘ä»¬å¼ è´´ä»¥ä¸‹è¿™å¼ å›¾ç‰‡ï¼š

```
<img src="http://placehold.it/200x200" />
```

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/TUL929xbQHaN0UknZsg2_2-5.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/TUL929xbQHaN0UknZsg2_2-5.png)

ä¸€æ ·è¢«è„±é€¸äº† :(

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/A36zirZfQ7CaOuHabLkL_2-6.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/A36zirZfQ7CaOuHabLkL_2-6.png)

å¦‚æœæˆ‘ä»¬è¿˜æ˜¯å¸Œæœ›ç”¨æˆ·å¯ä»¥è¾“å…¥ HTMLï¼Œå°±åƒç™¾å®ç®± 13. Rich Editor ç¼–è¾‘å™¨çš„éœ€æ±‚ï¼Œè¯·æ”¹ç”¨ sanitize ç™½åå•è¿‡æ»¤ï¼Œåªå…è®¸éƒ¨åˆ†çš„ HTML æ ‡ç±¤ï¼š

app/views/events/show.html.erb

```
-  <%= comment.content %>
+  <%= sanitize comment.content %>
```

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/xahFlNcQgGPo1lW4430z_2-7.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/xahFlNcQgGPo1lW4430z_2-7.png)

# 2-3 å¦ä¸€ä¸ªä¸å°å¿ƒçš„æ¼æ´

è¯·ç‚¹ä¸»é€‰å•çš„ä¿®æ”¹ä¸ªäººèµ„æ–™ï¼Œè¿™ä¸ªåœ°æ–¹ä¼šä¸ä¼šæœ‰æ¼æ´å‘¢?

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/OGu6g0GnTimIzv03Wkdb_2-8.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/OGu6g0GnTimIzv03Wkdb_2-8.png)

å›åˆ°ä»»ä¸€ä¸ªæ´»åŠ¨é¡µé¢ï¼š

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/ogGFNIQTjmKqTWzeXt29_2-9.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/ogGFNIQTjmKqTWzeXt29_2-9.png)

å‘ç°ç«Ÿç„¶æœ‰æ¼æ´ï¼Œè¿™æ®µ JavaScript è¢«æ‰§è¡Œäº†ã€‚

è®©æˆ‘ä»¬æ‰¾æ‰¾çœ‹æ¼æ´å‡ºç°åœ¨å“ªé‡Œï¼ŒåŸæ¥æ˜¯åœ¨ç•™è¨€æ˜¾ç¤ºç”¨æˆ·åç§°çš„åœ°æ–¹ï¼Œæ²¡æœ‰åšå¥½è„±é€¸ :(

app/views/events/show.html

```
<div class="panel-heading">
  <%= user_avatar_link(comment.author) %>
</div>
```

app/helpers/users_helper.rb

```
require 'digest/md5'

module UsersHelper

  def user_avatar_link(user)
    # https://cn.gravatar.com/

    email_md5 = Digest::MD5.hexdigest(user.email)
    gravatar_url = "https://www.gravatar.com/avatar/#{email_md5}"

    str = "<div class ='user-link'>" + link_to(image_tag(gravatar_url), user_path(user)) + " " + user.display_name + "</div>"

    str.html_safe
  end

end
```

è¿™ä¸ª `user_avatar_link` helper çš„ç›®çš„æ˜¯è¾“å‡ºç”¨æˆ·çš„ [Gravater](https://cn.gravatar.com/) ç…§ç‰‡çš„è¿ç»“ï¼Œä»¥åŠç”¨æˆ·çš„æ˜¾ç¤ºåç§°ï¼Œè€Œé—®é¢˜å°±å‡ºåœ¨ `str.html_safe` å¤ªè¿‡æ”¾çºµäº†ã€‚

ä½†æ˜¯å¦‚æœä½ æŠŠ `str.html_safe` è¿™è¡Œæ‹¿æ‰ï¼Œä½ ä¼šå‘ç°æ•´ä¸ª Helper çš„è¾“å‡ºéƒ½è¢«è„±é€¸äº† :( ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„ç»“æœã€‚

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/dNkDDgeuS2euPQwfxWVQ_2-10.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/dNkDDgeuS2euPQwfxWVQ_2-10.png)

è¿™æ˜¯å› ä¸º Rails ä¼šè¿½è¸ªæ¯ä¸ªå­—ç¬¦ä¸²æ˜¯å¦æ˜¯å®‰å…¨çš„ï¼Œå¦‚æœä¸å®‰å…¨çš„è¯ï¼Œè¾“å‡ºæ—¶ä¼šè‡ªåŠ¨è„±é€¸ã€‚ä¸å®‰å…¨çš„å­—ç¬¦ä¸² `+` å®‰å…¨çš„å­—ç¬¦ä¸²ï¼Œä¼šå˜æˆä¸å®‰å…¨çš„ã€‚ç”±äºå­—ç¬¦ä¸² `"<div class ='user-link'>"` é»˜è®¤æ˜¯ä¸å®‰å…¨çš„ï¼Œå› æ­¤åæ¥ç´¯åŠ å­—ç¬¦ä¸²è¿›æ¥ï¼Œæ•´ä¸ª `str` éƒ½æ˜¯ä¸å®‰å…¨çš„ï¼Œæ‰€ä»¥ Rails æœ€åä¼šè®©æ•´ä¸ª `str` éƒ½è„±é€¸ï¼Œé€ æˆå›¾ç‰‡ img æ ‡ç±¤ä¹Ÿæ— æ³•æ˜¾ç¤ºã€‚

# 2-4 è§£æ³•åŠæ³•

#### è§£æ³•åŠæ³•ä¸€

å°å¿ƒç¿¼ç¿¼åœ°åœ¨ä¸éœ€è¦è„±é€¸çš„åœ°æ–¹åŠ ä¸Š `.html_safe`

app/helpers/users_helper.rb

```
require 'digest/md5'

module UsersHelper

  def user_avatar_link(user)
    # https://cn.gravatar.com/

    email_md5 = Digest::MD5.hexdigest(user.email)
    gravatar_url = "https://www.gravatar.com/avatar/#{email_md5}"

-   str = "<div class ='user-link'>" + link_to(image_tag(gravatar_url), user_path(user)) + " " + user.display_name + "</div>"
-   str.html_safe

+   "<div class ='user-link'>".html_safe + link_to(image_tag(gravatar_url), user_path(user)) + " " + user.display_name + "</div>".html_safe
  end

end
```

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/w86gvStkTVKo8BkJUMQ0_2-11.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/w86gvStkTVKo8BkJUMQ0_2-11.png)

#### è§£æ³•åŠæ³•äºŒ

å¯ä»¥ç”¨ Rails å†…å»ºçš„ `content_tag` helper äº§ç”Ÿæ ‡ç±¤ï¼Œç»“æœä¸€æ ·ï¼Œåªæ˜¯å†™èµ·æ¥ä¼šæ¯”å­—ç¬¦ä¸²ç›¸åŠ å¥½çœ‹ä¸€ç‚¹ï¼š

app/helpers/users_helper.rb

```
require 'digest/md5'

module UsersHelper

  def user_avatar_link(user)
    # https://cn.gravatar.com/

    email_md5 = Digest::MD5.hexdigest(user.email)
    gravatar_url = "https://www.gravatar.com/avatar/#{email_md5}"

-   "<div class ='user-link'>".html_safe + link_to(image_tag(gravatar_url), user_path(user)) + " " + user.display_name + "</div>".html_safe

+   content_tag(:div,
      link_to(image_tag(gravatar_url), user_path(user)) + " " + user.display_name ,
      :class => "user-link" )
  end

end
```

# 2-5 å°ç»“

ç”±äº Rails é»˜è®¤ä¼šè„±é€¸ HTML çš„å…³ç³»ï¼Œæ‰€ä»¥ Rails å¯¹ XSS æ˜¯æœ‰äº†åŸºæœ¬çš„é˜²å¾¡ã€‚å¦‚æœä¸æ˜¯ Rails è¿™ç§çš„æ¡†æ¶å¸®ä½ é»˜è®¤è„±é€¸çš„è¯ï¼Œç½‘é¡µä¸Šåªè¦æ˜¾ç¤ºç”¨æˆ·çš„è¾“å‡ºï¼Œéƒ½æœ‰å¯èƒ½æ˜¯ä¸ªå®‰å…¨æ¼æ´ã€‚

ä¸è¿‡å³ä½¿æœ‰ Rails çš„ä¿æŠ¤ï¼Œä½ ä¹Ÿæœ‰å¯èƒ½åœ¨å­—ç¬¦ä¸²ç›¸åŠ çš„è¿‡ç¨‹ä¸­ï¼Œä¸å°å¿ƒå¤ªè¿‡æ”¾çºµè€Œé€ æˆæ¼æ´ï¼Œå°±åƒè¿™ä¸€èŠ‚æ‰€ç¤ºèŒƒçš„ã€‚è¿™æ—¶å€™å°±å¿…é¡»å°å¿ƒå¤„ç†é‚£äº›æ˜¯å®‰å…¨çš„å­—ç¬¦ä¸²ã€é‚£äº›æ˜¯ç”¨æˆ·è¾“å…¥çš„ä¸å®‰å…¨å­—ç¬¦ä¸²ã€‚

# 3-1 ä»€ä¹ˆæ˜¯ CSRF è·¨ç«™è¯·æ±‚ä¼ªé€ ?

è¯·ç”¨ `admin@example.org` å¸å·ç™»å…¥ï¼Œæµè§ˆä»»ä¸€æ´»åŠ¨ï¼š

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/xzif4mY0RHSx4CHkXAHg_3-1.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/xzif4mY0RHSx4CHkXAHg_3-1.png)

ç®¡ç†å‘˜å¯ä»¥ç»™ç•™è¨€ Highlight é«˜äº®ï¼Œè¿™æ ·å°±ä¼šæ˜¾ç¤ºé»„è‰²èƒŒæ™¯ã€‚

éª‡å®¢æ²¡æœ‰åŠæ³•åŠæ³•éª—ç®¡ç†å‘˜å»é«˜äº®ç‰¹å®šæ–‡ç« å‘¢? å¦‚æœè¿˜æœ‰ XSS æ¼æ´çš„è¯ï¼Œå¯ä»¥ç”¨ XSS æ”»å‡»ï¼Œç•™ä¸‹ä¸€æ®µ JavaScript ä»£ç å»è§¦å‘é‚£ä¸ªé«˜äº®æŒ‰é’®ï¼Œåªè¦ç®¡ç†å‘˜é€›åˆ°é‚£ä¸€é¡µï¼Œæ‰§è¡Œåˆ° JavaScript çš„è¯ï¼Œä¹Ÿå¯ä»¥åŠåˆ°è¿™ä»¶äº‹æƒ…ã€‚

ä¸è¿‡ï¼Œä¸Šä¸€èŠ‚æˆ‘ä»¬å·²ç»é˜²å¾¡å¥½ XSSï¼Œè¿™ä¸€èŠ‚æˆ‘ä»¬ç”¨å¦ä¸€æ¡æ”»å‡»æ‰‹æ³•ã€‚è¯·å…ˆè§‚å¯Ÿä½ è¦é«˜äº®é‚£ä¸€ç¯‡ç•™è¨€ï¼š

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/ufxd4fILRnOPoEdRvjon_3-2.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/ufxd4fILRnOPoEdRvjon_3-2.png)

è¿™ä¸€ç¯‡ç•™è¨€çš„IDæ˜¯ 522ï¼Œæ‰€ä»¥è¦éª—ç®¡ç†å‘˜å»é«˜äº®è¿™ç¯‡ç•™è¨€ï¼Œå°±æ˜¯è¦éª—ç®¡ç†å‘˜çš„æµè§ˆå™¨å»æ‰“ `/events/92/comments/522/highlight` å›‰ï¼Œè¿™ä»¶äº‹æƒ…å…¶å®å¾ˆç®€å•ï¼Œéª‡å®¢ç•™è¨€ä¸€ä¸‹ï¼š

```
<img src="/events/92/comments/522/highlight">
```

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/tA2uiHPVR4GsxUU8sbcW_3-3.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/tA2uiHPVR4GsxUU8sbcW_3-3.png)

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/Z9iRHVb0R02iZnVSFpi2_3-4.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/Z9iRHVb0R02iZnVSFpi2_3-4.png)

ä¸Šä¸€èŠ‚é˜²æ­¢ XSS æ—¶ï¼Œæœ‰ç”¨ sanitize æ¥åšç™½åå•çš„è¿‡æ»¤ï¼Œè€Œ `img` æ ‡ç±¤æ˜¯ä¸€ä¸ªç™½åå•æ”¾è¡Œçš„æ ‡ç±¤ï¼Œå› æ­¤è¿™ä¸ªå›¾æ¡£æµè§ˆå™¨ä¼šå‘é€ Request è¯·æ±‚åˆ° `/events/92/comments/522/highlight` å»æŠ“å›¾ã€‚å½“ç„¶ï¼Œæˆ‘ç›®å‰çš„èº«ä»½æ˜¯ `hacker@example.org` æ˜¯æ²¡æœ‰æƒé™é«˜äº®çš„ï¼Œä½†æ˜¯å·²ç»æŒ–äº†ä¸€ä¸ªå‘å‡†å¤‡ç»™ç®¡ç†å‘˜è·³ã€‚

> åœ¨ `app/controllers/comments_controller.rb` ä¸­ï¼Œæˆ‘ä»¬æœ‰ç”¨ `before_action :require_admin!, :only => [:highlight]` æ£€æŸ¥è°ƒç”¨ highlight æ–¹æ³•å¿…é¡»æœ‰ç®¡ç†å‘˜æƒé™ã€‚

æ¥ç€è¯·åˆ‡æ¢åˆ°ç®¡ç†å‘˜ `admin@example.org` èº«ä»½ï¼Œå»æµè§ˆè¿™ä¸€é¡µï¼Œç„¶åé‡æ–°æ•´ç†é¡µé¢ä¸€æ¬¡ï¼š

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/yKUjNFM8SVK4wuRsd4UO_3-5.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/yKUjNFM8SVK4wuRsd4UO_3-5.png)

è¿™ç¯‡æ–‡ç« å°±è¢«é«˜äº®äº†..... ç”¨ç®¡ç†å‘˜çš„æƒé™å»é«˜äº®çš„ã€‚æµè§ˆå™¨çœŸå¥½éª—å•Šã€‚

è¿™ç§æ”»å‡»ï¼Œå°±å«åš[CSRF è·¨ç«™è¯·æ±‚ä¼ªé€ ](https://zh.wikipedia.org/wiki/%E8%B7%A8%E7%AB%99%E8%AF%B7%E6%B1%82%E4%BC%AA%E9%80%A0)ï¼Œéª‡å®¢æŒ–å‘è®©æœ‰æƒé™çš„ç”¨æˆ·å»è·³ã€‚

# 3-2 å¦‚ä½•é˜²å¾¡ï¼Ÿ

é¦–å…ˆï¼Œè¿™ä¸ªé«˜äº®ä¼šè¿™ä¹ˆå¥½è§¦å‘çš„åŸå› ï¼Œåœ¨äºæˆ‘ä»¬æŠŠå®ƒè®¾è®¡æˆ `GET` è¯·æ±‚ï¼Œè¿™æ ·éª‡å®¢ç”¨ `img` æ ‡ç±¤å¤ªå®¹æ˜“å°±èƒ½è¯±éª—æµè§ˆå™¨äº†ã€‚è®©æˆ‘ä»¬æŠŠå®ƒæ”¹æˆ `POST` æ“ä½œã€‚

```
  resources :events do
    resources :comments do
      member do
-       get :highlight
+       post :highlight
      end
    end
  end
```

ä»¥åŠ

app/views/events/show.html.erb

```
-  <%= link_to "Highligh", highlight_event_comment_path(@event, comment), :class => "btn btn-default" %>
+  <%= link_to "Highligh", highlight_event_comment_path(@event, comment), :method => :post, :class => "btn btn-default" %>
```

> åœ¨ Web API è®¾è®¡å®ä½œè¯¾ç¨‹çš„ [3-2 ä»€ä¹ˆæ˜¯ REST API](https://fullstack.xinshengdaxue.com/posts/838) ä¹‹ä¸­ï¼Œä¹Ÿæœ‰è®²è¿°åˆ° GET å’Œ POST çš„å·®å¼‚ï¼šGET åªèƒ½å•çº¯è¯»å–èµ„æ–™ï¼Œä¸åº”è¯¥ä¿®æ”¹èµ„æ–™ã€‚è€Œ POST åˆ™æ˜¯æ‰§è¡ŒæŸä¸ªæ“ä½œï¼Œä¼šä¿®æ”¹åˆ°æœåŠ¡å™¨çš„èµ„æ–™ã€‚

è¿™æ ·çš„è¯ï¼Œç”¨ `img` æ ‡ç±¤å°±ä¸èƒ½æ”»å‡»äº†ï¼Œéª‡å®¢å¿…é¡»ç”¨åˆ° JavaScript æ‰èƒ½è®©ç®¡ç†å‘˜çš„æµè§ˆå™¨å»åš POST è¯·æ±‚ã€‚ä½†æ˜¯è¦ç”¨ JavaScript çš„è¯ï¼Œå°±å¿…é¡»å­˜åœ¨æœ‰ä¸Šä¸€èŠ‚çš„ XSS æ¼æ´æ‰è¡Œäº†ã€‚

# 3-3 æ¼ç½‘ä¹‹é±¼

CSRF ä¹‹æ‰€ä»¥å±é™©çš„åœ°æ–¹ï¼Œåœ¨äºæ”»å‡»æ–¹å¯ä»¥åœ¨å…¶ä»–ç½‘ç«™æŒ–å‘ï¼Œåªè¦ç®¡ç†å‘˜æµè§ˆåˆ°é‚£ä¸€é¡µï¼Œä¸€æ ·å¯ä»¥æ‰§è¡Œè¿™ä¸ªæ”»å‡»ã€‚

æ‰€ä»¥å°±ç®—ä¸Šä¸€èŠ‚æˆ‘ä»¬å·²ç»æ”¹æˆ POST äº†ï¼Œè€Œä¸”è¿™ä¸ªç½‘ç«™ä¹Ÿä¸å­˜åœ¨ XSS æ¼æ´ï¼Œéª‡å®¢ä¾ç„¶æœ‰åŠæ³•å»è¯±ä½¿ç®¡ç†å‘˜çš„æµè§ˆå™¨å» POST æ“ä½œã€‚ä¾‹å¦‚éª‡å®¢çŸ¥é“ç®¡ç†å‘˜å¸¸å»çœ‹ã€Œç™¾åº¦è´´å§ã€ï¼Œç„¶åå‡è®¾ã€Œç™¾åº¦è´´å§ã€æœ‰ä¸ª XSS æ¼æ´å¯ä»¥è´´ JavaScript ä»£ç ï¼Œé‚£ä¹ˆéª‡å®¢å¯ä»¥è´´æ–‡ï¼š

```
<iframe style="display:none" name="csrf-frame"></iframe>

<form method='POST' action='http://localhost:3000/events/92/comments/522/highlight' target="csrf-frame" id="csrf-form">
  <input type='submit' value='submit'>
</form>

<script>document.getElementById("csrf-form").submit()</script>
```

è¿™æ®µ HTML å’Œ JavaScript ä»£ç ä¼šè‡ªåŠ¨ submit åˆ°éšè—çš„ iframe è§†çª—é‡Œé¢ï¼Œæ‰€ä»¥ç®¡ç†å‘˜æ˜¯æ²¡æœ‰æ„Ÿè§‰çš„ã€‚åªè¦ç®¡ç†å‘˜æµè§ˆåˆ°è¿™æ®µè´´æ–‡çš„ç½‘é¡µï¼Œæµè§ˆå™¨å°±ä¼šè‡ªåŠ¨ POST å‡ºå»äº†.... è¾¾æˆé«˜äº®æ•ˆæœã€‚

# 3-4 å¦‚ä½•é˜²å¾¡ POST ç±»å‹çš„ CSRF æ”»å‡»ï¼Ÿ

é‚£è¦å¦‚ä½•é˜²å¾¡å‘¢ï¼Ÿæˆ‘ä»¬éœ€è¦é’ˆå¯¹æ‰€æœ‰é GET çš„æ“ä½œï¼Œéƒ½åŠ ä¸Šé¢å¤–çš„ token éªŒè¯ç å‚æ•°ï¼Œæ£€æŸ¥ç”¨æˆ·æµè§ˆå™¨å½“åˆçœŸçš„æ˜¯ä»ç½‘ç«™ä¸Šçš„æŸä¸ªè¡¨å•é€å‡ºçš„ï¼Œè€Œä¸æ˜¯ä¸å°å¿ƒè§¦å‘çš„ CSRF æ”»å‡»ã€‚

è¿™ä¸ªé˜²å¾¡åŠŸèƒ½ Rails å·²ç»å†…å»ºäº†ï¼Œè¯·ä¿®æ”¹ `app/controllers/application_controller.rb`ï¼Œæ‰“å¼€ `protect_from_forgery`

app/controllers/application_controller.rb

```
  class ApplicationController < ActionController::Base

    # protect_from_forgery with: :exception
+   protect_from_forgery with: :exception
```

åœ¨ Rails äº§ç”Ÿçš„è¡¨å•ä¸­ï¼Œå°±æœ‰å¸¦è¿™ä¸ªå‚æ•° `authenticity_token`

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/CWOAeWOaS4pAEApihUoO_3-6.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/CWOAeWOaS4pAEApihUoO_3-6.png)

å¦‚æœæ˜¯ Ajax è¯·æ±‚ï¼ŒjQuery åˆ™ä¼šå»æŠ“ meta ä¸­çš„ `csrf-token` å‚æ•°é™„åŠ ä¸Šå»ï¼š

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/kK2BE2SMTJ2qI4NiaSSp_3-7.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/kK2BE2SMTJ2qI4NiaSSp_3-7.png)

é€è¿‡è¿™ç§æœºåˆ¶ï¼Œéª‡å®¢åœ¨å…¶ä»–ç½‘ç«™æŒ–çš„å‘å› ä¸ºæ²¡æœ‰è¿™ä¸ª`authenticity_token`å‚æ•°ï¼Œé€è¿‡æ¥çš„æ—¶å€™å°±ä¼šè¢« Rails é˜»æŒ¡ä½ï¼Œä¼šæœ‰ä»¥ä¸‹çš„é”™è¯¯ç”»é¢ï¼š

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/7MnnSijMSdCm8zBg47jj_3-8-422.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/7MnnSijMSdCm8zBg47jj_3-8-422.png)

è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæœ‰æ—¶å€™é€› Rails åˆ¶ä½œçš„ç½‘ç«™ï¼Œè¡¨å•å¦‚æœæ”¾å¤ªä¹…æ‰é€å‡ºï¼Œæœ‰æ—¶å€™ä¹Ÿä¼šå‡ºç°è¿™ä¸ªé”™è¯¯ç”»é¢ï¼Œå› ä¸ºè¿™ä¸ª `authenticity_token` è¿‡æœŸå¤±æ•ˆäº†ã€‚

# 4-1 ä»€ä¹ˆæ˜¯ SQL

åœ¨ Rails ä¸­æˆ‘ä»¬åˆ©ç”¨ ActiveRecord è¯­æ³•æ¥æ“ä½œæ•°æ®åº“çš„èµ„æ–™ï¼Œä¾‹å¦‚æŸ¥è¯¢æ‰€æœ‰æ´»åŠ¨ï¼š

`@events = Event.all`

è¿™æ®µ Ruby ä»£ç ï¼Œå®é™…ä¸Šä¼šè¢«è½¬æˆæ•°æ®åº“è¯­è¨€ [SQL](https://zh.wikipedia.org/zh-cn/SQL) æ¥å¯¹æ•°æ®åº“åšæŸ¥è¯¢ ï¼š

`SELECT "events".* FROM "events"`

åœ¨ Rails log ä¸­ï¼Œåªè¦å¯¹æ•°æ®åº“åšä»»ä½• CRUD æ“ä½œï¼Œéƒ½ä¼šæ˜¯ä¸€ä¸ª SQLï¼Œä¾‹å¦‚è¿™äº›éƒ½æ˜¯ SQL

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/2P3yfiytQS6PMtmaHwdb_4-1.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/2P3yfiytQS6PMtmaHwdb_4-1.png)

> ä¹‹åä¼šæœ‰æ•°æ®åº“è¯¾ç¨‹æ•™å„ä½ç†è§£æ•°æ®åº“åŸç†å’Œ SQLï¼Œç†è§£ SQL å°±å¯ä»¥åšå‡ºæ¯”è¾ƒå¤æ‚çš„æ•°æ®åˆ†æåŠŸèƒ½ï¼Œå¯ä»¥æŠŠ ActiveRecord æ•°æ®æŸ¥è¯¢ç”¨çš„æ›´å¥½ã€‚

# 4-2 ä»€ä¹ˆæ˜¯ SQL Injection æ”»å‡»?

åœ¨å®é™…çš„ç½‘ç«™åº”ç”¨ä¸­ï¼Œæˆ‘ä»¬ä¼šå°†ç”¨æˆ·è¾“å…¥çš„å‚æ•°ï¼ŒåŠ¨æ€åœ°ç»„åˆå‡º SQL æ¥å¯¹æ•°æ®åº“æŸ¥è¯¢ã€‚ä¾‹å¦‚ï¼š

`@registrations = Registration.where( :status => params[:status] )`

å°±ä¼šæ ¹æ®ç”¨æˆ·æµè§ˆå™¨ä¼ è¿‡æ¥çš„ `params[:status]` å‚æ•°ä¸åŒï¼Œè€Œç»„åˆå‡ºä¸åŒçš„ SQL å¥å­ã€‚å‡å¦‚å‚æ•° `params[:status]` æ˜¯ `pending`ï¼Œé‚£è¿™ä¸ª SQL å¥å°±ä¼šæ˜¯ï¼š

`SELECT "registrations".* FROM "registrations" WHERE "registrations"."status" = 'pending'`

### å®é™…æ”»å‡»ç¤ºèŒƒ

åœ¨æœ¬è¯¾ç¨‹çš„èŒƒä¾‹ä¸­ï¼Œæœ‰ä¸€ä¸ªåŠŸèƒ½æ˜¯å…³é”®å­—æŸ¥è¯¢ç•™è¨€ï¼Œè¯·æµè§ˆè‡³ä»»ä¸€ä¸ªæ´»åŠ¨é¡µé¢ï¼š

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/2yEqOPZRuKISZQSStiOz_4-2.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/2yEqOPZRuKISZQSStiOz_4-2.png)

æŒ‰ä¸‹ Search æŒ‰é’®åï¼Œå¯¹åº”çš„å¤„ç†ä»£ç åœ¨ `app/controllers/events_controller.rb` ä¸­çš„ show action:

app/controllers/events_controller.rb

```
 @comments = @comments.where( "comments.content LIKE '%#{params[:keyword]}%'")
```

è¿™æ®µ ActiveRecord è¯­æ³•ä¼šè¢«è½¬æˆå¦‚ä»¥ä¸‹çš„ SQL å¥ï¼š

```
SELECT "comments".* FROM "comments" WHERE "comments"."event_id" = ? AND (comments.content LIKE '%è¿™æ˜¯æœå¯»å…³é”®å­—%')  [["event_id", 95]]
```

å¾ˆä¸å¹¸çš„ï¼Œè¿™ç§å†™æ³•å­˜åœ¨ SQL Injection æ¼æ´ï¼Œç”¨ä»¥ä¸‹çš„å…³é”®å­—å°±å¯ä»¥è¿›è¡Œæ”»å‡»ï¼Œåˆ é™¤æ‰€æœ‰ç•™è¨€æ•°æ®ï¼š

```
sorry'); DELETE * FROM comments; --
```

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/9rU0g4kwRuOkcbxbQdnE_4-3.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/9rU0g4kwRuOkcbxbQdnE_4-3.png)

æŒ‰ä¸‹ Search æŒ‰é’®åï¼Œæ‚²æƒ¨çš„äº‹æƒ…å°±å‘ç”Ÿäº†ï¼Œæ‰€æœ‰ç•™è¨€éƒ½è¢«åˆ é™¤äº† ğŸ˜³ğŸ˜³ğŸ˜³ğŸ˜³ğŸ˜³

è¿™æ˜¯æ€ä¹ˆåŠåˆ°çš„ï¼Ÿæˆ‘ä»¬æŠŠæ”»å‡»çš„å…³é”®å­—ä»£å…¥ SQL å¥å­ï¼Œå°±ä¼šå˜æˆï¼š

`SELECT "comments".* FROM "comments" WHERE "comments"."event_id" = ? AND (comments.content LIKE '%sorry'); DELETE * FROM comments; --%') [["event_id", 95]]`

è¿™ä¼šè¢«æ•°æ®åº“è§£è¯»æˆä¸‰ä¸ª SQL å¥å­ï¼š

1. `SELECT "comments".* FROM "comments" WHERE "comments"."event_id" = ? AND (comments.content LIKE '%sorry');`
2. `DELETE * FROM comments;`
3. `--%') [["event_id", 95]]`

å…¶ä¸­ç¬¬äºŒå¥å°±è¾¾æˆåˆ é™¤çš„æ•ˆæœï¼Œç¬¬ä¸‰å¥çš„ `--` æ˜¯ SQL çš„æ³¨è§£ã€‚

ç”±æ­¤å¯çŸ¥ï¼ŒSQL Injection æ•°æ®åº“æ³¨å…¥æ”»å‡»å¯ä»¥ç ´åæˆ‘ä»¬çš„æ•°æ®åº“ã€ä¿®æ”¹æ•°æ®èµ„æ–™ã€è·³è¿‡ç™»å…¥å¯†ç æ£€æŸ¥ç­‰ç­‰ï¼Œæ˜¯éå¸¸æœ‰ç ´ååŠ›çš„æ”»å‡»è¡Œä¸ºã€‚

# 4-3 å¦‚ä½•é˜²å¾¡ SQL æ³¨å…¥æ”»å‡» ï¼Ÿ

è·Ÿé˜²å¾¡ XSS ä¸€æ ·çš„é“ç†ï¼Œæ‰€æœ‰ç”¨æˆ·ä¼ è¿›æ¥è¦ä»£å…¥ SQL çš„å‚æ•°ï¼Œéƒ½å¿…é¡»åŠ ä»¥é€¸å‡ºï¼š

app/controllers/events_controller.rb

```
-  @comments = @comments.where( "comments.content LIKE '%#{params[:keyword]}%'")

+  keyword = ActiveRecord::Base::connection.quote_string( params[:keyword] )
+  @comments = @comments.where( "comments.content LIKE '%#{keyword}%'")
```

ä¸è¿‡ä»£å…¥ç”¨æˆ·å‚æ•°çš„æƒ…æ™¯å®åœ¨å¤ªå¸¸è§äº†ï¼Œåœ¨ Rails ä¼šé€šå¸¸ä¼šç”¨ç‰¹åˆ«çš„å†™æ³•æ¥æŒ‡å®š SQL æ¡ä»¶ï¼Œè®© Rails èƒ½å¤ŸçŸ¥é“å“ªä¸€éƒ¨åˆ†éœ€è¦é€¸å‡ºï¼š

app/controllers/events_controller.rb

```
-  @comments = @comments.where( "comments.content LIKE '%#{params[:keyword]}%'")
+  @comments = @comments.where( "comments.content LIKE ?", "%#{params[:keyword]}%")
```

å…¶ä¸­ `?` ä»£è¡¨è¦ä»£å…¥çš„å‚æ•°ã€‚

æœ€åçš„ SQL å¥å­å˜æˆï¼š

```
SELECT "comments".* FROM "comments" WHERE "comments"."event_id" = ? AND (comments.content LIKE '%sorry''); DELETE * FROM comments; --%')  [["event_id", 95]]
```

å…¶ä¸­ `sorry')` å˜æˆ `sorry'')` äº†ï¼Œè¿™æ ·æ•°æ®åº“å°±çŸ¥é“è¿™æ­¤å•å¼•å·ä¸æ˜¯ç»“æŸçš„å•å¼•å·ã€‚

> ä½ å¯ä»¥å†æµ‹è¯•çœ‹çœ‹è¿˜ä¼šä¸ä¼šæœ‰è¿™ä¸ªæ¼æ´ï¼Œé€å‡ºåä¼šå…ˆçœ‹åˆ°æ²¡æœ‰ä»»ä½•èµ„æ–™æ˜¯æ­£å¸¸çš„ï¼Œå› ä¸ºæŸ¥ä¸åˆ°ä»»ä½•ç•™è¨€æ˜¯ç¬¦åˆå…³é”®å­—ã€‚è¯·å›é¦–é¡µå†è¿›æ¥ï¼Œç•™è¨€è¿˜æ˜¯æ­£å¸¸æ²¡æœ‰è¢«åˆ é™¤æ‰ã€‚

å¦ä¸€ç§å¸¸è§çš„å†™æ³•æ˜¯ç”¨ Hashï¼Œä¾‹å¦‚

```
@registrations = Registraion.where( "status = '#{params[:status]}' ) # è‡ªå·±ç»„å­—ç¬¦ä¸²ï¼Œè¿™ä¸å®‰å…¨ï¼Œæœ‰ SQL æ³¨å…¥æ¼æ´

@registrations = Registraion.where( :status => params[:status] ) # Hash å†™æ³•ï¼Œè¿™æ˜¯å®‰å…¨çš„
@registrations = Registraion.where( "status = ?", params[:status] ) # Array å†™æ³•ï¼Œè¿™æ˜¯å®‰å…¨çš„

```

# 4-4 æ¼ç½‘ä¹‹é±¼

ä¸Šä¸€èŠ‚ä¸­æˆ‘ä»¬ç¤ºèŒƒäº†åœ¨ `where` è¯­æ³•ä¸­ï¼Œç”¨ Hash æˆ– Array å†™æ³•å¯ä»¥è‡ªåŠ¨åšé€¸å‡ºã€‚ä½†æ˜¯åœ¨ ActiveReocrd ä¸­ï¼Œè¿˜æœ‰ä¸€äº›æ–¹æ³•å¹¶æ²¡æœ‰å¸®æˆ‘ä»¬åšé€¸å‡ºï¼ŒåŒ…æ‹¬ `order`ã€`pluck` ç­‰ç­‰ï¼Œè¯¦è§ [Rails SQL Injection](https://rails-sqli.org/)ã€‚

æ‰€ä»¥å½“æˆ‘ä»¬éœ€è¦å°†ç”¨æˆ·ä¼ è¿‡æ¥çš„å‚æ•°ä¼ è¿›å»æ—¶ï¼Œé™¤äº†é€¸å‡ºä¹‹å¤–ï¼Œä¹Ÿå¯ä»¥é‡‡ç”¨ç™½åå•çš„è¿‡æ»¤æ–¹å¼ã€‚

åœ¨èŒƒä¾‹ä¸­ï¼Œå¯ä»¥æ ¹æ®ç”¨æˆ·æŒ‡å®šçš„é¡ºåºæ¥åšæ’åºï¼š

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/wmMSHd62RnQnxiWbhfKV_4-4.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/wmMSHd62RnQnxiWbhfKV_4-4.png)

ç”¨æˆ·å¯ä»¥ç‚¹ä¸åŒè¿ç»“æ¥è¿›è¡Œæ’åºï¼Œä¼šä¼ ä¸åŒ `sort` å‚æ•°ã€‚ç”¨æˆ·ä¼ è¿‡æ¥çš„å‚æ•°éƒ½æ˜¯ä¸å¯ä»¥ä¿¡ä»»çš„ï¼Œç”¨æˆ·å¤§å¯ä»¥ç›´æ¥ä¿®æ”¹ç½‘å€å°±å¯ä»¥ä¼ ä»»æ„å‚æ•°è¿›æ¥ ğŸ™€ğŸ™€ğŸ™€

è¯·ä¿®æ”¹ `app/controllers/events_controller.rb`ï¼Œæˆ‘ä»¬åªèƒ½å…è®¸ç‰¹å®šçš„æŸ¥è¯¢å‚æ•°ï¼š

app/controllers/events_controller.rb

```
-  if params[:sort] # æœ¬æ¥è¿™æ ·æœ‰æ¼æ´ï¼Œä½ å¤ªç›¸ä¿¡ç”¨æˆ·ä¼ è¿›æ¥çš„å‚æ•°äº†
+  if params[:sort] && ["id DESC", "id ASC"].include?(params[:sort])  # åªæœ‰ç™½åå•å†…çš„å‚æ•°å¯ä»¥ç”¨
    @comments = @comments.order(params[:sort])
  end
```

# 5-1 ActiveRecord èµ‹å€¼åŠŸèƒ½

å¤§é‡èµ‹å€¼(Mass Assignment)æ˜¯ ActiveRecord çš„ä¸€ä¸ªåŠŸèƒ½ï¼Œä¾‹å¦‚ä»¥ä¸‹æ˜¯æ–°å»º Event çš„ä»£ç ï¼š

```
event = Event.new
event.name = "Foo"
event.description = "Bar"
event.save
```

è¿™ä¸ª `new` å¯ä»¥æ¥å— Hash æ¥åšèµ‹å€¼ï¼Œä¸Šè¿°çš„ä»£ç ç­‰åŒäºï¼š

```
Event.new( { :name => "Foo", :description => "Bar" } )
```

å¦å¤–ï¼Œæ”¾åœ¨æ–¹æ³•å‚æ•°æœ€åé¢çš„ Hashï¼Œå®ƒçš„ `{ }` æ˜¯å¯ä»¥çœç•¥çš„ï¼Œå› æ­¤è¿™åˆç­‰åŒäºï¼š

```
Event.new( :name => "Foo", :description => "Bar" )
```

è¿™ç§ç”¨æ³•å°±å«åšå¤§é‡èµ‹å€¼(Mass Assignment)ã€‚é™¤äº† `new` ä¹‹å¤–ï¼Œ`update` ä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œè¿™ä¸ªæˆ‘ä»¬åœ¨åš CRUD æ—¶å°±æœ‰çœ‹è¿‡ï¼Œä¾‹å¦‚ï¼š

```
event = Event.first
event.name = "Foo"
event.description = "Bar"
event.save
```

ç­‰åŒäº

```
event = Event.first
event.update( :name => "Foo", :description => "Bar" )
```

# 5-2 å¤§é‡èµ‹å€¼ä¸ Rails è¡¨å•

è¿™ä¸ªåŠŸèƒ½çš„ä¸»ç”¨ç”¨é€”æ˜¯å¯ä»¥è·Ÿ Rails `form_for` æ–¹æ³•äº§ç”Ÿçš„è¡¨å•åšé…å¥—ï¼Œåœ¨ä»¥ä¸‹çš„ Event è¡¨å•ä¸­ï¼ŒRails æ•…æ„å°† HTML è¾“å…¥æ¡† input çš„ `name` å‘½åæˆ `event[name]` å’Œ `event[description]`

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/gNJTNOwpQUKrR6pgsccI_5-1.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/gNJTNOwpQUKrR6pgsccI_5-1.png)

è¿™æ ·é€å‡ºåï¼ŒRails ä¼šè§£ææˆ `params[:event]` åˆšå¥½æ˜¯ä¸€ä¸ª Hashï¼Œå¯ä»¥è·Ÿå¤§é‡èµ‹å€¼ç”¨æ³•é…å¥—åœ¨ä¸€èµ·ï¼š

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/MlJegER3y7OdbjesqaSg_5-2.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/MlJegER3y7OdbjesqaSg_5-2.png)

åœ¨æ—©å…ˆçš„ Rails ç‰ˆæœ¬ä¸­ï¼Œå¯ä»¥ç›´æ¥æŠŠ `params[:event]` ä¸¢è¿› `new`æˆ– `update` ä¸­ï¼Œä¾‹å¦‚ï¼š

`Event.new(params[:event])`

`@event.update( params[:event] )`

ä¸è¿‡è¿™æ ·å´å­˜åœ¨ä¸€ä¸ªå¤§æ¼æ´ï¼Œç”¨æˆ·å¯ä»¥è‡ªè¡Œä¿®æ”¹è¡¨å• input çš„ nameã€‚è¿™å¾ˆç®€å•ä½ ç”¨ Chrome é™¤é”™å™¨å°±å¯ä»¥åŠåˆ°äº†ï¼Œç‚¹è¯¥ input çš„ name å°±å¯ä»¥æ”¹ï¼š

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/r79h5T4SQ15rSZpoaU7M_5-3.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/r79h5T4SQ15rSZpoaU7M_5-3.png)

è¿™é‡Œæ”¹æˆ `event[user_id]`ï¼Œé€å‡ºä¹‹åå¦‚æœç›´æ¥è°ƒç”¨`@event.update( params[:event] )`çš„è¯ï¼Œé‚£å°±ä¿®æ”¹åˆ° `user_id` äº† ğŸ™€ğŸ™€ğŸ™€

å› æ­¤åœ¨æ–°ç‰ˆçš„ Rails ä¸­ï¼Œå¿…é¡»ç»è¿‡ [Strong Parameters](https://github.com/rails/strong_parameters) è¿‡æ»¤åï¼Œæ‰èƒ½ä¼ è¿› `new` æˆ– `update` ä¹‹ä¸­ï¼Œä»¥ä¸‹è¿™æ®µä»£ç å¤§å®¶éƒ½ç†Ÿæ‚‰ï¼š

```
  def update
    @event = Event.find(params[:id])

    if @event.update(event_params)
      redirect_to admin_events_path
    else
      render "edit"
    end
  end

  protected

  def event_params
    params.require(:event).permit(:name, :description)
  end
```

å…¶ä¸­ `params.require(:event).permit(:name, :description)` å°±æ˜¯åœ¨åšç™½åå•çš„æ£€æŸ¥ï¼Œåªèƒ½å…è®¸ `params[:event][:name]` å’Œ `params[:event][:description]`

# 5-3 æ”»å‡»ç¤ºèŒƒ

ä¸è¿‡å³ä½¿æœ‰ [Strong Parameters](https://github.com/rails/strong_parameters) çš„ä¿æŠ¤ï¼Œè¿˜æ˜¯å¯èƒ½å› ä¸ºç¨‹åºå‘˜æ¼«ä¸ç»å¿ƒè€Œå­˜åœ¨æ¼æ´ã€‚è®©æˆ‘ä»¬æ¥æ”»å‡»çœ‹çœ‹ã€‚

è¯·ç‚¹é€‰ä¸»é€‰å•ä¸Šçš„ä¿®æ”¹ä¸ªäººèµ„æ–™ï¼Œä¸è¿‡æˆ‘ä»¬ä¸æ˜¯æƒ³è¦ä¿®æ”¹æš±ç§°ï¼Œæˆ‘ä»¬æƒ³è¦æ¥ä¿®æ”¹ Role è§’è‰²....

1. é€è¿‡ Chrome é™¤é”™å™¨å°†æš±ç§° input çš„ name ä¸º `user[role]`
2. è¾“å…¥æ¡†è¾“å…¥ `admin`
3. æŒ‰ä¸‹é€å‡º

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/ilSd1SFgTTO7pN4W2TvE_5-4.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/ilSd1SFgTTO7pN4W2TvE_5-4.png)

ç„¶å hacker å°±å˜æˆ admin äº†ï¼Œä½ ç°åœ¨å¯ä»¥åœ¨ä¸»é€‰å•ä¸Šç‚¹è¿›åå°.... ğŸ™€ğŸ™€ğŸ™€ğŸ™€ğŸ™€

# 5-4 ä¿®è¡¥æ¼æ´

è®©æˆ‘ä»¬çœ‹çœ‹åˆ°åº•å“ªé‡Œå‡ºäº†æ¼æ´ï¼Œè¯·æ‰“å¼€ `app/controllers/users_controller.rb`ï¼Œé—®é¢˜å‡ºåœ¨ `params.require(:user).permit(:nickname, :role)` è¿™ä¸€è¡Œå¤ªè¿‡æ”¾çºµäº†ï¼Œç«Ÿç„¶å…è®¸ç”¨æˆ·å¯ä»¥ä¼ å‚æ•° `role` è¿›æ¥... :(

è™½ç„¶åœ¨ç½‘é¡µè¡¨å•ä¸Šé¢æ²¡æœ‰ `role` è¾“å…¥æ¡†ï¼Œä½†æ˜¯ç”¨æˆ·ä¾ç„¶å¯ä»¥è‡ªå·±æƒ³åŠæ³•æŠŠå‚æ•°ä¼ è¿›æ¥ã€‚

è®©æˆ‘ä»¬ä¿®è¡¥è¿™ä¸ªæ¼æ´ï¼š

app/controllers/users_controller.rb

```
  def update
    @user = current_user

    if @user.update(user_params)
      redirect_to user_path(@user)
    else
      render "edit"
    end
  end

  protected

  def user_params
-    params.require(:user).permit(:nickname, :role)
+    params.require(:user).permit(:nickname)
  end
```

å†æµ‹è¯•ä¸€æ¬¡ï¼Œéª‡å®¢å°±ä¸èƒ½ä¿®æ”¹ role äº†ã€‚åœ¨ Rails log ä¹‹ä¸­ï¼Œä¼šå‡ºç°

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/7tNCd9v4ReeoZ4mAaoiq_5-5.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/7tNCd9v4ReeoZ4mAaoiq_5-5.png)

`Unpermitted parameter: role` çš„æ„æ€å°±æ˜¯ç”¨æˆ·ä¼ äº†ä¸€ä¸ª `role`å‚æ•°è¿›æ¥è¢«è¿‡æ»¤æ‰äº†ã€‚

ä»è¿™ä¸ªæ¼æ´æˆ‘ä»¬ä¹Ÿå¯ä»¥äº†è§£ä¸ºä»€ä¹ˆå‰å°ã€åå°çš„ controller ä¼šæ‹†å¼€çš„ä¸€ä¸ªåŸå› ï¼Œå°±æ˜¯å‰åå°çš„ Strong Parameters å‚æ•°ç™½åå•æ˜¯ä¸ä¸€æ ·çš„ã€‚ç»™å‰å°ç”¨æˆ·çš„ `users_controller` ä¸å…è®¸ä¿®æ”¹ roleï¼Œä½†æ˜¯åå° `admin::users_controller` æ˜¯å¯ä»¥å…è®¸ä¿®æ”¹ role çš„ã€‚å¦‚æ­¤æ‹†åˆ†æ‰ä¼šæ¸…æ¥šä¸ä¼šææ··é€ æˆæ¼æ´ã€‚

# 6-1 ä»€ä¹ˆæ˜¯åŠ å¯† Cookie

[Cookie](https://zh.wikipedia.org/zh-cn/Cookie) æ˜¯æµè§ˆå™¨çš„ä¸€ä¸ªåŠŸèƒ½ï¼Œè®©æœåŠ¡å™¨å¯ä»¥ç•™æ•°æ®åœ¨ç”¨æˆ·æµè§ˆå™¨ä¸Šï¼Œè¿™æ · Rails å°±å¯ä»¥è¿½è¸ªè¯†åˆ«ä¸åŒç™»å…¥ç”¨æˆ·ã€‚æµè§ˆå™¨æ¯æ¬¡å¯¹æœåŠ¡å™¨çš„è¯·æ±‚ï¼Œéƒ½ä¼šé™„å¸¦è¿™ä¸ª Cookie æ•°æ®ã€‚

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/8Q50gisARByEBfKgIE2u_6-1.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/8Q50gisARByEBfKgIE2u_6-1.png)

ä¾‹å¦‚ç”¨æˆ·ç™»å…¥æ—¶ï¼Œè¾“å…¥å¸å·ã€å¯†ç ï¼ŒæœåŠ¡å™¨æ£€æŸ¥æ²¡é—®é¢˜åï¼Œå°±ä¼šè®¾å®šè¯¥æµè§ˆå™¨çš„ä¸€ä¸ª Cookie æ˜¯ user_id æ˜¯ 123
æ¥ä¸‹æ¥ç”¨æˆ·æµè§ˆå™¨å¯¹è¿™ä¸ªç½‘ç«™çš„ä»»ä½•è¯·æ±‚ï¼Œå°±ä¼šé™„å¸¦è¿™ä¸ª Cookie å‚æ•°ï¼Œé‚£ä¹ˆæœåŠ¡å™¨å°±çŸ¥é“è¿™ä¸ªæµè§ˆå™¨æ˜¯ç”¨æˆ· 123

ä¸è¿‡ï¼Œè¿™æ˜¯ç®€åŒ–çš„ç‰ˆæœ¬ï¼Œç›¸ä¿¡å¤§å®¶éƒ½çŸ¥é“ç”¨æˆ·æ˜¯ä¸å¯ä»¥ç›¸ä¿¡çš„ï¼Œå­˜åœ¨ç”¨æˆ·ç«¯çš„ Cookie ä¹Ÿæ˜¯ä¸å¯ä»¥ç›¸ä¿¡çš„ï¼Œéª‡å®¢å¯ä»¥ä¿®æ”¹ user_id å˜æˆ 1ï¼Œé‚£ä¸å°±å˜èº«ä¸ºç®¡ç†å‘˜äº†å—?

å› æ­¤æˆ‘ä»¬éœ€è¦é’ˆå¯¹ Cookie åšåŠ å¯†ï¼Œç”¨ä¸€ç§å«åš[å¯¹ç§°å¯†é’¥åŠ å¯†](https://zh.wikipedia.org/wiki/%E5%B0%8D%E7%A8%B1%E5%AF%86%E9%91%B0%E5%8A%A0%E5%AF%86)çš„ç®—æ³•ï¼Œç”¨ä¸€æŠŠå¯†é’¥æ¥åšåŠ å¯†ï¼Œå¹¶ä¸”ç”¨è¿™ä¸ªå¯†é’¥å¯ä»¥è§£å¯†å›æ¥ã€‚

ä¾‹å¦‚ï¼Œä»¥ä¸‹æ˜¯ä¸€æ®µç”¨ [DES](https://zh.wikipedia.org/wiki/%E8%B3%87%E6%96%99%E5%8A%A0%E5%AF%86%E6%A8%99%E6%BA%96) ç®—æ³•åŠ å¯†çš„ Ruby ä»£ç ï¼Œå°† `{message: "è¿™æ˜¯å¯†æ–‡"}` è¿›è¡ŒåŠ å¯†ï¼Œä½ å¯ä»¥è¿› `irb` å®éªŒçœ‹çœ‹ï¼š

```
key = 'baRudSWouiTVfu0jwXfYDg==' # ä¸€æ®µéšæœºæ•°æ˜¯å¯†é’¥


# åŠ å¯†

require 'json'
require 'base64'
require 'openssl'
text = {message: "è¿™æ˜¯å¯†æ–‡"}.to_json
cipher = OpenSSL::Cipher::DES.new("ECB")
cipher.encrypt
cipher.key = Base64.strict_decode64(key)
encrypted = cipher.update(text) + cipher.final
data = Base64.strict_encode64(encrypted)
```

æœ€åå¾—åˆ°çš„ data æ˜¯ `"pxsTws7UtD7bOwCl6+FeLQEBJWqNTb3RSo2V84/udL0="` å°±æ˜¯ä¸€æ®µåŠ å¯†åçš„æ–‡å­—ã€‚

ä»¥ä¸‹æ˜¯è§£å¯†çš„ä»£ç ï¼š

```
key = 'baRudSWouiTVfu0jwXfYDg==' # è¦åŒä¸€æŠŠå¯†é’¥æ‰èƒ½è§£å¼€


require 'json'
require 'base64'
require 'openssl'

encrypted_string = Base64.decode64(data)
cipher = OpenSSL::Cipher::DES.new("ECB")
cipher.decrypt
cipher.key = Base64.strict_decode64(key)
result = cipher.update(encrypted_string) + cipher.final
JSON.parse(result)
```

æœ€åå°±è§£å› `{message: "è¿™æ˜¯å¯†æ–‡"}` äº†ã€‚

åœ¨ä¸çŸ¥é“å¯†é’¥çš„æƒ…å†µä¸‹ï¼Œè¦ç ´è§£å›æœ¬æ¥çš„ç§˜æ–‡æ˜¯éå¸¸å›°éš¾çš„ï¼Œéœ€è¦è€—è´¹éå¸¸å¼ºå¤§çš„è¶…çº§ç”µè„‘ CPU è¿ç®—èµ„æºæ‰èƒ½ç ´è§£ã€‚

# 6-2 Rails çš„ secret key

åœ¨ Rails ä¸­ï¼Œé»˜è®¤çš„ Session å®é™…ä¸Šå°±æ˜¯åŠ å¯†çš„ Cookieï¼Œæˆ‘ä»¬åœ¨è´­ç‰©è½¦æ•™ç¨‹ä¸­ï¼Œä½¿ç”¨äº† `session[:cart_id]` æ¥å‚¨å­˜è¿½è¸ªç”¨æˆ·æ˜¯å“ªä¸€å°è´­ç‰©è½¦ã€‚

åˆšåˆšæˆ‘ä»¬å­¦åˆ°è¦èƒ½è§£å¯†çš„å…³é”®æ˜¯é‚£ä¸ªå¯†é’¥ï¼Œè€Œåœ¨ Rails ä¸­ï¼Œè¿™ä¸€æŠŠå¯†é’¥å°±å­˜åœ¨ `config/secrets.yml`

```
development:

  secret_key_base: a875bedfd1ba629c6c6039597cfd89a5bfb34fc440a0203d649bbd9e06de3e1939a4a586e1ed893108157688782b86b25223853a5b140aba7a21e5df675bed22


test:

  secret_key_base: 162ffbf8a8079326e46d6f6cf946de5c67a5c2372120a642b10c6d14b413f78fda09870a0697315ac067cf6bb6924b7ae16841894f3919ef09de65238d85f712


# Do not keep production secrets in the repository,

# instead read values from the environment.

production:

  secret_key_base: <%= ENV["SECRET_KEY_BASE"] %>
```

è¿™ä¸ª YAML è¿˜æ ¹æ®ä¸åŒç¯å¢ƒåŒºåˆ†ï¼Œæœ¬æœºå¼€å‘ç”¨çš„å¯†é’¥ï¼Œå’Œéƒ¨ç½² production ç¯å¢ƒç”¨çš„å¯†é’¥æ˜¯ä¸åŒçš„ã€‚

è¿™æŠŠå¯†é’¥éå¸¸é‡è¦ï¼Œä¸èƒ½å¤–æ´©ã€‚çŸ¥é“å¯†é’¥çš„è¯ï¼Œç”¨æˆ·å°±å¯ä»¥è§£å¼€ Cookieï¼Œå·çœ‹é‡Œé¢çš„å†…å®¹ï¼Œç”šè‡³ä¿®æ”¹å­˜å›å»ï¼Œè¿™æ ·æœåŠ¡å™¨å°±ä¼šè¢«éª—è¿‡å»....

è®©æˆ‘ä»¬çœ‹çœ‹å¦‚æœå¤–æ´©ä¼šæ€ä¹ˆæ ·ï¼Œä¾‹å¦‚ä½ æŠŠ production æ­£å¼ç¯å¢ƒçš„å¯†é’¥ push åˆ° github å…¬å¼€çš„é¡¹ç›®....

# 6-3 ç ´è§£ç¤ºèŒƒ

å¥½ï¼Œï¼Œå‡è®¾æˆ‘ä»¬å·²ç»çŸ¥é“å¯†é’¥æ˜¯ `a875bedfd1ba629c6c6039597cfd89a5bfb34fc440a0203d649bbd9e06de3e1939a4a586e1ed893108157688782b86b25223853a5b140aba7a21e5df675bed22`

æ¥ç€æ‰“å¼€ Chrome é™¤é”™å™¨ï¼Œå¤åˆ¶ä¸‹ `_hackme-app_session` è¿™æ®µ Cookie çš„å€¼ï¼Œä¾‹å¦‚ï¼š

```
V0JxRVF2UjQ4ZUx5M0tYMFgxN3ZIK092Yy9aY1RSNGJFZ3FIdDgvbUdOZjJxd0tJWHMyRk12bjRpRmMyRm85Qko1bXAwSThHZVA1TnhhZHhNb0hNL3FJQ0c3cVpGVUJ0VVY3N28zU3l6bkRCQkJXdGQ0LzRqR2tCeVVMSzNYbWtIRm1ycEhIejN2L1FmUTFIMktvNGpmWk8yOHFyQXUxZXlBMXd2SHlkV29RaENUdWwxSWsxdlBHVHF2Q0hTYXFoc0RydUd4MXJJMzQ5dm5ZUS9vYURnaWdubnduc1cwK3ExZldpMFVRSmZkUXZRa0FvR3FqQVplZEordE10MzVqTS0tSUs4NCtsZjNRZGRDMjM1ajVzQkRHQT09--f99ee52c228793955481cf56604ca293c96989a4
```

è¿› `rails console` è´´ä¸Šï¼š

```
def decrypt_session_cookie(cookie, key)
  cookie = CGI::unescape(cookie)
  salt         = "encrypted cookie"
  signed_salt  = "signed encrypted cookie"

  key_generator = ActiveSupport::KeyGenerator.new(key, iterations: 1000)
  secret = key_generator.generate_key(salt)
  sign_secret = key_generator.generate_key(signed_salt)

  encryptor = ActiveSupport::MessageEncryptor.new(secret, sign_secret, serializer: ActiveSupport::MessageEncryptor::NullSerializer)
  encryptor.decrypt_and_verify(cookie)
end

key = 'a875bedfd1ba629c6c6039597cfd89a5bfb34fc440a0203d649bbd9e06de3e1939a4a586e1ed893108157688782b86b25223853a5b140aba7a21e5df675bed22'
cookie = 'V0JxRVF2UjQ4ZUx5M0tYMFgxN3ZIK092Yy9aY1RSNGJFZ3FIdDgvbUdOZjJxd0tJWHMyRk12bjRpRmMyRm85Qko1bXAwSThHZVA1TnhhZHhNb0hNL3FJQ0c3cVpGVUJ0VVY3N28zU3l6bkRCQkJXdGQ0LzRqR2tCeVVMSzNYbWtIRm1ycEhIejN2L1FmUTFIMktvNGpmWk8yOHFyQXUxZXlBMXd2SHlkV29RaENUdWwxSWsxdlBHVHF2Q0hTYXFoc0RydUd4MXJJMzQ5dm5ZUS9vYURnaWdubnduc1cwK3ExZldpMFVRSmZkUXZRa0FvR3FqQVplZEordE10MzVqTS0tSUs4NCtsZjNRZGRDMjM1ajVzQkRHQT09--f99ee52c228793955481cf56604ca293c96989a4'

j = decrypt_session_cookie(cookie, key)
```

å°±ä¼šè§£å¯†å‡ºä¸€æ®µ JSON å‘Šè¯‰æˆ‘ä»¬ç”¨æˆ· id æ˜¯ 48ï¼Œè´­ç‰©è½¦ `cart_id` æ˜¯ 501ã€‚

```
"{\"session_id\":\"744813165ee90c30650c4ab8338d8140\",\"cart_id\":501,\"warden.user.user.key\":[[48],\"$2a$11$tpfEqlcCqD/8JRWPtvZTzu\"],\"_csrf_token\":\"zMPrCyTnxvpsPY0OWhPi8sM2suOa3dUFk4HHDyedbIs=\"}"
```

ä»¥ä¸‹ä»£ç ä¼šä¿®æ”¹ cart_id å¹¶å¯ä»¥åŠ å¯†å›å»ï¼š

```
def encrypt_session_cookie(value, key)
  salt         = "encrypted cookie"
  signed_salt  = "signed encrypted cookie"

  key_generator = ActiveSupport::KeyGenerator.new(key, iterations: 1000)
  secret = key_generator.generate_key(salt)
  sign_secret = key_generator.generate_key(signed_salt)

  encryptor = ActiveSupport::MessageEncryptor.new(secret, sign_secret, serializer: ActionDispatch::Cookies::JsonSerializer)
  encryptor.encrypt_and_sign(value)
end

h = JSON.parse(j)
h["cart_id"] = 1
encrypt_session_cookie(h, key)
```

> åŠ è§£å¯†çš„ä»£ç æ˜¯ä» Rails æºä»£ç ä¸­æŒ–å‡ºæ¥çš„

æœ€åå¾—åˆ° cookie å€¼ï¼Œæœ€åä¸€æ­¥å°±æ˜¯è®¾å®šå› Chrome æµè§ˆå™¨ã€‚ä¸è¿‡ Chrome é»˜è®¤ä¸å…è®¸æˆ‘ä»¬æ”¹ Cookieï¼Œä½ å¯ä»¥è£…ä¸€ä¸ª extension æ˜¯ [Cookie Inspector](https://chrome.google.com/webstore/detail/cookie-inspector/jgbbilmfbammlbbhmmgaagdkbkepnijn)ï¼Œç„¶åæŠŠåˆšåˆšæ”¹è¿‡çš„ cookie å€¼è®¾è¿›å»ï¼Œè¿™æ ·å°±ä¼šéª—è¿‡æœåŠ¡å™¨äº†ã€‚

# 6-4 å¦‚ä½•é˜²å¾¡?

æœ€åŸºæœ¬çš„å½“ç„¶æ˜¯ä¸è¦å¤–æ´©å¯†é’¥ï¼Œå¦‚æœå¤–æ´©äº†ï¼Œè¯·é©¬ä¸Šæ¢ä¸€ä¸ªå¯†é’¥ã€‚æ¢å¯†é’¥ä¼šå¼ºè¿«æ‰€æœ‰ç”¨æˆ·ç™»å‡ºï¼Œå› ä¸ºå¤§å®¶çš„ Cookie éƒ½ä¼šå› ä¸ºæ— æ³•è§£å¯†å›æ¥è€Œå¤±æ•ˆã€‚

å¦‚æœä½ çš„ç½‘ç«™éœ€è¦éå¸¸é«˜çš„å®‰å…¨æ€§ï¼Œåˆ™ä¸å»ºè®®ä½¿ç”¨ Cookie åŠ å¯†æ¥åš Sessionã€‚åœ¨ Rails å¯ä»¥æ›´æ¢ Session å­˜å‚¨çš„æ–¹å¼ï¼Œä¾‹å¦‚æ¢æˆ [Active Record's Session Store](https://github.com/rails/activerecord-session_store)ã€‚è¿™ä¼šå°† Session æ•°æ®å­˜åœ¨æ•°æ®åº“ä¸­ï¼Œè€Œä¸æ˜¯ Cookie ä¹‹ä¸­ï¼Œè¿™æ ·éª‡å®¢å°±å®Œå…¨æ— ä»ä¸‹æ‰‹äº†ã€‚

æ‰“å¼€ `config/initializers/session_store.rb` è§‚å¯Ÿçœ‹çœ‹ï¼š

config/initializers/session_store.rb

```
Rails.application.config.session_store :cookie_store, key: '_hackme-app_session'
```

è¿™ä¸ªè®¾å®šæ¡£å°±æ˜¯åœ¨è®¾å®š Session çš„ cookie key å«åš `_hackme-app_session`ï¼Œè€Œä¸”ä½¿ç”¨ `cookie_store` æœºåˆ¶æ¥å­˜å‚¨ã€‚

# 7-1 ä»€ä¹ˆæ˜¯ DoS æ‹’ç»æœåŠ¡æ”»å‡»

æƒ³åƒä½ ä»Šå¤©å¼€ä¸€é—´ä¹¦åº—ï¼Œæ¶æ„çš„å¯¹æ‰‹æ‰¾äº†è·‘è…¿100äººåœ¨ä½ çš„åº—é—¨å£åªçœ‹ä¸ä¹°ï¼Œè¿™ä¸€ç§æ”»å‡»å°±å«åš [DoS æ‹’ç»æœåŠ¡æ”»å‡»](https://zh.wikipedia.org/wiki/%E9%98%BB%E6%96%B7%E6%9C%8D%E5%8B%99%E6%94%BB%E6%93%8A)ã€‚ä¸åƒå‰å‡ ç« ï¼Œéª‡å®¢çš„ç›®çš„æ˜¯çªƒå–èµ„æ–™æˆ–æ˜¯ä¿®æ”¹èµ„æ–™ï¼ŒDoS æ”»å‡»çš„ç›®çš„æ˜¯è®©ä½ åšä¸æˆç”Ÿæ„ï¼Œè®©ä½ çš„ç½‘ç«™æ— æ³•æœåŠ¡æ­£å¸¸ç”¨æˆ·ã€‚

æ”»å‡»çš„æ‰‹æ³•å°±æ˜¯æš´åŠ›ï¼Œåªè¦ä¸æ–­åœ°å‘é€ HTTP è¯·æ±‚è®©æœåŠ¡å™¨å¿™ä¸è¿‡æ¥å³å¯ã€‚ç”¨æµè§ˆå™¨ä¸æ–­é‡æ–°æ•´ç†å¤ªæ…¢äº†ï¼Œè®©æˆ‘ä»¬å®‰è£…ä¸€ä¸ª [wrk](https://github.com/wg/wrk)ï¼Œè¿™æ˜¯ä¸€ä¸ªé‡æµ‹ HTTP æœåŠ¡å™¨æ•ˆèƒ½çš„å‹åŠ›æµ‹è¯•å·¥å…·ï¼š

æ‰§è¡Œ `brew install wrk`

æ‰§è¡Œ `wrk -t12 -c400 -d30s http://localhost:3000/products`

è¿™ä¼šåœ¨ 30 ç§’å†…ï¼ŒåŒæ—¶å¹³è¡Œå‘é€ 12 ä¸ª HTTP è¯·æ±‚ï¼Œå¹¶ä¿æŒ 400 ä¸ª HTTP è¿çº¿ä¸ä¸­æ–­çš„é€Ÿåº¦ï¼Œè¿›è¡Œ `http://localhost:3000/products` çš„å‹åŠ›æµ‹è¯•ã€‚

```
Running 30s test @ http://localhost:3000/products
  12 threads and 400 connections
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency   468.83ms  168.30ms 888.55ms   63.89%
    Req/Sec     3.12      3.07    10.00     65.31%
  50 requests in 30.06s, 1.30MB read
  Socket errors: connect 0, read 319, write 0, timeout 14
  Non-2xx or 3xx responses: 4
Requests/sec:      1.66
Transfer/sec:     44.25KB
```

æœ¬æœºè·‘çš„ `rails server` è¶…ä¸è€æ‰“çš„ï¼Œè¿™ä¸ªç½‘ç«™åŸºæœ¬ä¸Šæ˜¯åºŸäº†ï¼Œä½ ç”¨æµè§ˆå™¨å·²ç»æ— æ³•æ­£å¸¸æµè§ˆ `http://localhost:3000` äº†ã€‚

> å¼ºçƒˆè­¦å‘Šï¼Œå¯¹è‡ªå·±çš„ç½‘ç«™æ‰“å«åš"å‹åŠ›æµ‹è¯•"ï¼Œå¯¹åˆ«äººçš„ç½‘ç«™æ‰“å¯æ˜¯"å¹²æ‰°ä»–äººç½‘ç»œæ­£å¸¸åŠŸèƒ½"ï¼Œæ˜¯çŠ¯æ³•çš„è¡Œä¸ºã€‚è¯·ä¸è¦ä»¥èº«è¯•æ³•ã€‚

# 7-2 å¦‚ä½•é˜²å¾¡?

DoS å…¶å®æ˜¯ä¸å¤ªå¥½é˜²å¾¡çš„æ”»å‡»ï¼Œå› ä¸ºå¹¶ä¸æ˜¯å› ä¸ºç½‘ç«™æœ‰ä»€ä¹ˆæ¼æ´é€ æˆçš„ã€‚å¤§æ–¹å‘åªèƒ½æƒ³åŠæ³•å»è¾¨è¯†æ”»å‡»æ–¹çš„æ ·æ€ï¼Œç„¶åè¿›è¡Œå°é”ã€‚å®åŠ¡ä¸Šéœ€è¦ä¸´åœºååº”ï¼Œç¢°åˆ°äº†è§æ‹›æ‹†æ‹›ã€‚

å°é”æ”»å‡»æ–¹çš„ IP ç½‘ç»œåœ°å€æ˜¯æœ€åŸºæœ¬çš„æ‰‹æ³•ï¼Œé—®é¢˜å°±å‡ºåœ¨æ ·æ€å¯èƒ½å¾ˆå¤šç§ï¼Œä¾‹å¦‚ DDoS (åˆ†å¸ƒå¼DoS)å°±æ˜¯åˆ©ç”¨å¾ˆå¤šå°è¢«éª‡å®¢æ§åˆ¶çš„ä¸­æ¯’ç”µè„‘ï¼ŒåŒæ—¶è¿›è¡Œæ”»å‡»ï¼Œé‚£ä¹ˆæ¥æº IP å°±å¾ˆå¤šï¼Œé˜²å¾¡æ–¹å°±ä¸å®¹æ˜“åˆ¤æ–­å“ªä¸€äº›æ˜¯æ­£å¸¸ç”¨æˆ·æµé‡ã€å“ªä¸€äº›æ˜¯æ¶æ„çš„ã€‚

åœ¨ Rails ä¸­ï¼Œå¯ä»¥å®‰è£… [rack-attack](https://github.com/kickstarter/rack-attack) gemï¼Œè¿™å¯ä»¥è®¾å®šå½“ç‰¹å®š IP ä½å€å°±æŸä¸€æ®µæ—¶é—´å†…å­˜å–å¤ªå¤šæ¬¡çš„è¯ï¼Œè‡ªåŠ¨è¿›è¡Œå°é”ï¼š

> ä¸è¿‡å›°éš¾ç‚¹åœ¨äºå¤ªå¤šæ¬¡æ˜¯å¤šå°‘æ¬¡ï¼Œè®¾å¤ªä½ä¼šé˜»æŒ¡åˆ°æ­£å¸¸ç”¨æˆ·ï¼Œä¾‹å¦‚æœ‰äº›å…¬å¸ç»„ç»‡å¾ˆå¯èƒ½æ˜¯å¾ˆå¤šäººå…±äº«åŒä¸€ä¸ª IP ä½å€æ¥ä¸Šç½‘çš„ï¼Œé€è¿‡ VPN ç§‘å­¦ä¸Šç½‘çš„è¯ï¼Œæ¥æº IP ä¹Ÿæ˜¯å¾ˆå¤šäººå…±äº«çš„ã€‚ä½†æ˜¯è®¾å¤ªé«˜åˆæ²¡æ•ˆæœã€‚

ç¼–è¾‘ `Gemfile`

```
+  gem 'rack-attack'
```

æ‰§è¡Œ `bundle`

ç¼–è¾‘ `config/application.rb`

config/application.rb

```
+     config.middleware.use Rack::Attack
```

æ–°å¢ `config/initializers/rack-attack.rb`

config/initializers/rack-attack.rb

```
class Rack::Attack

  throttle('req/ip', :limit => 180, :period => 1.minutes) do |req|
    req.ip
  end

  ### Prevent Brute-Force Login Attacks ###


  # The most common brute-force login attack is a brute-force password

  # attack where an attacker simply tries a large number of emails and

  # passwords to see if any credentials match.

  #

  # Another common method of attack is to use a swarm of computers with

  # different IPs to try brute-forcing a password for a specific account.


  # Throttle POST requests to /login by IP address

  #

  # Key: "rack::attack:#{Time.now.to_i/:period}:logins/ip:#{req.ip}"

  throttle('logins/ip', :limit => 5, :period => 20.seconds) do |req|
    if req.path == '/users/sign_in' && req.post?
      req.ip
    end
  end

  # Throttle POST requests to /login by email param

  #

  # Key: "rack::attack:#{Time.now.to_i/:period}:logins/email:#{req.email}"

  #

  # Note: This creates a problem where a malicious user could intentionally

  # throttle logins for another user and force their login requests to be

  # denied, but that's not very common and shouldn't happen to you. (Knock

  # on wood!)

  throttle("logins/email", :limit => 5, :period => 20.seconds) do |req|
    if req.path == '/users/sign_in' && req.post?
      # return the email if present, nil otherwise

      req.params['email'].presence
    end
  end

end
```

é‡å¯æœåŠ¡å™¨ã€‚ä»¥ä¸Šè®¾å®šåŒ…æ‹¬ï¼š

1. ä¸€åˆ†é’Ÿå†…ï¼Œä¸€ä¸ª IP ä½å€åªèƒ½å­˜å– 180 æ¬¡
2. é’ˆå¯¹ `/users/sign_in` è¿™ä¸ªç™»å…¥ç½‘å€ï¼Œ20 ç§’å†…åªèƒ½å°è¯•ç™»å…¥ 5 æ¬¡
3. é’ˆå¯¹ `/users/sign_in` è¿™ä¸ªç½‘å€ï¼ŒåŒä¸€ email åœ¨ 20 ç§’å†…åªèƒ½å°è¯•ç™»å…¥ 5 æ¬¡

å¦å¤–å¯ä»¥åšçš„äº‹æƒ…å°±æ˜¯ï¼Œæ”¹è¿›ç½‘ç«™æ•ˆèƒ½ï¼šå‡å¦‚ä½ æœ‰ä¸€ä¸ªé¡µé¢æ•ˆèƒ½å¾ˆçƒ‚ï¼Œéœ€è¦è·‘å¥½å‡ ç§’ï¼Œè¿™ä¹ˆè¿™å°±æ˜¯ç½‘ç«™ DoS çš„å¼±ç‚¹ï¼Œå› ä¸ºéª‡å®¢åªè¦å»æ‰“è¿™ä¸ªé¡µé¢å°±æœ‰æœ€å¥½çš„æ”»å‡»æ•ˆæœã€‚

å¦‚æœçœŸçš„é¢ä¸´å¤§é‡çš„DDoS æ”»å‡»ï¼Œå°±ä¸æ˜¯Rails åº”ç”¨å±‚çº§å¯ä»¥å¤„ç†å¾—äº†ï¼Œå¿…é¡»è´­ä¹°ä¸“é—¨çš„ç½‘ç»œé˜²ç«å¢™ï¼Œä¾‹å¦‚[ç™¾åº¦å®‰å…¨](http://anquan.baidu.com/pages/ddos.html)ã€[äº‘ç›¾DDoSé«˜é˜²IP](https://intl.aliyun.com/zh/product/ddos-pro)ç­‰ç­‰äº‘æœåŠ¡å•†çš„äº§å“ã€‚

# 8-1 å®‰è£… brakeman æ£€æµ‹ä»£ç 

[brakeman](https://github.com/presidentbeef/brakeman) æ˜¯ä¸€ä¸ª Rails çš„å·¥å…·å¯ä»¥åˆ†æä»£ç ï¼Œæ‰¾å‡ºå¯èƒ½æœ‰æ¼æ´çš„åœ°æ–¹ã€‚

ä¿®æ”¹ `Gemfile`

```
  group :development do
+    gem 'brakeman'
```

æ‰§è¡Œ `bundle`

æ‰§è¡Œ `brakeman`ï¼Œå°±ä¼šåˆ†æä½ çš„ä»£ç ï¼Œåˆ—å‡º"å¯èƒ½"æœ‰æ¼æ´çš„åœ°æ–¹ï¼š

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/FKULBIUCTemz0A82LlO2_8-1.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/FKULBIUCTemz0A82LlO2_8-1.png)

> brakeman æŠ¥è¡¨ç»“æœä»…ä¾›å‚è€ƒï¼Œä¸è¡¨ç¤ºå¿…ç„¶æœ‰æ¼æ´ã€‚éœ€è¦ä¸€æ¡ä¸€æ¡å®é™…æ£€æŸ¥çœ‹çœ‹ã€‚

# 8-2 å®‰è£… bundler-audit æ£€æµ‹å¥—ä»¶

é™¤äº†è‡ªå·±å†™çš„ä»£ç æœ‰å¯èƒ½æœ‰æ¼æ´ä¹‹å¤–ï¼Œå®‰è£…çš„ gem ä¹Ÿæœ‰å¯èƒ½çˆ†å‡ºå®‰å…¨æ€§æ¼æ´ã€‚é€è¿‡ bundler-audit è¿™ä¸ª gem å¯ä»¥å¸®å¿™æ£€æŸ¥æœ‰æ²¡æœ‰å¥—ä»¶æœ‰å·²çŸ¥çš„æ¼æ´éœ€è¦å‡çº§ã€‚

ä¿®æ”¹ `Gemfile`

```
  group :development do
+    gem 'bundler-audit'
```

æ‰§è¡Œ `bundle`

æ‰§è¡Œ `bundle-audit`

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/5zgyzSq5REaICSpf5OXf_8-2.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/5zgyzSq5REaICSpf5OXf_8-2.png)

ç›®å‰æ²¡æœ‰éœ€è¦å‡çº§çš„å¥—ä»¶ã€‚å¦‚æœæœ‰çš„è¯ï¼Œè¯·æ‰§è¡Œ `bundle update å¥—ä»¶åç§°` å°±å¯ä»¥è¿›è¡Œå‡çº§ã€‚

#### æœ¬èŠ‚ä½œä¸š

##### [ä½œä¸š](https://fullstack.xinshengdaxue.com/assignments/56)ï¼š[ä½œä¸š](https://fullstack.xinshengdaxue.com/tasks/324)

å·²æœ‰ 10 ä¸ªç¬¬ä¸€æœŸåŒå­¦æäº¤äº†è¿™ä¸ªä½œä¸š [**çœ‹çœ‹åŒå­¦æ€ä¹ˆåš](https://fullstack.xinshengdaxue.com/tasks/324/other_answers?order=recent)

[**æäº¤ä½œä¸š](https://fullstack.xinshengdaxue.com/tasks/324)

è¯· Fork è¿™ä¸ªé¡¹ç›®ï¼š<https://github.com/growthschool/hackme-app>ï¼Œç„¶å Clone å›å»ï¼Œä¿®å¥½ä»¥ä¸‹æ¼æ´ï¼š

1. ä¿®å¥½ XSS
2. ä¿®å¥½ CSRF
3. ä¿®å¥½ SQL injection
4. ä¿®å¥½ Mass Assignment
5. å®‰è£… breakman å’Œ bundler-audit

æœ€åç”¨ Pull Request äº¤ä½œä¸šï¼Œè¯·è´´ä¸Š Github Pull Request çš„ç½‘å€ã€‚

# 9-1 è®¤è¯†æ•£åˆ—å‡½æ•°

æ•£åˆ—å‡½æ•°æ˜¯ä¸€ç§èƒ½å°†æ•°æ®å˜æˆæ‘˜è¦(digest)çš„ç®—æ³•ï¼Œæ‰§è¡Œ `irb`ï¼Œç„¶åè¾“å…¥ä»¥ä¸‹ä»£ç å®éªŒçœ‹çœ‹ï¼š

```
require 'digest'
Digest::SHA1.hexdigest '12345678'
```

å¾—åˆ° `"7c222fb2927d828af22f592134e8932480637c0d"`

æ•£åˆ—å‡½æ•°æœ‰ä¸€äº›ç‰¹æ€§ï¼š

1. ç›¸åŒçš„æ•°æ®ï¼Œæ¯æ¬¡éƒ½ä¼šå¾—åˆ°ä¸€æ ·çš„æ‘˜è¦
2. æ˜¯å•å‘çš„ï¼Œæ— æ³•é€†æ¨ï¼šåªçŸ¥é“æ‘˜è¦çš„è¯ï¼Œæ²¡æœ‰åŠæ³•èƒ½å¤Ÿé€è¿‡è®¡ç®—çŸ¥é“æœ¬æ¥çš„æ•°æ®é•¿æ€æ ·ã€‚ä¾‹å¦‚ç»™ä½  `7c222fb2927d828af22f592134e8932480637c0d`ï¼Œæ²¡æœ‰ç®—æ³•å¯ä»¥é€†æ¨å›æ¥ã€‚é™¤éæœ‰ä¸€ä¸ªå¯¹ç…§çš„å­—å…¸ã€‚

# 9-2 æ•£åˆ—å‡½æ•°çš„ç”¨é€”

[æ•£åˆ—å‡½æ•°](https://zh.wikipedia.org/wiki/%E6%95%A3%E5%88%97%E5%87%BD%E6%95%B8)éå¸¸æœ‰ç”¨ï¼Œå¯ä»¥æ‹¿æ¥å¿«é€Ÿæ¯”è¾ƒä¸¤ä¸ªæ–‡æ¡£æ˜¯å¦ç›¸åŒï¼Œè€Œä¸éœ€è¦å®é™…æ¯”è¾ƒæ–‡æ¡£å†…å®¹ï¼Œä¾‹å¦‚ï¼š

1. Git æ¯æ¬¡çš„ commitï¼Œéƒ½ä¼šæœ‰ä¸€ä¸ªæ‘˜è¦ã€‚ä¸åŒçš„æ‘˜è¦å°±ä»£è¡¨ commit å†…å®¹ä¸åŒã€‚Git ç”¨è¿™ä¸ªæ‘˜è¦å€¼å½“ä½œæ¯æ¬¡ commit çš„å”¯ä¸€è¯†åˆ« IDã€‚
2. ç½‘ç»œä¼ æ¡£çš„æ—¶å€™ï¼Œé€è¿‡æ¯”è¾ƒè¿™ä¸ªæ‘˜è¦ï¼Œå°±å¯ä»¥çŸ¥é“ä¸‹è½½äº†å®Œæ•´æ­£ç¡®çš„æ¡£æ¡ˆã€‚
3. åœ¨ Rails ä¸­ï¼ŒAsset pipeline ä¼šå°† CSS å’Œ JavaScript å‹ç¼©ï¼Œæ¡£åå°±æ˜¯é€è¿‡æ•£åˆ—å‡½æ•°äº§ç”Ÿçš„ã€‚è¿™æ˜¯å› ä¸ºæµè§ˆå™¨ä¼šç¼“å­˜é™æ€æ¡£æ¡ˆï¼Œå¦‚æœ CSS/Javascript å†…å®¹æœ‰ä¿®æ”¹çš„è¯ï¼Œç”¨æˆ·æµè§ˆå™¨å¯èƒ½ä¸çŸ¥é“æœ‰æ–°ç‰ˆè€Œä½¿ç”¨åˆ°æ—§çš„ CSS/JS æ¡£æ¡ˆã€‚ä½†æ˜¯å› ä¸ºæ¡£åç”¨äº†æ•£åˆ—å‡½æ•°çš„å…³ç³»ï¼Œå†…å®¹ä¸€æ”¹æ¡£åå°±ä¼šå˜å¾—ä¸ä¸€æ ·ï¼Œé‚£ä¹ˆæµè§ˆå™¨å°±ä¼šä¸‹è½½æ–°çš„æ¡£æ¡ˆäº†ã€‚

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/4zxGcrmNRCG4BgiySHAo_9-3.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/4zxGcrmNRCG4BgiySHAo_9-3.png)

1. å­˜å‚¨ç”¨æˆ·å¯†ç ã€‚å¤§å®¶å·²ç»ä¼šç”¨ Devise åœ¨ Rails ä¸­å®åš User Modelï¼Œåœ¨ users table ä¸­å®é™…çš„å­—æ®µæ˜¯ `encrypted_password`

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/8UURspY6Rc2nBum563xr_9-1.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/8UURspY6Rc2nBum563xr_9-1.png)

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/m7jUkAkFRtuW7ZIZmre4_9-2.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/m7jUkAkFRtuW7ZIZmre4_9-2.png)

ç”¨æˆ·æ³¨å†Œæ—¶è¾“å…¥çš„å¯†ç ï¼Œåœ¨å®é™…å­˜å‚¨è¿›æ•°æ®åº“æ—¶ï¼Œä¼šå…ˆç»è¿‡æ•£åˆ—å‡½æ•°ï¼Œå˜æˆæ‘˜è¦å€¼ã€‚æ•°æ®åº“é‡Œé¢æ²¡æœ‰å­˜ç”¨æˆ·çš„æ˜ç ï¼Œè€Œæ˜¯å­˜å¯†ç æ‘˜è¦åçš„å€¼ã€‚

è€Œä¸‹æ¬¡ç”¨æˆ·è¦ç™»å…¥çš„æ—¶å€™ï¼Œå°†ç”¨æˆ·è¾“å…¥çš„å¯†ç æ‘˜è¦ä¸€æ¬¡ï¼Œä¸æ•°æ®åº“ä¸­å­˜çš„å¯†ç æ‘˜è¦è¿›è¡Œæ¯”å¯¹ï¼Œå°±å¯ä»¥çŸ¥é“å¯†ç å¯¹ä¸å¯¹äº†ã€‚

è¿™æ ·çš„å¥½å¤„æ˜¯ä»€ä¹ˆå‘¢?

1. æ•°æ®åº“ä¸ä¼šå­˜ç”¨æˆ·çš„æ˜ç ï¼Œæ‰€ä»¥å³ä½¿æ˜¯æ•°æ®åº“ç®¡ç†å‘˜ï¼Œä¹Ÿä¸ä¼šçŸ¥é“ç”¨æˆ·çœŸæ­£çš„å¯†ç æ˜¯ä»€ä¹ˆã€‚çŸ¥é“ `encrypted_password` å¹¶æ²¡æœ‰ä»€ä¹ˆç”¨ï¼Œå› ä¸ºæˆ‘ä»¬æ— æ³•é€†æ¨ã€‚ä¹Ÿæ— æ³•ç”¨è¿™ä¸ª `encrypted_password` åšç™»å…¥ã€‚
2. ä¸‡ä¸€æ•°æ®åº“æ•´ä¸ªå¤–æ´©äº†ï¼Œéª‡å®¢ä¹Ÿæ— æ³•çŸ¥é“ç”¨æˆ·çš„å¯†ç 

ä¸è¿‡ï¼Œç›®å‰æ˜¯å¸‚é¢ä¸Šä»æœ‰å¾ˆå¤šç½‘ç«™æ˜¯ç›´æ¥å­˜å‚¨ç”¨æˆ·æ˜ç ï¼Œè¿™ä¼šé€ æˆç”¨æˆ·éšç§å¾ˆå¤§çš„å±å®³ã€‚å› ä¸ºç®¡ç†å‘˜æˆ–éª‡å®¢(å¦‚æœæ•°æ®åº“å¤–æ´©)å¯ä»¥ç›´æ¥çœ‹åˆ°ä½ å¯†ç ï¼Œç„¶åå¾ˆå¤šäººåœ¨ä¸åŒç½‘ç«™ä¸­ï¼Œä¼šæ²¿ç”¨ä¸€æ ·çš„å¯†ç ã€‚

è¦æ€ä¹ˆåˆ¤æ–­ä¸€ä¸ªç½‘ç«™æœ‰æ²¡æœ‰å­˜æ˜ç å‘¢ï¼Ÿåªè¦è¯•è¯•çœ‹å¿˜è®°å¯†ç ç¨‹åºå³å¯ï¼Œå¦‚æœç½‘ç«™ç›´æ¥å°†ä½ çš„å¯†ç å¯„ç»™ä½ ï¼Œé‚£å°±ä»£è¡¨ä»–çš„
æ•°æ®åº“å­˜æ˜ç ã€‚å¦‚æœç½‘ç«™è¦æ±‚ä½ é‡æ–°è®¾å®šå¯†ç (å°±åƒ Devise ä¸€æ ·)ï¼Œå°±è¡¨ç¤ºè¿™ç½‘ç«™æœ‰å®‰å…¨æ„è¯†ã€‚

# 10-1. è®¤è¯†éå¯¹ç§°åŠ å¯†

è¿‘å¹´æ¥ç”±äºä¸Šç½‘å®‰å…¨æ„è¯†çš„æå‡ï¼Œè¶Šæ¥è¶Šå¤šçš„ç½‘ç«™ä½¿ç”¨ HTTPS åŠ å¯†è¿çº¿ï¼Œç½‘å€åƒè¿™æ ·ï¼š

[![img](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/FQaKnbDVTyaoqrilCA3M_10-1.png)](https://s3-ap-northeast-1.amazonaws.com/ontrackapp-production/FQaKnbDVTyaoqrilCA3M_10-1.png)

è¿™ä¸ªåŸç†æ˜¯ä»€ä¹ˆå‘¢? æµè§ˆå™¨å’ŒæœåŠ¡å™¨ä¹‹é—´ï¼Œæ˜¯å¦‚ä½•å®‰å…¨è¿çº¿çš„ï¼Ÿå¦‚ä½•ä¿éšœä¸­é—´ä¼ è¾“çš„è¿‡ç¨‹ï¼Œä¸ä¼šè¢«äººå·å¬ã€è¢«äººä¿®æ”¹å†…å®¹ã€‚

> æ²¡æœ‰åŠ å¯†çš„ HTTP è¿çº¿ï¼Œå¯ä»¥é€è¿‡ç›‘å¬ç½‘ç»œå°åŒ…ï¼Œå°±å¯ä»¥çŸ¥é“æµè§ˆå™¨ä¼ è¾“çš„å†…å®¹ã€‚ä¾‹å¦‚åœ¨å’–å•¡å…ä¸Šç½‘ï¼Œéª‡å®¢å¯ä»¥é€è¿‡ç›‘å¬æ— çº¿ç½‘ç»œï¼Œçœ‹åˆ°ä½ ä¸Šç½‘çš„ä¸€ä¸¾ä¸€åŠ¨ã€‚æœ‰äº›å’–å•¡å…å¯ä»¥åœ¨ç½‘é¡µä¸­ç½®å…¥å¹¿å‘Š Bannerï¼Œå°±æ˜¯å› ä¸ºè¿çº¿æ˜¯èµ° HTTP æœªåŠ å¯†çš„å…³ç³»ï¼Œæ‰€ä»¥å¾ˆå®¹æ˜“å°±å¯ä»¥ä¿®æ”¹ç½‘é¡µå†…å®¹ã€‚

æˆ‘ä»¬åœ¨ 6-1 æ•™è¿‡ä»€ä¹ˆæ˜¯[å¯¹ç§°å¯†é’¥åŠ å¯†](https://zh.wikipedia.org/wiki/%E5%B0%8D%E7%A8%B1%E5%AF%86%E9%91%B0%E5%8A%A0%E5%AF%86)ç®—æ³•ï¼Œé€è¿‡å¯†é’¥å°±å¯ä»¥ä¼ è¾“å¯†æ–‡ã€‚

ä½†æ˜¯å¯¹ç§°å¯†é’¥åŠ å¯†æ–¹æ³•ï¼Œåœ¨æµè§ˆå™¨å’ŒæœåŠ¡å™¨è¿çº¿çš„æƒ…å¢ƒï¼Œæœ‰ä¸ªè‡´å‘½çš„ç¼ºç‚¹ï¼Œå°±æ˜¯ä¸€å¼€å§‹è¿çº¿æ—¶å¦‚ä½•äº¤æ¢å¯†é’¥ã€‚åŒæ–¹éƒ½è¦çŸ¥é“å¯†é’¥ï¼Œæ‰èƒ½çŸ¥é“å¯¹æ–¹è®²äº†ä»€ä¹ˆè¯ã€‚

æ—¢ç„¶ä¸€å¼€å§‹è¿çº¿å°±æ˜¯ä¸å®‰å…¨çš„ï¼Œåœ¨æŠŠå¯†é’¥å‘Šè¯‰å¯¹æ–¹çš„è¿‡ç¨‹ä¸­ï¼Œè¿™ä¸ªå¯†é’¥ä¹Ÿå°±å¤–æ´©äº†...

æ‰€å¹¸èªæ˜çš„æ•°å­¦å®¶å‘æ˜äº†[éå¯¹ç§°åŠ å¯†](https://zh.wikipedia.org/zh-cn/%E5%85%AC%E5%BC%80%E5%AF%86%E9%92%A5%E5%8A%A0%E5%AF%86)ï¼Œå¯ä»¥åœ¨ä¸äº¤æ¢å¯†é’¥çš„æƒ…å†µä¸‹ï¼Œè§£å†³è¿™ä¸ªé—®é¢˜ã€‚

åœ¨éå¯¹ç§°åŠ å¯†ç®—æ³•ä¸­ï¼Œä¼šæœ‰ä¸¤æŠŠé’¥åŒ™ï¼Œä¸€æŠŠå«åšå…¬é’¥ã€ä¸€æŠŠå«åšå¯†é’¥ã€‚

- é€è¿‡å…¬é’¥åŠ å¯†çš„å¯†æ–‡ï¼Œåªæœ‰å¯†é’¥èƒ½å¤Ÿè§£å¼€
- é€è¿‡å¯†é’¥åŠ å¯†çš„å¯†æ–‡ï¼Œåªæœ‰å…¬é’¥èƒ½å¤Ÿè§£å¼€

æœåŠ¡å™¨ä¼šå°†å…¬é’¥å…¬å¼€ç»™æµè§ˆå™¨çŸ¥é“ï¼Œæµè§ˆå™¨ä¼šç”¨å…¬é’¥åŠ å¯†å†…å®¹ï¼Œä¼ ç»™æœåŠ¡å™¨ï¼ŒæœåŠ¡å™¨ç”¨å¯†é’¥è§£å¼€ã€‚åä¹‹æœåŠ¡å™¨ç”¨å¯†é’¥åŠ å¯†ï¼Œæµè§ˆå™¨ç”¨å…¬é’¥è§£å¼€ã€‚å¦‚æ­¤å°±è§£å†³äº†ä¸€å¼€å§‹å¯†é’¥äº¤æ¢çš„é—®é¢˜ã€‚

> è¿™ç§æ–¹å¼ä¹Ÿç”¨åœ¨ SSH è¿çº¿è®¤è¯å’ŒåŠ å¯†è¿çº¿ 1. åœ¨éƒ¨ç½² Linux æœåŠ¡å™¨æ—¶ï¼Œæˆ‘ä»¬ä¼šå°†è‡ªå·±çš„å…¬é’¥æ”¾åœ¨æœåŠ¡å™¨ä¸Šï¼Œè¿™æ ·ç™»å…¥çš„æ—¶å€™å°±ä¸éœ€è¦æ‰“å¸å·å¯†ç ï¼ŒæœåŠ¡å™¨å°±èƒ½è®¤è¯ä½  2. åœ¨ Git ä¹‹ä¸­ï¼Œæˆ‘ä»¬ä¼šå°†è‡ªå·±çš„å…¬é’¥æ”¾åœ¨ Github ä¸Šï¼Œè¿™æ · git push å’Œ pull æ—¶ï¼ŒGithub å°±èƒ½åšè®¤è¯ã€‚

å‰©ä¸‹ä¿¡ä»»é—®é¢˜ï¼Œæˆ‘ä»¬æ€ä¹ˆçŸ¥é“è¿™ä¸ªå…¬é’¥çœŸçš„ä»£è¡¨è¿™ä¸ªç½‘ç«™ä¸»ï¼Ÿè¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬éœ€è¦ç”³è¯·æˆ–è´­ä¹°ç½‘ç«™å®‰å…¨å‡­è¯(SSL certificate)çš„åŸå› ã€‚ç½‘ç«™ä¸»éœ€è¦å‘æƒå¨æœºæ„è´­ä¹°ç”³è¯·æˆ–è´­ä¹°ï¼Œç»è¿‡ä¸€äº›è®¤è¯ç¨‹åºåï¼Œæ‰èƒ½è·å¾— HTTPS éœ€è¦çš„å®‰å…¨å‡­è¯ã€‚è€Œç”¨æˆ·çš„æµè§ˆå™¨ä¸­ï¼Œåœ¨å‡ºåœºæ—¶å°±ä¼šé»˜è®¤ç›¸ä¿¡ä¸€äº›æƒå¨æœºæ„æ‰€æ ¸å‘çš„å®‰å…¨å‡­è¯ï¼Œä»¥æ­¤å»ºæ„å‡ºä¿¡ä»»éŠã€‚

ä¸Šè¿°æ˜¯ç®€åŒ–çš„è¯´æ˜ï¼Œè¯¦ç»†å¯ä»¥å‚è€ƒä»¥ä¸‹æ–‡ç« ï¼š

- [ä¹Ÿè®¸ï¼Œè¿™æ ·ç†è§£HTTPSæ›´å®¹æ˜“](http://showme.codes/2017-02-20/understand-https/)
- [HTTPSç§‘æ™®æ‰«ç›²å¸–](https://segmentfault.com/a/1190000004523659)
- [HTTPSå·¥ä½œåŸç†](https://cattail.me/tech/2015/11/30/how-https-works.html)

é‚£ä¹ˆè¦å¦‚ä½•åœ¨æœåŠ¡å™¨ä¸Šå®‰è£… HTTPS å‘¢? æ­¥éª¤ä¼šæ¯”è¾ƒå¤æ‚ï¼Œæˆ‘ä»¬ä¼šåœ¨è¿›é˜¶çš„éƒ¨ç½²æ•™ç¨‹å†è¯´ä»¥è¯´æ˜ã€‚

> [Heroku: Announcing Free and Automated SSL Certs For All Paid Dynos](https://blog.heroku.com/announcing-automated-certificate-management) Heroku çš„ä»˜è´¹ç”¨æˆ·å¯ä»¥å…è´¹å¾—åˆ°SSL Certs

# 10-2 ç»“è¯­

å¸Œæœ›æœ¬è¯¾ç¨‹å¯ä»¥æœ‰æ•ˆæä¾›å¤§å®¶ç½‘ç«™å®‰å…¨æ„è¯†ï¼Œã€Œå®³äººä¹‹å¿ƒä¸å¯æœ‰ï¼Œé˜²äººä¹‹å¿ƒä¸å¯æ— ã€ï¼Œå†æ¬¡æé†’å¤§å®¶åˆ‡å‹¿ä»¥èº«è¯•æ³•ã€‚

å¯¹ç½‘ç»œå®‰å…¨æœ‰å…´è¶£çš„æœ‹å‹ï¼Œæ¨èé˜…è¯»é˜¿é‡Œå·´å·´çš„ç½‘ç»œå®‰å…¨ä¸“å®¶æ‰€å†™çš„å…¥é—¨ä¹¦ï¼š[ç™½å¸½å­è®²Webå®‰å…¨](https://book.douban.com/subject/10546925/)è¿™æœ¬ä¹¦ã€‚
